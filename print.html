<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>A/B Street</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Homepage</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="software/index.html"><strong aria-hidden="true">2.</strong> Software</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="software/abstreet.html"><strong aria-hidden="true">2.1.</strong> A/B Street</a></li><li class="chapter-item expanded "><a href="software/ungap_the_map/index.html"><strong aria-hidden="true">2.2.</strong> Ungap the Map</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="software/ungap_the_map/user_guide.html"><strong aria-hidden="true">2.2.1.</strong> User guide</a></li><li class="chapter-item expanded "><a href="software/ungap_the_map/motivation.html"><strong aria-hidden="true">2.2.2.</strong> Motivation</a></li><li class="chapter-item expanded "><a href="software/ungap_the_map/plan.html"><strong aria-hidden="true">2.2.3.</strong> Project plan</a></li><li class="chapter-item expanded "><a href="software/ungap_the_map/tech_details.html"><strong aria-hidden="true">2.2.4.</strong> Technical details</a></li></ol></li><li class="chapter-item expanded "><a href="software/fifteen_min.html"><strong aria-hidden="true">2.3.</strong> 15-minute neighborhoods explorer</a></li><li class="chapter-item expanded "><a href="software/santa.html"><strong aria-hidden="true">2.4.</strong> 15-minute Santa</a></li><li class="chapter-item expanded "><a href="software/ltn/index.html"><strong aria-hidden="true">2.5.</strong> Low-traffic neighborhoods</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="software/ltn/tech_details.html"><strong aria-hidden="true">2.5.1.</strong> Technical details</a></li></ol></li><li class="chapter-item expanded "><a href="software/osm_viewer.html"><strong aria-hidden="true">2.6.</strong> OpenStreetMap viewer</a></li><li class="chapter-item expanded "><a href="software/parking_mapper.html"><strong aria-hidden="true">2.7.</strong> Mapping on-street parking</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="user/index.html"><strong aria-hidden="true">3.</strong> User guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="user/new_city.html"><strong aria-hidden="true">3.1.</strong> Importing a new city</a></li><li class="chapter-item expanded "><a href="user/asu.html"><strong aria-hidden="true">3.2.</strong> ASU Lab guide</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="proposals/index.html"><strong aria-hidden="true">4.</strong> Proposals</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="proposals/seattle_bikes/index.html"><strong aria-hidden="true">4.1.</strong> Seattle bike network vision</a></li><li class="chapter-item expanded "><a href="proposals/broadmoor.html"><strong aria-hidden="true">4.2.</strong> Allow bike and foot traffic through Broadmoor</a></li><li class="chapter-item expanded "><a href="proposals/lake_wash.html"><strong aria-hidden="true">4.3.</strong> Lake Washington Blvd Stay Healthy Street</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="tech/index.html"><strong aria-hidden="true">5.</strong> Technical details</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tech/dev/index.html"><strong aria-hidden="true">5.1.</strong> Developer guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tech/dev/misc_tricks.html"><strong aria-hidden="true">5.1.1.</strong> Misc developer tricks</a></li><li class="chapter-item expanded "><a href="tech/dev/api.html"><strong aria-hidden="true">5.1.2.</strong> API</a></li><li class="chapter-item expanded "><a href="tech/dev/testing.html"><strong aria-hidden="true">5.1.3.</strong> Testing</a></li><li class="chapter-item expanded "><a href="tech/dev/data.html"><strong aria-hidden="true">5.1.4.</strong> Data organization</a></li><li class="chapter-item expanded "><a href="tech/dev/release.html"><strong aria-hidden="true">5.1.5.</strong> Release process</a></li><li class="chapter-item expanded "><a href="tech/dev/formats/index.html"><strong aria-hidden="true">5.1.6.</strong> Data formats</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tech/dev/formats/scenarios.html"><strong aria-hidden="true">5.1.6.1.</strong> Scenarios</a></li><li class="chapter-item expanded "><a href="tech/dev/formats/traffic_signals.html"><strong aria-hidden="true">5.1.6.2.</strong> Traffic signals</a></li></ol></li><li class="chapter-item expanded "><a href="tech/dev/ui.html"><strong aria-hidden="true">5.1.7.</strong> widgetry UI</a></li></ol></li><li class="chapter-item expanded "><a href="tech/map/index.html"><strong aria-hidden="true">5.2.</strong> Map model</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tech/map/geometry/index.html"><strong aria-hidden="true">5.2.1.</strong> Intersection geometry</a></li><li class="chapter-item expanded "><a href="tech/map/details.html"><strong aria-hidden="true">5.2.2.</strong> Details</a></li><li class="chapter-item expanded "><a href="tech/map/importing/index.html"><strong aria-hidden="true">5.2.3.</strong> Importing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tech/map/importing/convert_osm.html"><strong aria-hidden="true">5.2.3.1.</strong> convert_osm</a></li><li class="chapter-item expanded "><a href="tech/map/importing/geometry.html"><strong aria-hidden="true">5.2.3.2.</strong> Road/intersection geometry</a></li><li class="chapter-item expanded "><a href="tech/map/importing/rest.html"><strong aria-hidden="true">5.2.3.3.</strong> The rest</a></li><li class="chapter-item expanded "><a href="tech/map/importing/misc.html"><strong aria-hidden="true">5.2.3.4.</strong> Misc</a></li></ol></li><li class="chapter-item expanded "><a href="tech/map/edits.html"><strong aria-hidden="true">5.2.4.</strong> Live edits</a></li><li class="chapter-item expanded "><a href="tech/map/platform.html"><strong aria-hidden="true">5.2.5.</strong> Exporting</a></li></ol></li><li class="chapter-item expanded "><a href="tech/trafficsim/index.html"><strong aria-hidden="true">5.3.</strong> Traffic simulation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tech/trafficsim/discrete_event/index.html"><strong aria-hidden="true">5.3.1.</strong> Discrete event simulation</a></li><li class="chapter-item expanded "><a href="tech/trafficsim/travel_demand.html"><strong aria-hidden="true">5.3.2.</strong> Travel demand</a></li><li class="chapter-item expanded "><a href="tech/trafficsim/gridlock.html"><strong aria-hidden="true">5.3.3.</strong> Gridlock</a></li><li class="chapter-item expanded "><a href="tech/trafficsim/trips.html"><strong aria-hidden="true">5.3.4.</strong> Multi-modal trips</a></li><li class="chapter-item expanded "><a href="tech/trafficsim/live_edits.html"><strong aria-hidden="true">5.3.5.</strong> Live edits</a></li><li class="chapter-item expanded "><a href="tech/trafficsim/parking.html"><strong aria-hidden="true">5.3.6.</strong> Parking</a></li><li class="spacer"></li></ol></li></ol></li><li class="chapter-item expanded "><a href="project/index.html"><strong aria-hidden="true">6.</strong> Project</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="project/team.html"><strong aria-hidden="true">6.1.</strong> Team</a></li><li class="chapter-item expanded "><a href="project/contributing.html"><strong aria-hidden="true">6.2.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="project/funding.html"><strong aria-hidden="true">6.3.</strong> Funding</a></li><li class="chapter-item expanded "><a href="project/hiring.html"><strong aria-hidden="true">6.4.</strong> Hiring</a></li><li class="chapter-item expanded "><a href="project/motivations.html"><strong aria-hidden="true">6.5.</strong> Motivations</a></li><li class="chapter-item expanded "><a href="project/history/index.html"><strong aria-hidden="true">6.6.</strong> History</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="project/history/backstory.html"><strong aria-hidden="true">6.6.1.</strong> Backstory</a></li><li class="chapter-item expanded "><a href="project/history/year1.html"><strong aria-hidden="true">6.6.2.</strong> Year 1</a></li><li class="chapter-item expanded "><a href="project/history/year2.html"><strong aria-hidden="true">6.6.3.</strong> Year 2</a></li><li class="chapter-item expanded "><a href="project/history/year3.html"><strong aria-hidden="true">6.6.4.</strong> Year 3</a></li><li class="chapter-item expanded "><a href="project/history/retrospective/index.html"><strong aria-hidden="true">6.6.5.</strong> 3 year retrospective</a></li><li class="chapter-item expanded "><a href="project/history/CHANGELOG.html"><strong aria-hidden="true">6.6.6.</strong> Full CHANGELOG</a></li></ol></li><li class="chapter-item expanded "><a href="project/references.html"><strong aria-hidden="true">6.7.</strong> References</a></li><li class="chapter-item expanded "><a href="project/presentations.html"><strong aria-hidden="true">6.8.</strong> Presentations</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">A/B Street</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/a-b-street/docs/tree/main/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="homepage"><a class="header" href="#homepage">Homepage</a></h1>
<p>Welcome to the A/B Street website. Here you will find information about the
project, an overview of the <a href="software">software</a> products it has enabled, a
<a href="user">user guide</a>, <a href="tech">technical details</a> aimed at developers, and lots
more.</p>
<p>Like any open source project, A/B Street has evolved and will continue to
evolve, and that applies to the documentation. Any contributions to the website,
the source code of which can be found at
<a href="https://github.com/a-b-street/docs">github.com/a-b-street/docs</a> are very
welcome. In fact, contributing to the project's documentation can be one of the
easiest ways of supporting the project.</p>
<!--
Todo
This homepage should definitely have:

- our 3 principles
- lots of videos
- contact info
- contributing
-->
<div style="break-before: page; page-break-before: always;"></div><h1 id="software"><a class="header" href="#software">Software</a></h1>
<p>Our main software is <a href="software/abstreet.html">A/B Street</a>, but along the way, we've split
out a few related side projects. A/B Street has a huge scope, so over time, we'd
like to carve out more smaller pieces from it.</p>
<p>The main projects:</p>
<ul>
<li><a href="software/abstreet.html">A/B Street</a> for running a traffic simulation, editing roads and
intersections, and measuring the impact of your changes. It has game-like
elements, but leans more on the side of being a real prototyping tool.</li>
<li><a href="software/ungap_the_map/index.html">Ungap the Map</a> for exploring current gaps in a city's
bicycle network and proposing new bike lanes.</li>
<li><a href="software/fifteen_min.html">15-minute neighborhood explorer</a> for seeing where people live
in relation to commercial and public amenities.</li>
<li><a href="software/santa.html">15-minute Santa</a>, a light-hearted arcade game to demonstrate the
concept of a 15-minute neighborhood.</li>
<li><a href="software/ltn/index.html">Low-traffic neighborhood</a> for understanding how modal filters
can discourage vehicle traffic from cutting through residential areas.</li>
</ul>
<p>Some dedicated tools for the OpenStreetMap community:</p>
<ul>
<li><a href="software/osm_viewer.html">OpenStreetMap viewer</a> for auditing lane tagging</li>
<li><a href="software/parking_mapper.html">Parking mapper</a> for editing street parking data</li>
</ul>
<p>Some pieces of the code-base are eventually destined to be stand-alone and
useful for other projects:</p>
<ul>
<li><a href="software/../tech/dev/ui.html">widgetry</a> Rust UI library for native/web</li>
<li>a
<a href="https://github.com/a-b-street/abstreet/blob/master/map_model/src/make/initial/lane_specs.rs">common library</a>
for transforming OpenStreetMap key/values to a clear schema of lanes</li>
</ul>
<p>And some planned projects:</p>
<ul>
<li>a
<a href="https://docs.google.com/document/d/1ejmOPNyizR8owqjEbTYlIAN4l5QgLPJ85-es26q8nfg/edit?usp=sharing">low traffic neighborhood planner</a></li>
<li>something focused on
<a href="https://github.com/a-b-street/abstreet/issues/372">public transit</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ab-street"><a class="header" href="#ab-street">A/B Street</a></h1>
<ul>
<li><a href="software/../user/index.html">Download</a></li>
<li><a href="http://play.abstreet.org/0.3.20/abstreet.html">Play on the web</a></li>
<li><a href="https://github.com/a-b-street/abstreet/tree/master/game/src">Github</a></li>
</ul>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>A/B Street is a traffic simulation game exploring how small changes to roads
affect cyclists, transit users, pedestrians, and drivers. In other words, you
can transform that street parking into a bus lane or fix that pesky left turn at
a traffic signal, measure the effects, then
<a href="software/../proposals/index.html">propose actually making the change</a>.</p>
<p>A/B Street uses game-like elements to gradually introduce all of the features of
the simulation, with a tutorial and a few challenge modes. But just becaused
it's called a &quot;game&quot; doesn't mean it's not trying to model the real world as
accurately as possible from open data. (Keep in mind it's impossible to simulate
all complexity in the real world of people moving around a city. Every traffic
model makes lots of assumptions and trade-offs, including A/B Street.)</p>
<h2 id="explore"><a class="header" href="#explore">Explore</a></h2>
<p>A/B Street gives you a 2D representation of roads, with as much detail about
bus/bike/turn/parking lanes, transit stops, traffic signals, and parking lots as
possible, all from OpenStreetMap.</p>
<p><img src="software/../project/history/retrospective/road_width_abst.png" alt="" /></p>
<p>Depending on elevation data availability, some areas let you visualize steep
streets -- because your bike network should be planned accordingly.</p>
<p><img src="software/../project/history/retrospective/data_elevation.png" alt="" /></p>
<p>Using external travel demand models, you can explore patterns of where people
live, work, and shop.</p>
<p><img src="software/../project/history/retrospective/commuter_patterns.png" alt="" /></p>
<h2 id="simulate"><a class="header" href="#simulate">Simulate</a></h2>
<p>Using some external data about what trips people take on a typical day, you can
simulate drivers, bicyclists, and pedestrians moving around. (Public transit and
scooter/bikeshare micromobility planned.)</p>
<p><img src="software/../project/history/retrospective/traffic_sim.gif" alt="" /></p>
<p>You can follow individual people and watch them wrestle with problems, or get a
bird's-eye view of how everything is moving.</p>
<p>Every driving trip begins and ends with
<a href="software/../tech/trafficsim/parking.html">parking</a>, which might be easy in suburban areas,
but hard in cities.</p>
<p>Some details:</p>
<ul>
<li>People will take the best route available, <strong>not</strong> accounting for current
congestion. Drivers prefer the fastest route (shorter distances, higher speed
limits). Pedestrians and cyclists also factor in elevation changes.</li>
<li>Vehicles
<a href="software/../tech/trafficsim/discrete_event/index.html">instantly accelerate and stop</a>.
This is a useful simplification to speed up the simulation, but of course, you
shouldn't use A/B Street to simulate jam waves on freeways.</li>
<li>Vehicles stay in the same lane once they pick it, and sometimes they choose
their lane really poorly. We're working on improving this.</li>
<li>We don't simulate accidents -- but we do measure &quot;risk exposure&quot; where a
collision may be likely.</li>
</ul>
<h2 id="edit"><a class="header" href="#edit">Edit</a></h2>
<p>A/B Street lets you change how road space is divided up. You can create regular
vehicle lanes, bus-only lanes, bike lanes, street parking, and new sidewalks.
You can either transform existing lanes, or slightly widen/shrink the road. You
can reverse the direction of lanes, or close them down to simulate construction.</p>
<p><img src="software/../project/history/retrospective/edit_roads.gif" alt="" /></p>
<p>You can also change speed limits and restrict access to an area. Only trips that
start or end in a private area can use the roads within, modelling gated
communities. Or you can allow through-traffic for people walking and biking, to
create low-traffic neighborhoods.</p>
<p>You can also change how traffic signals work. You can modify the timing if you
notice left turns need more time, or set up actuated timing, so that the green
light lasts longer when many vehicles are waiting. You can also change which
movements are allowed each stage, so you could try out a dedicated left turn
stage or a pedestrian all-walk/scramble cycle.</p>
<p><img src="software/../project/history/retrospective/edit_signals.gif" alt="" /></p>
<h2 id="measure"><a class="header" href="#measure">Measure</a></h2>
<p>A/B Street lets you tell data-driven stories about both infrastructure and
people.</p>
<p><img src="software/../project/history/retrospective/viz_delay_scatter.gif" alt="" /></p>
<p><img src="software/../project/history/retrospective/viz_trip_table.gif" alt="" /></p>
<p><img src="software/../project/history/retrospective/viz_time_summary.gif" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ungap-the-map-envisioning-better-bike-networks"><a class="header" href="#ungap-the-map-envisioning-better-bike-networks">Ungap the Map: envisioning better bike networks</a></h1>
<p>Ever want to visualize how your city would look if streets were designed to
safely/comfortably make most trips by bike? This tool lets you quickly sketch
out your own vision to fill in missing gaps in the network, see how the changes
would impact your commute, and share the results with others.</p>
<ul>
<li><a href="http://play.abstreet.org/0.3.20/abstreet.html?--ungap&amp;system/us/seattle/maps/central_seattle.bin">Web version</a></li>
<li>To work for larger areas (like all of Seattle), it's highly recommend to
install the <a href="https://github.com/a-b-street/abstreet/releases">latest release</a>
for Windows, Mac, or Linux. After unzipping, run <code>ungap_the_map.sh</code> or
<code>ungap_the_map.bat</code>.</li>
<li>See an <a href="software/ungap_the_map/../../proposals/seattle_bikes/index.html">example vision for Seattle</a></li>
<li><a href="https://youtu.be/x--ULeDbeOc">15-minute video overview</a></li>
<li>This page: <a href="http://bike.abstreet.org">bike.abstreet.org</a></li>
</ul>
<p><img src="software/ungap_the_map/demo.gif" alt="" /></p>
<h2 id="credits"><a class="header" href="#credits">Credits</a></h2>
<p>This project was inspired by conversations with members of Seattle Neighborhood
Greenways, who had feedback about the main A/B Street traffic simulation being
too open-ended. This was developed
<a href="https://github.com/a-b-street/abstreet/issues/743">during August-October 2021</a>
for the Taiwan presidential hackathon. This tool is part of A/B Street, which
has had <a href="software/ungap_the_map/../../project/team.html">many contributors</a>, but specifically for this
tool:</p>
<ul>
<li>Dustin Carlino: primary creator</li>
<li><a href="https://github.com/michaelkirk">Michael Kirk</a>: usability feedback and fixes,
ideas for what the tool should do, implemented road labels and large parts of
the lane editor</li>
<li><a href="https://www.mara-cruz.com/">Mara Cruz</a>: part-time UX help, connections to
NYC's advocacy group</li>
<li><a href="https://www.robinlovelace.net/">Robin Lovelace</a>: domain knowledge about
<a href="https://github.com/a-b-street/abstreet/issues/448">mode shift</a></li>
<li><a href="https://www.yuwen-li.com/">Yuwen Li</a>: A/B Street's main UX designer. Not
directly involved in this tool, but the design is largely adapted from her
prior work</li>
<li>the <a href="https://got99problems.org">Aurora Reimagined Coalition</a> for letting us
bring a prototype to a design workshop event</li>
<li>contributors from the
<a href="https://www.democracylab.org/events/ndoch-2021">National Day of Civic Hacking</a></li>
<li><a href="https://eldang.xyz/">Eldan Goldenberg</a>: prior work on
<a href="https://github.com/eldang/elevation_lookups">elevation data</a></li>
<li>the <a href="https://openstreetmap.org/about">OpenStreetMap</a> community</li>
<li>Angelina and Amanda, DemocracyLab volunteers, for participating in usability
studies</li>
<li>the organizers of the
<a href="https://presidential-hackathon.taiwan.gov.tw/en/international-track/">Taiwan hackathon</a>
for providing motivation and direction for the project</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="user-guide"><a class="header" href="#user-guide">User guide</a></h1>
<p>You can use the different parts of this tool in any order you like, but the
recommended flow is:</p>
<ol>
<li>Start by exploring the existing bike network in your city. Try zooming in to
see detail about how street space is currently used!</li>
<li>Go plan a trip to see what trade-offs between safety and speed you might
experience biking today. You can save these trips to later evaluate your
proposal.</li>
<li>Create new bike lanes where you think they should exist!</li>
<li>Check your trips again, to see if the most direct route is now safer.</li>
<li>Use the &quot;predict impact&quot; mode to estimate how many other people might make
use of your changes.</li>
<li>Upload your proposal, then share on social media or start a conversation
with your local city government or advocacy groups!</li>
</ol>
<h2 id="general-tips"><a class="header" href="#general-tips">General tips</a></h2>
<p>This software can run in your web browser without any installation. If the
loading times are slow,
<a href="https://github.com/a-b-street/abstreet/releases">install and run</a> for a much
faster experience, especially for larger areas. There's no support for mobile
devices yet.</p>
<p>You can move around the map just like most digital maps. Click and drag to pan
around. To zoom in, just scroll with your mouse or touchpad, double click, or
use the buttons in the corner. This map shows much more detail when you zoom in
-- give it a try!</p>
<p>The map works anywhere in the world. You can use the button at the top to change
regions. Many cities have already been set up. If you're using the downloaded
version, you can also import another region yourself. (Sorry, no web support for
that yet.) If you want any help importing your region,
<a href="https://github.com/a-b-street/abstreet/issues">file an issue</a> or contact
<a href="mailto:software/ungap_the_map/dabreegster@gmail.com">dabreegster@gmail.com</a>.</p>
<h2 id="exploring-the-map"><a class="header" href="#exploring-the-map">Exploring the map</a></h2>
<p><img src="software/ungap_the_map/exploring_both_zooms.gif" alt="" /></p>
<h3 id="types-of-bike-infrastructure"><a class="header" href="#types-of-bike-infrastructure">Types of bike infrastructure</a></h3>
<p>If you open the layers in the corner, you'll see that bike infrastructure is
divided into 4 categories. Dedicated trails are usually the most segregated from
motor vehicles, and are often shared with people walking. In most cities, most
bike facilities are directly on the street, alongside traffic. Protected bike
lanes have some kind of buffer protecting cyclists from other vehicles --
sometimes concrete barriers, but often just about a foot of paint and some
flexible bollards. Painted lanes have no protection from traffic; cyclists just
have to trust vehicles not to cross a thin line of paint. Often painted lanes
are located very close to street parking, forcing cyclists to ride in the &quot;door
zone,&quot; where somebody in a parked car might suddenly open their door and block
the lane.</p>
<p>Greenways are streets where vehicles and cyclists share the same space. The city
has designated these as low traffic, and there might be small traffic calming
measures to discourage high-speed traffic -- like speed bumps, slaloms, curb
bulbs, small traffic circles, and signage. These routes have different names
across the world -- Stay Healthy Streets, neighborhood greenways, low-traffic
neighborhoods, slow streets, etc. In a place like Seattle, these streets are
very narrow because of cars parking on both sides, so when a cyclist and an
oncoming vehicle need to pass each other, both have to slow down. In the
author's opinion, it doesn't feel like the cyclist really has any sort of
priority here.</p>
<p>Finally, some cities use &quot;sharrows,&quot; or painted markings, on general-purpose
lanes to indicate to drivers that they're supposed to share the road. These
aren't reflected in the map at all, because they're not real infrastructure.
Studies have shown they can actually
<a href="https://www.bloomberg.com/news/articles/2016-02-05/study-sharrows-might-be-more-dangerous-to-cyclists-than-having-no-bike-infrastructure">make things worse</a>.</p>
<h3 id="understanding-elevation-layers"><a class="header" href="#understanding-elevation-layers">Understanding elevation layers</a></h3>
<p>Many places are flat or have widespread adoption of e-bikes. But in cities like
Seattle and San Francisco, the city is arranged on steep hills, which can deter
people from cycling for commuting. If you open the layers panel, you have two
ways to understand how the topography affects biking.</p>
<p>The elevation layer draws a contour map, drawing higher elevation in red. You
can quickly get a sense of how the city is arranged, and discover unexpected
flat &quot;shortcuts&quot; when the streets aren't aligned to the hills!</p>
<p><img src="software/ungap_the_map/greenwood_elevation.png" alt="" /></p>
<p>You can also check the incline on individual street segments. The arrows point
uphill.</p>
<p><img src="software/ungap_the_map/steep_streets.png" alt="" /></p>
<p>Note the elevation data is high-quality for Seattle, but has
<a href="software/ungap_the_map/tech_details.html#elevation-data">issues in the rest of the world</a>. And the
estimated incline on bridges is usually wrong!</p>
<h2 id="planning-a-trip"><a class="header" href="#planning-a-trip">Planning a trip</a></h2>
<p>Use this mode to plan a cycling trip. Just click the map to add waypoints, or
drag the waypoints to adjust.</p>
<p><img src="software/ungap_the_map/waypoints.gif" alt="" /></p>
<h3 id="saving-trips"><a class="header" href="#saving-trips">Saving trips</a></h3>
<p>You can name each trip, then save it. This is useful to define &quot;test cases&quot; for
evaluating how well the bike network serves the trip. The sample trips could be
based on your own commute, or trips you know are common -- like from a
university to the popular night-life district.</p>
<h3 id="preferences"><a class="header" href="#preferences">Preferences</a></h3>
<p>When you plan a bike route, you usually have to make a trade-off between time,
hilliness, and stress. The fastest, most direct route often forces you to ride
alongside high-speed traffic. Often the safer route will avoid major roads and
take longer, and maybe also force you to climb steeper hills.</p>
<p>By default, the most direct route is shown. You can change your preferences with
the checkboxes. Alternative routes are also shown, and if you hover over one,
you can compare to the direct route.</p>
<h3 id="details"><a class="header" href="#details">Details</a></h3>
<p><img src="software/ungap_the_map/route_details.gif" alt="" /></p>
<p>Besides showing you the distance and estimated time of a route, the tool also
tells you how comfortable the trip might be. You can see which segments of the
route travel on high-stress roads, which are defined as major roads without any
dedicated bike lanes. You can also explore the elevation profile of your route,
see the number of traffic signals you'll encounter, and check any potentially
difficult turns.</p>
<h2 id="creating-new-bike-lanes"><a class="header" href="#creating-new-bike-lanes">Creating new bike lanes</a></h2>
<p><img src="software/ungap_the_map/creating_lanes.gif" alt="" /></p>
<p>Once you know where you'd like to add new bike infrastructure, use this tool to
quickly sketch it up. Click the start and end of the path you want to modify,
then you can adjust by dragging intermediate points.</p>
<p>You can choose what type of bike lanes you want to add. Just painting lanes
takes the least amount of space, but adding some kind of barrier makes them much
safer. The software makes best guesses at the existing width of the road, and
adding bike lanes should never physically increase that width, but there may be
errors. Generally the tool will try to replace street parking first, then
sacrifice a driving lane if there are multiple. If there's no room (according to
the imperfect data) to add lanes, the tool won't make any changes. You can
always use explore mode to edit the road individually to fix up any problems.</p>
<p>Also note some roads fork off into separate pieces when there's some kind of
physical median. When you select a route to modify, this only traces one
direction. You might need to repeat for the other side.</p>
<h3 id="proposals"><a class="header" href="#proposals">Proposals</a></h3>
<p>Once you make changes to the map, you can save and load them. Maybe you have a
few different alternatives you'd like to try, or you'd like to compare your
ideas when your city's official plans.</p>
<p>You can also upload your proposal and share the URL with others. Note that
proposals are uploaded anonymously, and when you make any changes, you have to
upload again and share a new URL.</p>
<h3 id="editing-roads-in-detail"><a class="header" href="#editing-roads-in-detail">Editing roads in detail</a></h3>
<p>If you zoom into an individual road, you can click on it to edit. With this
mode, you can customize the width of each lane and other details. If you're
focused only on a small area, this might be useful. But if you're interested in
quickly sketching over a large area, use the &quot;create new bike lanes&quot; mode.</p>
<p><img src="software/ungap_the_map/../../project/history/retrospective/edit_roads.gif" alt="" /></p>
<h2 id="predict-impact"><a class="header" href="#predict-impact">Predict impact</a></h2>
<p><img src="software/ungap_the_map/predict_impact.png" alt="" /></p>
<p>Evaluating your proposed network against a few sample trips is useful, but from
a planner's perspective, you want to predict how many people will make use of
the new infrastructure. This tool analyzes all short driving trips in the area,
then calculates which of them might decide to switch to cycling. This feature
only works in Seattle or the UK, where we have a travel demand model describing
the population's existing commuter patterns.</p>
<p>There are <a href="software/ungap_the_map/tech_details.html#predict-impact">many assumptions</a> going into this
calculation. You can adjust many of these parameters yourself. The first bar
shows all of the driving trips in the area. First you have to decide which of
them would even consider switching. Based on existing research, the two main
factors are the time the biking trip would take instead, and the amount of hills
encountered. People with a quick, comfortable drive today are unlikely to bike
for a long time up steep hills.</p>
<p>The middle bar changes to show you how many of the trips would consider
switching, based on these settings. Now the question becomes, if these trips
wouldn't be so inconvenient for people to bike, what's stopping them today? Of
course there are many factors, but the one this software focuses on is safety --
the direct cycling route encounters too many high-stress roads without any bike
lanes. The red heatmap shows you these problems, ranking which roads are the
most important to fix, based on the number of trips that're prevented from
switching.</p>
<p>In response to your proposed network, the final bar guesses how many trips would
switch to biking if your changes were built. Then, to quantify the environmental
impact, the miles spent driving currently are added up, repeated every weekday
for a year, and converted to CO2 emissions. If your proposal comes to life, this
is what might be saved.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="project-motivation"><a class="header" href="#project-motivation">Project motivation</a></h1>
<p>This document will argue why this bike network software can help achieve the
UN's <a href="https://sdgs.un.org/goals/goal11">Sustainable Development Goal 11</a> of
improving cities.</p>
<p>The <a href="https://en.wikipedia.org/wiki/Theory_of_change">theory of change</a> summary:</p>
<ul>
<li><strong>Problem</strong>: Car dependency harms the environment. Biking is one low-cost
alternative. Cities need to build infrastructure to make it safe. Poor
communication between stakeholders slows down these changes.</li>
<li><strong>Activities</strong>: This new &quot;Ungap the Map&quot; software will help stakeholders
communicate more effectively.</li>
<li><strong>Outputs</strong>: Better plans for bike networks and increased civic engagement.</li>
<li><strong>Outcomes</strong>: Bike networks get built more quickly.</li>
<li><strong>Impacts</strong>: More people decide to bike, decreasing the environment impact of
transportation.</li>
</ul>
<h2 id="driving-is-a-problem"><a class="header" href="#driving-is-a-problem">Driving is a problem</a></h2>
<p>According to the EPA,
<a href="https://www.epa.gov/transportation-air-pollution-and-climate-change/carbon-pollution-transportation">29% of greenhouse gases in the USA come from transportation in 2019</a>.
Driving causes many other externalities -- noise pollution, an incredible amount
of space is used for parking, collisions kill many people, and incentivizing
driving reinforces suburban sprawl and unsustainable land use patterns. Even
though less people drove in 2020,
<a href="https://www.nhtsa.gov/press-releases/2020-fatality-data-show-increased-traffic-fatalities-during-pandemic">more people died from car collisions</a>.
Similar statistics can be found across most of the world. Many people have made
strong arguments that cities need to drastically reduce the use of personal
motor vehicles for trips.</p>
<p>A popular deflection currently is that fossil-fuel based cars are the problem,
and that electric vehicles will solve these problems. While they certainly help
with engine emissions, they still pollute due to
<a href="https://epha.org/electric-vehicles-and-air-pollution-the-claims-and-the-facts/">tires</a>
and do nothing to help with the space consumption or safety problem. And
migrating the majority of gas cars to electric would be incredibly expensive!</p>
<p>Another false promise is autonomous vehicles. The technology is seemingly always
a few years away from wide rollout. Even once it's ready, there's a very real
risk that it'll just exasperate problems with suburban sprawl even more, by
letting people tolerate longer hands-off commutes. As Tom MacWright has
explained,
<a href="https://macwright.com/2019/07/27/beware-the-ethical-car.html">beware the ethical car</a>.</p>
<h3 id="the-alternatives-to-driving"><a class="header" href="#the-alternatives-to-driving">The alternatives to driving</a></h3>
<p>Major European and Asian cities have effective mass public transit, and some --
the Netherlands being the most famous example -- have a high percentage of trips
done via bicycle. The world isn't missing some new technology like autonomous
cars; car-centric places can just look at these existing places for inspiration
on how to design sustainable transportation systems.</p>
<p>Transitioning away from cars is a very complicated problem, and the solution
probably involves land use changes (allowing mixed commercial/residential use to
create 15-minute neighborhoods, and changing zoning laws to allow mid-rise
residential buildings where only single-family homes exist today), investing in
public transit (both local buses and regional high-speed rail), designing proper
spaces for walking and biking, and encouraging remote working and staggered
commute times. It's also important to discourage automobile use as these
alternatives become available, by ending gas subsidies, implementing congestion
charges around city centers, removing parking minimum requirements, and so on.</p>
<p>Many of these changes are expensive or very complicated and slow to implement.</p>
<h3 id="the-case-for-biking"><a class="header" href="#the-case-for-biking">The case for biking</a></h3>
<p>This project focuses on a small piece of the solution: biking. Both cost and
benefit motivate this. Amazingly,
<a href="https://www.bikeleague.org/content/national-household-travel-survey-short-trips-analysis">60% of trips in the US are under 5 miles</a>
-- a range easily covered by a bike or an e-bike.
<a href="https://usa.streetsblog.org/2021/03/30/why-the-u-s-needs-a-bold-2030-mode-shift-target/">This report</a>
estimates that urban transport emissions could be reduced by 7% if a modest 16%
of trips were shifted from driving to biking. Biking also gets people doing
moderate exercise, and it's even a low-impact activity for people with knee
injuries! The barrier of entry and cost is much lower than driving, making it a
more widely accessible option.</p>
<p>One of the main barriers stopping people from switching to biking is safety.
Most streets are designed for moving vehicles quickly and can be incredibly
unsafe for cycling. Luckily, the cost of reallocating the space on these streets
to separate cyclists from motor vehicle traffic is low, compared to building new
light rail lines or improving bus route frequency. In the extreme case, making a
road more comfortable to bike on can be done with very little money or time, via
techniques of <a href="http://tacticalurbanismguide.com/about/">tactical urbanism</a>. Some
advocacy groups or cities will set up a temporary demonstration of a changed
street by simply using signs and movable barriers for a few days, and in other
cases, these street improvements are even
<a href="https://www.seattlebikeblog.com/2013/04/04/guerrilla-road-safety-group-politely-installs-illegal-bike-lane-protectors-on-cherry-street/">installed in the dead of night by citizen activists</a>.</p>
<h3 id="rising-momentum"><a class="header" href="#rising-momentum">Rising momentum</a></h3>
<p>Right now, cities across the world are actively finding ways to reduce car
dependency. This is a ripe time to accelerate this culture shift. Some examples:</p>
<ul>
<li><a href="https://archive.curbed.com/2020/1/15/21065343/bike-paris-cycling-anne-hidalgo">Paris has installed a huge number of new bike lanes, and seen usage skyrocket</a></li>
<li>In the middle of the sprawling Phoenix metro area, the new
<a href="https://culdesac.com">Culdesac</a> project is building the US's first car-free
neighborhood</li>
<li>Many US cities are attempting <a href="https://visionzeronetwork.org/">Vision Zero</a>
plans to reduce the number of traffic fatalities</li>
<li><a href="https://covidmeasuresbirmingham.commonplace.is/proposals/kings-heath-low-traffic-neighbourhood">Birmingham</a>
is piloting a low-traffic neighborhood</li>
<li>Advocates are pushing for a massive
<a href="https://www.theguardian.com/world/2021/oct/06/berlins-car-ban-campaign-its-about-how-we-want-to-live-breathe-and-play">car-free zone in Berlin</a></li>
<li>Many US cities transformed
<a href="https://nacto.org/publication/streets-for-pandemic-response-recovery/emerging-street-strategies/outdoor-dining/">streets into outdoor dining spaces</a>
during COVID. This kind of change would never have happened politically a few
years ago!</li>
<li>Some US cities are considering
<a href="https://www.nytimes.com/interactive/2021/05/27/climate/us-cities-highway-removal.html">removing highways</a>
that tear through the city center and have been historically used for
<a href="https://en.wikipedia.org/wiki/Redlining">redlining</a></li>
</ul>
<p>In short, the public imagination is picking up on these ideas. But this needs to
happen as fast as possible to transform cities into more sustainable places and
mitigate climate disasters.</p>
<h2 id="barriers-to-change"><a class="header" href="#barriers-to-change">Barriers to change</a></h2>
<p>So why isn't every city following Paris and building out a low-cost bike network
to encourage people to stop driving? The issue is often quite political -- if
city leaders build without the support of their constituents, they won't be
re-elected. The public very much are stakeholders. There's often quite fierce
opposition to building new bike lanes. Sometimes the arguments are based on
specifics -- some parking will be lost, and despite studies showing otherwise,
nearby businesses fear losing customers. (But these arguments rarely quantify
how much parking is available nearby -- largely because this data doesn't
generally exist without an on-the-ground survey.) Others make a very short-term
argument that vehicle traffic will be delayed by the reduction in lanes, and
this will actually increase pollution in the area. In other words, the concerns
raised are by individuals who don't buy into the idea of &quot;mode shift&quot; at all --
that the <strong>purpose</strong> of the new cycling infrastructure is to make driving a bit
less enticing and encourage people to move more sustainably. Some people quite
understandably feel &quot;left out&quot; by these transformations -- they've lived in the
city for a long time, moved around it in a certain way, and they feel threatened
by the changes. Making it safer to bike is inextricably tied up in this concern
about gentrification -- driving out long-time residents for younger, often
wealthier people who are seen as the target audience of the changes.</p>
<p>This is a really unfortunate miscommunication. Proper cycling infrastructure and
land use patterns make it very comfortable for all ages, abilities, and
demographics to thrive in a city. If cycling is just for young and athletic
people, why do people in the
<a href="https://www.statista.com/statistics/620201/average-biking-distance-per-person-per-day-netherlands-by-age/">Netherlands between 18 and 75 years all have similar distances cycled per day</a>?
Driving a car is quite expensive, with insurance and maintenance, and children
or people with vision impairment are totally excluded. Cycling can be more
inclusive.</p>
<p>A strong theme in the rhetoric around resisting change is that &quot;the new
infrastructure won't serve me individually.&quot; This view definitely ignores how
many people the changes <em>will</em> serve. But it's also short-sighted -- if lots of
<em>other</em> people switch away from driving, that's less cars on the road and less
traffic for the individual who wishes to continue. We all breathe the same air,
so reducing the vehicles on the road will benefit everyone. This is a
longer-term, broader consequence that's hard to understand.</p>
<p>Another problem with reasoning about incremental changes (often for just a
single stretch of road being redesigned) is ignoring the long-term vision.
Cities use &quot;master plans&quot; and other long-term planning documents to communicate
the overall direction, and may explain the individual changes in context of this
vision. But if that story isn't effectively told, then the public can wind up
arguing too much about the details.</p>
<p>In other words, I'm arguing that one of the biggest problems is around
communication. If city leaders could more effectively market a proposal to their
constituents, and if the public was better educated about the indirect
consequences of these changes, I believe the political will to deliver changes
would gain traction.</p>
<p>Let's look at how this communication happens today.</p>
<h3 id="large-scale-changes"><a class="header" href="#large-scale-changes">Large-scale changes</a></h3>
<p>As a first example, let's look at
<a href="https://www.seattle.gov/transportation/document-library/citywide-plans/modal-plans/bicycle-master-plan">Seattle's bike master plan</a>,
which describes what the bike network will look like by 2024. The official
documents include a
<a href="https://www.seattle.gov/Documents/Departments/SDOT/BikeProgram/BMP_Imp_Plan_2021_FINAL.pdf">PDF</a>
that has an overview map, which can't even show the road names by virtue of
being a fixed image:</p>
<p><img src="software/ungap_the_map/bmp_overview.png" alt="" /></p>
<p>There are maps showing more detail in different areas:</p>
<p><img src="software/ungap_the_map/bmp_zoomed.png" alt="" /></p>
<p>And tables summarizing some new routes:</p>
<p><img src="software/ungap_the_map/bmp_table.png" alt="" /></p>
<p>The official page doesn't link to any web map, but digging around reveals an
<a href="https://data-seattlecitygis.opendata.arcgis.com/datasets/f5b80ce716bc437c9a231d8e99f069bb_2/explore?location=47.619800%2C-122.338100%2C11.62">ArcGIS map</a>:</p>
<p><img src="software/ungap_the_map/bmp_arcgis.png" alt="" /></p>
<p>This is a little better, but it's overall pretty tough to just zoom into a road,
see at a glance what it looks like today, and see what the promised changes
by 2024.</p>
<p>A second example is Seattle Neighborhood Greenways, an advocacy group,
describing which streets they'd like to see changed to prioritize people walking
and biking, as a way to encourage exercise and social distancing during COVID.
Their plans are
<a href="https://www.google.com/maps/d/viewer?mid=1HQMnagRf8EbS1nouqCMLl4LZr0QE8VrC&amp;ll=47.641281552786445%2C-122.31769816918946&amp;z=12">a layer on top of Google Maps</a>:</p>
<p><img src="software/ungap_the_map/sng_stay_healthy_network.png" alt="" /></p>
<p>People are accustomed to interacting with maps by routing, to see what their
particular trip might look like. None of these solutions let you plan a trip and
compare how things might look before vs after the changes. As an individual, I
want to know if these plans will make it safer, let me avoid hills, or let me
comfortably bike past a commercial district. I have to interpret these planned
changes and apply them to my particular situation. Or if I care about broader
impact, these documents fail to sell me on the benefits, &quot;we forecast that
200,000 weekly trips will likely start biking instead of driving if we make
these changes. That could lower PM2.5 pollution by 3%...&quot;</p>
<p>These methods of communication are also very &quot;dry&quot; -- they do nothing to paint a
picture or tell a story about how awesome the city will be once this is built.</p>
<h3 id="individual-projects"><a class="header" href="#individual-projects">Individual projects</a></h3>
<p>Let's examine plans to
<a href="https://wsdot.wa.gov/projects/sr520/montlake/home">install a &quot;lid&quot; over the 520 highway in Montlake, Seattle</a>.
The plans show a new park where there used to just be a loud, unpleasant road.
This is better in terms of visioning! But advocacy blogs have called out some
important questions about these plans -- how long will it take for a pedestrian
to wait for a light and cross from the west to east side (from a residential
area to a light rail station)? In other words, what's the actual experience of
just moving through the space as a pedestrian? A static map or diagram is going
to have a hard time communicating this.</p>
<p><img src="software/ungap_the_map/montlake_lid.png" alt="" /></p>
<p>Visualizations of changes also tend to be very high-level or very low-level, and
switching between the two views is difficult. For
<a href="https://www.seattle.gov/transportation/projects-and-programs/programs/maintenance-and-paving/current-paving-projects/green-lake-area-paving-and-safety-projects">changes around Green Lake</a>,
here's an overview map:</p>
<p><img src="software/ungap_the_map/greenlake_overview.png" alt="" /></p>
<p>And a CAD drawing:</p>
<p><img src="software/ungap_the_map/greenlake_detail.png" alt="" /></p>
<p>One of the best examples communicating changes I've found is San Francisco's
<a href="https://storymaps.arcgis.com/stories/c44dfec403664e0ca3d2af6bd048b2ae">Golden Gate park story map</a>:</p>
<p><img src="software/ungap_the_map/golden_gate.png" alt="" /></p>
<h3 id="gathering-public-feedback"><a class="header" href="#gathering-public-feedback">Gathering public feedback</a></h3>
<p>Besides just asking people how they feel about some proposals, sometimes
governments directly solicit ideas from people -- a form of crowd-sourcing.
Seattle's
<a href="https://www.seattle.gov/neighborhoods/programs-and-services/your-voice-your-choice">Your Voice, Your Choice</a>
is an example, where people can drop pins on a map, describe a problem and
possible solution. This program is meant for low-cost, &quot;spot fixes&quot; like making
a certain intersection safer.</p>
<p>Probably the state-of-the-art in public engagement is
<a href="https://streetmix.net">Streetmix</a>, a very easy-to-use and fun website that lets
you rearrange space along a single street. People routinely share ideas through
Streetmix, and public agencies often explain changes using it. The sheer
ease-of-use and strong visuals are keys to its success -- the creators have a
strong design background, and it pays off. Proposals in Streetmix have even
become reality --
<a href="https://thecityfix.com/blog/how-bogota-is-turning-7000-citizen-proposals-into-a-real-plan-to-redesign-a-major-thoroughfare/">Bogota gathered 7,000 proposals</a>
from the public, then settled on something based on these designs.</p>
<p><img src="software/ungap_the_map/streetmix.png" alt="" /></p>
<p>Members of the public aren't experts in transportation engineering, so why not
leave the work to the professionals?
<a href="http://www.govtech.com/data/SimCities-Can-City-Planning-Mistakes-Be-Avoided-Through-Data-Driven-Simulations.html">Laura Adler</a>
writes &quot;Only with simple, accessible simulation programs can citizens become
active generators of their own urban visions, not just passive recipients of
options laid out by government officials.&quot;. Individuals <em>are</em> experts at some
slice of the city, since they interact with it every day. It's unlikely city
planners know every corner of the city as deeply as everyone else combined, so
incorporating their experiences is important.</p>
<p>Besides generating better proposals,
<a href="https://en.wikipedia.org/wiki/Participatory_design">participatory design</a> can
also decrease resistance to change.
<a href="http://www.urbanmovement.co.uk/brian-deegan.html">Brian Deegan</a>, one of the
UK's leading street designers, describes this
<a href="https://youtu.be/pHucS2F33W8?t=1684">during a workshop for planning low-traffic neighborhoods</a>.
When he frames things as a puzzle -- &quot;The number of cars has doubled in the last
few years, they just don't fit, we have to fix this somehow&quot; -- people set aside
their personal biases and just treat it as an abstract problem to solve. As a
result, everyone in the room feels more invested in the ideas produced.
&quot;Gamifying&quot; the planning process could be powerful.</p>
<h2 id="how-this-project-can-help"><a class="header" href="#how-this-project-can-help">How this project can help</a></h2>
<p>A/B Street in general and this bike tool in particular are an attempt to:</p>
<ol>
<li>help different stakeholders communicate more effectively</li>
<li>visually inspire people to see what their city could become</li>
<li>increase public engagement in transportation planning and amplify voices</li>
</ol>
<p>Some example &quot;success stories&quot; might look like this:</p>
<ol>
<li>City planners use the software to sell the public on existing plans that're
facing the threat of budget cuts</li>
<li>Advocacy groups help amplify that message</li>
<li>Support for the plans grows, people vote to fund it</li>
</ol>
<p>Or:</p>
<ol>
<li>The government is struggling to implement a contentious low-traffic
neighborhood plan. A vocal minority of the public is demanding the changes
are cancelled.</li>
<li>The city organizes an online &quot;competition&quot; to design the best compromise,
using the new software</li>
<li>People self-organize and debate their competing solutions to a shared puzzle,
focusing on the details specific to their area</li>
<li>The government adopts the winning solution and people accept it more readily,
<strong>because they've been forced to work through the trade-offs of alternatives
themselves</strong></li>
</ol>
<p>To clarify, A/B Street isn't meant to replace any internal CAD or engineering
processes that the city already internally uses. It's meant for rapid
prototyping and communication; it's a new first step in the design process.</p>
<h3 id="prior-art"><a class="header" href="#prior-art">Prior art</a></h3>
<p>Other software exists for related problems. But nothing other than A/B Street:</p>
<ul>
<li>visualizes as much detail about existing street layout and bicycle facilities</li>
<li>lets users easily mock up changes to a bike network, and route using the
changes</li>
<li>works anywhere in the world without substantial setup time</li>
<li>is free and available to anybody</li>
</ul>
<p><a href="http://streetmix.net">Streetmix</a> is a huge inspiration behind A/B Street. But
it only focuses on an individual street segment; it can't show how bicycle
infrastructure exists in context of an entire city.</p>
<p><a href="http://remix.com">Remix</a> has some similar goals, but it's meant for different
city agencies to internally collaborate. It's expensive, unavailable to the
public, and cities are only just starting to use it for public communication.</p>
<p><a href="https://www.ptvgroup.com/en/solutions/products/ptv-vissim/">PTV Vissim</a> is an
industry-standard traffic simulator. Many of its customers use it to calibrate
traffic models and plan changes. But it's extremely expensive and very difficult
to use, especially when initially setting up in a new city.</p>
<p><a href="https://www.matsim.org">MATSim</a> and <a href="https://www.eclipse.org/sumo">SUMO</a> are
open source traffic simulators that can run anywhere in the world. However,
they're hard to setup and use, not focused on visualization, and can't easily
prototyping changes to roads. They also don't run in web browsers, a further
barrier towards people that aren't tech-savvy trying them.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="project-plan"><a class="header" href="#project-plan">Project plan</a></h1>
<h2 id="stakeholders"><a class="header" href="#stakeholders">Stakeholders</a></h2>
<p>There are three groups usually involved with city-scale transportation planning.
First are government agencies -- city departments of transportation (DOT),
state-level DOTs for some projects, public transit agencies, etc. Sometimes
these contract planning or design work out to private consulting companies.
Second are local advocacy groups, who help raise awareness about safety issues
and vocally push the government to make changes. Third are individual citizens.
Once they're engaged by the issue of inadequate cycling infrastructure -- often
because of personal experiences or from looking for safe routes for their
children to bike to school -- they get involved in a few ways. Many join the
advocacy groups, volunteering their time. A few --
<a href="https://www.seattlebikeblog.com/2018/01/19/a-roosevelt-junior-redesigned-the-streets-around-his-high-school-and-his-plan-is-better-than-sdots/">Joe Mangan</a>
and <a href="https://twitter.com/pushtheneedle/">Pushing the Needle</a> being notable
examples -- start directly writing about their vision. And many more spend
endless hours debating strangers online on sites like Reddit, Twitter, or the
<a href="https://www.theurbanist.org/">Urbanist blog</a>.</p>
<p>The aim is for A/B Street to engage all of these stakeholders using the same
data and software. Engagement strategies so far include meeting people in person
(through meetups, community bike ride events, and public talks), posting demos
online (using the &quot;wow factor&quot; of the software to grab attention), and
networking. The most common problem so far (from the ~3 years of A/B Street
work) is simply not hearing back. An individual or group initially finds the
project, expresses interest, but disappears after an initial meeting.</p>
<p>Another challenge is deciding what software solutions can best help. A/B
Street's focus has jumped all over the place -- traffic simulation, collecting
data for traffic signal timing, 15-minute neighborhoods -- because none of the
stakeholders clearly express a need for software to solve a particular problem.
Few of these groups have much technical expertise in software, so how could they
even imagine some far-fetched program that doesn't resemble anything they've
used before? In traditional software companies, product managers serve the role
of engaging with these groups, learning about their problems, and gathering
feedback about possible solutions. The A/B Street team doesn't have resources
for that so far.</p>
<p>A barrier to engaging with government agencies is establishing professional
credibility. Governments are risk-averse and establish private industry partners
slowly. A/B Street is an open source project not seeking any kind of profits,
and backed by a few volunteer individuals. This is not something agencies are
used to dealing with -- although in the past, Seattle's open data program hosted
some hackathons specifically to engage with civic hackers. One workaround is to
partner with academic researchers, who have more credibility and some prior
relationships with government.</p>
<h3 id="seattle"><a class="header" href="#seattle">Seattle</a></h3>
<p>The launch plan for the bike network tool in Seattle includes all of these
groups:</p>
<ul>
<li>Individuals
<ul>
<li>The <a href="https://old.reddit.com/r/seattlebike">r/seattlebike subreddit</a></li>
<li>publishing an article to
<a href="https://www.seattlebikeblog.com">Seattle Bike Blog</a></li>
<li>The hope is for individual readers of these online communities to try out
the software, upload their proposals, and maybe become more involved with
widely publishing their ideas. This will help demonstrate the people's
visions to the government in a more visual and specific way than what
happens now.</li>
</ul>
</li>
<li>Advocacy groups
<ul>
<li><a href="https://seattlegreenways.org/">Seattle Neighborhood Greenways</a>, with whom
I've been involved for a while. They're starting an &quot;ungap the map&quot;
campaign, which was one of the original inspirations for this tool's focus.
<ul>
<li>The A/B Street team is already involved with one local chapter,
<a href="https://www.got99problems.org">the Aurora Reimagined Coalition</a>. We
attended a live design workshop in late August and got feedback on the
initial prototype of the tool.</li>
</ul>
</li>
<li><a href="https://www.glwstreets.org/complete-the-loop">Move Redmond</a>, a similar
group for a nearby city. I have some contact with them previously.</li>
<li><a href="https://completestreetsbellevue.org/">Complete Streets Bellevue</a>, also have
prior contact.</li>
</ul>
</li>
<li>Government entities
<ul>
<li>I've met and demonstrated A/B Street to a few people within
<a href="https://www.seattle.gov/transportation">SDOT</a>, but unfortunately I don't
expect any further response from them.</li>
<li>The
<a href="http://www.seattle.gov/seattle-bicycle-advisory-board">Seattle Bike Advisory Board</a>
is more likely to be responsive.</li>
<li>Seattle is about to elect a new mayor and city council in November. All the
major candidates mention biking in their platforms, so I'll get in touch.</li>
</ul>
</li>
</ul>
<p>A/B Street has wound up local <a href="https://www.youtube.com/watch?v=Pk8V-egsUxU">TV</a>
and
<a href="https://www.thestranger.com/slog/2020/06/29/43999454/ab-streets-game-lets-you-create-the-seattle-street-grid-of-your-dreams">newspaper</a>
media before. It might be strategic to repeat this for the new software, but I'd
like to wait and see how many people use the tool and upload proposals. If
there's a strong community response, I think this would merit another story.</p>
<h3 id="uk"><a class="header" href="#uk">UK</a></h3>
<p>There's one exception to the difficulties mentioned previously about getting
clear product requirements.
<a href="http://www.urbanmovement.co.uk/brian-deegan.html">Brian Deegan</a> is a cycling
planner who does consulting across the UK and whose company has written lots of
<a href="http://www.urbanmovement.co.uk/beeachampion.html">design manuals</a>. Thanks to
<a href="https://www.robinlovelace.net">Robin</a>, A/B Street has a relationship with
Brian, and based on studying a design workshop video by Brian, we've started
prototyping a new tool focused on placing modal filters to establish low-traffic
neighborhoods. The UK planning scene is currently more focused on this type of
intervention than building bike lanes. So, we're planning to pivot and focus on
this LTN tool after mid-October. The long-term strategy is to continue building
these smaller, focused tools, all leveraging the common A/B Street technical
platform. Different regions and situations will demand different planning
software.</p>
<h3 id="nyc"><a class="header" href="#nyc">NYC</a></h3>
<p>Thanks to the tool's part-time UX contributor
<a href="https://www.mara-cruz.com/">Mara</a>, we have a future meeting with
<a href="https://www.transalt.org">TransAlt</a>, an advocacy group in NYC.</p>
<h3 id="others"><a class="header" href="#others">Others</a></h3>
<p>The A/B Street team has a collaborator at the
<a href="https://github.com/asu-trans-ai-lab/">Arizona State Transportation AI lab</a>. It
could be the right time to focus on the currently car-centric Phoenix metro
area, with things like the <a href="https://culdesac.com">car-free Culdesac community</a>
gaining traction.</p>
<p>San Francisco is another high-potential market for the bike tool. They have
extreme hills, a very active
<a href="https://bikesiliconvalley.org">cycling advocacy group</a>, and a large tech
industry workforce likely to be interested in this kind of software. During
COVID, they established many
<a href="https://sf.eater.com/2021/6/3/22457397/sf-restaurants-support-slow-streets-permanent">slow streets</a>.
The A/B Street team has some connections to local advocates here.</p>
<h2 id="results-so-far"><a class="header" href="#results-so-far">Results so far</a></h2>
<p>Stay tuned for the reaction to the tool's launch and the example
<a href="software/ungap_the_map/../../proposals/seattle_bikes/index.html">Seattle proposal</a>. Ultimately the
measurable result is the number of real bike lane projects that reach
construction and used A/B Street in some part of the planning or engagement
process. In the short term, metrics we'll track are the number of proposals
uploaded, the responses on social media, and any new collaborations that're
started after launching.</p>
<h2 id="action-plan"><a class="header" href="#action-plan">Action plan</a></h2>
<p>The immediate plans are to launch the tool the week of October 11 to all of the
listed Seattle stakeholders. In a few weeks, we'll meet with NYC's TransAlt
group. If the initial response in Seattle is quiet, we will launch to San
Francisco, after fixing some elevation data issues there.</p>
<p>Roughly whenever we want, we could scale up to more cities. There's always some
specialized effort to fix the most egregious OpenStreetMap data quality issues.
Getting travel demand data is a common challenge, but it's less important for
this bike network tool. The limiting factor to expanding quickly really is time
and managing communications with all of the people who will initially be
interested -- it's important to balance this with time spent actually working on
the software.</p>
<h3 id="next-steps"><a class="header" href="#next-steps">Next steps</a></h3>
<p>The immediate priorities are to polish the tool and finish things that didn't
make the deadline:</p>
<ul>
<li>draw routes more clearly when unzoomed on large maps</li>
<li><a href="https://github.com/a-b-street/abstreet/issues/746">get the entire Seattle region to easily load on the web</a></li>
<li>map out the official Seattle bike master plan as a second example</li>
<li>add functionality to compare different proposals against each other and the
current conditions</li>
<li>implement the
<a href="https://github.com/a-b-street/abstreet/issues/448">decay curves for mode shift</a>
to get predictions better calibrated by research</li>
<li>consolidate the user flow into just 3 stages: explore, your trips, and
proposals</li>
</ul>
<p>To support rolling out to more cities:</p>
<ul>
<li>improve elevation data (switch from SRTM to
<a href="https://earthdata.nasa.gov/esds/competitive-programs/measures/nasadem">NASADEM</a>)</li>
<li>snapping separate cycleways to the main road</li>
</ul>
<p>There are also more features we could add:</p>
<ul>
<li>hover on commercial buildings to summarize what's inside</li>
<li>showing historic collision data to emphasize the dangers of high-stress roads</li>
<li>animating cyclists following sample routes before and after, using A/B
Street's traffic simulator</li>
<li>simulating other vehicles nearby to enhance the visualization</li>
<li>improve routing by allowing bikes to enter/exit buildings from either side of
the road</li>
</ul>
<p><img src="software/ungap_the_map/../../project/history/retrospective/traffic_sim.gif" alt="" /></p>
<h3 id="future-directions"><a class="header" href="#future-directions">Future directions</a></h3>
<p>The longer-term vision for A/B Street in general extends beyond just improving
the bike network tool and rolling out to more cities.</p>
<ul>
<li>low-traffic neighborhood planning
<ul>
<li>As mentioned <a href="software/ungap_the_map/plan.html#uk">above</a>, we have a promising collaboration to expand an
initial prototype to help design LTNs, which are a very active topic across
the entire UK. This is probably the highest immediate priority.</li>
</ul>
</li>
<li>public transit
<ul>
<li>A/B Street has <a href="https://github.com/a-b-street/abstreet/issues/372">plans</a> to
simulate buses and light rail, but there's lots of work to build it out.
We'd love to partner with <a href="https://www.seattlesubway.org">Seattle Subway</a>
and inspire the public to vote for
<a href="https://actionnetwork.org/letters/approve-funding-for-st4-in-seattle">ST4</a></li>
</ul>
</li>
<li>a website for organizing proposals
<ul>
<li>Although it's now possible to share individual A/B Street proposals by URL,
there's no way to browse, upvote, or give feedback on ideas</li>
</ul>
</li>
<li>story-mapping
<ul>
<li>Today we present A/B Street ideas like
<a href="software/ungap_the_map/../../proposals/seattle_bikes/index.html">the Seattle bike vision</a> in two
formats -- a blog post with pictures, and the software itself.
<a href="https://storymaps.arcgis.com/">Story maps</a> could be a format to combine
these.</li>
</ul>
</li>
<li>more detailed street and intersection design
<ul>
<li>A/B Street doesn't let you visualize or edit details like pocket parking,
parklets, curb bulbs, or barriers in intersections. This is maybe something
we should leave to experts with CAD software, but it could be worth modeling
this level of detail too.</li>
<li>Incorporating a satellite view layer would also be useful to understand
changes in context</li>
</ul>
</li>
<li>more detailed pedestrian simulation
<ul>
<li>Telling an effective story about what a new cafe street or public square
requires showing people using the space to meet friends, share meals, relax,
and play. A/B Street today just simulates people making trips. We'd like to
explore crowd simulation and visualization.</li>
</ul>
</li>
<li>Incorporating census and demographic information
<ul>
<li>City planners prioritize changes based on nearby residents' income, age,
employment, and other demographic factors. A/B Street could use public data
to further measure the impact of changes.</li>
</ul>
</li>
<li>Modifying land use policies
<ul>
<li>Many cities outlaw medium- and high-density housing in most of the city, and
force residential and commercial sectors to remain physically distinct. This
leads to longer trips, which most likely use cars. We've
<a href="software/ungap_the_map/../fifteen_min.html">started</a> exploring this relationship, but there's no way
yet to modify the zoning policy for some land parcels and explore possible
effects.</li>
</ul>
</li>
<li>3D visualization
<ul>
<li>Another way to visually communicate changes is with 3D renderings. We could
partner with <a href="https://www.3d.st">3D Street</a> and export A/B Street designs to
engage the public even better.</li>
</ul>
</li>
</ul>
<p>In other words, we envision A/B Street growing into a general digital twin
platform for exploring different aspects of urban design. We will continue our
key differentiators from other projects of remaining open source and geared
towards the general public's use.</p>
<h2 id="resources-needed"><a class="header" href="#resources-needed">Resources needed</a></h2>
<p>In short:</p>
<ul>
<li>connections to government or industry stakeholders who could sponsor the
project, provide use cases, etc</li>
<li>staff</li>
<li>funding (as a way to hire people)</li>
</ul>
<h3 id="staffing"><a class="header" href="#staffing">Staffing</a></h3>
<p>A/B Street has just one full-time software developer, who also plays the role of
project manager, marketer, and writer. There are a handful of volunteer UX
designers and programmers who sometimes have time to help. To really deliver on
the project's ambition, we need more full-time help:</p>
<ul>
<li>a visual designer, with particular cartography expertise
<ul>
<li>A/B Street's zoomed-in view presents an unprecedented level of detail about
each lane on a road. We also simulate individual vehicles and people moving
around. Color and design choices are difficult. There's lots of information
to display.</li>
<li>This is vital, because A/B Street's job is to tell stories and sell a vision
to people. This is best done visually, not by just presenting data!</li>
</ul>
</li>
<li>UX designer
<ul>
<li>Yuwen served as the project's UX lead for ~1 year and totally transformed
the project. We need full-time help here again.</li>
</ul>
</li>
<li>product manager
<ul>
<li>Urban planning is a broad space, and figuring out the most important area to
focus on is hard. Requires networking with advocacy groups, city planners,
etc across the world and figuring out their problems and ways to help.</li>
</ul>
</li>
<li>marketing expert
<ul>
<li>First use is just helping convince different stakeholders to use and invest
in A/B Street</li>
<li>But perhaps more importantly, somebody who understands how the general
public perceives transportation and city changes, and can figure out how to
educate and convince people it's beneficial long-term</li>
</ul>
</li>
<li>software engineers
<ul>
<li>A/B Street is both very broadly-scoped (and so just needs lots of help
implementing) and tackles some very difficult problems requiring deep focus</li>
<li>Because of this and the use of Rust, a programming language that has an
initial learning curve, it's a difficult project for beginners to contribute
to.</li>
</ul>
</li>
</ul>
<p>A single person may be able to serve multiple roles -- for instance, visual
designer, product management, and UX. Or a UX designer who can help with
programming.</p>
<h3 id="budget"><a class="header" href="#budget">Budget</a></h3>
<p>Say we want to hire one Rust software engineer and one UX designer (who would
also help with the cartography and product management roles) for a year.
Depending where the employees live, median salaries differ significantly.
Glassdoor estimates
<a href="https://www.glassdoor.com/Salaries/london-programmer-salary-SRCH_IL.0,6_IM1035_KO7,17.htm">42K</a>
for a general programmer in London, or
<a href="https://www.glassdoor.com/Salaries/seattle-programmer-salary-SRCH_IL.0,7_IC1150505_KO8,18.htm">$85k</a>
for Seattle. Neither the engineer nor designer could be entry-level for a
project this complicated.</p>
<h3 id="funding-sources"><a class="header" href="#funding-sources">Funding sources</a></h3>
<p>Becoming a traditional business goes directly against A/B Street's core
philosophy. Cities belong to everybody who lives in them, so the planning
processes around them should be transparent, accessible to everyone, and any
research studies should be reproducible. Open-source software and public data
are vital to this. A business exists to generate profit, even if those profits
are modest and just meant to sustain the business. The ultimate metric that
matters for this project is impact on the real world -- making transportation
more environmentally friendly. Therefore, a
<a href="https://en.wikipedia.org/wiki/B_Corporation_(certification)">B-corp</a> or
<a href="https://en.wikipedia.org/wiki/Benefit_corporation">benefit corp</a> might be more
appropriate.</p>
<p>One possible direction is consulting. Cities contract the A/B Street team to
specialize the software for their immediate needs. All of the work is open
source. So effectively they would just define priorities for the project.
<a href="http://docs.opentripplanner.org/en/latest/">OpenTripPlanner</a> is an example of
open source transportation software funded by different groups as a public good.</p>
<p>Other options are crowd-funding (like Github sponsors) and applying for grants
like the <a href="https://www.rjrf.uk/">Rees Jeffreys road fund</a>.</p>
<h3 id="schedule"><a class="header" href="#schedule">Schedule</a></h3>
<p>My time commitment is unknown starting November, so I'm only describing the next
few weeks.</p>
<ul>
<li>October 11-15
<ul>
<li>most of the <a href="software/ungap_the_map/plan.html#next-steps">next steps</a> items: unzoomed drawing, large maps on
the web, comparing proposals</li>
<li>gradually launch Ungap the Map to a Seattle audience</li>
</ul>
</li>
<li>October 18-22
<ul>
<li>mode shift decay curves, NASADEM elevation to support San Francisco and NYC
rollout</li>
<li>continue rapid prototyping of the new low-traffic neighborhood tool</li>
</ul>
</li>
<li>October 25-29
<ul>
<li>simulate nearby vehicles (also needed for the LTN tool)</li>
<li>respond to feedback from whichever stakeholders respond</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="technical-details"><a class="header" href="#technical-details">Technical details</a></h1>
<p>This document summarizes how the Ungap the Map tool works. The tool is just one
piece of the A/B Street platform, which has <a href="software/ungap_the_map/../../tech/index.html">much more</a>
technical documentation.</p>
<h2 id="system-overview"><a class="header" href="#system-overview">System overview</a></h2>
<!-- refactor/lift this -->
<p>A/B Street is generally organized into 3 layers. The lowest is the map model,
which represents the transportation network of some portion of a city. This
model combines the geometry of roads and intersections, routing for different
vehicle types, and semantics like turn restrictions, parking, traffic signal
timing, and land use patterns. In some regions, there's also a travel demand
model describing the trips that people regularly make. Lane configuration,
intersection control policy, and access restrictions can all be changed in
real-time (usually sub-second). You can think of the map model along with the
travel demand as a digital twin of the city, at least from a transportation
perspective.</p>
<p>A map and travel demand scenario are just files covering some manually-drawn
boundary. The map has &quot;borders&quot; along the boundary, and the travel demand model
can describe trips beginning or ending off-map somewhere. There's a complex
process to generate a map, pulling in and heavily processing data from
OpenStreetMap, different travel demand sources, city-specific datasets about
parking, and elevation. All of the datasets are public. This process works for
any city with sufficient OpenStreetMap coverage, but it still takes lots of work
to improve the imported map. Many cities have already been imported and stored
in Amazon S3; most users will never need to perform this process themselves.</p>
<p>The next layer is a 2D rendering and user interface library, written from
scratch on top of OpenGL. These libraries have common code for interacting with
the map in many ways, and managing things like downloading files for new cities.
There's also a traffic simulation in this layer, although the bike network tool
doesn't use it. Everything in A/B Street is written in
<a href="https://www.rust-lang.org">Rust</a>. One advantage of this is that everything can
run either natively on Mac, Windows, or Linux, or be compiled to WebAssembly and
run in web browsers without any installation.</p>
<p>Finally, the third layer consists of user-facing apps that make use of
everything. The bike network tool lives here, alongside tools that're focused on
related topics like 15-minute neighborhoods and low-traffic neighborhoods.</p>
<h2 id="sharing-proposals"><a class="header" href="#sharing-proposals">Sharing proposals</a></h2>
<p>When the user adds bike lanes to some roads, all of the changes are saved
locally as a JSON file. Since the tool's goal is for people to communicate about
their ideas and spread the word, there has to be some way for them to share
these files. This could be done manually by email or something else, but that
would be really painful. So the software can upload the files to a central
server, and people can just share a URL to download the file later.</p>
<p>Ideally, this feature would include a proper user account system, where people
can sign up, modify their proposals, and maybe even share comments or feedback
about other proposals. There are many technical and design challenges with this
-- for example, how to prevent abusive users from posting rude comments? In the
long-term, this is worth tackling, with careful design to facilitate useful
interactions.</p>
<p>But to get something working in the meantime, the JSON proposals can just be
shared anonymously. They're uploaded to a central server, which returns a URL to
share. Somebody else can load the proposal with that URL. Everybody remains
anonymous; it's impossible to prove who uploaded a proposal, or to edit or
delete it. The <a href="https://github.com/a-b-street/yimbyhoodlum">central server</a> is a
simple Go API hosted in Google App Engine, storing files in Google Cloud
Storage, and using MD5 checksums to identify and de-duplicate proposals.</p>
<h2 id="routing"><a class="header" href="#routing">Routing</a></h2>
<p>Unsurprisingly, A/B Street uses
<a href="https://en.wikipedia.org/wiki/Dijkstra%27s_algorithm">Dijkstra's algorithm</a> to
find paths. The interesting details are how the graph's edge weights are set for
bicycles. The weights are expressed in units of time, guessing how long it'll
take the typical cyclist to cross a road or turn through an intersection. This
is usually just <code>distance / speed</code>. The speed accounts for elevation, and
<a href="https://github.com/a-b-street/abstreet/blob/5f75656cc3760436659eb731106f9f886a6339e2/map_model/src/traversable.rs#L258">the calculation</a>
is adapted from the Valhalla routing engine. See the
<a href="https://github.com/a-b-street/abstreet/blob/master/map_model/src/pathfind/vehicles.rs">vehicle_cost method</a>
for specifics.</p>
<p>Additionally, the user can specify preferences to avoid steep hills or stressful
roads. Steep hills are defined as having over 8% incline, and when one is
encountered, the cost to cross it is multiplied by 2. Note this multiplication
happens <em>after</em> adjusting the typical biking speed to account for the incline.
Stressful roads are similar -- if a road is classified as an arterial or highway
and lacks bike lanes, the edge weight is multiplied by 2. There are many
possible ways to tune these parameters; the current implementation is simple,
but produces results that match personal experience around Seattle.</p>
<p>Note the mode shift calculation instead uses
<a href="https://en.wikipedia.org/wiki/Contraction_hierarchies">contraction hierarchies</a>,
which require an expensive one-time preparation step, but answer queries
<strong>much</strong> faster than Dijkstra's. On most of the Seattle maps, the travel demand
models require at least 100,000 paths!</p>
<h2 id="adding-bike-lanes"><a class="header" href="#adding-bike-lanes">Adding bike lanes</a></h2>
<p>The user can edit an individual road segment in detail, configuring individual
lane widths. But of course this is really tedious, so most people will probably
use this tool to automatically add lanes to an entire path at once. This tool
shouldn't require the road to be physically widened -- this is incredibly
expensive, and often there's no room to expand in the middle of a city. So
instead, the heuristics try to replace existing street parking or extraneous
driving lanes. In reality, OpenStreetMap data isn't high-fidelity enough to
capture the real width of a road. Often a driving lane might be 15 feet wide,
and there's plenty of room on the shoulder to at least paint a lane. See the
<a href="https://github.com/a-b-street/abstreet/blob/5f75656cc3760436659eb731106f9f886a6339e2/game/src/ungap/quick_sketch.rs#L163">heuristics and unit tests</a>
for details.</p>
<h2 id="predict-impact-1"><a class="header" href="#predict-impact-1">Predict impact</a></h2>
<p>This is the most complex piece, due to the number of assumptions made.
Particular thanks to <a href="https://www.robinlovelace.net">Robin Lovelace</a> for
<a href="https://github.com/a-b-street/abstreet/issues/448">lots of advice</a> here.</p>
<p>For a planner to evaluate building out a proposed bike network, the key question
is: how many people will use it? This is an incredibly open-ended research
question. For example, there might be some people today who live in an area
where driving is the only reasonable mode of transport, but they don't have
access to a vehicle or have an impairment preventing them from driving. They
might choose (or be forced to) work remotely in this situation, and wait to
car-pool for groceries. If cycling became a cheap and safe possibility, they
might start taking entirely new trips -- this would be a positive instance of
<a href="https://en.wikipedia.org/wiki/Induced_demand">induced demand</a>. Over time, if a
city becomes friendlier to walking and biking and builds more affordable
housing, travel patterns may change dramatically as people decide to live and
work in the city, instead of commuting from the suburbs. This long-term,
region-scale forecasting is the domain of groups like the
<a href="https://www.psrc.org/activity-based-travel-model-soundcast">Puget Sound Regional Council</a>.</p>
<h3 id="mode-shift-part-1"><a class="header" href="#mode-shift-part-1">Mode shift: part 1</a></h3>
<p>So let's narrow our focus and just consider &quot;mode shifting&quot; existing trips that
people currently perform by driving. We start with a
<a href="software/ungap_the_map/../../tech/trafficsim/travel_demand.html">travel demand model</a> describing
individual people's typical weekday schedule. The schedule defines a sequence of
trips, with specific locations, departure time, and mode of transport. The tool
first filters these trips to find all driving trips happening entirely within
the map boundary. (If a trip begins or ends somewhere off-map, we don't really
know its full distance and can't evaluate relevant factors along the whole
journey.)</p>
<h3 id="mode-shift-part-2"><a class="header" href="#mode-shift-part-2">Mode shift: part 2</a></h3>
<p>Once we've found the initial set of driving trips, we have to figure out which
ones would even consider switching to biking. If somebody drives somewhere in 10
minutes now, it's unlikely they'll be willing to bike for an hour, especially if
they have to climb steep hills. That's the intuition behind the
<a href="https://www.jtlu.org/index.php/jtlu/article/view/862">Propensity to Cycle tool</a>,
which calculates a distance and hilliness decay model to predict the percentage
of trips that would consider biking. Currently the software defines a hard
threshold for these two parameters -- the user can specify the maximum time
someone is willing to bike, and the max elevation gain they'll endure. In the
future, we can change this to use the decay functions from that prior research,
and use data particular to different regions to make this more evidence-based.
For instance, as e-bikes become more popular, hilliness becomes a less important
factor.</p>
<h3 id="mode-shift-part-3"><a class="header" href="#mode-shift-part-3">Mode shift: part 3</a></h3>
<p>Based on those settings, the software will calculate all of the biking routes
that the filtered trips would take. The question then becomes, why don't those
people choose to bike today? The barrier this project focuses on is safety --
even if the most direct cycling route isn't long or hilly, many people aren't
willing to risk riding alongside heavy traffic when the street isn't designed
for that.</p>
<p>So the tool first displays a red heatmap showing a count of all of the roads
where trips <strong>would</strong> switch, if it was safer. This guides the user to consider
adding lanes there.</p>
<p>Then the tool calculates if the proposal makes each trip safe enough. Currently
this just sees if even one road segment of the trip now has infrastructure, but
this will be made configurable soon!</p>
<h3 id="carbon-score"><a class="header" href="#carbon-score">Carbon score</a></h3>
<p>Finally we have an estimate of which trips might switch from driving to biking!
So we can sum up the total mileage of the driving route, multiply by 5 days a
week, and 52 weeks a year. This gives us the annual vehicle miles travelled that
a proposal will remove. Assuming
<a href="https://www.epa.gov/greenvehicles/greenhouse-gas-emissions-typical-passenger-vehicle#driving">404 grams of CO2 per mile</a>
-- since we don't have more details about the distribution of vehicle types
available -- we can estimate the annual CO2 savings.</p>
<h2 id="caveats-and-assumptions"><a class="header" href="#caveats-and-assumptions">Caveats and assumptions</a></h2>
<p>This software aims to do something pretty complicated, based on imperfect public
data, and was built by a tiny team. So naturally it has many problems, but
hopefully the goal is still achieved. Regardless, let's be clear about some
limitations.</p>
<h3 id="map-data"><a class="header" href="#map-data">Map data</a></h3>
<p>First, OpenStreetMap is produced by volunteers. The tagging schemas can be quite
complicated, and detailed lane data is often missing or wrong. Road width is
almost never mapped directly. A/B Street tries to workaround these issues with
aggressive heuristics.</p>
<p>You'll notice many parts of the map look visually broken, especially near major
junctions. That's because
<a href="software/ungap_the_map/../../tech/map/geometry/index.html">generating intersection geometry</a> is
incredibly hard.</p>
<p>One particular problem is how protected bike lanes are mapped. In OpenStreetMap,
these are represented as separate, but parallel, objects from the main street.
This usually appears in A/B Street as the cyclepath just overlapping the road in
a completely broken way. &quot;Snapping&quot; the parallel objects together and treating
as one road segment is the goal, but
<a href="https://github.com/a-b-street/abstreet/issues/330">this is very hard</a> and
ongoing work. The routing <strong>should</strong> still be able to use the separate
cyclepaths, and so things like mode shift calculations should still be fine.</p>
<h3 id="travel-demand-data"><a class="header" href="#travel-demand-data">Travel demand data</a></h3>
<p>The impact prediction needs to know trips people take in order to guess which of
those trips might mode shift from driving to biking. For Seattle, we use
<a href="https://www.psrc.org/activity-based-travel-model-soundcast">Soundcast</a>, but
notably the model is only available for 2014, which is quite out-of-date!</p>
<h3 id="elevation-data"><a class="header" href="#elevation-data">Elevation data</a></h3>
<p>A/B Street uses
<a href="https://github.com/eldang/elevation_lookups">this Python library</a> to process
elevation data and figure out which streets are steep. Currently the results are
quite realistic in Seattle, thanks to King County LIDAR data. Everywhere else,
currently NASA's SRTM is used, and the results don't seem to be working yet.
Additionally, elevation data near bridges is usually messed up, with the bridge
suddenly having the ground or water's elevation, and we're not working around
this problem yet.</p>
<h3 id="regional-differences"><a class="header" href="#regional-differences">Regional differences</a></h3>
<p>Although A/B Street can work anywhere in the world, its model of roads and
travel behavior along them makes some assumptions more tuned to North America
and the United Kingdom. A notable example where these assumptions break down is
in Taipei. If you look at A/B Street, it seems like there's a phenomenal network
of dedicated cyclepaths along most major roads!</p>
<p><img src="software/ungap_the_map/tw_network.png" alt="" /></p>
<p>But actually, these are just the sidewalks. Cyclists and pedestrians share this
space, and may come into conflict if many people switch to cycling.</p>
<p><img src="software/ungap_the_map/tw_detail.png" alt="" /></p>
<p>Apparently there were some efforts some time ago to install dedicated bike lanes
on the roads, but not many people used them, because there's less shade from the
sun during summer. In my own research about biking in Taiwan, I didn't discover
anything like this; it took local knowledge from the hackathon organizers to
clue me in! (Later, I found a
<a href="https://www.theguardian.com/cities/2016/mar/15/bicycle-kingdom-reborn-pavement-cycling-taipei-taiwan">bit more about the history of biking in Taipei</a>.)
Barriers to cycling uptake vary across the world. Also, in Taiwan, smaller
vehicles like mopeds and bikes use
<a href="https://en.wikipedia.org/wiki/Hook_turn">hook turns</a>, which should affect
routing and simulation. But A/B Street doesn't model this yet.</p>
<h3 id="high-stress-roads"><a class="header" href="#high-stress-roads">High-stress roads</a></h3>
<p>One of the key metrics for evaluating a cycling route in the software is how
much of it crosses high-stress roads. Currently that's just defined as a &quot;major&quot;
(arterial or highway) classification without any bike lanes. There are much more
rigorous ways to define stress, such as the one by
<a href="https://bna.peopleforbikes.org/#/places/0ea909ec-0b15-4bae-b593-a40da8a72312/">People For Bikes</a>.
Quickly comparing the results from this tool and A/B Street, we mostly agree,
though.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="15-minute-neighborhood-explorer"><a class="header" href="#15-minute-neighborhood-explorer">15-minute neighborhood explorer</a></h1>
<p><img src="software/walkshed.gif" alt="walkshed" /></p>
<ul>
<li><a href="http://play.abstreet.org/0.3.20/fifteen_min.html">Web version</a></li>
<li>To run locally, get the
<a href="https://github.com/a-b-street/abstreet/releases">latest release</a> for Windows,
Mac, or Linux. After unzipping, run <code>fifteen_min.exe</code> or <code>fifteen_min</code>.</li>
<li>This page: <a href="software/15m.abstreet.org">http://15m.abstreet.org</a></li>
</ul>
<p>In a
<a href="https://crosscut.com/focus/2020/11/seattle-could-become-next-15-minute-city">15-minute city</a>,
most residents can reach a variety of stores, restaurants, parks, and jobs
within about a 15 minute walk or bike ride. Part of advocating for a
bike-friendly city is evaluating the zoning laws and understanding where people
live in relation to where they work, shop, and meet friends. This tool is a
prototype letting you see what's 15 minutes away from a starting point. You can
explore the shops and estimate how much street parking and how many people live
within a walkshed.</p>
<h2 id="feedback"><a class="header" href="#feedback">Feedback</a></h2>
<p>The tool is quite simple right now. If you have an idea how this could be used
for advocacy, please
<a href="https://github.com/a-b-street/abstreet/issues/393">get in touch</a>.</p>
<h2 id="implementation"><a class="header" href="#implementation">Implementation</a></h2>
<p>This section describes some of the technical implementation details.</p>
<h3 id="calculating-time-to-buildings"><a class="header" href="#calculating-time-to-buildings">Calculating time to buildings</a></h3>
<p>When you click on a starting building, what happens? Follow along with the code:
<a href="https://github.com/a-b-street/abstreet/blob/master/fifteen_min/src/isochrone.rs">https://github.com/a-b-street/abstreet/blob/master/fifteen_min/src/isochrone.rs</a></p>
<p>First, we calculate the time to reach all buildings on the map from the start,
based on the current options for walking or biking. For walking, this calls
<a href="https://github.com/a-b-street/abstreet/blob/master/map_model/src/connectivity/walking.rs">all_walking_costs_from</a>.
This method simply performs
<a href="https://en.wikipedia.org/wiki/Dijkstra%27s_algorithm">Dijkstra's maneuever</a>,
floodfilling a graph from the start node and tracking the cost to reach other
nodes. It terminates early when the cost exceeds 15 minutes.</p>
<p>One relevant detail is that the graph is based off of <code>WalkingNodes</code>, which
represent both endpoints of a sidewalk. A building exists some distance along a
sidewalk. To calculate the final cost to a building, we also add up the cost
between the nearest end of the sidewalk and the building's exact position along
the sidewalk. This calculation doesn't use the length of the building's
driveway/front path, but it could.</p>
<p>The other question is how we calculate the cost to cross a sidewalk. The units
are durations, and most of the time, we simply calculate <code>distance / speed</code>. The
base speed for walking can be configured in the 15m tool UI, with a few pre-set
values for jogging, using a wheelchair, or a general average for adults. We also
<a href="https://github.com/a-b-street/abstreet/blob/8826af31cba342662694014e549322a727605339/map_model/src/traversable.rs#L315">adjust speed based on the road's incline</a>,
using a variation of
<a href="https://en.wikipedia.org/wiki/Tobler%27s_hiking_function">Tobler's hiking function</a>.
The elevation data baked into the map model likely has bugs, which then affect
walking speed.</p>
<p>In the future, we'll keep expanding this definition of &quot;cost&quot; to capture other
factors that make it safe and pleasant to walk, so that the 15m tool ultimately
reflects how awful it'd be to access essential services by walking along a busy
arterial road.</p>
<h3 id="drawing-the-isochrone"><a class="header" href="#drawing-the-isochrone">Drawing the isochrone</a></h3>
<p>Now that we have the cost to reach a bunch of buildings, we want to draw the
three-colored isochrone, showing the area reachable within 5, 10, and 15
minutes. We use the <a href="https://crates.io/crates/contour">contour</a> crate to do
this, which uses the
<a href="https://en.wikipedia.org/wiki/Marching_squares">marching squares algorithm</a> to
find the &quot;contour&quot; where the cost changes from less than 5 to over 5 minutes.</p>
<p>In my mind, an isochrone contour algorithm could just take the list of (point,
cost) pairs as input, but marching squares requires a grid, so
<a href="https://github.com/a-b-street/abstreet/blob/8826af31cba342662694014e549322a727605339/fifteen_min/src/isochrone.rs#L126">the code</a>
first creates that grid, using a fixed 100 meter cell size. If two buildings
happen to map to the same square, the cost of one of them is used arbitrarily.
It shouldn't matter much; it takes around 30 seconds to walk 100 meters, so the
contour might be a little off by about that much.</p>
<p><img src="software/gaps.png" alt="gaps" /></p>
<p>You can see some gaps in the middle of the park. Because there are no buildings
in the middle, the grid cell has 0 cost in there. There's probably some
<a href="https://github.com/a-b-street/abstreet/issues/669">better approaches</a> to
calculating isochrones.</p>
<h3 id="finding-the-perfect-home"><a class="header" href="#finding-the-perfect-home">Finding the perfect home</a></h3>
<p>The tool also has a feature that lets you mark what categories of amenities you
care about, then it finds houses within a 15 min walk of all of those. Its
implementation is
<a href="https://github.com/a-b-street/abstreet/blob/8826af31cba342662694014e549322a727605339/fifteen_min/src/find_home.rs#L84">laughably brute-force</a>.
For each of the categories, it finds all stores matching that category, then
does the Dijkstra's floodfill from each of those buildings. An obvious speedup
here would be to perform Dijkstra's just once for each category and insert all
of the stores into the priority queue as starting nodes.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="15-minute-santa"><a class="header" href="#15-minute-santa">15-minute Santa</a></h1>
<p>Created by <a href="https://abstreet.org">Dustin Carlino</a>,
<a href="https://www.yuwen-li.com/">Yuwen Li</a>, &amp;
<a href="https://michaelkirk.github.io/">Michael Kirk</a></p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/mrIsVMLZ_yc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
<p>15-minute Santa is a game where you deliver presents across Seattle. You earn
more points delivering to high-density housing, and you need to refuel from
shops, so you'll have to understand where people live in relation to where they
work and shop.</p>
<p>Contact <a href="mailto:software/dabreegster@gmail.com">dabreegster@gmail.com</a> with any feedback or
<a href="https://github.com/a-b-street/abstreet/issues/new">file an issue on Github</a>.</p>
<h2 id="play-it"><a class="header" href="#play-it">Play it</a></h2>
<ul>
<li><a href="http://play.abstreet.org/0.3.20/santa.html">Play online</a> (slower and no music
-- download below if possible)</li>
<li><a href="https://github.com/a-b-street/abstreet/releases/download/v0.3.20/abstreet_windows_v0_3_20.zip">Windows</a></li>
<li><a href="https://github.com/a-b-street/abstreet/releases/download/v0.3.20/abstreet_mac_v0_3_20.zip">Mac</a></li>
<li><a href="https://github.com/a-b-street/abstreet/releases/download/v0.3.20/abstreet_linux_v0_3_20.zip">Linux</a></li>
</ul>
<p>Unzip, then run <code>santa.exe</code> or <code>santa</code>. No mobile/tablet support, sorry -- you
need a keyboard.</p>
<h2 id="faq"><a class="header" href="#faq">FAQ</a></h2>
<h3 id="why-did-yall-make-this"><a class="header" href="#why-did-yall-make-this">Why did y'all make this?</a></h3>
<p>We normally work on <a href="https://abstreet.org">A/B Street</a>, a traffic simulation
that lets the general public explore a future prioritizing more sustainable
modes of transportation. All of the recent
<a href="https://crosscut.com/focus/2020/11/seattle-could-become-next-15-minute-city">talk</a>
about 15-minute cities prompted us to explore how Seattle's zoning causes many
people to live far from where they get groceries. After experimenting with a
<a href="software/fifteen_min.html">more serious</a> tool to understand walk-sheds, we decided to
spend a few weeks on something a bit more light-hearted.</p>
<h3 id="realism"><a class="header" href="#realism">Realism</a></h3>
<p>The map of Seattle and location of shops comes from
<a href="https://www.openstreetmap.org/about">OpenStreetMap</a>. We only consider shops if
they sell food or drinks -- let us know if the map seems to be missing your
favorite restaurant. The number of housing units is based on
<a href="https://data-seattlecitygis.opendata.arcgis.com/datasets/current-land-use-zoning-detail">Seattle GIS data</a>.
Mixed-use buildings with both commercial and residential units aren't
represented. The game lets you upzone any house to place a new store; obviously
this is a vast simplification of how complex a real conversation about changing
zoning codes should be.</p>
<p>We rigorously evaluated the speed and carrying capacity of different cargo bikes
and sleighs on the market to tune the vehicles in the game.</p>
<h3 id="modding-the-game"><a class="header" href="#modding-the-game">Modding the game</a></h3>
<p>Native versions only -- sorry, not easy to do on the web.</p>
<p>You can adjust the difficulty of the levels or give yourself all the upzoning
power you want by editing <code>data/player/santa.json</code>. You first have to set
<code>&quot;enable_modding&quot;: true</code>. The format should mostly be self-explanatory; also see
<a href="https://github.com/a-b-street/abstreet/blob/be589f7ef4f649bb5a35bfe8de0bc81a9deeb029/santa/src/session.rs#L13">here</a>
as a reference. If you break something, just delete the file to start over. If
you come up with a better gameplay progression, please share -- tuning a game is
hard!</p>
<h3 id="adding-new-maps"><a class="header" href="#adding-new-maps">Adding new maps</a></h3>
<p>Missing your slice of Seattle, or want to run somewhere else? If you have a bit
of technical experience, <a href="software/../user/new_city.html">follow this guide</a> and then the
above instructions for modding the game. Otherwise, draw the map boundaries in
<a href="http://geojson.io">http://geojson.io</a> and
<a href="https://github.com/a-b-street/abstreet/issues/new">send it to us</a> along with a
time limit, goal, and starting point on the map. If you have a public data
source for the number of housing units per building, please include it!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="low-traffic-neighborhoods"><a class="header" href="#low-traffic-neighborhoods">Low-traffic neighborhoods</a></h1>
<p>This tool lets anybody study existing and proposed low-traffic neighborhoods
(LTNs). Experiment with modal filter placement, and examine the impacts on
drivers trying to cut through residential areas.</p>
<p><strong>NOTE</strong>: A user guide and video tutorials will be available by end of March.
This software is updated every Sunday; see
<a href="https://github.com/dabreegster/abstreet/releases">release notes</a>.</p>
<p><img src="software/ltn/ltn.gif" alt="" /></p>
<ul>
<li>Try without installing:
<a href="http://play.abstreet.org/0.3.20/ltn.html?system/gb/bristol/maps/east.bin">web version</a></li>
</ul>
<p>The software runs faster if you install it. No mobile/tablet support. Unzip,
then run <code>ltn.exe</code> or <code>ltn</code>.</p>
<ul>
<li><a href="https://github.com/a-b-street/abstreet/releases/download/v0.3.20/abstreet_windows_v0_3_20.zip">Windows</a></li>
<li><a href="https://github.com/a-b-street/abstreet/releases/download/v0.3.20/abstreet_mac_v0_3_20.zip">Mac</a></li>
<li><a href="https://github.com/a-b-street/abstreet/releases/download/v0.3.20/abstreet_linux_v0_3_20.zip">Linux</a></li>
</ul>
<p>Contact <a href="mailto:software/ltn/dabreegster@gmail.com">dabreegster@gmail.com</a> with any feedback or
<a href="https://github.com/a-b-street/abstreet/issues/new">file an issue on Github</a>.</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<h3 id="modal-filters"><a class="header" href="#modal-filters">Modal filters</a></h3>
<p>You can place new modal filters (planters or bollards) along streets or
diagonally in intersections. Filters will calm traffic along that one street,
but may just find detour around it. Only when you split the neighborhood into
smaller &quot;cells&quot; does the amount of through-traffic in the area get reduced.</p>
<video controls>
  <source src="filters.mp4" type="video/mp4">
</video>
<p>The tool also detects existing modal filters today, based on on OpenStreetMap
data.</p>
<h3 id="rat-runs"><a class="header" href="#rat-runs">Rat-runs</a></h3>
<p>You can explore individual paths through a neighborhood that drivers may take,
and a heatmap predicting which streets are likely to experience more or less
traffic.</p>
<video controls>
  <source src="rat_runs.mp4" type="video/mp4">
</video>
<h3 id="plan-a-route"><a class="header" href="#plan-a-route">Plan a route</a></h3>
<p>If you want to understand how filters will affect your driving commute, you can
explore a route before and after a proposal. Main roads are often the fastest
route anyway, but you can adjust the level of traffic jams to see when it may be
advantageous to take a shortcut through a neighborhood.</p>
<p><img src="software/ltn/plan_route.gif" alt="" /></p>
<h3 id="neighborhood-boundaries"><a class="header" href="#neighborhood-boundaries">Neighborhood boundaries</a></h3>
<p>The tool starts by classifying everything inside &quot;major roads&quot; as a
neighborhood, where ideally there shouldn't be much through-traffic. But you can
adjust these boundaries however you like, merging two neighborhoods or placing a
local high street in the &quot;interior&quot; of your LTN, even if it serves lots of
traffic today.</p>
<video controls>
  <source src="adjust_boundaries.mp4" type="video/mp4">
</video>
<h3 id="proposals-1"><a class="header" href="#proposals-1">Proposals</a></h3>
<p>Once you create some filters or adjust neighborhood boundaries, you can save
your proposed changes. You can open and then compare multiple proposals. You may
also export all neighborhood boundaries and filters to the GeoJSON format, and
then work further in QGIS or your favorite tool.</p>
<p><strong>NOTE</strong>: Proposals are only saved on your computer (in the <code>data/player</code> folder
for the downloaded version, or in your browser's local storage). There's no
support yet for sharing proposals online.</p>
<p><strong>NOTE</strong>: Proposals saved with one version of the software might not work in
future versions. I'll aim to guarantee backwards compatibility by mid-March. In
the meantime, if you ever have trouble loading your previously saved work,
please contact me and I'll help.</p>
<h3 id="limitations"><a class="header" href="#limitations">Limitations</a></h3>
<p>The tool traces around areas surrounded by major roads, using this to determine
interior roads that should have minimal through-traffic. You can adjust the
default boundaries. Unfortunately, this feature is broken in some cities,
particularly where bridges and tunnels overlap other roads.
<a href="https://github.com/a-b-street/abstreet/issues/857">Track this issue</a> for
updates on progress.</p>
<p>There are some advanced / experimental features that don't work yet:</p>
<ul>
<li>Automatically placing filters to optimize some definition of a &quot;good&quot;
neighborhood</li>
<li>Predicting the overall impact of a proposal on vehicle traffic in the area.
This requires a high-quality travel demand model to know where people
currently try to drive, and coming by these isn't easy.</li>
</ul>
<h3 id="other-planned-features"><a class="header" href="#other-planned-features">Other planned features</a></h3>
<ul>
<li>Change between one-way and two-ways streets, which is a less common way to
effectively introduce filters</li>
<li>Overlay bus routes, and introduce bus gates (filters that buses can pass
through)</li>
<li>Visualizing and editing other traffic calming (speed humps, chicanes, curb
extensions)</li>
<li>Predict how much traffic will &quot;dissipate&quot; in response to LTNs, as people
switch their travel behavior long-term.</li>
</ul>
<h2 id="credits-1"><a class="header" href="#credits-1">Credits</a></h2>
<p>Main team:</p>
<ul>
<li><a href="http://dcarlino.org">Dustin Carlino</a>: project lead</li>
<li><a href="https://www.cindykhuang.me">Cindy Huang</a>: UX design</li>
<li><a href="https://jending.com">Jennifer Ding</a>: training material and outreach</li>
</ul>
<p>Alumni from A/B Street (the LTN tool is built upon past work):</p>
<ul>
<li>Michael Kirk</li>
<li>Yuwen Li</li>
</ul>
<p>None of this work would be possible without
<a href="http://openstreetmap.org/about">OpenStreetMap contributors</a>.</p>
<p>Inspiration / early testers giving great feedback:</p>
<ul>
<li>This tool was initially inspired by Brian Deegan's
<a href="https://www.youtube.com/watch?v=pHucS2F33W8&amp;t=1052s">workshop</a> on LTN
planning. We want to involve communities in planning local schemes, and get
everybody collaborating to solve the same problems.</li>
<li><a href="https://www.cyclestreets.org/news/2021/07/25/mapping-ltns/">Cyclestreets LTN map using OpenStreetMap</a></li>
<li><a href="https://twitter.com/Microlambert/status/1454017200004739073">Will Petty's QGIS tool</a></li>
<li><a href="https://www.sustrans.org.uk/for-professionals/infrastructure/an-introductory-guide-to-low-traffic-neighbourhood-design">Sustrans LTN guide</a></li>
<li>Robin Lovelace</li>
<li>Many others...</li>
</ul>
<p>This work was expanded from an initial prototype while Dustin worked at the Alan
Turing Institute, where he's funded by the UKRI grant for the ASG program.</p>
<h3 id="current-users"><a class="header" href="#current-users">Current users</a></h3>
<p>Planners from these cities are currently using a prototype of the software:</p>
<ul>
<li>Nottingham</li>
<li>Lyon campaigning group</li>
</ul>
<p>If you're using the tool and are willing to be listed here, please let me know,
so I can make the case for funding further development.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ltn-technical-details"><a class="header" href="#ltn-technical-details">LTN technical details</a></h1>
<p>Since the tool is in such an early stage of development, this is a mix of &quot;how
things work currently&quot; and ideas for moving forwards.</p>
<h2 id="neighborhood-selection"><a class="header" href="#neighborhood-selection">Neighborhood selection</a></h2>
<p>The software operates on a single &quot;neighborhood&quot; at a time. This is defined by a
perimeter, which is a contiguous sequence of roads that form a loop, without any
gaps in the middle. This separates the map into an &quot;interior&quot; and &quot;exterior,&quot;
with border intersections connecting the two.</p>
<p><img src="software/ltn/perimeter_ordering.png" alt="" /></p>
<p>Internally, this is built up from individual &quot;city blocks,&quot; that trace around an
area without ever crossing the street.</p>
<p><img src="software/ltn/blocks.png" alt="" /></p>
<h3 id="bugs"><a class="header" href="#bugs">Bugs</a></h3>
<p>These underlying blocks have three major bugs currently. Some blocks are missing
entirely, because of internal geometry problems trying to trace:</p>
<p><img src="software/ltn/geom_bug.png" alt="" /></p>
<p>Bridges, tunnels, and train tracks can produce blocks that appear to overlap in
2D space:</p>
<p><img src="software/ltn/overlap.png" alt="" /></p>
<p>And we don't attempt to build blocks near the boundary of the map. If somebody
wants to study that area, they should import a new map covering more of the
area. We don't know what roads exist just outside the map, so it's not useful to
do any analysis.</p>
<p><img src="software/ltn/map_boundary.png" alt="" /></p>
<h3 id="next-steps-1"><a class="header" href="#next-steps-1">Next steps</a></h3>
<p>We've heard overwhelming feedback that choosing the boundary of an LTN needs to
be much more flexible. Sometimes the software's guesses are flat-out wrong, due
to bugs, or improperly including large parks or lakes. Sometimes the major road
classifications in OpenStreetMap are inappropriate. And often, there are parties
interested in more ambitious schemes to &quot;merge&quot; two LTNs or create large ones.
We don't want the software to be prescriptive at all in this selection of
boundary road; people know best. So the plan is to allow for drawing custom
boundaries. To speed things up, we can also improve the built-in heuristics for
partitioning neighborhoods and let people select which OpenStreetMap highway
types should count as a &quot;major&quot; road.</p>
<h2 id="cell-connectivity"><a class="header" href="#cell-connectivity">Cell connectivity</a></h2>
<p>After picking a neighborhood, the tool groups all of the interior streets by
connectivity for motor vehicles. Within each &quot;cell,&quot; a driver can reach all
streets without using a perimeter road. How does this work? Start from any
interior street, and &quot;flood&quot; out from that start position to find all reachable
streets. Don't search past perimeter roads. That's a cell. Repeat until all
interior streets have been visited. The reachability is based on motor vehicle
constraints, so streets classified as pedestrian- or bike-only and new modal
filters can't be crossed.</p>
<p>Initially, a neighborhood might be split into a few cells:</p>
<p><img src="software/ltn/cells_initial.png" alt="" /></p>
<p>That blue cell is quite large, so drivers may be tempted to cut through to avoid
queues along the perimeter. Let's add a filter to stop them:</p>
<p><img src="software/ltn/one_filter.png" alt="" /></p>
<p>The cells didn't change, because there's a parallel street that's still open.
Adding a filter to just one street might not work -- drivers can just detour to
the other option. Let's fix that.</p>
<p><img src="software/ltn/cells_areas.png" alt="" /></p>
<p>Now the blue cell is split into a yellow piece; the two aren't connected
anymore. The scheme is now &quot;water-tight.&quot;</p>
<p>The cells are visualized as colored areas, inspired by many example LTN diagrams
floating around. But if that's confusing, you can just color the cells by street
instead:</p>
<p><img src="software/ltn/cells_streets.png" alt="" /></p>
<p>The colors aren't meaningful; they're just meant to show different cells. There
may be cases when two adjacent cells have the same color, but they're not
connected -- that's just a bug we're working on.</p>
<h2 id="routing-1"><a class="header" href="#routing-1">Routing</a></h2>
<p>There's a pathfinding tool to see how driving routes will interact with a
neighborhood. The pathfinding itself performs a standard graph search,
respecting any turn and lane restrictions defined in OpenStreetMap. The
<a href="https://github.com/a-b-street/abstreet/blob/b45bf869b7b037fefc075d19fb9ecd3d7dcacc86/map_model/src/pathfind/vehicles.rs#L271">cost function</a>,
expressed in units of duration, is the distance divided by the speed limit. For
drivers, there's just one extra penalty that normally applies -- unprotected
right turns (in the UK) from a smaller to a larger road. This penalty is fixed
at 30 seconds currently.</p>
<p>According to this cost function, often the optimal route for a driver doesn't
even pass through a neighborhood. Major roads tend to have higher speed limits
in OpenStreetMap, so their cost is lower. This may not match reality -- during
peak hours, main roads might have long queues, and a driver armed with satnav
could try to cut through a neighborhood. So there's a toggleable slowdown factor
for main roads, which just multiplies the cost.</p>
<p>Here's an example of the results. With a slowdown factor of 1.5x, the blue route
shows that drivers might try to cut through this neighborhood. After we add some
modal filters, the blue route becomes impossible, and the driver is likely to
try the red route instead -- which actually cuts through the neighborhood on the
north end, because we haven't added filters there.</p>
<p><img src="software/ltn/detour.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="openstreetmap-viewer"><a class="header" href="#openstreetmap-viewer">OpenStreetMap viewer</a></h1>
<ul>
<li><a href="http://play.abstreet.org/0.3.20/osm_viewer.html">Web version</a></li>
<li>To run locally, get the
<a href="https://github.com/a-b-street/abstreet/releases">latest release</a> for Windows,
Mac, or Linux. After unzipping, run <code>osm_viewer.exe</code> or <code>osm_viewer</code>.</li>
</ul>
<p>A separate tool that visualizes OpenStreetMap data, with details on lanes, turn
restrictions, parking lot capacity, and road width. It's also very convenient to
explore the raw attributes on roads. The
<a href="https://www.youtube.com/watch?v=JUN5GWfb4Qo">OSM Connect 2020 talk</a> talks about
possible directions for this viewer.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mapping-on-street-parking-in-openstreetmap"><a class="header" href="#mapping-on-street-parking-in-openstreetmap">Mapping on-street parking in OpenStreetMap</a></h1>
<p><img src="software/parking_mapper.gif" alt="parking_mapper" /></p>
<p>This guide assumes you've edited OSM before. Contact <a href="mailto:software/dabreegster@gmail.com">dabreegster@gmail.com</a> if
you have any trouble. Also give me a heads up when you make some edits, so I can
regenerate the maps!</p>
<ol>
<li><a href="software/../user/index.html">Install A/B Street</a></li>
<li>Choose <strong>Contribute parking data</strong> on the main screen</li>
<li>Change the map if you'd like to focus somewhere in particular</li>
<li>Click a road with unknown parking</li>
<li>Select what kind of on-street parking the road has</li>
<li>Repeat</li>
<li>Click <strong>Generate OsmChange file</strong></li>
<li>Upload the diff.osc file by adding a layer in JOSM (or send it to me)</li>
</ol>
<p>Like all edits to OSM, to figure out ground-truth, you can survey in-person or
use
<a href="https://wiki.openstreetmap.org/wiki/Bing_Maps#Streetside_imagery">Bing Streetside</a>.
<strong>Do not use data from Google Maps to edit OSM.</strong></p>
<h2 id="faq-1"><a class="header" href="#faq-1">FAQ</a></h2>
<h3 id="why"><a class="header" href="#why">Why?</a></h3>
<p>I'm trying to build a realistic traffic simulation of Seattle using OSM data,
then use it to strengthen proposals for
<a href="software/../proposals/lake_wash.html">pedestrianized streets</a>,
<a href="https://www.glwstreets.org/45th-st-bridge-overview">improving the bike network</a>,
and mitigating the West Seattle bridge closure. A/B Street is only as good as
its data, and parking is one of the biggest gaps. Missing data means unrealistic
traffic as vehicles contend for few parking spots, and roads that look much
wider than they are in reality.</p>
<h3 id="why-put-this-data-in-osm"><a class="header" href="#why-put-this-data-in-osm">Why put this data in OSM?</a></h3>
<p>Why can't I just grab parking data from
<a href="http://web6.seattle.gov/SDOT/seattleparkingmap/">SDOT's map</a>, using the
<a href="http://data-seattlecitygis.opendata.arcgis.com/datasets/blockface">blockface</a>
dataset? Well, I'm trying -- when you see a parking lane in the tool, it's
coming from blockface, unless that road in OSM is tagged. But the blockface
dataset is comically wrong in many places -- for example, the Montlake bridge
apparently has unrestricted parking?! King County GIS has confirmed the dataset
isn't meant to be used for this level of detail.</p>
<p>Plus, if the data is in OSM, anybody else can make use of it.</p>
<h3 id="how-does-the-tool-work"><a class="header" href="#how-does-the-tool-work">How does the tool work?</a></h3>
<p>A/B Street attempts to render individual lanes and intersections from OSM data.
This makes it useful to audit the lane tags in OSM, including
<a href="https://wiki.openstreetmap.org/wiki/Key:parking:lane">parking:lane</a>. The tool
tracks your edits and when you generate the OsmChange file, it grabs modified
ways from the OSM API to generate a diff. You can inspect the diff, load it in
JOSM, and upload.</p>
<p><strong>Your changes won't immediately be reflected in A/B Street.</strong> Let me know when
you've done some amount of mapping, and I'll regenerate the maps from fresh
data.</p>
<h3 id="why-use-this-tool"><a class="header" href="#why-use-this-tool">Why use this tool?</a></h3>
<p>You don't have to; <a href="https://zlant.github.io/parking-lanes/">this tool</a> or ID or
JOSM all work. But the UI is clunky for this specific purpose. (Also, if you
find this tool clunky in any way, let me know and I'll fix it.) There's also a
proposed
<a href="https://github.com/westnordost/StreetComplete/issues/771">StreetComplete quest</a>.</p>
<h3 id="what-about-parking-restrictions"><a class="header" href="#what-about-parking-restrictions">What about parking restrictions?</a></h3>
<p>There are many
<a href="https://wiki.openstreetmap.org/wiki/Key:parking:lane">parking:lane</a> tags to
indicate restricted parking zones, time restrictions, etc. Feel free to map that
in ID or JOSM, but I'm just looking to make a first pass over a wide area.</p>
<h3 id="what-about-off-street-parking"><a class="header" href="#what-about-off-street-parking">What about off-street parking?</a></h3>
<p>Ideally I'd also like to know how many private parking spots are available to
residents of each building. But I don't know of an OSM schema for mapping this,
or a practical way to collect this data. Let me know if you have ideas.</p>
<h3 id="what-about-long-roads-where-parking-appears-and-disappears"><a class="header" href="#what-about-long-roads-where-parking-appears-and-disappears">What about long roads where parking appears and disappears?</a></h3>
<p>The tool won't help. Use your favorite editor to split the way when the lane
configuration changes. Also feel free to just skip these areas.</p>
<h3 id="how-to-coordinate-with-other-mappers"><a class="header" href="#how-to-coordinate-with-other-mappers">How to coordinate with other mappers?</a></h3>
<p>If somebody wants to set up HOT tasking, that'd be great, but I don't expect so
many people to jump on this.</p>
<h3 id="i-noticed-weird-roads-in-the-tool"><a class="header" href="#i-noticed-weird-roads-in-the-tool">I noticed weird roads in the tool</a></h3>
<p>Welcome to my world. ;) If the number of lanes seems wrong, select the road and
check the OSM tags. I'm inferring lanes from that. Feel free to make manual OSM
edits to fix any problems you see. (I'd like to extend this tool to make that
easier; let me know if you have ideas how to do this.)</p>
<h3 id="i-want-to-map-an-area-but-theres-no-option-for-it"><a class="header" href="#i-want-to-map-an-area-but-theres-no-option-for-it">I want to map an area, but there's no option for it</a></h3>
<p>To keep the release size small, I'm not including all maps yet. Let me know what
you'd like to see included.</p>
<p>Or if you have a <code>.osm</code> file, try the <a href="software/../user/new_city.html">quick start guide</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="user-guide-1"><a class="header" href="#user-guide-1">User guide</a></h1>
<p>Please <a href="https://github.com/a-b-street/abstreet/issues/">file a Github issue</a> or
email <a href="mailto:user/dabreegster@gmail.com">dabreegster@gmail.com</a> if you encounter any problems.</p>
<h2 id="installing-ab-street"><a class="header" href="#installing-ab-street">Installing A/B Street</a></h2>
<p>You can run A/B Street
<a href="http://play.abstreet.org/0.3.20/abstreet.html">directly in your web browser</a>.
It's slower and there are some limitations compared to installing locally.</p>
<p>Grab a pre-built binary release:</p>
<ul>
<li><a href="https://github.com/a-b-street/abstreet/releases/download/v0.3.20/abstreet_windows_v0_3_20.zip">Windows</a>
<ul>
<li>Unzip the folder, then run <code>play_abstreet.bat</code>. If you get a warning about
compressed files, choose to extract -- you can't run from the .zip directly.</li>
<li>If you get a &quot;Windows protected you&quot; security warning, click &quot;more info&quot;,
then &quot;run anyway.&quot; We don't sign the release yet, so A/B Street shows up as
an unknown publisher.</li>
</ul>
</li>
<li><a href="https://github.com/a-b-street/abstreet/releases/download/v0.3.20/abstreet_mac_v0_3_20.zip">Mac</a>
<ul>
<li>Unzip the directory, then run <code>play_abstreet.sh</code>.</li>
<li>If you get an error about the developer unverified,
<a href="https://support.apple.com/guide/mac-help/open-a-mac-app-from-an-unidentified-developer-mh40616/mac">follow this</a>.
Help needed to start
<a href="https://github.com/a-b-street/abstreet/issues/107">signing the release</a>!</li>
<li>If that just opens a text file, then instead open terminal, <code>cd</code> to the
directory you just unzipped. Then do:
<code>cd game; RUST_BACKTRACE=1 ./game 1&gt; ../output.txt 2&gt;&amp;1</code></li>
<li><a href="https://github.com/a-b-street/abstreet/issues/77">Help needed</a> to package
this as a Mac .app, to make this process simpler</li>
</ul>
</li>
<li><a href="https://github.com/a-b-street/abstreet/releases/download/v0.3.20/abstreet_linux_v0_3_20.zip">Linux</a>
<ul>
<li>Unzip the directory, then run <code>play_abstreet.sh</code>, e.g. with the following
commands</li>
</ul>
</li>
</ul>
<pre><code class="language-bash">cd ~/Downloads
wget https://github.com/a-b-street/abstreet/releases/download/v0.3.20/abstreet_linux_v0_3_20.zip
unzip abstreet_linux_v0_3_20.zip
cd abstreet_linux_v0_3_20
./play_abstreet.sh
</code></pre>
<ul>
<li>For a video illustrating this and more detailed instructions on installing the
tool on Linux, see <a href="user/run_on_linux.gif">here</a>.</li>
<li><a href="https://www.freshports.org/games/abstreet/">FreeBSD</a>, thanks to
<a href="https://github.com/yurivict">Yuri</a></li>
</ul>
<p>Or you can <a href="user/../tech/dev/index.html">compile from source</a>.</p>
<h2 id="common-issues"><a class="header" href="#common-issues">Common issues</a></h2>
<p>If the size of text and panels
<a href="https://github.com/a-b-street/abstreet/issues/381">seems very strange</a>, you can
try editing <code>play_abstreet.sh</code> or <code>play_abstreet.bat</code> and passing
<code>--scale_factor=1</code> on the command line. This value is detected from your monitor
settings, so if you have a Retina or other HiDPI display, things may be too big
or small.</p>
<h2 id="data-source-licensing"><a class="header" href="#data-source-licensing">Data source licensing</a></h2>
<p>A/B Street binary releases contain pre-built maps that combine data from:</p>
<ul>
<li>OpenStreetMap (<a href="https://www.openstreetmap.org/copyright">https://www.openstreetmap.org/copyright</a>)</li>
<li>King County metro
(<a href="https://www.kingcounty.gov/depts/transportation/metro/travel-options/bus/app-center/terms-of-use.aspx">https://www.kingcounty.gov/depts/transportation/metro/travel-options/bus/app-center/terms-of-use.aspx</a>)</li>
<li>City of Seattle GIS program
(<a href="https://www.opendatacommons.org/licenses/pddl/1.0/">https://www.opendatacommons.org/licenses/pddl/1.0/</a>)</li>
<li><a href="https://github.com/seattleio/seattle-boundaries-data">https://github.com/seattleio/seattle-boundaries-data</a>
(<a href="https://creativecommons.org/publicdomain/zero/1.0/">https://creativecommons.org/publicdomain/zero/1.0/</a>)</li>
<li>Puget Sound Regional Council
(<a href="https://www.psrc.org/activity-based-travel-model-soundcast">https://www.psrc.org/activity-based-travel-model-soundcast</a>)</li>
<li>USGS SRTM</li>
</ul>
<p>Other binary data bundled in:</p>
<ul>
<li>Overpass font (<a href="https://fonts.google.com/specimen/Overpass">https://fonts.google.com/specimen/Overpass</a>, Open Font
License)</li>
<li>Bungee fonts (<a href="https://fonts.google.com/specimen/Bungee">https://fonts.google.com/specimen/Bungee</a>, Open Font License)</li>
<li>Material Design icons (<a href="https://material.io/resources/icons">https://material.io/resources/icons</a>, Apache license)</li>
<li>Some Graphics textures (<a href="https://www.kenney.nl/">https://www.kenney.nl/</a>, CC0 1.0 Universal)</li>
<li>Snowflake SVG (<a href="https://www.svgrepo.com/page/licensing">https://www.svgrepo.com/page/licensing</a>, CC0)</li>
<li>Music from
<a href="https://github.com/a-b-street/abstreet/tree/master/data/system/assets/music/sources.md">various sources</a>
with Creative Commons licenses</li>
<li>Country flags (<a href="https://github.com/hampusborgos/country-flags">https://github.com/hampusborgos/country-flags</a>, public domain)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="importing-a-new-city-into-ab-street"><a class="header" href="#importing-a-new-city-into-ab-street">Importing a new city into A/B Street</a></h1>
<p>If you get stuck, please email <a href="mailto:user/dabreegster@gmail.com">dabreegster@gmail.com</a> or
<a href="https://github.com/a-b-street/abstreet/issues/">file a Github issue</a>. I promise
quick turnaround time. All you need to do is send the boundary of the area you
want, drawn with <a href="http://geojson.io">geojson.io</a>.</p>
<h2 id="the-easy-method"><a class="header" href="#the-easy-method">The easy method</a></h2>
<p>This only works in the <a href="user/index.html">downloaded version</a>, not on web.</p>
<ol>
<li>Click the map name in sandbox mode to change your location.</li>
<li>Click &quot;import a new city&quot;</li>
<li>Follow the instructions. That's it!</li>
</ol>
<p>This may take a few minutes, depending on download speed. Be sure to use the
polygon tool to draw an area, not the polyline tool.</p>
<h2 id="if-the-city-has-already-been-imported"><a class="header" href="#if-the-city-has-already-been-imported">If the city has already been imported</a></h2>
<p>A/B Street includes many cities already. Once you're running the game (natively
or on the web), click on the Sandbox option, then check the top for a button to
change the map:</p>
<p><img src="user/change_map.png" alt="" /></p>
<p>You can browse through a list of cities per country, or use a text search:</p>
<p><img src="user/search_maps.png" alt="" /></p>
<p>You may need to download data for that city:</p>
<p><img src="user/download_map.png" alt="" /></p>
<p>You should be able to open the map. In this case above, the map data was saved
as <code>data/system/gb/exeter_red_cow_village/maps/center.bin</code>.</p>
<h2 id="how-to-pick-boundaries"><a class="header" href="#how-to-pick-boundaries">How to pick boundaries</a></h2>
<p>How do you decide what part of a city to import? It can be tempting to use
pre-existing administrative boundaries. There are a few problems:</p>
<ol>
<li>Official boundaries might exclude something relevant to transportation in
the area. For example, London boroughs don't cover the River Thames or its
bridges! Or if you're studying low-traffic neighborhoods, an area near the
border of two boroughs might not include enough surrounding context.</li>
</ol>
<p><img src="user/london_boroughs.png" alt="" /></p>
<ol start="2">
<li>
<p>File size is hard to tune. You have to play around with this to make the
resulting area large enough to be useful, but the map file small enough to
comfortably load. About 50MB uncompressed (usually 20MB gzipped) is a good
target.</p>
</li>
<li>
<p>You might have to adjust the boundary to exclude the coastline and ocean,
due to <a href="https://github.com/dabreegster/abstreet/issues/32">a bug</a>.</p>
</li>
</ol>
<p>You can create multiple districts covering a city. The districts can partially
overlap, and you don't have to cover everything. It's totally dependent on what
you want to study. The current Seattle boundaries are just based on different
projects we've worked on:</p>
<p><img src="user/seattle_boundaries.png" alt="" /></p>
<p>You can also just make best geographic guesses like in Paris:</p>
<p><img src="user/paris_boundaries.png" alt="" /></p>
<p>The more maps configured to always be imported, the slower my development
workflow gets when working on map importer code. So I'd also request you don't
go overboard and ask for lots of areas, unless you're going to actively work on
some advocacy or research across multiple A/B Street releases. You can always
import an area yourself in the UI.</p>
<h2 id="advanced-using-the-command-line"><a class="header" href="#advanced-using-the-command-line">Advanced: Using the command-line</a></h2>
<p>The process above using the UI just calls a tool to do all of the work. If you
want, you can just call that tool from the command line. First save a GeoJSON
file with your boundary. Then...</p>
<p>Using a .zip release:
<code>./cli one-step-import --geojson-path=boundary.geojson --map-name=prague</code></p>
<p>Building from source:
<code>cargo run --release --bin cli -- one-step-import --geojson-path=boundary.geojson --map-name=prague</code></p>
<p>The new map is located in the country with code &quot;zz&quot; (this isn't a real
country), in the &quot;oneshot&quot; city. This is stored in
<code>data/system/zz/oneshot/maps</code>.</p>
<h2 id="advanced-adding-the-city-to-ab-street-permanently"><a class="header" href="#advanced-adding-the-city-to-ab-street-permanently">Advanced: Adding the city to A/B street permanently</a></h2>
<p>The easiest method is to just ask Dustin to do this. The full process:</p>
<ol>
<li>
<p>Make sure you can run <code>import.sh</code> -- see
<a href="user/../tech/dev/index.html#building-map-data">the instructions</a>. You'll need
Rust, osmconvert, gdal, etc.</p>
</li>
<li>
<p>Create a new directory: <code>mkdir importer/config/xy/your_city</code>, where <code>xy</code> is
a lowercase two letter country code from
<a href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2">https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2</a></p>
</li>
<li>
<p>Use <a href="http://geojson.io/">geojson.io</a> or
<a href="https://geoman.io/geojson-editor">geoman.io</a> to draw a boundary around the
region you want to simulate and save the geojson locally.</p>
</li>
<li>
<p>Use <code>cargo run --release --bin cli -- geojson-to-osmosis boundary.geojson</code>
to convert that geojson to the
<a href="https://wiki.openstreetmap.org/wiki/Osmosis/Polygon_Filter_File_Format">Osmosis format</a>
required by osmconvert. This tool writes one file per feature in the input,
so you'd then
<code>mv boundary0.poly importer/config/xy/your_city/region_name.poly</code>, repeating
if you drew multiple polygons.</p>
</li>
<li>
<p>Edit <code>importer/src/map_config.rs</code> if needed. If you're the first to import a
new country, you may need to configure left-handed drivng, for example.</p>
</li>
<li>
<p>Run the import: <code>./import.sh --city=xy/your_city --raw --map</code></p>
</li>
<li>
<p>Update <code>.gitignore</code>, following <code>tel_aviv</code> as an example. Keep sorted!</p>
</li>
<li>
<p>Fill out <code>nice_map_name</code> in <code>map_gui/src/tools/mod.rs</code>.</p>
</li>
</ol>
<p>Send a PR with your changes! I'll generate everything and make it work with
<code>updater</code>, so most people don't have to build everything from scratch.</p>
<p>Also, you can divide the city into multiple regions, repeating step 4 and
declaring more polygon boundaries. The boundaries may overlap each other, and
they don't have to cover all of the space. Picking good boundaries may take
trial-and-error; the goal is to keep the resulting map file size small, so that
it loads quickly, while capturing all of the area needed to simulate something
interesting. This is easiest when you have some local knowledge of the area, and
at least a vague goal in mind for what you want to study.</p>
<h2 id="advanced-importing-a-osm-file-directly"><a class="header" href="#advanced-importing-a-osm-file-directly">Advanced: Importing a .osm file directly</a></h2>
<p>This section assumes you're comfortable working on a command line. If you have a
.osm XML file, you can import it directly by running
<code>cargo run --release --bin cli -- oneshot-import /path/to/extract.osm</code>. If
you're running from a .zip release and not building from source, replace the
first part with <code>./cli oneshot-import</code>.</p>
<p>Assuming this succeeds, it'll create a file in the
<code>data/system/zz/oneshot/maps/</code> directory. In the UI, you can open the &quot;zz&quot;
country to find it.</p>
<p>If you save a .osm file from JOSM, you might get an error importing related to
<code>convert_osm/src/clip.rs</code>. If so, delete the <code>&lt;bounds&gt;</code> element from the top of
the .osm file and try again.</p>
<p>If you follow this process, the resulting map won't have any border
intersections, which will break parts of the simulation:</p>
<p><img src="user/no_clip.png" alt="no_clip" /></p>
<p>You can fix this by creating the Osmosis .poly file and passing
<code>--clip-path=/path/to/clip.poly</code> to the import command.</p>
<p>One use case for following this section is to temporarily work around
<a href="https://github.com/a-b-street/abstreet/issues/654">broken intersection geometry</a>.
The process is:</p>
<ol>
<li>Edit the problematic area in JOSM, recreating a complicated intersection in
a simpler way.</li>
<li>Save the .osm file locally</li>
<li>Run the importer</li>
<li>Try in A/B Street</li>
</ol>
<p>You probably don't want to upload the changeset to OSM, unless it's actually
mis-tagged. Usually the problem is how A/B Street tries to interpret what's in
OSM. Ideally we could also follow this process using the ID editor, but it can't
currently
<a href="https://github.com/openstreetmap/iD/issues/7109">manage changeset files fully</a>.</p>
<h2 id="next-steps-2"><a class="header" href="#next-steps-2">Next steps</a></h2>
<p>OpenStreetMap isn't the only data source we need. If you look at the import
pipeline for Seattle, you'll see many more sources for parking, GTFS bus
schedules, person/trip demand data for scenarios, etc. Most of these aren't
standard between cities. If you want to make your city more realistic, we'll
have to import more data. Get in touch.</p>
<p>You may notice issues with OSM data while using A/B Street. Some of these are
bugs in A/B Street itself, but others are incorrectly tagged lanes. Some
resources for fixing OSM:</p>
<ul>
<li><a href="https://learnosm.org">https://learnosm.org</a></li>
<li><a href="https://wiki.openstreetmap.org/wiki/StreetComplete">https://wiki.openstreetmap.org/wiki/StreetComplete</a></li>
<li><a href="user/../software/parking_mapper.html">Mapping parking</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="instructions-for-asu-collaborators"><a class="header" href="#instructions-for-asu-collaborators">Instructions for ASU collaborators</a></h1>
<p>These instructions are tailored to the
<a href="https://github.com/asu-trans-ai-lab/">ASU Transportation AI Lab</a>.</p>
<p>The most important tip: ask questions!
<a href="https://github.com/dabreegster/abstreet/issues/">File an issue</a>, email
<a href="mailto:user/dabreegster@gmail.com">dabreegster@gmail.com</a>, or ask for a Slack invite.</p>
<h2 id="installing"><a class="header" href="#installing">Installing</a></h2>
<p>A new version is released every Sunday, but you probably don't need to update
every week.</p>
<ol>
<li>Go to <a href="https://github.com/a-b-street/abstreet/releases">https://github.com/a-b-street/abstreet/releases</a> and download the
latest <code>.zip</code> file for Windows, Mac, or Linux.</li>
</ol>
<p><img src="user/download.png" alt="download" /></p>
<ol start="2">
<li>Unzip the folder and run <code>play_abstreet.sh</code> or <code>play_abstreet.bat</code>. If you
get security warnings, see <a href="user/index.html#installing-the-game">here</a>.</li>
</ol>
<p><img src="user/run.png" alt="run" /></p>
<ol start="3">
<li>On the main title screen, click <code>Sandbox</code>. This starts in Seattle by
default, so change the map at the top.</li>
</ol>
<p><img src="user/change_map.png" alt="change_map" /></p>
<ol start="4">
<li>Choose USA, then Phoenix.</li>
</ol>
<p><img src="user/usa.png" alt="usa" /></p>
<ol start="5">
<li>You'll be prompted to download some files. It should be quick. After it's
done, click Phoenix again.</li>
</ol>
<p>You've now opened up the Tempe map!</p>
<h3 id="a-shortcut-and-improving-the-simulation-in-tempe"><a class="header" href="#a-shortcut-and-improving-the-simulation-in-tempe">A shortcut and improving the simulation in Tempe</a></h3>
<p>On Windows, edit <code>run_abstreet.bat</code> and change the last line to:</p>
<p><code>game.exe --dev data/system/us/phoenix/maps/tempe.bin --infinite_parking 1&gt; ..\\output.txt 2&gt;&amp;1</code></p>
<p>On Mac, edit <code>run_abstreet.sh</code> and change the last line to:</p>
<p><code>RUST_BACKTRACE=1 ./game --dev data/system/us/phoenix/maps/tempe.bin --infinite_parking 1&gt; ../output.txt 2&gt;&amp;1</code></p>
<p><code>--dev data/system/us/phoenix/maps/tempe.bin</code> will skip the title screen and
start on the Tempe map by default; this will save you lots of time.</p>
<p><code>--infinite_parking</code> disables the parking simulation. By default, there's an
unrealistic amount of people walking around Tempe just to reach the spot where
their car is parked. We don't have good data yet about on- and off-street
parking, so it's best to just make driving trips begin and end at buildings or
off the map, without a step to search for parking.</p>
<p>There are a bunch of other
<a href="user/../tech/dev/index.html#development-tips">startup parameters</a> you can pass here
too.</p>
<h2 id="importing-a-grid2demand-scenario"><a class="header" href="#importing-a-grid2demand-scenario">Importing a Grid2Demand scenario</a></h2>
<p>When you run <a href="https://github.com/asu-trans-ai-lab/grid2demand">https://github.com/asu-trans-ai-lab/grid2demand</a>, you get an
<code>input_agents.csv</code> file. You can import this into A/B Street as a scenario.</p>
<ol>
<li>Change the traffic from <code>none</code></li>
</ol>
<p><img src="user/pick_scenario.png" alt="pick_scenario" /></p>
<ol start="2">
<li>Click <code>import Grid2Demand data</code></li>
</ol>
<p><img src="user/grid2demand.png" alt="grid2demand" /></p>
<ol start="3">
<li>
<p>Choose your <code>input_agents.csv</code> file</p>
</li>
<li>
<p>A new scenario will be imported. Later you can launch this from the same
menu; the scenario will be called <code>grid2demand</code></p>
</li>
</ol>
<p><img src="user/scenario_again.png" alt="scenario_again" /></p>
<p>Grid2Demand needs a .osm file as input. The extract of Tempe that A/B Street
uses is at
<a href="https://abstreet.s3.us-east-2.amazonaws.com/dev/data/input/us/phoenix/osm/tempe.osm.gz">https://abstreet.s3.us-east-2.amazonaws.com/dev/data/input/us/phoenix/osm/tempe.osm.gz</a>.
Note the file is compressed.</p>
<h2 id="modifying-a-scenario"><a class="header" href="#modifying-a-scenario">Modifying a scenario</a></h2>
<p>You can transform a scenario before simulating it. This example will cancel all
walking and biking trips from the scenario, only leaving driving and public
transit.</p>
<ol>
<li>After loading a scenario, click <code>0 modifications to traffic patterns</code></li>
</ol>
<p><img src="user/mod_traffic.png" alt="mod_traffic" /></p>
<ol start="2">
<li>
<p>Click <code>Change trip mode</code></p>
</li>
<li>
<p>Select the types of trips that you want to transform, and change them to
cancel. Click <code>Apply</code>.</p>
</li>
</ol>
<p><img src="user/cancel.png" alt="cancel" /></p>
<h2 id="importing-vol2timing-data"><a class="header" href="#importing-vol2timing-data">Importing Vol2Timing data</a></h2>
<p><a href="https://github.com/asu-trans-ai-lab/Vol2Timing/">https://github.com/asu-trans-ai-lab/Vol2Timing/</a> produces <code>timing.csv</code> files
that you can import into A/B Street.</p>
<ol>
<li>
<p>Open the traffic signal editor for an intersection in A/B Street.</p>
</li>
<li>
<p>Click <code>Edit entire signal</code></p>
</li>
<li>
<p>Choose <code>import from a new GMNS timing.csv</code>, then pick your file.</p>
</li>
</ol>
<p>The import process isn't finished yet; some movements aren't matched properly,
some movements are incorrectly marked as protected, and no crosswalks are
imported yet. When you import, some error messages may be displayed, and others
might wind up printed to STDOUT (captured in <code>output.txt</code> on Windows).</p>
<p>If you want to import timing for more intersections in the same map, after
<code>Edit entire signal</code>, you should also have n option like
<code>import from GMNS C:\path\to\timing.csv</code>.</p>
<h3 id="debugging-timingcsv"><a class="header" href="#debugging-timingcsv">Debugging timing.csv</a></h3>
<p>Along with QGIS, you can also visualize <code>timing.csv</code> in A/B Street directly.</p>
<ol>
<li>
<p>From the title screen, choose <code>Internal dev tools</code>.</p>
</li>
<li>
<p>Change the map if necessary.</p>
</li>
<li>
<p>Click <code>view KML</code>.</p>
</li>
<li>
<p>Click <code>load KML file</code>, then choose your <code>timing.csv</code>.</p>
</li>
<li>
<p>Each movement is drawn in red. You can hover over a line-string to see its
attributes, and click to open all details.</p>
</li>
</ol>
<p><img src="user/gmns_debug.png" alt="gmns_debug" /></p>
<ol start="6">
<li>Using the key=value filter on the left, you can type in <code>no=3</code> to match
<code>stage_no=3</code> and easily check what movements belong to each stage.</li>
</ol>
<p><img src="user/gmns_stages.png" alt="gmns_stages" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="proposals-2"><a class="header" href="#proposals-2">Proposals</a></h1>
<p>The whole point of A/B Street is for people to suggest real fixes to their city,
so here's the list. In most cases, we're not yet able to use A/B Street itself
to illustrate the problem or solution -- but that shouldn't stop this list from
starting.</p>
<p>If you want to add anything here, contact us!</p>
<h2 id="seattle-1"><a class="header" href="#seattle-1">Seattle</a></h2>
<p>Disclaimer: currently this is just one person's (Dustin) list, so it reflects my
experiences and biases. South Seattle is conspicuously missing -- I need to go
explore more.</p>
<p>Safety problems biking:</p>
<ul>
<li>Airport Way southbound from ID to Georgetown. The right lane has a huge
shoulder; at least paint a bike lane</li>
<li>Broadway bike lanes missing between Highland and John</li>
<li>Partitioning off a lane of Aurora at Green Lake west, proposed by Seattle
Greenways</li>
<li>Bike lanes vanishing halfway up Harvard to Roanoke</li>
<li>The massive intersection where the Burke Gilman meets Corliss</li>
<li>No passing room on Fuhrman/Boyer</li>
</ul>
<p>Antagonistic traffic signal timing:</p>
<p>(Why are these important: they're hopefully a cheap change, and problems here
add up, making driving the most convenient option.)</p>
<ul>
<li>Northbound on 11th after the University Bridge</li>
<li>Turning left from 11th Ave NE to Ravenna</li>
<li>The double crosswalk at Montlake / Husky Stadium</li>
<li>Cherry and 12th; long cycle time for people crossing near Seattle University</li>
<li>Yesler and Broadway slow beg buttons</li>
<li>Unmarked beg buttons around Beacon Hill, and no bike actuators</li>
<li>Beg buttons along Interurban near Bitter Lake</li>
</ul>
<p>Larger changes:</p>
<ul>
<li>Cafe/bus street along University Ave</li>
<li>Eastlake cycle lanes</li>
<li><a href="https://twitter.com/QAGreenways/status/872554226752278528/photo/1">Madison Safety Corridor</a></li>
</ul>
<h2 id="london"><a class="header" href="#london">London</a></h2>
<p>There's some idea related to a
<a href="https://github.com/a-b-street/abstreet/issues/577">cycle-path on the A5</a></p>
<h2 id="template"><a class="header" href="#template">Template</a></h2>
<p>Over time, each idea will link to a full write-up. That page can have any
format, but I imagine this basic structure is useful:</p>
<ul>
<li>Describe the problem
<ul>
<li>A clear map showing the scope of the issue</li>
<li>Include pictures and videos from a physical survey, or maybe annotated
satellite imagery</li>
<li>Use A/B Street to demonstrate the problem for individual people or in
aggregate</li>
</ul>
</li>
<li>Describe the proposed solution
<ul>
<li>Ideally A/B Street is useful for visualizing the change, and measuring
quantitative results.</li>
<li>Explain any limits with the modelling</li>
</ul>
</li>
<li>Give context on the problem
<ul>
<li>Is this being discussed anywhere -- often on Twitter?</li>
<li>Are there other proposals or write-ups?</li>
</ul>
</li>
<li>Give arguments against the proposed solution
<ul>
<li>Unintended consequences, prohibitive costs, alternate routes available</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dustins-vision-for-seattles-bike-network"><a class="header" href="#dustins-vision-for-seattles-bike-network">Dustin's vision for Seattle's bike network</a></h1>
<p>I've been commuting almost exclusively by bike here since 2014. I've had too
many close calls and plenty of frustrating moments when it feels like the design
is trying to discourage this mode of transport as much as possible. I want to
see a network tht encourages as many people as possible to choose biking over
driving, for <a href="proposals/seattle_bikes/../../software/ungap_the_map/motivation.html">these reasons</a>.</p>
<p>So many times, I wish I had a magic wand that could just fix things. I don't,
and it takes years of concentrated effort to campaign and push for redesigned
streets, and I'm impatient -- so I (along with <a href="proposals/seattle_bikes/../../project/team.html">my team</a>)
built that magic wand: software to sketch out my vision for biking in Seattle.
My hope is that if people can more easily imagine and visualize things like the
<a href="https://www.seattle.gov/transportation/document-library/citywide-plans/modal-plans/bicycle-master-plan">bike master plan</a>,
they'll debate more effectively about them, proposals will be funded more easily
and with greater participation from more people.</p>
<p>The vision here will just be limited to adding bike lanes, protected by planter
boxes or just paint, to existing road-space, usually by sacrificing street
parking or an extra driving lane. There are plenty of other changes I want to
see involving light rail, bus frequencies, Stay Healthy Streets, and zoning
changes... but that's not the focus here.</p>
<h2 id="disclaimer"><a class="header" href="#disclaimer">Disclaimer</a></h2>
<p>This is what I personally want to see, based on where I live and commute. I'm
very much bringing all of my biases into the proposal. You'll notice much less
focus in South and West Seattle, because I don't happen to spend much time
there. Of course I think they also deserve great bike infrastructure, but I'm
not experienced enough to talk about it.</p>
<p>Because of this, I'm not very attached to this specific proposal. What I
<em>really</em> want is for <em>you</em> to try out this software yourself and share your own
vision. This write-up just serves as an example use of the tool. Please give it
a spin and blog or tweet about it, so I can go back to writing code, not
English!</p>
<!--
link to alt plans, like near-term / in progress builds, and the basic bike
network master plan -->
<h2 id="the-network"><a class="header" href="#the-network">The network</a></h2>
<p>Follow along in your web browser. Most of the changes are around
<a href="http://play.abstreet.org/0.3.20/abstreet.html?--ungap&amp;system/us/seattle/maps/central_seattle.bin&amp;--edits=dustin_bikelino">Central Seattle</a>
and
<a href="http://play.abstreet.org/0.3.20/abstreet.html?--ungap&amp;system/us/seattle/maps/south_seattle.bin&amp;--edits=dustin_bikelino">South Seattle</a>.
If you have trouble using the tool, check the
<a href="proposals/seattle_bikes/../../software/ungap_the_map/user_guide.html">user guide</a> or send feedback.</p>
<h3 id="boyer--fuhrman"><a class="header" href="#boyer--fuhrman">Boyer / Fuhrman</a></h3>
<p>This is practically the origin story of A/B Street; it only takes one truck
passing super close and almost pancaking me into the line of parked cars...</p>
<p>Swapping parking for some dedicated lanes is a really tough sell between the
university bridge and 520 underpass, though. Having lived in the area for a few
years (when I still had a jeep to park), I can confirm how low the area is on
street parking. Although the area's strategically close to UW and downtown for
biking, nearby transit connections are a bit of a walk. Also, Fuhrman has a
bunch of curb bulbs and traffic islands that would force bikes to merge back
into the main lane every few blocks, so this would probably be a bigger paving
project.</p>
<p>The alternative route is to cross the University or Montlake bridge and take the
Burke, or take the scenic route through south campus. But depending which way
you're going, this is a long detour, and probably forces you over the Montlake
bridge, meaning navigating the absolute mess of Montlake/520. It's possible the
<a href="https://wsdot.wa.gov/projects/sr520/montlake/home">the lid</a> will make this area
less terrible, but... not sure how. (There are some tricks like the Bill Dawson
trail that slightly ease the pain, depending where you're going.)</p>
<p>It's possible there's some
<a href="https://twitter.com/typewriteralley/status/1445922612421402626/photo/1">plan</a>
for Fuhrman with RapidRide J?</p>
<h3 id="ne-45th-st"><a class="header" href="#ne-45th-st">NE 45th St</a></h3>
<p><img src="proposals/seattle_bikes/45th.png" alt="" /></p>
<p><a href="https://www.theurbanist.org/2021/01/27/reclaiming-ne-45th-street-from-cars/">Joe Mangan</a>
presents this vision way more eloquently than I could. Another organization has
called for better facilities on
<a href="https://www.glwstreets.org/45th-st-bridge-overview">the I5 bridge</a>, but I'd
personally like to make the connection all the way from the U-district to
Wallingfjord, patronizing all the shops along the way without hustling to keep
up with traffic.</p>
<p>I thought about 50th as an alternative, but it's farther from the action in the
U-district (including the brand new Link station!) and would skip the
Wallingford business district.</p>
<h3 id="aurora-ave"><a class="header" href="#aurora-ave">Aurora Ave</a></h3>
<p><img src="proposals/seattle_bikes/aurora_alternative.png" alt="" /></p>
<p>This is a trivial argument by checking elevation. If you're going north from
Fremont, climbing Fremont Ave, then Phinney and Greenwood Ave at least has some
paint. But just look at how gentle the elevation using Aurora would be! Looking
the other direction, it could be a straight shot -- a bicycle superhighway --
from all of north Seattle right to downtown.</p>
<p>I would sometimes brave biking the bus lane when I lived in Lichton Springs. If
you've got your wits about you and don't mind cars flying by at 50mph, it's, uh,
fine, until somebody wants to use the bus lane to accelerate or turn right
quickly. The right-of-way is utterly massive; there's many ways to squeeze in a
cycletrack of some sort.</p>
<p>See <a href="https://www.got99problems.org">Aurora Reimagined Coalition</a> and
<a href="https://www.glwstreets.org/complete-the-loop">Complete the Loop</a> for some
ongoing advocacy efforts in the area.</p>
<h3 id="rainier-ave"><a class="header" href="#rainier-ave">Rainier Ave</a></h3>
<p>The most direct connection between the International District and Colombia City
is straight down Rainier, a nearly flat route:</p>
<p><img src="proposals/seattle_bikes/rainier_direct.png" alt="" /></p>
<p>The quiet route takes longer, is steeper, and doesn't bring you past any
businesses:</p>
<p><img src="proposals/seattle_bikes/rainier_detour.png" alt="" /></p>
<p>I've biked on Rainier before,
<a href="https://www.seattlebikeblog.com/2020/09/10/seattle-knew-5-years-ago-that-a-rainier-ave-safety-project-would-save-lives-but-is-just-now-starting-work/">fully aware it's called Seattle's most dangerous road for a reason</a>.
In most places, it's a massive 5 lanes, meaning there's plenty of room to add
some protected lanes, giving more people easy access to the many businesses
along the corridor:</p>
<p><img src="proposals/seattle_bikes/rainier_detail.png" alt="" /></p>
<p>I've ended the changes at Orcas, since I'm not familiar with what's south of
that and might be a useful connection.</p>
<p>For more ideas about the current gaps in South Seattle, see
<a href="https://twitter.com/Zee_Shaner/status/1433630099924946962">this list</a>.</p>
<h3 id="eastlake-ave"><a class="header" href="#eastlake-ave">Eastlake Ave</a></h3>
<p>Eastlake would be the de facto route between the university district and
downtown, if it weren't for the intermittent mess of parked cars currently.
Shoulder space to avoid traffic appears and disappears, and some of the parking
is even supposed to be banned during rush hour. I believe as part of the
RapidRide J plan, Eastlake is supposed to get some dedicated lanes! Until then,
we can imagine how awesome it'll be:</p>
<p><img src="proposals/seattle_bikes/eastlake.png" alt="" /></p>
<p>Of course, RapidRide J will bring bus lanes,
<a href="https://twitter.com/SD70MACMAN/status/1446148993042423813/photo/1">here's a more accurate future</a>.</p>
<p>The alternative today is following the Cheshiahud Loop loop through
neighborhoods. It's nice and scenic, but weaves through steep alleyways -- not a
commuter route.</p>
<h3 id="lakeview"><a class="header" href="#lakeview">Lakeview</a></h3>
<p>One reasonable way to access lower Capitol Hill or downtown from the university
district area is along Lakeview. This makes use of a nice bike-only connection
near Melrose, and pops you out right into the heart of a commercial area. The
gap is near the I5 colonnade. Currently this is one lane each direction, with
parking usually on both sides. There's an I5 exit in the middle. So in practice,
<a href="https://twitter.com/CarlinoDustin/status/1416988865844240386">this nonsense</a>
happens:</p>
<p><img src="proposals/seattle_bikes/lakeview_fail.png" alt="" /></p>
<p>Just nuke the parking and add bike lanes. I'm not sure what to do with the
Boylston Ave portion. There's a physical median there today, making the lane
pretty narrow, and I've heard stories about really aggressive cars squeezing
past at high speed. There is parking on the west side of that street, so
potentially that could be sacrificed and the median shifted over, to dedicate
shoulder space for biking on both sides.</p>
<p><img src="proposals/seattle_bikes/lakeview_fixed.png" alt="" /></p>
<h3 id="harvard-from-shelby-to-roanoke"><a class="header" href="#harvard-from-shelby-to-roanoke">Harvard from Shelby to Roanoke</a></h3>
<p>If you're crossing the university bridge and want to go to Capitol Hill, you're
probably taking Harvard to Roanoke to Broadway:</p>
<p><img src="proposals/seattle_bikes/harvard.png" alt="" /></p>
<p>There's a climbing lane up Harvard, but it just gives up at Shelby. There are
two full lanes at this point and is usually OK, but I've had a few stressful
experiences with aggressive vehicles. There's just one driving lane uphill
before Shelby, so why not just keep it that way, or make it a bus/bike lane for
Route 49?</p>
<p>The quieter route is to cut into the neighborhood and make use of the diagonal
diverter at Broadway and Edgar. You'll have to press the beg button at the south
end of Roanoke Park to continue up the hill.</p>
<h3 id="broadway-between-highland-and-denny"><a class="header" href="#broadway-between-highland-and-denny">Broadway between Highland and Denny</a></h3>
<p>South of the light rail, Broadway has a protected two-way cycletrack and north
of Highland, there are painted lanes. But inexplicably they vanish between
Highland and Denny. If you want to dodge less cars, you can cut onto Harvard, a
much bumpier street without any businesses along it. Why not take out the center
lane and extend the cycletrack or the painted lanes on both sides?</p>
<p>The street parking along this stretch is usually pretty full, and often trucks
use the center lane as a makeshift loading zone. This is a commercial hub and
should still have a way to drive and park here, but given how well-connected the
area is by public transit, I don't think prioritizing parking makes sense.</p>
<h3 id="the-missing-link"><a class="header" href="#the-missing-link">The Missing Link</a></h3>
<p>The Burke Gilman trail, which is probably the highest-traffic walking/biking
path in Seattle, has had a
<a href="https://www.seattle.gov/transportation/projects-and-programs/programs/bike-program/ballard-multimodal-corridor">missing link</a>
literally since the 90's. I'm not going to weigh in on the debate on exactly how
this should be fixed; I've just put it on Shilshole. Maybe we'll see it
completed in another 30 years.</p>
<h3 id="airport-way-s"><a class="header" href="#airport-way-s">Airport Way S</a></h3>
<p>Once upon a time, I made the mistake of biking to Fedex in SODO during afternoon
rush hour (the narrow window when you can retrieve packages). I took Airport
because it's flat and direct, and there was plenty of room for cars to pass --
there's a pretty generous shoulder. But even though I was gunning it and keeping
pace with the stop-and-go traffic, there were still some vehicles that insisted
on flying across the 15-foot lane and almost swerving into me. So, I'd like to
add a protected lane here:</p>
<p><img src="proposals/seattle_bikes/airport.png" alt="" /></p>
<p>Note the edits show a driving lane taken away, but that's just because we don't
have accurate road width data. There's enough room to keep all the lanes, and
add some paint and barriers to the shoulder.</p>
<p>Why didn't I take the SODO trail and 6th Ave S? (Well, I certainly did on the
way back!) Honestly, I was just following Google Maps routing (which doesn't
have an option to avoid high-stress roads), and getting to the SODO trail from
the international district is more confusing than following the natural path
onto Airport. Maybe some wayfinding could help.</p>
<h3 id="others-1"><a class="header" href="#others-1">Others</a></h3>
<p>This has been a very modest &quot;vision&quot; map. Part of me wants to just add lanes on
every arterial, but then I'd have to write about the nuances of each of these
cases. Nonetheless, a few other areas I considered:</p>
<p>How're you supposed to comfortably go east/west in north Seattle? After living
in Lichton Springs for a while, I probably cut through different sequences of
residential streets every single ride. Looking at a contour map, 75th looks like
a candidate, but I'll have to go try it out.</p>
<p><img src="proposals/seattle_bikes/75th_contours.png" alt="" /></p>
<p>It's ridiculous to me that Lake Washington Blvd from Montlake all the way to
Seaward isn't better designed for biking; it's part of the Lake Washington loop,
and loads of people ride it. Greenways successfully fought for a
<a href="http://stayhealthystreets.org/streets/lwb/">Keep Moving Street</a> that had loads
of usage, but it ended after September.</p>
<p>Going from Ballard to downtown, normally I'd just take the scenic Elliot Bay
trail through to Centennial Park, but once I had an errand somewhere around 15th
Ave NW and Elliot. That's another huge road through a commercial area that
probably deserves some protected lanes.</p>
<h2 id="estimating-how-much-these-might-help"><a class="header" href="#estimating-how-much-these-might-help">Estimating how much these might help</a></h2>
<p>The software includes a tool to
<a href="proposals/seattle_bikes/../../software/ungap_the_map/user_guide.html#predict-impact">predict the impact</a>
of all of these changes to the region's current travel patterns. There's lots of
assumptions and limitations with the calculation that you should read and mutter
quietly to yourself about, but nonetheless, what's the verdict?</p>
<p><img src="proposals/seattle_bikes/impact_prediction.png" alt="" /></p>
<p>These 30 miles of new lanes could sway about 100,000 daily driving trips (about
7% of trips that stay within this part of Seattle and don't just pass through)
to bike instead. That's assuming people will only tolerate up to a 30 minute
ride with no more than 200 feet of elevation gain. If these driving trips all
choose a more sustainable mode every weekday for a year, that's roughly 23,000
tons of CO2 emissions saved. It's a start.</p>
<p>Thanks for reading this far. Please share your feedback about these ideas and
the new tool, and more importantly, your own vision for what biking in Seattle
could be!</p>
<div style="break-before: page; page-break-before: always;"></div><div class="post-header">
    <div class="post-header-background" style="background-image:url(../assets/broadmoor/gate-banner.jpg)">
        <div class="post-header-overlay">
            <h1 class="post-header-text">Liberate Broadmoor</h1>
        </div>
    </div>
</div>
<h1 id="allow-bike-and-foot-traffic-through-broadmoor"><a class="header" href="#allow-bike-and-foot-traffic-through-broadmoor">Allow bike and foot traffic through Broadmoor</a></h1>
<p><em>posted July 1, 2021 by <a href="https://twitter.com/ikawe">Michael Kirk</a></em> 
<a href="proposals/../project/team.html">meet the A/B Street team</a></p>
<style>
// mobile-breakpoint = 569px + --side-bar-width (300px);

#site-header {
    font-weight: 600;
    background: #f0f0f0;
    padding:12px 16px
}

#site-header-title a {
    text-decoration: none;
    font-size: 16px;
    color:#000
}

.post-header {
    position:relative;
    /* hack: mdbook doesnt support the full bleed layout we actually want, so just do something that looks decent. */
    margin-left: -15px;
    margin-right: -15px;
}

.post-header-background {
    position: relative;
    background: black;
    width: 100%;
    background-size: cover;
    background-position:center
}

.post-header-overlay {
    padding-top: 80px;
    background-color:rgba(0, 0, 0, 0.6)
}

@media (min-width: 569px) {
    .sidebar-hidden .post-header-overlay {
        padding-top:280px
    }
}

@media (min-width: 869px) {
    .sidebar-visible .post-header-overlay {
        padding-top:280px
    }
}

.post-header-text {
    color: white;
    line-height: 50px;
    font-size: 46px;
    margin: 0 16px;
    padding-bottom:16px
}

@media (min-width: calc(816px)) {
    .post-header-text {
        margin-left: auto;
        margin-right: auto;
        max-width:800px;
        /* hack: mdbook doesnt support the full bleed layout we actually want, so just do something that looks decent. */
        margin-left: 15px;
    }
}

.post-subtitle {
    margin-left: auto;
    margin-right: auto;
    max-width: 800px;
    font-style:italic
}

.post-body {
    margin-left: auto;
    margin-right: auto;
    max-width:800px
}

.media-box {
    background-color: #f0f0f0;
    color: #000;
    padding-bottom: 16px;
    margin-bottom: 16px;
    margin-top:16px
}

.media-box img {
    width:100%;
    object-fit: cover;
}

.media-box .video-container {
    width: 100%;
    position:relative
}

.media-box .embedded-video, .media-box video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height:100%
}

.media-box .chart-header {
    margin-top: 0;
    padding-top: 8px;
    margin-bottom: 8px;
    margin-left:16px
}

.media-box img.chart {
    padding: 8px;
    width: calc(100% - 16px);
    object-fit:contain
}

.media-box p {
    margin: 8px 16px 0 16px;
    padding:0
}

.media-box .photo-attribution {
    color: #888;
    font-size:16px
}

@media (min-width: 569px) {
    .sidebar-hidden .wrap-two {
        display: flex;
        flex-direction: row;
        justify-content:space-between
    }

    .sidebar-hidden .wrap-two .media-box:first-child {
        margin-right: 16px
    }

    .sidebar-hidden .wrap-two .media-box {
        width: 50%
    }

    .sidebar-hidden .wrap-two img {
        max-height:300px
    }
}

@media (min-width: 869px) {
    .sidebar-visible .wrap-two {
        display: flex;
        flex-direction: row;
        justify-content:space-between
    }

    .sidebar-visible .wrap-two .media-box:first-child {
        margin-right:16px
    }

    .sidebar-visible .wrap-two .media-box {
        width:50%
    }

    .sidebar-visible .wrap-two img {
        max-height:300px
    }
}


@media (max-width: 569px) {
    .sidebar-hidden .media-box {
        /* hack: mdbook doesnt support the full bleed layout we actually want, so just do something that looks decent. */
        // left: 50%;
        // margin-left: -50vw;
        // margin-right: -50vw;
        // max-width: 100vw;
        // position: relative;
        // right: 50%;
        // width:100vw
    }
}

@media (max-width: 869px) {
    .sidebar-visible .media-box {
        /* hack: mdbook doesnt support the full bleed layout we actually want, so just do something that looks decent. */
        // left: 50%;
        // margin-left: -50vw;
        // margin-right: -50vw;
        // max-width: 100vw;
        // position: relative;
        // right: 50%;
        // width:100vw
    }
}

blockquote {
    border-left: 4px solid #CCC;
    padding-left: 8px;
    margin-left: 8px
}

</style>
<p>You could be forgiven for not knowing much about the Broadmoor neighborhood in
Seattle  that's kind of by design. We're going to explore how it could
become a valuable link for people walking and biking in Seattle, using the
travel simulation game <a href="proposals/../software/abstreet.html">A/B Street</a>.</p>
<div class="media-box">
<img alt="a map of part of Seattle, highlighting the Broadmoor neighborhood, about 2.5 miles northeast of downtown." src="proposals/../assets/broadmoor/seattle-overview.png">
<p>Broadmoor lies a few miles northeast of Downtown Seattle, sandwiched between the
<a href="https://botanicgardens.uw.edu/washington-park-arboretum/">delightful Washington Park Arboretum</a>
and the Madison Park neighborhood.</p>
</div>
<p>Adjacent to Broadmoor, the Madison Park and Washington Park neighborhoods offer
grocery stores, a hardware store, dining, and recreational destinations.</p>
<div class="media-box">
<img src="proposals/../assets/broadmoor/madison-park-beach.jpg" alt="a beach full of swimmers, paddle boards, and sun bathers" />
<p>Madison Park Beach on Lake Washington is another notable neighborhood
destination.</p>
<p><em class="photo-attribution">photo courtesy of the City of Seattle</em></p>
</div>
<p>If you were headed to one of these destinations today, and coming from, say
Montlake or from the University District via the University bridge, it would
almost certainly require you to take a long stretch walking or biking down East
Madison Ave. This particular stretch of road is known to be
<a href="https://www.seattle.gov/transportation/projects-and-programs/safety-first/vision-zero/resources/bicycle-level-of-traffic-stress">high stress for people on bikes</a>,
and can be an equally harrowing walk for those on foot.</p>
<div class="wrap-two">
<div class="media-box">
<img
  src="../assets/broadmoor/proposal-overview.png"
  alt="a proposed route, cutting through the arboretum and Broadmoor neighborhood, as opposed to a longer route possible today" />
<p>If people were instead allowed to walk or ride through Broadmoor, they could
expect shorter trips on quieter streets.</p>
</div>
<div class="media-box">
<img
  class="chart"
  src="../assets/broadmoor/elevation-profiles.png"
  alt="two elevation profiles, showing a gentler climb through Broadmoor" />
<p>Looking at elevation, the green route along Madison Ave climbs an 8% grade
 quite steep! The blue route through Broadmoor offers a shorter, less
steep, route.<sup class="footnote-reference"><a href="#elevation data">1</a></sup></p>
</div>
</div>
<p>So why don't people take this seemingly superior route through Broadmoor?
Apologies if you already have the context, but a greatly abridged history lesson
is in order for those who don't.</p>
<p>Up until about 200 years ago, what we refer to as Broadmoor, like much land near
the Puget Sound, was a forest inhabited by the Duwamish people. And, like much
land near the Puget Sound, it was cut clear, and the timber sold off by a mill
company. The owners of this particular parcel were the Puget Mill Company. After
logging the parcel, they split it, not quite in half. The smaller western half
was given to the city, and gardened into what is now enjoyed by the public as
the Washington Park Arboretum. The General Manager from the very same Puget Mill
Company was then allowed to develop the larger eastern half of the parcel into
that venerable American trifecta: a golf course / country club / private gated
residential community.<sup class="footnote-reference"><a href="#madison_park_remembered">2</a></sup></p>
<p>So, Broadmoor was initially built as a gated enclave impassible to all but a
select few of the leisure class. A century later, how much has changed?</p>
<div class="wrap-two">
<div class="media-box">
<img src="proposals/../assets/broadmoor/dead-end.jpg" alt="a sidewalk ends and a road turns where a large hedge looms" />
<p>Try to walk through or around Broadmoor today, and you'll find yourself
repeatedly redirected or inexplicably dead-ended.</p>
</div>
<div class="media-box">
<img src="proposals/../assets/broadmoor/front-gate.jpg" alt="a car waiting for entry at a security gate" />
<p>There are gates on the north and south ends of Broadmoor. Both are guarded by
uniformed security.</p>
</div>
</div>
<p>Broadmoor is an obstacle to people walking and biking to desirable destinations
on either side of it. But what if things were different? What if we allowed
people on bikes, on foot, and in wheelchairs <em>through</em> Broadmoor rather than
diverting them down Madison Ave?</p>
<h3 id="cui-bono"><a class="header" href="#cui-bono">Cui bono</a></h3>
<p>To get an intuition for the benefits that opening up Broadmoor might have, we
turn to <a href="https://abstreet.org">A/B Street</a>. If you have an idea for a change in
your city streets, A/B Street can visualize that change and measure its impacts.</p>
<p>If you've never seen A/B Street before, here's what it looks like:</p>
<div class="media-box">
<img src="proposals/../assets/broadmoor/abstreet-overview.gif" alt="Screencast of the A/B
Street travel simulator, showing an overhead street map view, roughly centered
around the Washington Park Arboretum, with hundreds of dots sliding along the
streets. An adjustable playback speed is shown, panning and zooming in reveals
the moving dots are cartoon people and vehicles getting around the streets of
Seattle. Madison Ave looks busy.">
<p>A/B Street uses public data sources, like
<a href="https://openstreetmap.org">OpenStreetMap</a> and Seattle's
<a href="https://www.psrc.org/activity-based-travel-model-soundcast">Soundcast Travel Demand Model</a>
to simulate travel in the city. You can gain insight into your proposal by
comparing metrics like travel duration and risk exposure as they are affected by
your proposal.</p>
</div>
<p>In A/B Street, allowing people to walk and cycle through Broadmoor, is a matter
of clicks. Then, A/B Street simulates how this change affects people's travel.
You can watch as each individual person goes about their day. If given new
circumstances, people will be able to make new, hopefully better, choices for
themselves.</p>
<p>To gain a little intuition for the benefits of our proposal, let's follow one
person in A/B Street on her morning walk from Madison Park to the University
District, comparing the trip before and after being allowed to walk through
Broadmoor.</p>
<div class="media-box">
<!--
Encode the aspect ratio of the video in "padding-bottom" value. Otherwise it'll
show up letter boxed.
-->
<div class="video-container" style="padding-top: 56.25%" >
  <video controls alt="A person from the simulation exits their house in Madison park for a long walk towards the Montlake Bridge. Two routes are shown, the original route down Madison shows busy streets and several alerts as the pedestrian walks down a long stretch of Madison. The new proposed route, through Broadmoor is much calmer. The two routes converge just south of the Montlake Bridge, where the trip ends.">
    <source src="../assets/broadmoor/individual-trip-comparison.mp4" type="video/mp4">
    <source src="../assets/broadmoor/individual-trip-comparison.webm" type="video/webm">
    Sorry, your browser does not support this website's videos.
  </video>
</div>
<p>Some of the highlights of her trip include a much calmer walk through Broadmoor
as opposed to crossing along the many busy intersections on Madison Ave.</p>
</div>
<h3 id="beyond-anecdotes"><a class="header" href="#beyond-anecdotes">Beyond anecdotes</a></h3>
<p>The morning commute shown above is good for story telling. It's an intuitive
anecdote for why this could be a worthwhile proposal. However, travel behavior
is highly interdependent. Every choice one person makes has potential ripple
effects for others.</p>
<p>We need more than a handful of individual examples. A/B Street uses Seattle's
<a href="https://www.psrc.org/activity-based-travel-model-soundcast">Soundcast travel demand model</a>
to generate a realistic set of workday trips for the given area  for this
area, that's about 75,000 trips. A/B Street includes tools to analyze each of
these trips and aggregate overall travel experiences  allowing us to see
beyond anecdotes to visualize trends across the map. Let's take a look at how
overall trip times and some safety metrics are affected by this proposal.</p>
<h3 id="trip-durations"><a class="header" href="#trip-durations">Trip Durations</a></h3>
<div class="wrap-two">
<div class="media-box">
  <h4 class="chart-header">Cars: Individual Trips</h4>
  <img class="chart" src="proposals/../assets/broadmoor/broadmoor-driving-duration-scatter.png" />
<p>Comparing each driver's trip time before vs. after this change, some trips were
a little faster, while others a little slower.</p>
<p>There appears to be a small positive bias, perhaps due to less contention on
Madison, but overall it's mostly a wash for drivers, which is a boring, but
useful validation.</p>
</div>
<div class="media-box">
  <h4 class="chart-header">Walking and Biking: Individual Trips</h4>
  <img class="chart" src="proposals/../assets/broadmoor/broadmoor-ped-bike-duration-scatter.png" />
<p>It gets more interesting for people walking and cycling. Especially for longer
trips, people get where they're going more quickly after being allowed access
through Broadmoor, with few trips experiencing a slowdown.</p>
</div>
</div>
<p>Apart from the benefits conveyed to pedestrians and cyclists, these charts also
nicely show the interdependent nature of travel. For example, even though
overall travel time and the routes available to drivers didn't change much,
individual drivers did experience downstream effects of pedestrians and
bicyclists making different choices. This interdependence is fertile soil for
unintended consequences, which is why having tools to measure <em>overall</em> impact
is essential.</p>
<h3 class="chart-header">Time Saved / Lost</h3>
<p>The dot charts above are helpful for seeing the shape of some trends, but it's
hard to quantify the improvements. These next charts compare the total amount of
time saved across all trips with the total amount of time lost.</p>
<div class="wrap-two">
<div class="media-box">
  <h4 class="chart-header">Cars: Overall</h4>
  <img class="chart" src="proposals/../assets/broadmoor/broadmoor-driving-duration-histogram.png" />
<p>Here we can confirm the small bias for faster car trips, but not much more time
is gained than was lost by others, implying a mostly neutral change across all
people driving.</p>
</div>
<div class="media-box">
  <h4 class="chart-header">Walking and Biking: Overall</h3>
  <img class="chart" src="proposals/../assets/broadmoor/broadmoor-ped-bike-duration-histogram.png" />
<p>A clearer trend emerges for people walking and biking  many long trips
were substantially faster given access to Broadmoor.</p>
</div>
</div>
<p>Trip duration is worth considering as a gut check to make sure a proposal seems
reasonable, and this proposal indeed has some favorable evidence for faster
trips, but trip duration shouldn't be the only, or even most important, effect
to consider. In particular, there are important safety metrics we can measure
with A/B Street which we'll dive into next.</p>
<h2 id="safety"><a class="header" href="#safety">Safety</a></h2>
<p>All people should be able to get where they're going safely. As our most
vulnerable road users, people walking, bicycling, and those using mobility aids
deserve extra consideration.</p>
<p>There is an increasing effort to not only look at previous crash sites, but also
to consider the <em>types</em> of places where crashes are likely to occur. By
prioritizing places based on their similarity to crash sites, we can prevent or
mitigate future crash sites before someone is hurt. In this vein, last year
Seattle DOT released a
<a href="https://www.seattle.gov/documents/Departments/SDOT/VisionZero/SDOT_Bike%20and%20Ped%20Safety%20Analysis_Ph2_2420(0).pdf">safety study</a>
analyzing which physical roadway features that are associated with an increased
risk of traffic-related death or serious injury.</p>
<p>For example:</p>
<blockquote>
<p>Right hook crash risk tends to be higher on arterial streets. [...] This could
be due to the overall complexity of the intersection and/or the width of the
intersection.<sup class="footnote-reference"><a href="#sdot safety study">3</a></sup></p>
</blockquote>
<p>By classifying these risky features, A/B Street can keep tabs as people in the
simulation are exposed to these risks. You can follow an individual's trip and
see what risks they are exposed to, or, for a macro view, you can aggregate and
identify map-wide hot spots for specific problems. Using A/B Street, you can
compare how a proposal affects these metrics.</p>
<div class="wrap-two">
<div class="media-box">
<h4 class="chart-header">Identifying Hotspots</h4>
<img class="chart" 
  src="../assets/broadmoor/montlake-520-hotspot.png" 
  alt="a heatmap covering about a square mile of streets south of the Montlake
  Bridge, with hotspots on the intersections leading up to the bridge"/>
<p>A/B Street's &quot;problem&quot; view helps you identify risk exposure hotspots.</p>
<p>These streets south of the Montlake Bridge exhibit several risk factors,
including wide streets with fast moving vehicles and many-legged intersections.</p>
<p>Because the Montlake Bridge is one of only a couple plausible connections
between the University District and central Seattle, it has relatively high bike
and foot traffic.</p>
<p>The inherent riskiness of these <em>kinds</em> of streets, paired with the high
<em>number</em> of people using them, results in a risk exposure hotspot worth extra
scrutiny.</p>
</div>
<div class="media-box">
<h4 class="chart-header">Walking: Arterial Intersections</h4>
<img class="chart" 
  src="../assets/broadmoor/broadmoor-ped-arterial-crossings.png" 
  alt="2-D grid chart, bucketing trips by trip duration on the x-axis and
  number of arterial intersections crossed on the y-axis, showing a clear
  postive bias for hundreds of walking tris, especially for longer trips. Just
  a few trips were negatively affected."/>
<p>Walking across arterial (wide, busy) intersections presents an increased risk of
death or severe injury. This chart groups walking trips by duration and by how
many fewer (or more) arterial intersections were crossed.</p>
<p>More than 800 walking trips had fewer arterial intersections to cross when they
were allowed to pass through Broadmoor.</p>
<p>The chart shows that medium-to-long trips were most affected. For example, <em>518</em>
people walking <em>30-60</em> minutes had <em>1-6</em> fewer arterial (major) intersections to
cross.</p>
</div>
</div>
<div class="wrap-two">
<div class="media-box">
<h4 class="chart-header">Biking: Car Wants to Overtake</h4>
<img class="chart" 
  src="../assets/broadmoor/alerts-on-madison.gif" 
  alt="animated GIF showing an aerial map view of a simulated cyclist biking
  down the street. When a faster moving car pulls up behind them, a thought
  bubble with an alert symbol appears above the cyclist." />
<p>A 2018 study found that most cyclists who died in single-vehicle crashes were
struck by the front of the vehicle<sup class="footnote-reference"><a href="#fars_2018">4</a></sup>.</p>
<p>In shared lanes, a common risk that could lead to this type of collision is when
a faster moving car pulls up too close behind a cyclist. This is uncomfortable
for both the person on the bike and the person driving. Having the option to
ride through Broadmoor gives some cyclists the option to avoid sharing a lane
with cars on busy Madison.</p>
</div>
<div class="media-box">
<h4 class="chart-header">Biking: Complex Intersections</h4>
<img class="chart" src="proposals/../assets/broadmoor/broadmoor-bike-complex-crossings.png" />
<p>Simple intersections are where just two roads cross. Passing through a complex
intersection, where more than two roads cross, has an increased risk of death or
severe injury for people on bikes<sup class="footnote-reference"><a href="#sdot safety study">3</a></sup>. Being able to cycle
through Broadmoor was a strict improvement for this metric.</p>
</div>
</div>
<p>This was a quick overview of some of the tools A/B Street has for measuring
baseline safety metrics and seeing how your proposal affects them. We're
continuing to add metrics and visualizations, but we'd love to know if there are
any you'd specifically like to see.</p>
<h3 id="whats-next"><a class="header" href="#whats-next">What's next?</a></h3>
<p>Using a tool like <a href="https://www.abstreet.org">A/B Street</a> is absolutely not a
definitive evaluation. It's intended to get you started tinkering.</p>
<p>By identifying and measuring things we care about, and simulating how they
change, we can quickly gain some visual intuition and quantified evidence to
validate (or refute) assumptions in our proposal, and hopefully it's a little
fun too.</p>
<p>Here we've shown there is at least some evidence that letting people walk and
bike through the Broadmoor neighborhood in Seattle could result in faster,
safer, and more pleasant trips without unduly impacting other traffic.</p>
<!-- TODO: it'd be nice to link to something like `https://abstreet.org/web` or even http://abstreet.s3-website.us-east-2.amazonaws.com/latest/abstreet.html rather than a specific version -->
<p>If you'd like to see for yourself what the Broadmoor proposal looks like, give
it a try,
<a href="http://play.abstreet.org/0.2.58/abstreet.html?--dev&amp;system/us/seattle/scenarios/arboretum/weekday.bin&amp;--edits=broadmoor%20access">you can run A/B Street in your browser</a>
or <a href="proposals/../user/index.html">download the desktop client</a>.</p>
<p>Or, if you have a different idea for improving how we get around, in Seattle or
elsewhere, give it a go! Please contact us on
<a href="https://twitter.com/CarlinoDustin">twitter</a> or
<a href="https://github.com/a-b-street/abstreet/issues/new">github</a> if you have any
questions or issues.</p>
<h2 id="caveats"><a class="header" href="#caveats">Caveats</a></h2>
<p>It bears repeating: A map is not the territory. The signifier is not the
signified. A simulation is not, and can never be, the actual world.</p>
<p>But like a good map or a good metaphor, a good simulation can be a useful tool
for learning and advocacy. Beyond the shortcomings inherent to any such semiotic
excursion, there are a couple of limitations we wanted to call out in this case
study in particular.</p>
<h3 id="data-sources"><a class="header" href="#data-sources">Data sources</a></h3>
<p>The underlying road network is inferred from
<a href="https://www.openstreetmap.org/#map=14/47.6337/-122.2941">OpenStreetMap</a> (OSM),
a global community of mapping enthusiasts whose software and data is freely
available. Using OSM, A/B Street is already usable in cities all over the globe.
However, as a freely available community maintained project, OSM comes with no
data quality guarantees, and local mapping conventions can vary. Not everyone
using OSM is interested in the incredible level of detail required to run a
travel simulation. This situation is ever improving though, and we'd love to
have you give A/B Street a try, wherever you are.</p>
<p>A/B Street leverages Seattle's
<a href="https://www.psrc.org/activity-based-travel-model-soundcast">Soundcast travel demand model</a>
to generate the list of trips for each person in A/B Street. Specifically, for
each person, Soundcast is responsible for saying where they need to be and at
what time. Soundcast is also responsible for what mode the person takes -
whether they walk, drive, cycle, etc.</p>
<h3 id="modeshift"><a class="header" href="#modeshift">Modeshift</a></h3>
<p>Intuitively if you make driving more attractive, more people will drive.
Similarly if you make a mode like cycling, walking, or transit more attractive,
more people will choose that mode.</p>
<p>A/B Street doesn't currently account for this shifting of modes. It naively
assumes that people will go about their day, always choosing to drive or walk or
cycle regardless of what changes you make to the city. Mode shift is a real and
important behavior that we are excited to implement and measure in A/B Street in
the future.</p>
<p>There's tons of other improvements in the works. Follow
<a href="https://twitter.com/CarlinoDustin">@CarlinoDustin</a> for updates, and let us know
what you'd like to see.</p>
<h2 id="footnotes"><a class="header" href="#footnotes">Footnotes</a></h2>
<!-- prettier-ignore-start -->
<div class="footnote-definition" id="elevation data"><sup class="footnote-definition-label">1</sup>
<p>Elevation data from <a href="http://pugetsoundlidar.ess.washington.edu/lidardata/restricted/projects/2016king_county.html">King County LIDAR</a>. Thanks to <a href="https://github.com/eldang/elevation_lookups">Eldan Goldenberg</a> for processing this data.</p>
</div>
<div class="footnote-definition" id="madison_park_remembered"><sup class="footnote-definition-label">2</sup>
<p>Jane Powell Thomas, Madison Park Remembered (J.P. Thomas, 2004)</p>
</div>
<div class="footnote-definition" id="sdot safety study"><sup class="footnote-definition-label">3</sup>
<p>Seattle Department of Transportation's safety study:
<a href="https://www.seattle.gov/documents/Departments/SDOT/VisionZero/SDOT_Bike%20and%20Ped%20Safety%20Analysis_Ph2_2420(0).pdf">City of Seattle Bicycle and Pedestrian Safety Analysis Phase2</a></p>
</div>
<div class="footnote-definition" id="fars_2018"><sup class="footnote-definition-label">4</sup>
<p>NHTSA | National Highway Traffic Safety Administration - <a href="https://crashstats.nhtsa.dot.gov/Api/Public/ViewPublication/812884">2018 Traffic Safety Facts</a></p>
</div>
<!-- prettier-ignore-end-->
<div style="break-before: page; page-break-before: always;"></div><h1 id="lake-washington-blvd-stay-healthy-street"><a class="header" href="#lake-washington-blvd-stay-healthy-street">Lake Washington Blvd Stay Healthy Street</a></h1>
<p><em>Draft, updated May 7, 2020 by Dustin Carlino (<a href="mailto:proposals/dabreegster@gmail.com">dabreegster@gmail.com</a>)</em></p>
<p>In April 2020, Seattle Department of Transportation started rolling out
<a href="https://sdotblog.seattle.gov/2020/04/16/announcing-stay-healthy-streets/">Stay Healthy Streets</a>,
restricting roads to through-traffic to give people walking and biking more
space for social distancing.
<a href="http://seattlegreenways.org/socialdistancingstreets/">Seattle Neighborhood Greenways</a>
soon proposed extending this to a
<a href="https://drive.google.com/open?id=1HQMnagRf8EbS1nouqCMLl4LZr0QE8VrC&amp;usp=sharing">130-mile network</a>.</p>
<p>Selecting the streets requires some planning:</p>
<blockquote>
<p>These streets were selected to amplify outdoor exercise opportunities for
areas with limited open space options, low car ownership and routes connecting
people to essential services and food take out. We also ensured street
closures did not impact newly opened food pick up loading zones, parking
around hospitals for service for health care professionals, and bus routes.</p>
</blockquote>
<p>I've spent the last two years building <a href="https://abstreet.org">A/B Street</a>,
software to explore the impacts of changes like this on different modes of
transportation. So, let's try implementing part of the proposed network and see
what happens!</p>
<h2 id="lake-washington-blvd"><a class="header" href="#lake-washington-blvd">Lake Washington Blvd</a></h2>
<p>Let's start with one part of the proposal, closing Lake Washington Blvd to cars
through the Arboretum. There's already a multi-use trail alongside this stretch,
but its width makes it difficult to maintain 6 feet from people. There are some
parking lots that become inaccessible with this proposal, but they're currently
closed anyway.</p>
<p><img src="proposals/edits.gif" alt="edits" /></p>
<h3 id="first-attempt"><a class="header" href="#first-attempt">First attempt</a></h3>
<iframe width="560" height="315" src="https://www.youtube.com/embed/PU0iT-_3-es" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
<p>Let's get started! If you want to follow along,
<a href="proposals/../user/index.html">install A/B Street</a>, open sandbox mode, and switch the map to
Lake Washington corridor. Zoom in on the southern tip of the Arboretum and hop
into edit mode. We can see Lake Washington Blvd just has one travel lane in each
direction here. Click each lane, convert it to a bike lane, and repeat north
until Foster Island Road.</p>
<p>When we leave edit mode, the traffic simulation resets to midnight. Nothing
really interesting happens until 5 or 6am, so we'll speed up time. Watching the
section of road we edited, we'll only see pedestrians and bikes use this stretch
of road. If we want, we can click an individual person and follow along their
journey.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/LSCHeDi5484" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
<p>Something's weird though. There's lots of traffic cutting northbound through the
neighborhood, along 29th, Ward, and 28th. We can open up the throughput layer to
find which roads have the most traffic. More usefully, we can select &quot;compare
before edits&quot; to see what roads are getting more or less traffic because of the
road we modified. As expected, there's much less traffic along Lake Wash Blvd,
but it's also clear that lots of cars are now cutting through 26th Ave E.</p>
<h3 id="traffic-calming"><a class="header" href="#traffic-calming">Traffic calming</a></h3>
<iframe width="560" height="315" src="https://www.youtube.com/embed/qAf5IAMbpcU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
<p>Let's say you want to nudge traffic to use 23rd Ave, the nearest north/south
arterial, instead. (A/B Street is an unopinionated tool; if you have a different
goal in mind, try using it for that instead.) In this simulation, drivers pick
the fastest route, so we could try lowering speed limits or make some of the
residential streets connecting to Madison one-way, discouraging through-traffic.
In reality, the speed limit changes could be implemented through
<a href="https://streetsillustrated.seattle.gov/design-standards/trafficcalming/">traffic calming</a>
or cheap, temporary alternatives.</p>
<h2 id="next-steps-3"><a class="header" href="#next-steps-3">Next steps</a></h2>
<p>I'm working to model &quot;local access only&quot; roads in A/B Street, and I'll describe
how to measure the impact on travel times. Stay tuned to see more of the
<a href="https://drive.google.com/open?id=1HQMnagRf8EbS1nouqCMLl4LZr0QE8VrC&amp;usp=sharing">proposed network</a>
simulated, and get in touch if you'd like to help out!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="technical-details-1"><a class="header" href="#technical-details-1">Technical details</a></h1>
<p>This section of the site is intended for anybody who wants to understand or work
on A/B Street's internals.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="developer-guide"><a class="header" href="#developer-guide">Developer guide</a></h1>
<p>This guide is meant for people who want to work on A/B Street's code. In most
cases as a user, even for importing new cities, you shouldn't need to bother
with any of this.</p>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting started</a></h2>
<p>You will first need:</p>
<ul>
<li>Stable Rust, at least 1.60. <a href="https://www.rust-lang.org/tools/install">https://www.rust-lang.org/tools/install</a>.
<ul>
<li>On Windows, you may need
<a href="https://visualstudio.microsoft.com/en/downloads/">Visual Studio 2019</a>.</li>
</ul>
</li>
<li>On Linux,
<code>sudo apt-get install libasound2-dev libxcb-shape0-dev libxcb-xfixes0-dev libpango1.0-dev libgtk-3-dev</code>
or the equivalent for your distro</li>
</ul>
<p>One-time setup:</p>
<ol>
<li>
<p>Download the repository:
<code>git clone https://github.com/a-b-street/abstreet.git</code></p>
</li>
<li>
<p>Grab the minimal amount of data to get started:
<code>cargo run --bin updater -- download --minimal</code></p>
</li>
<li>
<p>Run the game: <code>RUST_BACKTRACE=1 cargo run --bin game --release</code>. On Windows,
set environment variables like this:
<code>set RUST_BACKTRACE=1 &amp;&amp; cargo run --bin game --release</code></p>
</li>
</ol>
<h2 id="development-tips"><a class="header" href="#development-tips">Development tips</a></h2>
<ul>
<li><a href="https://a-b-street.github.io/abstreet/rustdoc/map_model/index.html">Generated API documentation</a></li>
<li>Compile faster by just doing <code>cargo run</code>. The executable will have debug stack
traces and run more slowly. You can do <code>cargo run --release</code> to build in
optimized release mode; compilation will be slower, but the executable much
faster.</li>
<li>Some in-game features are turned off by default or don't have a normal menu to
access them. The list:
<ul>
<li>To toggle developer mode: press <strong>Control+S</strong> in game, or
<code>cargo run -- --dev</code></li>
<li>To warp to an object by numeric ID: press <strong>Control+j</strong></li>
<li>To enter debug mode with all sorts of goodies: press <strong>Control+D</strong></li>
</ul>
</li>
<li>You can start the game in different modes using flags:
<ul>
<li><code>cargo run --bin game -- --dev data/system/us/seattle/maps/downtown.bin</code>
starts on a particular map</li>
<li><code>cargo run --bin game -- data/system/us/seattle/scenarios/downtown/weekday.bin</code>
starts with a scenario (which is tied to a certain map)</li>
<li><code>cargo run --bin game -- --challenge=trafficsig/tut2</code> starts on a particular
challenge. See the list of aliases by passing in a bad value here.</li>
<li><code>cargo run --bin game -- data/player/saves/us/seattle/montlake/no_edits_unnamed/00h00m20.3s.bin</code>
restores an exact simulation state. Savestates are found in debug mode
(<strong>Control+D</strong>) -- they're probably confusing for the normal player
experience, so they're hidden for now.</li>
<li><code>cargo run --bin game -- --tutorial=12</code> starts somewhere in the tutorial</li>
<li>Adding <code>--edits='name of edits'</code> starts with edits applied to the map.</li>
</ul>
</li>
</ul>
<h2 id="downloading-more-cities"><a class="header" href="#downloading-more-cities">Downloading more cities</a></h2>
<p>Most easily, you can download new cities using the GUI directly.</p>
<p>As data formats change over time, things in the <code>data/</code> directory not under
version control will get out of date. At any time, you can run
<code>cargo run --bin updater -- download</code> from the main repository directory to
update only the files that have changed.</p>
<p>You can also opt into downloading updates for more cities from the command line
by editing <code>data/player/data.json</code>. If you want to add data for Leeds, GB, for
example, you could edit that file so that it contains the following:</p>
<pre><code class="language-json">{
  &quot;runtime&quot;: [&quot;gb/leeds&quot;, &quot;us/seattle&quot;],
  &quot;input&quot;: [&quot;gb/leeds&quot;, &quot;us/seattle&quot;]
}
</code></pre>
<p>If you want to opt into absolutely everything:
<code>cargo run --bin updater -- opt-into-all &gt; data/player/data.json</code></p>
<h2 id="building-map-data"><a class="header" href="#building-map-data">Building map data</a></h2>
<p>You can skip this section if you're just touching code in <code>game</code>, <code>widgetry</code>,
and <code>sim</code>. If you're just trying to import a new city, follow
<a href="tech/dev/../../user/new_city.html">the user guide</a>. This section is relevant if you're
working on the code that imports maps and scenarios.</p>
<h3 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h3>
<p>To run all pieces of the importer, you'll need some extra dependencies:</p>
<ul>
<li><code>osmconvert</code>: See <a href="https://wiki.openstreetmap.org/wiki/Osmconvert#Download">https://wiki.openstreetmap.org/wiki/Osmconvert#Download</a> or
<a href="https://github.com/interline-io/homebrew-planetutils#installation">https://github.com/interline-io/homebrew-planetutils#installation</a> for Mac</li>
<li><code>libgdal-dev</code>: See <a href="https://gdal.org">https://gdal.org</a> if your OS package manager doesn't have
this. If you keep hitting linking errors, then just remove
<code>--features importer/scenarios</code> from <code>import.sh</code>. You won't be able to build
the Seattle scenarios.</li>
<li>Standard Unix utilities: <code>unzip</code> and <code>gunzip</code></li>
<li>If you have Docker installed, you'll notice the <code>--raw</code> stage will run a
container for <a href="https://github.com/eldang/elevation_lookups">https://github.com/eldang/elevation_lookups</a>. If you're missing
Docker, elevation data should just be skipped.</li>
</ul>
<h3 id="the-importer-pipeline"><a class="header" href="#the-importer-pipeline">The importer pipeline</a></h3>
<p>The import process is split into two main steps. When you run the importer, you
specify what work you want to do, so understanding these steps is important.
First is the <code>--raw</code> step, which:</p>
<ol>
<li>Downloads all input data needed for a map -- a .osm.pbf file from Geofabrik,
at minimum</li>
<li>Uses <code>osmconvert</code> to clip the large OSM file into smaller pieces</li>
<li>Reads in all of the input, producing a <code>RawMap</code> file. This is an
intermediate format that's useful for debugging, using the <code>map_editor</code>
tool.</li>
</ol>
<p>If you look in <code>data/input/us/nyc/</code> (substituting the country and city, of
course), you'll see <code>osm</code> and <code>raw_maps</code> directories. In places like
<code>data/input/us/seattle/</code>, there are many other input files.</p>
<p>The second step, <code>--map</code>, transforms the <code>RawMap</code> to the final <code>Map</code> file used
by all of the applications. These files live in <code>data/system/us/nyc/maps</code>.</p>
<h3 id="running-the-importer"><a class="header" href="#running-the-importer">Running the importer</a></h3>
<p>The importer tool has many CLI flags not described here; <code>--help</code> is the best
reference. But we can start with a few common examples.</p>
<p>After creating configuration files for a city, you can import it, running both
the <code>--raw</code> and <code>--map</code> steps:</p>
<p><code>./import.sh --raw --map --city=br/sao_paulo</code></p>
<p>If your city is split into many maps, you can operate on just one of them (the
<code>west</code> boundary):</p>
<p><code>./import.sh --raw --map --city=fr/paris west</code></p>
<p>If you want to regenerate a map with the latest OSM data, you need to first
delete the OSM input files cached locally. Then running with <code>--raw</code> will
download them again. Note the OSM files are downloaded from Geofabrik, so they
may be up to one day out-of-date. You can additionally use <code>osmupdate</code> if
needed.</p>
<pre><code>rm -rfv data/input/fr/paris/osm/
./import.sh --raw --map --city=fr/paris
</code></pre>
<p>Some more tips for running specific stages of the importer:</p>
<ul>
<li>If you're modifying the initial OSM data -&gt; RawMap conversion in
<code>convert_osm</code>, you need <code>./import.sh --raw --map</code>.</li>
<li>If you're modifying <code>map_model</code> but not the OSM -&gt; RawMap conversion, then you
just need <code>./import.sh --map</code>.</li>
<li>If you're modifying the demand model for Seattle, you can add <code>--scenario</code> to
regenerate.</li>
<li>By default, all maps are regenerated. You can also specify a single map:
<code>./import.sh --map downtown</code>.</li>
<li>By default, Seattle is assumed as the city. You have to specify otherwise:
<code>./import.sh --city=us/detroit --map downtown</code>.</li>
</ul>
<p>Building contraction hierarchies for pathfinding occurs in the <code>--map</code> stage. It
can take a few minutes for larger maps. To view occasional progress updates, you
can run the importer with</p>
<pre><code>RUST_LOG=&quot;fast_paths=debug/contracted node [0-9]+0000 &quot;
</code></pre>
<p>You can also make the importer <a href="tech/dev/../../user/new_city.html">import a new city</a>.</p>
<h2 id="understanding-stuff"><a class="header" href="#understanding-stuff">Understanding stuff</a></h2>
<p>The docs listed at <a href="https://github.com/a-b-street/abstreet#documentation">https://github.com/a-b-street/abstreet#documentation</a>
explain things like map importing and how the traffic simulation works.</p>
<h3 id="code-organization"><a class="header" href="#code-organization">Code organization</a></h3>
<p>If you're going to dig into the code, it helps to know what all the crates are.
The most interesting crates are <code>map_model</code>, <code>sim</code>, and <code>game</code>.</p>
<p>Constructing the map:</p>
<ul>
<li><code>convert_osm</code>: extract useful data from OpenStreetMap and other data sources,
emit intermediate map format</li>
<li><code>kml</code>: extract shapes from KML and CSV shapefiles</li>
<li><code>map_model</code>: the final representation of the map, also conversion from the
intermediate map format into the final format</li>
<li><code>map_editor</code>: GUI for modifying geometry of maps and creating maps from
scratch. pretty abandoned as of June 2020</li>
<li><code>importer</code>: the entire import pipeline</li>
<li><code>cli</code>: a collection of command-line tools to manage importing</li>
<li><code>updater</code>: tool to download/upload large files used in the import pipeline</li>
</ul>
<p>Traffic simulation:</p>
<ul>
<li><code>sim</code>: all of the agent-based simulation logic</li>
<li><code>headless</code>: tool to run a simulation without any visualization</li>
</ul>
<p>Graphics:</p>
<ul>
<li><code>game</code>: the GUI and main gameplay</li>
<li><code>map_gui</code>: common code to interact with <code>map_model</code> maps</li>
<li><code>widgetry</code>: a GUI and 2D OpenGL rendering library, using glium + winit +
glutin</li>
</ul>
<p>Common utilities:</p>
<ul>
<li><code>abstutil</code>: a grab-bag timing and logging utilities</li>
<li><code>abstio</code>: Reading/writing files on native/web</li>
<li><code>geom</code>: types for GPS and map-space points, lines, angles, polylines,
polygons, circles, durations, speeds</li>
</ul>
<p>Other:</p>
<ul>
<li><code>collisions</code>: an experimental data format for real-world collision data</li>
<li><code>traffic_seitan</code>: a bug-finding tool that randomly generates live map edits</li>
<li><code>tests</code>: integration tests</li>
<li><code>santa</code>: 15-minute Santa, an arcade game about delivering and zoning</li>
<li><code>parking_mapper</code>: a standalone tool to help map street parking in OSM</li>
<li><code>osm_viewer</code>: a standalone tool to render OSM in detail</li>
<li><code>fifteen_min</code>: a standalone tool to explore 15-minute neighborhoods</li>
<li><code>popdat</code>: use census data to produce traffic simulation input</li>
<li><code>traffic_signal_data</code>: manual timing overrides for some traffic signals</li>
<li><code>piggyback</code>: a small WebAssembly API to layer parts of A/B Street on top of
Mapbox or other web maps</li>
</ul>
<h2 id="code-conventions"><a class="header" href="#code-conventions">Code conventions</a></h2>
<p>All code is automatically formatted using
<a href="https://github.com/rust-lang/rustfmt">https://github.com/rust-lang/rustfmt</a>; please run <code>cargo fmt</code> before sending a
PR.</p>
<p>cargo fmt can't yet organize imports, but we follow a convention to minimize
conflict with what some IDEs do. Follow existing code to group imports: std,
external crates, other crates in the project, the current crate, then finally
any module declarations.</p>
<p>We also use <a href="https://github.com/rust-lang/rust-clippy">https://github.com/rust-lang/rust-clippy</a> to adhere to more Rust
best practices. No need to run it for every commit, and sometimes we'll disable
a warning. If in doubt, just ask on a PR.</p>
<p>See the <a href="tech/dev/testing.html">testing strategy</a> page.</p>
<h2 id="error-handling"><a class="header" href="#error-handling">Error handling</a></h2>
<p>The error handling is unfortunately inconsistent. The goal is to gracefully
degrade instead of crashing the game. If a crash does happen, make sure the logs
will have enough context to reproduce and debug. For example, giving up when
some geometry problem happens isn't ideal, but at least make sure to print the
road / agent IDs or whatever will help find the problem. It's fine to crash
during map importing, since the player won't deal with this, and loudly stopping
problems is useful. It's also fine to crash when initially constructing all of
the renderable map objects, because this crash will consistently happen at
startup-time and be noticed by somebody developing before a player gets to it.</p>
<p>Since almost none of the code ever needs to distinguish error cases, use
<a href="https://crates.io/crates/anyhow">anyhow</a>. Most of the errors generated within
A/B Street are just strings anyway; the <code>bail!</code> macro is a convenient way to
return them.</p>
<h2 id="logging"><a class="header" href="#logging">Logging</a></h2>
<p>Prefer using <code>info!</code>, <code>warn!</code>, <code>error!</code>, etc from the <code>log</code> crate rather than
<code>println</code>.</p>
<p>Adjust the log level without recompiling via the <code>RUST_LOG</code> env variable.</p>
<pre><code>RUST_LOG=debug cargo run --bin game
</code></pre>
<p>This can be done on a per lib basis:</p>
<pre><code>RUST_LOG=my_lib=debug cargo run --bin game
</code></pre>
<p>Or a module-by-module basis:</p>
<pre><code>RUST_LOG=my_lib::module=debug cargo run --bin game
</code></pre>
<p>You can mix and match:</p>
<pre><code># error logging by default, except the foo:bar module at debug level
# and the entire baz crate at info level
RUST_LOG=error,foo::bar=debug,baz=info cargo run --bin game
</code></pre>
<p>For some special cases, you might want to use regex matching by specifying a
pattern with the &quot;/&quot;:</p>
<pre><code># only log once every 10k
RUST_LOG=&quot;fast_paths=debug/contracted node [0-9]+0000 &quot; mike import_la
</code></pre>
<p>See the <a href="https://docs.rs/env_logger/0.8.2/env_logger/">env_logger documentation</a>
for more usage examples.</p>
<h2 id="profiling"><a class="header" href="#profiling">Profiling</a></h2>
<p>Use <a href="https://github.com/flamegraph-rs/flamegraph">https://github.com/flamegraph-rs/flamegraph</a>, just running it on the
binaries you build normally.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="development-notes"><a class="header" href="#development-notes">Development notes</a></h1>
<p>Find packages to upgrade: <code>cargo outdated -R</code></p>
<p>Deal with compile tile: <code>cargo bloat --time</code></p>
<p>Find why two binary crates aren't sharing dependencies:
<a href="https://old.reddit.com/r/rust/comments/cqceu4/common_crates_in_cargo_workspace_recompiled/">https://old.reddit.com/r/rust/comments/cqceu4/common_crates_in_cargo_workspace_recompiled/</a></p>
<p>Where's a dependency coming from? <code>cargo tree -i -p syn</code></p>
<p>Diff screencaps: <a href="http://www.imagemagick.org/Usage/compare/#methods">http://www.imagemagick.org/Usage/compare/#methods</a></p>
<p>Debug OpenGL calls:</p>
<pre><code>apitrace trace --api gl ../target/debug/game
qapitrace game.trace
apitrace dump game.trace
</code></pre>
<p>Understand XML: just use firefox</p>
<h2 id="markdown"><a class="header" href="#markdown">Markdown</a></h2>
<p>For formatting:</p>
<pre><code>sudo apt-get install npm
cd ~; mkdir npm; cd npm
npm init --yes
npm install prettier --save-dev --save-exact
</code></pre>
<h2 id="videos"><a class="header" href="#videos">Videos</a></h2>
<pre><code># Fullscreen
ffmpeg -f x11grab -r 25 -s 1920x960 -i :0.0+0,55 -vcodec huffyuv raw.avi

ffmpeg -ss 10.0 -t 5.0 -i raw.avi -f gif -filter_complex &quot;[0:v] fps=12,scale=1024:-1,split [a][b];[a] palettegen [p];[b][p] paletteuse&quot; screencast.gif
</code></pre>
<h2 id="faster-linking"><a class="header" href="#faster-linking">Faster linking</a></h2>
<pre><code>sudo apt-get install lld
</code></pre>
<p>Stick this in ~/.cargo/config:</p>
<pre><code>[target.x86_64-unknown-linux-gnu]
rustflags = [
    &quot;-C&quot;, &quot;link-arg=-fuse-ld=lld&quot;,
]
</code></pre>
<p>Also enable incremental builds in release mode. In <code>~/.cargo/config</code>:</p>
<pre><code>[build]
incremental = true
</code></pre>
<p>I'm not sure about setting this in the repo's Cargo.toml, because we may not
want incremental builds on Github Actions for building the release? Not sure
what best practice is.</p>
<h2 id="git"><a class="header" href="#git">git</a></h2>
<p>Keep a fork up to date:</p>
<pre><code># Once
git remote add upstream https://github.com/rust-windowing/glutin/

git fetch upstream
git merge upstream/master
git diff upstream/master
</code></pre>
<h2 id="refactoring"><a class="header" href="#refactoring">Refactoring</a></h2>
<pre><code>perl -pi -e 's/WrappedComposite::text_button\(ctx, (.+?), (.+?)\)/Btn::text_fg(\1).build_def\(ctx, \2\)/' `find|grep rs|xargs`
</code></pre>
<h2 id="stack-overflow"><a class="header" href="#stack-overflow">Stack overflow</a></h2>
<p>rust-gdb --args ../target/release/game --dev</p>
<h2 id="drawing-diagrams"><a class="header" href="#drawing-diagrams">Drawing diagrams</a></h2>
<p>draw.io</p>
<h2 id="mapping"><a class="header" href="#mapping">Mapping</a></h2>
<p>xodo on Android for annotating maps in the field</p>
<h2 id="osm-tools"><a class="header" href="#osm-tools">OSM tools</a></h2>
<p>osmcha.org for recent changes</p>
<p>To upload diffs:</p>
<pre><code>java -jar ~/Downloads/josm-tested.jar ~/abstreet/map_editor/diff.osc
</code></pre>
<p>JOSM: Press (and release T), then click to pan. Download a relevant layer,
select the .osc, merge, then upload.</p>
<h2 id="fonts"><a class="header" href="#fonts">Fonts</a></h2>
<p>fontdrop.info</p>
<h2 id="release-checklist"><a class="header" href="#release-checklist">Release checklist</a></h2>
<p>What things are sensitive to changes in map data and simulation rules?</p>
<ul>
<li>tutorial</li>
<li>optimize commute challenges</li>
</ul>
<p>What things do I always forget to test?</p>
<ul>
<li>DPI issues, use <code>--scale_factor</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="api"><a class="header" href="#api">API</a></h1>
<p>Suppose you're tired of manually fiddling with traffic signals, and you want to
use machine learning to do it. You can run A/B Street without graphics and
automatically control it through an API.</p>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<p>This
<a href="https://github.com/a-b-street/abstreet/blob/master/headless/examples/python_client.py">Python example</a>
has everything you need to get started.</p>
<p>See
<a href="https://github.com/a-b-street/abstreet/tree/master/headless/examples">all example code</a>
-- there are different experiments in Go and Python that automate running a
simulation, measuring some metric, and making a change to improve the metric.</p>
<h2 id="control-flow"><a class="header" href="#control-flow">Control flow</a></h2>
<p>The <code>headless</code> API server that you run contains a single map and simulation at a
time. Even though you can theoretically have multiple clients make requests to
it simultaneously, the server will only execute one at a time. If you're trying
to do something other than use one script to make API calls in sequence, please
get in touch, so we can figure out something better suited to your use case.</p>
<p>When you start the <code>headless</code> server, it always loads the <code>montlake</code> map with
the <code>weekday</code> scenario. The only way you can change this is by calling
<code>/sim/load</code>. For example:</p>
<pre><code>curl http://localhost:1234/sim/load -d '{ &quot;scenario&quot;: &quot;data/system/us/seattle/scenarios/downtown/monday.bin&quot;, &quot;modifiers&quot;: [], &quot;edits&quot;: null }' -X POST`
</code></pre>
<p>You can also pass flags like <code>--infinite_parking</code> to the server to control
<a href="https://a-b-street.github.io/abstreet/rustdoc/sim/struct.SimOptions.html">SimOptions</a>.
These settings will apply for the entire lifetime of the server; you can't
change them later.</p>
<h2 id="api-details"><a class="header" href="#api-details">API details</a></h2>
<blockquote>
<p><strong>Under construction</strong>: The API will keep changing. There are no backwards
compatibility guarantees yet. Please make sure I know about your project, so I
don't break your client code.</p>
</blockquote>
<p>For now, the API is JSON over HTTP. The exact format is unspecified, error codes
are missing, etc. A summary of the commands available so far:</p>
<ul>
<li><strong>/sim</strong>
<ul>
<li><strong>GET /sim/reset</strong>: Reset all temporary map edits and the simulation state.
The trips that will run don't change; they're determined by the scenario
specified by the last call to <code>/sim/load</code>. If you made live map edits using
things like <code>/traffic-signals/set</code>, they'll be reset to the <code>edits</code> from
<code>/sim/load</code>.</li>
<li><strong>POST /sim/load</strong>: Switch the scenario being simulated, and also optionally
sets the map edits.</li>
<li><strong>GET /sim/load-blank?map=data/system/gb/london/maps/southwark.bin</strong>: Switch
to a different map, loading a blank simulation.</li>
<li><strong>GET /sim/get-time</strong>: Returns the current simulation time.</li>
<li><strong>GET /sim/goto-time?t=06:30:00</strong>: Simulate until 6:30 AM. If the time you
specify is before the current time, you have to call <strong>/sim/reset</strong> first.</li>
<li><strong>POST /sim/new-person</strong>: The POST body must be an
<a href="https://a-b-street.github.io/abstreet/rustdoc/sim/struct.ExternalPerson.html">ExternalPerson</a>
in JSON format.</li>
</ul>
</li>
<li><strong>/traffic-signals</strong>
<ul>
<li><strong>GET /traffic-signals/get?id=42</strong>: Returns the traffic signal of
intersection #42 in JSON.</li>
<li><strong>POST /traffic-signals/set</strong>: The POST body must be a
<a href="https://a-b-street.github.io/abstreet/rustdoc/map_model/struct.ControlTrafficSignal.html">ControlTrafficSignal</a>
in JSON format.</li>
<li><strong>GET /traffic-signals/get-delays?id=42&amp;t1=03:00:00&amp;t2=03:30:00</strong>: Returns
the delay experienced by every agent passing through intersection #42 from
3am to 3:30, grouped by direction of travel.</li>
<li><strong>GET /traffic-signals/get-cumulative-thruput?id=42</strong>: Returns the number of
agents passing through intersection #42 since midnight, grouped by direction
of travel.</li>
<li><strong>GET /traffic-signals/get-all-current-state</strong>: Returns the current state of
all traffic signals, including the stage timing, waiting, and accepted
agents.</li>
</ul>
</li>
<li><strong>/data</strong>
<ul>
<li><strong>GET /data/get-finished-trips</strong>: Returns a JSON list of all finished trips.
Each tuple is (time the trip finished in seconds after midnight, trip ID,
mode, duration of trip in seconds). The mode is a string like &quot;Walk&quot; or
&quot;Drive&quot;. If the trip was cancelled for any reason, duration will be null.</li>
<li><strong>GET /data/get-agent-positions</strong>: Returns a JSON list of all active agents.
Vehicle type (or pedestrian), person ID, and position is included.</li>
<li><strong>GET /data/get-road-thruput</strong>: Returns a JSON list of (road, agent type,
hour since midnight, throughput for that one hour period).</li>
<li><strong>GET /data/get-blocked-by-graph</strong>: Returns a mapping from agent IDs to how
long they've been waiting and why they're blocked.</li>
<li><strong>GET /data/trip-time-lower-bound?id=123</strong>: Returns a reasonable lower bound
for the total duration of trip 123, in seconds. The time is calculated
assuming no delay at intersections, travelling full speed along every road,
and using the primary mode for the entire trip (so just driving).</li>
<li><strong>GET /data/all-trip-time-lower-bounds</strong>: The faster equivalent of calling
<code>/data/trip-time-lower-bound</code> for every trip in the simulation.</li>
</ul>
</li>
<li><strong>/map</strong>
<ul>
<li><strong>GET /map/get-edits</strong>: Returns the current map edits in JSON. You can save
this to a file in <code>data/player/edits/city_name/map_name/</code> and later use it
in-game normally. You can also later run the <code>headless</code> server with
<code>--edits=name_of_edits</code>.</li>
<li><strong>GET /map/get-edit-road-command?id=123</strong>: Returns an object that can be
modified and then added to map edits.</li>
<li><strong>GET /map/get-intersection-geometry?id=123</strong>: Returns a GeoJSON object with
one feature for the intersection and a feature for all connecting roads. The
polygon coordinates are measured in meters, with the origin centered at the
intersection's center.</li>
<li><strong>GET /map/get-all-geometry</strong>: Returns a huge GeoJSON object with one
feature per road and intersection in the map. The coordinate space is WGS84.</li>
<li><strong>GET /map/get-nearest-road?lat=1.23&amp;lon=4.56&amp;threshold_meters=100</strong>: Snaps
a point to the nearest road center line, and returns the RoadID.</li>
</ul>
</li>
</ul>
<h2 id="working-with-the-map-model"><a class="header" href="#working-with-the-map-model">Working with the map model</a></h2>
<p>If you need to deeply inspect the map, you can dump it to JSON:</p>
<pre><code>cargo run --release --bin cli -- dump-json data/system/us/seattle/maps/montlake.bin &gt; montlake.json
</code></pre>
<p>See some example code that
<a href="https://github.com/a-b-street/abstreet/blob/master/headless/examples/generate_traffic.py">reads this JSON and finds buildings</a>.</p>
<p>You could also edit the map JSON, convert it back to binary, and use it in the
simulation. This isn't recommended generally, but one possible use case could be
tuning the amount of offstreet parking per building. The map JSON has a list
called <code>buildings</code>, and each object there has a field <code>parking</code>. You coud set
this object to <code>{ &quot;Private&quot;: [100, false] }</code> to indicate 100 parking spots, for
a building not explicitly designated in OpenStreetMap as a garage. After editing
the JSON, you have to convert it back to the binary format:</p>
<pre><code>cargo run --release --bin cli -- import-json-map --input=montlake.json --output=data/system/us/seattle/maps/montlake_modified.bin`
</code></pre>
<p>The format of the map isn't well-documented yet. See the
<a href="https://a-b-street.github.io/abstreet/rustdoc/map_model/index.html">generated API docs</a>
and <a href="tech/dev/../map/index.html">the map model docs</a> in the meantime.</p>
<h2 id="working-with-individual-trips"><a class="header" href="#working-with-individual-trips">Working with individual trips</a></h2>
<p>You can use the <strong>/sim/new-person</strong> API in the middle of a simulation, if
needed. If possible, it's simpler to create a Scenario as input.</p>
<h2 id="working-with-scenarios"><a class="header" href="#working-with-scenarios">Working with Scenarios</a></h2>
<p>You can
<a href="tech/dev/../trafficsim/travel_demand.html#custom-import">import trips from your own data</a>.</p>
<p>You can also generate different variations of one of the
<a href="tech/dev/../trafficsim/travel_demand.html#proletariat-robot">demand models</a> by specifying
an RNG seed:</p>
<pre><code>cargo run --release --bin cli -- random-scenario --rng=123 --map=data/system/us/seattle/maps/montlake.bin --scenario_name=home_to_work
</code></pre>
<p>You can also dump Scenarios (the file that defines all of the people and trips)
to JSON:</p>
<pre><code>cargo run --release --bin cli -- dump-json data/system/us/seattle/scenarios/montlake/weekday.bin &gt; montlake_weekday.json
</code></pre>
<p>You can modify the JSON, then put the file back in the appropriate directory and
use it in-game:</p>
<pre><code>cargo run --bin game -- --dev data/system/us/seattle/scenarios/montlake/modified_scenario.json
</code></pre>
<p>The Scenario format is <a href="tech/dev/formats/scenarios.html">documented here</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="testing-strategy"><a class="header" href="#testing-strategy">Testing strategy</a></h1>
<h2 id="unit-tests"><a class="header" href="#unit-tests">Unit tests</a></h2>
<p>As you've probably noticed, there aren't many. Lots of the interesting behavior
in A/B Street - UI interactions, details of the simulation, map importing --
would take lots of infrastructure to specify a setup and expected outcomes. If
you have ideas for new tests, contributions always welcome! In the meantime, one
useful test covers how
<a href="https://github.com/a-b-street/abstreet/blob/master/map_model/src/make/initial/lane_specs.rs">OSM tags translate into individual lanes</a>.</p>
<h2 id="screenshot-diffs"><a class="header" href="#screenshot-diffs">Screenshot diffs</a></h2>
<p>Downloading fresh OSM data or modifying any part of the map importing pipeline
could easily break things. Expressing invariants about the map output is hard,
because importing is far from perfect, and OSM data is often quite buggy. So the
approach to preventing regressions here is to look for visual changes to the
final rendered map.</p>
<ol>
<li>When a new map is opted into this type of test, somebody manually squints
carefully at it and sanity checks that it works to some degree.</li>
<li>They use the screen capture tool in debug mode to tile the map into 1920x960
chunks and screengrab everything.</li>
<li>Later, somebody regenerates the map with some possible changes.</li>
<li>They grab screenshots again, then use <code>compare_screenshots.sh</code> to quickly
look at the visual diff. Changes to intersection geometry, number of lanes,
rendering, etc are all easy to spot.</li>
<li>If this manual inspection of the diff is good, they commit the new
screenshots as the new goldenfiles.</li>
</ol>
<p>How do you actually run this test? Open the main sandbox mode (on a release
build, unless you're very patient), go to debug mode (<strong>Ctrl+D</strong>), then hit
&quot;screenshot all of the everything&quot; on the right. This will fly through a few
maps, tiling them into screen-sized chunks and saving a screenshot for each one.
The maps configured for this test are in <code>game/src/debug/mod.rs</code>, near the
string <code>&quot;screenshot all of the everything&quot;</code>.</p>
<p>This process produces a <code>screenshots/</code> directory. You can then use
<code>./compare_screencaps.sh us phoenix tempe</code> to see if that map's screenshots have
changed since the last recorded run of the test. This script assumes you've
opted into the <a href="tech/dev/index.html#downloading-more-cities">input data</a> and run the
updater for the appropriate cities. It also assumes the <code>compare</code> command (from
ImageMagick) and <code>feh</code> (to view images; you could change the script to something
else). Very critically, all the stored screenshots are sized <code>1920 x 948</code> (from
a <code>1920 x 1080</code> monitor, subtracting titlebars and such for my GNOME setup). The
diffs won't make sense if the size is different!</p>
<p>After confirming any diffs are intentional, the <code>./confirm_screencap.sh</code> script
replaces the new source-of-truth in
<code>data/input/us/phoenix/screenshots/tempe.zip</code> or similar. The <code>updater</code> tool is
then used to upload the new data to S3 -- this is a step that currently only
Dustin has access to run.</p>
<h2 id="dataregensh"><a class="header" href="#dataregensh">data/regen.sh</a></h2>
<p>This tool regenerates all maps and scenarios from scratch.
<code>cargo run --bin updater -- dry-run</code> then reveals what files have changed.</p>
<p>Additionally, this script does a few more tests:</p>
<ul>
<li><code>--prebake</code> runs the full weekday scenario on two maps that've previously been
coerced into being gridlock-free</li>
</ul>
<h2 id="integration-tests"><a class="header" href="#integration-tests">Integration tests</a></h2>
<p>The <code>tests</code> crate contains some integration tests.</p>
<p>One part runs the full importer against really simple <code>.osm</code> files. To iterate
rapidly on interpreting turn restrictions, it produces goldenfiles describing
all turns in the tiny map.</p>
<p>The &quot;smoke-test&quot; section simulates one hour on all maps, flushing out bugs with
bus spawning, agents hitting odd parts of the map, etc</p>
<p>The &quot;check proposals&quot; section makes sure the edits shipped with the game still
load properly.</p>
<h2 id="old-tests"><a class="header" href="#old-tests">Old tests</a></h2>
<p>Once upon a time, I made a little test harness that would run the simulation
headlessly (without graphics), set up certain situations forcing a car to park
in a certain spot, and asserted that different <code>sim/src/events.rs</code> were produced
in the right order. The <code>map_editor</code> tool was used to manually draw really
simple maps for these situations. I deleted everything, because the effort to
specify the input and expected output were too tedious to maintain, and this
never really helped catch bugs. There was a way to label roads and buildings in
the synthetic maps, so the test code could assert person 2 made it to the
&quot;house&quot; building, but even with all of this, it was pretty hard.</p>
<p>This approach is maybe worth reviving, though.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="data-organization"><a class="header" href="#data-organization">Data organization</a></h1>
<p>A/B Street includes lots of large binary files to represent converted maps,
scenarios, and prebaked simulation results. The files are too large to store in
git, but the files are still logically tied to a version of the code, since the
format sometimes changes. Additionally, all of the files are too large to
include in the .zip release that most people use, but it should still be
possible for players to download the optional content. Also, there are different
versions of the game floating around, on native and web, that have to be
associated with the proper version of these files.</p>
<p>It's all slightly confusing, so this page describes how it all works.</p>
<h2 id="the-data-itself"><a class="header" href="#the-data-itself">The data itself</a></h2>
<p>If you peek into the <code>data/</code> directory, it's mainly split into 3 subdirectories.
<code>system/</code> is used when running the game and is the subject of this page.
<code>input/</code> is used to store input and intermediate files for importing maps, and
only developers running the importer should care about it. <code>player/</code> contains
local settings, map edits, and other data created in-game.</p>
<p><code>data/MANIFEST.json</code> is a listing of all files in <code>data/system/</code>, along with
their size and md5sum. Different tools compare this manifest to the local
filesystem to figure out what to do.</p>
<p>There are also some other scripts and files in <code>data/</code>, but they should probably
be moved.</p>
<h2 id="where-the-data-is-stored"><a class="header" href="#where-the-data-is-stored">Where the data is stored</a></h2>
<p><code>data/system/</code> and <code>data/input/</code> are stored in Amazon S3, at
http://abstreet.s3-website.us-east-2.amazonaws.com. This S3 bucket is organized
into versions: <code>dev</code>, <code>0.2.17</code>, <code>0.2.18</code>, etc. <code>dev</code> represents the latest
version of all data files. The numbered versions correspond to
<a href="https://github.com/a-b-street/abstreet/releases">releases</a> and only contain
<code>data/system/</code>, not <code>data/input/</code>. Depending how large these directories grow
over time, I'll commit to keeping around at least 3 of the previous numbered
versions, but I might delete older ones after that.</p>
<p><code>play.abstreet.org</code> is wired up to Cloudfront, via Google Domains. The CDN is
faster than accessing the S3 bucket (in one region) directly.</p>
<h2 id="native-running-from-source"><a class="header" href="#native-running-from-source">Native, running from source</a></h2>
<p>For people building the game <a href="tech/dev/index.html">from source</a>, the process to keep data
files fresh is to <code>cargo run --bin updater -- download</code>. This tool calculates
md5sums of all local files, then compares it with the checked-in
<code>data/MANIFEST.json</code>. Any difference results in a local file being deleted or a
new file from S3 being downloaded. By editing <code>data/player/data.json</code> manually
or using the UI in the game (found by loading a map, then choosing to download
more maps), somebody can opt into downloading &quot;extra/optional&quot; cities.</p>
<h2 id="native-running-from-a-release-zip"><a class="header" href="#native-running-from-a-release-zip">Native, running from a release .zip</a></h2>
<p>When the weekly .zip binary release for Mac, Linux, and Windows is produced, the
<code>game</code> crate is built with <code>--features release_s3</code>. When the downloader UI is
opened in-game, this causes downloads to occur from a versioned S3 directory,
like <code>0.2.17</code>, depending on the version string compiled into the game at that
time. So somebody can run off the weekly release, opt into more cities, and get
the correct version of the files, even if the format has changed in <code>/dev/</code>
since then.</p>
<h2 id="web-running-locally"><a class="header" href="#web-running-locally">Web, running locally</a></h2>
<p>The strategy for managing files gets more interested when the game is compiled
to WebAssembly, since browsers can't read from the local filesystem.
<code>game/src/load.rs</code> contains some crazy tricks to instead make asynchronous HTTP
requests through the browser. When using <code>game/run_web.sh</code>, the files are served
through a local HTTP server and symlinked to the local copy of <code>data/system/</code>.</p>
<p>Not all files are loaded through HTTP; some are actually statically compiled
into the <code>.wasm</code> file itself! <code>abstutil/src/io_web.rs</code> does this magic using the
<code>include_dir</code> crate. Only a few critical large files, needed at startup, are
included. There's an IO layer for listing and reading files that, on web, merges
results from the bundled-in files and the remote files that're declared to exist
in the bundled-in copy of <code>data/MANIFEST.json</code>.</p>
<h2 id="web-from-s3"><a class="header" href="#web-from-s3">Web, from S3</a></h2>
<p>Everything's the same, except that since the URL isn't localhost, the game makes
HTTP requests to the S3 bucket (or wherever the game is hosted). Additionally,
the files are expected to be gzipped. The web version always pins to <code>/dev</code>,
never a release version of the data, since the web client is always updated
along with the data, for now.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="release-process"><a class="header" href="#release-process">Release process</a></h1>
<p>This happens every Sunday.</p>
<ol>
<li>Push a commit containing <code>[rebuild] [release]</code> in the commit message.</li>
<li>Go to <a href="https://github.com/a-b-street/abstreet/actions">https://github.com/a-b-street/abstreet/actions</a> and manually approve
the deployment, then wait for it to complete</li>
<li>Manually download the 3 .zip files</li>
<li>With your current directory set to where the .zips are downloaded, run
<code>~/abstreet/release/finalize.sh v0_2_38</code>, changing the version number. (That
path assumes the abstreet git repo is in your home directory.)</li>
<li>If you want, sanity check that the final generated binaries work. Sometimes
I test things like the map importer or that maps not included by default can
be downloaded.</li>
<li>Create a new release at
<a href="https://github.com/a-b-street/abstreet/releases/new">https://github.com/a-b-street/abstreet/releases/new</a>. Make sure the version
matches, with a different format -- <code>v0.2.38</code>. The description should match
what later goes in the changelog, and the name really ought to be
gastronomically offensive.</li>
<li>Upload the 3 transformed .zips created by <code>finalize.sh</code> -- they're named
something like <code>abstreet_mac_v0_2_38.zip</code>.</li>
<li>Publish release!</li>
<li>From the root directory of the abstreet repo, run
<code>./release/update_docs.sh 37 38</code>. When the major version number changes,
update that script first. This updates the latest release from <code>0.2.37</code> to
<code>0.2.38</code>. It assumes the <a href="https://github.com/a-b-street/docs">https://github.com/a-b-street/docs</a> repo is in
your home directory named <code>~/docs</code>.</li>
<li>Go fill out <code>~/docs/book/src/project/history/CHANGELOG.md</code>; the notes should
match what's in the Github release.</li>
<li>Follow the steps that the <code>update_docs.sh</code> script tells you. Don't forget to
push the commit on the main abstreet repo as well.</li>
</ol>
<p>One of the <code>update_docs.sh</code> steps is an S3 copy. This &quot;freezes&quot; the current
&quot;dev&quot; data and web deployment as a named version. The URL would be something
like <a href="http://abstreet.s3-website.us-east-2.amazonaws.com/0.2.38/abstreet.html">http://abstreet.s3-website.us-east-2.amazonaws.com/0.2.38/abstreet.html</a>.</p>
<h2 id="how-it-works"><a class="header" href="#how-it-works">How it works</a></h2>
<p>The process is kind of convoluted; help is always welcome to smooth it out.</p>
<p>Github Actions is used to build for all 3 platforms.
<code>.github/workflows/main.yml</code> is configured to only build when <code>[rebuild]</code> is in
the commit message. <code>[release]</code> enables a cargo feature flag that tells
<code>map_gui/src/tools/updater.rs</code> where to look to download new system data.
Because the binary map format changes, an older release has to be pinned to a
particular versioned copy of all the system data. The workflow calls
<code>release/build.sh</code>, which assembles the directory structure with all of the
executables, system data (obtained by running the updater with the default
Seattle-only opt-in), and instructions.</p>
<p>There's some funkiness with producing a .zip, because uploading Github artifacts
always double-zips, and also on the Windows runner, there doesn't seem to be a
way to create a .zip. That's why the extra step of downloading the build
artifacts and running <code>release/finalize.sh</code> locally is necessary.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="data-formats"><a class="header" href="#data-formats">Data formats</a></h1>
<p>This section describes data formats that A/B Street uses for input and output.
Like the API, nothing is guaranteed to be backwards-compatible yet. The best way
to make sure schema changes won't mess up your workflow is to keep in touch and
make sure I know how you're using these files.</p>
<p>The formats are currently JSON, without a machine-readable schema. In the
future, I'm highly likely to use protocol buffers, flatbuffers, Thrift, etc
instead, so that languages with static type systems can benefit from
auto-generated libraries and so that larger files can be encoded in binary.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="scenario-data-format"><a class="header" href="#scenario-data-format">Scenario data format</a></h1>
<p>If you want to import your own
<a href="tech/dev/formats/../../trafficsim/travel_demand.html">travel demand model</a>, you can use this JSON
file.</p>
<h2 id="specification"><a class="header" href="#specification">Specification</a></h2>
<p>Until we switch to using protobufs or similar, there's no formal spec. The JSON
deserialization happens from
<a href="https://github.com/a-b-street/abstreet/blob/master/sim/src/make/external.rs">Rust code</a>.
It's easiest to follow the example below.</p>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<p>This defines a scenario containing a single person, who takes two trips. They
begin at 1 second past midnight (<code>10000</code>) at the building nearest to the
<code>origin</code>, 'find' a bike and cycle to the <code>destination</code>. Then at 12:20
(<code>12000000</code> is <code>1200</code> seconds after midnight), they walk to the building nearest
to the <code>destination</code>. Note that the <code>destination</code> of trip 1 must match the
<code>origin</code> of trip 2.</p>
<p>The <code>mode</code> field can be be <code>Walk</code>, <code>Bike</code>, or <code>Transit</code>. The <code>purpose</code> field is
mostly unused; you could pick
<a href="https://a-b-street.github.io/abstreet/rustdoc/sim/enum.TripPurpose.html">other values</a>
that show up in the UI. And of course, you can add as many people as you like.</p>
<pre><code>{
  &quot;scenario_name&quot;: &quot;minimal&quot;,
  &quot;people&quot;: [
    {
      &quot;trips&quot;: [
        {
          &quot;departure&quot;: 10000,
          &quot;origin&quot;: {
            &quot;Position&quot;: {
              &quot;longitude&quot;: -122.303723,
              &quot;latitude&quot;: 47.6372834
            }
          },
          &quot;destination&quot;: {
            &quot;Position&quot;: {
             &quot;longitude&quot;: -122.3190500,
              &quot;latitude&quot;: 47.6378600
        }
          },
          &quot;mode&quot;: &quot;Bike&quot;,
          &quot;purpose&quot;: &quot;Meal&quot;
        },
        {
          &quot;departure&quot;: 12000000,
          &quot;origin&quot;: {
            &quot;Position&quot;: {
             &quot;longitude&quot;: -122.3190500,
              &quot;latitude&quot;: 47.6378600
        }
          },
          &quot;destination&quot;: {
            &quot;Position&quot;: {
              &quot;longitude&quot;: -122.3075948,
              &quot;latitude&quot;: 47.6394773
        }
          },
          &quot;mode&quot;: &quot;Walk&quot;,
          &quot;purpose&quot;: &quot;Recreation&quot;
        }
      ]
    }
  ]
}
</code></pre>
<h2 id="tools"><a class="header" href="#tools">Tools</a></h2>
<p>To import this JSON file into A/B Street:</p>
<pre><code>cargo run --release --bin cli -- import-scenario --map=data/system/us/seattle/maps/montlake.bin --input=/path/to/input.json
</code></pre>
<p>Then run the game as follows:</p>
<pre><code>cargo run --bin game -- --dev data/system/us/seattle/maps/montlake.bin
</code></pre>
<p>You will need to select the senario with the user interface.</p>
<p>This tool matches input positions to the nearest building, within 100 meters. If
the point lies outside the map boundary, it's snapped to the nearest map border.
The tool will fail if any point doesn't match to a building. If you pass
<code>--skip_problems</code>, those people will be logged and skipped instead.</p>
<p>There are also a few tools that produce this JSON file:</p>
<ul>
<li><a href="https://github.com/a-b-street/abstreet/blob/master/headless/examples/generate_traffic.py">https://github.com/a-b-street/abstreet/blob/master/headless/examples/generate_traffic.py</a></li>
<li><a href="https://github.com/a-b-street/abstr">https://github.com/a-b-street/abstr</a></li>
</ul>
<h2 id="future-requests"><a class="header" href="#future-requests">Future requests</a></h2>
<ul>
<li>A way to specify some kind of numeric ID for each person, so you can later
correlate results from the simulation with your input</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="traffic-signal-data-format"><a class="header" href="#traffic-signal-data-format">Traffic signal data format</a></h1>
<p>A/B Street uses a JSON format to describe how a single intersection with traffic
signals is configured. This format changes more frequently, but the software
will automatically upgrade a signal described in an old format. This way,
players can save their edits to a map and, months later, still use the same
edits with a new version of A/B Street. (The only exception is when
OpenStreetMap IDs change; if a way near the intersection is split and assigned a
new ID, we make no attempt to handle this.)</p>
<p>The format is complicated, so let's break down some of the concepts used in it.</p>
<h2 id="turns"><a class="header" href="#turns">Turns</a></h2>
<p>We first need a way to describe a movement between two road segments. Let's use
<a href="https://www.openstreetmap.org/node/53219808">https://www.openstreetmap.org/node/53219808</a>, the intersection of 24th Ave E
and E McGraw St in Seattle as an example.</p>
<h3 id="directed-road-segments"><a class="header" href="#directed-road-segments">Directed road segments</a></h3>
<p>So first let's identify a single road segment. For this example, let's describe
the eastbound direction of the west side of McGraw St, which is
<a href="https://www.openstreetmap.org/way/804788512">https://www.openstreetmap.org/way/804788512</a> in OSM. As you can see, this way
hits 3 intersections. We just want to describe the segment between 24th and 25th
Ave. Looking at the list of nodes for that way in the order defined in OSM, we
see it goes from <a href="https://www.openstreetmap.org/node/53219808">https://www.openstreetmap.org/node/53219808</a> to
<a href="https://www.openstreetmap.org/node/1709143541">https://www.openstreetmap.org/node/1709143541</a>. Note that the intermediate
nodes used as control points for the shape of the road or as crosswalk nodes are
ignored. So, we can describe this segment by using the way's ID and the first
and last node ID.</p>
<p><img src="tech/dev/formats/mcgraw.png" alt="mcgraw" /></p>
<pre><code>{
  &quot;osm_way_id&quot;: 804788512,
  &quot;osm_node1&quot;: 53219808,
  &quot;osm_node2&quot;: 1709143541,
  &quot;is_forwards&quot;: false
}
</code></pre>
<p>Finally, we have to say which direction of this road segment we're talking
about. The order of the nodes in OSM is arbitrary; in this case, the road points
from the traffic signal we're talking about to another intersection. But we want
to refer to the inbound / eastbound direction of this road. So we say
<code>&quot;is_forwards&quot;: false</code> to indicate the opposite of the direction specified by
OSM. This is the same concept as &quot;forward &amp; backward&quot; as defined in the
<a href="https://wiki.openstreetmap.org/wiki/Forward_%26_backward,_left_%26_right">OSM wiki</a>.</p>
<h3 id="turns-for-vehicles"><a class="header" href="#turns-for-vehicles">Turns for vehicles</a></h3>
<p>So now let's describe the left turn from E McGraw to 24th going southbound. It
looks like this:</p>
<pre><code>{
  &quot;from&quot;: {
    &quot;osm_way_id&quot;: 804788512,
    &quot;osm_node1&quot;: 53219808,
    &quot;osm_node2&quot;: 1709143541,
    &quot;is_forwards&quot;: false
  },
  &quot;to&quot;: {
    &quot;osm_way_id&quot;: 6470476,
    &quot;osm_node1&quot;: 53128048,
    &quot;osm_node2&quot;: 53219808,
    &quot;is_forwards&quot;: false
  },
  &quot;intersection_osm_node_id&quot;: 53219808,
  &quot;is_crosswalk&quot;: false
}
</code></pre>
<p>You specify the <code>from</code> and <code>to</code> fields using the directed road segment ID.
Additionally, you specify which intersection the traffic signal is at --
<code>53219808</code> in this case -- and set <code>is_crosswalk</code> to <code>false</code> to indicate a turn
for vehicles or cyclists on the road.</p>
<h3 id="crosswalks"><a class="header" href="#crosswalks">Crosswalks</a></h3>
<p>Why is the format above so repetitive? The reason is to be able to also specify
movements along crosswalks in the intersection. The <code>from</code> and <code>to</code> directed
road segments refer to one half of a road, so they can be used to identify one
sidewalk or another. From this diagram, you can see how there are 8 different
start or end points for crosswalks at this intersection:</p>
<p><img src="tech/dev/formats/crosswalks.png" alt="crosswalks" /></p>
<p>TODO: Walk through an example of a single crosswalk. I hope the explanation of
the format above suffices, for now.</p>
<h2 id="stages"><a class="header" href="#stages">Stages</a></h2>
<p>Now that we understand how to describe turns, we can describe the sequence of
stages that a traffic signal cycles through. Each stage specifies the turns that
are <strong>protected</strong> and <strong>permitted</strong>. Protected turns have priority (a green
light), and no two protected turns in the same stage can cross each other.
Permitted turns are allowed only if there's no oncoming traffic -- so this could
mean a right turn on red or an unprotected left turn with a flashing arrow. Note
that crosswalks always must be defined as protected, which means any vehicle
turns that intersect with the crosswalk have to be specified as permitted. This
captures the semantics in the US that turning vehicles must always yield to
pedestrians when the crosswalk signal is on.</p>
<p>A single traffic signal cycles through the same list of stages over and over.
Each stage also specifies its duration with the <code>stage_type</code>. The simple example
is <code>&quot;Fixed&quot;: 45</code>, meaning this stage always lasts exactly 45 seconds. A stage
can also have variable timing, also known as actuation. The format is
<code>&quot;Variable&quot;: [15, 2, 10]</code>. This stage would last a minimum of 15 seconds, but it
may last an additional 10 seconds, up to a maximum of 25 seconds. If there are
no vehicles or pedestrians trying to make protected turns after 15 seconds, the
stage ends. If there are, then the stage is extended by 2 seconds, and the same
check repeats, until the maximum of 25 is reached.</p>
<h2 id="the-full-example"><a class="header" href="#the-full-example">The full example</a></h2>
<p>Understanding everything above means you should be able to interpret what
<a href="https://github.com/a-b-street/abstreet/blob/599c7b6d6bc078312e5ea9f57d3391be9568ef83/traffic_signal_data/data/53219808.json">https://github.com/a-b-street/abstreet/blob/599c7b6d6bc078312e5ea9f57d3391be9568ef83/traffic_signal_data/data/53219808.json</a>
means. The rendering in A/B Street looks like this:</p>
<p><img src="tech/dev/formats/stages.png" alt="stages" /></p>
<p>There are two stages. The first lasts 45 seconds and allows north/south
movement. Left turns onto McGraw are permitted after yielding. Since the
north/south crosswalks are also enabled, all right turns also have to yield. The
second stage lasts only 15 seconds and lets east/west traffic move. Left turns
are also unprotected here.</p>
<h2 id="limitations-1"><a class="header" href="#limitations-1">Limitations</a></h2>
<p>In reality, many traffic signals use different configuration during rush hour,
late at night, on weekends, etc. There's some
<a href="https://github.com/a-b-street/abstreet/issues/447">planned work</a> to model one
intersection having different plans.</p>
<p>Many intersections in Seattle now use
<a href="https://nacto.org/publication/urban-street-design-guide/intersection-design-elements/traffic-signals/leading-pedestrian-interval/">leading pedestrian intervals</a>,
which enable a crosswalk signal to give pedestrians a head-start into the
intersection before vehicles start to turn. You can model this in A/B Street by
adding an extra stage that only enables the crosswalks and lasts a few seconds,
followed by a stage allowing both the crosswalks and vehicle turns. We could
explicitly add a parameter for LPI duration, but it would complicate the format,
so this &quot;flattened stage&quot; format will work for now.</p>
<p>You'll notice the format for specifying turns works at the granularity of the
entire road, not individual lanes. Most of the time, this is fine -- vehicles
will only use the turn lanes available. But in some cases, we may want to
distinguish two groups of vehicles moving the same direction by the lane type.
In particular, sometimes there's a bidirectional protected cycle-track on one
side of the road with its own dedicated signal:</p>
<p><img src="tech/dev/formats/cycletrack.png" alt="cycletrack" /></p>
<p>A/B Street can't model this as having a separate signal yet.</p>
<h2 id="complications-with-importing-other-data"><a class="header" href="#complications-with-importing-other-data">Complications with importing other data</a></h2>
<p>External software like
<a href="https://github.com/asu-trans-ai-lab/data2timing">vol2timing</a> can provide much
better signal configuration than A/B Street's default heuristics. We will
encounter at least two major challenges to import it.</p>
<h2 id="crosswalks-1"><a class="header" href="#crosswalks-1">Crosswalks</a></h2>
<p>A/B Street currently does not use sidewalks, foot-paths, and crosswalks that are
explicitly drawn as separate OSM ways. Instead, it makes many guesses for which
roads have a sidewalk and creates many, many crosswalks. See
<a href="https://github.com/a-b-street/abstreet/issues/485">https://github.com/a-b-street/abstreet/issues/485</a> for some examples of
crosswalks that should not be created, but currently are.</p>
<p>When A/B Street imports traffic signal configuration, it validates that all
possible turns at the intersection are captured by at least one stage. The
problem here will be that other software may not list as many crosswalks as A/B
Street expects.</p>
<h2 id="intersection-mergingconsolidation"><a class="header" href="#intersection-mergingconsolidation">Intersection merging/consolidation</a></h2>
<p>OSM models bidirectional roads with some physical median as two one-ways. When
these divided one-ways cross a regular road, the intersection is split into two
intersections with a very short &quot;road&quot; in between. When two pairs of divided
one-ways cross, the intersection has four nodes and short &quot;roads&quot; in between.
This wreaks havoc in A/B Street, making the intersection geometry look strange,
making it hard to edit the two or four uncoordinated traffic signals around the
intersection, and causing vehicles to get stuck in the short &quot;roads&quot;.</p>
<p>One solution that's promising is for A/B Street to consolidate those nodes and
short &quot;roads&quot; into one big intersection, capturing how a human would intuitively
view the area. One case where this works well is
<a href="https://www.openstreetmap.org/#map=19/47.68264/-122.34426">https://www.openstreetmap.org/#map=19/47.68264/-122.34426</a>. See the before and
after:</p>
<p><img src="tech/dev/formats/consolidate.png" alt="consolidate" /></p>
<p>Unfortunately this process doesn't work for many more cases, so it's not enabled
by default yet. Preserving turn restrictions defined by OSM and getting good
results for the geometry of the consolidated intersection is hard.</p>
<p>In the meantime, all of this complicates the traffic signal format, because it's
unclear how to specify road segments when A/B Street will arbitrarily delete
some of the node IDs when it imports.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-the-the-ab-street-ui--drawing-work"><a class="header" href="#how-the-the-ab-street-ui--drawing-work">How the the A/B Street UI &amp; drawing work</a></h1>
<p>When I started A/B Street in June 2018, the
<a href="https://www.areweguiyet.com">Rust UI ecosystem</a> had nothing that clearly fit my
needs, so I wound up rolling something custom. This doc explains conceptually
how it works and how to use it. Eventually some of this should become proper
docs for <code>widgetry</code>.</p>
<p>Best advice on how to use stuff in practice is to work from examples. <code>grep</code> is
your friend.</p>
<h2 id="widgetry-overview"><a class="header" href="#widgetry-overview">widgetry overview</a></h2>
<p>First, the crate-level view. <code>widgetry</code> is the generic drawing and UI library,
independent of A/B Street. <code>map_gui</code> builds on top of it, providing ways to
render the map model used by all of the projects. Finally, <code>game</code>,
<code>fifteen_min</code>, <code>santa</code>, and others are the runnable applications making use of
this.</p>
<p>This section will explain how <code>widgetry</code> works from bottom-up. Conceptually
we'll walk through how it was built from scratch, skipping all of the false
turns made along the way.</p>
<h3 id="low-level"><a class="header" href="#low-level">Low-level</a></h3>
<p>Let's start just by drawing stuff and handling keyboard/mouse events. The basic
loop of any <a href="https://crates.io/crates/winit">winit</a> program is to handle input
events and, when winit says to, redraw everything. The earliest A/B Street
prototype expressed the primitive map model imported from OpenStreetMap as a
bunch of polygons, and hooked up basic mouse controls to pan and zoom over the
canvas.</p>
<p>And that hasn't really changed -- we still only draw 2D colored polygons.
Widgetry's use of
<a href="https://github.com/a-b-street/abstreet/tree/master/widgetry/shaders">OpenGL shaders</a>
is dirt simple. With the exception of some barely used texture code, all of the
icons and images in A/B Street are SVGs, which can be
<a href="https://github.com/a-b-street/abstreet/blob/master/widgetry/src/svg.rs">transformed into colored polygons</a>
through the magic of the <a href="https://crates.io/crates/usvg">usvg</a> and
<a href="https://crates.io/crates/lyon">lyon</a> crates. This includes all
<a href="https://github.com/a-b-street/abstreet/blob/master/widgetry/src/text.rs">text</a>
-- even the text is just colored vector polygons! (Text rendering usually works
by uploading a table of raster glyphs to the GPU and drawing textured quads.)</p>
<p>The brief story of how we got here: by
<a href="tech/dev/../../project/history/year2.html">November 2019</a>, there was some basic support
for uploading raster texture and drawing them. At the second Democracy Lab
hackathon, a developer on Mac hit a 16 texture object limit that was different
than Linux. This is also when Yuwen joined and started designing using Figma,
which... conveniently had SVG export. I was also frustrated by rendering text
separately from everything else; finding the bounding boxes was buggy and there
were z-order issues. All of this prompted me to poke around and discover an
example using lyon to tesellate the output from usvg. I thought, there's no way
vectorizing EVERYTHING could be performant. But happily I was wrong.</p>
<p>Finally getting to the practical consequence here. It's expensive to upload
stuff to the GPU, but it's cheap to draw something already uploaded. So you use
a <code>GeomBatch</code> to build up that list of colored polygons, then upload it by doing
<code>ctx.upload(batch)</code>. Later on, you can <code>g.redraw(&amp;drawable)</code> as many times as
you want and it's fast. You don't keep the <code>GeomBatch</code> around; it's just the
builder for a <code>Drawable</code>.</p>
<p>How should you batch stuff? Issuing redraw calls is fast, but not when there's
lots of them. So for example, one <code>Drawable</code> per every building on the map would
be a nightmare. Since buildings don't change, there's a single batch and
<code>Drawable</code> for all of them. There's a balance here; sometimes you have to
experiment to find it. But generally, if recalculating a batch only needs to
happen every so often, just lump everything together in one for simplicity.</p>
<h3 id="stack-of-states"><a class="header" href="#stack-of-states">Stack of states</a></h3>
<p>So at this point, there's logically one method to handle input events, and one
method to draw. No built-in organization; all application state is just lumped
somewhere. The basic insight is that an app has a stack of smaller states
layered on top of each other. For example, you start with a title screen, then
enter the main simulation interface, then open up a menu to show extra layers.
You still want to draw the simulation underneath the menu, but not allow it to
handle events. When you exit the simulation, you want to go back to the title
screen and preserve any local state there.</p>
<p>So a widgetry app mainly consists of a stack of
<a href="https://github.com/a-b-street/abstreet/blob/master/widgetry/src/app_state.rs">States</a>.
Each state implements a method to handle events and draw. Some states want to
draw what's underneath them, while some want to clear the screen and fully
handle everything -- so <code>draw_baselayer</code> specifies this.</p>
<p>When a state handles an event, it returns a <code>Transition</code>. This manipulates the
stack. <code>Transition::Keep</code> doesn't do anything; the current state remains.
<code>Transition::Pop</code> deletes the current state from the stack, and the previous one
takes over. <code>Transition::Push</code> introduces a new state, preserving the current
underneath. And so on.</p>
<p>There's actually two types of &quot;state&quot; (as in, data managed by the app): local
and global. Local &quot;state&quot; is owned by the struct implementing the <code>State</code> trait.
This is usually stuff like any UI panels (which we'll get to soon) and stuff
like which road we're editing, or what building we're examining. But usually an
app has a bunch of &quot;state&quot; that lasts for the entire lifetime of the program --
the map, the simulation, global settings. This stuff can change through the
program, like loading a new map, but every single <code>State</code> probably wants to use
it. This global stuff is stored in the <code>App</code> struct, which gets plumbed around.
So, each <code>State</code> has
<code>fn event(&amp;mut self, ctx: &amp;mut EventCtx, app: &amp;mut App) -&gt; Transition</code> -- <code>self</code>
is the local <code>State</code> on the stack, <code>ctx</code> is a handle into the generic <code>widgetry</code>
system, and <code>app</code> is that global &quot;state&quot;. And there's also
<code>fn draw(&amp;self, g: &amp;mut GfxCtx, app: &amp;App)</code>, with <code>GfxCtx</code> being the hook to
draw stuff. Note <code>draw</code> uses immutable borrows; generally you shouldn't modify
anything while drawing. (When you need to, like for caching, usually
<a href="https://doc.rust-lang.org/std/cell/index.html">RefCell</a> is the answer.)</p>
<p>This system of states and transitions mostly works, but there's one super
awkward problem. Sometimes, state1 needs to push on state2 in order to prompt
the user for input (free-form text, a menu, or even something more complicated)
and use the result of state2 in order to do something else. In normal
programming, this would just be calling a function and using the return value.
How do we make that work with the event/draw interface? The answer is for state2
to return <code>Transition::Pop</code> and <code>Transition::ModifyState</code>, downcast the previous
<code>State</code> into a particular struct, and shove the return value somewhere. This is
incredibly gross, but I'm not sure what else to do.</p>
<h3 id="panels"><a class="header" href="#panels">Panels</a></h3>
<p>What's been described so far is kind of only useful for drawing and interacting
with stuff in &quot;map-space&quot;, aka, the scrollable canvas. What about normal GUI
elements that live in &quot;screen-space&quot; on top of everything else -- buttons,
dropdowns, checkboxes, frobnozzlers? There needs to be a way to create these,
arrange them in some kind of layout, and use them for interaction. There's a
bunch of ways that GUI frameworks manage the problem of synchronizing
application &quot;state&quot; with the UI widgets, and it's more complex than usual in
Rust, because you hit crazy lifetime and borrowing issues if you try to do
anything with callbacks.</p>
<p>So sticking to the widgetry philosophy of seeing how far the low-level
abstractions stretch, widgets are just temporary &quot;state&quot; managed by a <code>State</code>.
They're always managed as part of a <code>Panel</code>, even if you have just a single
button. Constructing <code>Panel</code>s is hopefully straightforward from examples; you
assemble a tree of rows and columns, with some occasional styling and layouting
hints thrown in. Underneath, widgetry uses
<a href="https://crates.io/crates/stretch">stretch</a> for CSS Flexbox-style layouting.
There are some quirks, most of which we've worked out and hopefully papered over
(like <code>padding</code> and <code>margin</code> don't work on most widgets directly; you have to
wrap them in a <code>Widget::row</code> or <code>Widget::col</code>).</p>
<p>So how do you know if a button has been clicked, a toggle toggled, a slider
slidden, a frobnozzler frobnuzzled? In some languages, you might expect
callbacks, but here in widgetry, you have to explicitly ask. Most <code>State</code>s will
<code>match self.panel.event(ctx)</code> somewhere near the top. This takes the current
event (a low-level keypress or mouse movement) and lets all of the widgets
inside the <code>Panel</code> possibly use it. If the event caused the widgets to do
something interesting, the entire <code>Panel</code> will return
<code>Some(Outcome::Clicked(&quot;button name&quot;))</code> or
<code>Some(Outcome::Changed(&quot;spinner name&quot;))</code>. The <code>State</code> code can then interpret
that UI-level event appropriately.</p>
<p>Currently, the widgets in a <code>Panel</code> are identified by lovely type-unsafe
hardcoded strings. This isn't the best, but in practice, it's rare to get out of
sync between the two places in one file that talk about the same widget.</p>
<p>Some widgets have more information than just &quot;the button was clicked&quot;. Whenever
you need to, you can just query their state --
<code>self.panel.slider(&quot;time&quot;).get_percent()</code>, <code>self.panel.dropdown_value(&quot;mode&quot;)</code>,
<code>self.panel.spinner(&quot;duration&quot;)</code>. These last two are generic, and the compiler
usually infers the type of the value contained. (Internally, we just downcast to
that type, so you'd get a runtime panic if you mess up.)</p>
<h4 id="updating-panels"><a class="header" href="#updating-panels">Updating panels</a></h4>
<p>Sometimes you need to change a <code>Panel</code>, often in response to something done on
that panel -- like say you toggle between showing raw data points versus
aggregating in a heatmap, and want to expose extra heatmap settings. There are
two choices for how to do this: build a new panel entirely, or replace one
widget.</p>
<p>Often it's simplest to just split the method that builds a <code>Panel</code> into its own
method, and call it again with some different parameters. Very very occasionally
when you take this approach, you'll need to do
<code>new_panel.restore(ctx, &amp;self.panel); self.panel = new_panel;</code> to retain
internal widgetry state, such as &quot;this scrollbar is in the process of being
dragged by the mouse.&quot;</p>
<p>Or you can just replace one widget (which may be an entire row or column of
stuff; it's just based on the string ID you specify).
<code>self.panel.replace(ctx, &quot;edit&quot;, new_button)</code> does the trick.</p>
<h4 id="simplestate"><a class="header" href="#simplestate">SimpleState</a></h4>
<p>The free-formed nature of <code>State::event</code> is sometimes overwhelming; how do you
order all of the things that need to happen? You could also implement
<a href="https://github.com/a-b-street/abstreet/blob/master/widgetry/src/app_state.rs">SimpleState</a>
when you only have a single <code>Panel</code>. This gives a slightly more opinionated
interface, telling you when a button was clicked, slider was changed, when the
mouse was moved, etc. If you're confused, see how it implements <code>fn event</code> --
it's just organizing some typical different things that happen to handle an
event.</p>
<h2 id="higher-layers"><a class="header" href="#higher-layers">Higher layers</a></h2>
<p>Someday we want to release <code>widgetry</code> for general use to the Rust community. But
there's also lot of code shared between <code>game</code>, <code>fifteen_min</code>, and other apps
that handles UI concerns specific to <code>map_model</code>, which isn't something most
people will care about. This stuff goes in <code>map_gui</code>.</p>
<p>Lots of the <code>map_gui</code> code implements widgetry <code>States</code>, but those are
parameterized by a particular <code>App</code> struct. Since each of the top-level crates
uses a different struct, there's an
<a href="https://github.com/a-b-street/abstreet/blob/master/map_gui/src/lib.rs">AppLike trait</a>
to handle this level of indirection. If it walks like a duck...</p>
<h3 id="rendering-maps"><a class="header" href="#rendering-maps">Rendering maps</a></h3>
<p>There are generally two strategies for drawing the map. In the unzoomed view, we
tend to have a single <code>Drawable</code> for all buildings, another for all roads, etc.
In the zoomed view, only a few map elements (bus stops, lanes, buildings) are
visible at a time, so we can afford to show more detail, and store a <code>Drawable</code>
per object. In fact, there's no need to even calculate all of this zoomed-in
detail upfront; many maps are huge, and a player won't zoom into every section
in a particular session. So internally, most of the
<a href="https://github.com/a-b-street/abstreet/blob/master/map_gui/src/render/">Renderables</a>
use <code>RefCell</code> and lazily calculate what to draw.</p>
<p><code>DrawMap</code> internally manages a
<a href="https://en.wikipedia.org/wiki/Quadtree">quadtree</a> to figure out what to draw
and to help figure out what object is under the mouse cursor.</p>
<h3 id="async-madness"><a class="header" href="#async-madness">async madness</a></h3>
<p>If you want to see some scary Rust, check out
<a href="https://github.com/a-b-street/abstreet/blob/master/map_gui/src/load.rs">load.rs</a>.
There's a fatal flaw with the core <code>winit</code> event loop -- it was written before
Rust async landed. It's generally bad to spend more than a few milliseconds in
either <code>event</code> or <code>draw</code>; the app will appear sluggish, and at some point, the
window manager warns that the app is frozen. This happens when we
synchronously/blockingly load a big file from disk, or worse, from the network.</p>
<p>We're starting to figure out some of the workarounds. When there's &quot;proper&quot;
async Rust code, like for downloading a file on native, the trick is to spawn a
separate thread to execute the async block. The main thread (where <code>event</code> and
<code>draw</code> and most things run) stashes a <code>Future</code> inside of the <code>State</code>. In
<code>event</code>, it non-blockingly polls the future to see if its done. If not,
immediately return control to the window manager and just ask it to wake things
up again in a few milliseconds. Proper loading screens can be drawn this way.</p>
<p>All of this gets more complicated on the web, because you can't really spawn a
thread without somme web worker magic. It's still possible to make async HTTP
fetches work, but it's not all wired together yet.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="map-model"><a class="header" href="#map-model">Map model</a></h1>
<p>A/B Street transforms OpenStreetMap (OSM) data into a detailed geometric and
semantic representation of the world for traffic simulation. This chapter
describes that map model, with the hopes that it'll be useful for purposes
beyond this project.</p>
<h2 id="overview-1"><a class="header" href="#overview-1">Overview</a></h2>
<p>A <code>Map</code> covers everything inside some hand-drawn boundary, usually scoped to a
city or a few of a city's districts. Unlike OSM, it doesn't cover the entire
world; it only has areas specifically extracted for some purpose.</p>
<p>A map consists of many objects. Mainly, there are roads, broken down into
individual lanes, and intersections. A road is a single segment connecting
exactly two intersections (as opposed to OSM, where a single &quot;way&quot; may span many
intersections). Lanes within a road have a specific type, which dictates their
direction of travel (or lack of travel, like on-street parking) and uses.
Sidewalks are represented as bidirectional lanes. Roads connect at
intersections, which contain an explicit set of turns, each linking a source
lane to a destination lane.</p>
<p>Maps also contain parking lots and buildings, which connect to the nearest
driveable lane and a sidewalk. Maps have water and park areas, only used for
drawing. They also represent public transit stops and routes.</p>
<h2 id="how-is-a-map-used"><a class="header" href="#how-is-a-map-used">How is a map used?</a></h2>
<p>Unlike some GIS systems, maps don't use any kind of database -- they're just a
file, anywhere from 1 to ~500MB (depending on the size of their boundary). Once
loaded into memory, different objects from the map can be accessed directly,
along with a large API to perform various queries.</p>
<p>Most of the map's API is read-only; once built, a map doesn't change until
user-created edits are applied.</p>
<p>The pipeline to import a map from OSM data (and also optional supplementary,
city-specific data) is complex and may take a few minutes to run, but it happens
once offline. Applications using maps just read the final file.</p>
<h2 id="features-1"><a class="header" href="#features-1">Features</a></h2>
<p>Why use A/B Street's map model instead of processing OSM directly?</p>
<p>TODO: Order these better. For each one, show before/after pictures</p>
<h3 id="area-clipping"><a class="header" href="#area-clipping">Area clipping</a></h3>
<p>Bodies of water, forests, parks, and other areas are represented in OSM as
relations, requiring the user to stitch together multiple polylines in undefined
orders and handle inner holes. A/B Street maps handle all of that, and also clip
the area's polygon to the boundary of the entire map -- including coastlines.</p>
<h3 id="road-and-intersection-geometry"><a class="header" href="#road-and-intersection-geometry">Road and intersection geometry</a></h3>
<p>OSM represents roads as a polyline of the physical center of the road. A/B
Street infers the number and type of lanes from OSM metadata, then creates
individual lanes of appropriate width, each with a center-line and polygon for
geometry. At intersections, the roads and lanes are &quot;trimmed back&quot; to avoid
overlapping, and the &quot;common area&quot; becomes the intersection's polygon. This
heuristic process is reasonably robust to complex shapes, with special treatment
of highway on/off-ramps, although it does still have some bugs.</p>
<h3 id="turns-1"><a class="header" href="#turns-1">Turns</a></h3>
<p>At each intersection, A/B Street infers all legal movements between vehicle
lanes and sidewalks. This process makes use of OSM metadata about turn lanes,
inferring reasonable defaults for multi-lane roads. OSM turn restriction
relations, which may span a sequence of several roads to describe U-turns around
complex intersections, are also used.</p>
<h3 id="parking-lots"><a class="header" href="#parking-lots">Parking lots</a></h3>
<p>OSM models parking lots as areas along with the driveable aisles. Usually the
capacity of a lot isn't tagged. A/B Street automatically fills paring lots with
individual stalls along the aisles, estimating the capacity just from this
geometry.</p>
<h3 id="stop-signs"><a class="header" href="#stop-signs">Stop signs</a></h3>
<p>At unsignalized intersections, A/B Street infers which roads have to stop, and
which have right-of-way.</p>
<h3 id="traffic-signals"><a class="header" href="#traffic-signals">Traffic signals</a></h3>
<p>OSM has no way to describe how traffic signals are configured. A/B Street models
fixed-timer signals, automatically inferring the number of stages, their
duration, and the movements that are prioritized and permitted during each
stage.</p>
<h3 id="pathfinding"><a class="header" href="#pathfinding">Pathfinding</a></h3>
<p>A/B Street can determine routes along lanes and turns for vehicles and
pedestrians. These routes obey OSM's turn restriction relations that span
multiple road segments. They also avoid roads that're tagged as not allowing
through-traffic, depending on the route's origin and destination and vehicle
type. The pathfinding optionally makes use of contraction hierarchies to greatly
speed up query performance, at the cost of a slower offline importing process.</p>
<h3 id="bridge-z-ordering"><a class="header" href="#bridge-z-ordering">Bridge z-ordering</a></h3>
<p>OSM tags bridges and tunnels, but the roads that happen to pass underneath
bridges aren't mapped. A/B Street detects these and represents the z-order for
drawing.</p>
<h3 id="buildings"><a class="header" href="#buildings">Buildings</a></h3>
<p>Similar to areas, A/B Street consolidates the geometry of OSM buildings, which
may be split into multiple polygons. Each building is also associated with the
nearest driveable lane and sidewalk, and metadata is used to infer a land-use
(like residential and commercial) and commercial amenities available.</p>
<h3 id="experimental-public-transit"><a class="header" href="#experimental-public-transit">Experimental: public transit</a></h3>
<p>A/B Street uses bus stops and route relations from OSM to build a model of
public transit routes. OSM makes few guarantees about how the specifics of the
route are specified, but A/B Street produces specific paths, handling clipping
to the map boundary.</p>
<p>... All of this isn't the case yet, but it's a WIP!</p>
<h3 id="experimental-separated-cyclepaths-tramways-and-walking-paths"><a class="header" href="#experimental-separated-cyclepaths-tramways-and-walking-paths">Experimental: separated cyclepaths, tramways, and walking paths</a></h3>
<p>Some cyclepaths, tram lines, and footpaths in OSM are tagged as separate ways,
with no association to a &quot;main&quot; road. Sometimes this is true -- they're
independent trails that only occasionally cross roads. But often they run
alongside a road. A/B Street attempts to detect these and &quot;snap&quot; them to the
main road as extra lanes.</p>
<p>... But this doesn't work yet at all.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deep-dive-into-devilish-details-intersection-geometry"><a class="header" href="#deep-dive-into-devilish-details-intersection-geometry">Deep dive into devilish details: Intersection geometry</a></h1>
<style>
figure {
    outline: 1px solid black;
    padding: 16px;
}
</style>
<p><em>By Dustin Carlino, last updated September 2021</em></p>
<p>Some of the things in A/B Street that seem the simplest have taken tremendous
effort. Determining the shape of roads and intersections is one of those
problems, so this article is a deep-dive into how it works and why it's so hard.</p>
<p>Note: The approach I'll describe has many flaws -- I'm not claiming this is a
good solution, just the one that A/B Street uses. If you see a way to improve
anything here, let me know about it!</p>
<ul>
<li><a href="tech/map/geometry/index.html#trying-this-out">Trying this out</a></li>
<li><a href="tech/map/geometry/index.html#background">Background</a>
<ul>
<li><a href="tech/map/geometry/index.html#desired-output">Desired output</a></li>
</ul>
</li>
<li><a href="tech/map/geometry/index.html#the-main-process">The main process</a>
<ul>
<li><a href="tech/map/geometry/index.html#part-1-thickening-the-infinitesimal">Part 1: Thickening the infinitesimal</a>
<ul>
<li><a href="tech/map/geometry/index.html#projecting-a-polyline">Projecting a polyline</a></li>
</ul>
</li>
<li><a href="tech/map/geometry/index.html#part-2-counting-coup">Part 2: Counting coup</a></li>
<li><a href="tech/map/geometry/index.html#part-3-the-clockwise-walk">Part 3: The clockwise walk</a>
<ul>
<li><a href="tech/map/geometry/index.html#sorting-roads-around-a-center">Sorting roads around a center</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="tech/map/geometry/index.html#interlude-problems-so-far">Interlude: problems so far</a>
<ul>
<li><a href="tech/map/geometry/index.html#funky-sidewalks">Funky sidewalks</a></li>
<li><a href="tech/map/geometry/index.html#lovecraftian-geometry">Lovecraftian geometry</a></li>
<li><a href="tech/map/geometry/index.html#bad-osm-data">Bad OSM data</a></li>
<li><a href="tech/map/geometry/index.html#highway-onoff-ramps">Highway on/off-ramps</a></li>
</ul>
</li>
<li><a href="tech/map/geometry/index.html#intersection-consolidation">Intersection consolidation</a>
<ul>
<li><a href="tech/map/geometry/index.html#where-short-roads-conspire">Where short roads conspire</a></li>
<li><a href="tech/map/geometry/index.html#why-we-want-to-do-something-about-it">Why we want to do something about it</a></li>
<li><a href="tech/map/geometry/index.html#goal">Goal</a></li>
<li><a href="tech/map/geometry/index.html#a-solution-two-passes">A solution: two passes</a></li>
<li><a href="tech/map/geometry/index.html#sorting-revisited">Sorting revisited</a></li>
<li><a href="tech/map/geometry/index.html#finding-the-short-roads">Finding the short roads</a></li>
<li><a href="tech/map/geometry/index.html#phantom-collisions">Phantom collisions</a></li>
</ul>
</li>
<li><a href="tech/map/geometry/index.html#conclusion">Conclusion</a></li>
<li><a href="tech/map/geometry/index.html#appendices">Appendices</a>
<ul>
<li><a href="tech/map/geometry/index.html#related-work">Related work</a></li>
<li><a href="tech/map/geometry/index.html#tricks-and-tooling">Tricks and tooling</a></li>
<li><a href="tech/map/geometry/index.html#hall-of-lovecraftian-horrors">Hall of Lovecraftian horrors</a></li>
<li><a href="tech/map/geometry/index.html#a-radically-simpler-approach">A radically simpler approach?</a></li>
<li><a href="tech/map/geometry/index.html#other-data-sources">Other data sources</a></li>
</ul>
</li>
</ul>
<h2 id="trying-this-out"><a class="header" href="#trying-this-out">Trying this out</a></h2>
<p>Originally I wanted to embed code in this article and have interactive demos to
explore each step. That level of ambition fell through, but there is a geometry
debugging tool, running in your browser (with WASM and WebGL required):
<a href="http://play.abstreet.org/dev/map_editor.html?input/us/seattle/raw_maps/aurora_central.bin&--cam=17.39/47.68621/-122.32484" target="_blank">launch
the tool</a>.</p>
<p>The tool wasn't designed for ease-of-use, so some hints on using it:</p>
<ol>
<li>Click and drag to move, scroll to zoom</li>
<li>Toggle intersection geometry on/off with the right panel or by pressing
<strong>g</strong></li>
<li>Click and drag an intersection or an internal point in a curved road to move
it</li>
</ol>
<h2 id="background"><a class="header" href="#background">Background</a></h2>
<p>Most street maps you'll find provide a simplified view of streets. Google Maps,
Apple Maps, and most OpenStreetMap (OSM) renderers mostly just tell you the
road's name, color it by type (a highway, major arterial road, minor residential
street), take great liberties with the width, and don't explicitly distinguish
intersections from roads. These maps are used for navigation and drawing your
attention to nearby businesses, so this is quite a reasonable view.</p>
<figure>
  <a href="tech/map/geometry/rainier_google.png" target="_blank"><img src="tech/map/geometry/rainier_google.png"/></a>
  <figcaption>From Google, it looks like Rainier is a much bigger road than S Massachusetts</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/rainier_osm.png" target="_blank"><img src="tech/map/geometry/rainier_osm.png"/></a>
  <figcaption>The roads look about the same width in OSM</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/rainier_abst.png" target="_blank"><img src="tech/map/geometry/rainier_abst.png"/></a>
  <figcaption>A/B Street reveals the turn lanes and also some bike
lines on Massachusetts!</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/rainier_satellite.png" target="_blank"><img src="tech/map/geometry/rainier_satellite.png"/></a>
  <figcaption>Finally, Google's satellite imagery reveals the true
shape of the intersection, though it's a bit hard to tell with the tree cover.
And unless you zoom in, there's no way you'll spot the lane count or bike
lanes.</figcaption>
</figure>
<p>A/B Street is all about imagining how traffic moves through a city and exploring
the effects of redesigning streets. So of course, we need way more detail. To
imagine a bike lane down Eastlake Ave instead of street parking, we need to
first see how the street's space is allocated. To propose a more
pedestrian-friendly traffic signal crossing from Husky Stadium to the UW medical
building, we need to see that huge intersection.</p>
<figure>
  <a href="tech/map/geometry/eastlake_before.png" target="_blank"><img src="tech/map/geometry/eastlake_before.png"/></a>
  <figcaption>Does Eastlake really need to dedicate 5 lanes to
moving cars and 2 to storing them?</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/eastlake_after.png" target="_blank"><img src="tech/map/geometry/eastlake_after.png"/></a>
  <figcaption>Talking about Eastlake having a safe cycling route is
one thing, but isn't it much easier to imagine when you can just see it?</figcaption>
</figure>
<p>At a high-level, we want a representation that:</p>
<ol>
<li>Clearly communicates how a road is divided into different types of lanes
(general purpose driving, turn lanes, bike lanes, bus-only lanes, street
parking, sidewalks)</li>
<li>Represents the total road width, which tells us how we might change that lane
configuration</li>
<li>Divides paved area into distinct roads and intersections. This division tells
us where vehicles stop before entering an intersection, how pedestrians and
vehicles are likely to move through the space, and what conflicts between
them might occur.</li>
</ol>
<p>We're constrained to publicly available, free data sources. Although some cities
have GIS departments with some datasets that might be helpful, we're pretty much
going with OpenStreetMap (OSM), which has decent coverage of most cities
worldwide.</p>
<h3 id="desired-output"><a class="header" href="#desired-output">Desired output</a></h3>
<p>Let's be a little more specific about the representation we want. If you imagine
a city as flat 2D space, roads and intersections occupy some portion of it.
(Let's ignore bridges and tunnels.)</p>
<figure>
  <a href="tech/map/geometry/thick_pt1.png" target="_blank"><img src="tech/map/geometry/thick_pt1.png"/></a>
  <figcaption>Here's a three-way intersection at your typical Seattle
angle</figcaption>
</figure>
<p>We want to partition this space into individual intersections and road segments.
Each road segment (just called &quot;road&quot; for simplicity) leads between exactly two
of those intersections. This partition shouldn't have any ambiguous overlap
between objects.</p>
<figure>
  <a href="tech/map/geometry/thick_pt2.png" target="_blank"><img src="tech/map/geometry/thick_pt2.png"/></a>
  <figcaption>The red part is what we'll deem the intersection. The grey
roads and the intersection now partition the space.</figcaption>
</figure>
<p>A simplifying assumption, mostly coming from OSM, is that roads can be
represented as a center-line and width, and individual lanes can be formed by
projecting that center-line left and right. This means when the road changes
width in the middle (like for pocket parking or to make room for a turn lane),
we have to model that transition as a small &quot;degenerate&quot; intersection, which
connects only those two roads.</p>
<figure>
  <a href="tech/map/geometry/degenerate.png" target="_blank"><img src="tech/map/geometry/degenerate.png"/></a>
  <figcaption>Two lanes become four -- probably some turn lanes
appearing. The lighter grey is our intersection.</figcaption>
</figure>
<p>Another assumption taken by A/B Street is that roads hit intersections at a
perpendicular angle.</p>
<figure>
  <a href="tech/map/geometry/perp_no_traffic.png" target="_blank"><img src="tech/map/geometry/perp_no_traffic.png"/></a>
  <figcaption>Note how the intersection "eats into" Boren, the
diagonal road, more than you might expect.</figcaption>
</figure>
<p>We use this division to determine where vehicles stop, and where a crosswalk
exists:</p>
<figure>
  <a href="tech/map/geometry/perp_traffic.png" target="_blank"><img src="tech/map/geometry/perp_traffic.png"/></a>
  <figcaption>Does it seem like vehicles have stopped too far away from
the intersection?</figcaption>
</figure>
<p>Of course, this assumption isn't always true in reality:</p>
<figure>
  <a href="tech/map/geometry/perp_satellite.png" target="_blank"><img src="tech/map/geometry/perp_satellite.png"/></a>
  <figcaption>The crosswalks across Boren are horizontal!</figcaption>
</figure>
<p>If we allowed roads to hit intersections at non-perpendicular angles, but still
insisted that the stop position for each individual lane was perpendicular, it
might have a &quot;jagged tooth&quot; look:</p>
<figure>
  <a href="tech/map/geometry/perp_teeth.png" target="_blank"><img src="tech/map/geometry/perp_teeth.png"/></a>
  <figcaption>The cyan lines show one way to represent adjacent lanes
that extend different lengths.</figcaption>
</figure>
<p>But for the sake of this article, these're the assumptions we're sticking with.
Pedestrian islands, slip lanes, gores, and medians are all real-world elements
that don't fit nicely in this model.</p>
<h2 id="the-main-process"><a class="header" href="#the-main-process">The main process</a></h2>
<p>We'll now explore the steps to produce geometry for a single intersection and
its connected roads. The broad overview:</p>
<ol>
<li>Pre-process OSM into road center-lines with attributes, with each road
connecting just two intersections.</li>
<li>Thicken each road</li>
<li>Trim back the roads based on overlap</li>
<li>Produce the intersection polygon</li>
</ol>
<p>Let's pick a particularly illustrative
<a href="https://www.openstreetmap.org/node/1705063811">five-way intersection</a> as our
example.</p>
<h3 id="part-1-thickening-the-infinitesimal"><a class="header" href="#part-1-thickening-the-infinitesimal">Part 1: Thickening the infinitesimal</a></h3>
<p>OSM models roads as a center-line -- supposedly the physical center of the paved
area, not the solid or dashed yellow line (at least in the US) separating the
two directions of traffic. The schema, and how it gets mapped in practice, is
fuzzy when there are more lanes in one direction than the other or when roads
join or split up for logical routing, but... let's keep things simple to start.</p>
<figure>
  <a href="tech/map/geometry/osm_center_lines.png" target="_blank"><img src="tech/map/geometry/osm_center_lines.png"/></a>
  <figcaption>5 roads meet at this intersection. The white lines
are OSM's center line.</figcaption>
</figure>
<p>OSM has a few
<a href="https://wiki.openstreetmap.org/wiki/Key:width#Width_of_streets">tags</a> for
explicitly mapping road width, but in practice they're not widely used. Instead,
we have a whole bunch of tags that describe the lane configuration of the road.
A/B Street interprets these and produces an ordered list of lanes from the left
side of the road to the right, guessing the direction, width, and type of each
lane. See the
<a href="https://github.com/dabreegster/abstreet/blob/master/map_model/src/make/initial/lane_specs.rs">code here</a>
-- it's fairly lengthy, but has some intuitive unit tests. This interpretation
of tags is hard in practice because the schema is very confusing, there are
multiple ways of mapping the same thing, people make many mistakes in practice,
etc. <!-- TODO, list some examples like cycleway:left:separator:right. --></p>
<figure>
  <a href="tech/map/geometry/tags_to_lane_specs.png" target="_blank"><img src="tech/map/geometry/tags_to_lane_specs.png"/></a>
  <figcaption>A very simple example of OSM tags on the left, and
on the right, A/B Street's interpretation of each lane, ordered from the left
side of the road.</figcaption>
</figure>
<p>So for each road, we estimate the total width based on the lane tagging. Then we
project the center line to the left and right, giving us a thickened polygon for
the entire road:</p>
<figure>
  <a href="tech/map/geometry/thickened_5.png" target="_blank"><img src="tech/map/geometry/thickened_5.png"/></a>
  <figcaption>All 5 of our roads, thickened based on the lane tagging.
The red dot is the position of the OSM node shared by these roads.</figcaption>
</figure>
<h4 id="projecting-a-polyline"><a class="header" href="#projecting-a-polyline">Projecting a polyline</a></h4>
<p>Before we move on, a quick primer on how to take a polyline (an ordered list of
points) and project it to the left or right. For a much better explanation, see
<a href="https://wwwtyro.net/2019/11/18/instanced-lines.html">part 1</a> and
<a href="https://wwwtyro.net/2021/10/01/instanced-lines-part-2.html">2</a> from Rye
Terrell's blog. I wouldn't call A/B Street's
<a href="https://github.com/a-b-street/abstreet/blob/91c152c123924d7b8bfa14722d18c652d7e42966/geom/src/polyline.rs#L435">implementation</a>
fantastic, but it's there for reference.</p>
<figure>
  <a href="tech/map/geometry/project_pt1.png" target="_blank"><img src="tech/map/geometry/project_pt1.png"/></a>
</figure>
<p>The original polyline is in black. If you can't tell from my quick drawing, it
consists of 3 line segments glued together. We want to shift it to the right
some distance. We start by taking each line segment and projecting it to the
right that distance. That operation is simple -- rotate the line's angle by 90
degrees, then project the line's endpoints that direction. The 3 projected line
segments are shown in blue, green, and red.</p>
<p>There are two types of problems we need to fix for the new polyline to be glued
together nicely. The blue and the green line segment intersect each other, so
we'll trim both segments to that common point:</p>
<figure>
  <a href="tech/map/geometry/project_pt2.png" target="_blank"><img src="tech/map/geometry/project_pt2.png"/></a>
  <figcaption>Please forgive my horrid paint editor skills</figcaption>
</figure>
<p>The green and the red line segments are far apart. Let's imagine they keep
extending until they do intersect. If I recall proper terminology, this is a
miter join:</p>
<figure>
  <a href="tech/map/geometry/project_pt3.png" target="_blank"><img src="tech/map/geometry/project_pt3.png"/></a>
</figure>
<p>And that's it! Easy.</p>
<p>... Except not really. The real world of OSM center-lines has every imaginable
edge case. When a road is both thick and sharply angled enough, extending those
line segments until they meet works... but the hit might be very far away:</p>
<figure>
  <a href="tech/map/geometry/project_sharp.png" target="_blank"><img src="tech/map/geometry/project_sharp.png"/></a>
</figure>
<p>My workaround currently is to hardcode a maximum distance away from the original
line endpoints. If our miter cap reaches beyond that, just draw a straight line
between the two segments. I think this is known as a bevel join.</p>
<p>Just for fun, let's see what happens when a polyline doubles back on itself in
some less-than-realistic ways:</p>
<figure>
  <a href="tech/map/geometry/project_lovecraftian.gif" target="_blank"><img src="tech/map/geometry/project_lovecraftian.gif"/></a>
</figure>
<p>Truly Lovecraftian geometry. I don't think I often see points from OSM totally
out of order like this, but it happens sometimes and is immediately obvious.</p>
<h3 id="part-2-counting-coup"><a class="header" href="#part-2-counting-coup">Part 2: Counting coup</a></h3>
<p>For each road, we've got the original center from OSM and our calculated the
left and right side:</p>
<figure>
  <a href="tech/map/geometry/coup_pt1.png" target="_blank"><img src="tech/map/geometry/coup_pt1.png"/></a>
  <figcaption>The left and right sides of the 5 roads are shown -- not the
original centers. I manually traced this; slight errors are visible.</figcaption>
</figure>
<p>Now the magic happens. You'll notice that many of those polylines collide (For
sanity, let's call these &quot;collisions&quot; and not &quot;intersections&quot;, since that term
is overloaded here!). Let's find every collision point:</p>
<figure>
  <a href="tech/map/geometry/coup_pt2.png" target="_blank"><img src="tech/map/geometry/coup_pt2.png"/></a>
  <figcaption>Collisions drawn as black dots</figcaption>
</figure>
<p>These collisions represent where two thickened roads overlap. So let's use them
to &quot;trim back&quot; the roads and avoid overlap. For each collision, we form an
infinitely long line perpendicular to the collision and find where it hits the
original center-line. We'll trim the road back to at least that point.</p>
<figure>
  <a href="tech/map/geometry/coup_pt3.png" target="_blank"><img src="tech/map/geometry/coup_pt3.png"/></a>
  <figcaption>The red road's original center is now shown, in a darker red.
The collision between the red and green road is shown, with a yellow line used
to find the position along the original center. We'll trim the center back to
this point, at least.</figcaption>
</figure>
<p>Because we want roads to meet intersections perpendiculously (I'm quite sure
that's the proper term), we want the left and right side of a road to line up.
There's probably a collision on a road's left and right side, and usually one of
them would cause the center-line to be trimmed back more than the other. We'll
always trim back as much as possible.</p>
<figure>
  <a href="tech/map/geometry/coup_pt4.png" target="_blank"><img src="tech/map/geometry/coup_pt4.png"/></a>
  <figcaption>The collision between the red and blue road is shown in
yellow. The corresponding position on the original red road's center line is
found, then trimmed back.</figcaption>
</figure>
<p>If we repeat this for every collision, eventually we wind up with:</p>
<figure>
  <a href="tech/map/geometry/coup_final.png" target="_blank"><img src="tech/map/geometry/coup_final.png"/></a>
  <figcaption>All roads have been trimmed back, with their left and right
sides projected again</figcaption>
</figure>
<p>Some questions to consider:</p>
<ol>
<li>
<p>Why look for collisions between every pair of left/right lines? Couldn't we
just use the &quot;adjacent&quot; pairs?</p>
</li>
<li>
<p>Is it ever possible for the line perpendicular to a collision to NOT hit the
original center-line?</p>
</li>
</ol>
<p>(As I'm reviewing my old code and writing this up, these're things I don't
remember, worth revisiting.)</p>
<h3 id="part-3-the-clockwise-walk"><a class="header" href="#part-3-the-clockwise-walk">Part 3: The clockwise walk</a></h3>
<p>We've now trimmed roads back to avoid overlapping each other. We just need to
generate the polygon for the intersection. As a first cut, let's take these
trimmed center-lines, calculate the left and right polylines again (since we've
changed the center line), and use the endpoints for the shape.</p>
<figure>
  <a href="tech/map/geometry/clockwise_naive.png" target="_blank"><img src="tech/map/geometry/clockwise_naive.png"/></a>
  <figcaption>The red polygon is the intersection shape formed from
these endpoints. The pink portions don't look right!</figcaption>
</figure>
<p>Oops, the polygon covers a bit too much space! Cut red tape, queues, and split
ends, but not corners. What if we remember all of the collision points, and use
those too?</p>
<figure>
  <a href="tech/map/geometry/clockwise_better.png" target="_blank"><img src="tech/map/geometry/clockwise_better.png"/></a>
</figure>
<p>Much better.</p>
<h4 id="sorting-roads-around-a-center"><a class="header" href="#sorting-roads-around-a-center">Sorting roads around a center</a></h4>
<p>I snuck a fast one on ya. When we form a polygon from these left/right endpoints
and the original collision points, how do we put those points in the correct
order? Seemingly innocent question.</p>
<p>There are a few approaches that work fine for the simple cases. First, from OSM
we know the single point where the 5 road center lines meet. After we've
calculated the points for the intersection polygon, we can use that single
point, calculate the angle to each polygon point, and sort. That works fine.</p>
<figure>
  <a href="tech/map/geometry/sorting_orig_center.png" target="_blank"><img src="tech/map/geometry/sorting_orig_center.png"/></a>
  <figcaption>The road center-lines all meet at one point, from
the original OSM data.</figcaption>
</figure>
<p>Foreshadowing: But soon, things won't be so simple.</p>
<h2 id="interlude-problems-so-far"><a class="header" href="#interlude-problems-so-far">Interlude: problems so far</a></h2>
<p>That wasn't actually so bad! The results are reasonable in many cases:</p>
<figure>
  <a href="tech/map/geometry/good1.png" target="_blank"><img src="tech/map/geometry/good1.png"/></a>
  <figcaption>The curve that resembles a rail-road track is a light rail line, located beneath the road; it doesn't affect the intersection geometry here.
</figure>
<figure>
  <a href="tech/map/geometry/good2.png" target="_blank"><img src="tech/map/geometry/good2.png"/></a>
</figure>
<figure>
  <a href="tech/map/geometry/good3.png" target="_blank"><img src="tech/map/geometry/good3.png"/></a>
</figure>
<p>But what kind of things go wrong?</p>
<h3 id="funky-sidewalks"><a class="header" href="#funky-sidewalks">Funky sidewalks</a></h3>
<p>What's going on with the sidewalk in that last example?</p>
<figure>
  <a href="tech/map/geometry/sidewalk_corners.gif" target="_blank"><img src="tech/map/geometry/sidewalk_corners.gif"/></a>
</figure>
<h3 id="lovecraftian-geometry"><a class="header" href="#lovecraftian-geometry">Lovecraftian geometry</a></h3>
<p>Sometimes followers of Cthulu edit OSM, I assume.</p>
<figure>
  <a href="tech/map/geometry/lovecraft1.png" target="_blank"><img src="tech/map/geometry/lovecraft1.png"/></a>
  <figcaption>What... is happening here?</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/lovecraft2.png" target="_blank"><img src="tech/map/geometry/lovecraft2.png"/></a>
  <figcaption>Even the thickened roads, before calculating intersection
polygons, look broken.</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/lovecraft3.png" target="_blank"><img src="tech/map/geometry/lovecraft3.png"/></a>
  <figcaption>Before I can investigate, somebody has already fixed the
problem upstream in OSM!</figcaption>
</figure>
<!-- I think there are cases where two thick roads overlap, but don't share an intersection. -->
<h3 id="bad-osm-data"><a class="header" href="#bad-osm-data">Bad OSM data</a></h3>
<p>Often times, the upstream OSM data is just flat-out wrong. Center lines for
divided one-way roads are way too close to each other, so using the number of
lanes with a reasonable guess at width produces roads that overlap outside of
the intersection. This throws off everything we've done!</p>
<figure>
  <a href="tech/map/geometry/smushed.png" target="_blank"><img src="tech/map/geometry/smushed.png"/></a>
</figure>
<p>Another example is people tagging the lane count incorrectly. A common problem
when splitting a bidirectional road into two one-ways (which is what you're
supposed to do when there's physical separation like a median) is forgetting to
change the lane count.
<a href="https://www.openstreetmap.org/changeset/111311212">Here's</a> a recent example,
where <code>sidewalk=both</code> was copied when a bidirectional road was split into
divided one-ways.</p>
<p>An important lesson when trying to write algorithms using OSM data: there's a
balance between making your code robust to problems in the data, and trying to
fix everything upstream. I attempt a compromise. It's a virtuous cycle -- in
trying to use OSM data in this new way, I wind up fixing the data sometimes.</p>
<h3 id="highway-onoff-ramps"><a class="header" href="#highway-onoff-ramps">Highway on/off-ramps</a></h3>
<p>When three nearly parallel roads meet, our algorithm is a bit over-eager with
the size of the intersection:</p>
<figure>
  <a href="tech/map/geometry/ramp1.png" target="_blank"><img src="tech/map/geometry/ramp1.png"/></a>
</figure>
<p>This case isn't even a real &quot;intersection&quot; -- a one-way highway has two
different off-ramps jut out. At some point, I had some scribbled diagrams in a
notebook somewhere from when I worked on this, but it's lost -- luckily the
<a href="https://github.com/a-b-street/abstreet/blob/e2fc59a31aa043a879a372b2350b1f42391ee740/map_model/src/make/initial/geometry.rs#L434">code for this case</a>
is pretty simple. This produces much better results here:</p>
<figure>
  <a href="tech/map/geometry/ramp2.png" target="_blank"><img src="tech/map/geometry/ramp2.png"/></a>
</figure>
<p>OSM has a
<a href="https://wiki.openstreetmap.org/wiki/Proposed_features/placement">placement</a> tag
that may also be useful here.</p>
<h2 id="intersection-consolidation"><a class="header" href="#intersection-consolidation">Intersection consolidation</a></h2>
<p>The skeptical reader has noticed the suspicious lack of complex intersections so
far. Time to dive into that.</p>
<h3 id="where-short-roads-conspire"><a class="header" href="#where-short-roads-conspire">Where short roads conspire</a></h3>
<p>In OSM, roads with opposite directions of traffic separated by any sort of
center median -- even if it's just a small raised curb -- are mapped as two
parallel one-way roads. These're also called divided highways or dual
carriageways. When these intersect, we wind up with lots of short &quot;road
segments&quot; and several intersections all clustered together:</p>
<figure>
  <a href="tech/map/geometry/divided_simple.png" target="_blank"><img src="tech/map/geometry/divided_simple.png"/></a>
  <figcaption>The simplest case: the east/west road is a pair of
one-ways, and the north/south is a regular road without a median</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/divided_angle.png" target="_blank"><img src="tech/map/geometry/divided_angle.png"/></a>
  <figcaption>In case you were hoping these situations always happened
at nice 90 degree angles, think again</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/divided_join.png" target="_blank"><img src="tech/map/geometry/divided_join.png"/></a>
  <figcaption>Sometimes one dual carriageway joins back as a regular
bidirectional road just before intersecting another dual carriageway...</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/divided_streetcar.png" target="_blank"><img src="tech/map/geometry/divided_streetcar.png"/></a>
  <figcaption>Why not 4 parallel one-way roads? Can't forget
street cars!</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/divided_taipei.png" target="_blank"><img src="tech/map/geometry/divided_taipei.png"/></a>
  <figcaption>And every time I think I might've handled most cases,
I'm humbled by Taipei.</figcaption>
</figure>
<p>But wait, there's more. How about &quot;dog-leg&quot; intersections, where one road shifts
over slightly as it crosses another?</p>
<figure>
  <a href="tech/map/geometry/dogleg_alley.png" target="_blank"><img src="tech/map/geometry/dogleg_alley.png"/></a>
  <figcaption>The not-at-all elusive alley dog-leg</figcaption>
</figure>
<p>But sometimes something looking like a dog-leg actually isn't -- if vehicles can
legitimately stop and queue in the middle of the &quot;intersection&quot;, even if it's
only one or two of them, then I think that interior &quot;road&quot; deserves to remain
separate:</p>
<figure>
  <a href="tech/map/geometry/dogleg_false.png" target="_blank"><img src="tech/map/geometry/dogleg_false.png"/></a>
</figure>
<p>And then there's just the cases where I'm pretty sure civil engineers
anticipated me writing this algorithm, and found the most obnoxious angles for
roads to meet in order to maximize my pain:</p>
<figure>
  <a href="tech/map/geometry/boston_merge.png" target="_blank"><img src="tech/map/geometry/boston_merge.png"/></a>
</figure>
<h3 id="why-we-want-to-do-something-about-it"><a class="header" href="#why-we-want-to-do-something-about-it">Why we want to do something about it</a></h3>
<p>So hold up, what's the problem? Some areas that people treat as one physical
intersection in reality are modelled in OSM as a cluster of intersections, with
lots of short &quot;roads&quot; linking them together. It's fine from a graph connectivity
and routing perspective. What could go wrong?</p>
<p>Well for starters, with the algorithm described so far that tries to render the
physical shape, it's completely visually incomprehensible:</p>
<figure>
  <a href="tech/map/geometry/hard_to_see.png" target="_blank"><img src="tech/map/geometry/hard_to_see.png"/></a>
  <figcaption>The 4 "interior" intersections here even get stop signs
placed!</figcaption>
</figure>
<p>These complicated intersections are often the ones that would be the most
interesting to study in A/B Street, but just try modifying lanes in these cases:</p>
<figure>
  <a href="tech/map/geometry/edit_transit.png" target="_blank"><img src="tech/map/geometry/edit_transit.png"/></a>
  <figcaption>Considering a bus lane for the 520 off-ramp at Montlake?</figcaption>
</figure>
<p>Now throw traffic signals into the mix. A/B Street tries to simulate those, so
when we have a cluster of two or four of them super close, now we have to
somehow try to synchronize their timing. When somebody wants to edit them, now
they have to operate on all of them at once! We even extended the UI to handle
that, but it's quite a poor editing experience.</p>
<figure>
  <a href="tech/map/geometry/edit_one.png" target="_blank"><img src="tech/map/geometry/edit_one.png"/></a>
  <figcaption>Reasoning about 4 separate pieces of one traffic signal is
not pleasant</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/edit_multiple.png" target="_blank"><img src="tech/map/geometry/edit_multiple.png"/></a>
  <figcaption>We can do slightly better by editing all 4 at once, but
what do those movement arrows in the middle even mean? You have to reason about
where vehicles might've come from to even get there.</figcaption>
</figure>
<p>And finally, traffic simulation gets MUCH harder. A/B Street models vehicles as
having some length, meaning a vehicle's front can make it through one
intersection, but its tail gets stuck there:</p>
<figure>
  <a href="tech/map/geometry/tails.png" target="_blank"><img src="tech/map/geometry/tails.png"/></a>
  <figcaption>These two cars are blocking all movements through the pair of
intersections</figcaption>
</figure>
<p>At the simulation layer, vehicles moving through an intersection conflict with
each other very coarsely. If a vehicle is partially stuck in the intersection,
it prevents other vehicles from starting potentially conflicting turns. So to
prevent this problem from happening, the simulation has complicated rules so
that vehicles do not &quot;block the box&quot; -- if they enter an intersection, they must
be guaranteed to fully exit and clear it, not get stuck somewhere in the middle.
These rules blow up in the presence of short roads like this. Lots of effort has
gone into workarounds at the simulation layer, but... just fixing the
representation in the map model seems much more desirable.</p>
<h3 id="goal"><a class="header" href="#goal">Goal</a></h3>
<p>In reality, many of these clusters of intersections and short roads are actually
just one &quot;logical&quot; intersection. If you consider where vehicles stop or where
crosswalks are placed, this can make this definition a little bit more clear,
but it's somewhat subjective. In A/B Street, we aim to &quot;consolidate&quot; this
cluster into just one intersection. Visually coherent geometry, reasoning about
a single traffic signal, and preventing vehicles from getting stuck in the
cluster are the goals.</p>
<p>Before we dive into the approach to consolidate, let's look at some success
stories.</p>
<figure>
  <a href="tech/map/geometry/better_streetcar.png" target="_blank"><img src="tech/map/geometry/better_streetcar.png"/></a>
  <figcaption>A single intersection handles the 4 parallel OSM
ways.</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/better_tsigs.png" target="_blank"><img src="tech/map/geometry/better_tsigs.png"/></a>
  <figcaption>You can now edit the signal timing as if this is just a
regular massive Arizona intersection.</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/better_angled.png" target="_blank"><img src="tech/map/geometry/better_angled.png"/></a>
  <figcaption>The angled cut is a bit too aggressive and the crosswalk
"leaks" out, but this is a definite improvement.</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/better_montlake.png" target="_blank"><img src="tech/map/geometry/better_montlake.png"/></a>
  <figcaption>Four intersections become one, again with a slight
geometric distortion</figcaption>
</figure>
<h3 id="a-solution-two-passes"><a class="header" href="#a-solution-two-passes">A solution: two passes</a></h3>
<p>For some history getting to this point, check out
<a href="https://github.com/a-b-street/abstreet/issues/654">previous attempts</a> and
<a href="https://github.com/a-b-street/abstreet/pull/710">more before/after examples</a>.</p>
<p>Consolidating a complex intersection happens in a few steps.</p>
<ol>
<li>Identify the short roads</li>
<li>Run the regular algorithm for intersection geometry, and remember how much
each road's center line gets trimmed back</li>
<li>Remove the short road and fix up graph connectivity</li>
<li>Use the &quot;pre-trimmed&quot; center line to project each surviving road to the left
and right</li>
<li>Assemble those points in order to create the consolidated intersection's
polygon</li>
</ol>
<p>Step 1 and 5 are covered in more detail in below sections.</p>
<p>For step 2, we start with the regular algorithm described so far, applied to
each intersection:</p>
<figure>
  <a href="tech/map/geometry/consolidate_pt1.png" target="_blank"><img src="tech/map/geometry/consolidate_pt1.png"/></a>
  <figcaption>The results of running the algorithm on the 2 green
intersections. The pink road in the middle is marked for merging.</figcaption>
</figure>
<p>Then we delete the short road. The
<a href="https://github.com/a-b-street/abstreet/blob/c5671557defbd80ce749b8fa7faf7c166b3d23dd/map_model/src/raw.rs#L300">details</a>
of how this is done are particular to A/B Street's intermediate representation
of a map model. Graph connectivity and all sorts of turn restrictions must be
preserved. But geometrically, it just looks like this:</p>
<figure>
  <a href="tech/map/geometry/consolidate_pt2.png" target="_blank"><img src="tech/map/geometry/consolidate_pt2.png"/></a>
</figure>
<p>Then we run step 4, finding the left and right side of each surviving road:</p>
<figure>
  <a href="tech/map/geometry/consolidate_pt3.png" target="_blank"><img src="tech/map/geometry/consolidate_pt3.png"/></a>
  <figcaption>Black lines show the left and right side of each road.
The red dots are the endpoints of each line.</figcaption>
</figure>
<p>Now if we just use those red dots, we can create the final polygon for this
consolidated intersection.</p>
<h3 id="sorting-revisited"><a class="header" href="#sorting-revisited">Sorting revisited</a></h3>
<p>To assemble the endpoints into a polygon, we need to know what order they go in.
If you recall from an earlier section, we used the original shared point from
OSM as the center, and the point farthest away from that shared point to do
this:</p>
<figure>
  <a href="tech/map/geometry/sorting_orig_center.png" target="_blank"><img src="tech/map/geometry/sorting_orig_center.png"/></a>
</figure>
<p>But now things are less clear -- we have multiple shared points, from before
consolidation. As a first pass, maybe we can just average all of the original
shared OSM points and call that the &quot;center.&quot; And since we've already trimmed
back the roads around the complex junction, we can use that point to determine
order.</p>
<figure>
  <a href="tech/map/geometry/sorting_complex.png" target="_blank"><img src="tech/map/geometry/sorting_complex.png"/></a>
  <figcaption>The center is the average of all the original intersection nodes from OSM. Since the first pass trimmed th roads back for each of these nodes, we can use that point to calculate an angle to the center and get a clockwise ordering.</figcaption>
</figure>
<p>But let's imagine we didn't use that pre-trimmed point, and still used the point
farthest from the shared center, like we do for the first pass. Sometimes that
can break down!</p>
<figure>
  <a href="tech/map/geometry/sorting_inversion.png" target="_blank"><img src="tech/map/geometry/sorting_inversion.png"/></a>
  <figcaption>Two roads are on the east side of the green intersection. They start out roughly parallel, but curve and are split on the other end at different distances. The purple lines show the angle to the green intersection's center. The ordering of the two roads is switched if we use these purple lines to calculate angle!</figcaption>
</figure>
<p>What happens when we get the ordering of roads wrong? The polygon will loop back
on itself, looking like a bowtie:</p>
<figure>
  <a href="tech/map/geometry/sorting_bowtie.png" target="_blank"><img src="tech/map/geometry/sorting_bowtie.png"/></a>
</figure>
<p><a href="https://www.baeldung.com/cs/sort-points-clockwise">This article</a> has a clever
idea to break ties using distance from the center.</p>
<h3 id="finding-the-short-roads"><a class="header" href="#finding-the-short-roads">Finding the short roads</a></h3>
<p>The algorithm described relies on knowing short roads to merge. Conveniently,
there's a proposed OSM tag
<a href="https://wiki.openstreetmap.org/wiki/Proposed_features/junction%3Dintersection">junction=intersection</a>
that describes road segments that're physically located in the interior of
intersections. So far, I've been manually tagging this and using it as the
trigger to merge a junction. But of course, ideally heuristics would instead
discover these cases automatically.</p>
<p>The simplest start is to just define a threshold, like 5 meters, and try to
merge any road shorter than that. The road's original length could be used, or
-- perhaps more usefully -- we can first generate intersections normally and use
the trimmed road length. After merging a short road, perhaps some other ones
nearby change their trimmed length, so merging should happen in a fixed-point
loop, until no road has changed.</p>
<p>So far, I haven't made good progress with
<a href="https://github.com/a-b-street/abstreet/blob/14ce21c80dc0d7f2b1ac69c988f10e2dd14f17e0/map_model/src/make/merge_intersections.rs">this heuristic</a>.
Merging happens in too many places, or in a strange order, and causes assertion
failures. Much of the time, this exposes actual bugs, but exposing dozens at a
time is hard to handle, so that's why the slower approach of manually opting in
a few intersections to merging still remains.</p>
<p>In the spirit of a more gradual rollout of merging code, I've also attempted
heuristics just focused on common patterns of complex junctions with 2 or 4
pieces, resulting from one or two divided highways crossing. Sometimes just
looking for two or four traffic signal nodes close to each other reveals really
complex situations that break:</p>
<figure>
  <a href="tech/map/geometry/heuristic_loop101.png" target="_blank"><img src="tech/map/geometry/heuristic_loop101.png"/></a>
</figure>
<h3 id="phantom-collisions"><a class="header" href="#phantom-collisions">Phantom collisions</a></h3>
<p>There's a particularly insidious edge case not handled yet:</p>
<figure>
  <a href="tech/map/geometry/phantom_collision.gif" target="_blank"><img src="tech/map/geometry/phantom_collision.gif"/></a>
  <figcaption>The south road is connected to the left intersection in OSM's graph. But based on the geometry inferred for the two separate intersections, this road actually collides with the right intersection as well.
</figure>
<p>How could we handle this? Is it necessary to consider collisions between roads
one or two hops away in the graph, in case they might be thick enough to
interfere?</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>Given how much time I've sunk into automatically generating decent geometry from
an OSM schema absolutely not meant for this, I hope you don't fault me for
wanting to try some radically different ideas. There've been some OSM proposals
over the years to just explicitly draw roads and intersections as areas -- the
<a href="https://wiki.openstreetmap.org/wiki/Proposed_features/Street_area">street area</a>
and
<a href="https://wiki.openstreetmap.org/wiki/Proposed_features/area_highway/mapping_guidelines">area:highway</a>
pages describe these ideas the best. These proposals don't seem to have caught
on, but I think they're worth an attempt.</p>
<p>I've also toyed around with designing a schema to map roads and intersections
from scratch, but that's an article to write on a rainier day...</p>
<h2 id="appendices"><a class="header" href="#appendices">Appendices</a></h2>
<h3 id="related-work"><a class="header" href="#related-work">Related work</a></h3>
<p>I've found a few other active projects aiming to render details about lanes:</p>
<ul>
<li><a href="https://github.com/enzet/map-machine">https://github.com/enzet/map-machine</a></li>
<li><a href="http://blog.imagico.de/navigating-the-maze-part-1/">http://blog.imagico.de/navigating-the-maze-part-1/</a> (and don't miss part 2!)</li>
<li><a href="https://github.com/BjornRasmussen/Lanes">https://github.com/BjornRasmussen/Lanes</a> (there are some nice demos in the
OSMUS Slack somewhere)</li>
<li><a href="https://supaplexosm.github.io/strassenraumkarte-neukoelln/?map=micromap#20/52.48535/13.42666">micro-map of Neuklln in Berlin</a>,
see
<a href="https://supaplexosm.github.io/strassenraumkarte-neukoelln/posts/2021-07-18-strassenraumkarte">this blog</a>
for an introduction</li>
</ul>
<h3 id="tricks-and-tooling"><a class="header" href="#tricks-and-tooling">Tricks and tooling</a></h3>
<p>Iterating quickly on these algorithms and preventing regressions are often at
odds. These are some parts of my development workflow that help balance a bit.</p>
<p>First, how do you automatically test this? Expressing properties about the
output -- like no road and intersection polygons should overlap -- would be a
start, but it's a tough standard to reach. It's easy for a human to subjectively
judge output and spot regressions. So, screenshot diff-testing it is! For a
select few maps, I
<a href="https://github.com/a-b-street/abstreet/blob/master/widgetry/src/tools/screenshot.rs">take a bunch of screenshots</a>
covering the whole map and store them as &quot;golden-files.&quot; After importing new OSM
data or changing the code, I take more screenshots, then automatically compare
them with
<a href="https://github.com/a-b-street/abstreet/blob/master/game/compare_screencaps.sh">imagemagick's compare</a>
tool and manually inspect any differences.</p>
<p>The
<a href="https://github.com/a-b-street/abstreet/tree/master/map_editor/">RawMap editor</a>
serves as an interactive tool for quickly adjusting the input -- what if this
road center-line curved less sharply, what if the width implied by tags was a
little different, what if this road was marked for merging? But at the same
time, just previewing the intersection geometry doesn't reveal all problems --
sometimes the turns generated at a consolidated intersection are wrong, or the
traffic signal heuristic turns out poorly. The full A/B Street UI already has
tools to explore these things. So this UI also has a mode to load a second map
and quickly flip between the two:</p>
<figure>
  <a href="tech/map/geometry/compare_ui.gif" target="_blank"><img src="tech/map/geometry/compare_ui.gif"/></a>
</figure>
<p>Something I've always wanted is an interactive debugger -- the ability to step
through the code, print things, and more importantly, dump some kind of extra
output files to visualize intermediate shifted polylines or something. I've
never figured out an IDE setup for this, but it'd be very worthwhile.</p>
<h3 id="hall-of-lovecraftian-horrors"><a class="header" href="#hall-of-lovecraftian-horrors">Hall of Lovecraftian horrors</a></h3>
<p>Here's my list of stress test cases. Avert your eyes...</p>
<figure>
  <a href="tech/map/geometry/better_montlake.png" target="_blank"><img src="tech/map/geometry/better_montlake.png"/></a>
  <figcaption><a href="https://www.openstreetmap.org/node/3391701883" target="_blank">Montlake/520</a> in Seattle. I happened to live close to this intersection when I started A/B Street, so it holds a special place. And as of September 2021, it's been dramatically changed in real life and in OSM, so this rendering is now out-of-date and has probably blown up again.</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/nickerson.png" target="_blank"><img src="tech/map/geometry/nickerson.png"/></a>
  <figcaption>The confluence of <a href="https://www.openstreetmap.org/node/53128122" target="_blank">Nickerson, Dexter, Westlake, and the Fremont Bridge</a> in Seattle. We've got tiny road segments, a cycletrack that starts off parallel to the road but splits off, and a complete lack of 90 degree angles.</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/triangle_doom.png" target="_blank"><img src="tech/map/geometry/triangle_doom.png"/></a>
  <figcaption>The triangle of doom: <a href="https://www.openstreetmap.org/node/1884382823" target="_blank">Lenora and Westlake</a> in Seattle. Try synchronizing the 3 traffic signals!</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/dublin.png" target="_blank"><img src="tech/map/geometry/dublin.png"/></a>
  <figcaption>Let's not let the USA have all the fun. Here's <a href="https://www.openstreetmap.org/node/3594434240" target="_blank">Custom House Quay and the Talbot Memorial Bridge</a> in Dublin. A divided highway overlapping itself and some cycleways.</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/taipei.png" target="_blank"><img src="tech/map/geometry/taipei.png"/></a>
  <figcaption>Loads of the junctions in <a href="https://www.openstreetmap.org/node/1505012053" target="_blank">
Taipei</a> look like this. Two parallel one-ways isn't hard enough; we need at least six.</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/chorlton_traffic.jpeg" target="_blank"><img src="tech/map/geometry/chorlton_traffic.jpeg"/></a>
  <figcaption>And how about <a href="https://www.openstreetmap.org/node/31287523" target="_blank">Chester Road and Kingsway</a> with some gridlocked traffic?</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/loop101.png" target="_blank"><img src="tech/map/geometry/loop101.png"/></a>
  <figcaption>And finally, the eerie symmetry of <a href="https://www.openstreetmap.org/node/760159861" target="_blank">Arizona freeways</a>.</figcaption>
</figure>
<h3 id="a-radically-simpler-approach"><a class="header" href="#a-radically-simpler-approach">A radically simpler approach?</a></h3>
<p>I think many people's first instinct to solve the problem of forming an
intersection polygon from thickened roads is to use boolean operations. Just
find the intersection between all of the road polygons. Or maybe, find the
intersection between any pair of road polygons, then union all of those pieces.</p>
<p>Early on, I tried some variations of this. One difficulty was a lack of a robust
boolean geometry library in Rust, but if bindings to a native GEOS library were
acceptable, maybe this was possible. But also, this simple idea doesn't work for
three-way intersections:</p>
<figure>
  <a href="tech/map/geometry/three_way_overlap.png" target="_blank"><img src="tech/map/geometry/three_way_overlap.png"/></a>
  <figcaption>The horizontal road partly intersects the two
vertical roads (shown in red), but doesn't extend to cover enough of the
intersection.</figcaption>
</figure>
<p>The two vertical road pieces don't even intersect at all, except right at their
boundary. We'd need to special-case that, at least.</p>
<h3 id="other-data-sources"><a class="header" href="#other-data-sources">Other data sources</a></h3>
<p>I've come across a few cities that seem to have a vector dataset describing road
polygons or curbs. I haven't tried working with any of these before, but it
would be a useful exercise to start with one of these as the base, and snap OSM
road segments to this to get metadata about lanes and connectivity, but not
geometry.</p>
<ul>
<li><a href="https://streetsillustrated.seattle.gov/map/">Seattle Streets Illustrated</a>
includes some kind of CAD basemap that looks amazingly realistic
<ul>
<li>From some old emails with King County GIS, this is based on an impervious
surface layer with a license preventing it from being released as public
data</li>
</ul>
</li>
<li>Actually, <a href="https://data.seattle.gov/dataset/Pavement-Edge-zip/gy82-cq84">https://data.seattle.gov/dataset/Pavement-Edge-zip/gy82-cq84</a>
appears to be the curbs for Seattle! Possibly the data is from 1999, updated
maybe in 2011.</li>
<li><a href="https://distanciamiento.inspide.com">https://distanciamiento.inspide.com</a> appears to have detailed sidewalk
polygons for Madrid</li>
</ul>
<figure>
  <a href="tech/map/geometry/streets_illustrated.png" target="_blank"><img src="tech/map/geometry/streets_illustrated.png"/></a>
  <figcaption>The Fremont bridge and Nickerson looks fantastic
in Seattle Streets Illustrated, but the data isn't public</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/pavement_edge.png" target="_blank"><img src="tech/map/geometry/pavement_edge.png"/></a>
  <figcaption>The pavement edge dataset is public, though, and seems
to be quite similar!</figcaption>
</figure>
<figure>
  <a href="tech/map/geometry/pullman.png" target="_blank"><img src="tech/map/geometry/pullman.png"/></a>
  <figcaption>Pullman, WA provided sidewalk polygons for mapping in OSM</figcaption>
</figure>
<p>These vector datasets feel like some sort of holy grail, but all of the work
described in this article is still useful, because:</p>
<ol>
<li>Not every city has this kind of public data</li>
<li>If road edits need to legitimately widen or shrink a road, it's not obvious
how to modify these curbs. But then again, just rechannelizing lanes,
subject to the area that's already been paved, is kind of the main type of
edit in A/B Street...</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="map-model-details"><a class="header" href="#map-model-details">Map model details</a></h1>
<p>A/B Street builds a rich representation of a city map using OpenStreetMap (OSM)
and other sources. This chapter describes how.</p>
<p>TODO: Integrate pictures from
<a href="https://docs.google.com/presentation/d/1cF7qFtjAzkXL_r62CjxBvgQnLvuQ9I2WTE2iX_5tMCY/edit?usp=sharing">these slides</a>.</p>
<p><a href="https://youtu.be/chYd5I-5oyc?t=439">This recorded presentation</a> covers some of
this.</p>
<h2 id="the-map"><a class="header" href="#the-map">The map</a></h2>
<p>A single city is broken down into different pieces...</p>
<p>A/B Street comes with a few maps, each defined by a bounding/clipping polygon
for some portion of Seattle. Each map has these objects:</p>
<ul>
<li><strong>Roads</strong>: A single road connects two intersections, carrying OSM metadata and
containing some child lanes.</li>
<li><strong>Lanes</strong>: An individual lane of traffic. Driving (any vehicle), bus-only, and
bike-only lanes have a direction. On-street parking lanes don't allow any
movement, and they have some number of parking spots. Sidewalks are
bidirectional.</li>
<li><strong>Intersections</strong>: An intersection has references to all of the incoming and
outgoing lanes. Most intersections have a stop sign or traffic signal policy
controlling movement through it.
<ul>
<li><strong>Border</strong> intersections on the edge of the map are special places where
agents may appear or disappear.</li>
</ul>
</li>
<li><strong>Turns</strong>: A turn connects one lane to another, via some intersection.
(Sidewalks are bidirectional, so specifying the intersection is necessary to
distinguish crosswalks at each end of a sidewalk.)</li>
<li><strong>Buildings</strong>: A building has a position, OSM metadata, and a <strong>front path</strong>
connecting the edge of the building to the nearest sidewalk. Most trips in A/B
Street begin and end at buildings. Some buildings also contain a number of
off-street parking spots.</li>
<li><strong>Area</strong>: An area has geometry and OSM metadata and represents a body of
water, forest, park, etc. They're just used for drawing.</li>
<li><strong>Bus stop</strong>: A bus stop is placed some distance along a sidewalk, with a
pointer to the position on the adjacent driving or bus lane where a bus stops
for pick-up.</li>
<li><strong>Bus route</strong>: A bus route has a name and a list of stops that buses will
cycle between. In the future, they'll include information about the
frequency/schedule of the route.</li>
<li><strong>Parking lot</strong>: A parking lot is connected to a road, has a shape, and has
some internal driving &quot;aisles.&quot; The number and position of individual parking
spots is auto-generated.</li>
</ul>
<h2 id="coordinate-system"><a class="header" href="#coordinate-system">Coordinate system</a></h2>
<p>A/B Street converts (longitude, latitude) coordinates into a simpler form.</p>
<ul>
<li>An (x, y) point starts with the top-left of the bounding polygon as the
origin. Note this is screen drawing order, not a Cartesian plane (with Y
increasing upwards) -- so angle calculations account for this.</li>
<li>The (x, y) values are f64's trimmed to a few decimal places, with way more
precision than is really needed. These might become actual fixed-point
integers later, but for now, a <code>Pt2D</code> skirts around Rust's limits on f64's by
guaranteeing no NaN's or infinities and thus providing the full <code>Eq</code> trait.</li>
<li>A few places in map conversion compare points using different thresholds,
usually below 1 meter. Ideally these epsilon comparisons could be eliminated
in favor of a fixed-point integer representation, but for now, explicit
thresholds are useful.</li>
</ul>
<h2 id="invariants"><a class="header" href="#invariants">Invariants</a></h2>
<p>Ideally, the finalized maps would satisfy a list of invariants, simplifying the
traffic simulation and drawing code built on top. But the input data is quite
messy and for now, most of these aren't quite guaranteed to be true.</p>
<ul>
<li>Some minimum length for lanes and turns. Very small lanes can't be drawn, tend
to break intersection polygons, and may lead to gridlocked traffic.</li>
<li>Some guarantees that positions along adjacent lanes actually match up, even
though different lanes on the same road may have different lengths. Examples
include the position of a bus stop on the sidewalk and bus lane matching up.
<ul>
<li>Additionally, parking lanes without an adjacent driving lane or bus stops
without any driving or bus lanes make no sense and should never occur.</li>
</ul>
</li>
<li>Connectivity -- any sidewalk should be reachable from any other, and most
driving lanes should be accessible from any others. There are exceptions due
to border intersections -- if a car spawns on a highway along the border of
the map, it may be forced to disappear on the opposite border of the map, if
the highway happens to not have any exits within the map boundary.</li>
</ul>
<h2 id="connectivity"><a class="header" href="#connectivity">Connectivity</a></h2>
<p>For a single mode, each lane is connected to two intersections. Turns connect
two lanes. There are no turns between sidewalks and driving/bike/bus lanes.</p>
<p>All buildings and parking lots have driveways. This must connect to a sidewalk,
allowing pedestrians to enter/exit that object. The driveway OPTIONALLY connects
to the nearest driveable lane. This allows cars to enter/exit that object for
parking.</p>
<p>Public transit stops are located somewhere on a sidewalk. They're associated
with a driveable position where the bus or train stops. In the future, this will
need to account for dedicated surface-level platforms and for underground
transit stations, likely associated with a building.</p>
<p>There's a concept of &quot;parking blackholes.&quot; If you treat every road as
bidirectional without access restrictions, then the graph is connected. But the
more detailed view has to factor in one-way roads and things near the map
border. These blackholes influence where cars will try to look for parking
(since we don't want them entering a blackhole and getting stuck) and also, for
temporary/unintentional reasons, where pedestrian&lt;-&gt;bicycle transitions will
happen.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="importing"><a class="header" href="#importing">Importing</a></h1>
<p>This chapter describes the process of transforming OSM extracts into A/B
Street's map model. These are implementation details; you may be looking
<a href="tech/map/importing/../../../user/new_city.html">for the user guide to importing a new city</a>.</p>
<p>The steps are:</p>
<ol>
<li>A large .osm file is clipped to a hand-drawn boundary region, using
<code>osmconvert</code></li>
<li>The <code>convert_osm</code> crate reads the clipped <code>.osm</code>, and a bunch of optional
supplementary files, and produces a <code>RawMap</code></li>
<li>Part of the <code>map_model</code> crate transforms the <code>RawMap</code> into the final <code>Map</code></li>
<li>Other applications read and use the <code>Map</code> file</li>
</ol>
<p>The <code>importer</code> crate orchestrates these steps, along with automatically
downloading any missing input data.</p>
<p>The rest of these sections describe each step in a bit more detail. Keeping the
docs up-to-date is hard; the best reference is the code, which is hopefully
organized clearly.</p>
<p>Don't be afraid of how complicated this pipeline seems -- each step is
relatively simple. If it helps, imagine how this started -- just chop up OSM
ways into road segments, infer lanes for each road, and infer turns between the
lanes.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="from-osm-to-rawmap-convert_osm-crate"><a class="header" href="#from-osm-to-rawmap-convert_osm-crate">From OSM to RawMap (<code>convert_osm</code> crate)</a></h1>
<p>The first phase of map building reads in data from OSM files and a few others,
producing a serialized <code>RawMap</code>.</p>
<p>Only major steps are described; see the code for the rest.</p>
<h2 id="extractrs"><a class="header" href="#extractrs">extract.rs</a></h2>
<p>Read .osm, extracting the points for road-like ways, buildings, and areas</p>
<ul>
<li>Areas usually come from a relation of multiple ways, with the points out of
order. Gluing all the points together fails when the .osm has some ways
clipped out. In that case, try to trace along the map boundary if the partial
area intersects the boundary in a clear way. Otherwise, just use a straight
line to try to close off the polygon.</li>
<li>Also read traffic signal locations and turn restrictions between OSM ways</li>
</ul>
<h2 id="split_waysrs"><a class="header" href="#split_waysrs">split_ways.rs</a></h2>
<p>Split OSM ways into road segments</p>
<ul>
<li>OSM ways cross many intersections, so treat points with multiple ways and the
points at the beginning and end of a way as intersections, then split the way
into road segments between two intersections.</li>
<li>This phase remembers which road segment is the beginning and end of the OSM
way, for per-lane turn restrictions later</li>
<li>Apply turn restrictions between roads here. Since OSM ways cross many
intersections, the turn restrictions only apply to one particular road segment
that gets created from the way. Make sure the destination of the restriction
is actually incident to a particular source road.</li>
</ul>
<h2 id="clip"><a class="header" href="#clip">clip</a></h2>
<p>Clip the map to the boundary polygon</p>
<ul>
<li><code>osmconvert</code> options preserve ways that cross the boundary</li>
<li>Trim roads that cross the boundary. There may be cases where a road dips out
of bounds, then immediately comes back in. Disconnecting it isn't ideal, but
it's better to manually tune the boundary polygon when this happens than try
to preserve lots of out-of-bounds geometry.</li>
<li>Area polygons are intersected with the boundary polygon using the <code>clipping</code>
crate</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="roadintersection-geometry-rawmap-to-initialmap"><a class="header" href="#roadintersection-geometry-rawmap-to-initialmap">Road/intersection geometry: RawMap to InitialMap</a></h1>
<p>The remainder of map construction is done in the <code>map_model</code> crate. There's one
intermediate structure between <code>RawMap</code> and <code>Map</code>, called <code>InitialMap</code>.</p>
<ul>
<li><code>make/remove_disconnected.rs</code>: Remove disconnected roads
<ul>
<li>Just floodfill from some road, assuming all roads are bidirectional, to get
different partitions.</li>
<li>Remove roads from all but the largest partition</li>
</ul>
</li>
<li><code>make/initial/mod.rs</code> and <code>make/initial/lane_specs.rs</code>: Interpret OSM tags to
figure out what lanes are on each side of each road, also figuring out the
total width of the road.</li>
<li><code>make/initial/geometry.rs</code>: Figure out the polygon for each intersection, and
trim back road center-lines to end at a face of the polygon.
<ul>
<li>For every road touching the intersection, get the polyline of each side,
based on the road's width
<ul>
<li>See appendix for how to shift polylines</li>
</ul>
</li>
<li>Sort all the polylines by the angle to the intersection's shared point</li>
<li>Intersect every polyline with every other polyline
<ul>
<li>More specifically -- the second half of each polyline, to get the correct
collision point</li>
<li>Look at the perpendicular infinite line to the collision point on the
shifted polyline, then find where it hits the original center line. Trim
back the center line by the max distance from these collisions.</li>
</ul>
</li>
<li>Compute the intersection's polygon by considering collisions between
adjacent roads' polylines</li>
<li>Deal with short roads and floating point issues by deduping any adjacent
points closer than 0.1m</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="initialmap-to-map"><a class="header" href="#initialmap-to-map">InitialMap to Map</a></h1>
<p>Still in the <code>map_model</code> crate.</p>
<ul>
<li><code>map.rs</code>'s <code>make_half_map</code>: Expand roads to lanes, using the list of lane
types from before</li>
<li><code>make/turns.rs</code>: Generate turns for every intersection.
<ul>
<li>Vehicle turns (for cars, bikes, buses)
<ul>
<li>Consider every pair of roads in the intersection. Try to match up lane
types -- if there's a bike lane on both roads, don't add a turn from
driving-&gt;bike or bike-&gt;driving. If there's not, then fallback to
transitions between different lane types.</li>
<li>Classify the turn based on the difference between the angle of the
incoming lane's last line and the outgoing lane's first line
<ul>
<li>For straight turns, use the Cartesian product to link every incoming
with every outgoing lane. If the indices dont match up, the turn becomes
a <code>LaneChangeLeft</code> or <code>LaneChangeRight</code> turn. This is used later for
intersection policies to prioritize turns appropriately.</li>
<li>Right and left turns only originate from the one lane on the appropriate
side</li>
</ul>
</li>
</ul>
</li>
<li>Walking turns for pedestrians
<ul>
<li>Consider pairs of adjacent roads around the intersection
<ul>
<li>Make a crosswalk to the other side of the road, assuming there's a
sidewalk on both sides</li>
<li>Make a shared sidewalk corner over to the adjacent road</li>
<li>If the adjacent road doesn't have a sidewalk on the close side, then
consider skipping that road and making a crosswalk over to the next
road. An example of this is a crosswalk over a highway on/off ramp.</li>
</ul>
</li>
</ul>
</li>
<li>Verify all the turns so far are unique</li>
<li>Filter by the OSM turn restrictions (&quot;only straight&quot; between road1 and
road2)</li>
<li>Try to apply the OSM per-lane restrictions (&quot;straight or left&quot; from lane 3)
<ul>
<li>The number of lanes in the OSM metadata might not match up with how many
lanes created</li>
<li>Some of these OSM tags are just completely wrong sometimes. If the filter
makes an incoming lane lose all of its turns, then ignore that tag.</li>
</ul>
</li>
</ul>
</li>
<li><code>make/parking_blackholes.rs</code>: Find well-connected roads near &quot;blackhole&quot;
lanes.
<ul>
<li>Starting from most driving/biking lanes, most other lanes are reachable.
Some aren't -- such as one-way highways inevitably leading from or to a
border. These are &quot;blackholes&quot; -- pathfinding to or from here may fail.</li>
<li>Find the largest strongly-connected component (SCC) in the driving graph.
From every other lane (a blackhole), floodfill both forwards and backwards
to find the nearest driving lane part of the main SCC.</li>
<li>Later, if a car needs to park by a building on a blackhole road, it'll
instead start searching for parking at the redirect. This prevents it from
being forced to instead exit the map through a border.</li>
</ul>
</li>
<li><code>make/buildings.rs</code>: Match buildings up with sidewalks
<ul>
<li>Find the closest sidewalk polyline to each building's center. Then draw a
straight line for the front path between the edge of the building and the
sidewalk point.</li>
<li>Filter out buildings too far away from any sidewalk</li>
<li>The front path might cross through other buildings; this is probably not
worth fixing.</li>
</ul>
</li>
<li><code>make/buildings.rs</code>: Same for parking lots
<ul>
<li>Similar process to match parking lots to nearest sidewalk and driving lane</li>
<li>Try to place parking spots along both sides of parking aisles</li>
<li>Filter out overlapping spots</li>
</ul>
</li>
<li><code>make/bridges.rs</code>: Find what roads lie beneath bridges, and update their
Z-order accordingly for later drawing.</li>
<li><code>stop_signs.rs</code>: Instantiate default stop sign policies
<ul>
<li>Rank incoming roads by OSM priority (arterial beats residential)</li>
<li>If there's only one rank, then make an all-way stop</li>
<li>Otherwise, the highest rank gets priority and others stop
<ul>
<li>Check if there are any conflicts based on this. If so, then fall-back to
an all way stop.</li>
</ul>
</li>
</ul>
</li>
<li><code>traffic_signals.rs</code>: Instantiate default traffic signal policies
<ul>
<li>Apply the first predefined policy that works.
<ul>
<li>4-way 4 stage, 4-way 2 stage, 3-way 3-stage, degenerate policy for 2
roads, 2-stage for 4 one-ways</li>
<li>Fallback to a greedy assignment that just randomly starts a new stage,
adds all compatible turns, and repeats until all turns are present
priority in some stage.</li>
</ul>
</li>
</ul>
</li>
<li><code>pathfind/mod.rs</code>: Prepare pathfinding
<ul>
<li>A/B Street uses contraction hierarchies (CH) for fast routing, using the
<code>fast_paths</code> crate.</li>
<li><code>pathfind/vehicle.rs</code>: For cars, bikes, buses
<ul>
<li>There's a separate CH for cars, buses, and bikes, since they can use
slightly different sets of lanes.</li>
<li>Building the CH for buses and bikes is much faster than the one for cars,
because the algorithm can re-use the node ordering from the first CH.</li>
<li>Every lane is a node in the graph, even if it's not an appropriate lane
type -- it might change later, and reusing orderings is vital for speed.</li>
<li>If two lanes are connected by a turn, then there's an edge in the graph.
<ul>
<li>The edge weight is the length of the lane and turn. Later this could
take into account speed limit, penalize lane-changing and left turns,
etc.</li>
</ul>
</li>
</ul>
</li>
<li><code>pathfind/walking.rs</code>: For pedestrians
<ul>
<li>Only sidewalk lanes are nodes in the graph -- sidewalks can't ever be
changed in A/B Street, so there's no concern about reusing node orderings.</li>
<li>All turns between two sidewalks become edges, again using length</li>
<li>When actually pathfinding, we get back a list of sidewalks. The actual
paths used in the traffic simulation specify forwards or backwards on a
sidewalk. Looking at adjacent pairs of sidewalks lets us easily stitch
together exact directions.</li>
</ul>
</li>
</ul>
</li>
<li><code>make/bus_stops.rs</code>: Match bus stops with a sidewalk
<ul>
<li>Also precompute the position where the bus stops on the adjacent driving or
bus lane.</li>
<li>This &quot;equivalent position on another lane&quot; process has a few weird cases,
since two lanes on the same road might have different lengths. Right now,
the same distance from the start of the lane is used, with clamping for
shorter lanes. Ideally, the position would be found by projecting a
perpendicular line out from one lane to the other.</li>
</ul>
</li>
<li><code>make/bus_stops.rs</code>: Finalize the list of bus routes
<ul>
<li>Between each pair of adjacent bus stops, run pathfinding to verify there's
actually a path for the bus to follow. If any are disconnected, remove the
bus route</li>
<li>Remove bus stops that have no routes serving them.</li>
</ul>
</li>
<li><code>pathfind/walking.rs</code>: Precompute the CH for pedestrians who will use buses
<ul>
<li>Nodes in the graph are sidewalks and every bus stop</li>
<li>There's an edge with weight 0 between a bus stop and its sidewalk</li>
<li>There's also an edge with weight 0 between bus stops that're adjacent via
some route. Ideally this weight would account for the time until the next
bus and the time spent on the bus, etc.</li>
<li>Later when figuring out which bus to use for a pedestrian, the resulting
list of nodes is scanned for the first and last bus stop along the same
route.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="development-tricks"><a class="header" href="#development-tricks">Development tricks</a></h1>
<ul>
<li>Separate phases for fast incremental development
<ul>
<li>Don't reimport all data from OSM every time there's a change to part of the
map construction code!</li>
<li>For slow steps that don't change often, make them separate binaries -- hence
<code>convert_osm</code> being separate from the rest.</li>
</ul>
</li>
<li>Don't be afraid of manual intervention
<ul>
<li>The data isn't perfect. It's easy to spend lots of time fiddling with code
to automatically handle all problems</li>
<li>Instead of automatically resolving problems, prefer good tooling for finding
and specifying fixes</li>
<li>Be careful of derivative structures that could get out of sync with OSM.
Prefer contributing real fixes to OSM.</li>
</ul>
</li>
<li>Screenshot diff testing
<ul>
<li>When working on the code for intersection geometry, it's easy to check a few
example cases get fixed by some change. But what if another part of the map
regresses somehow?</li>
<li>Take screenshots of the entire map, keep the checksums under version
control, look at the diffs visually, and manually verify any changes.</li>
<li>Implementation details: One huge gif or png is too slow to read and write,
so take a bunch of tiled screenshots covering everything. Amusingly,
rendering to a file with <code>glium</code> is slow unless compiling in release mode
(which isn't an option for quick incremental development). So instead, pan
to each section of the map, render it, call an external screenshot utility,
and move on -- just don't wiggle the mouse during this process!</li>
</ul>
</li>
<li>Different IDs for objects make sense during different phases
<ul>
<li>For the final product, lanes and such are just a contiguous array, indexed
by numeric IDs.</li>
<li>But sometimes, we need IDs that're the same between different boundary
polygons of maps, so that player edits can be applied anywhere. Using
(longitude, latitude) pairs hits floating-point serialization and comparison
issues, so referring to roads as (OSM way ID, OSM node ID 1, OSM node ID 2)
works instead.</li>
</ul>
</li>
</ul>
<h2 id="appendix-polylines"><a class="header" href="#appendix-polylines">Appendix: PolyLines</a></h2>
<p>Add some pictures here to demonstrate how polyline shifting works, the
explode-to-infinity problem, and the bevel/miter fix.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="live-edits"><a class="header" href="#live-edits">Live edits</a></h1>
<p>A key feature of A/B Street is the player editing the map and seeing how traffic
responds. The possible edits include:</p>
<ul>
<li>Change lane types (driving, bus, bike, parking -- sidewalks are fixed)</li>
<li>Change speed limits</li>
<li>Reverse a lane</li>
<li>Change a stop sign policy (which roads have a stop sign and which have
priority)</li>
<li>Change a traffic signal policy</li>
</ul>
<p>The map conversion process outlined above takes a few minutes, so reusing this
process directly to compute a map with edits wouldn't work at all for real
gameplay. Instead, the process for applying edits is incremental:</p>
<ul>
<li>Figure out the actual diff between edits and the current map
<ul>
<li>This is necessary for correctness, but also speeds up a sequence of edits
made in the UI -- only one or two lanes or intersections actually changes
each time. Of course when loading some saved edits, lots of things might
change.</li>
</ul>
</li>
<li>For any changed roads, make sure any bus stop on it have a good pointer to
their equivalent driving position for the bus.</li>
<li>For any modified intersections, recompute turns and the default intersection
policies</li>
<li>Recompute all the CHs for cars, buses, and bikes -- note sidewalks and bus
stops never change
<ul>
<li>This is the slowest step. Critically, the <code>fast_paths</code> crate lets a previous
node ordering be reused. If just a few edge weights change, then recomputing
is much faster than starting from scratch.</li>
<li>While making edits in the UI, we don't actually need to recompute the CH
after every little tweak. When the player exits edit mode, only then do we
recompute everything.</li>
</ul>
</li>
</ul>
<p>A list of lanes and intersections actually modified is then returned to the
drawing layer, which uploads new geometry to the GPU accordingly.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ab-streets-map-model-as-a-platform"><a class="header" href="#ab-streets-map-model-as-a-platform">A/B Street's map model as a platform</a></h1>
<p>A/B Street's representation of a city, built mostly from OSM and lots of
heuristics, is likely useful to other projects. This doc brainstorms what it
would look like to properly expose it to other users.</p>
<p>To sum up what the map model provides: geometry + semantics.</p>
<h2 id="use-cases"><a class="header" href="#use-cases">Use cases</a></h2>
<ul>
<li>Different UIs (particularly 3D / VR) for exploring cities as they are or as
they could be, like Streetmix 3D and Complete Street Rule</li>
<li>Importing slices of a city as assets into a game engine like Godot
<ul>
<li>Imagine a hackathon where people easily build games based on the real world</li>
<li>Like <a href="https://developers.google.com/maps/documentation/gaming/overview_musk">https://developers.google.com/maps/documentation/gaming/overview_musk</a>
but open</li>
</ul>
</li>
<li>A new OSM viewer/editor, particularly focused on POIs</li>
<li>Something focusing on 15-minute neighborhoods, with isochrones and nearby
amenities</li>
</ul>
<p>TODO: Give a quick Python example of what interacting with the end goal could
look like.</p>
<h2 id="just-data-is-not-enough"><a class="header" href="#just-data-is-not-enough">Just data is not enough</a></h2>
<p>At first glance, the existing <code>Map</code> structure could be written to some format
with a nicely documented schema. This would certainly be useful, but it's not
nearly enough. Interpreting the data sometimes requires lots of code, which
already exists -- so why not expose it to users as well?</p>
<p>Examples in OSM where I wish &quot;standard libraries&quot; existed to interpret the data:</p>
<ul>
<li>The simple task of detecting intersections between ways</li>
<li><a href="https://github.com/a-b-street/abstreet/blob/master/map_model/src/make/initial/lane_specs.rs">Figuring out what lanes a road has from tags</a></li>
<li>Gluing multipolygons together</li>
<li>Inferring turns at an intersection, subject to the several types of turn
restrictions</li>
</ul>
<p>A/B Street solves these problems (or at least it tries to), but by itself, the
resulting data isn't always useful. So some examples of where a library would be
needed too:</p>
<ul>
<li>Pathfinding. ABST does lots of work especially to handle &quot;live&quot; map edits and
cheaply regenerate contraction hierarchies. Also, pathfinding requires obeying
OSM turn restrictions that span multiple roads -- this prevents even plain old
Dijkstra's from working correctly.</li>
<li>Getting geometry in different forms. Lanes are stored as a <code>PolyLine</code>, but
what if a consumer wants the thickened <code>Polygon</code>, either as points, or maybe
even pre-triangulated vertices and indices?</li>
</ul>
<h2 id="how-would-an-apilibrary-work"><a class="header" href="#how-would-an-apilibrary-work">How would an API/library work?</a></h2>
<p>The traditional approach is to link against part of A/B Street as a library and
call it through language-specific bindings. The more language-agnostic option is
defining an API (maybe JSON or protobuf) and having clients run a local A/B
Street server, making HTTP requests to it. This is like the &quot;sidecar&quot; pattern in
microservice-land.</p>
<h2 id="compatibility"><a class="header" href="#compatibility">Compatibility</a></h2>
<p>Really have to think through this carefully. Some examples of big changes on the
horizon:</p>
<ul>
<li>Additive: separate cycleways and tramways. Likely no schema change.</li>
<li>Modify: traffic signals will get
<a href="https://github.com/a-b-street/abstreet/issues/295">more complex</a></li>
<li>Modify: we'll likely try again to merge tiny intersections together, which
would get rid of the current guarantees that a road/intersection is associated
to one particular OSM object</li>
</ul>
<h2 id="layering"><a class="header" href="#layering">Layering</a></h2>
<p>Clients should be able to opt into different data layers. For example, A/B
Street strips out OSM building tags right now to keep filesizes small. But an
OSM viewer would want to keep this (and likely discard the large contraction
hierarchies). So some pieces of the map model need to be teased apart into
optional pieces, and probably loaded in as separate files.</p>
<h2 id="the-bigger-vision"><a class="header" href="#the-bigger-vision">The bigger vision</a></h2>
<p>Depending what other open source projects are on board, the general idea is to
start assembling an ecosystem of libraries/tooling to make it easier to build
new things off of open GIS data.</p>
<p>The end state might look like this. A few separate applications would exist, all
running both natively and in the browser:</p>
<ul>
<li>A/B Street the game, more or less in its current form</li>
<li>A new OpenStreetMap viewer, likely focused on visualizing roads and
points-of-interest in detail</li>
<li>The street parking OSM editor, and other OSM editors specialized for mapping
certain things</li>
<li>A new app focusing on 15-minute neighborhoods, using isochrones to show
amenities available nearby
<ul>
<li>Ideally, allow editing current land use / zoning, to let people explore how
new policies might get closer to a 15-minute neighborhood.</li>
<li>Possibly <a href="https://www.open-accessibility.org">GOAT</a> does all of this
already, and this new thing shouldn't be built</li>
</ul>
</li>
<li>A new app for creating story maps, showing events that occur over time, with
lots of detail about the surrounding environment</li>
</ul>
<p>All of these would make use of some common libraries, which should be extracted
out cleanly from A/B Street today:</p>
<ul>
<li>the map model and OSM importer</li>
<li>the widgetry UI library</li>
<li>some common code for specifically interacting with maps in widgetry</li>
<li>a tool to generate a traffic demand model from OSM data, optional census data,
etc
<ul>
<li>This has been initially
<a href="tech/map/../trafficsim/travel_demand.html#proletariat-robot">prototyped</a></li>
</ul>
</li>
<li>the discrete-event traffic simulation that A/B Street uses today</li>
<li>core geometry/utility libraries</li>
</ul>
<p>But note only the first application would use things like the simulation
library. The point of more cleanly modularizing these pieces is to make it
easier for new people to build different pieces, without having to understand
and be coupled to everything else. Also, as appropriate, these pieces should use
common data formats (like
<a href="https://github.com/d-wasserman/shared-row/">shared-row</a>) to be interoperable
with Streetmix, Complete Streets, etc.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ab-streets-traffic-simulation"><a class="header" href="#ab-streets-traffic-simulation">A/B Street's Traffic Simulation</a></h1>
<p>This article describes how cars, bikes, buses, and pedestrians are modeled in
A/B Street. All code lives in the <code>sim</code> crate.</p>
<p><a href="https://youtu.be/chYd5I-5oyc?t=1086">This recorded presentation</a> covers some of
this.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="discrete-event-traffic-simulation-laggy-heads-and-ghosts"><a class="header" href="#discrete-event-traffic-simulation-laggy-heads-and-ghosts">Discrete event traffic simulation, laggy heads, and ghosts</a></h1>
<style>
figure {
    outline: 1px solid black;
    padding: 16px;
}
</style>
<p><em>By Dustin Carlino, last updated September 2021</em></p>
<p>A/B Street's traffic simulation isn't based on any research papers or existing
systems, so this article aims to motivate and explain how it works. This article
focuses on how the different agents (drivers, bicyclists, and pedestrians) move
around. If you're wondering how we figure out where these agents should go or
what time they decide to take trips, go read about
<a href="tech/trafficsim/discrete_event/../travel_demand.html">travel demand models</a>.</p>
<p>I'm not aiming to survey how other traffic simulation models work here. In
short, some focus on &quot;macroscopic&quot; patterns, like the volume of traffic along a
particular highway over time. A/B Street is more on the &quot;microscopic&quot; side,
modeling individual agents making decisions over time. Many such models use
&quot;discrete-time&quot; simulation, where every agent senses and reacts to the world
every time-step (0.1 seconds or so). A/B Street actually started with this --
see the <a href="tech/trafficsim/discrete_event/index.html#appendix-discrete-time-simulation">appendix</a> for more background. But
early on, I switched to a discrete-event simulation instead. So, let's jump into
that!</p>
<p>Note: I'll provide references to the current implementation. Someday I'll write
that article describing how to build a traffic simulation from scratch...</p>
<ul>
<li><a href="tech/trafficsim/discrete_event/index.html#starting-simple-pedestrians">Starting simple: Pedestrians</a>
<ul>
<li><a href="tech/trafficsim/discrete_event/index.html#discrete-events">Discrete events</a></li>
</ul>
</li>
<li><a href="tech/trafficsim/discrete_event/index.html#vehicles">Vehicles</a>
<ul>
<li><a href="tech/trafficsim/discrete_event/index.html#the-state-machine">The state machine</a></li>
<li><a href="tech/trafficsim/discrete_event/index.html#exact-positions">Exact positions</a></li>
<li><a href="tech/trafficsim/discrete_event/index.html#laggy-heads">Laggy heads</a></li>
<li><a href="tech/trafficsim/discrete_event/index.html#performance">Performance</a></li>
</ul>
</li>
<li><a href="tech/trafficsim/discrete_event/index.html#lane-changing">Lane-changing</a>
<ul>
<li><a href="tech/trafficsim/discrete_event/index.html#background">Background</a></li>
<li><a href="tech/trafficsim/discrete_event/index.html#step-1-deciding-to-change-lanes">Step 1: deciding to change lanes</a></li>
<li><a href="tech/trafficsim/discrete_event/index.html#step-2-performing-the-lane-changing">Step 2: performing the lane-changing</a></li>
<li><a href="tech/trafficsim/discrete_event/index.html#future-work">Future work</a></li>
</ul>
</li>
<li><a href="tech/trafficsim/discrete_event/index.html#appendix-discrete-time-simulation">Appendix: discrete-time simulation</a></li>
</ul>
<h2 id="starting-simple-pedestrians"><a class="header" href="#starting-simple-pedestrians">Starting simple: Pedestrians</a></h2>
<p>Imagine a simple movement model for pedestrians. Usually they exist at some
point along a sidewalk and can move in one direction or the other. At
intersections, different sidewalks are connected by crosswalks, and pedestrians
can also move bidirectionally on those, after waiting for the right time to
cross.</p>
<figure>
  <a href="tech/trafficsim/discrete_event/sidewalks.png" target="_blank"><img src="tech/trafficsim/discrete_event/sidewalks.png"/></a>
  <figcaption>Sidewalks shown in blue, connected by pink crosswalks and
also cyan connections.Everything is bidirectional.</figcaption>
</figure>
<p>We'll make a few assumptions about pedestrians. They follow the sidewalks and
crosswalks perfectly, never deciding to honor their inner Pythagorean. They
travel at a fixed speed and change that speed instantly -- no smooth
acceleration. That fixed speed could depend on both their preferred walking
speed and on the current sidewalk's elevation gain. These poor robotic
pedestrians never stop to smell the flowers, write an angry neighborly note, or
pet a pupper -- they just walk, or wait. Online dating is also so pervasive in
this simulation that pedestrians ghost -- through each other, that is. There are
more interesting models of pedestrian movement like the
<a href="https://en.wikipedia.org/wiki/Crowd_simulation">social force model</a> where
people change speeds in crowds, but A/B Street is focused on sad American cities
where you don't often see many people walking in one place. So there's no
collision between pedestrians at all; they just pass through each other,
temporarily losing their individuality for rendering purposes:</p>
<figure>
  <a href="tech/trafficsim/discrete_event/pedestrian_ghosts.gif" target="_blank"><img src="tech/trafficsim/discrete_event/pedestrian_ghosts.gif"/></a>
  <figcaption><a href="https://www.youtube.com/watch?v=lsV500W4BHU" target="_blank">This is what it's like when people collide</a></figcaption>
</figure>
<p>In the world of discrete timesteps, you could imagine each pedestrian has very
simple logic. At any moment, they just continue walking one direction or the
other at their fixed speed along a sidewalk or crosswalk. Or they pause at the
end of a sidewalk, awaiting their turn at a stop sign or traffic signal.</p>
<h3 id="discrete-events"><a class="header" href="#discrete-events">Discrete events</a></h3>
<p>Don't the constant updates every time-step seem wasteful? Most of the time, a
pedestrian is in a steady-state -- walking or waiting. Since they walk at a
fixed speed, we can just linearly interpolate their exact position at any moment
in time if we want to draw them.</p>
<p>Instead of looping through every agent every time-step, in a discrete-event
system, we just have one giant
<a href="https://github.com/a-b-street/abstreet/blob/master/sim/src/scheduler.rs">priority queue of events</a>,
scheduled to happen at some time in the future. Each agent remains in a certain
state for a period of time, and schedules an event to transition themselves to a
different state.</p>
<p>In the case of pedestrians, this works like this:</p>
<ol>
<li>A pedestrian begins at 30 meters distance along their first sidewalk. They
want to walk forwards on the sidewalk, so they calculate the distance to the
end of the sidewalk -- say another 70 meters -- and divide that by their
preferred speed, scheduling an event an appropriate amount of time later --
say 10 seconds.</li>
<li>For the next 10 seconds, that pedestrian is in the <code>Crossing</code> state, which
has a <code>DistanceInterval</code> stating that they're moving on a certain sidewalk
from 30 to 70 meters. The <code>TimeInterval</code> says that this state is occurring
from time 0 to 10 seconds. We can linearly interpolate to find their
position for drawing.</li>
<li>At 10 seconds, the scheduler wakes up the pedestrian. They're now at the end
of the sidewalk, so they look at the intersection and ask to cross. There's
a traffic signal, and the almighty hand says NOPE, so they hand over control
to the intersection and just mark themselves as <code>WaitingToTurn</code> state. No
events are scheduled to update them.</li>
<li>But the intersection remembers the list of waiting agents. Some time later,
the light changes, and the intersection &quot;wakes up&quot; all of the agents who now
have a green.</li>
<li>Our pedestrian calculates a new <code>Crossing</code> state for the crosswalk. This
state too happens over some distance and time interval.</li>
<li>At the end of the crosswalk, the pedestrian immediately enters another
<code>Crossing</code> state for the next sidewalk.</li>
</ol>
<p>We can visualize this with a finite-state machine:</p>
<figure>
  <a href="tech/trafficsim/discrete_event/pedestrian_fsm.png" target="_blank"><img src="tech/trafficsim/discrete_event/pedestrian_fsm.png"/></a>
</figure>
<p>Code references
<a href="https://github.com/a-b-street/abstreet/blob/master/sim/src/mechanics/walking.rs">here</a>.</p>
<h2 id="vehicles"><a class="header" href="#vehicles">Vehicles</a></h2>
<p>Discrete events are obviously much simpler for pedestrians, but there were some
pretty drastic assumptions there that won't work for vehicles. It takes a few
more tricks for A/B Street to model cars, bikes, and buses (I'll just use
&quot;vehicle&quot; from here on.)</p>
<p>First let's understand what vehicles can do. They travel in one direction along
individual lanes, and they queue behind each other -- no ghosting. At
intersections, they wait as needed, then move along a &quot;turn,&quot; destined for a
target lane. There are two major differences from reality that we'll take as
assumptions.</p>
<p>First, vehicles instantly change speeds -- no smooth acceleration from rest, or
modeling of safe stopping distance. So if a vehicle starts at the beginning of
an empty lane, they instantly jump from rest to the maximum speed limit for that
road. They travel at that maximum speed limit until the moment their front
bumper strikes the boundary between road and intersection, then they stop
immediately. This doesn't model highway driving at all, where things like jam
waves are interesting to study and require more realistic kinematics and a model
of driver reaction time. But A/B Street is focused on in-city movement, and the
essence of scarcity I want to model is capacity on lanes and contention at
intersections. What happens in between isn't as important. I think you'll find
that the overall traffic patterns emerging in A/B Street still look compellingly
realistic.</p>
<figure>
  <a href="tech/trafficsim/discrete_event/quick_stop.gif" target="_blank"><img src="tech/trafficsim/discrete_event/quick_stop.gif"/></a>
  <figcaption>A perfect stop from 70mph.</figcaption>
</figure>
<p>The second article of funny business is lane-changing. Let's assume that
vehicles don't change lanes in the middle of a road. Instead, vehicles shift
left and right while moving through intersections. So if somebody needs to use a
left turn lane, then at the intersection one road back, they'll choose to slide
over during their turn. Any conflicting movements with other vehicles is handled
at the intersection already.</p>
<figure>
  <a href="tech/trafficsim/discrete_event/lc_intersections.png" target="_blank"><img src="tech/trafficsim/discrete_event/lc_intersections.png"/></a>
  <figcaption>On a two lane road, a vehicle changes lanes in the
south intersection, then makes a left turn at the north intersection. Don't try
this at home!</figcaption>
</figure>
<p>This also means there's no over-taking. If a car gets stuck behind a bike moving
slowly uphill, so be it.</p>
<figure>
  <a href="tech/trafficsim/discrete_event/no_overtaking.gif" target="_blank"><img src="tech/trafficsim/discrete_event/no_overtaking.gif"/></a>
  <figcaption>A car patiently follows a bike. In reality, they would
likely over-take here.</figcaption>
</figure>
<p>We'll try to relax this second assumption later.</p>
<h3 id="the-state-machine"><a class="header" href="#the-state-machine">The state machine</a></h3>
<p>So let's figure out how to model these vehicles. The approach used by
pedestrians, with <code>Crossing</code> and <code>WaitingToAdvance</code> states doesn't quite work,
because nothing would stop vehicles from plowing into each other. So let's
introduce a third state -- <code>Queued</code>. When a vehicle enters a new lane, it enters
the <code>Crossing</code> state as usual, calculating the &quot;best-case&quot; time to cross the
entire length of the lane at the max speed limit. This assumes nobody's in the
way! But when this state ends, we can only transition the vehicle to the
<code>WaitingToAdvance</code> state if they're the &quot;lead&quot; vehicle in the current lane's
queue. If they have a &quot;leader&quot; vehicle, then they enter the <code>Queued</code> state and
register as a &quot;follower&quot; of this &quot;leader&quot; in the queue.</p>
<figure>
  <a href="tech/trafficsim/discrete_event/car_ex_time1.png" target="_blank"><img src="tech/trafficsim/discrete_event/car_ex_time1.png"/></a>
  <figcaption>Both the cyan and green car are in the Crossing state.</figcaption>
</figure>
<figure>
  <a href="tech/trafficsim/discrete_event/car_ex_time2.png" target="_blank"><img src="tech/trafficsim/discrete_event/car_ex_time2.png"/></a>
  <figcaption>The green car has reached the intersection and is
WaitingToAdvance, but the cyan car is still Crossing.</figcaption>
</figure>
<figure>
  <a href="tech/trafficsim/discrete_event/car_ex_time3.png" target="_blank"><img src="tech/trafficsim/discrete_event/car_ex_time3.png"/></a>
  <figcaption>The cyan car caught up and is now Queued.</figcaption>
</figure>
<p>Note that somebody might enter <code>Queued</code> well before they're near the
intersection, like if they're following a slower vehicle. <code>Queued</code> just means
the faster vehicle has already spent the &quot;best-case&quot; time to cross the road at
the full speed limit.</p>
<figure>
  <a href="tech/trafficsim/discrete_event/car_ex_slow.png" target="_blank"><img src="tech/trafficsim/discrete_event/car_ex_slow.png"/></a>
  <figcaption>The cyan car is already Queued, but its leader, the green
vehicle, is still Crossing.</figcaption>
</figure>
<p>When the vehicle at the very front of a lane enters the intersection and fully
vacates their old lane, then they &quot;wake up&quot; their follower. Since the <code>Queued</code>
follower has been following along as closely as possible, they instantly
transition to <code>WaitingToAdvance</code>, since we know they're at the end of the lane.
&quot;Fully vacating&quot; the lane means the back of the vehicle clears the lane; see the
<a href="tech/trafficsim/discrete_event/index.html#laggy-heads">section below</a>.</p>
<p>We can again understand all of this with a finite-state machine:</p>
<figure>
  <a href="tech/trafficsim/discrete_event/vehicle_fsm.png" target="_blank"><img src="tech/trafficsim/discrete_event/vehicle_fsm.png"/></a>
  <figcaption>Unparking is an initial state, where a vehicle exits a driveway or street parking spot.</figcaption>
</figure>
<p>Code references
<a href="https://github.com/a-b-street/abstreet/blob/master/sim/src/mechanics/car.rs">here</a>
and
<a href="https://github.com/a-b-street/abstreet/blob/master/sim/src/mechanics/driving.rs">here</a>.</p>
<h3 id="exact-positions"><a class="header" href="#exact-positions">Exact positions</a></h3>
<p>Most of the time, we don't care exactly where on a lane some vehicle is. But we
do need to know for drawing and for a few cases during simulation, such as
determining when a bus is lined up with a bus stop in the middle of a lane.</p>
<p>To calculate exact positions, we walk along each lane's queue from front to
back. The key idea is that leaders bound the position of followers, and we can
&quot;lazily evaluate&quot; the position of followers. This means that calculating one
vehicle's position costs as much as calculating the entire queue's in the worst
case, but that's usually fine -- for drawing, we want everyone anyway.</p>
<p>The process is simple. We use each vehicle's state to determine the &quot;best-case&quot;
position of their front bumper. <code>WaitingToAdvance</code> means the vehicle is at the
very end of the lane. For vehicles still <code>Crossing</code>, we linearly interpolate the
time and distance intervals. Then as we walk from front to back, we maintain a
&quot;bound&quot; for the next vehicle's position. This is based on the front position of
the current vehicle, plus the vehicle's length and a fixed following distance
(which, note, is not based on speed).</p>
<figure>
  <a href="tech/trafficsim/discrete_event/exact_pos.png" target="_blank"><img src="tech/trafficsim/discrete_event/exact_pos.png"/></a>
</figure>
<p>Let's walk through the example above, from front (the left side) to back. The
yellow car is <code>WaitingToAdvance</code> at the intersection, so their front position
<strong>(1)</strong> is the full length of the lane. Based on the length of that car and a
following distance of 1 meter, the bound imposed by this first car is at <strong>(2)</strong>
-- nobody following could possibly be beyond this position.</p>
<p>The second vehicle in the queue is the bike. Based on their <code>Crossing</code> state,
which says they're crossing from 0 meters along the lane to the full length of
it from 30 seconds to 90 seconds, we linearly interpolate and get their front
position <strong>(3)</strong>. This position is smaller than the bound of <strong>(2)</strong>, so no
adjustment is needed.</p>
<p>The third vehicle is the red car. Based on their <code>Crossing</code> state,
optimistically they would be at position <strong>(4a)</strong> by this time. But since
they're following the bike, then they're bound by position <strong>(4)</strong>, so that's
where this algorithm places them. The bound for the next vehicle is then <strong>(4)</strong>
plus the vehicle's length and a following buffer, giving us <strong>(5)</strong>. The final
vehicle hasn't reached that position yet based on its <code>Crossing</code> state, so it's
unaffected by that bound and is just at <strong>(6)</strong>.</p>
<p>Code
<a href="https://github.com/a-b-street/abstreet/blob/master/sim/src/mechanics/queue.rs">here</a>.</p>
<h3 id="laggy-heads"><a class="header" href="#laggy-heads">Laggy heads</a></h3>
<p>Vehicles aren't infinitesimal dots; they have a length, so each one has a front
and back. This means we have to be a little careful about defining when a
vehicle has left a lane and its follower should be considered the &quot;first&quot; in the
queue:</p>
<figure>
  <a href="tech/trafficsim/discrete_event/laggy_heads.png" target="_blank"><img src="tech/trafficsim/discrete_event/laggy_heads.png"/></a>
  <figcaption>The front of the yellow car is in the intersection and
thus out of the queue. But its back is still in the lane, so the bike can't
truly be at the front of the queue yet.</figcaption>
</figure>
<p>To model this, every lane's queue may have a &quot;laggy head.&quot; (Naming things is
hard...) The head of this queue may be the bike, but because the yellow car is
still the laggy head, the bike remains <code>Queued</code>. When the yellow car enters the
intersection, we need to determine when its back will clear the lane, letting
the bike wind up at the very front. Optimistically we assume the yellow car will
travel through the turn as fast as possible, so we can calculate the time to
cross the car's length, and schedule a check there. When that check happens, we
calculate the exact position of the yellow car -- maybe it's queued behind other
vehicles making the same turn, or blocked by other vehicles in its target queue.
If it's advanced far enough, then we unregister the yellow car as a laggy head
and wake up the bike, who changes from <code>Queued</code> to <code>WaitingToAdvance</code>. If the
yellow car's back end is still sticking out into the lane, then we schedule
another check a fixed 0.1 seconds. This retry policy is quite aggressive and
will slow down the simulation as traffic jams start to form.</p>
<p>This logic to determine when a vehicle's back has fully cleared a lane is
unfortunately complicated by the presence of short roads and turns, a currently
unsolved problem in the underlying map model. A long vehicle like a bus may
partly be overlapping several lanes and turns at a time, meaning we have to
carefully calculate when the back of the bus has cleared each piece.</p>
<h3 id="performance"><a class="header" href="#performance">Performance</a></h3>
<p>It's been a very long time since I've measured the performance of this
discrete-event simulation, so these numbers are rather out-of-date:</p>
<figure>
  <a href="tech/trafficsim/discrete_event/perf.png" target="_blank"><img src="tech/trafficsim/discrete_event/perf.png"/></a>
</figure>
<p>One of the reasons the simulation is more performant than discrete time-steps is
by how much time the simulation advances between updates. With discrete time,
it's always a fixed amount -- 0.1 seconds usually. With discrete events, it
depends when the next event is scheduled -- the later that event occurs, the
faster the overall simulation proceeds. On a nearly empty map with really long
roads, a single agent only needs a few updates to complete its trip -- very
loosely, an update at the beginning and end of each lane and turn in its path.
As more vehicles queue along the same lane at the same time, we increase the
number of updates to process all of them, but it's still less than updating
every agent every 0.1 seconds.</p>
<p>There are a few big opportunities to improve performance, by requiring less
updates when vehicles are stuck waiting at intersections or stuck behind laggy
heads. From some
<a href="https://github.com/a-b-street/abstreet/issues/368#issuecomment-728289865">older investigation</a>,
it's clear that a huge amount of processing is spent on agents trying to start a
turn and on checks that a laggy head has cleared a queue.</p>
<figure>
  <a href="tech/trafficsim/discrete_event/perf_stats.png" target="_blank"><img src="tech/trafficsim/discrete_event/perf_stats.png"/></a>
</figure>
<h2 id="lane-changing"><a class="header" href="#lane-changing">Lane-changing</a></h2>
<p>For a long time, A/B Street had no dynamic lane-changing or over-taking. As
described earlier, vehicles use the conflict handling at intersections to change
lanes in order to pick the lane required for a turn (&quot;mandatory lane-changing&quot;)
or that's likely to be fastest (&quot;discretionary lane-changing&quot;). But that finally
changed in <a href="https://github.com/a-b-street/abstreet/pull/682">June 2021</a>.</p>
<figure>
  <a href="tech/trafficsim/discrete_event/lanechanging.gif" target="_blank"><img src="tech/trafficsim/discrete_event/lanechanging.gif"/></a>
  <figcaption>Two vehicles change lanes to pass a slower bike. They
follow the bike for a few seconds before starting to over-take.</figcaption>
</figure>
<h3 id="background-1"><a class="header" href="#background-1">Background</a></h3>
<p>The lane-changing implemented right now is only discretionary, meant for cars to
over-take slower vehicles. In a
<a href="http://apps.cs.utexas.edu/tech_reports/reports/tr/TR-2157.pdf">previous project</a>,
I tried implementing mandatory lane-changing. But the process could fail -- if
there wasn't room for a vehicle to start changing lanes, it would just continue
on the current lane and miss the turn it was supposed to take. That forced
rerouting. Since the lane-changing process is scoped to happen on a single road
-- which seems pretty necessary to manage complexity, and also prevent changing
lanes in the middle of an intersection -- this meant that clusters of short
roads in the map model really caused major problems. Many vehicles repeatedly
attempted lane-changing maneuvers required by pathfinding, but impossible to
actually pull off in the simulation. This greatly skewed results -- some agents
experienced really high trip times as they repeatedly rerouted and kept
attempting difficult maneuvers.</p>
<p>I considered making the process infallible -- vehicles would slow down and
eventually stop, until they forced their way into another lane. I suspect this
could also lead to lots of unrealistic gridlock, but I never tried it.</p>
<p>So that's why there's only discretionary or &quot;opportunistic&quot; lane-changing for
now.</p>
<h3 id="step-1-deciding-to-change-lanes"><a class="header" href="#step-1-deciding-to-change-lanes">Step 1: deciding to change lanes</a></h3>
<p>The current implementation will now be described. The process starts when a
vehicle transitions from <code>Crossing</code> to <code>Queued</code>. The follower will compare its
ideal speed to that of its leader. If the leader is still <code>Crossing</code> and has a
slower speed, then the follower will try to over-take. If the leader is also
<code>Queued</code>, then there's probably no opportunity to over-take -- the follower is
probably just hitting the end of a chain of vehicles waiting for an
intersection.</p>
<p>Next the vehicle will pick a lane to use for over-taking. There's currently no
support for crossing a road's center line and temporarily using a lane in the
opposite direction. The target lane must also be compatible with the vehicle's
path, so if there's a turn coming up, nothing will happen.</p>
<p>Finally, the vehicle will attempt to initiate the lane-changing. There's a bunch
of
<a href="https://github.com/a-b-street/abstreet/blob/83ebc96bb115c263edf3cf5f3567709ca52f2d52/sim/src/mechanics/driving.rs#L1128">checks</a>
in the code that I won't repeat here. In summary, we require a fixed 1 second
duration to perform the manuever. During this, the vehicle will exist in two
queues. Committing to the move requires completion before reaching the end of
the road, and nothing in the way in the target lane.</p>
<h3 id="step-2-performing-the-lane-changing"><a class="header" href="#step-2-performing-the-lane-changing">Step 2: performing the lane-changing</a></h3>
<p>The vehicle enters the <code>ChangingLanes</code> state, which works almost exactly like
<code>Crossing</code>. The vehicle immediately &quot;warps&quot; to their target lane. They exit
their original lane, replacing themselves with a &quot;ghost&quot; in that queue. The
ghost follows the leader vehicle and shares the same length as the actual
vehicle. This ghost prevents another vehicle from advancing too close to the
slow leader and &quot;clipping&quot; into the vehicle changing lanes.</p>
<figure>
  <a href="tech/trafficsim/discrete_event/lc_ghost.gif" target="_blank"><img src="tech/trafficsim/discrete_event/lc_ghost.gif"/></a>
  <figcaption>A car follows a bike, then starts changing lanes. The time to complete the movement is artificially stretched out to 3 seconds. While the car is sliding over, it leaves a "ghost" vehicle following the bike in the original lane, to prevent other vehicles from getting too close.
</figure>
<h3 id="future-work"><a class="header" href="#future-work">Future work</a></h3>
<p>There are many limits with the current approach.</p>
<p>First, vehicles should be able to change lanes twice and return to the original
lane, actually passing a slower vehicle. I got a
<a href="https://github.com/a-b-street/abstreet/tree/lc_overtaking_two_phase">proof-of-concept</a>
working. The idea is to &quot;acquire a lock&quot; on both lane-changing movements at the
same time, so that a vehicle doesn't start to over-take and then wind up unable
to return to the original lane. This involves inserting a ghost in front of the
slow vehicle, but there are some unsolved conceptual problems that I've...
completely lost context on.</p>
<figure>
  <a href="tech/trafficsim/discrete_event/two_phase_overtaking.gif" target="_blank"><img src="tech/trafficsim/discrete_event/two_phase_overtaking.gif"/></a>
</figure>
<p>Once full over-taking works, letting vehicles cross into incoming traffic to
over-take would be the next step. This will require calculating what part of
that opposite direction queue should be blocked off for the duration of the
movement.</p>
<p>There are some smaller things to polish:</p>
<ul>
<li>A lane-changing vehicle can visually &quot;clip&quot; into the slow leader, due to the
vehicle's front position no longer being bound by the slow leader. See
<a href="https://twitter.com/CarlinoDustin/status/1406020451541741568">here</a> for a bit
of detail.</li>
<li>Start the first step before a vehicle enters <code>Queued</code>. This is the reason why
cars will follow a bike for a few seconds before trying to pass. This could be
done by calculating the time at which a faster follower will intersect a
slower leader, and scheduling an event to possibly initiate lane-changing
then.</li>
<li>Once a vehicle decides it wants to pass somebody, it only checks if there's
room in the target lane once. If there happens to be somebody in the way, it
gives up. We could schedule more retries, possibly based on how busy the
target lane is. But if this is too aggressive, at some point we degrade to the
performance of time-steps.</li>
</ul>
<!-- Intersections... turn conflict granularity, how the request/retry stuff works, waking up in priority order, etc. -->
<h2 id="appendix-discrete-time-simulation"><a class="header" href="#appendix-discrete-time-simulation">Appendix: discrete-time simulation</a></h2>
<p>A/B Street's first traffic model was discrete-time, meaning that every agent
reacted to the world every 0.1s. Cars had a more realistic kinematics model,
accelerating to change speed and gradually come to a halt. Cars did a worst-case
estimation of how far ahead they need to lookahead in order to satisfy different
constraints:</p>
<ul>
<li>Don't exceed any speed limits</li>
<li>Don't hit the lead vehicle (which might suddenly slam on its brakes)</li>
<li>Stop at the end of a lane, unless the intersection says to go</li>
</ul>
<!-- why was lookahead hard: short lanes? -->
<p>After fighting with this approach for a long time, I eventually scrapped it in
favor of the simpler discrete-event model because:</p>
<ul>
<li>It's fundamentally slow; there's lots of busy work where cars in freeflow with
nothing blocking them or stopped in a long queue constantly check to see if
anything has changed.</li>
<li>Figuring out the acceleration to apply for the next 0.1s in order to satisfy
all of the constraints is really complicated. Floating point inaccuracies
cause ugly edge cases with speeds that wind up slightly negative and with cars
coming to a complete stop slightly past the end of a lane. I wound up storing
the &quot;intent&quot; of an action to auto-correct these errors.</li>
<li>The realism of having cars accelerate smoothly didn't add value to the core
idea in A/B Street, which is to model points of contention like parking
capacity and intersections. (This is the same reason why I don't model bike
racks for parking bikes -- in Seattle, it's never hard to find something to
lock to -- this would be very different if Copenhagen was the target.)
Additionally, the kinematics model made silly assumptions about driving anyway
-- cars would smash on their accelerators and brakes as hard as possible
within all of the constraints.</li>
</ul>
<!-- following papers is hard. diffeq's, no advice how to deal with real geometry or do LCing.. slow down to shift? -->
<p>And if you made it this far, have a
<a href="https://dabreegster.github.io/poetry/college/discrete_event_simulation.html">poem</a>
about discrete event simulation (and also compilers) that I wrote many years
ago...</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="travel-demand"><a class="header" href="#travel-demand">Travel demand</a></h1>
<p>A/B Street simulates people following a schedule of trips over a day. A single
<em>trip</em> has a start and endpoint, a departure time, and a mode. Most trips go
between buildings, but the start or endpoint may also be a border intersection
to represent something outside the map boundaries. The mode specifies whether
the person will walk, bike, drive, or use transit. Without a good set of people
and trips, evaluating some changes to a map is hard -- what if the traffic
patterns near the change aren't realistic to begin with? This chapter describes
where the travel demand data comes from.</p>
<p>See
<a href="https://dabreegster.github.io/talks/tds_seminar_synthpop/slides.html">these slides</a>
for this <a href="https://www.youtube.com/watch?v=vUJJJ_MD2CM">this recorded talk</a> for
up-to-date information as of March 2022.</p>
<h2 id="scenarios"><a class="header" href="#scenarios">Scenarios</a></h2>
<p>A <em>scenario</em> encodes the people and trips taken over a day. See the
<a href="https://github.com/a-b-street/abstreet/blob/master/sim/src/make/scenario.rs">code</a>.</p>
<p>See <a href="tech/trafficsim/parking.html#seeding-cars">here</a> for details how vehicles are initially
placed and used by the driving trips specified by the scenario.</p>
<h2 id="data-sources-1"><a class="header" href="#data-sources-1">Data sources</a></h2>
<h3 id="seattle-soundcast"><a class="header" href="#seattle-soundcast">Seattle: Soundcast</a></h3>
<p>Seattle luckily has the Puget Sound Regional Council, which has produced the
<a href="https://www.psrc.org/activity-based-travel-model-soundcast">Soundcast model</a>.
They use census stats, land parcel records, observed vehicle counts, travel
diaries, and lots of other things I don't understand to produce a detailed model
of the region. We're currently using their 2014 model; the 2018 one should be
available sometime in 2020. See the
<a href="https://github.com/a-b-street/abstreet/tree/master/importer/src/soundcast">code</a>
for importing their data.</p>
<p>TODO:</p>
<ul>
<li>talk about how trips beginning/ending off-map are handled</li>
</ul>
<h3 id="berlin"><a class="header" href="#berlin">Berlin</a></h3>
<p>This work is <a href="https://github.com/a-b-street/abstreet/issues/119">stalled</a>. See
the
<a href="https://github.com/a-b-street/abstreet/blob/master/importer/src/berlin.rs">code</a>.
So far, we've found a population count per planning area and are randomly
distributing the number of residents to all residential buildings in each area.</p>
<h3 id="proletariat-robot"><a class="header" href="#proletariat-robot">Proletariat robot</a></h3>
<p>What if we just want to generate a reasonable model without any city-specific
data? One of the simplest approaches is just to spawn people beginning at
residential buildings, make them go to some workplace in the morning, then
return in the evening. OpenStreetMap building tags can be used to roughly
classify building types and distinguish small houses from large apartments. See
the <code>proletariat_robot</code>
<a href="https://github.com/a-b-street/abstreet/blob/master/sim/src/make/activity_model.rs">code</a>
for an implementation of this.</p>
<h3 id="census-based"><a class="header" href="#census-based">Census Based</a></h3>
<p>Trips are distributed based on where we believe people live. For the US, this
information comes from the US Census. To take advantage of this model for areas
outside the US, you'll need to add your data to the global <code>population_areas</code>
file. This is one huge file that is shared across regions. This is more work up
front, but makes adding individual cities relatively straight forward.</p>
<p>See
<a href="https://github.com/a-b-street/abstreet/blob/master/popdat/src/lib.rs">the code</a>
for the very simple activity model using the census data.</p>
<h4 id="preparing-the-population_areas-file"><a class="header" href="#preparing-the-population_areas-file">Preparing the <code>population_areas</code> file</a></h4>
<p>See
<a href="https://github.com/a-b-street/abstreet/blob/master/popdat/scripts/build_population_areas.sh">this script</a>
for updating or adding to the existing population areas. Once rebuilt, you'll
need to upload the file so that popdat can find it.</p>
<h3 id="grid2demand"><a class="header" href="#grid2demand">Grid2Demand</a></h3>
<p>Collaborators at ASU are creating
<a href="https://github.com/asu-trans-ai-lab/grid2demand">https://github.com/asu-trans-ai-lab/grid2demand</a>, which does the traditional
four-step trip generation just using OSM as input. The output of this tool can
be directly imported into A/B Street. From the scenario picker, choose &quot;Import
Grid2Demand data&quot; and select the <code>input_agents.csv</code> file.</p>
<h3 id="abstr"><a class="header" href="#abstr">abstr</a></h3>
<p><a href="https://www.robinlovelace.net/">Robin Lovelace</a> is working on an
<a href="https://a-b-street.github.io/abstr/">R package</a> to transform aggregate desire
lines between different zones into A/B Street scenarios.</p>
<h3 id="desire-lines-for-the-uk"><a class="header" href="#desire-lines-for-the-uk">Desire lines (for the UK)</a></h3>
<p>The UK has origin/destination (aka desire line) data, recording how many people
travel between a home and work zone for work, broken down by mode. We have a
tool to disaggregate this and create individual people, picking homes and
workplaces reasonably using OSM-based heuristics. See
<a href="https://github.com/a-b-street/abstreet/blob/master/popdat/src/od.rs">the pipeline</a>
for details about how it works. The code that parses the raw UK data is
<a href="https://github.com/a-b-street/abstreet/blob/master/importer/src/uk.rs">here</a>.
If you have similar data for your area, contact me and we can add support for
it!</p>
<h3 id="custom-import"><a class="header" href="#custom-import">Custom import</a></h3>
<p>See <a href="tech/trafficsim/../dev/formats/scenarios.html">here</a>.</p>
<h2 id="modifying-demand"><a class="header" href="#modifying-demand">Modifying demand</a></h2>
<p>The travel demand model is extremely fixed; the main effect of a different
random number seed is currently to initially place parked cars in specific
spots. When the player makes changes to the map, exactly the same people and
trips are simulated, and we just measure how trip time changes. This is a very
short-term prediction. If it becomes much more convenient to bike or bus
somewhere, then more people will do it over time. How can we transform the
original demand model to respond to these changes?</p>
<p>Right now, there's very preliminary work in sandbox mode for Seattle weekday
scenarios. You can cancel all trips for some people (simulating lockdown) or
modify the mode for some people (change 50% of all driving trips between 7 and
9am to use transit).</p>
<h2 id="research"><a class="header" href="#research">Research</a></h2>
<ul>
<li><a href="https://github.com/replicahq/doppelganger">https://github.com/replicahq/doppelganger</a></li>
<li><a href="https://github.com/stasmix/popsynth">https://github.com/stasmix/popsynth</a></li>
<li><a href="https://zephyrtransport.github.io/zephyr-directory/projects/">https://zephyrtransport.github.io/zephyr-directory/projects/</a></li>
<li><a href="https://activitysim.github.io">https://activitysim.github.io</a></li>
<li><a href="https://github.com/BayAreaMetro/travel-model-one">https://github.com/BayAreaMetro/travel-model-one</a></li>
<li><a href="https://github.com/RSGInc/DaySim">https://github.com/RSGInc/DaySim</a></li>
<li><a href="https://github.com/arup-group/pam">https://github.com/arup-group/pam</a></li>
<li><a href="https://spatial-microsim-book.robinlovelace.net/smsimr.html">https://spatial-microsim-book.robinlovelace.net/smsimr.html</a></li>
<li><a href="https://github.com/DLR-VF/TAPAS">https://github.com/DLR-VF/TAPAS</a></li>
<li><a href="https://sumo.dlr.de/docs/Demand/Activity-based_Demand_Generation.html">https://sumo.dlr.de/docs/Demand/Activity-based_Demand_Generation.html</a></li>
<li><a href="https://www.youtube.com/watch?v=oYUZp4I3ksE&amp;t=213s">Watch Dogs: Legion</a> has a
synthetic population of London, generating individual detail lazily from real
statistical data</li>
</ul>
<h2 id="future-ideas"><a class="header" href="#future-ideas">Future ideas</a></h2>
<h3 id="uk-data-sources"><a class="header" href="#uk-data-sources">UK data sources</a></h3>
<p>Currently A/B Street is using
<a href="https://www.ons.gov.uk/census/2011census/2011censusdata/originanddestinationdata">2011 flow data</a>
-- specifically WU03UK (the location of usual residence and place of work by
method of travel to work).</p>
<p>There are some others to consider:</p>
<ul>
<li>WF01AEW_oa from
<a href="https://wicid.ukdataservice.ac.uk/flowdata/cider/wicid/downloads.php">here</a>
has even more granular home&lt;-&gt;work zones
<ul>
<li>Need to compare to
<a href="https://webarchive.nationalarchives.gov.uk/ukgwa/20160202161811/http://www.nomisweb.co.uk/census/2011/wf01bew">WF01BEW</a></li>
</ul>
</li>
<li><a href="https://www.nomisweb.co.uk/sources/ukbc">https://www.nomisweb.co.uk/sources/ukbc</a> could be used to understand how many
people work at different places</li>
<li><a href="https://github.com/ITSLeeds/NTEM2OD/">NTEM</a> has forecasted OD pairs</li>
<li><a href="http://quant.casa.ucl.ac.uk/">QUANT</a> and <a href="https://geospenser.com/">SPENSER</a>
are two other population and activity/time-use datasets, used by another
project I'm working on called
<a href="https://github.com/Urban-Analytics/RAMP-UA">RAMP</a></li>
</ul>
<h3 id="use-cases-1"><a class="header" href="#use-cases-1">Use cases</a></h3>
<p>What're all the uses of an accurate travel demand model? And when might it be
helpful to represent synthetic people with more info than just their daily
trips?</p>
<ul>
<li>the obvious: traffic simulation</li>
<li>Ungap the Map's mode shift calculation -- look for short driving trips, then
check the network to see if there are common gaps that might prevent cycling.
Do we need to understand the demographics of people taking these &quot;possible to
switch&quot; trips?</li>
<li>the LTN tool's impact predicton -- without using traffic simulation, just
calculate routes before and after changes</li>
<li>Equity and health analysis
<ul>
<li>If we think some interventions might cause higher traffic (and thus
noise/air pollution and safety issues) on major roads, who lives near the
affected area?</li>
</ul>
</li>
</ul>
<h3 id="validation--calibration"><a class="header" href="#validation--calibration">Validation / calibration</a></h3>
<p>How do we judge whether a given travel demand model is &quot;good&quot;?</p>
<p>For comparing two different models, one idea is to &quot;re-aggregate&quot; individual
trips from each of them and see if overall counts look similar. For example,
partition the map into zones (maybe using zones that one of the models being
compared used originally, or maybe making up new ones), count the trips between
zones, and compare between models -- grouping by departure time and mode, or
not.</p>
<p>This comparison could sanity check that roughly the same number of people live
and commute to the same places. But it's not a very satisfying judgment, because
it's not really what we're trying to measure. I think the validation that makes
sense is to plug the model into an analysis we actually care about and where we
have real observations. One of the simplest -- and most useful for LTN impact
prediction, particularly -- is just estimating traffic volumes at different
roads and intersections.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gridlock"><a class="header" href="#gridlock">Gridlock</a></h1>
<p>Here &quot;gridlock&quot; refers to the general problem of trips getting permanently
stuck, preventing the full simulation from completing. Most of the work is
tracked <a href="https://github.com/a-b-street/abstreet/issues/114">here</a>.</p>
<p>The general lesson is: you can't code your way around all edge cases. The data
in OSM often needs manual fixes. It's often useful to spend coding effort on
tools to detect and fix OSM problems.</p>
<h2 id="problems"><a class="header" href="#problems">Problems</a></h2>
<p>The choices in the movement model matter. Some gridlock is inherent to any
system with queueing and conflicting turns. But in reality, people wiggle around
partly blocked turns. And some of this comes from the treatment of the
front/back of vehicles.</p>
<ul>
<li>Short roads in OSM causing very weird geometry</li>
<li>Intersection geometry being too large, requiring too much time to cross</li>
<li>Unrealistic traffic patterns caused by everyone trying to park in one big
garage (downtown) or take some alley (the UW soundcast issue)</li>
<li>Too many people try to take an unprotected left turn (often at a stop sign)</li>
<li>Bad individual traffic signals, usually at 5- or 6-ways</li>
<li>Groups of traffic signals logically acting as a single intersection</li>
<li>Separate traffic signals along a corridor being unsynchronized</li>
<li>Vehicles performing illegal sequences of turns</li>
<li>Vehicles are stuck with their plan and not reacting to traffic by changing
route</li>
<li>Real traffic would result in a gridlock without a deliberate actions to avoid
it. Such actions range from individual decisions of drivers to police manually
controlling traffic. Intelligent avoidance of gridlock is not simulated and is
extremely hard to simulate.</li>
<li>Vehicles will wait in lane filled with already waiting vehicles, even if there
is a completely empty lane allowing travel in desired direction. It makes
easier for entire lane between crossings to fill, contributing to gridlocks.
Note that while this and other clearly stupid behaviors are clearly
unrealistic, it is not trivial to implement more realistic and more efficient
decisions.</li>
<li>Issues caused by the unrealistic
<a href="tech/trafficsim/discrete_event/index.html#lane-changing">lane-changing model</a>
<ul>
<li>Two turns that go to the same lane (one going &quot;straight&quot;, the other often a
lane-change) conflict. The conflict is coarse, at the granularity of the
entire intersection. So if vehicles are piled up in two lanes trying to
merge into one, then one group is likely to go through as expected, but the
second group will wait for the first to completely clear the intersection.
Until then, it looks like a conflicting turn is being done.</li>
</ul>
</li>
</ul>
<h2 id="solutions"><a class="header" href="#solutions">Solutions</a></h2>
<p>Divide into implemented or not.</p>
<ul>
<li>Synchronizing pairs of signals</li>
<li>Uber-turns
<ul>
<li>for interpreting OSM turn restrictions</li>
<li>for synchronizing a group of signals</li>
<li>for locking turn sequences
<ul>
<li>Once a vehicle starts an uber-turn, prevent others from starting
conflicting turns on nearby intersections. Until groups of traffic signals
are configured as one, this is necessary to prevent somebody from making
it halfway through a sequence then getting blocked.</li>
</ul>
</li>
</ul>
</li>
<li>Cycle detector</li>
<li>block-the-box protection
<ul>
<li>the manual list of overrides</li>
<li>likely shouldn't apply during uber-turns</li>
<li>is it always fine to block the box at degenerate intersections?</li>
</ul>
</li>
<li>hacks to allow conflicting turns at really broken intersections</li>
<li>manually timing signals</li>
<li>penalties for lane choice to make lane usage realistic</li>
</ul>
<h3 id="not-implemented"><a class="header" href="#not-implemented">Not implemented</a></h3>
<ul>
<li>Dynamic rerouting</li>
<li>Allow multiple vehicles through intersection at once if there is enough space
on lane where given vehicle is going. Currrently vehicles travel through
crossings one by one (or, with <code>--disable_block_the_box</code> enabled - will enter
crossing even if leaving it will be impossible).</li>
<li>Last resort: if someone's waiting on a turn &gt;5m, just go.</li>
<li>Uber-turns
<ul>
<li>Group both stop sign and traffic signal intersections when looking for
uber-turns. Even a single traffic signal surrounded by tiny roads with stop
signs is causing problems.</li>
</ul>
</li>
</ul>
<h2 id="strategy-for-resolving"><a class="header" href="#strategy-for-resolving">Strategy for resolving</a></h2>
<p>Because there are so many different causes all tangled together, my approach is
to simplify the simulation as much as possible. A problem is much easier to
understand and fix when it's isolated. I've been trying this to get the downtown
weekday scenario to complete. A list of different techniques to simplify, in no
particular order:</p>
<ul>
<li>Use the <code>--infinite_parking</code> flag to just let everyone park directly in their
destination buildings. This is useful since downtown has many large parking
garages with high capacity, but I don't have a data source describing them.</li>
<li>Use the <code>--disable_turn_conflicts</code> flag, which greatly reduces realism, but
lets conflicting turns happen simultaneously. (Even with this and other flags,
downtown still gridlocks!) It also disables traffic signals, so bad inferred
timing isn't an issue.</li>
<li>Use the <code>--disable_block_the_box</code> flag to workaround short roads.</li>
<li>If you notice problems forming from cars stacking up behind slower cyclists,
there's no over-taking implemented yet. Use the scenario modifiers to convert
all biking trip to driving:
<code>--scenario_modifiers='[{&quot;ChangeMode&quot;:{&quot;to_mode&quot;:&quot;Drive&quot;,&quot;pct_ppl&quot;:100,&quot;departure_filter&quot;:[0.0,86400.0],&quot;from_modes&quot;:[&quot;Bike&quot;]}}]'</code></li>
<li>If all else fails, use the scenario modifiers to bluntly cancel some
percentage of all trips.</li>
</ul>
<p>A quick method for &quot;disabling&quot; buggy short roads is to use edit mode and close
the lanes. This forces traffic to reroute around the problematic area, which
might create other problems, but it can be useful.</p>
<h2 id="fixing-data-used-in-simulation"><a class="header" href="#fixing-data-used-in-simulation">Fixing data used in simulation</a></h2>
<p>Give more examples of changesets.</p>
<ul>
<li>upstreaming turn restrictions into OSM to prevent invalid U-turns and other
crazy movements
<ul>
<li>ex: <a href="https://www.openstreetmap.org/changeset/87945050">https://www.openstreetmap.org/changeset/87945050</a></li>
</ul>
</li>
<li>upstreaming lane count fixes into OSM to improve geometry</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="multi-modal-trips"><a class="header" href="#multi-modal-trips">Multi-modal trips</a></h1>
<p>A single trip consists of a sequence of <code>TripLegs</code> -- walking, operating a
vehicle (car or bike), and riding the bus. Depending whether a trip begins or
ends at a border or building, there are many combinations of these sequences.
This is a way to categorize them into three groups. I'm not sure it's the
simplest way to express all the state transitons.</p>
<h2 id="walking-only-trips"><a class="header" href="#walking-only-trips">Walking-only trips</a></h2>
<p><img src="tech/trafficsim/walking_only_trips.svg" alt="walking_only_trips" /></p>
<h2 id="trips-starting-from-a-border"><a class="header" href="#trips-starting-from-a-border">Trips starting from a border</a></h2>
<p><img src="tech/trafficsim/trips_from_border.svg" alt="trips_from_border" /></p>
<h2 id="trips-starting-from-a-building"><a class="header" href="#trips-starting-from-a-building">Trips starting from a building</a></h2>
<p><img src="tech/trafficsim/trips_from_building.svg" alt="trips_from_building" /></p>
<h2 id="spawning-code-overview"><a class="header" href="#spawning-code-overview">Spawning code overview</a></h2>
<p>As of January 2021, starting a traffic simulation works like this:</p>
<ol>
<li>Something creates a <code>Scenario</code>, which defines a bunch of people. Each person
has a schedule of trips, carrying them between <code>TripEndpoints</code> via some
<code>TripMode</code>, leaving at some <code>Time</code>.</li>
<li>When a scenario is instantiated, not much happens besides scheduling the trip
to start at the appropriate time and filling out <code>TripInfo</code> in <code>TripManager</code>.
Some state in <code>StartTripArgs</code> has to be plumbed forward in the
<code>Command::StartTrip</code>.</li>
<li>When the command gets run later, <code>TripManager::start_trip</code> happens. The
origin, destination, and mode flow through <code>TripSpec::maybe_new</code>.</li>
<li><code>TripSpec::to_plan</code> further validates these and attempts to repair impossible
plans. Each <code>TripSpec</code> is turned into a list of <code>TripLegs</code>.</li>
<li>Each <code>TripSpec</code> has its own initialization logic to kick off the first leg of
the trip.</li>
<li>Most trips have multiple legs. When the first car, bike, or pedestrian
reaches their goal, <code>TripManager</code> gets called with some sort of transition
function to initiate the next leg of the trip, or declare the trip finished.
These transition functions also record stats from that leg of the trip, like
total blocked time.</li>
</ol>
<p>What're the different <code>TripSpec</code> cases, and what <code>TripLegs</code> do they get turned
into?</p>
<ul>
<li><code>VehicleAppearing</code>: Starts at a border. Drive, then maybe walk to the
destination building.</li>
<li><code>SpawningFailure</code>: No trip legs; just create and immediately cancel the trip.</li>
<li><code>UsingParkedCar</code>: Starts at a building. Walk (to the parked car), drive, then
maybe walk to the destination building (after parking again).</li>
<li><code>JustWalking</code>: Just walk between two buildings/borders.</li>
<li><code>UsingBike</code>: Starts at a building. Walk to the nearest bikeable lane, drive,
then maybe walk to the destination building. (Note that starting a bike from a
border uses <code>VehicleAppearing</code>.)</li>
<li><code>UsingTransit</code>: Walk, ride the bus, maybe walk again. No transfers yet; only
rides one bus between two stops.</li>
</ul>
<p><code>TripManager</code> has a whole bunch of transition functions:</p>
<ul>
<li><code>car_reached_parking_spot</code>: drive -&gt; walk, unless the destination building is
where we parked</li>
<li><code>ped_reached_parking_spot</code>: walk -&gt; drive</li>
<li><code>ped_ready_to_bike</code>: walk -&gt; bike</li>
<li><code>bike_reached_end</code>: bike -&gt; walk</li>
<li><code>ped_reached_building</code>: walk -&gt; done</li>
<li><code>ped_reached_bus_stop</code>: walk -&gt; wait or ride bus</li>
<li><code>ped_boarded_bus</code>: waiting -&gt; ride bus</li>
<li><code>person_left_bus</code>: riding bus -&gt; walk</li>
<li><code>ped_reached_border</code>: walk -&gt; done</li>
<li><code>transit_rider_reached_border</code>: ride bus -&gt; done</li>
<li><code>car_or_bike_reached_border</code>: drive -&gt; done</li>
</ul>
<p>There are at least a few use cases motivating the cleanup of all of this
structure:</p>
<ul>
<li>Capping trips through congested areas. Sometimes this just changes the driving
route, but sometimes it needs to cancel trips, convert driving trips to
walking/transit, or delay the trip's start.</li>
<li>Multiple public transit rides in a single trip, aka transferring</li>
<li>Handling live map edits in the middle of a trip</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="live-edits-1"><a class="header" href="#live-edits-1">Live edits</a></h1>
<p>When the player edits the map, there's an <a href="tech/trafficsim/../map/edits.html">efficient process</a>
for applying the edits at the map model and rendering layer. In the middle of a
simulation, it's less obvious how to apply all edits. Most of the time
currently, edits cause the simulation to reset to midnight. Applying edits to
the sim without reset is important for running machine learning experiments and
for improving the gameplay experience (by having more immediate feedback about
the consequences of a change).</p>
<p>The UI has a <code>dirty_from_edits</code> bit to track when changes have been applied
without reset. This lets us tell the player that by the end of the day, any
score / results are tentative, because their edits might have a different effect
earlier in the day.</p>
<h2 id="what-works-today"><a class="header" href="#what-works-today">What works today</a></h2>
<p>Changes to traffic signals are simple -- <code>incremental_edit_traffic_signal</code>
happens at the map layer, and then <code>handle_live_edited_traffic_signals</code> at the
sim layer just resets the current stage to 0 if the previous configuration had
more stages.</p>
<h2 id="todo-recalculating-paths"><a class="header" href="#todo-recalculating-paths">TODO: Recalculating paths</a></h2>
<p>Many of the edits will influence routes. For trips that haven't started yet,
there's nothing to do immediately. Paths are calculated right before the trip
starts, so slight changes to the start/end of the path due to map edits (like
where somebody starts biking, for example) are captured naturally.</p>
<p>For currently active trips, in some cases, rerouting would be ideal but not
necessary (like if speed limits changed). In other cases -- like changing access
restrictions, modifying lane types, closing intersections -- the route must be
recomputed. As a simple first attempt, we could just cancel all active trips
whose path crosses an edited road or intersection. Later, we can figure out
rerouting.</p>
<p>And actually, the only other case to handle is <code>ChangeRouteSchedule</code>, which
should just be rescheduling the <code>StartBus</code> commands.</p>
<h2 id="todo-parking"><a class="header" href="#todo-parking">TODO: Parking</a></h2>
<p>What happens if you modify a parking lane while there are cars on it? For now,
just delete them. Trips later making use of them will just act as if the car
never had room to be spawned at all and get cancelled or fallback to walking.</p>
<p>A better resolution would be to relocate them to other parking spots. If the
owner is home, it'd be neat to have them walk outside, move the car, and go back
in. But this greatly complicates the simulation -- the edited lane is in a
transition state for a while, it modifies schedules, the person might not be
around, etc.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="parking"><a class="header" href="#parking">Parking</a></h1>
<p>In some areas, lots of traffic is caused by people circling around the block in
search of parking. And often, a great deal of space in a city is spent on street
parking, surface lots, and garages. So, A/B Street attempts to model parking as
a step at the beginning and end of every driving trip.</p>
<h2 id="types-of-parking"><a class="header" href="#types-of-parking">Types of parking</a></h2>
<p>Every parking spot can be categorized as public or private. Anybody can use
public spots, but only trips beginning or ending at a particular building can
use private spots inside of it. There's no modeling yet of time limits or fees.</p>
<p>On-street parking acts as one lane of the road. The full length of the lane gets
divided up into spots with a per-city configurable length, called
<code>street_parking_spot_length</code>, with a default of 8 meters. This is the only type
of parking that players can edit in-game, by changing lane types. Street parking
is always public.</p>
<p>Parking lots are also always public. OSM includes the service &quot;aisles&quot; running
through the lot, and A/B Street automatically packs in individual spots, winding
up with an estimate of the capacity.</p>
<p><img src="tech/trafficsim/parking_lot.png" alt="parking_lot" /></p>
<p>Off-street parking is part of a building. Physically this could mean a parking
garage, a small private lot behind some apartments, or a few spots in a carport
and driveway -- there's no distinction in A/B Street. Off-street parking can be
public or private.</p>
<h2 id="data-sources-2"><a class="header" href="#data-sources-2">Data sources</a></h2>
<p>On-street parking comes from OSM, using the
<a href="https://wiki.openstreetmap.org/wiki/Key:parking:lane">parking:lane</a> tags. This
field is rarely mapped; see <a href="tech/trafficsim/../../software/parking_mapper.html">here</a> to help
with that. Different cities can optionally configure some percentage of
residential roads to automatically infer a parking lane or two.</p>
<p>Parking lots only come from OSM. Individual spots and capacity is almost never
mapped, so A/B Street doesn't use that data.</p>
<p>Public off-street parking is only configured for Seattle right now, and comes
from
<a href="https://data-seattlecitygis.opendata.arcgis.com/datasets/public-garages-or-parking-lots">this dataset</a>.</p>
<p>I've yet to find any data that would help estimate private off-street parking.
For now, this is per-city configuration, called <code>FixedPerBldg</code>. We could
definitely do better by estimating building size. There's an exception for two
Seattle maps currently -- the number of off-street spots is set to equal the
number of driving trips that originate from that building over the course of the
entire day. This is also unrealistic, but was some attempt at improving those
two maps.</p>
<h2 id="simulation"><a class="header" href="#simulation">Simulation</a></h2>
<p>This seems like a good place to preface that A/B Street doesn't have any kind of
car-sharing, ride-share, or even multiple people in one car yet.</p>
<h3 id="seeding-cars"><a class="header" href="#seeding-cars">Seeding cars</a></h3>
<p>See
<a href="https://github.com/a-b-street/abstreet/blob/master/sim/src/make/scenario.rs">seed_parked_cars</a>
for reference.</p>
<p>When a simulation starts at midnight, where are cars initially placed? That
process first figures out how many cars are needed per building through the day.
If 100 driving trips originate from that building, you might think the building
needs 100 cars nearby. But many of these trips might actually arrive at the
building earlier using a car, in which case, when the same person later departs,
they'll take their car.</p>
<p>After this count per building is produced, we place each car as close as
possible to its building, only going far away as we run out of capacity. We
always prefer seeding a car inside a building than on the street or in a lot.
The list of cars to seed is shuffled, so that roughly helps with fairness -- we
don't fill in all of one building's cars first, then go the next -- that would
arbitrarily place one building's cars closer.</p>
<p>There's also a detail in this randomization process about the available spots.
The consequence is this: when a player makes a few changes to the amount of
street parking in an area, the effects shouldn't percolate everywhere and change
how cars are seeded far away -- unless the change adds/removes so much capacity
that the effect really would spill out that far.</p>
<h3 id="how-people-pick-a-spot"><a class="header" href="#how-people-pick-a-spot">How people pick a spot</a></h3>
<p>When a car gets to the last lane before its target building, it starts looks for
a free spot. If there's one on the current lane, it goes for it. If not, it uses
a breadth-first search, using distance, to explore from its current lane until
it finds a free spot. To avoid many cars in one area all contending for the same
spot, the distance used in the search has some randomized scaling applied.
Omnisciently knowing where free spots are located far away isn't realistic, but
attempting some kind of human-realistic random walk seems even harder to get
right.</p>
<h3 id="infinite-parking"><a class="header" href="#infinite-parking">Infinite parking</a></h3>
<p>If you pass <code>--infinite_parking</code> on the command line, every building gets
unlimited public spots. This effectively removes the effects of parking from the
model, since driving trips can always begin or end at their precise building
(except for blackhole cases). This is useful if a particular map has poor
parking data and you need to get comparative results about speeding up some
trips. Often the A/B testing is extremely sensitive, because a parking space
close to someone's destination is filled up quickly, slowing down the trip.</p>
<h3 id="blackholes"><a class="header" href="#blackholes">Blackholes</a></h3>
<p>Vehicles don't know how to turn left (or right for UK folks) from a driveway
yet. This means that some buildings and street parking lanes near map boundaries
might not be reachable from most of the map. Consequently, even though there
might be parking there, the simulation ignores it, because it's &quot;blackholed&quot;.</p>
<p><img src="tech/trafficsim/blackhole.png" alt="blackhole" /></p>
<h2 id="data-viz"><a class="header" href="#data-viz">Data viz</a></h2>
<p>There are 3 tools in the game that'll help you understand the effects of how
parking is modeled.</p>
<p><img src="tech/trafficsim/parking_occupancy.png" alt="parking_occupancy" /></p>
<p>The parking occupancy layer shows where parking spots are currently available.</p>
<p><img src="tech/trafficsim/parking_efficiency.png" alt="parking_efficiency" /></p>
<p>The parking efficiency layer shows how far away from their destination somebody
was forced to park. If you see lots of dark red dots, then people wound up
parking somewhere, then walking a long way to actually get to their building.
This is probably unrealistic, likely due to bad guesses about capacity in
different areas.</p>
<p><img src="tech/trafficsim/parking_overhead.png" alt="parking_overhead" /></p>
<p>The parking overhead dashboard looks at every driving trip that included a
parking phase. It measures how much of the total trip time was spent actually
driving, vs looking for parking and covering any remaining distance by foot.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="project-logistics"><a class="header" href="#project-logistics">Project logistics</a></h1>
<p>This has some background/logistics about the project.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="team"><a class="header" href="#team">Team</a></h1>
<p>The core group:</p>
<ul>
<li><a href="https://dcarlino.org">Dustin Carlino</a></li>
<li><a href="https://www.yuwen-li.com/">Yuwen Li</a> (UX)</li>
<li><a href="https://github.com/michaelkirk">Michael Kirk</a></li>
</ul>
<p>Collaborators from other projects:</p>
<ul>
<li><a href="https://www.robinlovelace.net/">Robin Lovelace</a> on
<a href="https://actdev.cyipt.bike/">ActDev</a> and
<a href="https://github.com/a-b-street/abstr/">demand modelling in R</a></li>
<li>Xuesong Zhou of
<a href="https://github.com/asu-trans-ai-lab">ASU's Transportation AI Lab</a> on
<a href="https://github.com/zephyr-data-specs/GMNS">GMNS integration</a></li>
</ul>
<h2 id="full-credits"><a class="header" href="#full-credits">Full credits</a></h2>
<p>Programming:</p>
<ul>
<li>All <a href="https://github.com/a-b-street/abstreet/graphs/contributors">contributors</a></li>
<li><a href="https://www.trevornederlof.me/">Trevor Nederlof</a> 15m explorer and census</li>
<li>Pandemic modeling by Orestis Malaspinas (<a href="mailto:project/orestis.malaspinas@hesge.ch">orestis.malaspinas@hesge.ch</a>)</li>
<li>OSM expertise courtesy <a href="https://github.com/matkoniecz">Mateusz Konieczny</a></li>
<li>Lots of helpful PRs from <a href="https://github.com/RestitutorOrbis">Javed Nissar</a></li>
<li>Lots of traffic signal and uber-turn work from
<a href="https://github.com/BruceBrown">Bruce</a></li>
<li><a href="https://github.com/a-b-street/osm2lanes">osm2lanes</a> by [Michael Droogleever</li>
<li>Fortuyn](https://github.com/droogmic) and [Ben</li>
<li>Ritter](https://github.com/BudgieInWA)</li>
</ul>
<p>Graphics / design:</p>
<ul>
<li>Logo by <a href="https://www.ryandpierson.com/">Ryan Pierson</a></li>
<li>Graphic design advice from <a href="http://starcatgames.com/">Starcat Games</a>,
<a href="https://somethingaboutmaps.wordpress.com/">Daniel Huffman</a>,
<a href="http://thebaprince.com/">Brian Prince</a></li>
<li>Character art by <a href="http://www.hollyhansel.com/">Holly Hansel</a></li>
<li>In-game character faces adapted from
<a href="https://github.com/anokhee/visual-synthesizer">Anokhee Jandhyala</a></li>
<li>Game design advice from Christopher Klein</li>
<li>Color and street rendering help from
<a href="https://github.com/westnordost">Tobias Zwick</a> of
<a href="https://github.com/streetcomplete/StreetComplete">StreetComplete</a></li>
<li>Additional UX design and research from <a href="https://trang.io">Trang Le</a>,
<a href="https://www.mara-cruz.com">Mara Cruz</a>, and
<a href="https://www.cindykhuang.me">Cindy Huang</a></li>
</ul>
<p>Software dependencies:</p>
<ul>
<li>Lightning-fast pathfinding thanks to
<a href="https://github.com/easbar/fast_paths">fast_paths</a> by Andreas Barth
(<a href="mailto:project/easbar.mail@posteo.net">easbar.mail@posteo.net</a>)</li>
<li>Lots of help with rendering SVG and fonts from
<a href="https://github.com/RazrFalcon">RazrFalcon</a> and
<a href="https://github.com/nical">nical</a></li>
<li><a href="https://github.com/eldang/elevation_lookups">Elevation data</a> from
<a href="https://eldang.xyz/">Eldan</a></li>
</ul>
<p>Networking:</p>
<ul>
<li>Hackathon drop-ins from <a href="https://www.democracylab.org/">Democracy Lab</a> events</li>
<li><a href="https://cugos.org/">CUGOS</a> and <a href="http://julianmichael.org/">Julian Michael</a>
have been great sounding boards for ideas since the beginning</li>
</ul>
<p>Product management / community outreach:</p>
<ul>
<li><a href="https://jending.com">Jennifer Ding</a></li>
</ul>
<p>Data:</p>
<ul>
<li>Special thanks to all <a href="https://www.openstreetmap.org/about">OpenStreetMap</a>
contributors!</li>
<li><a href="https://www.kingcounty.gov/services/gis.aspx">King County GIS</a></li>
<li><a href="https://data.seattle.gov/">Seattle Open Data</a></li>
<li><a href="https://www.psrc.org/">Puget Sound Regional Council</a></li>
<li><a href="https://www.nhgis.org">IPUMS NHGIS, University of Minnesota</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributing"><a class="header" href="#contributing">Contributing</a></h1>
<p>Lots of people are interested in this project, with very diverse backgrounds.
This page isn't meant to be prescriptive or limit options; it's just a starter.</p>
<h2 id="programming"><a class="header" href="#programming">Programming</a></h2>
<p>The biggest hurdle here is that A/B Street is written in Rust, a language that
may have a high entry barrier. If you're more comfortable in Python, R, or
something else, there are still ways to contribute -- particularly producing
input data for A/B Street to simulate.</p>
<h3 id="machinereinforcement-learning"><a class="header" href="#machinereinforcement-learning">Machine/reinforcement learning</a></h3>
<p>If you're a researcher looking for a complex multi-agent simulation with lots of
things to optimize, you've found the right place. We have a simple
<a href="project/../tech/dev/api.html">JSON API</a> already you can plug into, but we'd love to
improve this based on your use case. Particularly cool ideas could be
auto-tuning traffic signal timing or calibrating travel demand scenarios to
real-world throughput/delay measurements.</p>
<h3 id="transportation-modelling"><a class="header" href="#transportation-modelling">Transportation modelling</a></h3>
<p>Do you sling around population and aggregated origin/destination data with R or
Python? Great, help us generate realistic
<a href="project/tech/dev/formats/scenarios.html">travel demand models</a>! Work in whatever language
you like best; we'll settle on a common format.</p>
<h3 id="working-on-ab-street-itself"><a class="header" href="#working-on-ab-street-itself">Working on A/B Street itself</a></h3>
<p>You'll need to learn at least some Rust to start here. We can help you a bit
with that, especially by recommending starter projects or giving feedback in
PRs, but this requires a fair bit of independence.</p>
<p>There's so many different types of things to work on -- see our
<a href="project/hiring.html">hiring page</a> and
<a href="https://github.com/a-b-street/abstreet/issues">Github issues</a>.</p>
<h3 id="data-visualization--analysis"><a class="header" href="#data-visualization--analysis">Data visualization / analysis</a></h3>
<p>A/B Street generates loads of individual data through the simulation, but
deciding what's important, how to aggregate things, what filters/controls to
give to the user, and how to communicate trade-offs is really hard!</p>
<p>We can export data however's useful -- there's a few CSV files that the UI can
export today. You can work on analyzing and visualizing the data using whatever
tools you like. To actually implement a new dashboard in A/B Street, we'll
implement it in Rust, but we can implement/copy what you produce elsewhere.</p>
<p>Some examples where we need help:</p>
<ul>
<li>How to aggregate and compare the number of &quot;risky events&quot; somebody encounters
on their trip, possibly using some kind of contingency matrix. See
<a href="https://github.com/a-b-street/abstreet/pull/622">this PR</a> for some discussion
and open questions</li>
<li>How to show roads with more/less traffic. See this
<a href="https://github.com/a-b-street/abstreet/issues/85">discussion</a></li>
</ul>
<h2 id="design"><a class="header" href="#design">Design</a></h2>
<p>We wouldn't have made it to this point without loads of help from our UX
designer. We could always use more help here. We use Figma for designs
currently.</p>
<h3 id="graphics"><a class="header" href="#graphics">Graphics</a></h3>
<p>From what I've seen, no other street map attempt to include lane markings and as
much detail as A/B Street. This means there's not much cartography to take
inspiration from. Some places we need help:</p>
<ul>
<li>Showing arterial vs small residential roads while zoomed in</li>
<li>Conveying more information about buildings and land use -- is it a small
house, some apartments, a shop, a mall, a multi-use development?</li>
<li><a href="https://github.com/a-b-street/abstreet/issues/74">Tuning the color-scheme</a>,
especially in a color-blind friendly way</li>
<li>Visualizing
<a href="https://github.com/a-b-street/abstreet/issues/660">low traffic neighborhoods</a></li>
<li>Many people can't recognize the pedestrians and cyclists; how do we represent
them better in our 2D top-down view? What should e-scooters look like?</li>
</ul>
<h3 id="storyboarding"><a class="header" href="#storyboarding">Storyboarding</a></h3>
<p>We didn't start A/B Street with a clear set of product requirements or a
storyboard for how it should work -- and we've been paying the price of this all
along. But newer tools like the <a href="project/../software/fifteen_min.html">15-minute explorer</a>
or the idea for a
<a href="https://github.com/a-b-street/abstreet/issues/660">low-traffic neighborhood planner</a>
are focused and young enough where we could properly plan out the features and
UI.</p>
<h3 id="game-design"><a class="header" href="#game-design">Game design</a></h3>
<p>A/B Street <em>tries</em> to be a game, but it falls pretty short. Want to help us
improve the <a href="https://github.com/a-b-street/abstreet/issues/611">tutorial</a>? Have
some ideas how to split up levels in the challenge mode? Know how to write a
story? Help us!</p>
<p>Or maybe you can imagine a new spin-off game reusing some of the work that
exists today. That's how <a href="project/../software/santa.html">15-minute Santa</a> happened!</p>
<h2 id="using-ab-street"><a class="header" href="#using-ab-street">Using A/B Street</a></h2>
<h3 id="you-have-an-idea-for-fixing-something-in-your-city"><a class="header" href="#you-have-an-idea-for-fixing-something-in-your-city">You have an idea for fixing something in your city</a></h3>
<p>That's why we made this! Just go try and make the change, initially without help
from us. Write down your experience and all of the problems you hit. Then tell
us the problems and any ideas for fixing them.</p>
<p>Then write up a <a href="project/../proposals/index.html">proposal</a> and start advocating for it!</p>
<h3 id="youre-an-advocacy-group"><a class="header" href="#youre-an-advocacy-group">You're an advocacy group</a></h3>
<p>If you want to use A/B Street to argue for some change in your city, get in
touch! It's easiest if you:</p>
<ul>
<li>Tell us very clearly what you need</li>
<li>Draw a <a href="project/../user/new_city.html">study area</a></li>
<li>Have a pretty specific idea of what roads/intersections you want to actually
change</li>
<li>Have an idea of how you want to communicate your idea; browse
<a href="project/../proposals/index.html">our proposals</a> for inspiration</li>
</ul>
<h3 id="researching-car-free-cities"><a class="header" href="#researching-car-free-cities">Researching car-free cities</a></h3>
<p>Maybe you're studying urban planning and think our software can help. We have
some of the tools to get you started -- importing a new map, changing road
configuration and access, measuring comparative results. But you'll probably
have to work with us directly to fix up the map data and get a proper demand
model. You can help us by giving usability feedback about what's hard to do and
ideas for things to add. We're not experts in planning -- if you can tell us how
software can help you do your job better, let's talk!</p>
<h3 id="usability-studies"><a class="header" href="#usability-studies">Usability studies</a></h3>
<p>Every so often, we conduct formal usability studies. You'll spend an hour on a
videocall doing something in A/B Street and vocalizing your thought process and
what problems you hit. We'll use your feedback to find and fix problems.</p>
<p>We only run these every now and then; just contact us to get on the list for the
next round.</p>
<h3 id="reporting-bugs"><a class="header" href="#reporting-bugs">Reporting bugs</a></h3>
<p>You're bound to hit problems using our software -- just
<a href="https://github.com/a-b-street/abstreet/issues/new">file an issue</a> when you do.</p>
<h2 id="improving-data-quality"><a class="header" href="#improving-data-quality">Improving data quality</a></h2>
<p>A/B Street relies on having an accurate and up-to-date model of your city. What
do you do when it's wrong?</p>
<h3 id="fix-incorrect-lane-data"><a class="header" href="#fix-incorrect-lane-data">Fix incorrect lane data</a></h3>
<p>The most common problem is that a road has the wrong number of lanes, or
turn/bike/parking lanes are missing. If you know how to edit OpenStreetMap
already, go fix it. If not, you can use the lane editor in A/B Street to fix the
problem and make the road match reality. Send us your edits, and we can help
make the fix in OSM.</p>
<h3 id="openstreetmap-mapper"><a class="header" href="#openstreetmap-mapper">OpenStreetMap mapper</a></h3>
<p>Are you already involved in OSM and want to validate your work? Use
<a href="project/../software/osm_viewer.html">our tool</a> to help you visualize lane tagging easily.
Keep in mind there are some problems with this viewer that might not reflect
problems with the data in OSM -- particularly separate foot/cyclepaths and weird
intersection geometry.</p>
<p>Or maybe you think your city is incredibly well-mapped already -- I bet it's
missing one thing. Please map <a href="project/../software/parking_mapper.html">street parking</a> --
we need this to guess road widths.</p>
<h2 id="project-logistics-1"><a class="header" href="#project-logistics-1">Project logistics</a></h2>
<h3 id="networking--marketing"><a class="header" href="#networking--marketing">Networking / marketing</a></h3>
<p>Know an advocacy group or city authority who would want to use our work? Make
the connection!</p>
<h3 id="project-management"><a class="header" href="#project-management">Project management</a></h3>
<p>Organizing all of the information, ideas, and people involved with this project
is hard. Just writing this page and website took way too many tears and
caffeine! We could also use help prioritizing work and coming up with
requirements for new ideas.</p>
<h3 id="write-documentation"><a class="header" href="#write-documentation">Write documentation</a></h3>
<p>This website is <a href="https://github.com/a-b-street/docs">easy to edit</a>. We could
especially use help writing a user guide -- describe how different tools in A/B
Street work, or work through examples of how to do stuff.</p>
<h3 id="funding"><a class="header" href="#funding">Funding</a></h3>
<p>Our <a href="project/funding.html">funding</a> is pretty nonexistent, but if we had some, we could
<a href="project/hiring.html">hire more people</a> and build useful things faster. Do you know how to
write NSF grants? Have you thought of a business model compatible with our
values but that would let us financially sustain ourselves? Do you think we
should be an LLC, a B corp, a non-profit, something else? Help needed!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="funding-1"><a class="header" href="#funding-1">Funding</a></h1>
<p>A/B Street is in need of funding. If you would like to support the development
of A/B Street, e.g. to get a particular feature implemented or to get support
using it to simulate changes in a particular city,
<a href="mailto:dabreegster@gmail.com">get in touch</a>.</p>
<p>Funding received:</p>
<ul>
<li>Contract with <a href="https://actdev.cyipt.bike/">ActDev</a></li>
</ul>
<p>The project has funded two open-source libraries needed by A/B Street,
supporting the development of open source software for transport planning
applications:</p>
<ul>
<li><a href="https://github.com/easbar/fast_paths/">fast_paths Rust contraction hierarchy pathfinding</a></li>
<li><a href="https://github.com/eldang/elevation_lookups">Python elevation data processing</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hiring"><a class="header" href="#hiring">Hiring</a></h1>
<p>A/B Street is hiring a Rust engineer!</p>
<h2 id="the-project"><a class="header" href="#the-project">The project</a></h2>
<p>A/B Street aims to get the average citizen more involved with local
transportation planning and accelerate plans to make cities more friendly to
people biking, walking, and using public transit. This massive undertaking
involves building a realistic model of any citys street network from open data,
designing a user interface to easily edit streets and intersections, getting a
traffic simulation to run with some degree of realism, using data visualization
to explain the impacts of changes, and advocating for real changes using results
from the software.</p>
<p>A/B Street has yet to focus on public transit. Thats where you come in. Today,
theres only preliminary and broken support for importing bus routes from
OpenStreetMap and simulating people using them. A vision of what proper public
transit support in A/B Street should do:</p>
<ul>
<li>Let people draw entirely new bus and light rail routes, then understand the
impact on individual people and the aggregate community.</li>
<li>Explore how small changes affect bus performance -- like changing bus stop
locations, adding a bus-only lane, or configuring a traffic signal to
prioritize buses.</li>
<li>Gamify the process of planning for public transit, by gradually introducing
editing tools and a budget, to teach the public about the trade-offs involved
with planning.</li>
</ul>
<p>These goals will involve
<a href="https://github.com/a-b-street/abstreet/issues/372">many tasks</a>, such as
incorporating data from OpenStreetMap and GTFS into A/B Streets map model;
modifying pathfinding to decide which route a person should use; defining and
visualizing metrics for performance of a bus route; and changing the map model
and UI to allow bus stops and routes to be created and edited.</p>
<p>Although your main focus will be public transit, A/B Street is a project with a
wide scope, and there are other areas we need help, many of which good public
transit support depends on:</p>
<ul>
<li>Improving the underlying map model:
<ul>
<li><a href="https://github.com/a-b-street/abstreet/issues/654">simplifying complex intersections from OpenStreetMap</a></li>
<li><a href="https://github.com/a-b-street/abstreet/issues/330">snapping separate paths to the main road</a></li>
<li><a href="https://github.com/a-b-street/abstreet/issues/485">improving heuristics for placing crosswalks</a></li>
</ul>
</li>
<li>Fixing gridock and improving the simulation
<ul>
<li>lane-changing and over-taking</li>
<li>biking in parking lanes when possible</li>
<li>better rules for when pedestrians are likely to start crossing</li>
<li>mode shift / figuring out when a new bus route would
<a href="https://github.com/a-b-street/abstreet/issues/448">convince somebody to stop driving</a></li>
<li>editing the map without needing to restart a simulation</li>
</ul>
</li>
<li>UI / design
<ul>
<li>helping implement UX designs prototyped in Figma</li>
<li>fixing usability problems you notice yourself</li>
</ul>
</li>
</ul>
<h2 id="your-qualifications"><a class="header" href="#your-qualifications">Your qualifications</a></h2>
<ul>
<li>Can work independently, but still communicate effectively with the rest of the
team. We need to focus our efforts on other parts of the project, but we'll
keep up with your work closely
<ul>
<li>One way to demonstrate this: have you created your own project and
maintained it for a while? Have you worked on other open source projects?</li>
</ul>
</li>
<li>Can ramp up quickly on Rust, OpenStreetMap, GTFS, etc. If you already know
these, great. If not, you should feel comfortable learning enough to start
contributing to the code-base in a few days.</li>
<li>Are fine with (and happy to have) all of your work being Apache licensed and
designed/discussed transparently on Github and Slack</li>
<li>Bonus if you have enough design sense to mock up UIs, but no worries if not</li>
</ul>
<h2 id="the-job"><a class="header" href="#the-job">The job</a></h2>
<p>Our <a href="project/funding.html">funding</a> is all but nonexistent, so I am personally carving out
some of my savings for this. Because of this, the bar for hiring and my
expectations are pretty high.</p>
<ul>
<li>The amount is negotiable, but no more than about $30,000 USD total for the
duration of the contract.</li>
<li>Ideally this contract would be full-time (35-40 hours a week) for about 6
months -- so that's about $5,000 per month.</li>
<li>Can't offer any benefits, sorry -- we're not a company yet!</li>
<li>Remote only. Anywhere in the world is fine. The main person you'd be
collaborating with is in the UK.</li>
</ul>
<p>If we can figure out how to financially sustain ourselves, this could become a
permanent position, but don't count on it.</p>
<h2 id="applying"><a class="header" href="#applying">Applying</a></h2>
<p>If you think youd be a good fit, email <a href="mailto:project/dabreegster@gmail.com">dabreegster@gmail.com</a> with any
relevant material -- open source projects, a resume, etc. We can schedule a
video call.</p>
<p>In lieu of a traditional interview, Id like to ask you to submit a PR to A/B
Street to make progress on one of our starter bugs or any other fix/feature
youd like to see (theres plenty of things that need improving, and being able
to find and fix them without much guidance is what were looking for). Please
focus on good communication in your PR, as its something wed expect you to
keep up the entire time -- see
<a href="https://github.com/a-b-street/abstreet/pull/571">this</a> as an example, where the
before/after of the change is clear, and any uncertain design decisions are
brought up.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="project-motivations"><a class="header" href="#project-motivations">Project motivations</a></h1>
<p>I thought it'd be helpful to explain what motivates my work in A/B Street. These
are just my personal values; I don't intend to make a careful argument about
these here. In no particular order:</p>
<ul>
<li>
<p><strong>Transparency and reproducibility</strong>: if city government uses data, modeling,
or simulation to inform a decision affecting the general public, then anybody
ought to be able to repeat that analysis.</p>
<ul>
<li>This means code and data should be open.</li>
<li>Businesses like <a href="https://replicahq.com/">Sidewalk Lab's Replica</a> and
<a href="https://www.remix.com/solutions/streets">Remix</a> still need to generate
income, but it's unclear why governments use taxes to pay for something only
they see.</li>
<li>Decision making should be documented clearly. Why were the
<a href="https://www.seattle.gov/transportation/projects-and-programs/programs/maintenance-and-paving/current-paving-projects/35th-ave-ne">35th Ave bike lanes</a>
scrapped? Was the amount of on-street parking on nearby residential roads
factored in? Was there analysis of how trip time is impacted by parking in
the neighborhood and walking a few blocks to a business on the arterial?</li>
<li>I'm personally inspired by approaches like
<a href="https://info.vtaiwan.tw/">vTaiwan</a> and
<a href="https://po.pdis.nat.gov.tw/en/opengov/">PDIS</a></li>
</ul>
</li>
<li>
<p><strong>Accessibility leads to participation</strong>: There's overhead to taking small
ideas to advocacy groups or inconveniently timed public meetings. If the
planning process is easier to interact with, more people will participate.</p>
<ul>
<li>Seattle's
<a href="https://www.seattle.gov/neighborhoods/programs-and-services/your-voice-your-choice">Your Voice, Your Choice</a>
program is maybe an example of this</li>
</ul>
</li>
<li>
<p><strong>Short-term changes</strong>: <a href="https://en.wikipedia.org/wiki/Sound_Transit_3">ST3</a>
is exciting, but 2040 isn't close. There are much cheaper changes that can be
implemented sooner.</p>
<ul>
<li>Most of the edits in A/B Street are inspired by tactical urbanism; they
could be prototyped with signs and paint.</li>
</ul>
</li>
<li>
<p><strong>The US is too dependent on cars</strong>: This has an unacceptable impact on the
environment. Even ignoring that, many cities are out of room to build more
roads. We can't keep scaling population like this.</p>
</li>
<li>
<p><strong><a href="https://macwright.com/2019/07/27/beware-the-ethical-car.html">Autonomous vehicles will NOT save the day</a></strong>:
They can squeeze more throughput out of existing infrastructure, but only up
to a point. They might encourage people to move and tolerate longer commutes.
Mass transit and dense land-use patterns handle population growth better.</p>
</li>
<li>
<p><strong>Compromise and trade-offs</strong>: I see lots of rhetoric calling for extreme,
sudden change. I don't want to ban all cars from downtown Seattle, because
that's not realistic. I want to focus on immediate steps forward. I want to
come up with estimates about impacting drivers by a median 3 minutes in order
to save a bus route 1 minute, and to shift public discourse towards that.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="project-history"><a class="header" href="#project-history">Project history</a></h1>
<p>As of June 2020.</p>
<p>tldr: A/B Street has been in active development since June 2018, but the idea
has been festering since I was about 16.</p>
<h2 id="retrospective"><a class="header" href="#retrospective">Retrospective</a></h2>
<p>What poor judgments have cost me the most time?</p>
<ul>
<li>UI churn: I should've studied some UX on my own and started with a clear idea
of how to organize everything</li>
<li>OSM data quality: I should've gained the confidence to upstream fixes earlier</li>
<li>Intersection geometry: I should've realized sooner that simulation robustness
is more important than nice appearance.</li>
<li>Geometry primitives: I sunk too much time into the polyline problem and f64
precision.</li>
</ul>
<h2 id="trivia"><a class="header" href="#trivia">Trivia</a></h2>
<ul>
<li>The name was almost &quot;Unstreet&quot; or &quot;Superban&quot; (superb urban)</li>
<li>I hope you enjoy and/or are baffled by the
<a href="https://github.com/a-b-street/abstreet/releases">release names</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backstory"><a class="header" href="#backstory">Backstory</a></h1>
<p>I originally wanted to tell a much longer story here of how I came to work on
A/B Street, but I'm not sure this is the right time yet. So consider this the
quick version.</p>
<p>I grew up in Baton Rouge, where driving is effectively the only mode of
transport. (I've gone back and made a point of taking long walks to confirm how
antagonistically the city is designed towards walking.) Very early on, I fell in
love with a Nintendo 64 game called Banjo Kazooie, which led me to the online
fan communities of the early 2000's. I wanted to create games too, so I started
learning programming via library books and lots of questions on IRC. Because I
never had any confidence in art, I wound up working on
<a href="https://github.com/dabreegster/mnemonicrl/">roguelikes</a>, which led to a fervent
interest in pathfinding algorithms and
<a href="http://www.cs.colorado.edu/%7Eralex/papers/PDF/OOPSLA06antiobjects.pdf">collaborative diffusion</a>.
When I started driving in high school, I quickly realized how bad people were at
it. I remember being stuck at the intersection of
<a href="https://www.openstreetmap.org/node/1279204989">Florida Blvd and Cloud</a> and
first wondering if the pathfinding algorithms could help with traffic. Can you
see where this is going?</p>
<p><img src="project/history/cloud_florida.jpg" alt="Impatience is a virtue" /></p>
<p>I moved to Austin for college. One of the first days of class, I shuffled down
the stairs of Gearing Hall past a crackly old speaker apocalyptically announcing
the weather forecast (details add color, right?) into a seminar demanding a
totally open-ended first assignment to do something interesting. After I left,
somebody stopped to ask me for directions, but I didn't know campus well yet. I
thought about how Google Maps gave really silly walking directions. So I decided
I'd hand-draw a map of campus, showing all of the construction, how to cut
through the labryinth that is Welch Hall on hot days, and where to find the 24/7
robot coffee machines, and hack together a routing engine to help people find
the shortest path between their classes. The feedback I got on this assignment
included something along the lines of, &quot;I was really pretty impressed first that
you would be so stupid as to actually try to do this...&quot;</p>
<p><img src="project/history/ut_map.png" alt="Hand-mapping UT Austin" /></p>
<p>But I did, and that led me to discovering OpenStreetMap, which it turns out was
pretty pivotal. (The first version of my campus map was seeded vaguely off an
official paper map, but mostly I walked around and invented half-assed surveying
methods on the spot.) Next semester, I joined a freshman research stream with
somebody who had worked on <a href="http://www.cs.utexas.edu/%7Eaim/">AIM</a>, UT's
demonstration that autonomous vehicles wouldn't need traffic lights. Everything
came together, and I started a 3 year journey of building
<a href="https://github.com/dabreegster/aorta/">AORTA</a>, a traffic simulator for AVs.
Guided by the research lab, I explored the really bizarre idea of letting AVs
<a href="http://www.cs.utexas.edu/%7Eaim/papers/ITSC13-dcarlino.pdf">bid to turn lights green sooner</a>
and micro-tolling all roads to disincentivize congestion. Both of these
mechanisms would be incredibly unfair to people without the spare cash to back
up their high value-of-time, but I brushed this off by saying the currency could
be based on carpooling, EVs, etc.</p>
<p><img src="project/history/aorta.gif" alt="Approximately Orchestrated Routing and Transportation Analyzer" /></p>
<p>It was great to try research in college; I learned I <em>really</em> dislike munging
data and compressing my work into 6 pages of conference paper LaTeX. So I moved
to Seattle to work in industry instead, on something completely unrelated to
transportation. Lots of things began unravelling for me in Seattle, but one of
them was biking. In Austin, I had picked up mountain biking, and all but stopped
driving; it was an amazing place to explore and commute by bike. Seattle was
different. There were many more cyclists around, but the experience felt more
stressful, the drivers more aggressive. I had plenty of near-misses. I kept
commuting by bike, but the joy of it was gone. I started noticing how many cars
were parked on narrow arterials and wondering why that was a fair use of space.
I started paying attention to the public discourse around bike infrastructure in
Seattle and feeling like the conversation was... chaotic.</p>
<p><img src="project/history/manhattan.jpg" alt="Manhattan took walkability seriously" /></p>
<p>Fast forward to late 2017. This is where I'll omit chunks of the story. I
visited London, my first experience with a city that took public transit
seriously. When I returned, lots of latent ideas stopped fermenting and started
exploding. I threw together a prototype of A/B Street and started the arduous
process at work of open-sourcing it and applying to a program to let me work it
on for a few quarters. A few months later, I wound up quitting instead, and
began to work on A/B Street in earnest.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="year-1-june-2018-2019"><a class="header" href="#year-1-june-2018-2019">Year 1 (June 2018-2019)</a></h1>
<p>I skimmed through git and summarized roughly what I was working on each month,
calling out milestones. &quot;UI churn&quot; is pretty much constantly happening.</p>
<ul>
<li>
<p>June: polyline geometry and lanes, building paths, protobuf -&gt; serde</p>
</li>
<li>
<p>July: pedestrians, bikes, parked cars, lane edits</p>
</li>
<li>
<p>August: porting AORTA's discrete-time driving model</p>
</li>
<li>
<p>September: multi-leg trips, buses, the first ezgui wizard, randomized
scenarios</p>
</li>
<li>
<p>October: A/B test mode (and so per-map plugins), forking RNG for
edit-invariance, intersection geometry</p>
</li>
<li>
<p>November: clipping / borders, using blockface for parking, time travel mode,
test runner framework</p>
</li>
<li>
<p>December: bezier curves for turns, traffic signal editor, a first attempt at
merging intersections, right-click menus, a top menu, modal menus</p>
<ul>
<li>the grand colorscheme refactor: a python script scraped <code>cs.get_def</code> calls
at build-time</li>
</ul>
</li>
<li>
<p>January: careful f64 resolution, ezgui screencapping, synthetic map editor</p>
<ul>
<li><strong>grand refactor</strong>: piston to glium</li>
</ul>
</li>
<li>
<p>February: attempting to use time-space intervals for a new driving model, new
discrete-event model instead</p>
<ul>
<li><strong>Feb 19-27</strong>: conceiving and cutting over to the new discrete event model</li>
</ul>
</li>
<li>
<p>March: fleshing out DES model (laggy heads), first attempt to build on
windows, gridlock detection</p>
</li>
<li>
<p>April: first public releases, splash screen and rearranging game modes</p>
</li>
<li>
<p>May: fancier agent rendering, attempting to use census tracts, finding real
demand data</p>
<ul>
<li><strong>milestone</strong>: discovered PSRC Soundcast data, much more realistic trips</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="year-2-june-2019-2020"><a class="header" href="#year-2-june-2019-2020">Year 2 (June 2019-2020)</a></h1>
<p><img src="project/history/oct_2019.png" alt="Circa October 2019" /></p>
<ul>
<li>
<p>June: contraction hierarchies for pathfinding, stackable game states</p>
</li>
<li>
<p>July: OSM turn restrictions, misc (I think I was in Europe?)</p>
</li>
<li>
<p>August: pedestrian crowds, agent color schemes, parking blackholes, a big
<code>raw_data</code> refactor to store <code>Pt2D</code>, attended first hackathon</p>
</li>
<li>
<p>September: offstreet parking, associating parked cars with buildings using
Soundcast (before that, anybody could use any car!), implemented texture
support for some reason, doing manual <code>MapFixes</code> at scale to fix OSM bugs</p>
<ul>
<li><strong>milestone</strong>: got the smallest montlake map to run without gridlock</li>
</ul>
</li>
<li>
<p>October: parking sim fixes, opportunistic lane-changing, starting challenge
modes</p>
</li>
<li>
<p>November: prebaked sim results, time-series plots, undo for edit mode, traffic
signal editor grouping turns</p>
<ul>
<li><strong>milestone</strong>: Yuwen joins project</li>
</ul>
</li>
<li>
<p>December: the UI reform begins (flexbox, minimap, trip timelines, cutting over
to SVGs, info panels, scrolling), started naming releases sensibly</p>
<ul>
<li>Project leaked to <a href="https://news.ycombinator.com/item?id=21763636">HN</a>, woops</li>
</ul>
</li>
<li>
<p>January: UI reform continues, the modern tutorial mode appears</p>
</li>
<li>
<p>Feburary: UI and tutorial, all text now pure vectors, port to glow+WASM</p>
</li>
<li>
<p>March: lockdowns start in US, start grouping trips as a person, population
heatmap, left-hand driving, info panel and typography overhauls. started
engaging with Greenways, started effort to map traffic signals</p>
</li>
<li>
<p>April: Orestis joins and starts the pandemic model, trip tables, the optimize
commute challenge, refactor for people's schedules and owned vehicles, trip
time dat viz, MAJOR progress fixing gridlock at the sim layer</p>
</li>
<li>
<p>May: gridlock progress, upstreaming fixes in OSM, differential throughput and
first real write-up, long-lasting player edits, dedicated parking mapper,
maybe vanquished the HiDPI bugs, multi-step turn restrictions, random bios for
people, and docs like this to prep for launch ;)</p>
<ul>
<li><strong>milestone</strong>: relying on pure OSM, no more <code>MapFixes</code></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="year-3-june-2020-2021"><a class="header" href="#year-3-june-2020-2021">Year 3 (June 2020-2021)</a></h1>
<ul>
<li>June: parking lots, real minimap controls, road labels
<ul>
<li><strong>June 22</strong>: alpha launch!
<a href="https://old.reddit.com/r/Seattle/comments/hdtucd/ab_street_think_you_can_fix_seattles_traffic/">r/Seattle</a>,
<a href="https://old.reddit.com/r/SeattleWA/comments/hdttu8/ab_street_think_you_can_fix_seattles_traffic/">r/SeattleWA</a>,
<a href="https://old.reddit.com/r/urbanplanning/comments/hdylmo/ab_street_a_traffic_simulation_game/">r/UrbanPlanning</a>,
<a href="https://news.ycombinator.com/item?id=23605048">HN</a>,
<a href="https://www.geekwire.com/2020/want-fix-seattle-traffic-redditor-makes-game-allows-players-tweak-city-streets/">GeekWire</a>,
<a href="https://www.thestranger.com/slog/2020/06/29/43999454/ab-streets-game-lets-you-create-the-seattle-street-grid-of-your-dreams">The Stranger</a></li>
</ul>
</li>
<li>July: loads of bugfixes, map geometry improvements, UI cleanups,
access-restricted zones for private neighborhoods and no-through-traffic,
better traffic generation between home&lt;-&gt;work for new maps, complete overhaul
to bus routes and introduction of light rail, commute pattern explorer,
importing Krakow and Berlin, smarter lane-changing, walkable shoulders for
roads without sidewalks
<ul>
<li><a href="https://www.youtube.com/watch?v=Pk8V-egsUxU">KING 5 Evening</a> interview</li>
</ul>
</li>
<li>August: Michael joins, multiple traffic signals can be edited together,
started a headless JSON API, support for other languages in OSM data, started
congestion capping, backwards-compatible and more robust map edits, two-way
cycletracks, more cities imported, slurry of bugfixes and performance
improvements
<ul>
<li><a href="https://bikesiliconvalley.org/2020/07/poster_dustin-carlino/">Silicon Valley Bike Summit</a>,
<a href="https://www.seattlepi.com/local/transportation/slideshow/solve-Seattles-traffic-problem-in-this-video-game-205839.php">Seattle PI</a></li>
</ul>
</li>
<li>September: full support for driving on the left, textured color scheme,
rendering isometric buildings, editing traffic signal offsets, a big round of
UI changes, infinite parking mode, trip purpose, alleyways
<ul>
<li><a href="https://www.seattlemet.com/news-and-city-life/2020/09/a-new-game-allows-you-to-redesign-seattle-streets">SeattleMet</a></li>
</ul>
</li>
<li>October: unit tested turn generation, web version launched with async file
loading, thought bubbles showing agent goals, slow parts of a trip
highlighted, more UI overhauls, dedicated OSM viewer mode started, major
simulation performance optimizations, major progress towards live map edits,
automatically picking boundaries for arbitrary cities</li>
<li>November: switched from Dropbox to S3, download new maps in-game, collision
dataviz UI, day/night color switching, unit testing lane changing behavior,
starting the 15 min walkshed tool, simplified simulation spawning code,
recording and replaying traffic around a few intersections, refactoring to
split out separate tools</li>
<li>December: lane-changing fixes, blocked-by explorer in debug mode, non-Latin
font support on web, saving player state on web, census-based scenario
generation started, 15 minute Santa</li>
<li>January: experimented with SUMO import, UI button overhaul, day/night mode,
first separate cycleways</li>
<li>February: better web loading and URL sharing, randomized parking, procedurally
generated houses, actdev integration, geofabrik picker, new day theme, static
routing penalties</li>
<li>March: UK flow-based scenario generation, roundabout gridlock fixes, UI panel
redesign, one-step OSM importer with UI, elevation data &amp; layers</li>
<li>April: pathfinding by roads, editing number of lanes, risk exposure, Tempe
intersection consolidation</li>
<li>May: GMNS signal timing import, cloud map importer, OSM turn lane fixes</li>
<li>June: performance, first dynamic vehicle lane-changing, exiting driveways
off-sides and across multiple lanes</li>
<li>July: pathfinding refactor, Broadmoor blog post, mode shift tool, massive
intersection consolidation breakthrough, deduplicating cycleways in OSM, bike
lane separators, new day mode colors</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-ab-street-almost-postmortem"><a class="header" href="#the-ab-street-almost-postmortem">The A/B Street &quot;Almost&quot; Postmortem</a></h1>
<p>This was written September 2021, originally meant as a project postmortem.
(Spoiler alert: we're still alive and kicking)</p>
<ul>
<li><a href="project/history/retrospective/index.html#technical-accomplishments--challenges">Technical accomplishments &amp; challenges</a>
<ul>
<li><a href="project/history/retrospective/index.html#the-map-model">The map model</a>
<ul>
<li><a href="project/history/retrospective/index.html#render-osm-in-gory-detail">Render OSM in gory detail</a></li>
<li><a href="project/history/retrospective/index.html#joining-data-sources">Joining data sources</a></li>
<li><a href="project/history/retrospective/index.html#map-editing">Map editing</a></li>
<li><a href="project/history/retrospective/index.html#the-map-importer">The map importer</a></li>
</ul>
</li>
<li><a href="project/history/retrospective/index.html#software-engineering">Software engineering</a>
<ul>
<li><a href="project/history/retrospective/index.html#testing">Testing</a></li>
<li><a href="project/history/retrospective/index.html#releases">Releases</a></li>
</ul>
</li>
<li><a href="project/history/retrospective/index.html#simulation">Simulation</a>
<ul>
<li><a href="project/history/retrospective/index.html#discrete-event-traffic-simulation">Discrete event traffic simulation</a></li>
<li><a href="project/history/retrospective/index.html#parking">Parking</a></li>
<li><a href="project/history/retrospective/index.html#gridlock">Gridlock</a></li>
<li><a href="project/history/retrospective/index.html#travel-demand-models">Travel demand models</a></li>
</ul>
</li>
<li><a href="project/history/retrospective/index.html#ui">UI</a>
<ul>
<li><a href="project/history/retrospective/index.html#widgetry-a-ui--dataviz-library-from-scratch">widgetry: a UI + dataviz library from scratch</a></li>
<li><a href="project/history/retrospective/index.html#native-and-web">Native and web</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="project/history/retrospective/index.html#design-accomplishments-and-challenges">Design accomplishments and challenges</a>
<ul>
<li><a href="project/history/retrospective/index.html#color-schemes">Color schemes</a></li>
<li><a href="project/history/retrospective/index.html#road-editor">Road editor</a></li>
<li><a href="project/history/retrospective/index.html#traffic-signal-editor">Traffic signal editor</a></li>
<li><a href="project/history/retrospective/index.html#data-visualization">Data visualization</a></li>
<li><a href="project/history/retrospective/index.html#road-labels">Road labels</a></li>
<li><a href="project/history/retrospective/index.html#charm">Charm</a></li>
</ul>
</li>
<li><a href="project/history/retrospective/index.html#project-management">Project management</a>
<ul>
<li><a href="project/history/retrospective/index.html#collaborations">Collaborations</a>
<ul>
<li><a href="project/history/retrospective/index.html#the-success-stories">The success stories</a></li>
</ul>
</li>
<li><a href="project/history/retrospective/index.html#project-scope">Project scope</a></li>
<li><a href="project/history/retrospective/index.html#teasing-apart-the-monolith">Teasing apart the monolith</a></li>
<li><a href="project/history/retrospective/index.html#marketing">Marketing</a></li>
<li><a href="project/history/retrospective/index.html#community">Community</a></li>
<li><a href="project/history/retrospective/index.html#money">Money</a></li>
</ul>
</li>
<li><a href="project/history/retrospective/index.html#the-problem">The problem</a>
<ul>
<li><a href="project/history/retrospective/index.html#advocacy-groups">Advocacy groups</a></li>
<li><a href="project/history/retrospective/index.html#the-public">The public</a></li>
<li><a href="project/history/retrospective/index.html#whos-our-audience">Who's our audience?</a></li>
<li><a href="project/history/retrospective/index.html#what-this-project-means-to-me">What this project means to me</a></li>
</ul>
</li>
<li><a href="project/history/retrospective/index.html#epilogue">Epilogue</a></li>
</ul>
<h2 id="technical-accomplishments--challenges"><a class="header" href="#technical-accomplishments--challenges">Technical accomplishments &amp; challenges</a></h2>
<h3 id="the-map-model"><a class="header" href="#the-map-model">The map model</a></h3>
<p>To support a traffic simulation, A/B Street's map model isn't just a graph. It
represents the physical geometry of roads and intersections and includes
land-use semantics, like estimates of residential units and commercial spaces
within each building.</p>
<p>One thing that's surprising to people with a GIS background is how from-scratch
everything is. There's no QGIS, Leaflet, PostGIS, or map tiles. The map is just
a single file with simple data structures and a clipped study area.</p>
<h4 id="render-osm-in-gory-detail"><a class="header" href="#render-osm-in-gory-detail">Render OSM in gory detail</a></h4>
<p>OpenStreetMap represents streets loosely as a graph, with road center-lines and
a pretty free-form key/value tagging system. It was designed for ease of mapping
certain features, not for maintaining data quality, representing roads as
physical space, or describing semantics of movement along the transportation
network.</p>
<p>But A/B Street needed lots of this, and OSM is the most enticing data source
available, so I wrote aggressive heuristics to extract meaning from the formless
chaos. Perfect results are unattainable, but I'm quite proud of how far it's
come and how robust it is to most cities I've imported.</p>
<ul>
<li><a href="https://github.com/dabreegster/abstreet/blob/master/map_model/src/make/initial/lane_specs.rs">transforming road tagging into lanes</a>
<ul>
<li>The tagging schema described by the OSM wiki is complicated to begin with.
But real mapping still diverges from this. I wound up fixing many
discrepencies in Seattle, and made
<a href="project/history/retrospective/../../../software/osm_viewer.html">a dedicated tool</a> to help other mappers
validate their work.</li>
<li>Because of A/B Street, I've mapped OSM tags that're just proposals or not
widely used -- like <a href="project/history/retrospective/../../../software/parking_mapper.html">street parking</a>
and
<a href="https://wiki.openstreetmap.org/wiki/Talk:Proposed_features/cycleway:separation">cycleway:separation</a>.</li>
</ul>
</li>
<li><a href="project/history/retrospective/../../../tech/map/geometry/index.html">Creating geometry from roads and intersections</a>
<ul>
<li>I believe A/B Street has the most advanced handling of complex OSM
intersections of anything that's public</li>
</ul>
</li>
<li>OSM doesn't directly encode what movements are possible through each
intersection. A/B Street generates this for vehicles and pedestrians with
aggressive heuristics.
<ul>
<li>OSM turn lane tagging is often flat-out wrong (not matching the lane count)
or broken when ways are split before an intersection</li>
<li>OSM has turn restriction relations that can span multiple road segments.
This impacts graph pathfinding and traffic simulation in subtle ways.<!-- link pathfinding article -->
</li>
</ul>
</li>
<li>OSM includes parking lots and aisles, but A/B Street needs to know capacity,
which is rarely mapped. So it procedurally generates individual stalls fitting
the geometry.</li>
<li>A traffic signal is just a node in OSM -- or worse, a bunch of individual
nodes for a complex junction. There's no way to describe its timing.
<ul>
<li>A/B Street has reasonable heuristics for grouping movements together in
stages for many different shapes of intersections. (I never did much work on
automatically improving the timing, though.)</li>
<li>I invented a
<a href="project/history/retrospective/../../../tech/dev/formats/traffic_signals.html">JSON interchange format</a>
referencing OSM IDs to describe signal configuration.</li>
<li>I worked with Dr. Xuezong Zhou's ASU group to import
<a href="https://github.com/asu-trans-ai-lab/Vol2Timing">GMNS signal timing</a> and
match the movements to A/B Street's representation.</li>
<li>The city of Seattle has still yet to release any public data about how
signals are really timed, so for a while, I was
<a href="https://docs.google.com/document/d/1Od_7WvBVYsvpY4etRI0sKmYmZnwXMAXcJxVmm8Iwdcg/edit?usp=sharing">manually mapping them</a>
with a notebook and stopwatch, and even convinced a few other people to
join. (Of course this was futile; most interesting intersections depend on
actuators, which can't be observed directly.)</li>
</ul>
</li>
<li>Built pathfinding into the map model for vehicles and pedestrians.<!-- article -->
<ul>
<li>Funded the creation of a new
<a href="https://github.com/easbar/fast_paths">Rust contraction hierarchy library</a>
to achieve the performance necessary for a traffic simulation</li>
<li>Some complex features: responding to map edits (that might reverse roads,
close things off to some vehicles), handling complex turn restriction
relations, modeling private neighborhoods and streets with no through-traffic,
turning left or right out of a driveway, and elevation-aware cost functions
for vehicles, pedestrians, making unprotected turns, etc</li>
</ul>
<!-- Snapping -->
</li>
</ul>
<p><img src="project/history/retrospective/road_width_osm.png" alt="" /> <em>Do you have any idea what's on these roads?</em></p>
<p><img src="project/history/retrospective/road_width_abst.png" alt="" /> <em>A/B Street shows the bus lanes and guesses road
width.</em></p>
<p><img src="project/history/retrospective/tempe_junction_osm.png" alt="" /> <em>An arterial road with light rail crosses a minor
road in OSM</em></p>
<p><img src="project/history/retrospective/tempe_junction_abst.png" alt="" /> <em>In A/B Street, one consolidated traffic signal
represents this situation</em></p>
<p><img src="project/history/retrospective/parking_lot_osm.png" alt="" /> <em>A parking lot in OSM</em> <img src="project/history/retrospective/parking_lot_abst.png" alt="" /> <em>The
same lot in A/B Street -- 1500 spots, based on geometry</em></p>
<p><img src="project/history/retrospective/tsig_two_stage.png" alt="" /> <em>Is turning traffic backing up here?</em></p>
<p><img src="project/history/retrospective/tsig_four_stage.png" alt="" /> <em>Add some protected left turns!</em></p>
<h4 id="joining-data-sources"><a class="header" href="#joining-data-sources">Joining data sources</a></h4>
<p>A/B Street brings in other public data for some cities, joining it with the
OSM-based map model.</p>
<p><img src="project/history/retrospective/data_blockface.png" alt="" /> <em>Blockface data in Seattle describes street parking
restrictions... in theory. Many segments disagree with OSM's splitting of roads,
and many blocks have incorrect data.</em></p>
<p><img src="project/history/retrospective/data_elevation.png" alt="" /> <em>LIDAR elevation data overlaid with the bike network
shows why Aurora would be such a nicer route to bike north from downtown than
Fremont</em></p>
<p><img src="project/history/retrospective/data_parcels.png" alt="" /> <em>The sad blue sea of single-family parcels, from King
County parcel data</em></p>
<h4 id="map-editing"><a class="header" href="#map-editing">Map editing</a></h4>
<p>It would be so simple if that map model representation was nice and immutable.
But the whole point of A/B Street is to explore changes to the built
environment. Aside from the UIs for this (which themselves went through many
design iterations and usability studies), supporting this in the map model layer
has been tough.</p>
<ul>
<li>Representing edits durably, even when a map is rebuilt from updated OSM data.</li>
<li>Handling undo/redo. When you change the lanes of one road, it might invalidate
the traffic signal policy nearby.</li>
<li>When you widen or shrink a road, it affects intersection geometry. Especially
when that intersection has been consolidated from several in OSM, there are
some edge cases...</li>
<li>Applying edits has to be fast -- jokes on loading screens are hard to write!</li>
</ul>
<h4 id="the-map-importer"><a class="header" href="#the-map-importer">The map importer</a></h4>
<p>At first, I was just importing a few parts of Seattle, so running a little tool
was fine. But as word of the project spread, of course people wanted to see it
in more places. (And in fact, the most solid audience for the project has been
the OSM community -- mappers tend to already be very invested in OSM as a hobby,
so they're willing to get past any clunky UX hurdles in order to play with
something cool!) By now, I'm importing ~130 maps from ~80 cities. Anytime I
update the OSM import code, I've committed to regenerating everything and at
least not totally breaking a city!</p>
<p>I've <a href="https://github.com/a-b-street/abstreet/issues/326">only barely managed</a> to
stay on top of this growing scale. My faster laptop died for a few months and I
scrambled to parallelize the import process in the cloud just to survive.
Something that I haven't solved is expressing the complex importing process as a
proper pipeline. Ideally it's a DAG of tasks depending on each other, with clear
logging, progress tracking, parallelization, and error handling. One reason this
is hard is expressing which parts of the graph to invalidate and recalculate.
Should we grab new upstream OSM data? Just recalculat scenarios, leaving the
maps alone? Only re-run one stage of the map import?</p>
<p>I'm pretty happy with how easy it is to
<a href="project/history/retrospective/../../../user/new_city.html">import a new city</a>. Originally you had to email me a
boundary or compile the project yourself, but now the UI just asks you to draw a
GeoJSON boundary, uses Overpass to grab fresh data, and runs the importer for
you.</p>
<h3 id="software-engineering"><a class="header" href="#software-engineering">Software engineering</a></h3>
<h4 id="testing"><a class="header" href="#testing">Testing</a></h4>
<p>A huge challenge to maintaining maps over time is not breaking things, either
from my own importing code or when grabbing new OSM data upstream. Writing tests
to guarantee some kind of invariants in the map model layer (like no two roads
overlapping each other, no disconnected bits of the graph, minimum road length,
etc...) was something I wanted to do, but all of those are pretty impossible
targets to meet with the messiness of OSM data. So I settled on regression tests
and manual tool-assisted diffing. Screenshot diffing is one trick -- inspect an
imported map once, take screenshots of it, then later compare to manually
validate changes. There are also tests that re-run a full traffic simulation on
maps known to work. They ensure gridlock isn't re-introduced, that overall
travel time patterns don't change radically, etc.</p>
<p>There aren't tons of unit tests. Usually expressing the input and expected
output for any of the interesting problems is just too hard manually. There are
some hybrid solutions, like generating turns at an intersection. The input (a
map's roads) isn't easy to understand by looking at some text encoding, but
viewing in the UI is. Likewise, a human can't glance at output like &quot;left turn
from lane #5 to lane #84&quot; and hope to understand it. But we can store the text
output as goldenfiles and, when there's a diff, again use the UI to inspect the
change.</p>
<h4 id="releases"><a class="header" href="#releases">Releases</a></h4>
<p>At my previous job, there was quite a bit of hassle maintaining a production
service without downtime. It was initially very freeing to just write software
quickly without worrying about breaking people, but of couse that didn't last
long after I started releasing public builds every week. The
<a href="project/history/retrospective/../../../tech/dev/release.html">release process</a> is mostly automated.</p>
<p>At first, I just shipped all map and scenario data with the .zip releases and
bundled this in one big .wasm blob (yes, really). Of course this didn't scale as
we increased the number of imported cities. So eventually I made the UI download
each city only when needed. This required
<a href="project/history/retrospective/../../../tech/dev/data.html">versioning the data</a> -- the code in a release from
weeks ago is probably binary incompatible with the current map data.</p>
<p>Originally I just threw all the files in my personal Dropbox, but moved to S3 at
some point (every single public file in Dropbox needs its own URL, and I broke
the Python tool spamming it with requests for hundreds of files...). I really
wanted to just re-use some existing tool to sync with S3 (both for me uploading
and for people downloading), but never found anything that met all my needs --
cross-platform without system dependencies, grouping files into per-city data
packs, gzipping. So I rolled my own
<a href="https://github.com/a-b-street/abstreet/blob/master/updater/src/main.rs">updater</a>.</p>
<p>I'd still love to conceptually use real version control; maybe Git LFS is worth
another try.</p>
<h3 id="simulation-1"><a class="header" href="#simulation-1">Simulation</a></h3>
<h4 id="discrete-event-traffic-simulation"><a class="header" href="#discrete-event-traffic-simulation">Discrete event traffic simulation</a></h4>
<p>Read the <a href="project/history/retrospective/../../../tech/trafficsim/index.html">full article</a>.</p>
<p>Although there's lots of academic papers out there describing car-following
models and other &quot;microscopic,&quot; agent-based traffic models, it's always seemed
to me that they omit details about how to actually implement them. So, I rolled
my own. Not claiming this is a good approach -- simulation results have to be
met with <strong>much</strong> more skepticism -- but I'm very proud of the model.</p>
<p>A/B Street simulates the movement of individual people walking, biking, and
driving. It doesn't do so in fixed time-steps (every 0.1 seconds, update
everything). It uses a &quot;discrete event&quot; approach. Each agent is in a state, like
traveling along a lane or waiting at an intersection, for some amount of time.
Updates only happen when that state possibly transitions to another one, like
when a vehicle reaches the end of a lane or a traffic signal &quot;wakes up&quot; people
on a green light. Instead of updating every agent every 0.1 seconds, we just
&quot;skip ahead&quot; to the next interesting time, per agent.</p>
<p>Actually making this work with on-demand rendering at any moment in time is one
of the more clever things I've come up with. The model is quite fast (until
gridlock happens...) and looks reasonably realistic in aggregate. Things like
smooth acceleration are missing, but few people have seemed to notice. Making
vehicles change lanes and over-take is one of the main limitations -- this is
very hard to squeeze into the discrete event model, and only half-done.</p>
<p><img src="project/history/retrospective/traffic_sim.gif" alt="" /> <em>Drivers, cyclists, and pedestrians negotiate the traffic
signal at Greenwood and N 87th</em></p>
<h4 id="parking-1"><a class="header" href="#parking-1">Parking</a></h4>
<p>Some traffic simulators out there are only focused on highways, not even
inner-city driving. Many don't include pedestrians and cyclists, or bolt them on
as an after-thought. But I'll bet A/B Street is one of the only ones including a
detail crucial to the experience of driving:
<a href="project/history/retrospective/../../../tech/trafficsim/parking.html">parking</a>. How many times have you heard a
friend complain that it took 10 minutes to drive over, but 15 to find parking?
Exactly.</p>
<p>Except in some maps that disable it, every driving trip in A/B Street begins and
ends with somebody walking between their actual endpoint and a parking spot with
their car. There's lots of estimation with the capacity along streets, in
parking lots, and especially with private residences and businesses, but at
least A/B Street tries. Maybe this pushes the rest of the field towards a bit
more realism. Abstractions matter! Parking occupies a huge amount of space, and
when your phone says driving somewhere is 20 minutes faster than taking a bus,
it may not be giving you the full picture -- are you sure you won't circle
around a dense neighborhood for 10 minutes finding that free spot? Abstractions
matter. I hope I've done justice to Donald Shoup.</p>
<p><img src="project/history/retrospective/../../../tech/trafficsim/parking_efficiency.png" alt="" /> <em>Darker red dots are
vehicles parked farther away from their final destination</em></p>
<h4 id="gridlock-1"><a class="header" href="#gridlock-1">Gridlock</a></h4>
<p>In both the real world and in a traffic simulation, vehicles get a bit stuck. In
the real world, this is usually resolved by humans slightly breaking strict
abstractions like usage of distinct lanes, slowly creeping into a partially
blocked intersection, or deciding to detour around a problem last minute. I've
had a hard time capturing that robustness in simulation, so well, in most
simulations on larger maps, vehicles get stuck. Like, permanently.</p>
<p>This has so many causes -- broken intersection geometry causing impossible turn
conflicts, weird lane-changing behavior, vehicles being too cautious about
partially blocking an intersection, pedestrians darting into non-existent
crosswalks, hilariously Byzantine traffic signal timing, travel demand models
sending all 80,000 trips to UW campus to a single tiny building... and so I've
dumped countless hours into trying to fix them, with only very modest success.
Sometimes it's trying to fix the data, or improve signal timing heuristics.
Sometimes it's building in complex cycle detectors into the simulation to figure
out when vehicles in a roundabout are all waiting for each other. Sometimes it
works. Usually it doesn't.</p>
<p><img src="project/history/retrospective/traffic_seitan.png" alt="" /> <em>Traffic Seitan spreads from one broken Fremont bridge</em></p>
<h4 id="travel-demand-models"><a class="header" href="#travel-demand-models">Travel demand models</a></h4>
<p>You can't run a traffic simulation if you don't know where people are going,
when they're leaving, or how they're trying to get there. The naive approach of
uniformly distributing some number of trips between all possible buildings is
hilariously unrealistic. And the amount of complex modeling and
<a href="https://www.psrc.org/sites/default/files/soundcastdesign2014.pdf">specialized knowledge</a>
needed to properly do activity modeling or something simpler is overwhelming.
I've tried as much as possible to punt on this -- importing Soundcast data for
Seattle, relying on collaborators like
<a href="https://github.com/asu-trans-ai-lab/grid2demand">grid2demand</a> and
<a href="https://a-b-street.github.io/abstr">abstr</a>.</p>
<p>But inevitably, A/B Street has wound up with its own simple travel demand
models. Mateusz started the
<a href="https://github.com/a-b-street/abstreet/issues/154">proletariat robot model</a>,
using naught but OSM tags on buildings to estimate the number of people living
and working, and using simple matching to send people to and from work, and
nothing else. Such robots.</p>
<p>Then during the <a href="https://actdev.cyipt.bike/">Actdev</a> work, it became necessary
last-minute to generate traffic using UK census flow data, which describes the
number of people commuting between different polygonal areas for work, broken
down by mode. The
<a href="https://github.com/a-b-street/abstreet/blob/master/popdat/src/od.rs">pipeline</a>
is simple.</p>
<p>We've also done a fair bit of work into data visualization to understand the
outut of these travel demand models. Part of this even includes heuristics that
automatically group buildings into &quot;neighborhoods&quot; -- roughly, tracing along
arterial roads and finding everything in the middle.</p>
<p><img src="project/history/retrospective/commuter_patterns.png" alt="" /> <em>Where do trips starting from Broadview go, according
to Soundcast data?</em></p>
<h3 id="ui"><a class="header" href="#ui">UI</a></h3>
<h4 id="widgetry-a-ui--dataviz-library-from-scratch"><a class="header" href="#widgetry-a-ui--dataviz-library-from-scratch">widgetry: a UI + dataviz library from scratch</a></h4>
<p>This is probably one of the more ridiculous things that's happened.</p>
<p>In ~2018 when I started, all of the rendering and GUI libraries for Rust
appeared to not do what I needed. So I started with
<a href="https://github.com/rust-windowing/winit">raw window event handling</a> and OpenGL
and... just went for it. It's not hard to start drawing a big
<a href="https://wiki.openstreetmap.org/wiki/Slippy_Map">slippy map</a> with zooming and
panning, nor is it tough to wire up a basic clickable button. But...
<a href="project/history/retrospective/../../../tech/dev/ui.html">widgetry</a> has turned into something quite feature-full
and has a decent API.</p>
<p>The journey there was quite circuitous. Most of the difficulty was not even
knowing how the UI should work (or even having a clear picture of what the app
was supposed to do...). But once Yuwen joined the project, this library started
shaping up very quickly. And Michael has dumped in countless work into adding
complex features to it, polishing the APIs and style, implementing massive
design changes from Yuwen like the buttons...</p>
<p>The end result is pretty impressive -- it works on native and web (no system
dependencies), everything's an infinitely scalable vector (including text), and
it has loads of interactive dataviz widgets.</p>
<p><img src="project/history/retrospective/widgetry_demo.gif" alt="" /> <em>A quick preview of interactive line plots, draggable
cards, and a canvas filled with vector goodies</em></p>
<h4 id="native-and-web"><a class="header" href="#native-and-web">Native and web</a></h4>
<p>I never intended to target mobile or the web. But in January 2020ish, winit
support for web landed, so I thought... why not? Initial support was
surprisingly easy, but properly dealing with asynchronous file loading, loading
screens, progress bars, and detangling native-only dependencies has been quite
tough.</p>
<h2 id="design-accomplishments-and-challenges"><a class="header" href="#design-accomplishments-and-challenges">Design accomplishments and challenges</a></h2>
<p>I think it's safe to say my own design skills are somewhat lacking:</p>
<p><img src="project/history/retrospective/ui_ancient.png" alt="" /> <em>A/B Street as of September 2019</em></p>
<p>A/B Street has lots of complex information to convey and data to visualize, and
getting people excited about a vision for a more sustainable transportation
system requires beautiful design. So... it's quite awesome that
<a href="https://www.yuwen-li.com/work/abstreet">Yuwen</a> joined the project at the right
time. Thanks to <a href="https://github.com/michaelkirk">Michael</a> and feedback from
dozens of people from OpenStreetMap, Github, Twitter, and user testing studies,
A/B Street today is quite aesthetic and functional.</p>
<h3 id="color-schemes"><a class="header" href="#color-schemes">Color schemes</a></h3>
<p>One of the puzzles I struggled with from the very start was how to communicate
both lane types and road types at the same time. Unzoomed, a simple color scheme
distinguishes highways from major and minor roads:</p>
<p><img src="project/history/retrospective/colors_unzoomed.png" alt="" /> <em>I5 is distinguishable from arterial and residential
roads in Seattle, and the Burke Gilman trail is also visible.</em></p>
<p>But zoom in, and we use coloring to distinguish regular lanes, parking, and
sidewalks. It's still useful to distinguish major and minor roads, though! Most
maps cheat with road width and use that, but there are many cases where
arterials are just as wide as residential streets.</p>
<p><img src="project/history/retrospective/colors_zoomed_before.png" alt="" /> <em>Can you spot the arterial?</em></p>
<p>But inspired by designs from
<a href="https://github.com/westnordost">Streetcomplete by Tobias</a>, we found some shades
of grey that convey the difference quite effectively, as well as slightly convey
the curb height:</p>
<p><img src="project/history/retrospective/colors_zoomed_after.png" alt="" /> <em>There it is!</em></p>
<p>Also, we have a pretty fantastic night mode, although I'm still holding out for
something more cyberpunk.</p>
<p><img src="project/history/retrospective/colors_night.png" alt="" /> <em>Both the UI and map have colors to show when the
simulation is after-hours</em></p>
<h3 id="road-editor"><a class="header" href="#road-editor">Road editor</a></h3>
<p>A/B Street's ability to edit roads started simple, but today is quite powerful.
Inspired by <a href="http://streetmix.net">Streetmix</a>, you can modify lanes however you
want:</p>
<p><img src="project/history/retrospective/edit_roads.gif" alt="" /> <em>Drag-and-drop, spear-headed by Michael, is key to this UI
working smoothly.</em></p>
<p>We arrived at this design only after many rounds of designing, implementing
prototypes, and gathering feedback.</p>
<h3 id="traffic-signal-editor"><a class="header" href="#traffic-signal-editor">Traffic signal editor</a></h3>
<p>Most people experience traffic signals from the ground, not the sky -- they
think about just the direction they want to go, not how the entire intersection
behaves over time. At any point in time, a particular movement could be
protected by a green arrow or light, permitted after yielding to oncoming
traffic, or not allowed. After many iterations, I think we represent and allow
changes to this quite well:</p>
<p><img src="project/history/retrospective/edit_signals.gif" alt="" /> <em>Left turns should be protected here. So first we remove
the left turns from stage 1, where they were just permitted. Then we add a new
stage, protect the left turns, and adjust its timing to end early if there's no
traffic.</em></p>
<h3 id="data-visualization"><a class="header" href="#data-visualization">Data visualization</a></h3>
<p>A/B Street measures all sorts of things -- travel times, delays, throughput, a
biking route's steepness, exposure to risky events. All of these things can be
understood at the level of individual agents, roads, and intersections, or you
can explore aggregate patterns and finder larger trends. You can view the data
in absolute terms based on the current simulation running, or if you've edited
the map (and the map is one of the lucky few that doesn't gridlock), then you
can compare the results to the baseline simulation without edits -- the essence
of A/B testing.</p>
<p>Here's a very incomplete sampling of our work:</p>
<p><img src="project/history/retrospective/viz_trip.png" alt="" /> <em>Diving into one person's route</em></p>
<p><img src="project/history/retrospective/viz_delay_scatter.gif" alt="" /> <em>Watching a live scatter plot of delays through an
intersection, broken down by mode</em></p>
<p><img src="project/history/retrospective/viz_relative_thruput.png" alt="" /> <em>The red roads have higher foot traffic, due to
converting Broadmoor to a Stay Healthy Street</em></p>
<p><img src="project/history/retrospective/viz_trip_table.gif" alt="" /> <em>Using a sortable table of all trips to find individual
people whose journey got much faster due to map edits</em></p>
<p><img src="project/history/retrospective/viz_time_summary.gif" alt="" /> <em>Understanding how short and long trips got faster or
slower due to map edits</em></p>
<h3 id="road-labels"><a class="header" href="#road-labels">Road labels</a></h3>
<p>Placing road labels on a map is quite a design and implementation challenge, but
Michael and I cranked out something decent in a few days:</p>
<p><img src="project/history/retrospective/road_labels.gif" alt="" /> <em>Labels aren't too densely clustered, but they still appear
to help orient by major roads.</em></p>
<h3 id="charm"><a class="header" href="#charm">Charm</a></h3>
<p>Some design decisions in A/B Street are a love story to the city that started
it:</p>
<p><img src="project/history/retrospective/rainbow_crosswalks.png" alt="" /> <em>The cycletrack may not be snapped to Broadway
properly, but we do have the rainbow crosswalks on Pike</em></p>
<p>We tried to create a narrative around the game's challenge modes, with character
art from a <a href="https://hollarity.com/">college friend</a>:</p>
<p><img src="project/history/retrospective/characters_cutscene.png" alt="" /> <em>The Boss doles out assignments and placates irate
citizens</em></p>
<p>One of the first things people point out about A/B Street is the unusually bendy
buses:</p>
<p><img src="project/history/retrospective/articulate.gif" alt="" /> <em>&quot;This frustrated tension and brief relief I cant
articulate / oh, but the bus can.&quot; - from
<a href="https://dabreegster.github.io/poetry/adult/public_transit.html">public transit</a></em></p>
<p>For the record, this started because the simpler alternative is much worse. If
you draw a long bus as a straight line and use any one point to determine the
angle, the bus will pendulum around tight curves, happily smashing into anything
in the way. Snakes are a slightly better approximation of reality. (I think the
bendy buses have been called some less polite, but more hilarious, things
too...)</p>
<h2 id="project-management-1"><a class="header" href="#project-management-1">Project management</a></h2>
<p>Here's the section where I feel like the challenges have swallowed me, with very
little success.</p>
<h3 id="collaborations"><a class="header" href="#collaborations">Collaborations</a></h3>
<p>I was pretty quiet the first year, but then I started actively looking for
people interested in working on this. I've lost track of all the people I've
spent at least an hour talking to and seriously trying to set up some sort of
collaboration -- at least 100? I've tried everything I can to attract
<a href="project/history/retrospective/../../contributing.html">contributors</a> for programming, design, business,
outreach, writing. Many start, but wind up vanishing. It's exhausting for me; I
get emotionally invested in everybody who wants something from A/B Street.
Running an open source project is really hard. <strong>But I want to emphasize it has
partly worked -- I'm super thankful for the ~dozen people who have stuck around
and really made working on this project a true pleasure.</strong> I probably need to
learn to filter better, fail-fast, and put some barriers up before I invest.</p>
<p>There were a few low moments that stand out. Accidentally CC'd on an internal
email literally stood the question, &quot;It's open souce, why pay him anything?&quot;
when I was trying to set up a small consulting deal. There was also a group that
was too cheap to hire somebody for their own idea, so exploited the fact that
this is a passion project for me and for a while, somewhat successfully coerced
me to work on their quasi-startup. There were also some highlights, especially
when butting heads philosophically. Not everybody understood my
<a href="project/history/retrospective/../../motivations.html">mission</a> before reaching out. I'll never forget one video
call with a company that was going splendidly, until I explicitly stated all
work I do will be open source -- watching the other person scramble to control
their plummeting facial expression was perfect. And once I got the most Silicon
Valley-ish email ever that started, &quot;I'm the founder of a XYZ billion dollar AV
startup.&quot; After thinking a moment, I led back with, &quot;Well I think your XYZ
billion dollar startup is a reasonable stepping towards car-free cities, but AVs
aren't part of the world that I ultimately want to build towards.&quot;</p>
<p>These moments still bring me strength.</p>
<h4 id="the-success-stories"><a class="header" href="#the-success-stories">The success stories</a></h4>
<p>I want to particularly thank Robin for his involvement with A/B Street. He
fought to make it a part of <a href="https://actdev.cyipt.bike">ActDev</a>, a really neat
data science tool studying how people living in new residential sites in the UK
are likely to commute. This integration provided a strong push to solidify the
web deployment of A/B Street.</p>
<p><img src="project/history/retrospective/poundbury_actdev.png" alt="" /> <em>You can explore mode split patterns and other data in
the ActDev site</em></p>
<p><img src="project/history/retrospective/poundbury_abst.png" alt="" /> <em>and then just click to simulate the site at an
agent-based level, and edit the cycle network</em></p>
<p>Robin has also massively helped evangelize the project and network with possible
users. Along with Nathanael, they've made A/B Street more accessible to the data
science community, creating an <a href="https://a-b-street.github.io/abstr/">R package</a>
to transform travel demand models into individual trips to simulate. Robin's
enthusiasm for open source and reproducible research is infectious.</p>
<h3 id="project-scope"><a class="header" href="#project-scope">Project scope</a></h3>
<p>Traffic simulation is such a massively broad endeavor, and because I dabble in
so many parts of it, people really brought strong expectations about what they
wanted it to be. What about Monte Carlo simulations? Or gondolas? (No, really.)
Why not build a city from scratch, just merge with Citybound? Oh, there's no
lane-changing? Not calibrated to real traffic volume data? Well then it must be
useless.</p>
<p>I tried my best to balance all of that input with establishing boundaries and
pursuing MY vision.</p>
<p>... But what exactly was my vision? I said early on, &quot;this is an identity crisis
between a game and a serious planning tool.&quot; At first that was a way to punt on
the realism and calibration problem -- I couldn't hope to alone compete with
industry standard simulation software. It was also a way to engage the general
public, or at least the percentage that plays games.</p>
<h3 id="teasing-apart-the-monolith"><a class="header" href="#teasing-apart-the-monolith">Teasing apart the monolith</a></h3>
<p>The scope of A/B Street is <strong>way</strong> too broad. Early on, all of the new
experiments were just crowded onto the title screen, but at some point, we split
out more tools with more focused purposes.</p>
<p>The &quot;main&quot; app is A/B Street -- that thing that lets you simulate traffic and
edit roads. Part of it still tries to act like a computer game, but we haven't
put much effort into this in quite a while. It does have a tutorial and a few
challenge modes with particular objectives (and even a narrative with some
characters!). But I wouldn't call A/B Street as a game &quot;fun&quot; -- one of the
challenge modes is impossible to win, because we picked too large a map to ever
hope to get past the gridlock bugs. We could chop up the challenges into much
smaller &quot;levels&quot; and properly tune the difficulty curve, but it would honestly
take somebody dedicated to game design to spearhead that.</p>
<p><img src="project/history/retrospective/tutorial.png" alt="" /> <em>The user interface can be overwhelming, but the tutorial
slowly introduces and motivates different features. The more ambitious idea was
always to have the player slowly &quot;unlock&quot; more of the tools as they complete
challenges.</em></p>
<p>Instead, most uses of A/B Street are in the &quot;sandbox&quot; mode, where no specific
objectives exist. Instead, this is a place to edit the map, explore all the
different data visualizations, and try to inch towards completing a full
simulation without gridlock.</p>
<p>I feel bad that A/B Street as a properly fun game was never realized, but I'm
proud of <a href="project/history/retrospective/../../../software/santa.html">15-minute Santa</a>. By no means is Santa
attempting to split the difference between serious planning and entertainment;
it's just a silly arcade game that loosely involves transportation and land use.</p>
<p><img src="project/history/retrospective/santa.gif" alt="" /> <em>Paperboy modernized with OpenStreetMap, a Santa sprite, and
plenty of silliness</em></p>
<p>We also made a tool to explore
<a href="project/history/retrospective/../../../software/fifteen_min.html">15-minute neighborhoods</a>. The isochrones are
hopefully useful to understand what parts of a city have good or bad access to
different types of shops, and how hills and slow traffic signals affect walk or
bike-sheds. Editing the map -- particularly to modify land use -- and checking
out the differential isochrone would be the ultimate use for this tool, should
we ever revive it.</p>
<p>As I realized the most active audience for A/B Street is the OpenStreetMap
community, I spun out some tools to
<a href="project/history/retrospective/../../../software/osm_viewer.html">validate lane tagging</a> and
<a href="project/history/retrospective/../../../software/parking_mapper.html">tag street parking</a>.</p>
<p>After some feedback from advocacy groups and people who felt overwhelmed by the
broad scope of A/B Street, we created a
<a href="project/history/retrospective/../../../software/ungap_the_map/index.html">simple interface for sketching and evaluating a bike network</a>.</p>
<p>And now we're spinning up a dedicated tool for
<a href="project/history/retrospective/../../../software/ltn/index.html">low traffic neighborhoods</a>.</p>
<h3 id="marketing"><a class="header" href="#marketing">Marketing</a></h3>
<p>The successful marketing basically came for free. A single bold post to
<a href="https://old.reddit.com/r/Seattle/comments/hdtucd/ab_street_think_you_can_fix_seattles_traffic/">r/seattle</a>
was magic. Someone &quot;leaked&quot; the project to
<a href="https://news.ycombinator.com/item?id=23605048">Hacker News</a>. I think the
<a href="https://www.youtube.com/watch?v=LxPD4n_1-LU">alpha launch trailer</a> got the
point across.
<a href="https://www.thestranger.com/slog/2020/06/29/43999454/ab-streets-game-lets-you-create-the-seattle-street-grid-of-your-dreams">The Stranger</a>
made a shocking connection between my childhood with Banjo Kazooie and my
current fascination with multi-modal travel.</p>
<p>But I've also hustled near-constantly online and in-person, at countless
hackathons and <a href="project/history/retrospective/../../presentations.html">conferences</a>. I've cold-emailed so many
companies trying to set up collaborations.</p>
<h3 id="community"><a class="header" href="#community">Community</a></h3>
<p>The A/B Street Slack has a sense of home to me; it might've started for work,
but I've forged friendships there.</p>
<p>I think I did a reasonable job amassing a small army of people interested in
open source transportation software. Some of the academic and data science
communities weren't talking to each other before I got people into the same
(virtual) room.</p>
<h3 id="money"><a class="header" href="#money">Money</a></h3>
<p>I self-funded from savings from my previous big tech job. I feel super fortunate
to have had zero pressure to make money with A/B Street, letting me prioritize
what really matters to me. I've even personally funded a few people to create
<a href="project/history/retrospective/../../funding.html">new open source libraries</a> that I needed.</p>
<p>But not starting a business, even some kind of consulting firm, was likely a
mistake. Many of the groups I tried to collaborate with probably had no idea how
to deal with me. There's no legal entity for the project, I'm not in academia,
I'm not even calling it a startup.</p>
<h1 id="the-problem"><a class="header" href="#the-problem">The problem</a></h1>
<p>That thing I've poured 3+ years of my life into? Nobody's using it.</p>
<p>(Except maybe a few members of the OSM community, in a way I mostly don't hear
about.)</p>
<h2 id="advocacy-groups"><a class="header" href="#advocacy-groups">Advocacy groups</a></h2>
<p>For a long time, I've insisted that either advocacy groups who fight for
biking/walking-friendly changes in cities or individual Twitter urbanists with
large followings would find some use for A/B Street. Maybe the traffic
simulation stuff is overwhelming and not trustworthy, fine. But at least the
top-down road visualization and editing is better at communicating an idea than
some squiggly lines on top of Google Maps? Surely groups pushing for a better
bike network want to see how elevation and collision data relate to their ideas?</p>
<p>And the more I understand about how advocacy groups (at least in Seattle) work,
the less I have faith in them to avert the climate crisis. I seriously respect
their longevity and determination, but fighting for years to get only the
slightest improvement isn't a time-scale I believe in. Cities need a massive
culture shift. I want to find and work with the people who have some sense of
urgency, even if that's not realistic.</p>
<h2 id="the-public"><a class="header" href="#the-public">The public</a></h2>
<p>The thesis behind A/B Street is that ordinary citizens are experts in some small
slice of the city that they interact with. And so when they see a problem, A/B
Street is a tool for them to explore and express ideas for changing it. But I'm
beginning to believe I'm wrong about this -- because, where are they? If
somebody's only casually interested, they're not going to dedicate their time to
fighting for a real change. And if somebody really does care enough, they'll...
possibly wind up working for a city government, where they actually have power
to change things (and slowly have their spirit crushed by bureaucracy).</p>
<p>I had many goals with A/B Street that are about sparking culture shifts:</p>
<ol>
<li>Pushing people towards sustainable car-free cities</li>
<li>Getting more ordinary citizens involved, in a productive way</li>
<li>Getting different parties -- government, citizen, advocacy group -- on the
same level, communicating in a standard way</li>
<li>Promoting open data and open source software for use in government planning
-- why trust the traffic analysis that you can't read and reproduce yourself?</li>
</ol>
<p>I don't feel I've budged the needle on any of these.</p>
<h2 id="whos-our-audience"><a class="header" href="#whos-our-audience">Who's our audience?</a></h2>
<p>I've tried to avoid actually advocating myself for specific changes in Seattle.
Partly this is because there are well-established groups here that do this
already, and I want to spend my energy doing what I enjoy more -- creating
software to empower them. Partly I'm afraid of promoting ideas that're tied to
my own biases and wouldn't serve everyone in Seattle well -- I have a
conspicuous gap of knowledge about biking in South Seattle, a place with much
more traffic violence and much less cycling-friendly infrastructure. And partly,
I'm just lazy and avoiding writing -- I can do it, but it's so draining --
writing this document was quite difficult for me. As a team, we have published
<a href="project/history/retrospective/../../../proposals/broadmoor.html">one simple advocacy piece</a> -- written by
Michael -- more to experiment with the format than to push for a real change
(although the idea would be fantastic, asking to open up private roads is a
non-starter).</p>
<p>I don't have a good understanding of politics or how to actually help advance
real changes on the ground. But since we've failed to find users for A/B Street
that're advancing some cause, then... there is one last thing we could try. Will
I rip off such an adhesive bandage before it's too late?</p>
<h2 id="what-this-project-means-to-me"><a class="header" href="#what-this-project-means-to-me">What this project means to me</a></h2>
<p>I try to inject my humor into A/B Street wherever I can. When I skim through the
<a href="https://github.com/a-b-street/abstreet/releases">release names</a>, I remember the
story of my life that week, or something bizarre I cooked/ate/&quot;foraged&quot; --
ajitummy, twice-dumpstered anything, beef welldoneington, tostonical vows, the
rise of Fridgehaus, rubducks in the laptub, taro bingsoothsayer, Hausbroken.</p>
<p>After weeks of sweating over what the 15-minute neighborhood tool is supposed to
do and just one stout, I exploded out of my room and drunkenly pitched
<a href="project/history/retrospective/../../../software/santa.html">15 minute Santa</a> to my bewildered housemates. Then
Michael and Yuwen and I made it (thank you for putting up with me).</p>
<p>A/B Street is my self-expression. Its origins are tangled in a mess of
bittersweet memory (I wasn't the one who thought a game should be about traffic)
and near-misses with trucks passing too closely on Boyer. I used it to pull out
of a nose-dive of depression -- that's a story I'm still trying to write. I
broke my fear and landed some of the largest jumps of my life (I do
<a href="http://dcarlino.org/parkour">parkour</a>) as an escape from constantly thinking
about A/B Street. I've worked on this project for the entirety of COVID. I've
coded while taking the shinkansen from Tokyo to Miyazaki and the TGV from Paris
to Berlin. I pushed code the morning of my ACL surgery, and reviewed a PR when I
got home (and was remarkably lucid). It's safe to call me obsessed. I quit my
job to do this. I've worked on it basically every weekday and weekend for 3
years, and thought about it constantly for at least 6 months before starting the
project full-time.</p>
<p>A/B Street lets me take a bird's eye view of the messy world I move through,
imagine it a bit differently, and try to convince others to see it the same way.</p>
<p>If anybody wants to convince me to do something else instead, now you know what
you're up against. And if you succeed, you know how important your idea must be
to me instead.</p>
<h1 id="epilogue"><a class="header" href="#epilogue">Epilogue</a></h1>
<p>(November 2021, a few months after this article was first written.)</p>
<p>After a rocky few months, I've decided to continue this &quot;passion project,&quot; but
with some changes and a much more clear understanding of what I want out of it.
Stay tuned.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="changelog"><a class="header" href="#changelog">CHANGELOG</a></h1>
<p>Every time I upload a new <a href="https://github.com/a-b-street/abstreet/releases">binary
release</a>, I'll list major
changes here.</p>
<p>0.1.0</p>
<ul>
<li>First binary release</li>
</ul>
<p>0.1.1</p>
<ul>
<li>drawing arrows better</li>
<li>start with a splash screen, make it easy to change maps in-game</li>
</ul>
<p>0.1.2</p>
<ul>
<li>totally revamp GUI by organizing everything into distinct gameplay modes</li>
</ul>
<p>0.1.3</p>
<ul>
<li>new warp tool that autocompletes street names</li>
<li>hideable menus, place context menus better, remove top menu bar, add a simple OSD</li>
<li>loading screens reflect what's printed to the terminal</li>
<li>depict pedestrians and bikes with more detail</li>
<li>tool to scroll through an agent's route</li>
<li>make simulation speed controls actually work</li>
</ul>
<p>0.1.4</p>
<ul>
<li>improve stop sign editor UI (toggle entire roads)</li>
<li>better mouseover / selection rendering</li>
<li>better traffic signal rendering (show time left, use outlines for yields)</li>
<li>make cars actually stop and briefly wait at stop signs</li>
<li>improve edit mode diff visualization (cross-hatching)</li>
<li>render actual stop signs, not just red lines</li>
<li>fix intersection policies confused by conflicting straight turns with lane-changing</li>
<li>fix mac scrolling</li>
<li>better turn indicators</li>
<li>nicer unzoomed view of roads, with different colors for big/small roads</li>
</ul>
<p>0.1.5</p>
<p>(release file size jumped from ~15MB to ~70MB because of new PSRC trips)</p>
<ul>
<li>improve UX of intersection editors</li>
<li>define a better set of maps included by default</li>
<li>improve drawing speed by batching more stuff</li>
<li>better default traffic signal policies for many cases</li>
<li>import and visualize census data</li>
<li>fix missing sidewalks on downtown one-ways</li>
<li>import and visualize PSRC trip data</li>
</ul>
<p>0.1.6</p>
<ul>
<li>slider widget for controlling time and speed</li>
<li>fixing bad polyline geometry in most cases; visualizing routes should no longer be buggy</li>
<li>handle PSRC trips that begin or end out-of-bounds</li>
<li>draw agents in unzoomed mode in a way simpler way</li>
<li>improve edit mode: detect reverts to original, easier lane type switching</li>
<li>lots of fixes for buses: handle edits better, read sequence of stops correctly from GTFS</li>
<li>set up A/B tests faster</li>
</ul>
<p>0.1.7</p>
<ul>
<li>bulk and revert tools in edit mode</li>
<li>improve turns and default intersection policies when bike/bus lanes involved</li>
<li>new tool to manually hint for short roads and weird intersections. some problems have now been manually fixed</li>
<li>scoreboard of trip results for sandbox and A/B test mode</li>
<li>reduce lag when sim is running at full speeds, but system is too slow</li>
<li>switch to easbar's contraction hierarchy crate, making all pathfinding INSANELY fast</li>
<li>remove weird rules about the world freezing when traffic signals are in &quot;overtime&quot;</li>
</ul>
<p>0.1.8</p>
<ul>
<li>edit mode: convert to a ped scramble cycle, simplify stop sign editor by removing individual turns</li>
<li>ui: put labels next to sliders, organize modal menus into sections, add a minimize/maximize icon</li>
<li>A/B test mode: savestate, include time controls and agent following/route tools here</li>
<li>use more OSM data for turn lanes, turn restrictions from lanes, turn restrictions between entire roads</li>
<li>dont attempt to cross a traffic signal if there's absolutely no hope</li>
<li>improve bus route UI tools and make routes using transit more sane</li>
<li>user-defined shortcuts for jumping between views of a map</li>
</ul>
<p>0.1.9</p>
<ul>
<li>sliders to pick times in wizards</li>
<li>fix hidpi scaling</li>
<li>traffic signal diagram scrolls properly</li>
<li>easier to instantiate a scenario, show all trips involving a building for a scenario</li>
<li>colorschemes to show trip duration or time blocked</li>
<li>label buses with route number</li>
<li>represent overlapping pedestrians as a labeled crowd</li>
<li>massive performance boost via real priority queue</li>
<li>prevent cars from &quot;blocking the box&quot;</li>
<li>prevent all? aborted trips (due to parking blackholes mostly)</li>
<li>smarter roam-around-for-parking router</li>
</ul>
<p>0.1.10</p>
<ul>
<li>sim
<ul>
<li>parking in off-street garages and on-street lanes on the off-side of oneways now mostly works</li>
<li>detect and handle parking blackholes; cars should never get stuck looking for parking now</li>
<li>let lower-priority turns happen at traffic signals when higher-priority ones blocked</li>
<li>get closer to FCFS ordering at stop signs</li>
<li>basic opportunistic lane-changing</li>
<li>a bus should be seeded for every route now</li>
</ul>
</li>
<li>demand data
<ul>
<li>show trips to/from buildings and borders</li>
<li>make PSRC trips seed and attempt to use parked cars</li>
</ul>
</li>
<li>UI
<ul>
<li>different heatmap overlays, like parking availability and busiest areas</li>
<li>show colorscheme legends when relevant</li>
<li>interactively seed parked cars, spawn more types of trips</li>
<li>fix major A/B test mode bug (mismatched scenarios and map edits)</li>
<li>adjusting sliders, menu placement, dynamic items</li>
<li>consolidating different tools into a single info panel for objects</li>
<li>bus route explorer shows entire route, current bus location</li>
</ul>
</li>
<li>map quality
<ul>
<li>degenerate intersections only have one crosswalk now</li>
<li>revamped the map editor for fixing geometry problems, used it in many places</li>
<li>nicer yellow center lines (dashed when appropriate)</li>
<li>handling OSM turn restriction relations properly</li>
<li>fix empty traffic signal phases</li>
<li>handling bike lanes on certain sides of the road</li>
<li>starting to upstream manually-verified parking lanes into OSM</li>
</ul>
</li>
<li>new gameplay: reverse direction of lanes</li>
</ul>
<p>0.1.11</p>
<ul>
<li>small UI fixes: fixed width traffic signal diagram, skip info phase of menus when empty</li>
<li>start drawing (but not using) shared left-turn lanes from OSM</li>
<li>fix OSM polylines with redundant points (fixing an issue in ballard)</li>
<li>improved traffic signal policies in some cases</li>
<li>started upstreaming some sidewalk tags in OSM to fix inference issues</li>
<li>fixed misclassified right turns</li>
<li>adjusting map colors</li>
<li>handling lakes/ocean polygons from OSM way better</li>
<li>reorganized sim analytics, added stuff for bus arrivals</li>
<li>adding new internal road points to map editor. almost ready to really aggressively use it</li>
<li>skipping parking lanes with no nearby sidewalks, since they're unusable</li>
<li>fix z-order of bridges/tunnels in unzoomed view</li>
<li>allow unzooming indefinitely</li>
<li>move lots of sandbox mode controls (and other modes) to menus under buttons and dedicated buttons</li>
<li>basic support for marking a lane closed for construction</li>
<li>improved geometry of sidewalks at dead-ends</li>
</ul>
<p>0.1.12</p>
<ul>
<li>reorganize everything as different challenge modes. start implementing 3: optimizing a bus route, speeding up all trips, or causing as much gridlock as possible</li>
<li>improved bus route explorer</li>
<li>some UI fixes (popup messages in a few places, moving mouse tooltips to the OSD)</li>
<li>lots of analytics and time-series plots</li>
</ul>
<p>0.1.13</p>
<ul>
<li>analytics: prebake baseline results properly. hover over plot series. some new modes to see bus network, throughput of a road/intersection over time</li>
<li>log scale for the speed slider</li>
<li>add a bulk spawner in freeform mode (F2 on a lane)</li>
<li>rendering: nicer routes, crosswalks, zoomed car colors</li>
<li>map data: better stop sign and sidewalk heuristics</li>
<li>fixed the mac hidpi text rendering issue once and for all?!</li>
</ul>
<p>0.1.14</p>
<ul>
<li>better crosswalk generation when there's only a sidewalk on one side of a road</li>
<li>edit mode UI revamp: paintbrush-style buttons to apply changes to lanes</li>
<li>show error messages and prevent edits, like disconnecting sidewalks</li>
<li>properly ban bikes from highways (revamped rules for vehicles using a lane)</li>
<li>new freeform mode tool to spawn bikes</li>
<li>WIP (not working yet): make bikes prefer bike lanes. some debug heatmaps for path cost</li>
<li>edit mode has proper undo support</li>
</ul>
<p>0.1.15</p>
<ul>
<li>minor bugfixes with reverting lane types, preserving stop signs</li>
<li>incorporate edits into the challenge splash screen, make sure edits are reset when appropriate</li>
<li>starting a new challenge mode, just focused on traffic signals</li>
<li>can't leave traffic signal editor with missing turns</li>
<li>render pedestrian crowds on building front paths</li>
<li>traffic signals support an offset parameter</li>
<li>traffic signal visualization and editing revamped to group related turns together</li>
<li>can preview traffic using a signal from the editor</li>
<li>actually apply priority at intersections, so protected turns get first dibs over yield turns</li>
</ul>
<p>0.1.16</p>
<ul>
<li>fix Mac crashing with texture limit bug by switching to texture arrays</li>
<li>fix crashing simulation when a border intersection was used</li>
<li>started to implement a new UI design for starting the game</li>
</ul>
<p>0.1.17</p>
<ul>
<li>more work on the pre-game UI, with some flexbox layouting</li>
<li>prototype a minimap in sandbox mode. doesn't pan or scroll yet.</li>
<li>prototype a new speed/time control panel from the mockup</li>
<li>nicer time warp loading screen</li>
<li>record and show detailed trip timeline, including time to park</li>
</ul>
<p>0.1.18</p>
<ul>
<li>map data: infer more building addresses</li>
<li>some analytics on how long people spend parking and intersection delay over time</li>
<li>create an options panel, allowing runtime customization of color scheme, traffic signal rendering, etc</li>
<li>internal changes to map building pipeline to make it much easier for new devs to onboard</li>
<li>organizing challenges into sub-stages, starting to flesh out specifics for the fix traffic signal track</li>
<li>much more realistic pedestrian pathfinding</li>
<li>fix minimap on mac (dpi issues)</li>
<li>visual tweaks to cars to make front/back easier to distinguish</li>
<li>internal change to switch most assets from PNG to SVG</li>
</ul>
<p>0.1.19</p>
<ul>
<li>some challenge modes show a histogram for counting faster/slower trips</li>
<li>new visualization of current demand per direction at a traffic signal</li>
<li>implementing some of Yuwen's UI changes: agent counter, split time/speed panel, moved functionality out of the old drop-down menus into a bottom-left tool panel, hiding debug functionality</li>
<li>replaced right-click context menus with left click to open info panels</li>
<li>fixed random issues reported by people from HN</li>
</ul>
<p>0.1.20</p>
<ul>
<li>moved some UI functionality around, pulling graphs into info panel</li>
<li>interactive legend for the minimap, toggle visibility of different agents</li>
<li>nicer colors and shapes for cars</li>
<li>misc simulation bugfixes that might help huge_seattle</li>
<li>pedestrians choose to use transit more realistically, factoring in time for the bus to drive</li>
</ul>
<p>0.1.21</p>
<ul>
<li>switch some analytics dashboards to use buttons, not old non-scrolling menus</li>
<li>scrollbars... at least a start</li>
<li>preview traffic signal changes from live sim as the base</li>
<li>traffic signal preview has normal time/speed controls</li>
<li>traffic signal editor has undo support</li>
<li>minimap has buttons to pan</li>
</ul>
<p>0.1.22</p>
<ul>
<li>minimap zoom controls</li>
<li>traffic signal rendering overhaul</li>
<li>heatmap colors improved, heatmap appears on minimap</li>
<li>bus info panel, a start to live delay analytics</li>
</ul>
<p>0.1.23</p>
<ul>
<li>UI revamps: speed panel, minimap controls, heatmap chooser</li>
<li>bus timeline</li>
<li>hide internal IDs normally</li>
<li>limit map zoom</li>
<li>fix bugs with crosswalks conflicting with vehicle turns</li>
</ul>
<p>0.1.24</p>
<ul>
<li>overhaul traffic signal editor UI, and add redo support</li>
<li>update main edit mode UI, and add redo support</li>
<li>limit max unzoom</li>
<li>fix the infamous HiDPI bug once and for all; minimaps should work everywhere</li>
<li>almost bug-free support for floating, horizontally and vertically scrolling panels</li>
<li>overhaul top-center panel, rename scenarios to be less confusing</li>
<li>expose bus analytics outside of challenge mode</li>
<li>live info panel can exist during a running simulation</li>
<li>consolidated agent route/trip information into info panel</li>
</ul>
<p>0.1.25</p>
<ul>
<li>overhauled the tutorial</li>
<li>tuned top-center panel for sandbox and challenge modes</li>
<li>make bike and bus lanes more obvious</li>
<li>show map edits as an overlay anywhere</li>
<li>tune info panel contents, and show relationships between parked cars and buildings</li>
<li>fixes to traffic signal editor, like making all-walk conversion idempotent</li>
<li>nicer throughput and delay plots (sliding windows, grid lines)</li>
</ul>
<p>0.1.26</p>
<ul>
<li>tutorial improved in a few places</li>
<li>map data: thinner sidewalks, associate buildings with named amenities</li>
<li>traffic model: vehicles can spawn on all lanes from a border</li>
<li>much better gameplay speed (previously was too fast)</li>
<li>UI tuning: lane editor, minimap, signal editor, heatmap legends don't overwrite minimap</li>
<li>traffic signal challenge communicates score more clearly</li>
</ul>
<p>0.1.27</p>
<ul>
<li>edit mode revamped: click to edit stuff. no more lane paintbrushes. autosaving and save as.</li>
<li>tutorial: can quit and resume tutorial now</li>
<li>challenge picking flow simplified</li>
<li>UI: layouting fixes to full-screen / into stuff, popup menus go beneath buttons, plots improved</li>
<li>internal change to render all text using vector graphics. other than a few text layouting issues, shouldn't be noticeable, except now tooltips in plots don't get covered up</li>
<li>misc perf improvements (cache SVGs, drawing many circles for unzoomed agents, dont reload prebaked data)</li>
<li>upgraded winit, glutin, glium -- hopefully no new bugs introduced on any platforms</li>
</ul>
<p>0.1.27a</p>
<ul>
<li>patch to fix a crash with empty text dimensions on things like building info panels</li>
</ul>
<p>0.1.28</p>
<ul>
<li>all info panels revamped</li>
<li>some tutorial stages are much more clear, with an updating goal</li>
<li>traffic signal scorecard generalized to work for some tutorial too</li>
<li>adjust how selected agents look</li>
<li>X button on popup menus</li>
</ul>
<p>0.1.29</p>
<ul>
<li>new tool to convert between stop signs and traffic signals</li>
<li>lane editor easier to edit multiple lanes</li>
<li>info panels: IDs, mostly avoid horizontal scrolling, better info about trips to/from somewhere, move buttons up</li>
<li>traffic signal editor UI overhaul</li>
<li>different data in top-right agent meters panel</li>
<li>tooltips to communicate keybindings better</li>
<li>new jump-to-time panel, showing when rush hours occur</li>
<li>speed controls use more useful speeds</li>
<li>include ongoing trips in measured trip times</li>
<li>jump to next challenge after completing one</li>
<li>lots of tutorial tweaks</li>
</ul>
<p>0.1.30</p>
<ul>
<li>show additional info about traffic patterns and buggy maps</li>
<li>revamp tutorial UI to group tasks and messages better</li>
<li>handle different mode transitions when info panel open on an agent</li>
<li>select entire roads in unzoomed edit mode</li>
<li>show total time an agent has spent moving / blocked</li>
<li>use 2-phase traffic signals by default, making the 23rd map successfully complete!</li>
<li>jump-to-time now optionally points out traffic jams forming</li>
<li>challenge splash screen improved</li>
</ul>
<p>0.1.31</p>
<ul>
<li>overhauled trip timeline in agent info panels</li>
<li>overhauled traffic signal details panel and the per-lane turn explorer</li>
<li>settings page: show all options at once. add way to scale up text/UI elements for high-DPI displays, and an alternate pan/zoom control scheme</li>
<li>traffic signal edits can now be exported and used in any slice of Seattle. will be using this to hand-map many of them.</li>
<li>many small tutorial fixes</li>
</ul>
<p>0.1.32</p>
<ul>
<li>some UI work on giving focus to textboxes, improving dropdown menus</li>
<li>road/intersection plots display baseline sim data too</li>
<li>start associating people with multiple trips, exposing this a little in the UI</li>
<li>bring back elevation data, introduce a new overlay. the elevation data is still really bad.</li>
</ul>
<p>0.1.33</p>
<ul>
<li>new &quot;population&quot; overlay, showing people (not just current trips). heatmap and dot map to visualize.</li>
<li>improved the &quot;delay&quot; overlay to handle roads and intersections</li>
<li>removed the confusing and useless alternate color schemes for agents</li>
<li>initial left-hand driving side, tested in Perth, also drawing more arrows for all one-way roads</li>
<li>loads of internal GUI code refactorings, preparing for a standalone release of the library</li>
<li>fixed z-buffering and alpha values for web backend</li>
</ul>
<p>0.1.34</p>
<ul>
<li>info panels have been totally overhauled again. multiple tabs, way more clear representation of agents, trips, and people.</li>
<li>draw people inside of a building</li>
<li>applied consistent typography everywhere</li>
<li>lots of internal refactoring</li>
</ul>
<p>0.1.35</p>
<ul>
<li>more info panel work, particularly for trips and buses. change plot settings live.</li>
<li>prototype of a SEIR pandemic model based on time spent in shared spaces, by orestis</li>
<li>slight heatmap improvements, more coming</li>
<li>more typography changes</li>
<li>mouse cursor now changes for buttons and dragging!</li>
<li>overhaul minimap controls, make layers behavior zoomed in a little better</li>
<li>new speed panel and jump-to-time modal</li>
</ul>
<p>0.1.36</p>
<ul>
<li>overhauled simulation data page, with a table to find slow trips and some initial summary visualizations</li>
<li>plots can change windowing and show/hide series</li>
<li>layers: fade map to contrast more, better scales/legends</li>
<li>show relative trip times in info panels</li>
<li>tools to rewind/ffw to watch particular trips</li>
<li>refocusing efforts on challenge modes; level 1 of a new one is pretty much ready</li>
<li>some simulation fixes around parking and a corner case of cars temporarily forming a cycle</li>
<li>orestis improved the population/pandemic heatmaps</li>
</ul>
<p>0.1.37</p>
<ul>
<li>optimize commute challenge: high score, live sentiment, second stage</li>
<li>parked cars are owned by people, not buildings</li>
<li>info panel improvements for trips</li>
<li>bike layer suggests places where bike lanes could be helpful</li>
<li>many improvements to scatter plot</li>
<li>a new histogram-ish thing for understanding faster/slower trips</li>
<li>handling scenarios longer than 24 hours better (for pandemic model)</li>
<li>prototype of commute visualization, grouping buildings by blocks</li>
<li>sim bugfixes: crosswalk / vehicle turn conflicts, start bikes in bike lanes from borders</li>
</ul>
<p>0.1.38</p>
<ul>
<li>major internal changes to ensure people's schedules don't have impossible gaps, to associate fixed bikes/cars to a eprson, handle delayed starts to trips</li>
<li>parking changes: show path to closest free spot, utilization of a lane over time, every building includes at least 1 offstreet spot by default</li>
<li>progress on removing unrealistic gridlock: detect turn conflict cycles and temporarily allow conflicts, trim last steps of a laggy head</li>
<li>internal sim alert system. speeds up debugging, could be used for player-facing &quot;traffic jam!&quot; alerts</li>
</ul>
<p>0.1.39</p>
<ul>
<li>switched to proper OSM-based maps; no more brittle, manual geometry fixes</li>
<li>more sorting and filtering options in trip table and parking overhead tables</li>
<li>improve offstreet parking rendering. park closer to destination buildings</li>
<li>easier process for importing new cities. introducing Los Angeles, Austin, Barranquilla.</li>
<li>new data updater tool so people can opt-in to new cities</li>
<li>many internal fixes to prevent gridlock. smarter cycle detection, manual OSM fixes and traffic signal timings</li>
</ul>
<p>0.1.40</p>
<ul>
<li>differential throughput layer to understand routing diversions</li>
<li>map edits now reference longer-lasting OSM IDs, can work cross-map</li>
<li>basemap updates: new areas for west seattle, mt baker, lots of upstreamed fixes in OSM and traffic signals, smarter border matching</li>
<li>parking: optionally filter on/off-street spots in the layer, allow disconnecting spots via edits</li>
<li>render some tunnels with lower opacity</li>
<li>new feature to change speed limits and bulk road selection tools</li>
<li>first write-up of a real use case (closing lake wash through arboretum)</li>
<li>make the traffic signal challenge act like a game, with a failure/win state and scoring</li>
</ul>
<p>0.1.40a</p>
<ul>
<li>added a mode to map parking</li>
</ul>
<p>0.1.41</p>
<ul>
<li>new parking mapper tool</li>
<li>include a one-shot .osm importer in the release</li>
<li>new layer to find different types of amenities / businesses</li>
<li>adjust traffic signal rendering style</li>
<li>bulk lane editor for changing speed limits and lane types</li>
<li>including west seattle and udistrict maps</li>
<li>include some OSM buildings that were being skipped</li>
<li>dont pause after opening something from sandbox mode</li>
<li>adjust turn signals for lane-changing cars</li>
<li>lots of fixes for monitors with different DPIs, enabled by default</li>
</ul>
<p>0.1.42</p>
<ul>
<li>many misc UI bugfixes, especially for high-DPI screens</li>
<li>managing turns across multiple nearby intersections: tool to visualize, handling multi-way OSM turn restrictions, using this to ban illegal movements at the pathfinding layer, starting a traffic signal editor variant to edit these</li>
<li>rendering improvements: unzoomed agent size, visualizing routes on trip table, transparent roads beneath bridges, draw harbor island</li>
<li>overhauled street/address finder</li>
<li>parking mapper: shortcut to open bing</li>
</ul>
<p>0.1.43</p>
<ul>
<li>new map picker!</li>
<li>UI polish: traffic signal editor, layers, bus stops, delay plots</li>
<li>generate more interesting biographies for people</li>
<li>tuned all the map boundaries</li>
<li>fleshing out lots of docs in preparation for the alpha release...</li>
</ul>
<p>0.1.44</p>
<ul>
<li>spawner UI revamped</li>
<li>model parking lots! and finally model public/private parking</li>
<li>fix up tutorial</li>
<li>starting a story map mode</li>
</ul>
<p>0.1.45</p>
<ul>
<li>overhauled challenge cutscenes and hints</li>
<li>traffic signal challenge: fix score detection, add meter, much faster startup, no reset-to-midnight required</li>
<li>layers: use gradient for a few, delay comparison, new UI for picker</li>
<li>overhauled minimap controls, should be intuitive now</li>
<li>edit mode changelist UI started</li>
</ul>
<p>0.2.0 (alpha launch)</p>
<ul>
<li>road names now shown by default, in a new style</li>
<li>all layers now use gradients and show up zoomed in. worst traffic jam layer revamped.</li>
<li>scatter and line plot improvements</li>
<li>internal UI fixes: proper word wrap</li>
<li>bugfixes for following people riding the bus</li>
<li>rainbow crosswalks in one neighborhood</li>
<li>final polishing for launch</li>
</ul>
<p>0.2.1</p>
<ul>
<li>busy week due to launch, but many new features in the pipeline</li>
<li>many bug fixes</li>
<li>edit mode: proper autosave, load proposals, jump between lane/intersection editors</li>
<li>very first steps on light rail... importing the tracks</li>
<li>starting a new traffic scenario modifier system, to repeat entire scenario or outright cancel trips for some people. many more ideas for filters and actions coming soon.</li>
<li>starting to represent private roads</li>
<li>add a very simple actuated traffic signal</li>
</ul>
<p>0.2.2</p>
<ul>
<li>the default traffic signal configuration is much smarter now, handling roads with some sidewalks missing and automatically synchronizing pairs of adjacent lights</li>
<li>much faster startup time for large maps</li>
<li>better UX for handling unsaved edits</li>
<li>access-restricted zones: changing existing zones almost completely works, except for granting new access to pedestrians</li>
<li>new sidewalk corner rendering, more rounded</li>
<li>ui style standardized for margins, padding</li>
<li>Javed got camera panning when your cursor is at the edge of the screen to work; enable it in settings</li>
<li>pulling bus stop/route info from OSM, not GTFS. steps towards light rail.</li>
<li>experimenting with controls for hiding bridges to see roads underneath; try them in dev mode (ctrl+S)</li>
<li>many bug fixes</li>
</ul>
<p>0.2.3</p>
<ul>
<li>lane geometry is dramatically fixed, especially for one-ways</li>
<li>importing lanes from OSM improved</li>
<li>UI: bulk select includes select-along-a-route, show all bus routes in the layer, unzoomed zordering for roads/intersections</li>
<li>traffic scenario modifier can now convert trip modes</li>
<li>slight progress on light rail, although the train only makes one stop</li>
<li>vehicles moving through complex intersections with multiple traffic signals will now make it through multiple lights, even if they're unsynchronized</li>
<li>new random traffic scenario generator that makes people go between houses and workplaces</li>
<li>access-restricted zones: granular editing of individual roads now mostly works</li>
<li>removing the hardcoded relative directories, which many people have been having problems with</li>
<li>many many bug fixes, and some optimizations to reduce release file size</li>
</ul>
<p>0.2.4</p>
<ul>
<li>bus/train routes overhauled; they're now one-way, regularly spawn every hour, and may begin or end at a border</li>
<li>new commute pattern explorer tool</li>
<li>new character art to give cutscenes a bit more personaliy</li>
<li>some progress on gridlocking maps, both from manual fixes and an attempt to reduce conflicts in multi-turn sequences</li>
<li>misc UI: show cars seeking parking in unzoomed mode, plot arrival rate at border intersections, consolidate bulk selection controls</li>
<li>trips modified by an experiment can now be filtered in summaries</li>
<li>buses, trains, and passengers on them are now properly distinguished in different stats</li>
<li>include krakow and berlin in release</li>
<li>buildings with holes in the middle are now rendered properly</li>
</ul>
<p>0.2.5</p>
<ul>
<li>cars pick lanes better</li>
<li>overhaul bus/stop/route info panels</li>
<li>UI: better autocomplete, commuter pattern improvements by Michael, toggles instead of checkboxes, contours for heatmaps, edit mode loader revamp</li>
<li>internal refactors: turn creation, osm tags, osm parsing</li>
<li>import living streets from OSM as restricted-access zones, and other importer tweaks for berlin, krakow, san jose, sydney</li>
</ul>
<p>0.2.6</p>
<ul>
<li>many roads without sidewalks now have a tiny shoulder lane, still enabling pedestrian movement, but with a penalty</li>
<li>bike trips will stop/start at a better position along the sidewalk now</li>
<li>support parking lanes on the off-side of a one-way</li>
<li>UI: search by building names, commuter patterns shows borders better</li>
<li>transit: make people ride off-map, spawn buses on short roads</li>
<li>internal cleanups for buttons</li>
</ul>
<p>0.2.7</p>
<ul>
<li>many intersections with on/off ramps have much better geometry</li>
<li>lane-changing banned on turn lanes</li>
<li>lots more work matching bus stops/routes to the map. some progress, also some regressions.</li>
<li>fixing spawning on tiny borders</li>
<li>bus spawn rates from GTFS for seattle. started an editor for the schedule.</li>
<li>internal ezgui refactorings</li>
</ul>
<p>0.2.8</p>
<ul>
<li>multiple traffic signals can now be synchronized and edited together</li>
<li>new dashboard for &quot;traffic signal demand&quot; over the entire day and map</li>
<li>started experimenting with controlling the headless runner via a JSON API</li>
<li>epic ezgui fix by Michael to consolidate handling of HiDPI scaling</li>
<li>got a bunch of huge cities importing and loading quickly</li>
<li>you can now save the trips you manually spawn in freeform mode, then replay them later</li>
</ul>
<p>0.2.9</p>
<ul>
<li>import Xi'an, add a Chinese font, and add a tool for that group to import their external demand data</li>
<li>control A/B Street through a graphics-less API, with a Python example</li>
<li>improve UI for per-direction traffic signal demand</li>
<li>on/off ramp geometry fixed in a few more cases</li>
<li>fix some missing parking lot aisles, handle parking lots with 0 spots, and extract parking garages from OSM</li>
<li>switch road/building language in settings, if OSM data exists</li>
<li>congestion capping prototype: declare a max number of vehicles that can pass through a zone per hour, view/edit it, and very simple implementation in the sim layer</li>
<li>add custom-drawn trips to the main scenario, for exploring new demand from a new building</li>
<li>mkirk fixed up the glow/wasm ezgui backends, letting us remove glium</li>
<li>make map edit JSON backwards compatible</li>
<li>better lane/turn markings</li>
</ul>
<p>0.2.10</p>
<ul>
<li>two-way cycletracks and arbitrary direction changes for roads</li>
<li>fix map editing for lane reversals, make edits backwards compatible, and massively speed up applying edits</li>
<li>fleshing out the headless API and tooling for controlling the simulation from any language</li>
<li>import a few more places, redo left-hand driving support so far</li>
<li>various bug/performance fixes</li>
</ul>
<p>0.2.11</p>
<ul>
<li>disabled support for editing the map without resetting the simulation. needs more work, but solid start.</li>
<li>improvements to API, activity model, congestion capping</li>
<li>small UI tweaks for parking, editing multiple signals</li>
<li>fixed last bugs for left-handed driving, should work just as well now</li>
<li>lots of graphics experiments from the hackathon, not merged yet</li>
</ul>
<p>0.2.12</p>
<ul>
<li>new textured color scheme and isometric buildings, in settings</li>
<li>new layer to show how far away people parked</li>
<li>Massive UI overhauls: jump to time/delay, edit mode, traffic signal editor (now with offsets), lane editor, bulk lane edit, traffic signal demand (individual intersections and all), loading screen</li>
<li>the Go API example compares trip times and detects gridlock</li>
<li>infinite parking mode</li>
<li>show how long a car has been parked in one spot</li>
<li>bugfix for some pathfinding costs around uber-turns</li>
<li>start to show a trip's purpose</li>
</ul>
<p>0.2.13</p>
<ul>
<li>alleyways from OSM imported</li>
<li>traffic signal minimum time now constrained by crosswalks; thanks Sam!</li>
<li>UI changes in progress for trip tables, summaries, bulk edit</li>
<li>more API / Python example work for congestion capping</li>
<li>bug fixes: isometric buildings, documentation links, dropdown widgets, turn restrictions</li>
</ul>
<p>0.2.14</p>
<ul>
<li>improve turn generation, with goldenfile tests</li>
<li>UI adjustments: unzoomed routes, better delay layer, include reasons for cancelled trips, throughput layer counts</li>
<li>small map importing fixes: multipolygon parking lots</li>
<li>fix infinite parking and blackholed buildings</li>
</ul>
<p>0.2.15</p>
<ul>
<li>large internal change allowing asynchronously loading extra files over HTTP for web</li>
<li>the release of the first web version!</li>
<li>cars looking for parking now have a &quot;thought bubble&quot; showing this, by Michael</li>
<li>slow sections of a trip are now shown in the info panel, by Sam</li>
<li>fix by Michael for handling window resizing in panels</li>
<li>fix original routes on edited maps</li>
<li>internal code organization and documentation</li>
</ul>
<p>0.2.16</p>
<ul>
<li>UI: click unzoomed agents, switch between metric/imperial units, show reason for cancelled trips, new &quot;faded zoom&quot; color scheme based on mapbox, more detailed agent counts in the top-right panel's tooltips</li>
<li>started a new dedicated OpenStreetMap viewer, will split out from A/B Street later</li>
<li>fix alpha colors on web</li>
<li>bugfixes for the new asynchronous map loading</li>
<li>some substantial simulation performance gains (168s to 90s on one benchmark!)</li>
<li>lots of progress towards editing the map without resetting the simulation to midnight. please test with --live_map_edits and report any issues</li>
<li>internal refactoring and code documentation</li>
</ul>
<p>0.2.17</p>
<ul>
<li>tooling to automatically extract different shapes around cities without an explicit bounding polygon</li>
<li>imported many maps for an OSM viewer demo</li>
<li>misc bug fixes, UI tweaks, and perf improvements, especially for the web version</li>
<li>start using OSM sidewalks data properly in krakow -- more work needed, but better start</li>
</ul>
<p>0.2.18</p>
<ul>
<li>overhaul data/system management: switch from Dropbox to S3, reorganize files, add an in-game updater</li>
<li>started a UI for collision dataviz, with data in the UK and Seattle</li>
<li>improve turns between separate footways</li>
<li>simplify the process of importing a new city</li>
</ul>
<p>0.2.19</p>
<ul>
<li>added experimental day/night support; run with --day_night</li>
<li>slight performance improvements by avoiding applying no-op edits</li>
<li>new tests for lane-changing behavior, used to more safely allow more realistic behavior blocking &quot;degenerate&quot; intersections</li>
<li>experimenting with filling in gaps between one-way roads, to represent medians</li>
</ul>
<p>0.2.20</p>
<ul>
<li>prototyped a new 15-minute neighborhood tool</li>
<li>overhaul internal simulation input code -- better performance, way simpler</li>
<li>debug tool to record traffic around a few intersections and replay later</li>
</ul>
<p>0.2.21</p>
<ul>
<li>split separate tools into their own executables</li>
<li>misc bug fixes and other refactoring, focused on GUI code mostly</li>
<li>most of a prototype done for an experiment</li>
<li>map added for north seattle</li>
</ul>
<p>0.2.22</p>
<ul>
<li>vehicles will lane-change less erratically during uber-turns (sequences of turns through multiple traffic signals close together)</li>
<li>debug mode has a &quot;blocked-by graph&quot; tool to understand dependencies between waiting agents</li>
<li>try multiple OpenGL video mode options if the first choice fails (thanks Michael!)</li>
<li>refactoring trip starting code and the minimap</li>
<li>non-Latin fonts now supported on web too, thanks to rustybuzz release</li>
<li>new small maps in Seattle included in the release, and NYC added to optional cities</li>
<li>saving some player state on the web (mostly camera position per map, for the main game)</li>
<li>partial prototype of a new census-based scenario generator, thanks to help from the Amazon SSPA hackathon</li>
<li>significant progress on the experiment, about one week left...</li>
</ul>
<p>0.2.23</p>
<ul>
<li>released the 15-minute Santa experiment!</li>
<li>trip info panels now show more continuous progress along a route</li>
<li>fixing inactive buttons stretching too much</li>
</ul>
<p>0.2.24</p>
<ul>
<li>variable traffic signal timing, thanks to Bruce</li>
<li>15 min explorer: more walking options (require shoulders, change speed), more organized business search</li>
<li>15 min santa: remember upzoning choices</li>
<li>misc bugfixes and refactoring</li>
<li>2021 roadmap drafted</li>
</ul>
<p>0.2.25</p>
<ul>
<li>huge breakthrough on merging intersections to handle short roads. applied to just a few places so far</li>
<li>support one-way roads with default traffic signal heuristics</li>
<li>15 min explorer: find residences close to user-specified businesses, see unwalkable roads</li>
<li>bugfix from Bruce to prevent sim from crashing when a short road is over capacity</li>
<li>automatically fetch census data for any US map and use for scenario generation, from Michael</li>
<li>some initial experiments to bring A/B Street's lane rendering to the web using Leaflet</li>
</ul>
<p>0.2.26</p>
<ul>
<li>dramatically improve initial web loading and be able to start with any map</li>
<li>city picker UI now better organizes other regions with many maps</li>
<li>new tool to convert SUMO networks into A/B Street maps</li>
<li>taking screenshots of the entire map now much faster, portable. trying to use for Leaflet raster tiles, but not working yet.</li>
<li>widgetry UI library now doesn't depend on anything specific to A/B Street</li>
<li>internal refactoring for error handling</li>
</ul>
<p>0.2.27</p>
<ul>
<li>dramatically speed up starting scenarios by deferring when public transit riders pick their route</li>
<li>start importing separate cyclepaths and pedestrian plazas for Cambridge, many adjustments to make these start working</li>
<li>full panel for picking a scenario to start</li>
<li>import trip data from the actdev project for Cambridge</li>
<li>improve inferred map elements (stop signs and crosswalks) near short roads</li>
<li>heuristics for automatically finding and merging short roads. disabled, but solid start</li>
</ul>
<p>0.2.28</p>
<ul>
<li>massive button overhaul by Yuwen and Michael</li>
<li>the color scheme automatically switches between day/night based on simulation time!</li>
<li>significant progress on editing the map without resetting the simulation</li>
<li>various bugfixes, new maps, improvements to running the importer, faster updater</li>
</ul>
<p>0.2.29</p>
<ul>
<li>new map, Rainier Valley, is the 3rd ever to finish without gridlock! One of the fixes was collapsing traffic circles into a normal intersecton</li>
<li>bugfixes for map importing: cycleways with left-handed driving, matching traffic signals, odd number of lanes, u-turns</li>
<li>further fixes after the great button refactor</li>
</ul>
<p>0.2.30</p>
<ul>
<li>split documentation into a separate git repo</li>
<li>UI: filter throughput layer by mode, render stop signs better</li>
<li>started a debug tool to live-tune routing parameters and see the effects on a single route or all trips</li>
<li>Michael improved the web loading screen and added webgl1 support for ios browsers</li>
<li>cars looking for parking now randomize a bit, eliminating the unrealistic &quot;parking snakes/parades&quot; effect</li>
<li>Bruce fixed a critical bug with uber-turns, helping ease gridlock in some maps</li>
<li>new tool to procedurally generate houses along empty residential roads, useful when OSM is missing most data</li>
</ul>
<p>0.2.31</p>
<ul>
<li>loads of work integrating abstreet with the actdev project, and importing tons of maps</li>
<li>new tool to find the geofabrik OSM source best fitting a boundary</li>
<li>fix crosswalks and traffic signal policies in left-handed driving countries</li>
<li>fix initial zoom when starting with flags to copy the viewport from OSM</li>
<li>Bruce added lagging green signal heuristics</li>
<li>make it easier to click tiny bikes and pedestrians</li>
<li>change the URL in the web version as you change maps/scenarios</li>
<li>split the list of cities by country, and improved the UI for picking a place</li>
</ul>
<p>0.2.32</p>
<ul>
<li>easier to share web URLs with the current viewport</li>
<li>more actdev integration work</li>
<li>misc bugfixes, especially with uber-turns and the city picker UI</li>
<li>revived the map_editor tool for drawing small test maps and iterating faster on merging intersection geometry</li>
</ul>
<p>0.2.33</p>
<ul>
<li>import service roads and separate cyclepaths in all maps!</li>
<li>brand new day theme, designed by Yuwen and implemented by Michael!</li>
<li>improved rendering where sidewalks and shoulders of roads meet</li>
<li>fix overlapping panels on HiDPI screens with low resolution</li>
<li>prototype of loading abst in the background on a webpage</li>
<li>adjusted routing, penalizing unprotected left turns onto bigger roads, which often contribute to gridlock</li>
<li>fixed some turn restrictions at merged intersections</li>
<li>widgetry: change fonts mid-line, dynamically load extra fonts (for a Taipei map)</li>
</ul>
<p>0.2.34</p>
<ul>
<li>new travel demand generator using UK origin/destination data</li>
<li>the 15m and OSM viewer web apps also have nicer URLs now</li>
<li>2 more seattle maps complete without gridlock!</li>
<li>less seattle maps bundled with the release by default, to keep file size sane</li>
<li>many UI changes for the actdev integration, pending rollout to abst generally</li>
<li>initial experiments with implementing lane over-taking and road-based pathfinding</li>
</ul>
<p>0.2.35</p>
<ul>
<li>vast improvements to roundabouts, gridlock, and ordering at stop signs</li>
<li>consolidated UI panels in simulation modes; should work much better for smaller screens</li>
<li>measure intersection delay more intuitively</li>
<li>use straight lines for right/left turns at small intersections</li>
<li>various bugfixes and small UI improvements</li>
<li>started a tool to import from OSM without the command line; should be ready next week</li>
</ul>
<p>0.2.36</p>
<ul>
<li>released a new tool to import anywhere from OSM from within the game!</li>
<li>UI: finished trips meter, consolidated agent counters on minimap, move layers to the left for small screens, new tab style, use new day colorscheme in other apps</li>
<li>fixed a bug with comparing the route somebody took before/after changes</li>
<li>start integrating Eldan's elevation data and reviving parts of the UI that use the data</li>
<li>better routing into/out of access-restricted neighborhoods</li>
</ul>
<p>0.2.37</p>
<ul>
<li>import elevation data for Seattle!</li>
<li>add layers showing steep streets, elevation contours, and show elevation profile for bike/pedestrian routes</li>
<li>faster, simpler pathfinding for access-restricted zones</li>
<li>faster map importer and some UI fixes</li>
</ul>
<p>0.2.38</p>
<ul>
<li>change walking and biking speed based on elevation</li>
<li>import elevation data for all maps -- though there may still be quality issues</li>
<li>filter trip table by start/end location on the map</li>
<li>Michael made the web deployment much more flexible, in preparation for a blog post</li>
</ul>
<p>0.2.39</p>
<ul>
<li>massive internal change to make pathfinding use roads, not lanes. paves the way for many exciting things, like...</li>
<li>changing the number and width of lanes per road! WIP, debug mode-only UI for now</li>
</ul>
<p>0.2.40</p>
<ul>
<li>fix bugs running the importer</li>
<li>import grid2demand scenarios from the UI</li>
<li>implement more of road widening internals</li>
<li>new --minimal_controls option by Michael for screencasts</li>
<li>ran the first UX study in a long time, lots of feedback on the tutorial and traffic signal editor</li>
</ul>
<p>0.2.41</p>
<ul>
<li>first prototype of the new road editor!</li>
<li>much easier way to download new cities -- just try to open a map you don't yet have. much smaller .zip release now</li>
<li>track two &quot;risk exposure&quot; events -- when cars want to overtake cyclists, and passing through a large intersection -- and start to show data on trip panels, a new &quot;problem map&quot; layer, and a WIP summary dashboard</li>
<li>better geometry for some merged intersections, and applying the algorithm all around Tempe</li>
<li>another UX study and some tutorial UX fixes</li>
</ul>
<p>0.2.42</p>
<ul>
<li>improvements to experimental road editor</li>
<li>2 more UX studies and a slew of small fixes</li>
</ul>
<p>0.2.43</p>
<ul>
<li>starting to import GMNS traffic signal timing. this will eventully let us import from Synchro!</li>
<li>more work on the new road editor, but still not ready. lane widths are now more varied and realistic.</li>
<li>Trevor overhauled the OSM amenity categories and added a multi-source isochrone to the 15m tool to find places without access to some amenity</li>
<li>partial work running the map importer in a Docker container, to eventually speed up the import process in the cloud</li>
<li>signal editor UI adjustments</li>
<li>time warp UI fixes and a new risk exposure contingency matrix by Michael</li>
<li>internal code cleanup using clippy, by Vinzent</li>
</ul>
<p>0.2.44</p>
<ul>
<li>experimental road editor finally released! more improvements still planned</li>
<li>save/restore settings (like camera angle and units) between sessions</li>
<li>Michael improved performance of scrolling panels</li>
<li>Michael adding more dataviz to travel time and risk exposure dashboards</li>
<li>regenerating all maps now happens on the cloud -- faster and less harmful to my poor laptop</li>
<li>exploring some debug tools and strategies for consolidating intersections</li>
</ul>
<p>0.2.45</p>
<ul>
<li>map importing fixes: multiple left/right turn lanes, combo bus/turn lanes, tidy up degenerate intersections along cyclepaths, allow explicitly tagged U-turns, better stop sign placement heuristics</li>
<li>in Seattle, snap trips entering/leaving map through borders more carefully</li>
<li>prebake data to cover trips starting near midnight. down from about 3000 cancelled trips in montlake to 300</li>
<li>road editor UI: explain disabled actions</li>
<li>Michael added new &quot;arterial crossing&quot; risk for pedestrians</li>
<li>improved GMNS signal timing importer</li>
</ul>
<p>0.2.46</p>
<ul>
<li>lots of internal writing, presentations... not quite ready for an audience yet</li>
<li>fixed weird turn lane arrows</li>
<li>GMNS signal import now works for many intersections, thanks to crosswalk inference</li>
<li>road editor UI fixes</li>
<li>speed up starting a simulation with infinite parking</li>
<li>possible breakthrough with intersection consolidation</li>
</ul>
<p>0.2.47</p>
<ul>
<li>simulation speedup by storing turns better</li>
<li>new website/docs maybe halfway done</li>
<li>sped up rust build process</li>
<li>improved some geometry around Tempe</li>
<li>fix broken screenshot diff test</li>
<li>trevor added the &quot;cloud of uncertainty&quot; in the 15m tool to show borders</li>
</ul>
<p>0.2.48</p>
<ul>
<li>vehicles will now dynamically change lanes to pass slower traffic! in limited cases only.</li>
<li>vehicles can now exit a building's driveway and immediately cut across a few lanes</li>
<li>new UI tool to easily find when trips start</li>
<li>fix some crashes related to widening roads</li>
</ul>
<p>0.2.49</p>
<ul>
<li>vehicles can exit driveways in either direction!</li>
<li>bugfixes with lane-changing, time-warping, settings, nondeterministic z-ordering, changing speed limits</li>
<li>speed up edit mode on large maps</li>
<li>loading maps on native now sees locally imported maps</li>
<li>smaller files across the board by serializing f64s as integers</li>
<li>map data quality: greenlake cycletrack, better stop sign placement, crosswalks at consolidated intersections</li>
<li>risk exposure matrix labels</li>
<li>keep cars out of bus lanes with better costing</li>
</ul>
<p>0.2.50</p>
<ul>
<li>UI: improve elevation profiles, add road editor revert button, thought bubbles for people climbing steep inclines</li>
<li>fixed signal timing for 3-ways</li>
<li>fixed a race condition with two vehicles going for the same offstreet parking</li>
<li>fixing pedestrian speeds on inclines</li>
<li>improved relative positons of adjacent lanes on curvy roads</li>
<li>internal speedups for map importing and a tool to compare two maps, for intersection consolidation</li>
<li>let lane-changing happen in more cases (when vehicle1 wants to pass vehicle2, but can't until a few lanes later)</li>
<li>add a mode to import a region-wide map without local roads</li>
<li>internal pathfinding refactor to switch between contraction hierarchies &amp; Dijkstra more flexibly, reduce duplicate higher-level input graph logic</li>
</ul>
<p>0.2.51</p>
<ul>
<li>special mid-week release to support a blog post</li>
<li>using infinite parking for the arboretum scenario</li>
<li>add y axis to trip time dashboard</li>
<li>faster OSM import using overpass</li>
<li>internal tools for working on intersection consolidation and cyclepath snapping</li>
</ul>
<p>0.2.52</p>
<ul>
<li>started a mode shift dashboard</li>
<li>individual trips can be explored from the risk exposure dashboards now</li>
<li>fixed actdev scenarios</li>
<li>web file loaders now show progress</li>
<li>performance improvements for editing roads</li>
<li>various bug fixes</li>
</ul>
<p>0.2.53</p>
<ul>
<li>new intersection consolidation algorithm, applied around Seattle and Tempe with really great results!</li>
<li>Seattle fixes: deduplicating cycletracks, connecting Arboretum bike paths</li>
<li>add new lane types to express buffers for protected bike lanes</li>
<li>better neighborhood shapes by Michael, in the commuter patterns layer</li>
<li>fixed Overpass imports, which were missing border intersections</li>
</ul>
<p>0.2.54</p>
<ul>
<li>brand new day mode color scheme!</li>
<li>road editor automatically adjusts lane width, and other small UI fixes</li>
<li>show bike network gaps in the mode shift dashboard</li>
<li>progress on snapping cyclepaths, representing buffers, fixing up nearby geometry</li>
<li>fixed crosswalks for consolidated intersections on left-handed maps</li>
</ul>
<p>0.2.55</p>
<ul>
<li>more progress on cycleway snapping, but still not ready</li>
<li>road editor sets new lane width better</li>
<li>load proposals picks a better order</li>
<li>a new experiment unfolding...</li>
</ul>
<p>0.2.56</p>
<ul>
<li>releasing a new tool dedicated to planning bike networks!</li>
<li>massive overhaul to the road editor, including lane cards that can be both dragged AND dropped</li>
<li>new road labeling in unzoomed mode</li>
<li>new tool to quickly sketch roads to edit</li>
<li>new tool to plan routes and see elevation/road types along the way</li>
<li>load previously saved proposals on web</li>
<li>disabled prototype: uploading proposals to a central server for easier sharing</li>
</ul>
<p>0.2.57</p>
<ul>
<li>bike network tool UI fixes, especially for the routing tool</li>
<li>use drag and drop for traffic signal editor and route waypoints</li>
<li>small internal map model performance boost</li>
<li>heavy documentation week</li>
</ul>
<p>0.2.58</p>
<ul>
<li>dramatically improve time to recalculate pathfinding</li>
<li>deploy raw map editor to web, to support a long-form article: https://a-b-street.github.io/docs/tech/map/geometry/index.html</li>
<li>long-form article about the simulation: https://a-b-street.github.io/docs/tech/trafficsim/discrete_event/index.html</li>
<li>small fixes to ungap route tool</li>
</ul>
<p>0.2.59</p>
<ul>
<li>bike network's route tool: naming saved routes, showing details about the route</li>
<li>switch from s3 to cloudfront CDN; all downloads should be faster</li>
<li>further pathfinding performance improvements</li>
<li>fix bike quick sketch tool in left-handed maps</li>
<li>consolidate tools into a single CLI and include it in the release</li>
</ul>
<p>0.2.60</p>
<ul>
<li>incorporated a configurable mode shift and carbon emissions model with the bike network tool</li>
<li>partially implemented Mara's UX changes to the bike tool</li>
<li>improved UI map importing: no more overwriting, and naming new maps</li>
<li>prototyped a new low-traffic neighborhood / rat-run tool</li>
</ul>
<p>0.2.61</p>
<ul>
<li>bike network tool now shows alternate routes</li>
<li>small fixes to mode shift and LTN tool</li>
<li>major internal UI refactors started</li>
</ul>
<p>0.2.62</p>
<ul>
<li>ungap the map bike network tool launched! bike.abstreet.org has documentation and videos</li>
<li>uploading and sharing proposals now works!</li>
<li>super speedup to applying map edits</li>
</ul>
<p>0.2.63</p>
<ul>
<li>ungap: consolidate editing controls</li>
<li>workaround some bugs loading map edits</li>
<li>ungap: add ability to compare a trip before/after some proposed changes</li>
<li>ungap: make the high-stress metric handle one side of a road missing bike lanes</li>
<li>ungap route sketcher easier to use when zoomed far out</li>
<li>ui fixes: units in barrier type, dropdowns focus-fighting with drag-drop cards</li>
<li>perf: smaller city overview maps</li>
</ul>
<p>0.2.64</p>
<ul>
<li>new algorithms to find and render city block and neighborhoods. almost ready for use in main applications</li>
<li>fixed the worst of curb rendering bugs</li>
<li>new mapbox gl + abstreet demo</li>
<li>adding command-line --help to most programs</li>
</ul>
<p>0.2.65</p>
<ul>
<li>rewrote the low-traffic neighborhood prototype. neighborhood detection much better, internal streets grouped into traffic cells, two rendering styles for cells. browsing rat runs not ready yet, disabled</li>
<li>new shared title screen, to switch easily between all A/B Street apps</li>
</ul>
<p>0.3.0 (major release)</p>
<p>See https://a-b-street.github.io/docs/project/history/retrospective/index.html for a look back on the project so far. I started https://github.com/sponsors/dabreegster to fundraise for a full-time Rust developer.</p>
<ul>
<li>added basic routing to LTN tool</li>
<li>roads with modal filters belong to two traffic cells</li>
<li>progress on LTN rat run detection, but still not ready</li>
<li>new option to use OSM crossing nodes to model unmarked foot crossings</li>
<li>better road label placement</li>
</ul>
<p>0.3.1</p>
<ul>
<li>no right turn at red lights, in most of the world. thanks Marcel!</li>
<li>simplify map importing config</li>
<li>some fixes to OSM crosswalk matching</li>
<li>placing LTN modal filters more intuitively</li>
<li>change level of traffic assumptions in LTN pathfinder. thanks Andrew!</li>
<li>diagonal modal filters for LTNs</li>
</ul>
<p>0.3.2</p>
<ul>
<li>render one-way markings as outlines by Marcel</li>
<li>few fixes, mostly just importing some new places</li>
<li>the project lead has moved to London ;)</li>
</ul>
<p>0.3.3</p>
<ul>
<li>bus routes now imported for Seattle and SF, from GTFS</li>
<li>fix &quot;bowtie&quot; intersection shapes, resulting from incorrect clockwise ordering</li>
<li>few small OSM data fixes for London and Leeds</li>
<li>fix crash when customizing a route in Ungap the Map</li>
</ul>
<p>0.3.4</p>
<ul>
<li>draw custom boundaries for LTNs (but can't yet save the boundaries)</li>
<li>rendering modal filters better when zoomed in</li>
<li>v3 of a rat-run detector, and showing a heatmap of quiet/busy streets</li>
</ul>
<p>0.3.5</p>
<ul>
<li>improved LTN rat-run detection</li>
<li>LTN UI overhaul, expressing 3 modes for per-neighborhood analysis, all of which can edit modal filters</li>
<li>LTN drawing fixes -- including the 4-color theorem to make sure adjacent areas appear distinct</li>
<li>LTN tool now understands roads that're already tagged as car-free in OSM</li>
<li>LTN tool can adjust boundaries a bit more precisely, but this still half-broken</li>
<li>Marcel overhauled walking turns, letting them be bidirectional and switching to a simpler implementation of crosswalk generation</li>
<li>Marcel improved the geometry of all turns</li>
<li>fix downloading maps in the Windows version</li>
</ul>
<p>0.3.6</p>
<ul>
<li>bugfixes for partitioning space into blocks, which helps the LTN tool</li>
</ul>
<p>0.3.7</p>
<ul>
<li>experimenting with a few heuristics for automatically placing modal filters</li>
<li>improved rendering in the &quot;browse neighborhoods&quot; screen: show all filters, emphasize boundary roads, optionally show cell connectivity, and optionally show how &quot;good&quot; the neighborhood is</li>
<li>draw disconnected cells more loudly</li>
<li>fix bug introduced recently that broke listing files (especially newly imported maps)</li>
<li>add an &quot;undo&quot; button for the LTN tool</li>
<li>export all LTN data to GeoJSON -- the cell polygons are slow to produce, and buggy, though</li>
<li>start ranking neighborhoods by how many streets with through-traffic exist</li>
<li>make the &quot;adjust boundary&quot; UI mostly work now -- individual blocks are transferred between neighborhoods properly in most cases</li>
</ul>
<p>0.3.8</p>
<ul>
<li>sped up initial loading of the LTN tool on web by splitting it from the main A/B Street binary</li>
<li>LTN UX: preserve dropdown settings and saved routes</li>
<li>draw LTN cells as proper polygons, always clipped to the neighborhood boundary (instead of a grid)</li>
<li>support LTN GeoJSON export in web</li>
<li>prototyped an impact prediction for LTN schemes by comparing per-road volumes using a demand model. Not working yet.</li>
</ul>
<p>0.3.9</p>
<ul>
<li>LTN boundary selection can now split neighborhoods in most ways</li>
<li>allow UK scenarios to be generated with one-shot imports</li>
<li>fix pedestrian rendering crash that happened in some maps</li>
<li>fix how cycle-and-foot-only roads are drawn unzoomed</li>
<li>make LTN impact prediction tool stop running out of video memory</li>
<li>internal refactoring to separate Scenario stuff from rest of simulation code</li>
</ul>
<p>0.3.10</p>
<ul>
<li>save/load LTN proposals as local files only</li>
<li>improve LTN block tracing near railroads and bridges/tunnels, fixing many overlapping areas</li>
<li>LTN UI: draw cell &amp; neighborhood areas beneath roads, add road name search tool everywhere</li>
<li>make modal filters visible even at very low zoom levels</li>
<li>extend the quietness view and automatic filter heuristics to the entire map</li>
<li>improve the travel demand model for UK data by handling desire lines starting/ending off-map</li>
</ul>
<p>0.3.11</p>
<ul>
<li>detect existing modal filters in OSM</li>
<li>import Melbourne and most London boroughs</li>
<li>simplify road center-lines after merging roads</li>
<li>improve my workflow for regenerating all maps locally in parallel</li>
<li>save LTN proposals in web browsers to local storage</li>
<li>some small LTN UI fixes</li>
</ul>
<p>0.3.12</p>
<ul>
<li>fix various crashes relating to geometry and edits near public transit</li>
<li>internal refactoring to make the map_editor debugging tool build much faster</li>
<li>improved geometry near dog-leg intersections in some maps</li>
</ul>
<p>0.3.13</p>
<ul>
<li>swap between multiple LTN proposals easily</li>
<li>LTN boundary selection is now faster, has simpler colors, has a freehand lasso tool, and includes blocks near roads without sidewalks</li>
<li>quickly create multiple modal filters by freehand drawing</li>
<li>core geometry fixes: remedy some lane center lines that explode at sharp angles</li>
<li>upgrade window management dependencies; if you experience new problems, please report</li>
</ul>
<p>0.3.14</p>
<ul>
<li>overhaul the rat-run mode: tighten up things counting as shortcuts, keep the same path after adding a filter</li>
<li>change the LTN route planning tool to be map-wide, not per-neighborhood</li>
<li>place filters at non 4-way intersections</li>
<li>shrink some cases of overlapping roads, improving geometry when OSM data is not great</li>
<li>a first round of simplifying LTN panels</li>
<li>when the LTN blockfinding would've crashed previously, just fallback to using more expensive blockfinding</li>
<li>bugfix: detect existing filters on really short roads</li>
<li>fix initial camera placement outside of the main A/B Street app</li>
</ul>
<p>0.3.15</p>
<ul>
<li>re-import the current map from fresh OSM data (native only)</li>
<li>adjust LTN panels</li>
</ul>
<p>0.3.16</p>
<ul>
<li>show rat-runs on the connectivity tab; understand both detours and cells as you place filters</li>
<li>merge blocks with different winding orders</li>
<li>better behavior when switching proposals on the rat-run tab</li>
<li>new automatic filter heuristic inspired by min cut</li>
<li>adjust LTN color scheme, de-emphasizing buildings</li>
<li>simplify LTN UI, hiding advanced controls</li>
</ul>
<p>0.3.17</p>
<ul>
<li>show biking and walking directions too in the LTN tool</li>
<li>add help and info buttons to the LTN tool</li>
<li>show area of neighborhoods</li>
</ul>
<p>0.3.18</p>
<ul>
<li>fix major bug where pathfinding after map edits was broken</li>
<li>make the LTN impact tool show results more reasonably</li>
</ul>
<p>0.3.19</p>
<ul>
<li>breaking change: saved LTN proposals have a new format. Please contact me if you need to fix any previously saved files.</li>
<li>starting to revive public transit support a bit, simplifying how many times pathfinding happens</li>
<li>adjust LTN filter drawing style and allow toggling filters on &quot;degenerate&quot; intersections</li>
<li>fix a rare simulation crash involving a vehicle exiting driveways off-side</li>
<li>slow down pedestrians walking on crowded sidewalks, and track where this problem happens</li>
<li>thanks to Michael, Mac binaries are now signed!</li>
</ul>
<p>0.3.20</p>
<ul>
<li>you can now edit crosswalks!</li>
<li>more realistic behavior of pedestrians at stop signs -- they won't endlessly swarm and cut off vehicles</li>
<li>show a popup when the web browser version crashes</li>
<li>change metric/imperial settings automatically based on the map loaded</li>
<li>update Seattle OSM data (first time in over 6 months)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="references"><a class="header" href="#references">References</a></h1>
<h2 id="example-use-cases"><a class="header" href="#example-use-cases">Example use cases</a></h2>
<ul>
<li><a href="https://www.reddit.com/r/SeattleWA/comments/9mtgkh/seven_places_to_add_bus_lanes_now/">https://www.reddit.com/r/SeattleWA/comments/9mtgkh/seven_places_to_add_bus_lanes_now/</a></li>
<li><a href="https://www.reddit.com/r/SeattleWA/comments/9oqkz9/how_traffic_patterns_will_change_after_seattles/">https://www.reddit.com/r/SeattleWA/comments/9oqkz9/how_traffic_patterns_will_change_after_seattles/</a></li>
<li><a href="https://www.reddit.com/r/Seattle/comments/9orqne/4_fresh_ideas_to_ease_seattles_coming_traffic/">https://www.reddit.com/r/Seattle/comments/9orqne/4_fresh_ideas_to_ease_seattles_coming_traffic/</a></li>
<li><a href="https://www.reddit.com/r/SeattleWA/comments/cr1r1l/why_the_fuck_does_the_right_lane_convert_to/">https://www.reddit.com/r/SeattleWA/comments/cr1r1l/why_the_fuck_does_the_right_lane_convert_to/</a></li>
<li><a href="https://twitter.com/transitrunner/status/1175068582142599168">https://twitter.com/transitrunner/status/1175068582142599168</a></li>
</ul>
<h2 id="groups-that-may-be-eventually-interested"><a class="header" href="#groups-that-may-be-eventually-interested">Groups that may be eventually interested</a></h2>
<ul>
<li>Seattle Times Traffic Lab</li>
<li><a href="https://www.citylab.com/transportation/2018/08/is-it-time-to-rethink-what-a-bike-lane-is/568483/">https://www.citylab.com/transportation/2018/08/is-it-time-to-rethink-what-a-bike-lane-is/568483/</a></li>
<li><a href="http://openseattle.org/">http://openseattle.org/</a></li>
<li><a href="https://igniteseattle.com/">https://igniteseattle.com/</a></li>
<li><a href="http://seattlegreenways.org/">http://seattlegreenways.org/</a></li>
<li><a href="https://www.livablecities.org/">https://www.livablecities.org/</a></li>
<li><a href="https://www.reddit.com/r/openstreetmap/comments/a39uv0/ok_so/">https://www.reddit.com/r/openstreetmap/comments/a39uv0/ok_so/</a></li>
<li><a href="https://mic.comotion.uw.edu/">https://mic.comotion.uw.edu/</a></li>
<li><a href="https://www.seattleinprogress.com/">https://www.seattleinprogress.com/</a></li>
<li><a href="http://www.seattle.gov/seattle-pedestrian-advisory-board">http://www.seattle.gov/seattle-pedestrian-advisory-board</a></li>
<li>Socrata</li>
<li><a href="http://transportationcamp.org/">http://transportationcamp.org/</a></li>
<li><a href="https://www.seattle.gov/transportation/projects-and-programs/programs/neighborhood-street-fund">https://www.seattle.gov/transportation/projects-and-programs/programs/neighborhood-street-fund</a></li>
<li><a href="https://www.seattle.gov/neighborhoods/programs-and-services/your-voice-your-choice">https://www.seattle.gov/neighborhoods/programs-and-services/your-voice-your-choice</a></li>
<li><a href="https://commuteseattle.com/">https://commuteseattle.com/</a></li>
<li><a href="https://www.theurbanist.org/">https://www.theurbanist.org/</a></li>
<li><a href="https://humantransit.org/2019/03/notes-on-simcity-at-30.html">https://humantransit.org/2019/03/notes-on-simcity-at-30.html</a></li>
<li><a href="https://mynorthwest.com/category/chokepoints/">https://mynorthwest.com/category/chokepoints/</a></li>
<li><a href="https://blogs.uw.edu/ceadvice/2019/05/08/infrastructure-week-2019-welcome-uw-cee-students-and-faculty/">https://blogs.uw.edu/ceadvice/2019/05/08/infrastructure-week-2019-welcome-uw-cee-students-and-faculty/</a></li>
<li><a href="https://escience.washington.edu/dssg/">https://escience.washington.edu/dssg/</a></li>
<li>josie kresner from transport foundry</li>
<li><a href="https://www.citylab.com/transportation/2019/08/city-planning-transportation-oakland-community-engagement/596050/">https://www.citylab.com/transportation/2019/08/city-planning-transportation-oakland-community-engagement/596050/</a>
<ul>
<li>tweeting small problems -&gt; bug tracker</li>
</ul>
</li>
<li><a href="https://www.the74million.org/article/building-a-smarter-and-cheaper-school-bus-system-how-a-boston-mit-partnership-led-to-new-routes-that-are-20-more-efficient-use-400-fewer-buses-save-5-million/">https://www.the74million.org/article/building-a-smarter-and-cheaper-school-bus-system-how-a-boston-mit-partnership-led-to-new-routes-that-are-20-more-efficient-use-400-fewer-buses-save-5-million/</a></li>
<li><a href="https://www.citylab.com/perspective/2019/10/micromobility-urban-design-car-free-infrastruture-futurama/600163/">https://www.citylab.com/perspective/2019/10/micromobility-urban-design-car-free-infrastruture-futurama/600163/</a></li>
<li><a href="https://www.sanjorn.com/">https://www.sanjorn.com/</a></li>
<li><a href="https://ui.kpf.com/">https://ui.kpf.com/</a></li>
</ul>
<h2 id="similar-projects"><a class="header" href="#similar-projects">Similar projects</a></h2>
<ul>
<li>Urban Footprint (<a href="https://news.ycombinator.com/item?id=17895739">https://news.ycombinator.com/item?id=17895739</a>)</li>
</ul>
<h2 id="seattle-specific"><a class="header" href="#seattle-specific">Seattle-specific</a></h2>
<p>SDOT asking for feedback:</p>
<ul>
<li><a href="http://sdotblog.seattle.gov/2017/02/08/from-signals-to-signs/">http://sdotblog.seattle.gov/2017/02/08/from-signals-to-signs/</a></li>
<li><a href="https://www.seattle.gov/transportation/projects-and-programs/programs/bike-program/protected-bike-lanes/n-34th-st-mobility-improvements">https://www.seattle.gov/transportation/projects-and-programs/programs/bike-program/protected-bike-lanes/n-34th-st-mobility-improvements</a></li>
<li><a href="https://www.seattle.gov/transportation/projects-and-programs/programs/transportation-planning/north-downtown-mobility-action-plan">https://www.seattle.gov/transportation/projects-and-programs/programs/transportation-planning/north-downtown-mobility-action-plan</a></li>
<li><a href="https://www.seattlebikeblog.com/2016/12/01/check-out-seattles-12-winning-neighborhood-led-transportation-ideas/">https://www.seattlebikeblog.com/2016/12/01/check-out-seattles-12-winning-neighborhood-led-transportation-ideas/</a></li>
</ul>
<p>Seattlites with opinions and ideas:</p>
<ul>
<li>
<p><a href="http://seattlegreenways.org/">http://seattlegreenways.org/</a></p>
</li>
<li>
<p><a href="https://www.seattlebikeblog.com/2018/01/19/a-roosevelt-junior-redesigned-the-streets-around-his-high-school-and-his-plan-is-better-than-sdots/">https://www.seattlebikeblog.com/2018/01/19/a-roosevelt-junior-redesigned-the-streets-around-his-high-school-and-his-plan-is-better-than-sdots/</a></p>
</li>
<li>
<p><a href="https://www.reddit.com/r/SeattleWA/comments/5rvss5/what_changes_would_you_make_to_seattles_bus/">https://www.reddit.com/r/SeattleWA/comments/5rvss5/what_changes_would_you_make_to_seattles_bus/</a></p>
</li>
<li>
<p><a href="https://www.seattletimes.com/seattle-news/transportation/congestion-tolling-could-finally-break-seattles-working-poor-heres-a-better-idea/">https://www.seattletimes.com/seattle-news/transportation/congestion-tolling-could-finally-break-seattles-working-poor-heres-a-better-idea/</a></p>
</li>
<li>
<p><a href="https://www.reddit.com/r/SeattleWA/comments/86g3p9/id_get_back_an_hour_and_a_half_a_week/">https://www.reddit.com/r/SeattleWA/comments/86g3p9/id_get_back_an_hour_and_a_half_a_week/</a></p>
</li>
<li>
<p><a href="https://www.reddit.com/r/Seattle/comments/4z3ewl/what_are_seattles_worst_intersections/">https://www.reddit.com/r/Seattle/comments/4z3ewl/what_are_seattles_worst_intersections/</a></p>
</li>
<li>
<p><a href="https://www.reddit.com/r/SeattleWA/comments/83h4ri/the_intersection_at_john_and_broadway_desperately/">https://www.reddit.com/r/SeattleWA/comments/83h4ri/the_intersection_at_john_and_broadway_desperately/</a></p>
</li>
<li>
<p><a href="http://www.seattle.gov/transportation/sdot-document-library/citywide-plans/move-seattle">http://www.seattle.gov/transportation/sdot-document-library/citywide-plans/move-seattle</a></p>
</li>
</ul>
<h2 id="other-projects"><a class="header" href="#other-projects">Other projects</a></h2>
<ul>
<li><a href="https://github.com/uwescience/TrafficCruising-DSSG2017">https://github.com/uwescience/TrafficCruising-DSSG2017</a></li>
<li><a href="http://sharedstreets.io/">http://sharedstreets.io/</a></li>
<li><a href="https://github.com/twpol/osm-tiles">https://github.com/twpol/osm-tiles</a> attempting to infer nice road geometry
too</li>
</ul>
<h2 id="notes-from-related-work"><a class="header" href="#notes-from-related-work">Notes from related work</a></h2>
<h3 id="smarts-httpspeopleengunimelbeduauetanintist17pdf"><a class="header" href="#smarts-httpspeopleengunimelbeduauetanintist17pdf">SMARTS (<a href="https://people.eng.unimelb.edu.au/etanin/tist17.pdf">https://people.eng.unimelb.edu.au/etanin/tist17.pdf</a>)</a></h3>
<ul>
<li>Split map into sections, simulate in parallel, load-balance</li>
<li>has an IDM equation</li>
<li>tests against real TomTom data of average speed per link</li>
</ul>
<h3 id="games"><a class="header" href="#games">Games</a></h3>
<p>SimCity, Cities: Skylines
<a href="https://steamcommunity.com/sharedfiles/filedetails/?id=583429740">https://steamcommunity.com/sharedfiles/filedetails/?id=583429740</a>
<a href="https://github.com/fegennari/3DWorld">https://github.com/fegennari/3DWorld</a></p>
<h3 id="open-source-urban-planning"><a class="header" href="#open-source-urban-planning">Open source urban planning</a></h3>
<p>UrbanSim</p>
<h3 id="proprietary"><a class="header" href="#proprietary">Proprietary</a></h3>
<p>Sidewalk Labs Model</p>
<h3 id="maps-for-people"><a class="header" href="#maps-for-people">Maps for people</a></h3>
<p><a href="https://arxiv.org/pdf/1811.01147.pdf">https://arxiv.org/pdf/1811.01147.pdf</a></p>
<h3 id="gammacsunceduroadnetworkwilkie_tvcgpdf"><a class="header" href="#gammacsunceduroadnetworkwilkie_tvcgpdf">gamma.cs.unc.edu/RoadNetwork/wilkie_TVCG.pdf</a></h3>
<p>section 6.3 talks about offset polylines <a href="http://gamma.cs.unc.edu/RoadNetwork">http://gamma.cs.unc.edu/RoadNetwork</a></p>
<h3 id="citybound"><a class="header" href="#citybound">CityBound</a></h3>
<p><a href="https://github.com/aeickhoff/descartes">https://github.com/aeickhoff/descartes</a></p>
<h3 id="discrete-event-simulation-papers"><a class="header" href="#discrete-event-simulation-papers">Discrete Event Simulation papers</a></h3>
<ul>
<li>
<p>section 5.1 of Advanced tutorial on microscopic discrete-event traffic
simulation refers to some DES systems</p>
<ul>
<li>Florian, Mahut, and Tremblay 2008</li>
<li>Sumaryo, Halim, and Ramli 2013</li>
<li>Salimifard and Ansari 2013</li>
<li>Burghout, Koutsopoulos, and Andreasson 2006</li>
<li>Thulasidasan, Kasiviswanathan, Eidenbenz, Galli, Mniszewski, and Romero 2009</li>
</ul>
</li>
<li>
<p>A Dynamic Traffic Assignment Model for Highly Congested Urban Networks</p>
<ul>
<li>section 2.2 models lanes as a moving and queueing part, references other
possibly useful papers</li>
<li>dont worry about multiple lanes for the moving part, just the turn queues at
the end</li>
</ul>
</li>
</ul>
<h2 id="tactical-urbanism"><a class="header" href="#tactical-urbanism">Tactical urbanism</a></h2>
<ul>
<li><a href="https://www.vice.com/en_us/article/pajgyz/rogue-coder-turned-a-parking-spot-into-a-coworking-space">https://www.vice.com/en_us/article/pajgyz/rogue-coder-turned-a-parking-spot-into-a-coworking-space</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="presentations"><a class="header" href="#presentations">Presentations</a></h1>
<p>Most recent first.</p>
<ul>
<li>March 2022: AI:UK workshop on low-traffic neighborhoods
<ul>
<li><a href="https://dabreegster.github.io/talks/aiuk_ltn/slides.html">Slides</a>,
<a href="https://youtu.be/P97F_7_A-Qg?t=64">video of spotlight talk</a>, video of
longer workshop coming eventually</li>
</ul>
</li>
<li>March 2022: The abridged and entirely truthful story of A/B Street (Geomob)
<ul>
<li><a href="https://docs.google.com/presentation/d/1rq0aegKmpt6uI-oieQW5BXQ-vqQji3S48m-pLJ8kGnI/edit?usp=sharing">Slides</a>,
<a href="https://www.youtube.com/watch?v=4Tg3Fc2J3MI&amp;t=1356s">video</a></li>
</ul>
</li>
<li>March 2022: FOSSGIS session on better geometric representation in OSM
<ul>
<li><a href="https://dabreegster.github.io/talks/map_model_v2/slides.html">Slides</a>,
<a href="https://files.fossgis.de/Konferenz/OSM-Event/highway_1120_Micromapping_OSM_data_model.intro.mp4">video</a></li>
</ul>
</li>
<li>March 2022: FOSSGIS session on osm2lanes
<ul>
<li><a href="https://dabreegster.github.io/talks/osm2lanes/slides.html">Slides</a>,
<a href="https://files.fossgis.de/Konferenz/OSM-Event/highway_1020_osm2lanes.intro.mp4">video</a></li>
</ul>
</li>
<li>March 2022: Leeds Transport Data Science seminar on travel demand modeling
<ul>
<li><a href="https://dabreegster.github.io/talks/tds_seminar_synthpop/slides.html">Slides</a>,
<a href="https://www.youtube.com/watch?v=vUJJJ_MD2CM">video</a></li>
</ul>
</li>
<li>February 2022:
<a href="https://docs.google.com/presentation/d/1hcaRL7guN4vnP7--Y5e92kC4GwXe7LyI1HdNSp3e9Tc/edit?usp=sharing">OpenTransportMeetup slides</a></li>
<li>January 2022: <a href="https://thegeomob.com/podcast/episode-113">Geomob podcast</a></li>
<li>January 2022: An open source transportation planning platform (for the U-Shift
lab)
<ul>
<li><a href="https://docs.google.com/presentation/d/1kyh5dZxjZIrFf4N6rk48jMcdxXIpDraRv-A0MsEd_48/edit?usp=sharing">Slides</a></li>
</ul>
</li>
<li>December 2021:
<a href="https://www.youtube.com/watch?v=d-8u5ONfie4">Lightning talk at ATI's Towards Urban Analytics 2.0</a></li>
<li>December 2021: A/B Street in the UK
<ul>
<li><a href="https://docs.google.com/presentation/d/1D-f1qjc1f_2vTs12ilIIZjoNJlgO0t3sYFRc9D2OCSk/edit?usp=sharing">Slides</a></li>
</ul>
</li>
<li>November 2021: <a href="https://youtu.be/S1h2EYSmNpo?t=2156">Ideas with Beers</a></li>
<li>October 2021:
<a href="https://presidential-hackathon.taiwan.gov.tw/en/international-track/">Taiwan presidential hackathon</a>
<ul>
<li><a href="https://docs.google.com/presentation/d/1SOnd1D-Y96YZynFjHMPUe6boFZ9YNIBl0WWfwAZ2jGc/edit?usp=sharing">Slides</a></li>
<li><a href="https://youtu.be/x--ULeDbeOc">Video</a></li>
</ul>
</li>
<li>October 2021:
<a href="https://callforpapers.2021.foss4g.org/foss4g2021/talk/CA8M8U/">FOSS4G</a>
<ul>
<li><a href="https://docs.google.com/presentation/d/1EkQNWc0c-UKoz1hbefMoz4KIxgsIE5YJ_B-KnLQFglQ/edit?usp=sharing">Slides</a></li>
<li><a href="https://www.youtube.com/watch?v=CrEDggzKxt0">Video</a></li>
</ul>
</li>
<li>September 2021:
<a href="https://www.eclipse.org/sumo/conference/">SUMO user conference</a>
<ul>
<li><a href="https://docs.google.com/presentation/d/1_xaR0LQCkZVhcxIep1YgzWm18NVxhGwZVHh-tNfDpjY/edit?usp=sharing">Slides</a></li>
</ul>
</li>
<li>August 2021: <a href="https://www.youtube.com/watch?v=nNYroA16JEQ">Actdev promo video</a></li>
<li>July 2021: State of the Map 2021, Using OSM for transportation advocacy
<ul>
<li><a href="https://docs.google.com/presentation/d/1glV5DTq2M-XMHOwiNyAmQ6LeeyaKynOHRA-XoU02qYk/edit?usp=sharing">Slides</a></li>
<li><a href="https://www.youtube.com/watch?v=27uxMlF8th8">Video</a></li>
</ul>
</li>
<li>June 2021: Smart Planning, Digital Twins, &amp; Open Data
<ul>
<li><a href="https://docs.google.com/presentation/d/1Tt6oentuh_q-WpIC8auX67HBocpTj7ywnKZN-x6Ny8w/edit?usp=sharing">Slides</a></li>
<li><a href="https://www.dropbox.com/s/ywsshog7vbdkf9x/TOMNETWebinar_060721.mp4?dl=0">Video</a></li>
<li>Talk given for
<a href="https://tomnet-utc.engineering.asu.edu/seminars/spring-2021-seminars/">Arizona State University TOMNET</a></li>
</ul>
</li>
<li>April 2021:
<a href="https://www.fsutmsonline.net/index.php?/user_groups/comments/southeast_florida_fsutms_users_group_meeting_april_16_2021">FSUTMS talk</a>
<ul>
<li><a href="https://docs.google.com/presentation/d/1YpqE3NpQYZmSePbALMK5PWoP7jD3cah_X8Jtcy4gtpo/edit?usp=sharing">Slides</a></li>
<li><a href="https://www.fsutmsonline.net/images/uploads/southeastfloridafsutms/SEFL_FSUTMS_UG_04_16_2021.mp4">Video</a></li>
</ul>
</li>
<li>February 2021: Transport Data Science guest lecture
<ul>
<li><a href="https://docs.google.com/presentation/d/1wFgkbyVhsa93FxmDsWuMQ6nXPJbHiZDllQ59xGXcKyg/edit?usp=sharing">Slides</a></li>
</ul>
</li>
<li>October 2020: OSM Connect 2020
<ul>
<li><a href="https://docs.google.com/presentation/d/1ZudGSXlbOL6xdVZXhAcKJvFaLEgeRkgFIX4pbVKSvLQ/edit?usp=sharing">Slides</a></li>
<li><a href="https://www.youtube.com/watch?v=JUN5GWfb4Qo">Video</a></li>
</ul>
</li>
<li>July 2020:
<a href="https://bikesiliconvalley.org/2020/07/poster_dustin-carlino/">Silicon Valley Bike Coalition summit</a></li>
<li><a href="https://youtu.be/P12N51qI5Cs?t=1469">March 2021 ActDev workshop</a></li>
<li>April 2020 Seattle Rust meetup
<ul>
<li><a href="https://www.youtube.com/watch?v=chYd5I-5oyc">Video</a></li>
<li><a href="https://docs.google.com/presentation/d/1nUodhr42eppB2E2eMAnuTkMhIVuHnN7_6i6V6MA028c/edit?usp=sharing">Slides</a></li>
</ul>
</li>
<li><a href="https://docs.google.com/presentation/d/181so6bWkGsPzpc-mI72CQffthMKMVzFPAkYxIyzgfAs/edit?usp=sharing">Feb 2020 traffic sim</a></li>
<li><a href="https://docs.google.com/presentation/d/1PJRFoXmJAyenkqHIwo48zxqu1LSH6pc7XKSzhyC1raw/edit?usp=sharing">Oct 2019 Traffic sim and current challenges</a></li>
<li><a href="https://docs.google.com/presentation/d/1cF7qFtjAzkXL_r62CjxBvgQnLvuQ9I2WTE2iX_5tMCY/edit?usp=sharing">Oct 2019 Map construction</a></li>
</ul>
<h2 id="minor-talksdemos"><a class="header" href="#minor-talksdemos">Minor talks/demos</a></h2>
<ul>
<li>May 2021: Open:Data:Night for Open Manchester
<ul>
<li><a href="https://vimeo.com/557955717">Video</a></li>
</ul>
</li>
<li>January 2021: TRB Network Models in Practice
<ul>
<li><a href="https://docs.google.com/presentation/d/1-yC_WsdHN5RjmEvdN1wpa8Pdy-BJIZGhyV_dPYbaxyI/edit?usp=sharing">Slides</a></li>
</ul>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
