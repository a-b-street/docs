<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>A/B Street</title>
                <meta name="robots" content="noindex" />
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Homepage</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="software/index.html"><strong aria-hidden="true">2.</strong> Software</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="software/abstreet.html"><strong aria-hidden="true">2.1.</strong> A/B Street</a></li><li class="chapter-item expanded "><a href="software/fifteen_min.html"><strong aria-hidden="true">2.2.</strong> 15-minute neighborhoods explorer</a></li><li class="chapter-item expanded "><a href="software/santa.html"><strong aria-hidden="true">2.3.</strong> 15-minute Santa</a></li><li class="chapter-item expanded "><a href="software/osm_viewer.html"><strong aria-hidden="true">2.4.</strong> OpenStreetMap viewer</a></li><li class="chapter-item expanded "><a href="software/parking_mapper.html"><strong aria-hidden="true">2.5.</strong> Mapping on-street parking</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="user/index.html"><strong aria-hidden="true">3.</strong> User guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="user/new_city.html"><strong aria-hidden="true">3.1.</strong> Importing a new city</a></li><li class="chapter-item expanded "><a href="user/asu.html"><strong aria-hidden="true">3.2.</strong> ASU Lab guide</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="proposals/index.html"><strong aria-hidden="true">4.</strong> Proposals</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="proposals/lake_wash.html"><strong aria-hidden="true">4.1.</strong> Lake Washington Blvd Stay Healthy Street</a></li><li class="chapter-item expanded "><a href="proposals/broadmoor.html"><strong aria-hidden="true">4.2.</strong> Allow bike and foot traffic through Broadmoor</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="tech/index.html"><strong aria-hidden="true">5.</strong> Technical details</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tech/dev/index.html"><strong aria-hidden="true">5.1.</strong> Developer guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tech/dev/misc_tricks.html"><strong aria-hidden="true">5.1.1.</strong> Misc developer tricks</a></li><li class="chapter-item expanded "><a href="tech/dev/api.html"><strong aria-hidden="true">5.1.2.</strong> API</a></li><li class="chapter-item expanded "><a href="tech/dev/testing.html"><strong aria-hidden="true">5.1.3.</strong> Testing</a></li><li class="chapter-item expanded "><a href="tech/dev/mass_import.html"><strong aria-hidden="true">5.1.4.</strong> Importing many maps</a></li><li class="chapter-item expanded "><a href="tech/dev/data.html"><strong aria-hidden="true">5.1.5.</strong> Data organization</a></li><li class="chapter-item expanded "><a href="tech/dev/release.html"><strong aria-hidden="true">5.1.6.</strong> Release process</a></li><li class="chapter-item expanded "><a href="tech/dev/formats/index.html"><strong aria-hidden="true">5.1.7.</strong> Data formats</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tech/dev/formats/scenarios.html"><strong aria-hidden="true">5.1.7.1.</strong> Scenarios</a></li><li class="chapter-item expanded "><a href="tech/dev/formats/traffic_signals.html"><strong aria-hidden="true">5.1.7.2.</strong> Traffic signals</a></li></ol></li><li class="chapter-item expanded "><a href="tech/dev/ui.html"><strong aria-hidden="true">5.1.8.</strong> UI</a></li></ol></li><li class="chapter-item expanded "><a href="tech/map/index.html"><strong aria-hidden="true">5.2.</strong> Map model</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tech/map/geometry/index.html"><strong aria-hidden="true">5.2.1.</strong> Intersection geometry</a></li><li class="chapter-item expanded "><a href="tech/map/details.html"><strong aria-hidden="true">5.2.2.</strong> Details</a></li><li class="chapter-item expanded "><a href="tech/map/importing/index.html"><strong aria-hidden="true">5.2.3.</strong> Importing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tech/map/importing/convert_osm.html"><strong aria-hidden="true">5.2.3.1.</strong> convert_osm</a></li><li class="chapter-item expanded "><a href="tech/map/importing/geometry.html"><strong aria-hidden="true">5.2.3.2.</strong> Road/intersection geometry</a></li><li class="chapter-item expanded "><a href="tech/map/importing/rest.html"><strong aria-hidden="true">5.2.3.3.</strong> The rest</a></li><li class="chapter-item expanded "><a href="tech/map/importing/misc.html"><strong aria-hidden="true">5.2.3.4.</strong> Misc</a></li></ol></li><li class="chapter-item expanded "><a href="tech/map/edits.html"><strong aria-hidden="true">5.2.4.</strong> Live edits</a></li><li class="chapter-item expanded "><a href="tech/map/platform.html"><strong aria-hidden="true">5.2.5.</strong> Exporting</a></li></ol></li><li class="chapter-item expanded "><a href="tech/trafficsim/index.html"><strong aria-hidden="true">5.3.</strong> Traffic simulation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tech/trafficsim/discrete_event/index.html"><strong aria-hidden="true">5.3.1.</strong> Discrete event simulation</a></li><li class="chapter-item expanded "><a href="tech/trafficsim/travel_demand.html"><strong aria-hidden="true">5.3.2.</strong> Travel demand</a></li><li class="chapter-item expanded "><a href="tech/trafficsim/gridlock.html"><strong aria-hidden="true">5.3.3.</strong> Gridlock</a></li><li class="chapter-item expanded "><a href="tech/trafficsim/trips.html"><strong aria-hidden="true">5.3.4.</strong> Multi-modal trips</a></li><li class="chapter-item expanded "><a href="tech/trafficsim/live_edits.html"><strong aria-hidden="true">5.3.5.</strong> Live edits</a></li><li class="chapter-item expanded "><a href="tech/trafficsim/parking.html"><strong aria-hidden="true">5.3.6.</strong> Parking</a></li><li class="spacer"></li></ol></li></ol></li><li class="chapter-item expanded "><a href="project/index.html"><strong aria-hidden="true">6.</strong> Project</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="project/team.html"><strong aria-hidden="true">6.1.</strong> Team</a></li><li class="chapter-item expanded "><a href="project/contributing.html"><strong aria-hidden="true">6.2.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="project/funding.html"><strong aria-hidden="true">6.3.</strong> Funding</a></li><li class="chapter-item expanded "><a href="project/hiring.html"><strong aria-hidden="true">6.4.</strong> Hiring</a></li><li class="chapter-item expanded "><a href="project/roadmap.html"><strong aria-hidden="true">6.5.</strong> Roadmap</a></li><li class="chapter-item expanded "><a href="project/motivations.html"><strong aria-hidden="true">6.6.</strong> Motivations</a></li><li class="chapter-item expanded "><a href="project/history/index.html"><strong aria-hidden="true">6.7.</strong> History</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="project/history/backstory.html"><strong aria-hidden="true">6.7.1.</strong> Backstory</a></li><li class="chapter-item expanded "><a href="project/history/year1.html"><strong aria-hidden="true">6.7.2.</strong> Year 1</a></li><li class="chapter-item expanded "><a href="project/history/year2.html"><strong aria-hidden="true">6.7.3.</strong> Year 2</a></li><li class="chapter-item expanded "><a href="project/history/year3.html"><strong aria-hidden="true">6.7.4.</strong> Year 3</a></li></ol></li><li class="chapter-item expanded "><a href="project/retrospective/index.html"><strong aria-hidden="true">6.8.</strong> Retrospective</a></li><li class="chapter-item expanded "><a href="project/CHANGELOG.html"><strong aria-hidden="true">6.9.</strong> Full CHANGELOG</a></li><li class="chapter-item expanded "><a href="project/references.html"><strong aria-hidden="true">6.10.</strong> References</a></li><li class="chapter-item expanded "><a href="project/presentations.html"><strong aria-hidden="true">6.11.</strong> Presentations</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">A/B Street</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/a-b-street/docs/tree/main/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="homepage"><a class="header" href="#homepage">Homepage</a></h1>
<p>Welcome to the A/B Street website. Here you will find information about the
project, an overview of the <a href="software">software</a> products it has enabled, a
<a href="user">user guide</a>, <a href="tech">technical details</a> aimed at developers, and lots
more.</p>
<p>Like any open source project, A/B Street has evolved and will continue to
evolve, and that applies to the documentation. Any contributions to the website,
the source code of which can be found at
<a href="https://github.com/a-b-street/docs">github.com/a-b-street/docs</a> are very
welcome. In fact, contributing to the project's documentation can be one of the
easiest ways of supporting the project.</p>
<!--
Todo
This homepage should definitely have:

- our 3 principles
- lots of videos
- contact info
- contributing
-->
<div style="break-before: page; page-break-before: always;"></div><h1 id="software"><a class="header" href="#software">Software</a></h1>
<p>Our main software is <a href="software/abstreet.html">A/B Street</a>, but along the way, we've split
out a few related side projects. A/B Street has a huge scope, so over time, we'd
like to carve out more smaller pieces from it.</p>
<p>The main projects:</p>
<ul>
<li><a href="software/abstreet.html">A/B Street</a> for running a traffic simulation, editing roads and
intersections, and measuring the impact of your changes. It has game-like
elements, but leans more on the side of being a real prototyping tool.</li>
<li><a href="software/fifteen_min.html">15-minute neighborhood explorer</a> for seeing where people live
in relation to commercial and public amenities.</li>
<li><a href="software/santa.html">15-minute Santa</a>, a light-hearted arcade game to demonstrate the
concept of a 15-minute neighborhood.</li>
</ul>
<p>Some dedicated tools for the OpenStreetMap community:</p>
<ul>
<li><a href="software/osm_viewer.html">OpenStreetMap viewer</a> for auditing lane tagging</li>
<li><a href="software/parking_mapper.html">Parking mapper</a> for editing street parking data</li>
</ul>
<p>Some pieces of the code-base are eventually destined to be stand-alone and
useful for other projects:</p>
<ul>
<li><a href="software/../tech/dev/ui.html">widgetry</a> Rust UI library for native/web</li>
<li>a
<a href="https://github.com/a-b-street/abstreet/blob/master/map_model/src/make/initial/lane_specs.rs">common library</a>
for transforming OpenStreetMap key/values to a clear schema of lanes</li>
</ul>
<p>And some planned projects:</p>
<ul>
<li>a
<a href="https://docs.google.com/document/d/1ejmOPNyizR8owqjEbTYlIAN4l5QgLPJ85-es26q8nfg/edit?usp=sharing">low traffic neighborhood planner</a></li>
<li>something focused on
<a href="https://github.com/a-b-street/abstreet/issues/372">public transit</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ab-street"><a class="header" href="#ab-street">A/B Street</a></h1>
<ul>
<li>Download: <a href="https://a-b-street.github.io/docs/howto/index.html">https://a-b-street.github.io/docs/howto/index.html</a></li>
<li>Play on the web:
<a href="http://abstreet.s3-website.us-east-2.amazonaws.com/0.2.57/abstreet.html">http://abstreet.s3-website.us-east-2.amazonaws.com/0.2.57/abstreet.html</a></li>
<li>Github: <a href="https://github.com/a-b-street/abstreet/tree/master/game/src">https://github.com/a-b-street/abstreet/tree/master/game/src</a></li>
</ul>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>A/B Street is &quot;a traffic simulation game exploring how small changes to roads
affect cyclists, transit users, pedestrians, and drivers.&quot; In other words, you
can transform that street parking into a bus lane or fix that pesky left turn at
a traffic signal, measure the effects, then
<a href="software/../proposals/README.html">propose actually making the change</a>.</p>
<p>A/B Street uses game-like elements to gradually introduce all of the features of
the simulation, with a tutorial and a few challenge modes. (Or at least, that's
the goal.) But just becaused it's called a &quot;game&quot; doesn't mean it's not trying
to model the real world as accurately as possible from open data.</p>
<p>Keep in mind it's impossible to simulate all complexity in the real world of
people moving around a city. Every traffic model makes lots of assumptions and
trade-offs, including A/B Street.</p>
<h2 id="explore"><a class="header" href="#explore">Explore</a></h2>
<p>A/B Street gives you a 2D representation of roads, with as much detail about
bus/bike/turn/parking lanes, transit stops, traffic signals, and parking lots as
possible, all from OpenStreetMap.</p>
<p>(map model pictures)</p>
<p>Depending on elevation data availability, some areas let you visualize steep
streets -- because your bike network should be planned accordingly.</p>
<p>(two elevation pictures)</p>
<p>Using external travel demand models, you can explore patterns of where people
live, work, and shop.</p>
<p>(commuter layer picture)</p>
<h2 id="simulate"><a class="header" href="#simulate">Simulate</a></h2>
<p>Using some external data about what trips people take on a typical day, you can
simulate drivers, bicyclists, and pedestrians moving around. (Public transit and
scooter/bikeshare micromobility planned.)</p>
<p>(video of one intersection)</p>
<p>You can follow individual people and watch them wrestle with problems.</p>
<p>(follow video)</p>
<p>Or get a bird's-eye view of how everything is moving.</p>
<p>(unzoomed video)</p>
<p>Every driving trip begins and ends with parking, which might be easy in suburban
areas, but hard in cities.</p>
<p>(video)</p>
<p>Some details:</p>
<ul>
<li>People will take the best route available, <strong>not</strong> accounting for current
congestion. Drivers prefer the fastest route (shorter distances, higher speed
limits). Pedestrians and cyclists also factor in elevation changes.</li>
<li>Vehicles instantly accelerate and stop. This is a useful simplification to
speed up the simulation, but of course, you shouldn't use A/B Street to
simulate jam waves on freeways.</li>
<li>Vehicles stay in the same lane once they pick it, and sometimes they choose
their lane really poorly. We're working on improving this.</li>
<li>We don't simulate accidents -- but we do measure &quot;risk exposure&quot; where a
collision may be likely.</li>
</ul>
<h2 id="edit"><a class="header" href="#edit">Edit</a></h2>
<p>A/B Street lets you change how road space is divided up. You can create regular
vehicle lanes, bus-only lanes, bike lanes, street parking, and new sidewalks.
You can either transform existing lanes, or slightly widen/shrink the road. You
can reverse the direction of lanes, or close them down to simulate construction.</p>
<p>(video)</p>
<p>You can also change speed limits and restrict access to an area. Only trips that
start or end in a private area can use the roads within, modelling gated
communities. Or you can allow through-traffic for people walking and biking, to
create low-traffic neighborhoods.</p>
<p>(video)</p>
<p>You can also change how traffic signals work. You can modify the timing if you
notice left turns need more time, or set up actuated timing, so that the green
light lasts longer when many vehicles are waiting. You can also change which
movements are allowed each stage, so you could try out a dedicated left turn
stage or a pedestrian all-walk/scramble cycle.</p>
<p>(video)</p>
<h2 id="measure"><a class="header" href="#measure">Measure</a></h2>
<p>A/B Street lets you tell data-driven stories about both infrastructure and
people</p>
<p>stories you can tell</p>
<p>individ/aggregate absolute/relative</p>
<ul>
<li>go through all of the layers</li>
<li>and dashboards</li>
</ul>
<h2 id="not-to-crush-your-dreams-but"><a class="header" href="#not-to-crush-your-dreams-but">Not to crush your dreams, but...</a></h2>
<p>gridlock cant do A/B tests if you cant finish trips</p>
<p>mode shift!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="15-minute-neighborhood-explorer"><a class="header" href="#15-minute-neighborhood-explorer">15-minute neighborhood explorer</a></h1>
<p><img src="software/walkshed.gif" alt="walkshed" /></p>
<ul>
<li><a href="http://abstreet.s3-website.us-east-2.amazonaws.com/0.2.57/fifteen_min.html">Web version</a></li>
<li>To run locally, get the
<a href="https://github.com/a-b-street/abstreet/releases">latest release</a> for Windows,
Mac, or Linux. After unzipping, run <code>fifteen_min.exe</code> or <code>fifteen_min</code>.</li>
</ul>
<p>In a
<a href="https://crosscut.com/focus/2020/11/seattle-could-become-next-15-minute-city">15-minute city</a>,
most residents can reach a variety of stores, restaurants, parks, and jobs
within about a 15 minute walk or bike ride. Part of advocating for a
bike-friendly city is evaluating the zoning laws and understanding where people
live in relation to where they work, shop, and meet friends. This tool is a
prototype letting you see what's 15 minutes away from a starting point. You can
explore the shops and estimate how much street parking and how many people live
within a walkshed.</p>
<h2 id="feedback"><a class="header" href="#feedback">Feedback</a></h2>
<p>The tool is quite simple right now. If you have an idea how this could be used
for advocacy, please
<a href="https://github.com/a-b-street/abstreet/issues/393">get in touch</a>.</p>
<h2 id="implementation"><a class="header" href="#implementation">Implementation</a></h2>
<p>This section describes some of the technical implementation details.</p>
<h3 id="calculating-time-to-buildings"><a class="header" href="#calculating-time-to-buildings">Calculating time to buildings</a></h3>
<p>When you click on a starting building, what happens? Follow along with the code:
<a href="https://github.com/a-b-street/abstreet/blob/master/fifteen_min/src/isochrone.rs">https://github.com/a-b-street/abstreet/blob/master/fifteen_min/src/isochrone.rs</a></p>
<p>First, we calculate the time to reach all buildings on the map from the start,
based on the current options for walking or biking. For walking, this calls
<a href="https://github.com/a-b-street/abstreet/blob/master/map_model/src/connectivity/walking.rs">all_walking_costs_from</a>.
This method simply performs
<a href="https://en.wikipedia.org/wiki/Dijkstra%27s_algorithm">Dijkstra's maneuever</a>,
floodfilling a graph from the start node and tracking the cost to reach other
nodes. It terminates early when the cost exceeds 15 minutes.</p>
<p>One relevant detail is that the graph is based off of <code>WalkingNodes</code>, which
represent both endpoints of a sidewalk. A building exists some distance along a
sidewalk. To calculate the final cost to a building, we also add up the cost
between the nearest end of the sidewalk and the building's exact position along
the sidewalk. This calculation doesn't use the length of the building's
driveway/front path, but it could.</p>
<p>The other question is how we calculate the cost to cross a sidewalk. The units
are durations, and most of the time, we simply calculate <code>distance / speed</code>. The
base speed for walking can be configured in the 15m tool UI, with a few pre-set
values for jogging, using a wheelchair, or a general average for adults. We also
<a href="https://github.com/a-b-street/abstreet/blob/8826af31cba342662694014e549322a727605339/map_model/src/traversable.rs#L315">adjust speed based on the road's incline</a>,
using a variation of
<a href="https://en.wikipedia.org/wiki/Tobler%27s_hiking_function">Tobler's hiking function</a>.
The elevation data baked into the map model likely has bugs, which then affect
walking speed.</p>
<p>In the future, we'll keep expanding this definition of &quot;cost&quot; to capture other
factors that make it safe and pleasant to walk, so that the 15m tool ultimately
reflects how awful it'd be to access essential services by walking along a busy
arterial road.</p>
<h3 id="drawing-the-isochrone"><a class="header" href="#drawing-the-isochrone">Drawing the isochrone</a></h3>
<p>Now that we have the cost to reach a bunch of buildings, we want to draw the
three-colored isochrone, showing the area reachable within 5, 10, and 15
minutes. We use the <a href="https://crates.io/crates/contour">contour</a> crate to do
this, which uses the
<a href="https://en.wikipedia.org/wiki/Marching_squares">marching squares algorithm</a> to
find the &quot;contour&quot; where the cost changes from less than 5 to over 5 minutes.</p>
<p>In my mind, an isochrone contour algorithm could just take the list of (point,
cost) pairs as input, but marching squares requires a grid, so
<a href="https://github.com/a-b-street/abstreet/blob/8826af31cba342662694014e549322a727605339/fifteen_min/src/isochrone.rs#L126">the code</a>
first creates that grid, using a fixed 100 meter cell size. If two buildings
happen to map to the same square, the cost of one of them is used arbitrarily.
It shouldn't matter much; it takes around 30 seconds to walk 100 meters, so the
contour might be a little off by about that much.</p>
<p><img src="software/gaps.png" alt="gaps" /></p>
<p>You can see some gaps in the middle of the park. Because there are no buildings
in the middle, the grid cell has 0 cost in there. There's probably some better
approaches to calculating isochrones.</p>
<h3 id="finding-the-perfect-home"><a class="header" href="#finding-the-perfect-home">Finding the perfect home</a></h3>
<p>The tool also has a feature that lets you mark what categories of amenities you
care about, then it finds houses within a 15 min walk of all of those. Its
implementation is
<a href="https://github.com/a-b-street/abstreet/blob/8826af31cba342662694014e549322a727605339/fifteen_min/src/find_home.rs#L84">laughably brute-force</a>.
For each of the categories, it finds all stores matching that category, then
does the Dijkstra's floodfill from each of those buildings. An obvious speedup
here would be to perform Dijkstra's just once for each category and insert all
of the stores into the priority queue as starting nodes.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="15-minute-santa"><a class="header" href="#15-minute-santa">15-minute Santa</a></h1>
<p>Created by <a href="https://abstreet.org">Dustin Carlino</a>,
<a href="https://www.yuwen-li.com/">Yuwen Li</a>, &amp;
<a href="https://michaelkirk.github.io/">Michael Kirk</a></p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/mrIsVMLZ_yc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
<p>15-minute Santa is a game where you deliver presents across Seattle. You earn
more points delivering to high-density housing, and you need to refuel from
shops, so you'll have to understand where people live in relation to where they
work and shop.</p>
<p>Contact <a href="software/dabreegster@gmail.com">dabreegster@gmail.com</a> with any feedback or
<a href="https://github.com/a-b-street/abstreet/issues/new">file an issue on Github</a>.</p>
<h2 id="play-it"><a class="header" href="#play-it">Play it</a></h2>
<ul>
<li><a href="http://abstreet.s3-website.us-east-2.amazonaws.com/0.2.57/santa.html">Play online</a>
(slower and no music -- download below if possible)</li>
<li><a href="https://github.com/a-b-street/abstreet/releases/download/v0.2.57/abstreet_windows_v0_2_57.zip">Windows</a></li>
<li><a href="https://github.com/a-b-street/abstreet/releases/download/v0.2.57/abstreet_mac_v0_2_57.zip">Mac</a></li>
<li><a href="https://github.com/a-b-street/abstreet/releases/download/v0.2.57/abstreet_linux_v0_2_57.zip">Linux</a></li>
</ul>
<p>Unzip, then run <code>santa.exe</code> or <code>santa</code>. No mobile/tablet support, sorry -- you
need a keyboard.</p>
<h2 id="faq"><a class="header" href="#faq">FAQ</a></h2>
<h3 id="why-did-yall-make-this"><a class="header" href="#why-did-yall-make-this">Why did y'all make this?</a></h3>
<p>We normally work on <a href="https://abstreet.org">A/B Street</a>, a traffic simulation
that lets the general public explore a future prioritizing more sustainable
modes of transportation. All of the recent
<a href="https://crosscut.com/focus/2020/11/seattle-could-become-next-15-minute-city">talk</a>
about 15-minute cities prompted us to explore how Seattle's zoning causes many
people to live far from where they get groceries. After experimenting with a
<a href="software/fifteen_min.html">more serious</a> tool to understand walk-sheds, we decided to
spend a few weeks on something a bit more light-hearted.</p>
<h3 id="realism"><a class="header" href="#realism">Realism</a></h3>
<p>The map of Seattle and location of shops comes from
<a href="https://www.openstreetmap.org/about">OpenStreetMap</a>. We only consider shops if
they sell food or drinks -- let us know if the map seems to be missing your
favorite restaurant. The number of housing units is based on
<a href="https://data-seattlecitygis.opendata.arcgis.com/datasets/current-land-use-zoning-detail">Seattle GIS data</a>.
Mixed-use buildings with both commercial and residential units aren't
represented. The game lets you upzone any house to place a new store; obviously
this is a vast simplification of how complex a real conversation about changing
zoning codes should be.</p>
<p>We rigorously evaluated the speed and carrying capacity of different cargo bikes
and sleighs on the market to tune the vehicles in the game.</p>
<h3 id="modding-the-game"><a class="header" href="#modding-the-game">Modding the game</a></h3>
<p>Native versions only -- sorry, not easy to do on the web.</p>
<p>You can adjust the difficulty of the levels or give yourself all the upzoning
power you want by editing <code>data/player/santa.json</code>. You first have to set
<code>&quot;enable_modding&quot;: true</code>. The format should mostly be self-explanatory; also see
<a href="https://github.com/a-b-street/abstreet/blob/be589f7ef4f649bb5a35bfe8de0bc81a9deeb029/santa/src/session.rs#L13">here</a>
as a reference. If you break something, just delete the file to start over. If
you come up with a better gameplay progression, please share -- tuning a game is
hard!</p>
<h3 id="adding-new-maps"><a class="header" href="#adding-new-maps">Adding new maps</a></h3>
<p>Missing your slice of Seattle, or want to run somewhere else? If you have a bit
of technical experience,
<a href="https://a-b-street.github.io/docs/howto/new_city.html">follow this guide</a> and
then the above instructions for modding the game. Otherwise, draw the map
boundaries in <a href="http://geojson.io">http://geojson.io</a> and
<a href="https://github.com/a-b-street/abstreet/issues/new">send it to us</a> along with a
time limit, goal, and starting point on the map. If you have a public data
source for the number of housing units per building, please include it!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="openstreetmap-viewer"><a class="header" href="#openstreetmap-viewer">OpenStreetMap viewer</a></h1>
<ul>
<li><a href="http://abstreet.s3-website.us-east-2.amazonaws.com/0.2.57/osm_viewer.html">Web version</a></li>
<li>To run locally, get the
<a href="https://github.com/a-b-street/abstreet/releases">latest release</a> for Windows,
Mac, or Linux. After unzipping, run <code>osm_viewer.exe</code> or <code>osm_viewer</code>.</li>
</ul>
<p>A separate tool that visualizes OpenStreetMap data, with details on lanes, turn
restrictions, parking lot capacity, and road width. It's also very convenient to
explore the raw attributes on roads. The
<a href="https://www.youtube.com/watch?v=JUN5GWfb4Qo">OSM Connect 2020 talk</a> talks about
possible directions for this viewer.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mapping-on-street-parking-in-openstreetmap"><a class="header" href="#mapping-on-street-parking-in-openstreetmap">Mapping on-street parking in OpenStreetMap</a></h1>
<p><img src="software/parking_mapper.gif" alt="parking_mapper" /></p>
<p>This guide assumes you've edited OSM before. Contact <a href="software/dabreegster@gmail.com">dabreegster@gmail.com</a> if
you have any trouble. Also give me a heads up when you make some edits, so I can
regenerate the maps!</p>
<ol>
<li><a href="software/../user/index.html">Install A/B Street</a></li>
<li>Choose <strong>Contribute parking data</strong> on the main screen</li>
<li>Change the map if you'd like to focus somewhere in particular</li>
<li>Click a road with unknown parking</li>
<li>Select what kind of on-street parking the road has</li>
<li>Repeat</li>
<li>Click <strong>Generate OsmChange file</strong></li>
<li>Upload the diff.osc file by adding a layer in JOSM (or send it to me)</li>
</ol>
<p>Like all edits to OSM, to figure out ground-truth, you can survey in-person or
use
<a href="https://wiki.openstreetmap.org/wiki/Bing_Maps#Streetside_imagery">Bing Streetside</a>.
<strong>Do not use data from Google Maps to edit OSM.</strong></p>
<h2 id="faq-1"><a class="header" href="#faq-1">FAQ</a></h2>
<h3 id="why"><a class="header" href="#why">Why?</a></h3>
<p>I'm trying to build a realistic traffic simulation of Seattle using OSM data,
then use it to strengthen proposals for
<a href="software/../proposals/lake_wash.html">pedestrianized streets</a>,
<a href="https://www.glwstreets.org/45th-st-bridge-overview">improving the bike network</a>,
and <a href="software/../proposals/west_seattle.html">mitigating the West Seattle bridge closure</a>.
A/B Street is only as good as its data, and parking is one of the biggest gaps.
Missing data means unrealistic traffic as vehicles contend for few parking
spots, and roads that look much wider than they are in reality.</p>
<h3 id="why-put-this-data-in-osm"><a class="header" href="#why-put-this-data-in-osm">Why put this data in OSM?</a></h3>
<p>Why can't I just grab parking data from
<a href="http://web6.seattle.gov/SDOT/seattleparkingmap/">SDOT's map</a>, using the
<a href="http://data-seattlecitygis.opendata.arcgis.com/datasets/blockface">blockface</a>
dataset? Well, I'm trying -- when you see a parking lane in the tool, it's
coming from blockface, unless that road in OSM is tagged. But the blockface
dataset is comically wrong in many places -- for example, the Montlake bridge
apparently has unrestricted parking?! King County GIS has confirmed the dataset
isn't meant to be used for this level of detail.</p>
<p>Plus, if the data is in OSM, anybody else can make use of it.</p>
<h3 id="how-does-the-tool-work"><a class="header" href="#how-does-the-tool-work">How does the tool work?</a></h3>
<p>A/B Street attempts to render individual lanes and intersections from OSM data.
This makes it useful to audit the lane tags in OSM, including
<a href="https://wiki.openstreetmap.org/wiki/Key:parking:lane">parking:lane</a>. The tool
tracks your edits and when you generate the OsmChange file, it grabs modified
ways from the OSM API to generate a diff. You can inspect the diff, load it in
JOSM, and upload.</p>
<p><strong>Your changes won't immediately be reflected in A/B Street.</strong> Let me know when
you've done some amount of mapping, and I'll regenerate the maps from fresh
data.</p>
<h3 id="why-use-this-tool"><a class="header" href="#why-use-this-tool">Why use this tool?</a></h3>
<p>You don't have to; <a href="https://zlant.github.io/parking-lanes/">this tool</a> or ID or
JOSM all work. But the UI is clunky for this specific purpose. (Also, if you
find this tool clunky in any way, let me know and I'll fix it.) There's also a
proposed
<a href="https://github.com/westnordost/StreetComplete/issues/771">StreetComplete quest</a>.</p>
<h3 id="what-about-parking-restrictions"><a class="header" href="#what-about-parking-restrictions">What about parking restrictions?</a></h3>
<p>There are many
<a href="https://wiki.openstreetmap.org/wiki/Key:parking:lane">parking:lane</a> tags to
indicate restricted parking zones, time restrictions, etc. Feel free to map that
in ID or JOSM, but I'm just looking to make a first pass over a wide area.</p>
<h3 id="what-about-off-street-parking"><a class="header" href="#what-about-off-street-parking">What about off-street parking?</a></h3>
<p>Ideally I'd also like to know how many private parking spots are available to
residents of each building. But I don't know of an OSM schema for mapping this,
or a practical way to collect this data. Let me know if you have ideas.</p>
<h3 id="what-about-long-roads-where-parking-appears-and-disappears"><a class="header" href="#what-about-long-roads-where-parking-appears-and-disappears">What about long roads where parking appears and disappears?</a></h3>
<p>The tool won't help. Use your favorite editor to split the way when the lane
configuration changes. Also feel free to just skip these areas.</p>
<h3 id="how-to-coordinate-with-other-mappers"><a class="header" href="#how-to-coordinate-with-other-mappers">How to coordinate with other mappers?</a></h3>
<p>If somebody wants to set up HOT tasking, that'd be great, but I don't expect so
many people to jump on this.</p>
<h3 id="i-noticed-weird-roads-in-the-tool"><a class="header" href="#i-noticed-weird-roads-in-the-tool">I noticed weird roads in the tool</a></h3>
<p>Welcome to my world. ;) If the number of lanes seems wrong, select the road and
check the OSM tags. I'm inferring lanes from that. Feel free to make manual OSM
edits to fix any problems you see. (I'd like to extend this tool to make that
easier; let me know if you have ideas how to do this.)</p>
<h3 id="i-want-to-map-an-area-but-theres-no-option-for-it"><a class="header" href="#i-want-to-map-an-area-but-theres-no-option-for-it">I want to map an area, but there's no option for it</a></h3>
<p>To keep the release size small, I'm not including all maps yet. Let me know what
you'd like to see included.</p>
<p>Or if you have a <code>.osm</code> file, try the <a href="software/../user/new_city.html">quick start guide</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="user-guide"><a class="header" href="#user-guide">User guide</a></h1>
<p>This is an alpha-quality demo. Please email <a href="user/dabreegster@gmail.com">dabreegster@gmail.com</a> or
<a href="https://github.com/a-b-street/abstreet/issues/">file a Github issue</a> if you hit
problems.</p>
<h2 id="installing-the-game"><a class="header" href="#installing-the-game">Installing the game</a></h2>
<p>Grab a pre-built binary release -- updated every Sunday, announced at
<a href="http://old.reddit.com/r/abstreet">r/abstreet</a>:</p>
<ul>
<li><a href="https://github.com/a-b-street/abstreet/releases/download/v0.2.57/abstreet_windows_v0_2_57.zip">Windows</a>
<ul>
<li>Unzip the folder, then run <code>play_abstreet.bat</code>. If you get a warning about
compressed files, choose to extract -- you can't run from the .zip directly.</li>
<li>If you get a &quot;Windows protected you&quot; security warning, click &quot;more info&quot;,
then &quot;run anyway.&quot; We don't sign the release yet, so A/B Street shows up as
an unknown publisher.</li>
</ul>
</li>
<li><a href="https://github.com/a-b-street/abstreet/releases/download/v0.2.57/abstreet_mac_v0_2_57.zip">Mac</a>
<ul>
<li>Unzip the directory, then run <code>play_abstreet.sh</code>.</li>
<li>If you get an error about the developer unverified,
<a href="https://support.apple.com/guide/mac-help/open-a-mac-app-from-an-unidentified-developer-mh40616/mac">follow this</a>.
Help needed to start
<a href="https://github.com/a-b-street/abstreet/issues/107">signing the release</a>!</li>
<li>If that just opens a text file instead of running the game, then instead
open terminal, <code>cd</code> to the directory you just unzipped. Then do:
<code>cd game; RUST_BACKTRACE=1 ./game 1&gt; ../output.txt 2&gt;&amp;1</code></li>
<li><a href="https://github.com/a-b-street/abstreet/issues/77">Help needed</a> to package
this as a Mac .app, to make this process simpler</li>
</ul>
</li>
<li><a href="https://github.com/a-b-street/abstreet/releases/download/v0.2.57/abstreet_linux_v0_2_57.zip">Linux</a>
<ul>
<li>Unzip the directory, then run <code>play_abstreet.sh</code>.</li>
</ul>
</li>
<li><a href="https://www.freshports.org/games/abstreet/">FreeBSD</a>, thanks to
<a href="https://github.com/yurivict">Yuri</a></li>
</ul>
<p>Or you can play
<a href="http://abstreet.s3-website.us-east-2.amazonaws.com/0.2.57/abstreet.html">directly in your web browser</a>
-- some things don't work as well, but no install required.</p>
<p>Or you can <a href="user/../tech/dev/index.html">compile from source</a>.</p>
<h2 id="playing-the-game"><a class="header" href="#playing-the-game">Playing the game</a></h2>
<ul>
<li>Use the <strong>tutorial</strong> to learn the controls.</li>
<li>Play the <strong>challenges</strong> for directed gameplay.</li>
<li>Try out any ideas in the <strong>sandbox</strong>.</li>
</ul>
<h2 id="common-issues"><a class="header" href="#common-issues">Common issues</a></h2>
<p>If the size of text and panels
<a href="https://github.com/a-b-street/abstreet/issues/381">seems very strange</a>, you can
try editing <code>play_abstreet.sh</code> or <code>play_abstreet.bat</code> and passing
<code>--scale_factor=1</code> on the command line. This value is detected from your monitor
settings, so if you have a Retina or other HiDPI display, things may be too big
or small.</p>
<h2 id="data-source-licensing"><a class="header" href="#data-source-licensing">Data source licensing</a></h2>
<p>A/B Street binary releases contain pre-built maps that combine data from:</p>
<ul>
<li>OpenStreetMap (<a href="https://www.openstreetmap.org/copyright">https://www.openstreetmap.org/copyright</a>)</li>
<li>King County metro
(<a href="https://www.kingcounty.gov/depts/transportation/metro/travel-options/bus/app-center/terms-of-use.aspx">https://www.kingcounty.gov/depts/transportation/metro/travel-options/bus/app-center/terms-of-use.aspx</a>)</li>
<li>City of Seattle GIS program
(<a href="https://www.opendatacommons.org/licenses/pddl/1.0/">https://www.opendatacommons.org/licenses/pddl/1.0/</a>)</li>
<li><a href="https://github.com/seattleio/seattle-boundaries-data">https://github.com/seattleio/seattle-boundaries-data</a>
(<a href="https://creativecommons.org/publicdomain/zero/1.0/">https://creativecommons.org/publicdomain/zero/1.0/</a>)</li>
<li>Puget Sound Regional Council
(<a href="https://www.psrc.org/activity-based-travel-model-soundcast">https://www.psrc.org/activity-based-travel-model-soundcast</a>)</li>
<li>USGS SRTM</li>
</ul>
<p>Other binary data bundled in:</p>
<ul>
<li>Overpass font (<a href="https://fonts.google.com/specimen/Overpass">https://fonts.google.com/specimen/Overpass</a>, Open Font
License)</li>
<li>Bungee fonts (<a href="https://fonts.google.com/specimen/Bungee">https://fonts.google.com/specimen/Bungee</a>, Open Font License)</li>
<li>Material Design icons (<a href="https://material.io/resources/icons">https://material.io/resources/icons</a>, Apache license)</li>
<li>Some Graphics textures (<a href="https://www.kenney.nl/">https://www.kenney.nl/</a>, CC0 1.0 Universal)</li>
<li>Snowflake SVG (<a href="https://www.svgrepo.com/page/licensing">https://www.svgrepo.com/page/licensing</a>, CC0)</li>
<li>Music from
<a href="https://github.com/a-b-street/abstreet/tree/master/data/system/assets/music/sources.md">various sources</a>
with Creative Commons licenses</li>
<li>Country flags (<a href="https://github.com/hampusborgos/country-flags">https://github.com/hampusborgos/country-flags</a>, public domain)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="importing-a-new-city-into-ab-street"><a class="header" href="#importing-a-new-city-into-ab-street">Importing a new city into A/B Street</a></h1>
<p>If you get stuck, please email <a href="user/dabreegster@gmail.com">dabreegster@gmail.com</a> or
<a href="https://github.com/a-b-street/abstreet/issues/">file a Github issue</a>. I promise
quick turnaround time. All you need to do is send the boundary of the area you
want, drawn with <a href="http://geojson.io">geojson.io</a>.</p>
<h2 id="the-easy-method"><a class="header" href="#the-easy-method">The easy method</a></h2>
<p>This only works in the
<a href="https://a-b-street.github.io/docs/howto/index.html">downloaded version</a>, not on
web.</p>
<ol>
<li>Click the map name in sandbox mode to change your location.</li>
<li>Scroll down and click &quot;import a new city&quot;</li>
<li>Follow the instructions. That's it!</li>
</ol>
<p>This may take a few minutes, depending on download speed.</p>
<h2 id="if-the-city-has-already-been-imported"><a class="header" href="#if-the-city-has-already-been-imported">If the city has already been imported</a></h2>
<p>A/B Street includes many cities already. Once you're running the game (natively
or on the web), click on the Sandbox option, then check the top for a button to
change the map:</p>
<p><img src="user/change_map.png" alt="" /></p>
<p>You can browse through a list of cities per country, or use a text search:</p>
<p><img src="user/search_maps.png" alt="" /></p>
<p>You may need to download data for that city:</p>
<p><img src="user/download_map.png" alt="" /></p>
<p>You should be able to open the map. In this case above, the map data was saved
as <code>data/system/gb/exeter_red_cow_village/maps/center.bin</code>.</p>
<h2 id="advanced-using-the-command-line"><a class="header" href="#advanced-using-the-command-line">Advanced: Using the command-line</a></h2>
<p>The process above using the UI just calls a tool to do all of the work. If you
want, you can just call that tool from the command line. First save a GeoJSON
file with your boundary. Then...</p>
<p>Using a .zip release: <code>./tools/one_step_import boundary.geojson</code></p>
<p>Building from source:
<code>cargo build --release --bin importer --bin one_step_import --bin geojson_to_osmosis --bin pick_geofabrik --bin clip_osm &amp;&amp; ./target/release/one_step_import boundary.geojson</code></p>
<p>The new map is located in the country with code &quot;zz&quot; (this isn't a real
country), in the &quot;oneshot&quot; city. This is stored in
<code>data/system/zz/oneshot/maps</code>.</p>
<h2 id="advanced-adding-the-city-to-ab-street-permanently"><a class="header" href="#advanced-adding-the-city-to-ab-street-permanently">Advanced: Adding the city to A/B street permanently</a></h2>
<p>The easiest method is to just ask Dustin to do this. The full process:</p>
<ol>
<li>
<p>Make sure you can run <code>import.sh</code> -- see
<a href="user/../tech/dev/index.html#building-map-data">the instructions</a>. You'll need
Rust, osmconvert, gdal, etc.</p>
</li>
<li>
<p>Create a new directory: <code>mkdir importer/config/xy/your_city</code>, where <code>xy</code> is
a lowercase two letter country code from
<a href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2">https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2</a></p>
</li>
<li>
<p>Use <a href="http://geojson.io/">geojson.io</a> or
<a href="https://geoman.io/geojson-editor">geoman.io</a> to draw a boundary around the
region you want to simulate and save the geojson locally.</p>
</li>
<li>
<p>Use <code>cargo run --bin geojson_to_osmosis &lt; boundary.geojson</code> to convert that
geojson to the
<a href="https://wiki.openstreetmap.org/wiki/Osmosis/Polygon_Filter_File_Format">Osmosis format</a>
required by osmconvert. This tool writes one file per feature in the input,
so you'd then
<code>mv boundary0.poly importer/config/xy/your_city/region_name.poly</code>, repeating
if you drew multiple polygons.</p>
</li>
<li>
<p>Copy <code>importer/config/il/tel_aviv/cfg.json</code> to
<code>importer/config/xy/your_city/cfg.json</code> and edit this file. See
<a href="https://github.com/a-b-street/abstreet/blob/master/importer/src/generic.rs">here</a>
for details on the different fields. The defaults are a reasonable start;
the only thing you need to change is <code>osm_url</code>. You can use
<a href="https://github.com/a-b-street/abstreet/blob/master/importer/src/bin/pick_geofabrik.rs">pick_geofabrik</a>
to figure out this URL.</p>
</li>
<li>
<p>Run the import: <code>./import.sh --city=xy/your_city --raw --map</code></p>
</li>
<li>
<p>Update <code>.gitignore</code>, following <code>tel_aviv</code> as an example. Keep sorted!</p>
</li>
<li>
<p>Fill out <code>nice_map_name</code> in <code>map_gui/src/tools/mod.rs</code>.</p>
</li>
</ol>
<p>Send a PR with your changes! I'll generate everything and make it work with
<code>updater</code>, so most people don't have to build everything from scratch.</p>
<p>Also, you can divide the city into multiple regions, repeating step 4 and
declaring more polygon boundaries. The boundaries may overlap each other, and
they don't have to cover all of the space. Picking good boundaries may take
trial-and-error; the goal is to keep the resulting map file size small, so that
it loads quickly, while capturing all of the area needed to simulate something
interesting. This is easiest when you have some local knowledge of the area, and
at least a vague goal in mind for what you want to study.</p>
<h2 id="advanced-importing-a-osm-file-directly"><a class="header" href="#advanced-importing-a-osm-file-directly">Advanced: Importing a .osm file directly</a></h2>
<p>This section assumes you're comfortable working on a command line. If you have a
.osm XML file, you can import it directly by running
<code>./import.sh --oneshot=/path/to/extract.osm</code>. If you're running from a .zip
release and not building from source, replace the first part with
<code>./tools/importer</code>.</p>
<p>Assuming this succeeds, it'll create a file called
<code>data/system/zz/oneshot/maps/extract.bin</code>. Currently the UI won't list this
file, so you have to launch the game pointed at this file directly; see
<a href="user/asu.html#a-shortcut-and-improving-the-simulation-in-tempe">here</a> for how to do
that.</p>
<p>If you save a .osm file from JOSM, you might get an error importing related to
<code>convert_osm/src/clip.rs</code>. If so, delete the <code>&lt;bounds&gt;</code> element from the top of
the .osm file and try again.</p>
<p>If you follow this process, the resulting map won't have any border
intersections, which will break parts of the simulation:</p>
<p><img src="user/no_clip.png" alt="no_clip" /></p>
<p>You can fix this by creating the Osmosis .poly file and passing
<code>--oneshot_clip=/path/to/clip.poly</code> to the import command.</p>
<p>One use case for following this section is to temporarily work around
<a href="https://github.com/a-b-street/abstreet/issues/654">broken intersection geometry</a>.
The process is:</p>
<ol>
<li>Edit the problematic area in JOSM, recreating a complicated intersection in
a simpler way.</li>
<li>Save the .osm file locally</li>
<li>Run the importer</li>
<li>Try in A/B Street</li>
</ol>
<p>You probably don't want to upload the changeset to OSM, unless it's actually
mis-tagged. Usually the problem is how A/B Street tries to interpret what's in
OSM. Ideally we could also follow this process using the ID editor, but it can't
currently
<a href="https://github.com/openstreetmap/iD/issues/7109">manage changeset files fully</a>.</p>
<h2 id="next-steps"><a class="header" href="#next-steps">Next steps</a></h2>
<p>OpenStreetMap isn't the only data source we need. If you look at the import
pipeline for Seattle, you'll see many more sources for parking, GTFS bus
schedules, person/trip demand data for scenarios, etc. Most of these aren't
standard between cities. If you want to make your city more realistic, we'll
have to import more data. Get in touch.</p>
<p>You may notice issues with OSM data while using A/B Street. Some of these are
bugs in A/B Street itself, but others are incorrectly tagged lanes. Some
resources for fixing OSM:</p>
<ul>
<li><a href="https://learnosm.org">https://learnosm.org</a></li>
<li><a href="https://wiki.openstreetmap.org/wiki/StreetComplete">https://wiki.openstreetmap.org/wiki/StreetComplete</a></li>
<li><a href="user/../software/parking_mapper.html">Mapping parking</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="instructions-for-asu-collaborators"><a class="header" href="#instructions-for-asu-collaborators">Instructions for ASU collaborators</a></h1>
<p>These instructions are tailored to the
<a href="https://github.com/asu-trans-ai-lab/">ASU Transportation AI Lab</a>.</p>
<p>The most important tip: ask questions!
<a href="https://github.com/dabreegster/abstreet/issues/">File an issue</a>, email
<a href="user/dabreegster@gmail.com">dabreegster@gmail.com</a>, or ask for a Slack invite.</p>
<h2 id="installing"><a class="header" href="#installing">Installing</a></h2>
<p>A new version is released every Sunday, but you probably don't need to update
every week.</p>
<ol>
<li>Go to <a href="https://github.com/a-b-street/abstreet/releases">https://github.com/a-b-street/abstreet/releases</a> and download the
latest <code>.zip</code> file for Windows, Mac, or Linux.</li>
</ol>
<p><img src="user/download.png" alt="download" /></p>
<ol start="2">
<li>Unzip the folder and run <code>play_abstreet.sh</code> or <code>play_abstreet.bat</code>. If you
get security warnings, see <a href="user/index.html#installing-the-game">here</a>.</li>
</ol>
<p><img src="user/run.png" alt="run" /></p>
<ol start="3">
<li>On the main title screen, click <code>Sandbox</code>. This starts in Seattle by
default, so change the map at the top.</li>
</ol>
<p><img src="user/change_map.png" alt="change_map" /></p>
<ol start="4">
<li>Choose USA, then Phoenix.</li>
</ol>
<p><img src="user/usa.png" alt="usa" /></p>
<ol start="5">
<li>You'll be prompted to download some files. It should be quick. After it's
done, click Phoenix again.</li>
</ol>
<p>You've now opened up the Tempe map!</p>
<h3 id="a-shortcut-and-improving-the-simulation-in-tempe"><a class="header" href="#a-shortcut-and-improving-the-simulation-in-tempe">A shortcut and improving the simulation in Tempe</a></h3>
<p>On Windows, edit <code>run_abstreet.bat</code> and change the last line to:</p>
<p><code>game.exe --dev data/system/us/phoenix/maps/tempe.bin --infinite_parking 1&gt; ..\\output.txt 2&gt;&amp;1</code></p>
<p>On Mac, edit <code>run_abstreet.sh</code> and change the last line to:</p>
<p><code>RUST_BACKTRACE=1 ./game --dev data/system/us/phoenix/maps/tempe.bin --infinite_parking 1&gt; ../output.txt 2&gt;&amp;1</code></p>
<p><code>--dev data/system/us/phoenix/maps/tempe.bin</code> will skip the title screen and
start on the Tempe map by default; this will save you lots of time.</p>
<p><code>--infinite_parking</code> disables the parking simulation. By default, there's an
unrealistic amount of people walking around Tempe just to reach the spot where
their car is parked. We don't have good data yet about on- and off-street
parking, so it's best to just make driving trips begin and end at buildings or
off the map, without a step to search for parking.</p>
<p>There are a bunch of other
<a href="user/../tech/dev/index.html#development-tips">startup parameters</a> you can pass here
too.</p>
<h2 id="importing-a-grid2demand-scenario"><a class="header" href="#importing-a-grid2demand-scenario">Importing a Grid2Demand scenario</a></h2>
<p>When you run <a href="https://github.com/asu-trans-ai-lab/grid2demand">https://github.com/asu-trans-ai-lab/grid2demand</a>, you get an
<code>input_agents.csv</code> file. You can import this into A/B Street as a scenario.</p>
<ol>
<li>Change the traffic from <code>none</code></li>
</ol>
<p><img src="user/pick_scenario.png" alt="pick_scenario" /></p>
<ol start="2">
<li>Click <code>import Grid2Demand data</code></li>
</ol>
<p><img src="user/grid2demand.png" alt="grid2demand" /></p>
<ol start="3">
<li>
<p>Choose your <code>input_agents.csv</code> file</p>
</li>
<li>
<p>A new scenario will be imported. Later you can launch this from the same
menu; the scenario will be called <code>grid2demand</code></p>
</li>
</ol>
<p><img src="user/scenario_again.png" alt="scenario_again" /></p>
<p>Grid2Demand needs a .osm file as input. The extract of Tempe that A/B Street
uses is at
<a href="https://abstreet.s3.us-east-2.amazonaws.com/dev/data/input/us/phoenix/osm/tempe.osm.gz">https://abstreet.s3.us-east-2.amazonaws.com/dev/data/input/us/phoenix/osm/tempe.osm.gz</a>.
Note the file is compressed.</p>
<h2 id="modifying-a-scenario"><a class="header" href="#modifying-a-scenario">Modifying a scenario</a></h2>
<p>You can transform a scenario before simulating it. This example will cancel all
walking and biking trips from the scenario, only leaving driving and public
transit.</p>
<ol>
<li>After loading a scenario, click <code>0 modifications to traffic patterns</code></li>
</ol>
<p><img src="user/mod_traffic.png" alt="mod_traffic" /></p>
<ol start="2">
<li>
<p>Click <code>Change trip mode</code></p>
</li>
<li>
<p>Select the types of trips that you want to transform, and change them to
cancel. Click <code>Apply</code>.</p>
</li>
</ol>
<p><img src="user/cancel.png" alt="cancel" /></p>
<h2 id="importing-vol2timing-data"><a class="header" href="#importing-vol2timing-data">Importing Vol2Timing data</a></h2>
<p><a href="https://github.com/asu-trans-ai-lab/Vol2Timing/">https://github.com/asu-trans-ai-lab/Vol2Timing/</a> produces <code>timing.csv</code> files
that you can import into A/B Street.</p>
<ol>
<li>
<p>Open the traffic signal editor for an intersection in A/B Street.</p>
</li>
<li>
<p>Click <code>Edit entire signal</code></p>
</li>
<li>
<p>Choose <code>import from a new GMNS timing.csv</code>, then pick your file.</p>
</li>
</ol>
<p>The import process isn't finished yet; some movements aren't matched properly,
some movements are incorrectly marked as protected, and no crosswalks are
imported yet. When you import, some error messages may be displayed, and others
might wind up printed to STDOUT (captured in <code>output.txt</code> on Windows).</p>
<p>If you want to import timing for more intersections in the same map, after
<code>Edit entire signal</code>, you should also have n option like
<code>import from GMNS C:\path\to\timing.csv</code>.</p>
<h3 id="debugging-timingcsv"><a class="header" href="#debugging-timingcsv">Debugging timing.csv</a></h3>
<p>Along with QGIS, you can also visualize <code>timing.csv</code> in A/B Street directly.</p>
<ol>
<li>
<p>From the title screen, choose <code>Internal dev tools</code>.</p>
</li>
<li>
<p>Change the map if necessary.</p>
</li>
<li>
<p>Click <code>view KML</code>.</p>
</li>
<li>
<p>Click <code>load KML file</code>, then choose your <code>timing.csv</code>.</p>
</li>
<li>
<p>Each movement is drawn in red. You can hover over a line-string to see its
attributes, and click to open all details.</p>
</li>
</ol>
<p><img src="user/gmns_debug.png" alt="gmns_debug" /></p>
<ol start="6">
<li>Using the key=value filter on the left, you can type in <code>no=3</code> to match
<code>stage_no=3</code> and easily check what movements belong to each stage.</li>
</ol>
<p><img src="user/gmns_stages.png" alt="gmns_stages" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="proposals"><a class="header" href="#proposals">Proposals</a></h1>
<p>The whole point of A/B Street is for people to suggest real fixes to their city,
so here's the list. In most cases, we're not yet able to use A/B Street itself
to illustrate the problem or solution -- but that shouldn't stop this list from
starting.</p>
<p>If you want to add anything here, contact us!</p>
<h2 id="seattle"><a class="header" href="#seattle">Seattle</a></h2>
<p>Disclaimer: currently this is just one person's (Dustin) list, so it reflects my
experiences and biases. South Seattle is conspicuously missing -- I need to go
explore more.</p>
<p>Safety problems biking:</p>
<ul>
<li>Airport Way southbound from ID to Georgetown. The right lane has a huge
shoulder; at least paint a bike lane</li>
<li>Broadway bike lanes missing between Highland and John</li>
<li>Partitioning off a lane of Aurora at Green Lake west, proposed by Seattle
Greenways</li>
<li>Bike lanes vanishing halfway up Harvard to Roanoke</li>
<li>The massive intersection where the Burke Gilman meets Corliss</li>
<li>No passing room on Fuhrman/Boyer</li>
</ul>
<p>Antagonistic traffic signal timing:</p>
<p>(Why are these important: they're hopefully a cheap change, and problems here
add up, making driving the most convenient option.)</p>
<ul>
<li>Northbound on 11th after the University Bridge</li>
<li>Turning left from 11th Ave NE to Ravenna</li>
<li>The double crosswalk at Montlake / Husky Stadium</li>
<li>Cherry and 12th; long cycle time for people crossing near Seattle University</li>
<li>Yesler and Broadway slow beg buttons</li>
<li>Unmarked beg buttons around Beacon Hill, and no bike actuators</li>
<li>Beg buttons along Interurban near Bitter Lake</li>
</ul>
<p>Larger changes:</p>
<ul>
<li>Cafe/bus street along University Ave</li>
<li>Eastlake cycle lanes</li>
<li><a href="https://twitter.com/QAGreenways/status/872554226752278528/photo/1">Madison Safety Corridor</a></li>
</ul>
<h2 id="london"><a class="header" href="#london">London</a></h2>
<p>There's some idea related to a
<a href="https://github.com/a-b-street/abstreet/issues/577">cycle-path on the A5</a></p>
<h2 id="template"><a class="header" href="#template">Template</a></h2>
<p>Over time, each idea will link to a full write-up. That page can have any
format, but I imagine this basic structure is useful:</p>
<ul>
<li>Describe the problem
<ul>
<li>A clear map showing the scope of the issue</li>
<li>Include pictures and videos from a physical survey, or maybe annotated
satellite imagery</li>
<li>Use A/B Street to demonstrate the problem for individual people or in
aggregate</li>
</ul>
</li>
<li>Describe the proposed solution
<ul>
<li>Ideally A/B Street is useful for visualizing the change, and measuring
quantitative results.</li>
<li>Explain any limits with the modelling</li>
</ul>
</li>
<li>Give context on the problem
<ul>
<li>Is this being discussed anywhere -- often on Twitter?</li>
<li>Are there other proposals or write-ups?</li>
</ul>
</li>
<li>Give arguments against the proposed solution
<ul>
<li>Unintended consequences, prohibitive costs, alternate routes available</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="lake-washington-blvd-stay-healthy-street"><a class="header" href="#lake-washington-blvd-stay-healthy-street">Lake Washington Blvd Stay Healthy Street</a></h1>
<p><em>Draft, updated May 7, 2020 by Dustin Carlino (<a href="proposals/dabreegster@gmail.com">dabreegster@gmail.com</a>)</em></p>
<p>In April 2020, Seattle Department of Transportation started rolling out
<a href="https://sdotblog.seattle.gov/2020/04/16/announcing-stay-healthy-streets/">Stay Healthy Streets</a>,
restricting roads to through-traffic to give people walking and biking more
space for social distancing.
<a href="http://seattlegreenways.org/socialdistancingstreets/">Seattle Neighborhood Greenways</a>
soon proposed extending this to a
<a href="https://drive.google.com/open?id=1HQMnagRf8EbS1nouqCMLl4LZr0QE8VrC&amp;usp=sharing">130-mile network</a>.</p>
<p>Selecting the streets requires some planning:</p>
<blockquote>
<p>These streets were selected to amplify outdoor exercise opportunities for
areas with limited open space options, low car ownership and routes connecting
people to essential services and food take out. We also ensured street
closures did not impact newly opened food pick up loading zones, parking
around hospitals for service for health care professionals, and bus routes.</p>
</blockquote>
<p>I've spent the last two years building <a href="https://abstreet.org">A/B Street</a>,
software to explore the impacts of changes like this on different modes of
transportation. So, let's try implementing part of the proposed network and see
what happens!</p>
<h2 id="lake-washington-blvd"><a class="header" href="#lake-washington-blvd">Lake Washington Blvd</a></h2>
<p>Let's start with one part of the proposal, closing Lake Washington Blvd to cars
through the Arboretum. There's already a multi-use trail alongside this stretch,
but its width makes it difficult to maintain 6 feet from people. There are some
parking lots that become inaccessible with this proposal, but they're currently
closed anyway.</p>
<p><img src="proposals/edits.gif" alt="edits" /></p>
<h3 id="first-attempt"><a class="header" href="#first-attempt">First attempt</a></h3>
<iframe width="560" height="315" src="https://www.youtube.com/embed/PU0iT-_3-es" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
<p>Let's get started! If you want to follow along,
<a href="proposals/../user/index.html">install A/B Street</a>, open sandbox mode, and switch the map to
Lake Washington corridor. Zoom in on the southern tip of the Arboretum and hop
into edit mode. We can see Lake Washington Blvd just has one travel lane in each
direction here. Click each lane, convert it to a bike lane, and repeat north
until Foster Island Road.</p>
<p>When we leave edit mode, the traffic simulation resets to midnight. Nothing
really interesting happens until 5 or 6am, so we'll speed up time. Watching the
section of road we edited, we'll only see pedestrians and bikes use this stretch
of road. If we want, we can click an individual person and follow along their
journey.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/LSCHeDi5484" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
<p>Something's weird though. There's lots of traffic cutting northbound through the
neighborhood, along 29th, Ward, and 28th. We can open up the throughput layer to
find which roads have the most traffic. More usefully, we can select &quot;compare
before edits&quot; to see what roads are getting more or less traffic because of the
road we modified. As expected, there's much less traffic along Lake Wash Blvd,
but it's also clear that lots of cars are now cutting through 26th Ave E.</p>
<h3 id="traffic-calming"><a class="header" href="#traffic-calming">Traffic calming</a></h3>
<iframe width="560" height="315" src="https://www.youtube.com/embed/qAf5IAMbpcU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
<p>Let's say you want to nudge traffic to use 23rd Ave, the nearest north/south
arterial, instead. (A/B Street is an unopinionated tool; if you have a different
goal in mind, try using it for that instead.) In this simulation, drivers pick
the fastest route, so we could try lowering speed limits or make some of the
residential streets connecting to Madison one-way, discouraging through-traffic.
In reality, the speed limit changes could be implemented through
<a href="https://streetsillustrated.seattle.gov/design-standards/trafficcalming/">traffic calming</a>
or cheap, temporary alternatives.</p>
<h2 id="next-steps-1"><a class="header" href="#next-steps-1">Next steps</a></h2>
<p>I'm working to model &quot;local access only&quot; roads in A/B Street, and I'll describe
how to measure the impact on travel times. Stay tuned to see more of the
<a href="https://drive.google.com/open?id=1HQMnagRf8EbS1nouqCMLl4LZr0QE8VrC&amp;usp=sharing">proposed network</a>
simulated, and get in touch if you'd like to help out!</p>
<div style="break-before: page; page-break-before: always;"></div><div class="post-header">
    <div class="post-header-background" style="background-image:url(../assets/broadmoor/gate-banner.jpg)">
        <div class="post-header-overlay">
            <h1 class="post-header-text">Liberate Broadmoor</h1>
        </div>
    </div>
</div>
<h1 id="allow-bike-and-foot-traffic-through-broadmoor"><a class="header" href="#allow-bike-and-foot-traffic-through-broadmoor">Allow bike and foot traffic through Broadmoor</a></h1>
<p><em>posted July 1, 2021 by <a href="https://twitter.com/ikawe">Michael Kirk</a></em> 
<a href="proposals/../project/team.html">meet the A/B Street team</a></p>
<style>
// mobile-breakpoint = 569px + --side-bar-width (300px);

#site-header {
    font-weight: 600;
    background: #f0f0f0;
    padding:12px 16px
}

#site-header-title a {
    text-decoration: none;
    font-size: 16px;
    color:#000
}

.post-header {
    position:relative;
    /* hack: mdbook doesnt support the full bleed layout we actually want, so just do something that looks decent. */
    margin-left: -15px;
    margin-right: -15px;
}

.post-header-background {
    position: relative;
    background: black;
    width: 100%;
    background-size: cover;
    background-position:center
}

.post-header-overlay {
    padding-top: 80px;
    background-color:rgba(0, 0, 0, 0.6)
}

@media (min-width: 569px) {
    .sidebar-hidden .post-header-overlay {
        padding-top:280px
    }
}

@media (min-width: 869px) {
    .sidebar-visible .post-header-overlay {
        padding-top:280px
    }
}

.post-header-text {
    color: white;
    line-height: 50px;
    font-size: 46px;
    margin: 0 16px;
    padding-bottom:16px
}

@media (min-width: calc(816px)) {
    .post-header-text {
        margin-left: auto;
        margin-right: auto;
        max-width:800px;
        /* hack: mdbook doesnt support the full bleed layout we actually want, so just do something that looks decent. */
        margin-left: 15px;
    }
}

.post-subtitle {
    margin-left: auto;
    margin-right: auto;
    max-width: 800px;
    font-style:italic
}

.post-body {
    margin-left: auto;
    margin-right: auto;
    max-width:800px
}

.media-box {
    background-color: #f0f0f0;
    color: #000;
    padding-bottom: 16px;
    margin-bottom: 16px;
    margin-top:16px
}

.media-box img {
    width:100%;
    object-fit: cover;
}

.media-box .video-container {
    width: 100%;
    position:relative
}

.media-box .embedded-video, .media-box video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height:100%
}

.media-box .chart-header {
    margin-top: 0;
    padding-top: 8px;
    margin-bottom: 8px;
    margin-left:16px
}

.media-box img.chart {
    padding: 8px;
    width: calc(100% - 16px);
    object-fit:contain
}

.media-box p {
    margin: 8px 16px 0 16px;
    padding:0
}

.media-box .photo-attribution {
    color: #888;
    font-size:16px
}

@media (min-width: 569px) {
    .sidebar-hidden .wrap-two {
        display: flex;
        flex-direction: row;
        justify-content:space-between
    }

    .sidebar-hidden .wrap-two .media-box:first-child {
        margin-right: 16px
    }

    .sidebar-hidden .wrap-two .media-box {
        width: 50%
    }

    .sidebar-hidden .wrap-two img {
        max-height:300px
    }
}

@media (min-width: 869px) {
    .sidebar-visible .wrap-two {
        display: flex;
        flex-direction: row;
        justify-content:space-between
    }

    .sidebar-visible .wrap-two .media-box:first-child {
        margin-right:16px
    }

    .sidebar-visible .wrap-two .media-box {
        width:50%
    }

    .sidebar-visible .wrap-two img {
        max-height:300px
    }
}


@media (max-width: 569px) {
    .sidebar-hidden .media-box {
        /* hack: mdbook doesnt support the full bleed layout we actually want, so just do something that looks decent. */
        // left: 50%;
        // margin-left: -50vw;
        // margin-right: -50vw;
        // max-width: 100vw;
        // position: relative;
        // right: 50%;
        // width:100vw
    }
}

@media (max-width: 869px) {
    .sidebar-visible .media-box {
        /* hack: mdbook doesnt support the full bleed layout we actually want, so just do something that looks decent. */
        // left: 50%;
        // margin-left: -50vw;
        // margin-right: -50vw;
        // max-width: 100vw;
        // position: relative;
        // right: 50%;
        // width:100vw
    }
}

blockquote {
    border-left: 4px solid #CCC;
    padding-left: 8px;
    margin-left: 8px
}

</style>
<p>You could be forgiven for not knowing much about the Broadmoor neighborhood in
Seattle  that's kind of by design. We're going to explore how it could
become a valuable link for people walking and biking in Seattle, using the
travel simulation game <a href="proposals/../software/abstreet.html">A/B Street</a>.</p>
<div class="media-box">
<img alt="a map of part of Seattle, highlighting the Broadmoor neighborhood, about 2.5 miles northeast of downtown." src="proposals/../assets/broadmoor/seattle-overview.png">
<p>Broadmoor lies a few miles northeast of Downtown Seattle, sandwiched between the
<a href="https://botanicgardens.uw.edu/washington-park-arboretum/">delightful Washington Park Arboretum</a>
and the Madison Park neighborhood.</p>
</div>
<p>Adjacent to Broadmoor, the Madison Park and Washington Park neighborhoods offer
grocery stores, a hardware store, dining, and recreational destinations.</p>
<div class="media-box">
<img src="proposals/../assets/broadmoor/madison-park-beach.jpg" alt="a beach full of swimmers, paddle boards, and sun bathers" />
<p>Madison Park Beach on Lake Washington is another notable neighborhood
destination.</p>
<p><em class="photo-attribution">photo courtesy of the City of Seattle</em></p>
</div>
<p>If you were headed to one of these destinations today, and coming from, say
Montlake or from the University District via the University bridge, it would
almost certainly require you to take a long stretch walking or biking down East
Madison Ave. This particular stretch of road is known to be
<a href="https://www.seattle.gov/transportation/projects-and-programs/safety-first/vision-zero/resources/bicycle-level-of-traffic-stress">high stress for people on bikes</a>,
and can be an equally harrowing walk for those on foot.</p>
<div class="wrap-two">
<div class="media-box">
<img
  src="../assets/broadmoor/proposal-overview.png"
  alt="a proposed route, cutting through the arboretum and Broadmoor neighborhood, as opposed to a longer route possible today" />
<p>If people were instead allowed to walk or ride through Broadmoor, they could
expect shorter trips on quieter streets.</p>
</div>
<div class="media-box">
<img
  class="chart"
  src="../assets/broadmoor/elevation-profiles.png"
  alt="two elevation profiles, showing a gentler climb through Broadmoor" />
<p>Looking at elevation, the green route along Madison Ave climbs an 8% grade
 quite steep! The blue route through Broadmoor offers a shorter, less
steep, route.<sup class="footnote-reference"><a href="#elevation data">1</a></sup></p>
</div>
</div>
<p>So why don't people take this seemingly superior route through Broadmoor?
Apologies if you already have the context, but a greatly abridged history lesson
is in order for those who don't.</p>
<p>Up until about 200 years ago, what we refer to as Broadmoor, like much land near
the Puget Sound, was a forest inhabited by the Duwamish people. And, like much
land near the Puget Sound, it was cut clear, and the timber sold off by a mill
company. The owners of this particular parcel were the Puget Mill Company. After
logging the parcel, they split it, not quite in half. The smaller western half
was given to the city, and gardened into what is now enjoyed by the public as
the Washington Park Arboretum. The General Manager from the very same Puget Mill
Company was then allowed to develop the larger eastern half of the parcel into
that venerable American trifecta: a golf course / country club / private gated
residential community.<sup class="footnote-reference"><a href="#madison_park_remembered">2</a></sup></p>
<p>So, Broadmoor was initially built as a gated enclave impassible to all but a
select few of the leisure class. A century later, how much has changed?</p>
<div class="wrap-two">
<div class="media-box">
<img src="proposals/../assets/broadmoor/dead-end.jpg" alt="a sidewalk ends and a road turns where a large hedge looms" />
<p>Try to walk through or around Broadmoor today, and you'll find yourself
repeatedly redirected or inexplicably dead-ended.</p>
</div>
<div class="media-box">
<img src="proposals/../assets/broadmoor/front-gate.jpg" alt="a car waiting for entry at a security gate" />
<p>There are gates on the north and south ends of Broadmoor. Both are guarded by
uniformed security.</p>
</div>
</div>
<p>Broadmoor is an obstacle to people walking and biking to desirable destinations
on either side of it. But what if things were different? What if we allowed
people on bikes, on foot, and in wheelchairs <em>through</em> Broadmoor rather than
diverting them down Madison Ave?</p>
<h3 id="cui-bono"><a class="header" href="#cui-bono">Cui bono</a></h3>
<p>To get an intuition for the benefits that opening up Broadmoor might have, we
turn to <a href="https://abstreet.org">A/B Street</a>. If you have an idea for a change in
your city streets, A/B Street can visualize that change and measure its impacts.</p>
<p>If you've never seen A/B Street before, here's what it looks like:</p>
<div class="media-box">
<img src="proposals/../assets/broadmoor/abstreet-overview.gif" alt="Screencast of the A/B
Street travel simulator, showing an overhead street map view, roughly centered
around the Washington Park Arboretum, with hundreds of dots sliding along the
streets. An adjustable playback speed is shown, panning and zooming in reveals
the moving dots are cartoon people and vehicles getting around the streets of
Seattle. Madison Ave looks busy.">
<p>A/B Street uses public data sources, like
<a href="https://openstreetmap.org">OpenStreetMap</a> and Seattle's
<a href="https://www.psrc.org/activity-based-travel-model-soundcast">Soundcast Travel Demand Model</a>
to simulate travel in the city. You can gain insight into your proposal by
comparing metrics like travel duration and risk exposure as they are affected by
your proposal.</p>
</div>
<p>In A/B Street, allowing people to walk and cycle through Broadmoor, is a matter
of clicks. Then, A/B Street simulates how this change affects people's travel.
You can watch as each individual person goes about their day. If given new
circumstances, people will be able to make new, hopefully better, choices for
themselves.</p>
<p>To gain a little intuition for the benefits of our proposal, let's follow one
person in A/B Street on her morning walk from Madison Park to the University
District, comparing the trip before and after being allowed to walk through
Broadmoor.</p>
<div class="media-box">
<!--
Encode the aspect ratio of the video in "padding-bottom" value. Otherwise it'll
show up letter boxed.
-->
<div class="video-container" style="padding-top: 56.25%" >
  <video controls alt="A person from the simulation exits their house in Madison park for a long walk towards the Montlake Bridge. Two routes are shown, the original route down Madison shows busy streets and several alerts as the pedestrian walks down a long stretch of Madison. The new proposed route, through Broadmoor is much calmer. The two routes converge just south of the Montlake Bridge, where the trip ends.">
    <source src="../assets/broadmoor/individual-trip-comparison.mp4" type="video/mp4">
    <source src="../assets/broadmoor/individual-trip-comparison.webm" type="video/webm">
    Sorry, your browser does not support this website's videos.
  </video>
</div>
<p>Some of the highlights of her trip include a much calmer walk through Broadmoor
as opposed to crossing along the many busy intersections on Madison Ave.</p>
</div>
<h3 id="beyond-anecdotes"><a class="header" href="#beyond-anecdotes">Beyond anecdotes</a></h3>
<p>The morning commute shown above is good for story telling. It's an intuitive
anecdote for why this could be a worthwhile proposal. However, travel behavior
is highly interdependent. Every choice one person makes has potential ripple
effects for others.</p>
<p>We need more than a handful of individual examples. A/B Street uses Seattle's
<a href="https://www.psrc.org/activity-based-travel-model-soundcast">Soundcast travel demand model</a>
to generate a realistic set of workday trips for the given area  for this
area, that's about 75,000 trips. A/B Street includes tools to analyze each of
these trips and aggregate overall travel experiences  allowing us to see
beyond anecdotes to visualize trends across the map. Let's take a look at how
overall trip times and some safety metrics are affected by this proposal.</p>
<h3 id="trip-durations"><a class="header" href="#trip-durations">Trip Durations</a></h3>
<div class="wrap-two">
<div class="media-box">
  <h4 class="chart-header">Cars: Individual Trips</h4>
  <img class="chart" src="proposals/../assets/broadmoor/broadmoor-driving-duration-scatter.png" />
<p>Comparing each driver's trip time before vs. after this change, some trips were
a little faster, while others a little slower.</p>
<p>There appears to be a small positive bias, perhaps due to less contention on
Madison, but overall it's mostly a wash for drivers, which is a boring, but
useful validation.</p>
</div>
<div class="media-box">
  <h4 class="chart-header">Walking and Biking: Individual Trips</h4>
  <img class="chart" src="proposals/../assets/broadmoor/broadmoor-ped-bike-duration-scatter.png" />
<p>It gets more interesting for people walking and cycling. Especially for longer
trips, people get where they're going more quickly after being allowed access
through Broadmoor, with few trips experiencing a slowdown.</p>
</div>
</div>
<p>Apart from the benefits conveyed to pedestrians and cyclists, these charts also
nicely show the interdependent nature of travel. For example, even though
overall travel time and the routes available to drivers didn't change much,
individual drivers did experience downstream effects of pedestrians and
bicyclists making different choices. This interdependence is fertile soil for
unintended consequences, which is why having tools to measure <em>overall</em> impact
is essential.</p>
<h3 class="chart-header">Time Saved / Lost</h3>
<p>The dot charts above are helpful for seeing the shape of some trends, but it's
hard to quantify the improvements. These next charts compare the total amount of
time saved across all trips with the total amount of time lost.</p>
<div class="wrap-two">
<div class="media-box">
  <h4 class="chart-header">Cars: Overall</h4>
  <img class="chart" src="proposals/../assets/broadmoor/broadmoor-driving-duration-histogram.png" />
<p>Here we can confirm the small bias for faster car trips, but not much more time
is gained than was lost by others, implying a mostly neutral change across all
people driving.</p>
</div>
<div class="media-box">
  <h4 class="chart-header">Walking and Biking: Overall</h3>
  <img class="chart" src="proposals/../assets/broadmoor/broadmoor-ped-bike-duration-histogram.png" />
<p>A clearer trend emerges for people walking and biking  many long trips
were substantially faster given access to Broadmoor.</p>
</div>
</div>
<p>Trip duration is worth considering as a gut check to make sure a proposal seems
reasonable, and this proposal indeed has some favorable evidence for faster
trips, but trip duration shouldn't be the only, or even most important, effect
to consider. In particular, there are important safety metrics we can measure
with A/B Street which we'll dive into next.</p>
<h2 id="safety"><a class="header" href="#safety">Safety</a></h2>
<p>All people should be able to get where they're going safely. As our most
vulnerable road users, people walking, bicycling, and those using mobility aids
deserve extra consideration.</p>
<p>There is an increasing effort to not only look at previous crash sites, but also
to consider the <em>types</em> of places where crashes are likely to occur. By
prioritizing places based on their similarity to crash sites, we can prevent or
mitigate future crash sites before someone is hurt. In this vein, last year
Seattle DOT released a
<a href="https://www.seattle.gov/documents/Departments/SDOT/VisionZero/SDOT_Bike%20and%20Ped%20Safety%20Analysis_Ph2_2420(0).pdf">safety study</a>
analyzing which physical roadway features that are associated with an increased
risk of traffic-related death or serious injury.</p>
<p>For example:</p>
<blockquote>
<p>Right hook crash risk tends to be higher on arterial streets. [...] This could
be due to the overall complexity of the intersection and/or the width of the
intersection.<sup class="footnote-reference"><a href="#sdot safety study">3</a></sup></p>
</blockquote>
<p>By classifying these risky features, A/B Street can keep tabs as people in the
simulation are exposed to these risks. You can follow an individual's trip and
see what risks they are exposed to, or, for a macro view, you can aggregate and
identify map-wide hot spots for specific problems. Using A/B Street, you can
compare how a proposal affects these metrics.</p>
<div class="wrap-two">
<div class="media-box">
<h4 class="chart-header">Identifying Hotspots</h4>
<img class="chart" 
  src="../assets/broadmoor/montlake-520-hotspot.png" 
  alt="a heatmap covering about a square mile of streets south of the Montlake
  Bridge, with hotspots on the intersections leading up to the bridge"/>
<p>A/B Street's &quot;problem&quot; view helps you identify risk exposure hotspots.</p>
<p>These streets south of the Montlake Bridge exhibit several risk factors,
including wide streets with fast moving vehicles and many-legged intersections.</p>
<p>Because the Montlake Bridge is one of only a couple plausible connections
between the University District and central Seattle, it has relatively high bike
and foot traffic.</p>
<p>The inherent riskiness of these <em>kinds</em> of streets, paired with the high
<em>number</em> of people using them, results in a risk exposure hotspot worth extra
scrutiny.</p>
</div>
<div class="media-box">
<h4 class="chart-header">Walking: Arterial Intersections</h4>
<img class="chart" 
  src="../assets/broadmoor/broadmoor-ped-arterial-crossings.png" 
  alt="2-D grid chart, bucketing trips by trip duration on the x-axis and
  number of arterial intersections crossed on the y-axis, showing a clear
  postive bias for hundreds of walking tris, especially for longer trips. Just
  a few trips were negatively affected."/>
<p>Walking across arterial (wide, busy) intersections presents an increased risk of
death or severe injury. This chart groups walking trips by duration and by how
many fewer (or more) arterial intersections were crossed.</p>
<p>More than 800 walking trips had fewer arterial intersections to cross when they
were allowed to pass through Broadmoor.</p>
<p>The chart shows that medium-to-long trips were most affected. For example, <em>518</em>
people walking <em>30-60</em> minutes had <em>1-6</em> fewer arterial (major) intersections to
cross.</p>
</div>
</div>
<div class="wrap-two">
<div class="media-box">
<h4 class="chart-header">Biking: Car Wants to Overtake</h4>
<img class="chart" 
  src="../assets/broadmoor/alerts-on-madison.gif" 
  alt="animated GIF showing an aerial map view of a simulated cyclist biking
  down the street. When a faster moving car pulls up behind them, a thought
  bubble with an alert symbol appears above the cyclist." />
<p>A 2018 study found that most cyclists who died in single-vehicle crashes were
struck by the front of the vehicle<sup class="footnote-reference"><a href="#fars_2018">4</a></sup>.</p>
<p>In shared lanes, a common risk that could lead to this type of collision is when
a faster moving car pulls up too close behind a cyclist. This is uncomfortable
for both the person on the bike and the person driving. Having the option to
ride through Broadmoor gives some cyclists the option to avoid sharing a lane
with cars on busy Madison.</p>
</div>
<div class="media-box">
<h4 class="chart-header">Biking: Complex Intersections</h4>
<img class="chart" src="proposals/../assets/broadmoor/broadmoor-bike-complex-crossings.png" />
<p>Simple intersections are where just two roads cross. Passing through a complex
intersection, where more than two roads cross, has an increased risk of death or
severe injury for people on bikes<sup class="footnote-reference"><a href="#sdot safety study">3</a></sup>. Being able to cycle
through Broadmoor was a strict improvement for this metric.</p>
</div>
</div>
<p>This was a quick overview of some of the tools A/B Street has for measuring
baseline safety metrics and seeing how your proposal affects them. We're
continuing to add metrics and visualizations, but we'd love to know if there are
any you'd specifically like to see.</p>
<h3 id="whats-next"><a class="header" href="#whats-next">What's next?</a></h3>
<p>Using a tool like <a href="https://www.abstreet.org">A/B Street</a> is absolutely not a
definitive evaluation. It's intended to get you started tinkering.</p>
<p>By identifying and measuring things we care about, and simulating how they
change, we can quickly gain some visual intuition and quantified evidence to
validate (or refute) assumptions in our proposal, and hopefully it's a little
fun too.</p>
<p>Here we've shown there is at least some evidence that letting people walk and
bike through the Broadmoor neighborhood in Seattle could result in faster,
safer, and more pleasant trips without unduly impacting other traffic.</p>
<!-- TODO: it'd be nice to link to something like `https://abstreet.org/web` or even http://abstreet.s3-website.us-east-2.amazonaws.com/latest/abstreet.html rather than a specific version -->
<p>If you'd like to see for yourself what the Broadmoor proposal looks like, give
it a try,
<a href="http://abstreet.s3-website.us-east-2.amazonaws.com/0.2.51/abstreet.html?--dev&amp;system/us/seattle/scenarios/arboretum/weekday.bin&amp;--edits=broadmoor%20access">you can run A/B Street in your browser</a>
or <a href="proposals/../user/index.html">download the desktop client</a>.</p>
<p>Or, if you have a different idea for improving how we get around, in Seattle or
elsewhere, give it a go! Please contact us on
<a href="https://twitter.com/CarlinoDustin">twitter</a> or
<a href="https://github.com/a-b-street/abstreet/issues/new">github</a> if you have any
questions or issues.</p>
<h2 id="caveats"><a class="header" href="#caveats">Caveats</a></h2>
<p>It bears repeating: A map is not the territory. The signifier is not the
signified. A simulation is not, and can never be, the actual world.</p>
<p>But like a good map or a good metaphor, a good simulation can be a useful tool
for learning and advocacy. Beyond the shortcomings inherent to any such semiotic
excursion, there are a couple of limitations we wanted to call out in this case
study in particular.</p>
<h3 id="data-sources"><a class="header" href="#data-sources">Data sources</a></h3>
<p>The underlying road network is inferred from
<a href="https://www.openstreetmap.org/#map=14/47.6337/-122.2941">OpenStreetMap</a> (OSM),
a global community of mapping enthusiasts whose software and data is freely
available. Using OSM, A/B Street is already usable in cities all over the globe.
However, as a freely available community maintained project, OSM comes with no
data quality guarantees, and local mapping conventions can vary. Not everyone
using OSM is interested in the incredible level of detail required to run a
travel simulation. This situation is ever improving though, and we'd love to
have you give A/B Street a try, wherever you are.</p>
<p>A/B Street leverages Seattle's
<a href="https://www.psrc.org/activity-based-travel-model-soundcast">Soundcast travel demand model</a>
to generate the list of trips for each person in A/B Street. Specifically, for
each person, Soundcast is responsible for saying where they need to be and at
what time. Soundcast is also responsible for what mode the person takes -
whether they walk, drive, cycle, etc.</p>
<h3 id="modeshift"><a class="header" href="#modeshift">Modeshift</a></h3>
<p>Intuitively if you make driving more attractive, more people will drive.
Similarly if you make a mode like cycling, walking, or transit more attractive,
more people will choose that mode.</p>
<p>A/B Street doesn't currently account for this shifting of modes. It naively
assumes that people will go about their day, always choosing to drive or walk or
cycle regardless of what changes you make to the city. Mode shift is a real and
important behavior that we are excited to implement and measure in A/B Street in
the future.</p>
<p>There's tons of other improvements in the works. Follow
<a href="https://twitter.com/CarlinoDustin">@CarlinoDustin</a> for updates, and let us know
what you'd like to see.</p>
<h2 id="footnotes"><a class="header" href="#footnotes">Footnotes</a></h2>
<!-- prettier-ignore-start -->
<div class="footnote-definition" id="elevation data"><sup class="footnote-definition-label">1</sup>
<p>Elevation data from <a href="http://pugetsoundlidar.ess.washington.edu/lidardata/restricted/projects/2016king_county.html">King County LIDAR</a>. Thanks to <a href="https://github.com/eldang/elevation_lookups">Eldan Goldenberg</a> for processing this data.</p>
</div>
<div class="footnote-definition" id="madison_park_remembered"><sup class="footnote-definition-label">2</sup>
<p>Jane Powell Thomas, Madison Park Remembered (J.P. Thomas, 2004)</p>
</div>
<div class="footnote-definition" id="sdot safety study"><sup class="footnote-definition-label">3</sup>
<p>Seattle Department of Transportation's safety study:
<a href="https://www.seattle.gov/documents/Departments/SDOT/VisionZero/SDOT_Bike%20and%20Ped%20Safety%20Analysis_Ph2_2420(0).pdf">City of Seattle Bicycle and Pedestrian Safety Analysis Phase2</a></p>
</div>
<div class="footnote-definition" id="fars_2018"><sup class="footnote-definition-label">4</sup>
<p>NHTSA | National Highway Traffic Safety Administration - <a href="https://crashstats.nhtsa.dot.gov/Api/Public/ViewPublication/812884">2018 Traffic Safety Facts</a></p>
</div>
<!-- prettier-ignore-end-->
<div style="break-before: page; page-break-before: always;"></div><h1 id="technical-details"><a class="header" href="#technical-details">Technical details</a></h1>
<p>This section of the site is intended for anybody who wants to understand or work
on A/B Street's internals.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="developer-guide"><a class="header" href="#developer-guide">Developer guide</a></h1>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting started</a></h2>
<p>You will first need:</p>
<ul>
<li>Stable Rust, at least 1.54. <a href="https://www.rust-lang.org/tools/install">https://www.rust-lang.org/tools/install</a>.
<ul>
<li>On Windows, you may need
<a href="https://visualstudio.microsoft.com/en/downloads/">Visual Studio 2019</a>.</li>
</ul>
</li>
<li>On Linux,
<code>sudo apt-get install libasound2-dev libxcb-shape0-dev libxcb-xfixes0-dev libpango1.0-dev libgtk-3-dev</code>
or the equivalent for your distro</li>
</ul>
<p>One-time setup:</p>
<ol>
<li>
<p>Download the repository:
<code>git clone https://github.com/a-b-street/abstreet.git</code></p>
</li>
<li>
<p>Grab the minimal amount of data to get started:
<code>cargo run --bin updater -- --minimal</code></p>
</li>
<li>
<p>Run the game: <code>RUST_BACKTRACE=1 cargo run --bin game --release</code>. On Windows,
set environment variables like this:
<code>set RUST_BACKTRACE=1 &amp;&amp; cargo run --bin game --release</code></p>
</li>
</ol>
<h2 id="development-tips"><a class="header" href="#development-tips">Development tips</a></h2>
<ul>
<li><a href="https://a-b-street.github.io/abstreet/rustdoc/map_model/index.html">Generated API documentation</a></li>
<li>Compile faster by just doing <code>cargo run</code>. The executable will have debug stack
traces and run more slowly. You can do <code>cargo run --release</code> to build in
optimized release mode; compilation will be slower, but the executable much
faster.</li>
<li>Some in-game features are turned off by default or don't have a normal menu to
access them. The list:
<ul>
<li>To toggle developer mode: press <strong>Control+S</strong> in game, or
<code>cargo run -- --dev</code></li>
<li>To warp to an object by numeric ID: press <strong>Control+j</strong></li>
<li>To enter debug mode with all sorts of goodies: press <strong>Control+D</strong></li>
</ul>
</li>
<li>You can start the game in different modes using flags:
<ul>
<li><code>cargo run --bin game -- --dev data/system/us/seattle/maps/downtown.bin</code>
starts on a particular map</li>
<li><code>cargo run --bin game -- data/system/us/seattle/scenarios/downtown/weekday.bin</code>
starts with a scenario (which is tied to a certain map)</li>
<li><code>cargo run --bin game -- --challenge=trafficsig/tut2</code> starts on a particular
challenge. See the list of aliases by passing in a bad value here.</li>
<li><code>cargo run --bin game -- data/player/saves/us/seattle/montlake/no_edits_unnamed/00h00m20.3s.bin</code>
restores an exact simulation state. Savestates are found in debug mode
(<strong>Control+D</strong>) -- they're probably confusing for the normal player
experience, so they're hidden for now.</li>
<li><code>cargo run --bin game -- --tutorial=12</code> starts somewhere in the tutorial</li>
<li>Adding <code>--edits='name of edits'</code> starts with edits applied to the map.</li>
</ul>
</li>
</ul>
<h2 id="downloading-more-cities"><a class="header" href="#downloading-more-cities">Downloading more cities</a></h2>
<p>Most easily, you can download new cities using the UI directly.</p>
<p>As data formats change over time, things in the <code>data/</code> directory not under
version control will get out of date. At any time, you can run
<code>cargo run --bin updater</code> from the main repository directory to update only the
files that have changed.</p>
<p>You can also opt into downloading updates for more cities by editing
<code>data/player/data.json</code>. If you want to opt into absolutely everything:
<code>cargo run --bin updater -- --opt-into-all &gt; data/player/data.json</code></p>
<h2 id="building-map-data"><a class="header" href="#building-map-data">Building map data</a></h2>
<p>You can skip this section if you're just touching code in <code>game</code>, <code>widgetry</code>,
and <code>sim</code>.</p>
<p>To run all pieces of the importer, you'll need some extra dependencies:</p>
<ul>
<li><code>osmconvert</code>: See <a href="https://wiki.openstreetmap.org/wiki/Osmconvert#Download">https://wiki.openstreetmap.org/wiki/Osmconvert#Download</a> or
<a href="https://github.com/interline-io/homebrew-planetutils#installation">https://github.com/interline-io/homebrew-planetutils#installation</a> for Mac</li>
<li><code>libgdal-dev</code>: See <a href="https://gdal.org">https://gdal.org</a> if your OS package manager doesn't have
this. If you keep hitting linking errors, then just remove
<code>--features scenarios</code> from <code>import.sh</code>. You won't be able to build the
Seattle scenarios.</li>
<li>Standard Unix utilities: <code>unzip</code> and <code>gunzip</code></li>
</ul>
<p>The first stage of the importer, <code>--raw</code>, will download input files from OSM,
King County GIS, and so on. If the mirrors are slow or the files vanish, you
could fill out <code>data/config</code> and use the <code>updater</code> described above to grab the
latest input.</p>
<p>Building contraction hierarchies for pathfinding occurs in the --map stage. It
can take a few minutes for larger maps. To view occasional progress updates, you
can run the importer with</p>
<pre><code>RUST_LOG=&quot;fast_paths=debug/contracted node [0-9]+0000 &quot;
</code></pre>
<p>You can rerun specific stages of the importer:</p>
<ul>
<li>If you're modifying the initial OSM data -&gt; RawMap conversion in
<code>convert_osm</code>, you need <code>./import.sh --raw --map</code>.</li>
<li>If you're modifying <code>map_model</code> but not the OSM -&gt; RawMap conversion, then you
just need <code>./import.sh --map</code>.</li>
<li>If you're modifying the demand model for Seattle, you can add <code>--scenario</code> to
regenerate.</li>
<li>By default, all maps are regenerated. You can also specify a single map:
<code>./import.sh --map downtown</code>.</li>
<li>By default, Seattle is assumed as the city. You have to specify otherwise:
<code>./import.sh --city=us/detroit --map downtown</code>.</li>
</ul>
<p>You can also make the importer <a href="tech/dev/../../user/new_city.html">import a new city</a>.</p>
<h2 id="understanding-stuff"><a class="header" href="#understanding-stuff">Understanding stuff</a></h2>
<p>The docs listed at <a href="https://github.com/a-b-street/abstreet#documentation">https://github.com/a-b-street/abstreet#documentation</a>
explain things like map importing and how the traffic simulation works.</p>
<h3 id="code-organization"><a class="header" href="#code-organization">Code organization</a></h3>
<p>If you're going to dig into the code, it helps to know what all the crates are.
The most interesting crates are <code>map_model</code>, <code>sim</code>, and <code>game</code>.</p>
<p>Constructing the map:</p>
<ul>
<li><code>convert_osm</code>: extract useful data from OpenStreetMap and other data sources,
emit intermediate map format</li>
<li><code>kml</code>: extract shapes from KML and CSV shapefiles</li>
<li><code>map_model</code>: the final representation of the map, also conversion from the
intermediate map format into the final format</li>
<li><code>map_editor</code>: GUI for modifying geometry of maps and creating maps from
scratch. pretty abandoned as of June 2020</li>
<li><code>importer</code>: tool to run the entire import pipeline</li>
<li><code>updater</code>: tool to download/upload large files used in the import pipeline</li>
</ul>
<p>Traffic simulation:</p>
<ul>
<li><code>sim</code>: all of the agent-based simulation logic</li>
<li><code>headless</code>: tool to run a simulation without any visualization</li>
</ul>
<p>Graphics:</p>
<ul>
<li><code>game</code>: the GUI and main gameplay</li>
<li><code>map_gui</code>: common code to interact with <code>map_model</code> maps</li>
<li><code>widgetry</code>: a GUI and 2D OpenGL rendering library, using glium + winit +
glutin</li>
</ul>
<p>Common utilities:</p>
<ul>
<li><code>abstutil</code>: a grab-bag timing and logging utilities</li>
<li><code>abstio</code>: Reading/writing files on native/web</li>
<li><code>geom</code>: types for GPS and map-space points, lines, angles, polylines,
polygons, circles, durations, speeds</li>
</ul>
<p>Other:</p>
<ul>
<li><code>collisions</code>: an experimental data format for real-world collision data</li>
<li><code>traffic_seitan</code>: a bug-finding tool that randomly generates live map edits</li>
<li><code>tests</code>: integration tests</li>
<li><code>santa</code>: 15-minute Santa, an arcade game about delivering and zoning</li>
<li><code>parking_mapper</code>: a standalone tool to help map street parking in OSM</li>
<li><code>osm_viewer</code>: a standalone tool to render OSM in detail</li>
<li><code>fifteen_min</code>: a standalone tool to explore 15-minute neighborhoods</li>
<li><code>popdat</code>: use census data to produce traffic simulation input</li>
<li><code>traffic_signal_data</code>: manual timing overrides for some traffic signals</li>
</ul>
<h2 id="code-conventions"><a class="header" href="#code-conventions">Code conventions</a></h2>
<p>All code is automatically formatted using
<a href="https://github.com/rust-lang/rustfmt">https://github.com/rust-lang/rustfmt</a>; please run <code>cargo fmt</code> before sending a
PR.</p>
<p>cargo fmt can't yet organize imports, but we follow a convention to minimize
conflict with what some IDEs do. Follow existing code to group imports: std,
external crates, other crates in the project, the current crate, then finally
any module declarations.</p>
<p>We also use <a href="https://github.com/rust-lang/rust-clippy">https://github.com/rust-lang/rust-clippy</a> to adhere to more Rust
best practices. No need to run it for every commit, and sometimes we'll disable
a warning. If in doubt, just ask on a PR.</p>
<p>See the <a href="tech/dev/testing.html">testing strategy</a> page.</p>
<h2 id="error-handling"><a class="header" href="#error-handling">Error handling</a></h2>
<p>The error handling is unfortunately inconsistent. The goal is to gracefully
degrade instead of crashing the game. If a crash does happen, make sure the logs
will have enough context to reproduce and debug. For example, giving up when
some geometry problem happens isn't ideal, but at least make sure to print the
road / agent IDs or whatever will help find the problem. It's fine to crash
during map importing, since the player won't deal with this, and loudly stopping
problems is useful. It's also fine to crash when initially constructing all of
the renderable map objects, because this crash will consistently happen at
startup-time and be noticed by somebody developing before a player gets to it.</p>
<p>Since almost none of the code ever needs to distinguish error cases, use
<a href="https://crates.io/crates/anyhow">anyhow</a>. Most of the errors generated within
A/B Street are just strings anyway; the <code>bail!</code> macro is a convenient way to
return them.</p>
<h2 id="logging"><a class="header" href="#logging">Logging</a></h2>
<p>Prefer using <code>info!</code>, <code>warn!</code>, <code>error!</code>, etc from the <code>log</code> crate rather than
<code>println</code>.</p>
<p>Adjust the log level without recompiling via the <code>RUST_LOG</code> env variable.</p>
<pre><code>RUST_LOG=debug cargo run --bin game
</code></pre>
<p>This can be done on a per lib basis:</p>
<pre><code>RUST_LOG=my_lib=debug cargo run --bin game
</code></pre>
<p>Or a module-by-module basis:</p>
<pre><code>RUST_LOG=my_lib::module=debug cargo run --bin game
</code></pre>
<p>You can mix and match:</p>
<pre><code># error logging by default, except the foo:bar module at debug level
# and the entire baz crate at info level
RUST_LOG=error,foo::bar=debug,baz=info cargo run --bin game
</code></pre>
<p>For some special cases, you might want to use regex matching by specifying a
pattern with the &quot;/&quot;:</p>
<pre><code># only log once every 10k
RUST_LOG=&quot;fast_paths=debug/contracted node [0-9]+0000 &quot; mike import_la
</code></pre>
<p>See the <a href="https://docs.rs/env_logger/0.8.2/env_logger/">env_logger documentation</a>
for more usage examples.</p>
<h2 id="profiling"><a class="header" href="#profiling">Profiling</a></h2>
<p>Use <a href="https://github.com/flamegraph-rs/flamegraph">https://github.com/flamegraph-rs/flamegraph</a>, just running it on the
binaries you build normally.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="development-notes"><a class="header" href="#development-notes">Development notes</a></h1>
<p>Find packages to upgrade: <code>cargo outdated -R</code></p>
<p>Deal with compile tile: <code>cargo bloat --time</code></p>
<p>Find why two binary crates aren't sharing dependencies:
<a href="https://old.reddit.com/r/rust/comments/cqceu4/common_crates_in_cargo_workspace_recompiled/">https://old.reddit.com/r/rust/comments/cqceu4/common_crates_in_cargo_workspace_recompiled/</a></p>
<p>Where's a dependency coming from? <code>cargo tree -i -p syn</code></p>
<p>Diff screencaps: <a href="http://www.imagemagick.org/Usage/compare/#methods">http://www.imagemagick.org/Usage/compare/#methods</a></p>
<p>Debug OpenGL calls:</p>
<pre><code>apitrace trace --api gl ../target/debug/game
qapitrace game.trace
apitrace dump game.trace
</code></pre>
<p>Understand XML: just use firefox</p>
<h2 id="building-releases"><a class="header" href="#building-releases">Building releases</a></h2>
<p>Cross-compilation notes: <a href="https://github.com/rust-embedded/cross">https://github.com/rust-embedded/cross</a> Or use
<a href="https://github.com/japaric/trust">https://github.com/japaric/trust</a></p>
<p>Initially have to:</p>
<pre><code class="language-shell">cargo install cross
sudo apt-get install docker.io
sudo usermod -aG docker ${USER}
</code></pre>
<p>Then:</p>
<pre><code>sudo systemctl start docker
cross build --release --target x86_64-pc-windows-gnu --bin game
wine target/x86_64-pc-windows-gnu/release/game.exe data/system/seattle/maps/montlake.bin
</code></pre>
<h2 id="markdown"><a class="header" href="#markdown">Markdown</a></h2>
<p>For formatting:</p>
<pre><code>sudo apt-get install npm
cd ~; mkdir npm; cd npm
npm init --yes
npm install prettier --save-dev --save-exact
</code></pre>
<h2 id="videos"><a class="header" href="#videos">Videos</a></h2>
<pre><code># Fullscreen
ffmpeg -f x11grab -r 25 -s 1920x960 -i :0.0+0,55 -vcodec huffyuv raw.avi

ffmpeg -ss 10.0 -t 5.0 -i raw.avi -f gif -filter_complex &quot;[0:v] fps=12,scale=1024:-1,split [a][b];[a] palettegen [p];[b][p] paletteuse&quot; screencast.gif
</code></pre>
<h2 id="faster-linking"><a class="header" href="#faster-linking">Faster linking</a></h2>
<pre><code>sudo apt-get install lld
</code></pre>
<p>Stick this in ~/.cargo/config:</p>
<pre><code>[target.x86_64-unknown-linux-gnu]
rustflags = [
    &quot;-C&quot;, &quot;link-arg=-fuse-ld=lld&quot;,
]
</code></pre>
<h2 id="git"><a class="header" href="#git">git</a></h2>
<p>Keep a fork up to date:</p>
<pre><code># Once
git remote add upstream https://github.com/rust-windowing/glutin/

git fetch upstream
git merge upstream/master
git diff upstream/master
</code></pre>
<h2 id="refactoring"><a class="header" href="#refactoring">Refactoring</a></h2>
<pre><code>perl -pi -e 's/WrappedComposite::text_button\(ctx, (.+?), (.+?)\)/Btn::text_fg(\1).build_def\(ctx, \2\)/' `find|grep rs|xargs`
</code></pre>
<h2 id="stack-overflow"><a class="header" href="#stack-overflow">Stack overflow</a></h2>
<p>rust-gdb --args ../target/release/game --dev</p>
<h2 id="drawing-diagrams"><a class="header" href="#drawing-diagrams">Drawing diagrams</a></h2>
<p>draw.io</p>
<h2 id="mapping"><a class="header" href="#mapping">Mapping</a></h2>
<p>xodo on Android for annotating maps in the field</p>
<h2 id="osm-tools"><a class="header" href="#osm-tools">OSM tools</a></h2>
<p>osmcha.org for recent changes</p>
<p>To upload diffs:</p>
<pre><code>java -jar ~/Downloads/josm-tested.jar ~/abstreet/map_editor/diff.osc
</code></pre>
<p>JOSM: Press (and release T), then click to pan. Download a relevant layer,
select the .osc, merge, then upload.</p>
<h2 id="fonts"><a class="header" href="#fonts">Fonts</a></h2>
<p>fontdrop.info</p>
<h2 id="release-checklist"><a class="header" href="#release-checklist">Release checklist</a></h2>
<p>What things are sensitive to changes in map data and simulation rules?</p>
<ul>
<li>tutorial</li>
<li>optimize commute challenges</li>
</ul>
<p>What things do I always forget to test?</p>
<ul>
<li>DPI issues, use <code>--scale_factor</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="api"><a class="header" href="#api">API</a></h1>
<p>Suppose you're tired of manually fiddling with traffic signals, and you want to
use machine learning to do it. You can run A/B Street without graphics and
automatically control it through an API.</p>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<p>This
<a href="https://github.com/a-b-street/abstreet/blob/master/headless/examples/python_client.py">Python example</a>
has everything you need to get started.</p>
<p>See
<a href="https://github.com/a-b-street/abstreet/tree/master/headless/examples">all example code</a>
-- there are different experiments in Go and Python that automate running a
simulation, measuring some metric, and making a change to improve the metric.</p>
<h2 id="control-flow"><a class="header" href="#control-flow">Control flow</a></h2>
<p>The <code>headless</code> API server that you run contains a single map and simulation at a
time. Even though you can theoretically have multiple clients make requests to
it simultaneously, the server will only execute one at a time. If you're trying
to do something other than use one script to make API calls in sequence, please
get in touch, so we can figure out something better suited to your use case.</p>
<p>When you start the <code>headless</code> server, it always loads the <code>montlake</code> map with
the <code>weekday</code> scenario. The only way you can change this is by calling
<code>/sim/load</code>. For example:</p>
<pre><code>curl http://localhost:1234/sim/load -d '{ &quot;scenario&quot;: &quot;data/system/us/seattle/scenarios/downtown/monday.bin&quot;, &quot;modifiers&quot;: [], &quot;edits&quot;: null }' -X POST`
</code></pre>
<p>You can also pass flags like <code>--infinite_parking</code> to the server to control
<a href="https://a-b-street.github.io/abstreet/rustdoc/sim/struct.SimOptions.html">SimOptions</a>.
These settings will apply for the entire lifetime of the server; you can't
change them later.</p>
<h2 id="api-details"><a class="header" href="#api-details">API details</a></h2>
<blockquote>
<p><strong>Under construction</strong>: The API will keep changing. There are no backwards
compatibility guarantees yet. Please make sure I know about your project, so I
don't break your client code.</p>
</blockquote>
<p>For now, the API is JSON over HTTP. The exact format is unspecified, error codes
are missing, etc. A summary of the commands available so far:</p>
<ul>
<li><strong>/sim</strong>
<ul>
<li><strong>GET /sim/reset</strong>: Reset all temporary map edits and the simulation state.
The trips that will run don't change; they're determined by the scenario
specified by the last call to <code>/sim/load</code>. If you made live map edits using
things like <code>/traffic-signals/set</code>, they'll be reset to the <code>edits</code> from
<code>/sim/load</code>.</li>
<li><strong>POST /sim/load</strong>: Switch the scenario being simulated, and also optionally
sets the map edits.</li>
<li><strong>GET /sim/get-time</strong>: Returns the current simulation time.</li>
<li><strong>GET /sim/goto-time?t=06:30:00</strong>: Simulate until 6:30 AM. If the time you
specify is before the current time, you have to call <strong>/sim/reset</strong> first.</li>
<li><strong>POST /sim/new-person</strong>: The POST body must be an
<a href="https://a-b-street.github.io/abstreet/rustdoc/sim/struct.ExternalPerson.html">ExternalPerson</a>
in JSON format.</li>
</ul>
</li>
<li><strong>/traffic-signals</strong>
<ul>
<li><strong>GET /traffic-signals/get?id=42</strong>: Returns the traffic signal of
intersection #42 in JSON.</li>
<li><strong>POST /traffic-signals/set</strong>: The POST body must be a
<a href="https://a-b-street.github.io/abstreet/rustdoc/map_model/struct.ControlTrafficSignal.html">ControlTrafficSignal</a>
in JSON format.</li>
<li><strong>GET /traffic-signals/get-delays?id=42&amp;t1=03:00:00&amp;t2=03:30:00</strong>: Returns
the delay experienced by every agent passing through intersection #42 from
3am to 3:30, grouped by direction of travel.</li>
<li><strong>GET /traffic-signals/get-cumulative-thruput?id=42</strong>: Returns the number of
agents passing through intersection #42 since midnight, grouped by direction
of travel.</li>
<li><strong>GET /traffic-signals/get-all-current-state</strong>: Returns the current state of
all traffic signals, including the stage timing, waiting, and accepted
agents.</li>
</ul>
</li>
<li><strong>/data</strong>
<ul>
<li><strong>GET /data/get-finished-trips</strong>: Returns a JSON list of all finished trips.
Each tuple is (time the trip finished in seconds after midnight, trip ID,
mode, duration of trip in seconds). The mode is a string like &quot;Walk&quot; or
&quot;Drive&quot;. If the trip was cancelled for any reason, duration will be null.</li>
<li><strong>GET /data/get-agent-positions</strong>: Returns a JSON list of all active agents.
Vehicle type (or pedestrian), person ID, and position is included.</li>
<li><strong>GET /data/get-road-thruput</strong>: Returns a JSON list of (road, agent type,
hour since midnight, throughput for that one hour period).</li>
<li><strong>GET /data/get-blocked-by-graph</strong>: Returns a mapping from agent IDs to how
long they've been waiting and why they're blocked.</li>
<li><strong>GET /data/trip-time-lower-bound?id=123</strong>: Returns a reasonable lower bound
for the total duration of trip 123, in seconds. The time is calculated
assuming no delay at intersections, travelling full speed along every road,
and using the primary mode for the entire trip (so just driving).</li>
<li><strong>GET /data/all-trip-time-lower-bounds</strong>: The faster equivalent of calling
<code>/data/trip-time-lower-bound</code> for every trip in the simulation.</li>
</ul>
</li>
<li><strong>/map</strong>
<ul>
<li><strong>GET /map/get-edits</strong>: Returns the current map edits in JSON. You can save
this to a file in <code>data/player/edits/city_name/map_name/</code> and later use it
in-game normally. You can also later run the <code>headless</code> server with
<code>--edits=name_of_edits</code>.</li>
<li><strong>GET /map/get-edit-road-command?id=123</strong>: Returns an object that can be
modified and then added to map edits.</li>
<li><strong>GET /map/get-intersection-geometry?id=123</strong>: Returns a GeoJSON object with
one feature for the intersection and a feature for all connecting roads. The
polygon coordinates are measured in meters, with the origin centered at the
intersection's center.</li>
<li><strong>GET /map/get-all-geometry</strong>: Returns a huge GeoJSON object with one
feature per road and intersection in the map. The coordinate space is WGS84.</li>
</ul>
</li>
</ul>
<h2 id="working-with-the-map-model"><a class="header" href="#working-with-the-map-model">Working with the map model</a></h2>
<p>If you need to deeply inspect the map, you can dump it to JSON:</p>
<pre><code>cargo run --bin dump_map data/system/us/seattle/maps/montlake.bin &gt; montlake.json
</code></pre>
<p>See some example code that
<a href="https://github.com/a-b-street/abstreet/blob/master/headless/examples/generate_traffic.py">reads this JSON and finds buildings</a>.</p>
<p>You could also edit the map JSON, convert it back to binary, and use it in the
simulation. This isn't recommended generally, but one possible use case could be
tuning the amount of offstreet parking per building. The map JSON has a list
called <code>buildings</code>, and each object there has a field <code>parking</code>. You coud set
this object to <code>{ &quot;Private&quot;: [100, false] }</code> to indicate 100 parking spots, for
a building not explicitly designated in OpenStreetMap as a garage. After editing
the JSON, you have to convert it back to the binary format:</p>
<pre><code>cargo run --bin json_to_binary_map -- --input=montlake.json out=data/system/us/seattle/maps/montlake_modified.bin`
</code></pre>
<p>The format of the map isn't well-documented yet. See the
<a href="https://a-b-street.github.io/abstreet/rustdoc/map_model/index.html">generated API docs</a>
and <a href="tech/dev/../map/index.html">the map model docs</a> in the meantime.</p>
<h2 id="working-with-individual-trips"><a class="header" href="#working-with-individual-trips">Working with individual trips</a></h2>
<p>You can use the <strong>/sim/new-person</strong> API in the middle of a simulation, if
needed. If possible, it's simpler to create a Scenario as input.</p>
<h2 id="working-with-scenarios"><a class="header" href="#working-with-scenarios">Working with Scenarios</a></h2>
<p>You can
<a href="tech/dev/../trafficsim/travel_demand.html#custom-import">import trips from your own data</a>.</p>
<p>You can also generate different variations of one of the
<a href="tech/dev/../trafficsim/travel_demand.html#proletariat-robot">demand models</a> by specifying
an RNG seed:</p>
<pre><code>cargo run --bin random_scenario -- --rng=123 --map=data/system/us/seattle/maps/montlake.bin --scenario_name=home_to_work
</code></pre>
<p>You can also dump Scenarios (the file that defines all of the people and trips)
to JSON:</p>
<pre><code>cargo run --bin dump_scenario data/system/us/seattle/scenarios/montlake/weekday.bin &gt; montlake_weekday.json
</code></pre>
<p>You can modify the JSON, then put the file back in the appropriate directory and
use it in-game:</p>
<pre><code>cargo run --bin game data/system/us/seattle/scenarios/montlake/modified_scenario.json
</code></pre>
<p>The Scenario format is <a href="tech/dev/formats/scenarios.html">documented here</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="testing-strategy"><a class="header" href="#testing-strategy">Testing strategy</a></h1>
<h2 id="unit-tests"><a class="header" href="#unit-tests">Unit tests</a></h2>
<p>As you've probably noticed, there aren't many. Lots of the interesting behavior
in A/B Street - UI interactions, details of the simulation, map importing --
would take lots of infrastructure to specify a setup and expected outcomes. If
you have ideas for new tests, contributions always welcome! In the meantime, one
useful test covers how
<a href="https://github.com/a-b-street/abstreet/blob/master/map_model/src/make/initial/lane_specs.rs">OSM tags translate into individual lanes</a>.</p>
<h2 id="screenshot-diffs"><a class="header" href="#screenshot-diffs">Screenshot diffs</a></h2>
<p>Downloading fresh OSM data or modifying any part of the map importing pipeline
could easily break things. Expressing invariants about the map output is hard,
because importing is far from perfect, and OSM data is often quite buggy. So the
approach to preventing regressions here is to look for visual changes to the
final rendered map.</p>
<ol>
<li>When a new map is opted into this type of test, somebody manually squints
carefully at it and sanity checks that it works to some degree.</li>
<li>They use the screen capture tool in debug mode to tile the map into 1920x960
chunks and screengrab everything.</li>
<li>Later, somebody regenerates the map with some possible changes.</li>
<li>They grab screenshots again, then use <code>compare_screenshots.sh</code> to quickly
look at the visual diff. Changes to intersection geometry, number of lanes,
rendering, etc are all easy to spot.</li>
<li>If this manual inspection of the diff is good, they commit the new
screenshots as the new goldenfiles.</li>
</ol>
<h2 id="dataregensh"><a class="header" href="#dataregensh">data/regen.sh</a></h2>
<p>This tool regenerates all maps and scenarios from scratch.
<code>cargo run --bin updater -- --dry</code> then reveals what files have changed.</p>
<p>Additionally, this script does a few more tests:</p>
<ul>
<li><code>--prebake</code> runs the full weekday scenario on two maps that've previously been
coerced into being gridlock-free</li>
</ul>
<h2 id="integration-tests"><a class="header" href="#integration-tests">Integration tests</a></h2>
<p>The <code>tests</code> crate contains some integration tests.</p>
<p>One part runs the full importer against really simple <code>.osm</code> files. To iterate
rapidly on interpreting turn restrictions, it produces goldenfiles describing
all turns in the tiny map.</p>
<p>The &quot;smoke-test&quot; section simulates one hour on all maps, flushing out bugs with
bus spawning, agents hitting odd parts of the map, etc</p>
<p>The &quot;check proposals&quot; section makes sure the edits shipped with the game still
load properly.</p>
<h2 id="old-tests"><a class="header" href="#old-tests">Old tests</a></h2>
<p>Once upon a time, I made a little test harness that would run the simulation
headlessly (without graphics), set up certain situations forcing a car to park
in a certain spot, and asserted that different <code>sim/src/events.rs</code> were produced
in the right order. The <code>map_editor</code> tool was used to manually draw really
simple maps for these situations. I deleted everything, because the effort to
specify the input and expected output were too tedious to maintain, and this
never really helped catch bugs. There was a way to label roads and buildings in
the synthetic maps, so the test code could assert person 2 made it to the
&quot;house&quot; building, but even with all of this, it was pretty hard.</p>
<p>This approach is maybe worth reviving, though.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mass-importing-many-maps"><a class="header" href="#mass-importing-many-maps">Mass importing many maps</a></h1>
<p>For <a href="https://github.com/a-b-street/abstreet/issues/326">https://github.com/a-b-street/abstreet/issues/326</a>, I'm starting to figure
out how to import hundreds of maps into A/B Street. There are many issues with
scaling up the number of supported maps. This document just focuses on
importing.</p>
<h2 id="the-current-approach"><a class="header" href="#the-current-approach">The current approach</a></h2>
<p><a href="https://download.bbbike.org/">https://download.bbbike.org/</a> conveniently has 200 OSM extracts for major
cities world-wide. The <code>data/bbike.sh</code> script downloads these. Then
<code>data/mass_import.sh</code> attempts to import them into A/B Street.</p>
<p>The bbike extracts, however, cover huge areas surrounding major cities.
Importing such large areas is slow, and the result is too large to work well in
A/B Street or the OSM viewer. Ideally, we want just the area concentrated around
the &quot;core&quot; of each city.</p>
<p><a href="https://github.com/a-b-street/abstreet/blob/master/convert_osm/src/bin/extract_cities.rs">https://github.com/a-b-street/abstreet/blob/master/convert_osm/src/bin/extract_cities.rs</a>
transforms a huge .osm file into smaller pieces, each focusing on one city core.
This tool looks for administrative boundary relations tagged as cities, produces
a clipping polygon covering the city, and uses <code>osmconvert</code> to produce a smaller
<code>.osm</code> file. The tool has two strategies for generating clipping polygons. One
is to locate the <code>admin_centre</code> or <code>label</code> node for the region, then generate a
circle of fixed radius around that point. Usually this node is located in the
city core, so it works reasonably, except for &quot;narrow&quot; cities along a coast. The
other strategy glues together the relation's multipolygon boundary, then
simplifies the shape (usually with thousands of points) using a convex hull.
This strategy tends to produce results that're too large, because city limits
are often really huge.</p>
<h2 id="problems"><a class="header" href="#problems">Problems</a></h2>
<ul>
<li>Outside the US, administrative boundaries don't always have a &quot;city&quot; defined.
In Tokyo in particular, this name isn't used. I'm not sure which boundary
level to use yet.</li>
<li>The tool assumes driving on the right everywhere. OSM has
<a href="https://wiki.openstreetmap.org/wiki/Key:driving_side">https://wiki.openstreetmap.org/wiki/Key:driving_side</a>, but this is usually
tagged at the country level, which isn't included in the bbike extracts.</li>
<li>The resulting maps are all &quot;flattened&quot; in A/B Street's list, so you can't see
any hierarchy of areas. Two cities with the same name from different areas
will arbitrarily collide.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="data-organization"><a class="header" href="#data-organization">Data organization</a></h1>
<p>A/B Street includes lots of large binary files to represent converted maps,
scenarios, and prebaked simulation results. The files are too large to store in
git, but the files are still logically tied to a version of the code, since the
format sometimes changes. Additionally, all of the files are too large to
include in the .zip release that most people use, but it should still be
possible for players to download the optional content. Also, there are different
versions of the game floating around, on native and web, that have to be
associated with the proper version of these files.</p>
<p>It's all slightly confusing, so this page describes how it all works.</p>
<h2 id="the-data-itself"><a class="header" href="#the-data-itself">The data itself</a></h2>
<p>If you peek into the <code>data/</code> directory, it's mainly split into 3 subdirectories.
<code>system/</code> is used when running the game and is the subject of this page.
<code>input/</code> is used to store input and intermediate files for importing maps, and
only developers running the importer should care about it. <code>player/</code> contains
local settings, map edits, and other data created in-game.</p>
<p><code>data/MANIFEST.json</code> is a listing of all files in <code>data/system/</code>, along with
their size and md5sum. Different tools compare this manifest to the local
filesystem to figure out what to do.</p>
<p>There are also some other scripts and files in <code>data/</code>, but they should probably
be moved.</p>
<h2 id="where-the-data-is-stored"><a class="header" href="#where-the-data-is-stored">Where the data is stored</a></h2>
<p><code>data/system/</code> and <code>data/input/</code> are stored in Amazon S3, at
http://abstreet.s3-website.us-east-2.amazonaws.com. This S3 bucket is organized
into versions: <code>dev</code>, <code>0.2.17</code>, <code>0.2.18</code>, etc. <code>dev</code> represents the latest
version of all data files. The numbered versions correspond to
<a href="https://github.com/a-b-street/abstreet/releases">releases</a> and only contain
<code>data/system/</code>, not <code>data/input/</code>. Depending how large these directories grow
over time, I'll commit to keeping around at least 3 of the previous numbered
versions, but I might delete older ones after that.</p>
<h2 id="native-running-from-source"><a class="header" href="#native-running-from-source">Native, running from source</a></h2>
<p>For people building the game <a href="tech/dev/index.html">from source</a>, the process to keep data
files fresh is to <code>cargo run --bin updater</code>. This tool calculates md5sums of all
local files, then compares it with the checked-in <code>data/MANIFEST.json</code>. Any
difference results in a local file being deleted or a new file from S3 being
downloaded. By editing <code>data/player/data.json</code> manually or using the UI in the
game (found by loading a map, then choosing to download more maps), somebody can
opt into downloading &quot;extra/optional&quot; cities.</p>
<h2 id="native-running-from-a-release-zip"><a class="header" href="#native-running-from-a-release-zip">Native, running from a release .zip</a></h2>
<p>When the weekly .zip binary release for Mac, Linux, and Windows is produced, the
<code>game</code> crate is built with <code>--features release_s3</code>. When the downloader UI is
opened in-game, this causes downloads to occur from a versioned S3 directory,
like <code>0.2.17</code>, depending on the version string compiled into the game at that
time. So somebody can run off the weekly release, opt into more cities, and get
the correct version of the files, even if the format has changed in <code>/dev/</code>
since then.</p>
<h2 id="web-running-locally"><a class="header" href="#web-running-locally">Web, running locally</a></h2>
<p>The strategy for managing files gets more interested when the game is compiled
to WebAssembly, since browsers can't read from the local filesystem.
<code>game/src/load.rs</code> contains some crazy tricks to instead make asynchronous HTTP
requests through the browser. When using <code>game/run_web.sh</code>, the files are served
through a local HTTP server and symlinked to the local copy of <code>data/system/</code>.</p>
<p>Not all files are loaded through HTTP; some are actually statically compiled
into the <code>.wasm</code> file itself! <code>abstutil/src/io_web.rs</code> does this magic using the
<code>include_dir</code> crate. Only a few critical large files, needed at startup, are
included. There's an IO layer for listing and reading files that, on web, merges
results from the bundled-in files and the remote files that're declared to exist
in the bundled-in copy of <code>data/MANIFEST.json</code>.</p>
<h2 id="web-from-s3"><a class="header" href="#web-from-s3">Web, from S3</a></h2>
<p>Everything's the same, except that since the URL isn't localhost, the game makes
HTTP requests to the S3 bucket (or wherever the game is hosted). Additionally,
the files are expected to be gzipped. The web version always pins to <code>/dev</code>,
never a release version of the data, since the web client is always updated
along with the data, for now.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="release-process"><a class="header" href="#release-process">Release process</a></h1>
<p>This happens every Sunday.</p>
<ol>
<li>Push a commit containing <code>[rebuild] [release]</code> in the commit message.</li>
<li>Wait for the build to complete at
<a href="https://github.com/a-b-street/abstreet/actions">https://github.com/a-b-street/abstreet/actions</a></li>
<li>Manually download the 3 .zip files</li>
<li>With your current directory set to where the .zips are downloaded, run
<code>~/abstreet/release/finalize.sh v0_2_38</code>, changing the version number. (That
path assumes the abstreet git repo is in your home directory.)</li>
<li>If you want, sanity check that the final generated binaries work. Sometimes
I test things like the map importer or that maps not included by default can
be downloaded.</li>
<li>Create a new release at
<a href="https://github.com/a-b-street/abstreet/releases/new">https://github.com/a-b-street/abstreet/releases/new</a>. Make sure the version
matches, with a different format -- <code>v0.2.38</code>. The description should match
what later goes in the changelog, and the name really ought to be
gastronomically offensive.</li>
<li>Upload the 3 transformed .zips created by <code>finalize.sh</code> -- they're named
something like <code>abstreet_mac_v0_2_38.zip</code>.</li>
<li>Publish release!</li>
<li>From the root directory of the abstreet repo, run
<code>./release/update_docs.sh 37 38</code>. When the major version number changes,
update that script first. This updates the latest release from <code>0.2.37</code> to
<code>0.2.38</code>. It assumes the <a href="https://github.com/a-b-street/docs">https://github.com/a-b-street/docs</a> repo is in
your home directory named <code>~/docs</code>.</li>
<li>Go fill out <code>~/docs/book/src/project/CHANGELOG.md</code>; the notes should match
what's in the Github release.</li>
<li>Follow the steps that the <code>update_docs.sh</code> script tells you. Don't forget to
push the commit on the main abstreet repo as well.</li>
</ol>
<p>One of the <code>update_docs.sh</code> steps is an S3 copy. This &quot;freezes&quot; the current
&quot;dev&quot; data and web deployment as a named version. The URL would be something
like <a href="http://abstreet.s3-website.us-east-2.amazonaws.com/0.2.38/abstreet.html">http://abstreet.s3-website.us-east-2.amazonaws.com/0.2.38/abstreet.html</a>.</p>
<h2 id="how-it-works"><a class="header" href="#how-it-works">How it works</a></h2>
<p>The process is kind of convoluted; help is always welcome to smooth it out.</p>
<p>Github Actions is used to build for all 3 platforms.
<code>.github/workflows/main.yml</code> is configured to only build when <code>[rebuild]</code> is in
the commit message. <code>[release]</code> enables a cargo feature flag that tells
<code>map_gui/src/tools/updater.rs</code> where to look to download new system data.
Because the binary map format changes, an older release has to be pinned to a
particular versioned copy of all the system data. The workflow calls
<code>release/build.sh</code>, which assembles the directory structure with all of the
executables, system data (obtained by running the updater with the default
Seattle-only opt-in), and instructions.</p>
<p>There's some funkiness with producing a .zip, because uploading Github artifacts
always double-zips, and also on the Windows runner, there doesn't seem to be a
way to create a .zip. That's why the extra step of downloading the build
artifacts and running <code>release/finalize.sh</code> locally is necessary.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="data-formats"><a class="header" href="#data-formats">Data formats</a></h1>
<p>This section describes data formats that A/B Street uses for input and output.
Like the API, nothing is guaranteed to be backwards-compatible yet. The best way
to make sure schema changes won't mess up your workflow is to keep in touch and
make sure I know how you're using these files.</p>
<p>The formats are currently JSON, without a machine-readable schema. In the
future, I'm highly likely to use protocol buffers, flatbuffers, Thrift, etc
instead, so that languages with static type systems can benefit from
auto-generated libraries and so that larger files can be encoded in binary.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="scenario-data-format"><a class="header" href="#scenario-data-format">Scenario data format</a></h1>
<p>If you want to import your own
<a href="tech/dev/formats/../../trafficsim/travel_demand.html">travel demand model</a>, you can use this JSON
file.</p>
<h2 id="specification"><a class="header" href="#specification">Specification</a></h2>
<p>Until we switch to using protobufs or similar, there's no formal spec. The JSON
deserialization happens from
<a href="https://github.com/a-b-street/abstreet/blob/master/sim/src/make/external.rs">Rust code</a>.
It's easiest to follow the example below.</p>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<p>This defines a scenario containing a single person, who takes two trips. They
begin at 1 second past midnight (<code>10000</code>) at the building nearest to the <code>origin</code>,
'find' a bike and cycle to the <code>destination</code>.
Then at 12:20 (<code>12000000</code> is <code>1200</code> seconds after midnight), they walk to the building nearest to the
<code>destination</code>. Note that the
<code>destination</code> of trip 1 must match the <code>origin</code> of trip 2.</p>
<p>The <code>mode</code> field can be be <code>Walk</code>, <code>Bike</code>, or <code>Transit</code>. The <code>purpose</code>
field is mostly unused; you could pick <a href="https://a-b-street.github.io/abstreet/rustdoc/sim/enum.TripPurpose.html">other
values</a>
that show up in the UI. And of course, you can add as many people as you like.</p>
<pre><code>{
  &quot;scenario_name&quot;: &quot;minimal&quot;,
  &quot;people&quot;: [
    {
      &quot;trips&quot;: [
        {
          &quot;departure&quot;: 10000,
          &quot;origin&quot;: {
            &quot;Position&quot;: {
              &quot;longitude&quot;: -122.303723,
              &quot;latitude&quot;: 47.6372834
            }
          },
          &quot;destination&quot;: {
            &quot;Position&quot;: {
             &quot;longitude&quot;: -122.3190500,
              &quot;latitude&quot;: 47.6378600
        }
          },
          &quot;mode&quot;: &quot;Bike&quot;,
          &quot;purpose&quot;: &quot;Meal&quot;
        },
        {
          &quot;departure&quot;: 12000000,
          &quot;origin&quot;: {
            &quot;Position&quot;: {
             &quot;longitude&quot;: -122.3190500,
              &quot;latitude&quot;: 47.6378600
        }
          },
          &quot;destination&quot;: {
            &quot;Position&quot;: {
              &quot;longitude&quot;: -122.3075948,
              &quot;latitude&quot;: 47.6394773
        }
          },
          &quot;mode&quot;: &quot;Walk&quot;,
          &quot;purpose&quot;: &quot;Recreation&quot;
        }
      ]
    }
  ]
}
</code></pre>
<h2 id="tools"><a class="header" href="#tools">Tools</a></h2>
<p>To import this JSON file into A/B Street:</p>
<pre><code>cargo run --bin import_traffic -- --map=data/system/us/seattle/maps/montlake.bin --input=/path/to/input.json
</code></pre>
<p>Then run the game as follows:</p>
<pre><code>cargo run --bin game -- --dev data/system/us/seattle/maps/montlake.bin
</code></pre>
<p>You will need to select the senario with the user interface.</p>
<p>This tool matches input positions to the nearest building, within 100 meters. If
the point lies outside the map boundary, it's snapped to the nearest map border.
The tool will fail if any point doesn't match to a building. If you pass
<code>--skip_problems</code>, those people will be logged and skipped instead.</p>
<p>There are also a few tools that produce this JSON file:</p>
<ul>
<li><a href="https://github.com/a-b-street/abstreet/blob/master/headless/examples/generate_traffic.py">https://github.com/a-b-street/abstreet/blob/master/headless/examples/generate_traffic.py</a></li>
<li><a href="https://github.com/a-b-street/abstr">https://github.com/a-b-street/abstr</a></li>
</ul>
<h2 id="future-requests"><a class="header" href="#future-requests">Future requests</a></h2>
<ul>
<li>A way to specify some kind of numeric ID for each person, so you can later
correlate results from the simulation with your input</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="traffic-signal-data-format"><a class="header" href="#traffic-signal-data-format">Traffic signal data format</a></h1>
<p>A/B Street uses a JSON format to describe how a single intersection with traffic
signals is configured. This format changes more frequently, but the software
will automatically upgrade a signal described in an old format. This way,
players can save their edits to a map and, months later, still use the same
edits with a new version of A/B Street. (The only exception is when
OpenStreetMap IDs change; if a way near the intersection is split and assigned a
new ID, we make no attempt to handle this.)</p>
<p>The format is complicated, so let's break down some of the concepts used in it.</p>
<h2 id="turns"><a class="header" href="#turns">Turns</a></h2>
<p>We first need a way to describe a movement between two road segments. Let's use
<a href="https://www.openstreetmap.org/node/53219808">https://www.openstreetmap.org/node/53219808</a>, the intersection of 24th Ave E
and E McGraw St in Seattle as an example.</p>
<h3 id="directed-road-segments"><a class="header" href="#directed-road-segments">Directed road segments</a></h3>
<p>So first let's identify a single road segment. For this example, let's describe
the eastbound direction of the west side of McGraw St, which is
<a href="https://www.openstreetmap.org/way/804788512">https://www.openstreetmap.org/way/804788512</a> in OSM. As you can see, this way
hits 3 intersections. We just want to describe the segment between 24th and 25th
Ave. Looking at the list of nodes for that way in the order defined in OSM, we
see it goes from <a href="https://www.openstreetmap.org/node/53219808">https://www.openstreetmap.org/node/53219808</a> to
<a href="https://www.openstreetmap.org/node/1709143541">https://www.openstreetmap.org/node/1709143541</a>. Note that the intermediate
nodes used as control points for the shape of the road or as crosswalk nodes are
ignored. So, we can describe this segment by using the way's ID and the first
and last node ID.</p>
<p><img src="tech/dev/formats/mcgraw.png" alt="mcgraw" /></p>
<pre><code>{
  &quot;osm_way_id&quot;: 804788512,
  &quot;osm_node1&quot;: 53219808,
  &quot;osm_node2&quot;: 1709143541,
  &quot;is_forwards&quot;: false
}
</code></pre>
<p>Finally, we have to say which direction of this road segment we're talking
about. The order of the nodes in OSM is arbitrary; in this case, the road points
from the traffic signal we're talking about to another intersection. But we want
to refer to the inbound / eastbound direction of this road. So we say
<code>&quot;is_forwards&quot;: false</code> to indicate the opposite of the direction specified by
OSM. This is the same concept as &quot;forward &amp; backward&quot; as defined in the
<a href="https://wiki.openstreetmap.org/wiki/Forward_%26_backward,_left_%26_right">OSM wiki</a>.</p>
<h3 id="turns-for-vehicles"><a class="header" href="#turns-for-vehicles">Turns for vehicles</a></h3>
<p>So now let's describe the left turn from E McGraw to 24th going southbound. It
looks like this:</p>
<pre><code>{
  &quot;from&quot;: {
    &quot;osm_way_id&quot;: 804788512,
    &quot;osm_node1&quot;: 53219808,
    &quot;osm_node2&quot;: 1709143541,
    &quot;is_forwards&quot;: false
  },
  &quot;to&quot;: {
    &quot;osm_way_id&quot;: 6470476,
    &quot;osm_node1&quot;: 53128048,
    &quot;osm_node2&quot;: 53219808,
    &quot;is_forwards&quot;: false
  },
  &quot;intersection_osm_node_id&quot;: 53219808,
  &quot;is_crosswalk&quot;: false
}
</code></pre>
<p>You specify the <code>from</code> and <code>to</code> fields using the directed road segment ID.
Additionally, you specify which intersection the traffic signal is at --
<code>53219808</code> in this case -- and set <code>is_crosswalk</code> to <code>false</code> to indicate a turn
for vehicles or cyclists on the road.</p>
<h3 id="crosswalks"><a class="header" href="#crosswalks">Crosswalks</a></h3>
<p>Why is the format above so repetitive? The reason is to be able to also specify
movements along crosswalks in the intersection. The <code>from</code> and <code>to</code> directed
road segments refer to one half of a road, so they can be used to identify one
sidewalk or another. From this diagram, you can see how there are 8 different
start or end points for crosswalks at this intersection:</p>
<p><img src="tech/dev/formats/crosswalks.png" alt="crosswalks" /></p>
<p>TODO: Walk through an example of a single crosswalk. I hope the explanation of
the format above suffices, for now.</p>
<h2 id="stages"><a class="header" href="#stages">Stages</a></h2>
<p>Now that we understand how to describe turns, we can describe the sequence of
stages that a traffic signal cycles through. Each stage specifies the turns that
are <strong>protected</strong> and <strong>permitted</strong>. Protected turns have priority (a green
light), and no two protected turns in the same stage can cross each other.
Permitted turns are allowed only if there's no oncoming traffic -- so this could
mean a right turn on red or an unprotected left turn with a flashing arrow. Note
that crosswalks always must be defined as protected, which means any vehicle
turns that intersect with the crosswalk have to be specified as permitted. This
captures the semantics in the US that turning vehicles must always yield to
pedestrians when the crosswalk signal is on.</p>
<p>A single traffic signal cycles through the same list of stages over and over.
Each stage also specifies its duration with the <code>stage_type</code>. The simple example
is <code>&quot;Fixed&quot;: 45</code>, meaning this stage always lasts exactly 45 seconds. A stage
can also have variable timing, also known as actuation. The format is
<code>&quot;Variable&quot;: [15, 2, 10]</code>. This stage would last a minimum of 15 seconds, but it
may last an additional 10 seconds, up to a maximum of 25 seconds. If there are
no vehicles or pedestrians trying to make protected turns after 15 seconds, the
stage ends. If there are, then the stage is extended by 2 seconds, and the same
check repeats, until the maximum of 25 is reached.</p>
<h2 id="the-full-example"><a class="header" href="#the-full-example">The full example</a></h2>
<p>Understanding everything above means you should be able to interpret what
<a href="https://github.com/a-b-street/abstreet/blob/599c7b6d6bc078312e5ea9f57d3391be9568ef83/traffic_signal_data/data/53219808.json">https://github.com/a-b-street/abstreet/blob/599c7b6d6bc078312e5ea9f57d3391be9568ef83/traffic_signal_data/data/53219808.json</a>
means. The rendering in A/B Street looks like this:</p>
<p><img src="tech/dev/formats/stages.png" alt="stages" /></p>
<p>There are two stages. The first lasts 45 seconds and allows north/south
movement. Left turns onto McGraw are permitted after yielding. Since the
north/south crosswalks are also enabled, all right turns also have to yield. The
second stage lasts only 15 seconds and lets east/west traffic move. Left turns
are also unprotected here.</p>
<h2 id="limitations"><a class="header" href="#limitations">Limitations</a></h2>
<p>In reality, many traffic signals use different configuration during rush hour,
late at night, on weekends, etc. There's some
<a href="https://github.com/a-b-street/abstreet/issues/447">planned work</a> to model one
intersection having different plans.</p>
<p>Many intersections in Seattle now use
<a href="https://nacto.org/publication/urban-street-design-guide/intersection-design-elements/traffic-signals/leading-pedestrian-interval/">leading pedestrian intervals</a>,
which enable a crosswalk signal to give pedestrians a head-start into the
intersection before vehicles start to turn. You can model this in A/B Street by
adding an extra stage that only enables the crosswalks and lasts a few seconds,
followed by a stage allowing both the crosswalks and vehicle turns. We could
explicitly add a parameter for LPI duration, but it would complicate the format,
so this &quot;flattened stage&quot; format will work for now.</p>
<p>You'll notice the format for specifying turns works at the granularity of the
entire road, not individual lanes. Most of the time, this is fine -- vehicles
will only use the turn lanes available. But in some cases, we may want to
distinguish two groups of vehicles moving the same direction by the lane type.
In particular, sometimes there's a bidirectional protected cycle-track on one
side of the road with its own dedicated signal:</p>
<p><img src="tech/dev/formats/cycletrack.png" alt="cycletrack" /></p>
<p>A/B Street can't model this as having a separate signal yet.</p>
<h2 id="complications-with-importing-other-data"><a class="header" href="#complications-with-importing-other-data">Complications with importing other data</a></h2>
<p>External software like
<a href="https://github.com/asu-trans-ai-lab/data2timing">vol2timing</a> can provide much
better signal configuration than A/B Street's default heuristics. We will
encounter at least two major challenges to import it.</p>
<h2 id="crosswalks-1"><a class="header" href="#crosswalks-1">Crosswalks</a></h2>
<p>A/B Street currently does not use sidewalks, foot-paths, and crosswalks that are
explicitly drawn as separate OSM ways. Instead, it makes many guesses for which
roads have a sidewalk and creates many, many crosswalks. See
<a href="https://github.com/a-b-street/abstreet/issues/485">https://github.com/a-b-street/abstreet/issues/485</a> for some examples of
crosswalks that should not be created, but currently are.</p>
<p>When A/B Street imports traffic signal configuration, it validates that all
possible turns at the intersection are captured by at least one stage. The
problem here will be that other software may not list as many crosswalks as A/B
Street expects.</p>
<h2 id="intersection-mergingconsolidation"><a class="header" href="#intersection-mergingconsolidation">Intersection merging/consolidation</a></h2>
<p>OSM models bidirectional roads with some physical median as two one-ways. When
these divided one-ways cross a regular road, the intersection is split into two
intersections with a very short &quot;road&quot; in between. When two pairs of divided
one-ways cross, the intersection has four nodes and short &quot;roads&quot; in between.
This wreaks havoc in A/B Street, making the intersection geometry look strange,
making it hard to edit the two or four uncoordinated traffic signals around the
intersection, and causing vehicles to get stuck in the short &quot;roads&quot;.</p>
<p>One solution that's promising is for A/B Street to consolidate those nodes and
short &quot;roads&quot; into one big intersection, capturing how a human would intuitively
view the area. One case where this works well is
<a href="https://www.openstreetmap.org/#map=19/47.68264/-122.34426">https://www.openstreetmap.org/#map=19/47.68264/-122.34426</a>. See the before and
after:</p>
<p><img src="tech/dev/formats/consolidate.png" alt="consolidate" /></p>
<p>Unfortunately this process doesn't work for many more cases, so it's not enabled
by default yet. Preserving turn restrictions defined by OSM and getting good
results for the geometry of the consolidated intersection is hard.</p>
<p>In the meantime, all of this complicates the traffic signal format, because it's
unclear how to specify road segments when A/B Street will arbitrarily delete
some of the node IDs when it imports.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-the-the-ab-street-ui--drawing-work"><a class="header" href="#how-the-the-ab-street-ui--drawing-work">How the the A/B Street UI &amp; drawing work</a></h1>
<p>When I started A/B Street in June 2018, the
<a href="https://www.areweguiyet.com">Rust UI ecosystem</a> had nothing that clearly fit my
needs, so I wound up rolling something custom. This doc explains conceptually
how it works and how to use it. Eventually some of this should become proper
docs for <code>widgetry</code>.</p>
<p>Best advice on how to use stuff in practice is to work from examples. <code>grep</code> is
your friend.</p>
<h2 id="widgetry-overview"><a class="header" href="#widgetry-overview">widgetry overview</a></h2>
<p>First, the crate-level view. <code>widgetry</code> is the generic drawing and UI library,
independent of A/B Street. <code>map_gui</code> builds on top of it, providing ways to
render the map model used by all of the projects. Finally, <code>game</code>,
<code>fifteen_min</code>, <code>santa</code>, and others are the runnable applications making use of
this.</p>
<p>This section will explain how <code>widgetry</code> works from bottom-up. Conceptually
we'll walk through how it was built from scratch, skipping all of the false
turns made along the way.</p>
<h3 id="low-level"><a class="header" href="#low-level">Low-level</a></h3>
<p>Let's start just by drawing stuff and handling keyboard/mouse events. The basic
loop of any <a href="https://crates.io/crates/winit">winit</a> program is to handle input
events and, when winit says to, redraw everything. The earliest A/B Street
prototype expressed the primitive map model imported from OpenStreetMap as a
bunch of polygons, and hooked up basic mouse controls to pan and zoom over the
canvas.</p>
<p>And that hasn't really changed -- we still only draw 2D colored polygons.
Widgetry's use of
<a href="https://github.com/a-b-street/abstreet/tree/master/widgetry/shaders">OpenGL shaders</a>
is dirt simple. With the exception of some barely used texture code, all of the
icons and images in A/B Street are SVGs, which can be
<a href="https://github.com/a-b-street/abstreet/blob/master/widgetry/src/svg.rs">transformed into colored polygons</a>
through the magic of the <a href="https://crates.io/crates/usvg">usvg</a> and
<a href="https://crates.io/crates/lyon">lyon</a> crates. This includes all
<a href="https://github.com/a-b-street/abstreet/blob/master/widgetry/src/text.rs">text</a>
-- even the text is just colored vector polygons! (Text rendering usually works
by uploading a table of raster glyphs to the GPU and drawing textured quads.)</p>
<p>The brief story of how we got here: by
<a href="tech/dev/../../project/history/year2.html">November 2019</a>, there was some basic support
for uploading raster texture and drawing them. At the second Democracy Lab
hackathon, a developer on Mac hit a 16 texture object limit that was different
than Linux. This is also when Yuwen joined and started designing using Figma,
which... conveniently had SVG export. I was also frustrated by rendering text
separately from everything else; finding the bounding boxes was buggy and there
were z-order issues. All of this prompted me to poke around and discover an
example using lyon to tesellate the output from usvg. I thought, there's no way
vectorizing EVERYTHING could be performant. But happily I was wrong.</p>
<p>Finally getting to the practical consequence here. It's expensive to upload
stuff to the GPU, but it's cheap to draw something already uploaded. So you use
a <code>GeomBatch</code> to build up that list of colored polygons, then upload it by doing
<code>ctx.upload(batch)</code>. Later on, you can <code>g.redraw(&amp;drawable)</code> as many times as
you want and it's fast. You don't keep the <code>GeomBatch</code> around; it's just the
builder for a <code>Drawable</code>.</p>
<p>How should you batch stuff? Issuing redraw calls is fast, but not when there's
lots of them. So for example, one <code>Drawable</code> per every building on the map would
be a nightmare. Since buildings don't change, there's a single batch and
<code>Drawable</code> for all of them. There's a balance here; sometimes you have to
experiment to find it. But generally, if recalculating a batch only needs to
happen every so often, just lump everything together in one for simplicity.</p>
<h3 id="stack-of-states"><a class="header" href="#stack-of-states">Stack of states</a></h3>
<p>So at this point, there's logically one method to handle input events, and one
method to draw. No built-in organization; all application state is just lumped
somewhere. The basic insight is that an app has a stack of smaller states
layered on top of each other. For example, you start with a title screen, then
enter the main simulation interface, then open up a menu to show extra layers.
You still want to draw the simulation underneath the menu, but not allow it to
handle events. When you exit the simulation, you want to go back to the title
screen and preserve any local state there.</p>
<p>So a widgetry app mainly consists of a stack of
<a href="https://github.com/a-b-street/abstreet/blob/master/widgetry/src/app_state.rs">States</a>.
Each state implements a method to handle events and draw. Some states want to
draw what's underneath them, while some want to clear the screen and fully
handle everything -- so <code>draw_baselayer</code> specifies this.</p>
<p>When a state handles an event, it returns a <code>Transition</code>. This manipulates the
stack. <code>Transition::Keep</code> doesn't do anything; the current state remains.
<code>Transition::Pop</code> deletes the current state from the stack, and the previous one
takes over. <code>Transition::Push</code> introduces a new state, preserving the current
underneath. And so on.</p>
<p>There's actually two types of &quot;state&quot; (as in, data managed by the app): local
and global. Local &quot;state&quot; is owned by the struct implementing the <code>State</code> trait.
This is usually stuff like any UI panels (which we'll get to soon) and stuff
like which road we're editing, or what building we're examining. But usually an
app has a bunch of &quot;state&quot; that lasts for the entire lifetime of the program --
the map, the simulation, global settings. This stuff can change through the
program, like loading a new map, but every single <code>State</code> probably wants to use
it. This global stuff is stored in the <code>App</code> struct, which gets plumbed around.
So, each <code>State</code> has
<code>fn event(&amp;mut self, ctx: &amp;mut EventCtx, app: &amp;mut App) -&gt; Transition</code> -- <code>self</code>
is the local <code>State</code> on the stack, <code>ctx</code> is a handle into the generic <code>widgetry</code>
system, and <code>app</code> is that global &quot;state&quot;. And there's also
<code>fn draw(&amp;self, g: &amp;mut GfxCtx, app: &amp;App)</code>, with <code>GfxCtx</code> being the hook to
draw stuff. Note <code>draw</code> uses immutable borrows; generally you shouldn't modify
anything while drawing. (When you need to, like for caching, usually
<a href="https://doc.rust-lang.org/std/cell/index.html">RefCell</a> is the answer.)</p>
<p>This system of states and transitions mostly works, but there's one super
awkward problem. Sometimes, state1 needs to push on state2 in order to prompt
the user for input (free-form text, a menu, or even something more complicated)
and use the result of state2 in order to do something else. In normal
programming, this would just be calling a function and using the return value.
How do we make that work with the event/draw interface? The answer is for state2
to return <code>Transition::Pop</code> and <code>Transition::ModifyState</code>, downcast the previous
<code>State</code> into a particular struct, and shove the return value somewhere. This is
incredibly gross, but I'm not sure what else to do.</p>
<h3 id="panels"><a class="header" href="#panels">Panels</a></h3>
<p>What's been described so far is kind of only useful for drawing and interacting
with stuff in &quot;map-space&quot;, aka, the scrollable canvas. What about normal GUI
elements that live in &quot;screen-space&quot; on top of everything else -- buttons,
dropdowns, checkboxes, frobnozzlers? There needs to be a way to create these,
arrange them in some kind of layout, and use them for interaction. There's a
bunch of ways that GUI frameworks manage the problem of synchronizing
application &quot;state&quot; with the UI widgets, and it's more complex than usual in
Rust, because you hit crazy lifetime and borrowing issues if you try to do
anything with callbacks.</p>
<p>So sticking to the widgetry philosophy of seeing how far the low-level
abstractions stretch, widgets are just temporary &quot;state&quot; managed by a <code>State</code>.
They're always managed as part of a <code>Panel</code>, even if you have just a single
button. Constructing <code>Panel</code>s is hopefully straightforward from examples; you
assemble a tree of rows and columns, with some occasional styling and layouting
hints thrown in. Underneath, widgetry uses
<a href="https://crates.io/crates/stretch">stretch</a> for CSS Flexbox-style layouting.
There are some quirks, most of which we've worked out and hopefully papered over
(like <code>padding</code> and <code>margin</code> don't work on most widgets directly; you have to
wrap them in a <code>Widget::row</code> or <code>Widget::col</code>).</p>
<p>So how do you know if a button has been clicked, a toggle toggled, a slider
slidden, a frobnozzler frobnuzzled? In some languages, you might expect
callbacks, but here in widgetry, you have to explicitly ask. Most <code>State</code>s will
<code>match self.panel.event(ctx)</code> somewhere near the top. This takes the current
event (a low-level keypress or mouse movement) and lets all of the widgets
inside the <code>Panel</code> possibly use it. If the event caused the widgets to do
something interesting, the entire <code>Panel</code> will return
<code>Some(Outcome::Clicked(&quot;button name&quot;))</code> or
<code>Some(Outcome::Changed(&quot;spinner name&quot;))</code>. The <code>State</code> code can then interpret
that UI-level event appropriately.</p>
<p>Currently, the widgets in a <code>Panel</code> are identified by lovely type-unsafe
hardcoded strings. This isn't the best, but in practice, it's rare to get out of
sync between the two places in one file that talk about the same widget.</p>
<p>Some widgets have more information than just &quot;the button was clicked&quot;. Whenever
you need to, you can just query their state --
<code>self.panel.slider(&quot;time&quot;).get_percent()</code>, <code>self.panel.dropdown_value(&quot;mode&quot;)</code>,
<code>self.panel.spinner(&quot;duration&quot;)</code>. These last two are generic, and the compiler
usually infers the type of the value contained. (Internally, we just downcast to
that type, so you'd get a runtime panic if you mess up.)</p>
<h4 id="updating-panels"><a class="header" href="#updating-panels">Updating panels</a></h4>
<p>Sometimes you need to change a <code>Panel</code>, often in response to something done on
that panel -- like say you toggle between showing raw data points versus
aggregating in a heatmap, and want to expose extra heatmap settings. There are
two choices for how to do this: build a new panel entirely, or replace one
widget.</p>
<p>Often it's simplest to just split the method that builds a <code>Panel</code> into its own
method, and call it again with some different parameters. Very very occasionally
when you take this approach, you'll need to do
<code>new_panel.restore(ctx, &amp;self.panel); self.panel = new_panel;</code> to retain
internal widgetry state, such as &quot;this scrollbar is in the process of being
dragged by the mouse.&quot;</p>
<p>Or you can just replace one widget (which may be an entire row or column of
stuff; it's just based on the string ID you specify).
<code>self.panel.replace(ctx, &quot;edit&quot;, new_button)</code> does the trick.</p>
<h4 id="simplestate"><a class="header" href="#simplestate">SimpleState</a></h4>
<p>The free-formed nature of <code>State::event</code> is sometimes overwhelming; how do you
order all of the things that need to happen? You could also implement
<a href="https://github.com/a-b-street/abstreet/blob/master/widgetry/src/app_state.rs">SimpleState</a>
when you only have a single <code>Panel</code>. This gives a slightly more opinionated
interface, telling you when a button was clicked, slider was changed, when the
mouse was moved, etc. If you're confused, see how it implements <code>fn event</code> --
it's just organizing some typical different things that happen to handle an
event.</p>
<h2 id="higher-layers"><a class="header" href="#higher-layers">Higher layers</a></h2>
<p>Someday we want to release <code>widgetry</code> for general use to the Rust community. But
there's also lot of code shared between <code>game</code>, <code>fifteen_min</code>, and other apps
that handles UI concerns specific to <code>map_model</code>, which isn't something most
people will care about. This stuff goes in <code>map_gui</code>.</p>
<p>Lots of the <code>map_gui</code> code implements widgetry <code>States</code>, but those are
parameterized by a particular <code>App</code> struct. Since each of the top-level crates
uses a different struct, there's an
<a href="https://github.com/a-b-street/abstreet/blob/master/map_gui/src/lib.rs">AppLike trait</a>
to handle this level of indirection. If it walks like a duck...</p>
<h3 id="rendering-maps"><a class="header" href="#rendering-maps">Rendering maps</a></h3>
<p>There are generally two strategies for drawing the map. In the unzoomed view, we
tend to have a single <code>Drawable</code> for all buildings, another for all roads, etc.
In the zoomed view, only a few map elements (bus stops, lanes, buildings) are
visible at a time, so we can afford to show more detail, and store a <code>Drawable</code>
per object. In fact, there's no need to even calculate all of this zoomed-in
detail upfront; many maps are huge, and a player won't zoom into every section
in a particular session. So internally, most of the
<a href="https://github.com/a-b-street/abstreet/blob/master/map_gui/src/render/">Renderables</a>
use <code>RefCell</code> and lazily calculate what to draw.</p>
<p><code>DrawMap</code> internally manages a
<a href="https://en.wikipedia.org/wiki/Quadtree">quadtree</a> to figure out what to draw
and to help figure out what object is under the mouse cursor.</p>
<h3 id="async-madness"><a class="header" href="#async-madness">async madness</a></h3>
<p>If you want to see some scary Rust, check out
<a href="https://github.com/a-b-street/abstreet/blob/master/map_gui/src/load.rs">load.rs</a>.
There's a fatal flaw with the core <code>winit</code> event loop -- it was written before
Rust async landed. It's generally bad to spend more than a few milliseconds in
either <code>event</code> or <code>draw</code>; the app will appear sluggish, and at some point, the
window manager warns that the app is frozen. This happens when we
synchronously/blockingly load a big file from disk, or worse, from the network.</p>
<p>We're starting to figure out some of the workarounds. When there's &quot;proper&quot;
async Rust code, like for downloading a file on native, the trick is to spawn a
separate thread to execute the async block. The main thread (where <code>event</code> and
<code>draw</code> and most things run) stashes a <code>Future</code> inside of the <code>State</code>. In
<code>event</code>, it non-blockingly polls the future to see if its done. If not,
immediately return control to the window manager and just ask it to wake things
up again in a few milliseconds. Proper loading screens can be drawn this way.</p>
<p>All of this gets more complicated on the web, because you can't really spawn a
thread without somme web worker magic. It's still possible to make async HTTP
fetches work, but it's not all wired together yet.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="map-model"><a class="header" href="#map-model">Map model</a></h1>
<p>A/B Street transforms OpenStreetMap (OSM) data into a detailed geometric and
semantic representation of the world for traffic simulation. This chapter
describes that map model, with the hopes that it'll be useful for purposes
beyond this project.</p>
<h2 id="overview-1"><a class="header" href="#overview-1">Overview</a></h2>
<p>A <code>Map</code> covers everything inside some hand-drawn boundary, usually scoped to a
city or a few of a city's districts. Unlike OSM, it doesn't cover the entire
world; it only has areas specifically extracted for some purpose.</p>
<p>A map consists of many objects. Mainly, there are roads, broken down into
individual lanes, and intersections. A road is a single segment connecting
exactly two intersections (as opposed to OSM, where a single &quot;way&quot; may span many
intersections). Lanes within a road have a specific type, which dictates their
direction of travel (or lack of travel, like on-street parking) and uses.
Sidewalks are represented as bidirectional lanes. Roads connect at
intersections, which contain an explicit set of turns, each linking a source
lane to a destination lane.</p>
<p>Maps also contain parking lots and buildings, which connect to the nearest
driveable lane and a sidewalk. Maps have water and park areas, only used for
drawing. They also represent public transit stops and routes.</p>
<h2 id="how-is-a-map-used"><a class="header" href="#how-is-a-map-used">How is a map used?</a></h2>
<p>Unlike some GIS systems, maps don't use any kind of database -- they're just a
file, anywhere from 1 to ~500MB (depending on the size of their boundary). Once
loaded into memory, different objects from the map can be accessed directly,
along with a large API to perform various queries.</p>
<p>Most of the map's API is read-only; once built, a map doesn't change until
user-created edits are applied.</p>
<p>The pipeline to import a map from OSM data (and also optional supplementary,
city-specific data) is complex and may take a few minutes to run, but it happens
once offline. Applications using maps just read the final file.</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<p>Why use A/B Street's map model instead of processing OSM directly?</p>
<p>TODO: Order these better. For each one, show before/after pictures</p>
<h3 id="area-clipping"><a class="header" href="#area-clipping">Area clipping</a></h3>
<p>Bodies of water, forests, parks, and other areas are represented in OSM as
relations, requiring the user to stitch together multiple polylines in undefined
orders and handle inner holes. A/B Street maps handle all of that, and also clip
the area's polygon to the boundary of the entire map -- including coastlines.</p>
<h3 id="road-and-intersection-geometry"><a class="header" href="#road-and-intersection-geometry">Road and intersection geometry</a></h3>
<p>OSM represents roads as a polyline of the physical center of the road. A/B
Street infers the number and type of lanes from OSM metadata, then creates
individual lanes of appropriate width, each with a center-line and polygon for
geometry. At intersections, the roads and lanes are &quot;trimmed back&quot; to avoid
overlapping, and the &quot;common area&quot; becomes the intersection's polygon. This
heuristic process is reasonably robust to complex shapes, with special treatment
of highway on/off-ramps, although it does still have some bugs.</p>
<h3 id="turns-1"><a class="header" href="#turns-1">Turns</a></h3>
<p>At each intersection, A/B Street infers all legal movements between vehicle
lanes and sidewalks. This process makes use of OSM metadata about turn lanes,
inferring reasonable defaults for multi-lane roads. OSM turn restriction
relations, which may span a sequence of several roads to describe U-turns around
complex intersections, are also used.</p>
<h3 id="parking-lots"><a class="header" href="#parking-lots">Parking lots</a></h3>
<p>OSM models parking lots as areas along with the driveable aisles. Usually the
capacity of a lot isn't tagged. A/B Street automatically fills paring lots with
individual stalls along the aisles, estimating the capacity just from this
geometry.</p>
<h3 id="stop-signs"><a class="header" href="#stop-signs">Stop signs</a></h3>
<p>At unsignalized intersections, A/B Street infers which roads have to stop, and
which have right-of-way.</p>
<h3 id="traffic-signals"><a class="header" href="#traffic-signals">Traffic signals</a></h3>
<p>OSM has no way to describe how traffic signals are configured. A/B Street models
fixed-timer signals, automatically inferring the number of stages, their
duration, and the movements that are prioritized and permitted during each
stage.</p>
<h3 id="pathfinding"><a class="header" href="#pathfinding">Pathfinding</a></h3>
<p>A/B Street can determine routes along lanes and turns for vehicles and
pedestrians. These routes obey OSM's turn restriction relations that span
multiple road segments. They also avoid roads that're tagged as not allowing
through-traffic, depending on the route's origin and destination and vehicle
type. The pathfinding optionally makes use of contraction hierarchies to greatly
speed up query performance, at the cost of a slower offline importing process.</p>
<h3 id="bridge-z-ordering"><a class="header" href="#bridge-z-ordering">Bridge z-ordering</a></h3>
<p>OSM tags bridges and tunnels, but the roads that happen to pass underneath
bridges aren't mapped. A/B Street detects these and represents the z-order for
drawing.</p>
<h3 id="buildings"><a class="header" href="#buildings">Buildings</a></h3>
<p>Similar to areas, A/B Street consolidates the geometry of OSM buildings, which
may be split into multiple polygons. Each building is also associated with the
nearest driveable lane and sidewalk, and metadata is used to infer a land-use
(like residential and commercial) and commercial amenities available.</p>
<h3 id="experimental-public-transit"><a class="header" href="#experimental-public-transit">Experimental: public transit</a></h3>
<p>A/B Street uses bus stops and route relations from OSM to build a model of
public transit routes. OSM makes few guarantees about how the specifics of the
route are specified, but A/B Street produces specific paths, handling clipping
to the map boundary.</p>
<p>... All of this isn't the case yet, but it's a WIP!</p>
<h3 id="experimental-separated-cyclepaths-tramways-and-walking-paths"><a class="header" href="#experimental-separated-cyclepaths-tramways-and-walking-paths">Experimental: separated cyclepaths, tramways, and walking paths</a></h3>
<p>Some cyclepaths, tram lines, and footpaths in OSM are tagged as separate ways,
with no association to a &quot;main&quot; road. Sometimes this is true -- they're
independent trails that only occasionally cross roads. But often they run
alongside a road. A/B Street attempts to detect these and &quot;snap&quot; them to the
main road as extra lanes.</p>
<p>... But this doesn't work yet at all.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deep-dive-into-devilish-details-intersection-geometry"><a class="header" href="#deep-dive-into-devilish-details-intersection-geometry">Deep dive into devilish details: Intersection geometry</a></h1>
<p>Some of the things in A/B Street that seem the simplest have taken me tremendous effort. Determining the shape of roads and intersections is one of those problems, so this article is a deep-dive into how it works and why it's so hard.</p>
<p>Note 1: There's no &quot;related work&quot; section here -- I haven't found many other projects attempting something like this. I've seen a few research papers going in this direction, but none of them pointed to any code to try. The approach I'll describe has many flaws -- I'm not claiming this is a good solution, just the one that A/B Street uses. If you see a way to improve anything here, let me know about it! Even better, try it for real and send a PR -- there's plenty of tooling to help you debug and visually diff against the existing implementation. There should be a convenient button at the top-right of this page to suggest an edit in Github.</p>
<p>Note 2: This article would be way more awesome with code and some interactive demos to play around with each step. That level of ambition would prevent this from ever being written, though! I'll link to the real code and am happy to answer questions if anything's unclear.</p>
<p>Note 3: Apologies for the rough diagrams and lack of polish. I'm time-constrained and communicating the ideas is my priority.</p>
<ul>
<li><a href="tech/map/geometry/index.html#background">Background</a>
<ul>
<li><a href="tech/map/geometry/index.html#desired-output">Desired output</a></li>
</ul>
</li>
<li><a href="tech/map/geometry/index.html#overview-of-the-process">Overview of the process</a></li>
<li><a href="tech/map/geometry/index.html#part-1-thickening-the-infinitesmal">Part 1: Thickening the infinitesmal</a>
<ul>
<li><a href="tech/map/geometry/index.html#projecting-a-polyline">Projecting a polyline</a></li>
</ul>
</li>
<li><a href="tech/map/geometry/index.html#part-2-counting-coup">Part 2: Counting coup</a></li>
<li><a href="tech/map/geometry/index.html#part-3-the-clockwise-walk">Part 3: The clockwise walk</a>
<ul>
<li><a href="tech/map/geometry/index.html#sorting-roads-around-a-center">Sorting roads around a center</a></li>
</ul>
</li>
<li><a href="tech/map/geometry/index.html#interlude-problems-so-far">Interlude: problems so far</a>
<ul>
<li><a href="tech/map/geometry/index.html#funky-sidewalks">Funky sidewalks</a></li>
<li><a href="tech/map/geometry/index.html#lovecraftian-geometry">Lovecraftian geometry</a></li>
<li><a href="tech/map/geometry/index.html#bad-osm-data">Bad OSM data</a></li>
<li><a href="tech/map/geometry/index.html#highway-onoff-ramps">Highway on/off-ramps</a></li>
</ul>
</li>
<li><a href="tech/map/geometry/index.html#intersection-consolidation">Intersection consolidation</a>
<ul>
<li><a href="tech/map/geometry/index.html#where-short-roads-conspire">Where short roads conspire</a></li>
<li><a href="tech/map/geometry/index.html#why-we-want-to-do-something-about-it">Why we want to do something about it</a></li>
<li><a href="tech/map/geometry/index.html#goal">Goal</a></li>
<li><a href="tech/map/geometry/index.html#a-solution-two-passes">A solution: two passes</a></li>
<li><a href="tech/map/geometry/index.html#sorting-revisited">Sorting revisited</a></li>
<li><a href="tech/map/geometry/index.html#finding-the-short-roads">Finding the short roads</a></li>
</ul>
</li>
<li><a href="tech/map/geometry/index.html#conclusion">Conclusion</a></li>
<li><a href="tech/map/geometry/index.html#appendices">Appendices</a>
<ul>
<li><a href="tech/map/geometry/index.html#tricks-and-tooling">Tricks and tooling</a></li>
<li><a href="tech/map/geometry/index.html#hall-of-lovecraftian-horrors--the-stress-tests">Hall of Lovecraftian horrors / the stress tests</a></li>
<li><a href="tech/map/geometry/index.html#radically-simpler-approach">Radically simpler approach?</a></li>
<li><a href="tech/map/geometry/index.html#other-data-sources">Other data sources</a></li>
</ul>
</li>
</ul>
<h2 id="background"><a class="header" href="#background">Background</a></h2>
<p>Most street maps you'll find provide a simplified view of streets. Google Maps, Apple Maps, and most OpenStreetMap renderers mostly just tell you the road's name, color it by type (a highway, major arterial road, minor residential street), take great liberties with the width, and don't explicitly distinguish intersections from roads. These maps are used for navigation and drawing your attention to nearby businesses, so this is quite a reasonable view.</p>
<p><img src="tech/map/geometry/rainier_google.png" alt="" />
<em>From Google, it looks like Rainier is a much bigger road than S Massachusetts</em></p>
<p><img src="tech/map/geometry/rainier_osm.png" alt="" />
<em>The roads look about the same width in OSM</em></p>
<p><img src="tech/map/geometry/rainier_abst.png" alt="" />
<em>A/B Street reveals the turn lanes and also some bike lines on Massachusetts!</em></p>
<p><img src="tech/map/geometry/rainier_satellite.png" alt="" />
<em>Finally, Google's satellite imagery reveals the true shape of the intersection, though it's a bit hard to tell with the tree cover. And unless you zoom in, there's no way you'll spot the lane count or bike lanes.</em></p>
<p>A/B Street is all about imagining how traffic moves through a city and exploring the effects of redesigning streets. So of course, we need way more detail. To imagine a bike lane down Eastlake Ave instead of street parking, we need to first see how the street's space is allocated. To propose a more pedestrian-friendly traffic signal crossing from Husky Stadium to the UW medical building, we need to see that huge intersection.</p>
<p><img src="tech/map/geometry/eastlake_before.png" alt="" />
<em>Does Eastlake really need to dedicate 5 lanes to moving cars and 2 to storing them?</em></p>
<p><img src="tech/map/geometry/eastlake_after.png" alt="" />
<em>Talking about Eastlake having a safe cycling route is one thing, but isn't it much easier to imagin when you can just see it?</em></p>
<p>At a high-level, we want a representation that:</p>
<ol>
<li>Clearly communicates how a road is divided into different types of lanes (general purpose driving, turn lanes, bike lanes, bus-only lanes, street parking, sidewalks)</li>
<li>Represents the total road width, which tells us how we might change that lane configuration</li>
<li>Divides paved area into distinct roads and intersections. This division tells us where vehicles stop before entering an intersection, how pedestrians and vehicles are likely to move through the space, and what conflicts between them might occur.</li>
</ol>
<p>We're constrained to publicly available, free data sources. Although some cities have GIS departments with some datasets that might be helpful, we're pretty much going with OpenStreetMap (OSM), which has decent coverage of most cities worldwide.</p>
<h3 id="desired-output"><a class="header" href="#desired-output">Desired output</a></h3>
<p>Let's be a little more specific about the representation we want. If you imagine a city as flat 2D space, roads and intersections occupy some portion of it. (Let's ignore bridges and tunnels.)</p>
<p><img src="tech/map/geometry/thick_pt1.png" alt="" />
<em>Here's a three-way intersection at your typical Seattle angle</em></p>
<p>We want to partition this space into individual intersections and road segments. Each road segment (just called &quot;road&quot; for simplicity) leads between exactly two of those intersections. This partition shouldn't have any ambiguous overlap between objects.</p>
<p><img src="tech/map/geometry/thick_pt2.png" alt="" />
<em>The red part is what we'll deem the intersection. The grey roads and the intersection now partition the space.</em></p>
<p>A simplifying assumption, mostly coming from OSM, is that roads can be represented as a center-line and width, and individual lanes can be formed by projecting that center-line left and right. This means when the road changes width in the middle (like for pocket parking or to make room for a turn lane), we have to model that transition as a small &quot;degenerate&quot; intersection, which connects only those two roads.</p>
<p><img src="tech/map/geometry/degenerate.png" alt="" />
<em>Two lanes become four -- probably some turn lanes appearing. The lighter grey is our intersection.</em></p>
<p>Another assumption taken by A/B Street is that roads hit intersections at a perpendicular angle.</p>
<p><img src="tech/map/geometry/perp_no_traffic.png" alt="" />
<em>Note how the intersection &quot;eats into&quot; Boren, the diagonal road more than you might expect.</em></p>
<p>We use this division to determine where vehicles stop, and where a crosswalk exists:</p>
<p><img src="tech/map/geometry/perp_traffic.png" alt="" />
<em>Does it seem like vehicles have stopped too far away from the intersection?</em></p>
<p>Of course, this assumption isn't always true in reality:</p>
<p><img src="tech/map/geometry/perp_satellite.png" alt="" />
<em>The crosswalks across Boren are horizontal!</em></p>
<p>If we allowed roads to hit intersections at non-perpendicular angles, but still insisted that the stop position for each individual lane was perpendicular, it might have a &quot;jagged tooth&quot; look:</p>
<p><img src="tech/map/geometry/perp_teeth.png" alt="" />
<em>The cyan lines show one way to represent adjacent lanes that extend different lengths.</em></p>
<p>But for the sake of this article, these're the assumptions we're sticking with. Pedestrian islands, slip lanes, gores, and medians are all real-world elements that don't fit nicely in this model.</p>
<h2 id="overview-of-the-process"><a class="header" href="#overview-of-the-process">Overview of the process</a></h2>
<p>We'll now explore the steps to produce geometry for a single intersection and its connected roads. The broad overview:</p>
<ol>
<li>Pre-process OSM into road center-lines with attributes, with each road connecting just two intersections.</li>
<li>Thicken each road</li>
<li>Trim back the roads based on overlap</li>
<li>Produce the intersection polygon</li>
</ol>
<p>Let's pick a particularly illustrative <a href="https://www.openstreetmap.org/node/1705063811">five-way intersection</a> as our example.</p>
<h2 id="part-1-thickening-the-infinitesmal"><a class="header" href="#part-1-thickening-the-infinitesmal">Part 1: Thickening the infinitesmal</a></h2>
<p>OSM models roads as a center-line -- supposedly the physical center of the paved area, not the solid or dashed yellow line (t least in the US) separating the two directions of traffic. The schema, and how it gets mapped in practice, is fuzzy when there are more lanes in one direction than the other or when roads join or split up for logical routing, but... let's keep things simple to start.</p>
<p><img src="tech/map/geometry/osm_center_lines.png" alt="" />
<em>5 roads meet at this intersection. The white lines are OSM's center line.</em></p>
<p>OSM has a few tags (link) for explicitly mapping road width, but in practice they're not used. Instead, we have a whole bunch of tags that describe the lane configuration of the road. A/B Street interprets these and produces an ordered list of lanes from the left side of the road to the right, guessing the direction, width, and type of each lane. See the <a href="https://github.com/dabreegster/abstreet/blob/master/map_model/src/make/initial/lane_specs.rs">code here</a> -- it's fairly lengthy, but has some intuitive unit tests. This interpretation of tags is hard in practice because the schema is very confusing, there are multiple ways of mapping the same thing, people make many mistakes in practice, etc. <!-- TODO, list some examples like cycleway:left:separator:right. --></p>
<p><img src="tech/map/geometry/tags_to_lane_specs.png" alt="" />
<em>A very simple example of OSM tags on the left, and on the right, A/B Street's interpretation of each lane, ordered from the left side of the road.</em></p>
<p>So for each road, we estimate the total width based on the lane tagging. Then we project the center line to the left and right, giving us a thickened polygon for the entire road:</p>
<p><img src="tech/map/geometry/thickened_5.png" alt="" />
<em>All 5 of our roads, thickened based on the lane tagging. The red dot is the position of the OSM node shared by these roads.</em></p>
<h3 id="projecting-a-polyline"><a class="header" href="#projecting-a-polyline">Projecting a polyline</a></h3>
<p>Before we move on, a quick primer on how to take a polyline (a list of ordered points) and project it to the left or right. There are some better explanations of this online, but I don't have them handy. I wouldn't call A/B Street's <a href="https://github.com/a-b-street/abstreet/blob/91c152c123924d7b8bfa14722d18c652d7e42966/geom/src/polyline.rs#L435">implementation</a> fantastic, but it's there for reference.</p>
<p><img src="tech/map/geometry/project_pt1.png" alt="" /></p>
<p>The original polyline is in black. If you can't tell from my quick drawing, it consists of 3 line segments glued together. We want to shift it to the right some distance. We start by taking each line segment and projecting it to the right that distance. That operation is simple -- rotate the line's angle by 90 degrees, then project the line's endpoints that direction. The 3 projected line segments are shown in blue, green, and red.</p>
<p>There are two types of problems we need to fix for the new polyline to be glued together nicely. The blue and the green line segment intersect each other, so we'll trim both segments to that common point:</p>
<p><img src="tech/map/geometry/project_pt2.png" alt="" />
<em>Please forgive my horrid paint editor skills</em></p>
<p>The green and the red line segments are far apart. Let's imagine they keep extending until they do intersect. If I recall proper terminology, this is a miter join:</p>
<p><img src="tech/map/geometry/project_pt3.png" alt="" /></p>
<p>And that's it! Easy.</p>
<p>... Except not really. The real world of OSM center-lines has every imaginable edge case. When a road is both thick and sharply angled enough, extending those line segments until they meet works... but the hit might be very far away:</p>
<p><img src="tech/map/geometry/project_sharp.png" alt="" /></p>
<p>My workaround currently is to hardcode a maximum distance away from the original line endpoints. If our miter cap reaches beyond that, just draw a straight line between the two segments. I think this is known as a bevel join.</p>
<p>Just for fun, let's see what happens when a polyline doubles back on itself in some less-than-realistic ways:</p>
<p><img src="tech/map/geometry/project_lovecraftian.gif" alt="" /></p>
<p>Truly Lovecraftian geometry. I don't think I often see points from OSM totally out of order like this, but it happens sometimes and is immediately obvious.</p>
<h2 id="part-2-counting-coup"><a class="header" href="#part-2-counting-coup">Part 2: Counting coup</a></h2>
<p>For each road, we've got the original center from OSM and our calculated the left and right side:</p>
<p><img src="tech/map/geometry/coup_pt1.png" alt="" />
<em>The left and right sides of the 5 roads are shown -- not the original centers. I manually traced this; slight errors are visible.</em></p>
<p>Now the magic happens. You'll notice that many of those polylines collide (For sanity, let's call these &quot;collisions&quot; and not &quot;intersections&quot;, since that term is overloaded here!). Let's find every collision point:</p>
<p><img src="tech/map/geometry/coup_pt2.png" alt="" />
<em>Collisions drawn as black dots</em></p>
<p>These collisions represent where two thickened roads overlap. So let's use them to &quot;trim back&quot; the roads and avoid overlap. For each collision, we form an infinitely long line perpendicular to the collision and find where it hits the original center-line. We'll trim the road back to at least that point.</p>
<p><img src="tech/map/geometry/coup_pt3.png" alt="" />
<em>The red road's original center is now shown, in a darker red. The collision between the red and green road is shown, with a yellow line used to find the position along the original center. We'll trim the center back to this point, at least.</em></p>
<p>Because we want roads to meet intersections perpendiculously (I'm quite sure that's the proper term), we want the left and right side of a road to line up. There's probably a collision on a road's left and right side, and usually one of them would cause the center-line to be trimmed back more than the other. We'll always trim back as much as possible.</p>
<p><img src="tech/map/geometry/coup_pt4.png" alt="" />
<em>The collision between the red and blue road is shown in yellow. The corresponding position on the original red road's center line is found, then trimmed back.</em></p>
<p>If we repeat this for every collision, eventually we wind up with:</p>
<p><img src="tech/map/geometry/coup_final.png" alt="" />
<em>All roads have been trimmed back, with their left and right sides projected again</em></p>
<p>Some questions to consider:</p>
<ol>
<li>
<p>Why look for collisions between every pair of left/right lines? Couldn't we just use the &quot;adjacent&quot; pairs?</p>
</li>
<li>
<p>Is it ever possible for the line perpendicular to a collision to NOT hit the original center-line?</p>
</li>
</ol>
<p>(As I'm reviewing my old code and writing this up, these're things I don't remember, worth revisiting.)</p>
<h2 id="part-3-the-clockwise-walk"><a class="header" href="#part-3-the-clockwise-walk">Part 3: The clockwise walk</a></h2>
<p>We've now trimmed roads back to avoid overlapping each other. We just need to generate the polygon for the intersection. As a first cut, let's take these trimmed center-lines, calculate the left and right polylines again (since we've changed the center line), and use the endpoints for the shape.</p>
<p><img src="tech/map/geometry/clockwise_naive.png" alt="" />
<em>The red polygon is the intersection shape formed from these endpoints. The pink portions don't look right!</em></p>
<p>Oops, the polygon covers a bit too much space! Cut red tape, queues, and split ends, but not corners. What if we remember all of the collision points, and use those too?</p>
<p><img src="tech/map/geometry/clockwise_better.png" alt="" /></p>
<p>Much better.</p>
<h3 id="sorting-roads-around-a-center"><a class="header" href="#sorting-roads-around-a-center">Sorting roads around a center</a></h3>
<p>I snuck another fast one on ya. When we form a polygon from these left/right endpoints and the original collision points, how do we put those points in the correct order? Seemingly innocent question.</p>
<p>There are a few approaches that work fine for the simple cases. First, from OSM we know the single point where the 5 road center lines meet. After we've calculated the points for the intersection polygon, we can use that single point, calculate the angle to each polygon point, and sort. That works fine.</p>
<p><img src="tech/map/geometry/sorting_orig_center.png" alt="" />
<em>The road center-lines all meet at one point, from the original OSM data.</em></p>
<p>Foreshadowing: But soon, things won't be so simple. </p>
<h2 id="interlude-problems-so-far"><a class="header" href="#interlude-problems-so-far">Interlude: problems so far</a></h2>
<p>That wasn't actually so bad! The results are reasonable in many cases:</p>
<p><img src="tech/map/geometry/good1.png" alt="" />
<img src="tech/map/geometry/good2.png" alt="" />
<img src="tech/map/geometry/good3.png" alt="" /></p>
<p>But what kind of things go wrong?</p>
<h3 id="funky-sidewalks"><a class="header" href="#funky-sidewalks">Funky sidewalks</a></h3>
<p>What's going on with the sidewalk in that last example?</p>
<p><img src="tech/map/geometry/sidewalk_corners.gif" alt="" /></p>
<h3 id="lovecraftian-geometry"><a class="header" href="#lovecraftian-geometry">Lovecraftian geometry</a></h3>
<p>Sometimes followers of Cthulu edit OSM, I assume.</p>
<p><img src="tech/map/geometry/lovecraft1.png" alt="" />
<em>What... is happening here?</em></p>
<p><img src="tech/map/geometry/lovecraft2.png" alt="" />
<em>Even the thickened roads, before calculating intersection polygons, look broken.</em></p>
<p><img src="tech/map/geometry/lovecraft3.png" alt="" />
<em>Before I can investigate, somebody has already fixed the problem upstream in OSM!</em></p>
<!-- I think there are cases where two thick roads overlap, but don't share an intersection. -->
<h3 id="bad-osm-data"><a class="header" href="#bad-osm-data">Bad OSM data</a></h3>
<p>Often times, the upstream OSM data is just flat-out wrong. Center lines for divided one-way roads are way too close to each other, so using the number of lanes with a reasonable guess at width produces roads that overlap outside of the intersection. This throws off everything we've done!</p>
<p><img src="tech/map/geometry/smushed.png" alt="" /></p>
<p>Another example is people tagging the lane count incorrectly. A common problem when splitting a bidirectional road into two one-ways (which is what you're supposed to do when there's physical separation like a median) is forgetting to change the lane count. I don't have examples handy, because I've fixed every case I've found.</p>
<p>An important lesson when trying to write algorithms using OSM data: there's a balance between making your code robust to problems in the data, and trying to fix everything upstream. I attempt a compromise. It's a virtuous cycle -- in trying to use OSM data in this new way, I wind up fixing the data sometimes.</p>
<h3 id="highway-onoff-ramps"><a class="header" href="#highway-onoff-ramps">Highway on/off-ramps</a></h3>
<p>When three nearly parallel roads meet, our algorithm is a bit over-eager with the size of the intersection:</p>
<p><img src="tech/map/geometry/ramp1.png" alt="" /></p>
<p>This case isn't even a real &quot;intersection&quot; -- a one-way highway has two different off-ramps jut out. At some point, I had some scribbled diagrams in a notebook somewhere from when I worked on this, but it's lost -- luckily the <a href="https://github.com/a-b-street/abstreet/blob/e2fc59a31aa043a879a372b2350b1f42391ee740/map_model/src/make/initial/geometry.rs#L434">code for this case</a> is pretty simple. This produces much better results here:</p>
<p><img src="tech/map/geometry/ramp2.png" alt="" /></p>
<h2 id="intersection-consolidation"><a class="header" href="#intersection-consolidation">Intersection consolidation</a></h2>
<p>The skeptical reader has noticed the suspicious lack of complex intersections so far. Time to dive into that.</p>
<h3 id="where-short-roads-conspire"><a class="header" href="#where-short-roads-conspire">Where short roads conspire</a></h3>
<p>In OSM, roads with opposite directions of traffic separated by any sort of center median -- even if it's just a small raised curb -- are mapped as two parallel one-way roads. These're also called divided highways or dual carriageways. When these intersect, we wind up with lots of short &quot;road segments&quot; and several intersections all clustered together:</p>
<p><img src="tech/map/geometry/divided_simple.png" alt="" />
<em>The simplest case: the east/west road is a pair of one-ways, and the north/south is a regular road without a median</em></p>
<p><img src="tech/map/geometry/divided_angle.png" alt="" />
<em>In case you were hoping these situations always happened at nice 90 degree angles, think again</em></p>
<p><img src="tech/map/geometry/divided_join.png" alt="" />
<em>Sometimes one dual carriageway joins back as a regular bidirectional road just before intersecting another dual carriageway...</em></p>
<p><img src="tech/map/geometry/divided_streetcar.png" alt="" />
<em>Why not 4 parallel one-way roads? Can't forget street cars!</em></p>
<p><img src="tech/map/geometry/divided_taipei.png" alt="" />
<em>And everytime I think I might've handled most cases, I'm humbled by Taipei.</em></p>
<p>But wait, there's more. How about &quot;dog-leg&quot; intersections, where one road shifts over slightly as it crosses another?</p>
<p><img src="tech/map/geometry/dogleg_alley.png" alt="" />
<em>The not-at-all elusive alley dog-leg</em></p>
<p>But sometimes something looking like a dog-leg actually isn't -- if vehicles can legitimately stop and queue in the middle of the &quot;intersection&quot;, even if it's only one or two of them, then I think that interior &quot;road&quot; deserves to remain separate:</p>
<p><img src="tech/map/geometry/dogleg_false.png" alt="" /></p>
<p>And then there's just the cases where I'm pretty sure civil engineers anticipated me writing this algorithm, and found the most obnoxious angles for roads to meet in order to maximize my pain:</p>
<p><img src="tech/map/geometry/boston_merge.png" alt="" /></p>
<h3 id="why-we-want-to-do-something-about-it"><a class="header" href="#why-we-want-to-do-something-about-it">Why we want to do something about it</a></h3>
<p>So hold up, what's the problem? Some areas that people treat as one physical intersection in reality are modelled in OSM as a cluster of intersections, with lots of short &quot;roads&quot; linking them together. It's fine from a graph connectivity and routing perspective. What could go wrong?</p>
<p>Well for starters, with the algorithm described so far that tries to render the physical shape, it's completely visually incomprehensible:</p>
<p><img src="tech/map/geometry/hard_to_see.png" alt="" />
<em>The 4 &quot;interior&quot; intersections here even get stop signs placed!</em></p>
<p>These complicated intersections are often the ones that would be the most interesting to study in A/B Street, but just try modifying lanes in these cases:</p>
<p><img src="tech/map/geometry/edit_transit.png" alt="" />
<em>Considering a bus lane for the 520 off-ramp at Montlake?</em></p>
<p>Now throw traffic signals into the mix. A/B Street tries to simulate those, so when we have a cluster of two or four of them super close, now we have to somehow try to synchronize their timing. When somebody wants to edit them, now they have to operate on all of them at once! We even extended the UI to handle that, but it's quite a poor editing experience.</p>
<p><img src="tech/map/geometry/edit_one.png" alt="" />
<em>Reasoning about 4 separate pieces of one traffic signal is not pleasant</em></p>
<p><img src="tech/map/geometry/edit_multiple.png" alt="" />
<em>We can do slightly better by editing all 4 at once, but what do those movement arrows in the middle even mean? You have to reason about where vehicles might've come from to even get there.</em></p>
<p>And finally, traffic simulation gets MUCH harder. A/B Street models vehicles as having some length, meaning a vehicle's front can make it through one intersection, but its tail gets stuck there:</p>
<p><img src="tech/map/geometry/tails.png" alt="" />
<em>These two cars are blocking all movements through the pair of intersections</em></p>
<p>At the simulation layer, vehicles moving through an intersection conflict with each other very coarsely. If a vehicle is partially stuck in the intersection, it prevents othr vehicles from starting potentially conflicting turns. So to prevent this problem from happening, the simulation has complicated rules so that vehicles do not &quot;block the box&quot; -- if they enter an intersection, they must be guaranteed to fully exit and clear it, not get stuck somewhere in the middle. These rules blow up in the presence of short roads like this. Lots of effort has gone into workarounds at the simulation layer, but... just fixing the representation in the map model seems much more desirable.</p>
<h3 id="goal"><a class="header" href="#goal">Goal</a></h3>
<p>In reality, many of these clusters of intersections and short roads are actually just one &quot;logical&quot; intersection. If you consider where vehicles stop or where crosswalks are placed, this can make this definition a little bit more clear, but it's somewhat subjective. In A/B Street, we aim to &quot;consolidate&quot; this cluster into just one intersection. Visually coherent geometry, reasoning about a single traffic signal, and preventing vehicles from getting stuck in the cluster are the goals.</p>
<p>Before we dive into the approach to consolidate, let's look at some success stories.</p>
<p><img src="tech/map/geometry/better_streetcar.png" alt="" />
<em>A single intersection handles the 4 parallel OSM ways.</em></p>
<p><img src="tech/map/geometry/better_tsigs.png" alt="" />
<em>You can now edit the signal timing as if this is just a regular massive Arizona intersection.</em></p>
<p><img src="tech/map/geometry/better_angled.png" alt="" />
<em>The angled cut is a bit too aggressive and the crosswalk &quot;leaks&quot; out, but this is a definite improvement.</em></p>
<p><img src="tech/map/geometry/better_montlake.png" alt="" />
<em>Four intersections become one, again with a slight geometric distortion</em></p>
<h3 id="a-solution-two-passes"><a class="header" href="#a-solution-two-passes">A solution: two passes</a></h3>
<p>For some history getting to this point, check out <a href="https://github.com/a-b-street/abstreet/issues/654">previous attempts</a> and <a href="https://github.com/a-b-street/abstreet/pull/710">more before/after examples</a>.</p>
<p>Consolidating a complex intersection happens in a few steps.</p>
<ol>
<li>Identify the short roads</li>
<li>Run the regular algorithm for intersection geometry, and remember how much each road's center line gets trimmed back</li>
<li>Remove the short road and fix up graph connectivity</li>
<li>Use the &quot;pre-trimmed&quot; center line to project each surviving road to the left and right</li>
<li>Assemble those points in order to create the consolidated intersection's polygon</li>
</ol>
<p>Step 1 and 5 are covered in more detail in below sections.</p>
<p>For step 2, we start with the regular algorithm described so far, applied to each intersection:</p>
<p><img src="tech/map/geometry/consolidate_pt1.png" alt="" />
<em>The results of running the algorithm on the 2 green intersections. The pink road in the middle is marked for merging.</em></p>
<p>Then we delete the short road. The <a href="https://github.com/a-b-street/abstreet/blob/c5671557defbd80ce749b8fa7faf7c166b3d23dd/map_model/src/raw.rs#L300">details</a> of how this is done are particular to A/B Street's intermediate representation of a map model. Graph connectivity and all sorts of turn restrictions must be preserved. But geometrically, it just looks like this:</p>
<p><img src="tech/map/geometry/consolidate_pt2.png" alt="" /></p>
<p>Then we run step 4, finding the left and right side of each surviving road:</p>
<p><img src="tech/map/geometry/consolidate_pt3.png" alt="" />
<em>Black lines show the left and right side of each road. The red dots are the endpoints of each line.</em></p>
<p>Now if we just use those red dots, we can create the final polygon for this consolidated intersection.</p>
<h3 id="sorting-revisited"><a class="header" href="#sorting-revisited">Sorting revisited</a></h3>
<p>To assemble the endpoints into a polygon, we need to know what order they go in. If you recall from an earlier section, we used the original shared point from OSM to do this:</p>
<p><img src="tech/map/geometry/sorting_orig_center.png" alt="" /></p>
<p>But now things are less clear -- we have multiple shared points, from before consolidation. As a first pass, maybe we can just average all of the points, call that the &quot;center,&quot; calculate the angle to each point, and order clockwise.</p>
<p>(diagram)</p>
<p>Before trimming, how do you do this? The point farthest away? A point a fixed few meters away?</p>
<p>For consolidated intersections, probably use the pre-trimmed point</p>
<p>Example Tempe intersection with light rail that blows it up. Center vs polylabel.</p>
<h3 id="finding-the-short-roads"><a class="header" href="#finding-the-short-roads">Finding the short roads</a></h3>
<p>I've been tagging junction=intersection manually upstream to opt them in slowly.</p>
<p>Tried some approaches that look for all short road (pre trimmed or post?). Usually breaks.</p>
<p>Targeted heuristics for 2 and 4-clusters of tsigs.</p>
<p>Examples in Loop 101 -- it gets crazy.</p>
<p>Focusing on tsig clusters for now, since they cause the most problems to traffic sim, but very much ongoing work.</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>Given how much time I've sunk into trying to automatically generate decent geometry from an OSM schema absolutely not meant for this, I hope you don't fault me for wanting to try some radically different ideas, like mapping from scratch. There are some intersections just not worth trying to squeeze into OSM's model. Maybe in some future, I'll explore something very different. Or play around with some of the proposals to tag OSM junction areas.</p>
<h2 id="appendices"><a class="header" href="#appendices">Appendices</a></h2>
<h3 id="tricks-and-tooling"><a class="header" href="#tricks-and-tooling">Tricks and tooling</a></h3>
<ul>
<li>screenshot diff as a regression test!</li>
<li>back and forth on RawMap editor and marking stuff in the main game. fast reimports. be able to adjust road centers in rawmap, quickly toggle shorties on or off, preview geometry.</li>
<li>how to debug? this is wedged in the middle of an import process, should we emit extra &quot;side output&quot; files to visualize later? Some kind of step-through debugger, live edit code would be fantastic.</li>
</ul>
<h3 id="hall-of-lovecraftian-horrors--the-stress-tests"><a class="header" href="#hall-of-lovecraftian-horrors--the-stress-tests">Hall of Lovecraftian horrors / the stress tests</a></h3>
<p>montlake/520</p>
<p>roundabouts</p>
<p>south of fremont bridge</p>
<h3 id="radically-simpler-approach"><a class="header" href="#radically-simpler-approach">Radically simpler approach?</a></h3>
<p>Why not just thicken roads, calc bool overlap?  robust bool-op library, and also three-ways</p>
<p>why not map manually? OSM sort of has schema. maybe infer for most but not all.</p>
<h3 id="other-data-sources"><a class="header" href="#other-data-sources">Other data sources</a></h3>
<p>I've come across a few cities that seem to have a vector dataset describing road polygons or curbs. I haven't tried working with any of these before, but it would be a useful exercise to start with one of these as the base, and snap OSM road segments to this to get metadata about lanes and connectivity, but not geometry.</p>
<ul>
<li><a href="https://streetsillustrated.seattle.gov/map/">Seattle Streets Illustrated</a> includes some kind of CAD basemap that looks amazingly realistic
<ul>
<li>From some old emails with King County GIS, this is based on an impervious surface layer with a license preventing it from being released as public data</li>
</ul>
</li>
<li>Actually, <a href="https://data.seattle.gov/dataset/Pavement-Edge-zip/gy82-cq84">https://data.seattle.gov/dataset/Pavement-Edge-zip/gy82-cq84</a> appears to be the curbs for Seattle! Possibly the data is from 1999, updated maybe in 2011.</li>
<li><a href="https://distanciamiento.inspide.com">https://distanciamiento.inspide.com</a> appears to have detailed sidewalk polygons for Madrid</li>
</ul>
<p><img src="tech/map/geometry/streets_illustrated.png" alt="" />
<em>The Fremont bridge and Nickerson looks fantastic in Seattle Streets Illustrated, but the data isn't public</em></p>
<p><img src="tech/map/geometry/pavement_edge.png" alt="" />
<em>The pavement edge dataset is public, though, and seems to be quite similar!</em></p>
<p><img src="tech/map/geometry/pullman.png" alt="" />
<em>Pullman, WA provided sidewalk polygons for mapping in OSM</em></p>
<p>These vector datasets feel like some sort of holy grail, but all of the work described in this article is still useful, because:</p>
<ol>
<li>Not every city has this kind of public data</li>
<li>If road edits need to legitimately widen or shrink a road, it's not obvious how to modify these curbs. But then again, just rechannelizing lanes, subject to the area that's already been paved, is kind of the main type of edit in A/B Street...</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="map-model-details"><a class="header" href="#map-model-details">Map model details</a></h1>
<p>A/B Street builds a rich representation of a city map using OpenStreetMap (OSM)
and other sources. This chapter describes how.</p>
<p>TODO: Integrate pictures from
<a href="https://docs.google.com/presentation/d/1cF7qFtjAzkXL_r62CjxBvgQnLvuQ9I2WTE2iX_5tMCY/edit?usp=sharing">these slides</a>.</p>
<p><a href="https://youtu.be/chYd5I-5oyc?t=439">This recorded presentation</a> covers some of
this.</p>
<h2 id="the-map"><a class="header" href="#the-map">The map</a></h2>
<p>A single city is broken down into different pieces...</p>
<p>A/B Street comes with a few maps, each defined by a bounding/clipping polygon
for some portion of Seattle. Each map has these objects:</p>
<ul>
<li><strong>Roads</strong>: A single road connects two intersections, carrying OSM metadata and
containing some child lanes.</li>
<li><strong>Lanes</strong>: An individual lane of traffic. Driving (any vehicle), bus-only, and
bike-only lanes have a direction. On-street parking lanes don't allow any
movement, and they have some number of parking spots. Sidewalks are
bidirectional.</li>
<li><strong>Intersections</strong>: An intersection has references to all of the incoming and
outgoing lanes. Most intersections have a stop sign or traffic signal policy
controlling movement through it.
<ul>
<li><strong>Border</strong> intersections on the edge of the map are special places where
agents may appear or disappear.</li>
</ul>
</li>
<li><strong>Turns</strong>: A turn connects one lane to another, via some intersection.
(Sidewalks are bidirectional, so specifying the intersection is necessary to
distinguish crosswalks at each end of a sidewalk.)</li>
<li><strong>Buildings</strong>: A building has a position, OSM metadata, and a <strong>front path</strong>
connecting the edge of the building to the nearest sidewalk. Most trips in A/B
Street begin and end at buildings. Some buildings also contain a number of
off-street parking spots.</li>
<li><strong>Area</strong>: An area has geometry and OSM metadata and represents a body of
water, forest, park, etc. They're just used for drawing.</li>
<li><strong>Bus stop</strong>: A bus stop is placed some distance along a sidewalk, with a
pointer to the position on the adjacent driving or bus lane where a bus stops
for pick-up.</li>
<li><strong>Bus route</strong>: A bus route has a name and a list of stops that buses will
cycle between. In the future, they'll include information about the
frequency/schedule of the route.</li>
<li><strong>Parking lot</strong>: A parking lot is connected to a road, has a shape, and has
some internal driving &quot;aisles.&quot; The number and position of individual parking
spots is auto-generated.</li>
</ul>
<h2 id="coordinate-system"><a class="header" href="#coordinate-system">Coordinate system</a></h2>
<p>A/B Street converts (longitude, latitude) coordinates into a simpler form.</p>
<ul>
<li>An (x, y) point starts with the top-left of the bounding polygon as the
origin. Note this is screen drawing order, not a Cartesian plane (with Y
increasing upwards) -- so angle calculations account for this.</li>
<li>The (x, y) values are f64's trimmed to a few decimal places, with way more
precision than is really needed. These might become actual fixed-point
integers later, but for now, a <code>Pt2D</code> skirts around Rust's limits on f64's by
guaranteeing no NaN's or infinities and thus providing the full <code>Eq</code> trait.</li>
<li>A few places in map conversion compare points using different thresholds,
usually below 1 meter. Ideally these epsilon comparisons could be eliminated
in favor of a fixed-point integer representation, but for now, explicit
thresholds are useful.</li>
</ul>
<h2 id="invariants"><a class="header" href="#invariants">Invariants</a></h2>
<p>Ideally, the finalized maps would satisfy a list of invariants, simplifying the
traffic simulation and drawing code built on top. But the input data is quite
messy and for now, most of these aren't quite guaranteed to be true.</p>
<ul>
<li>Some minimum length for lanes and turns. Very small lanes can't be drawn, tend
to break intersection polygons, and may lead to gridlocked traffic.</li>
<li>Some guarantees that positions along adjacent lanes actually match up, even
though different lanes on the same road may have different lengths. Examples
include the position of a bus stop on the sidewalk and bus lane matching up.
<ul>
<li>Additionally, parking lanes without an adjacent driving lane or bus stops
without any driving or bus lanes make no sense and should never occur.</li>
</ul>
</li>
<li>Connectivity -- any sidewalk should be reachable from any other, and most
driving lanes should be accessible from any others. There are exceptions due
to border intersections -- if a car spawns on a highway along the border of
the map, it may be forced to disappear on the opposite border of the map, if
the highway happens to not have any exits within the map boundary.</li>
</ul>
<h2 id="connectivity"><a class="header" href="#connectivity">Connectivity</a></h2>
<p>For a single mode, each lane is connected to two intersections. Turns connect
two lanes. There are no turns between sidewalks and driving/bike/bus lanes.</p>
<p>All buildings and parking lots have driveways. This must connect to a sidewalk,
allowing pedestrians to enter/exit that object. The driveway OPTIONALLY connects
to the nearest driveable lane. This allows cars to enter/exit that object for
parking.</p>
<p>Public transit stops are located somewhere on a sidewalk. They're associated
with a driveable position where the bus or train stops. In the future, this will
need to account for dedicated surface-level platforms and for underground
transit stations, likely associated with a building.</p>
<p>There's a concept of &quot;parking blackholes.&quot; If you treat every road as
bidirectional without access restrictions, then the graph is connected. But the
more detailed view has to factor in one-way roads and things near the map
border. These blackholes influence where cars will try to look for parking
(since we don't want them entering a blackhole and getting stuck) and also, for
temporary/unintentional reasons, where pedestrian&lt;-&gt;bicycle transitions will
happen.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="importing"><a class="header" href="#importing">Importing</a></h1>
<p>This chapter describes the process of transforming OSM extracts into A/B
Street's map model. These are implementation details; you may be looking <a href="tech/map/importing/../../../user/new_city.html">for
the user guide to importing a new city</a>.</p>
<p>The steps are:</p>
<ol>
<li>A large .osm file is clipped to a hand-drawn boundary region, using
<code>osmconvert</code></li>
<li>The <code>convert_osm</code> crate reads the clipped <code>.osm</code>, and a bunch of optional
supplementary files, and produces a <code>RawMap</code></li>
<li>Part of the <code>map_model</code> crate transforms the <code>RawMap</code> into the final <code>Map</code></li>
<li>Other applications read and use the <code>Map</code> file</li>
</ol>
<p>The <code>importer</code> crate orchestrates these steps, along with automatically
downloading any missing input data.</p>
<p>The rest of these sections describe each step in a bit more detail. Keeping the
docs up-to-date is hard; the best reference is the code, which is hopefully
organized clearly.</p>
<p>Don't be afraid of how complicated this pipeline seems -- each step is
relatively simple. If it helps, imagine how this started -- just chop up OSM
ways into road segments, infer lanes for each road, and infer turns between the
lanes.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="from-osm-to-rawmap-convert_osm-crate"><a class="header" href="#from-osm-to-rawmap-convert_osm-crate">From OSM to RawMap (<code>convert_osm</code> crate)</a></h1>
<p>The first phase of map building reads in data from OSM files and a few others,
producing a serialized <code>RawMap</code>.</p>
<p>Only major steps are described; see the code for the rest.</p>
<h2 id="extractrs"><a class="header" href="#extractrs">extract.rs</a></h2>
<p>Read .osm, extracting the points for road-like ways, buildings, and areas</p>
<ul>
<li>Areas usually come from a relation of multiple ways, with the points out of
order. Gluing all the points together fails when the .osm has some ways
clipped out. In that case, try to trace along the map boundary if the partial
area intersects the boundary in a clear way. Otherwise, just use a straight
line to try to close off the polygon.</li>
<li>Also read traffic signal locations and turn restrictions between OSM ways</li>
</ul>
<h2 id="split_waysrs"><a class="header" href="#split_waysrs">split_ways.rs</a></h2>
<p>Split OSM ways into road segments</p>
<ul>
<li>OSM ways cross many intersections, so treat points with multiple ways and the
points at the beginning and end of a way as intersections, then split the way
into road segments between two intersections.</li>
<li>This phase remembers which road segment is the beginning and end of the OSM
way, for per-lane turn restrictions later</li>
<li>Apply turn restrictions between roads here. Since OSM ways cross many
intersections, the turn restrictions only apply to one particular road segment
that gets created from the way. Make sure the destination of the restriction
is actually incident to a particular source road.</li>
</ul>
<h2 id="clip"><a class="header" href="#clip">clip</a></h2>
<p>Clip the map to the boundary polygon</p>
<ul>
<li><code>osmconvert</code> options preserve ways that cross the boundary</li>
<li>Trim roads that cross the boundary. There may be cases where a road dips out
of bounds, then immediately comes back in. Disconnecting it isn't ideal, but
it's better to manually tune the boundary polygon when this happens than try
to preserve lots of out-of-bounds geometry.</li>
<li>Area polygons are intersected with the boundary polygon using the <code>clipping</code>
crate</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="roadintersection-geometry-rawmap-to-initialmap"><a class="header" href="#roadintersection-geometry-rawmap-to-initialmap">Road/intersection geometry: RawMap to InitialMap</a></h1>
<p>The remainder of map construction is done in the <code>map_model</code> crate. There's one
intermediate structure between <code>RawMap</code> and <code>Map</code>, called <code>InitialMap</code>.</p>
<ul>
<li><code>make/remove_disconnected.rs</code>: Remove disconnected roads
<ul>
<li>Just floodfill from some road, assuming all roads are bidirectional, to get
different partitions.</li>
<li>Remove roads from all but the largest partition</li>
</ul>
</li>
<li><code>make/initial/mod.rs</code> and <code>make/initial/lane_specs.rs</code>: Interpret OSM tags to
figure out what lanes are on each side of each road, also figuring out the
total width of the road.</li>
<li><code>make/initial/geometry.rs</code>: Figure out the polygon for each intersection, and
trim back road center-lines to end at a face of the polygon.
<ul>
<li>For every road touching the intersection, get the polyline of each side,
based on the road's width
<ul>
<li>See appendix for how to shift polylines</li>
</ul>
</li>
<li>Sort all the polylines by the angle to the intersection's shared point</li>
<li>Intersect every polyline with every other polyline
<ul>
<li>More specifically -- the second half of each polyline, to get the correct
collision point</li>
<li>Look at the perpendicular infinite line to the collision point on the
shifted polyline, then find where it hits the original center line. Trim
back the center line by the max distance from these collisions.</li>
</ul>
</li>
<li>Compute the intersection's polygon by considering collisions between
adjacent roads' polylines</li>
<li>Deal with short roads and floating point issues by deduping any adjacent
points closer than 0.1m</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="initialmap-to-map"><a class="header" href="#initialmap-to-map">InitialMap to Map</a></h1>
<p>Still in the <code>map_model</code> crate.</p>
<ul>
<li><code>map.rs</code>'s <code>make_half_map</code>: Expand roads to lanes, using the list of lane
types from before</li>
<li><code>make/turns.rs</code>: Generate turns for every intersection.
<ul>
<li>Vehicle turns (for cars, bikes, buses)
<ul>
<li>Consider every pair of roads in the intersection. Try to match up lane
types -- if there's a bike lane on both roads, don't add a turn from
driving-&gt;bike or bike-&gt;driving. If there's not, then fallback to
transitions between different lane types.</li>
<li>Classify the turn based on the difference between the angle of the
incoming lane's last line and the outgoing lane's first line
<ul>
<li>For straight turns, use the Cartesian product to link every incoming
with every outgoing lane. If the indices dont match up, the turn becomes
a <code>LaneChangeLeft</code> or <code>LaneChangeRight</code> turn. This is used later for
intersection policies to prioritize turns appropriately.</li>
<li>Right and left turns only originate from the one lane on the appropriate
side</li>
</ul>
</li>
</ul>
</li>
<li>Walking turns for pedestrians
<ul>
<li>Consider pairs of adjacent roads around the intersection
<ul>
<li>Make a crosswalk to the other side of the road, assuming there's a
sidewalk on both sides</li>
<li>Make a shared sidewalk corner over to the adjacent road</li>
<li>If the adjacent road doesn't have a sidewalk on the close side, then
consider skipping that road and making a crosswalk over to the next
road. An example of this is a crosswalk over a highway on/off ramp.</li>
</ul>
</li>
</ul>
</li>
<li>Verify all the turns so far are unique</li>
<li>Filter by the OSM turn restrictions (&quot;only straight&quot; between road1 and
road2)</li>
<li>Try to apply the OSM per-lane restrictions (&quot;straight or left&quot; from lane 3)
<ul>
<li>The number of lanes in the OSM metadata might not match up with how many
lanes created</li>
<li>Some of these OSM tags are just completely wrong sometimes. If the filter
makes an incoming lane lose all of its turns, then ignore that tag.</li>
</ul>
</li>
</ul>
</li>
<li><code>make/parking_blackholes.rs</code>: Find well-connected roads near &quot;blackhole&quot;
lanes.
<ul>
<li>Starting from most driving/biking lanes, most other lanes are reachable.
Some aren't -- such as one-way highways inevitably leading from or to a
border. These are &quot;blackholes&quot; -- pathfinding to or from here may fail.</li>
<li>Find the largest strongly-connected component (SCC) in the driving graph.
From every other lane (a blackhole), floodfill both forwards and backwards
to find the nearest driving lane part of the main SCC.</li>
<li>Later, if a car needs to park by a building on a blackhole road, it'll
instead start searching for parking at the redirect. This prevents it from
being forced to instead exit the map through a border.</li>
</ul>
</li>
<li><code>make/buildings.rs</code>: Match buildings up with sidewalks
<ul>
<li>Find the closest sidewalk polyline to each building's center. Then draw a
straight line for the front path between the edge of the building and the
sidewalk point.</li>
<li>Filter out buildings too far away from any sidewalk</li>
<li>The front path might cross through other buildings; this is probably not
worth fixing.</li>
</ul>
</li>
<li><code>make/buildings.rs</code>: Same for parking lots
<ul>
<li>Similar process to match parking lots to nearest sidewalk and driving lane</li>
<li>Try to place parking spots along both sides of parking aisles</li>
<li>Filter out overlapping spots</li>
</ul>
</li>
<li><code>make/bridges.rs</code>: Find what roads lie beneath bridges, and update their
Z-order accordingly for later drawing.</li>
<li><code>stop_signs.rs</code>: Instantiate default stop sign policies
<ul>
<li>Rank incoming roads by OSM priority (arterial beats residential)</li>
<li>If there's only one rank, then make an all-way stop</li>
<li>Otherwise, the highest rank gets priority and others stop
<ul>
<li>Check if there are any conflicts based on this. If so, then fall-back to
an all way stop.</li>
</ul>
</li>
</ul>
</li>
<li><code>traffic_signals.rs</code>: Instantiate default traffic signal policies
<ul>
<li>Apply the first predefined policy that works.
<ul>
<li>4-way 4 stage, 4-way 2 stage, 3-way 3-stage, degenerate policy for 2
roads, 2-stage for 4 one-ways</li>
<li>Fallback to a greedy assignment that just randomly starts a new stage,
adds all compatible turns, and repeats until all turns are present
priority in some stage.</li>
</ul>
</li>
</ul>
</li>
<li><code>pathfind/mod.rs</code>: Prepare pathfinding
<ul>
<li>A/B Street uses contraction hierarchies (CH) for fast routing, using the
<code>fast_paths</code> crate.</li>
<li><code>pathfind/vehicle.rs</code>: For cars, bikes, buses
<ul>
<li>There's a separate CH for cars, buses, and bikes, since they can use
slightly different sets of lanes.</li>
<li>Building the CH for buses and bikes is much faster than the one for cars,
because the algorithm can re-use the node ordering from the first CH.</li>
<li>Every lane is a node in the graph, even if it's not an appropriate lane
type -- it might change later, and reusing orderings is vital for speed.</li>
<li>If two lanes are connected by a turn, then there's an edge in the graph.
<ul>
<li>The edge weight is the length of the lane and turn. Later this could
take into account speed limit, penalize lane-changing and left turns,
etc.</li>
</ul>
</li>
</ul>
</li>
<li><code>pathfind/walking.rs</code>: For pedestrians
<ul>
<li>Only sidewalk lanes are nodes in the graph -- sidewalks can't ever be
changed in A/B Street, so there's no concern about reusing node orderings.</li>
<li>All turns between two sidewalks become edges, again using length</li>
<li>When actually pathfinding, we get back a list of sidewalks. The actual
paths used in the traffic simulation specify forwards or backwards on a
sidewalk. Looking at adjacent pairs of sidewalks lets us easily stitch
together exact directions.</li>
</ul>
</li>
</ul>
</li>
<li><code>make/bus_stops.rs</code>: Match bus stops with a sidewalk
<ul>
<li>Also precompute the position where the bus stops on the adjacent driving or
bus lane.</li>
<li>This &quot;equivalent position on another lane&quot; process has a few weird cases,
since two lanes on the same road might have different lengths. Right now,
the same distance from the start of the lane is used, with clamping for
shorter lanes. Ideally, the position would be found by projecting a
perpendicular line out from one lane to the other.</li>
</ul>
</li>
<li><code>make/bus_stops.rs</code>: Finalize the list of bus routes
<ul>
<li>Between each pair of adjacent bus stops, run pathfinding to verify there's
actually a path for the bus to follow. If any are disconnected, remove the
bus route</li>
<li>Remove bus stops that have no routes serving them.</li>
</ul>
</li>
<li><code>pathfind/walking.rs</code>: Precompute the CH for pedestrians who will use buses
<ul>
<li>Nodes in the graph are sidewalks and every bus stop</li>
<li>There's an edge with weight 0 between a bus stop and its sidewalk</li>
<li>There's also an edge with weight 0 between bus stops that're adjacent via
some route. Ideally this weight would account for the time until the next
bus and the time spent on the bus, etc.</li>
<li>Later when figuring out which bus to use for a pedestrian, the resulting
list of nodes is scanned for the first and last bus stop along the same
route.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="development-tricks"><a class="header" href="#development-tricks">Development tricks</a></h1>
<ul>
<li>Separate phases for fast incremental development
<ul>
<li>Don't reimport all data from OSM every time there's a change to part of the
map construction code!</li>
<li>For slow steps that don't change often, make them separate binaries -- hence
<code>convert_osm</code> being separate from the rest.</li>
</ul>
</li>
<li>Don't be afraid of manual intervention
<ul>
<li>The data isn't perfect. It's easy to spend lots of time fiddling with code
to automatically handle all problems</li>
<li>Instead of automatically resolving problems, prefer good tooling for finding
and specifying fixes</li>
<li>Be careful of derivative structures that could get out of sync with OSM.
Prefer contributing real fixes to OSM.</li>
</ul>
</li>
<li>Screenshot diff testing
<ul>
<li>When working on the code for intersection geometry, it's easy to check a few
example cases get fixed by some change. But what if another part of the map
regresses somehow?</li>
<li>Take screenshots of the entire map, keep the checksums under version
control, look at the diffs visually, and manually verify any changes.</li>
<li>Implementation details: One huge gif or png is too slow to read and write,
so take a bunch of tiled screenshots covering everything. Amusingly,
rendering to a file with <code>glium</code> is slow unless compiling in release mode
(which isn't an option for quick incremental development). So instead, pan
to each section of the map, render it, call an external screenshot utility,
and move on -- just don't wiggle the mouse during this process!</li>
</ul>
</li>
<li>Different IDs for objects make sense during different phases
<ul>
<li>For the final product, lanes and such are just a contiguous array, indexed
by numeric IDs.</li>
<li>But sometimes, we need IDs that're the same between different boundary
polygons of maps, so that player edits can be applied anywhere. Using
(longitude, latitude) pairs hits floating-point serialization and comparison
issues, so referring to roads as (OSM way ID, OSM node ID 1, OSM node ID 2)
works instead.</li>
</ul>
</li>
</ul>
<h2 id="appendix-polylines"><a class="header" href="#appendix-polylines">Appendix: PolyLines</a></h2>
<p>Add some pictures here to demonstrate how polyline shifting works, the
explode-to-infinity problem, and the bevel/miter fix.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="live-edits"><a class="header" href="#live-edits">Live edits</a></h1>
<p>A key feature of A/B Street is the player editing the map and seeing how traffic
responds. The possible edits include:</p>
<ul>
<li>Change lane types (driving, bus, bike, parking -- sidewalks are fixed)</li>
<li>Change speed limits</li>
<li>Reverse a lane</li>
<li>Change a stop sign policy (which roads have a stop sign and which have
priority)</li>
<li>Change a traffic signal policy</li>
</ul>
<p>The map conversion process outlined above takes a few minutes, so reusing this
process directly to compute a map with edits wouldn't work at all for real
gameplay. Instead, the process for applying edits is incremental:</p>
<ul>
<li>Figure out the actual diff between edits and the current map
<ul>
<li>This is necessary for correctness, but also speeds up a sequence of edits
made in the UI -- only one or two lanes or intersections actually changes
each time. Of course when loading some saved edits, lots of things might
change.</li>
</ul>
</li>
<li>For any changed roads, make sure any bus stop on it have a good pointer to
their equivalent driving position for the bus.</li>
<li>For any modified intersections, recompute turns and the default intersection
policies</li>
<li>Recompute all the CHs for cars, buses, and bikes -- note sidewalks and bus
stops never change
<ul>
<li>This is the slowest step. Critically, the <code>fast_paths</code> crate lets a previous
node ordering be reused. If just a few edge weights change, then recomputing
is much faster than starting from scratch.</li>
<li>While making edits in the UI, we don't actually need to recompute the CH
after every little tweak. When the player exits edit mode, only then do we
recompute everything.</li>
</ul>
</li>
</ul>
<p>A list of lanes and intersections actually modified is then returned to the
drawing layer, which uploads new geometry to the GPU accordingly.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ab-streets-map-model-as-a-platform"><a class="header" href="#ab-streets-map-model-as-a-platform">A/B Street's map model as a platform</a></h1>
<p>A/B Street's representation of a city, built mostly from OSM and lots of
heuristics, is likely useful to other projects. This doc brainstorms what it
would look like to properly expose it to other users.</p>
<p>To sum up what the map model provides: geometry + semantics.</p>
<h2 id="use-cases"><a class="header" href="#use-cases">Use cases</a></h2>
<ul>
<li>Different UIs (particularly 3D / VR) for exploring cities as they are or as
they could be, like Streetmix 3D and Complete Street Rule</li>
<li>Importing slices of a city as assets into a game engine like Godot
<ul>
<li>Imagine a hackathon where people easily build games based on the real world</li>
<li>Like <a href="https://developers.google.com/maps/documentation/gaming/overview_musk">https://developers.google.com/maps/documentation/gaming/overview_musk</a>
but open</li>
</ul>
</li>
<li>A new OSM viewer/editor, particularly focused on POIs</li>
<li>Something focusing on 15-minute neighborhoods, with isochrones and nearby
amenities</li>
</ul>
<p>TODO: Give a quick Python example of what interacting with the end goal could
look like.</p>
<h2 id="just-data-is-not-enough"><a class="header" href="#just-data-is-not-enough">Just data is not enough</a></h2>
<p>At first glance, the existing <code>Map</code> structure could be written to some format
with a nicely documented schema. This would certainly be useful, but it's not
nearly enough. Interpreting the data sometimes requires lots of code, which
already exists -- so why not expose it to users as well?</p>
<p>Examples in OSM where I wish &quot;standard libraries&quot; existed to interpret the data:</p>
<ul>
<li>The simple task of detecting intersections between ways</li>
<li><a href="https://github.com/a-b-street/abstreet/blob/master/map_model/src/make/initial/lane_specs.rs">Figuring out what lanes a road has from tags</a></li>
<li>Gluing multipolygons together</li>
<li>Inferring turns at an intersection, subject to the several types of turn
restrictions</li>
</ul>
<p>A/B Street solves these problems (or at least it tries to), but by itself, the
resulting data isn't always useful. So some examples of where a library would be
needed too:</p>
<ul>
<li>Pathfinding. ABST does lots of work especially to handle &quot;live&quot; map edits and
cheaply regenerate contraction hierarchies. Also, pathfinding requires obeying
OSM turn restrictions that span multiple roads -- this prevents even plain old
Dijkstra's from working correctly.</li>
<li>Getting geometry in different forms. Lanes are stored as a <code>PolyLine</code>, but
what if a consumer wants the thickened <code>Polygon</code>, either as points, or maybe
even pre-triangulated vertices and indices?</li>
</ul>
<h2 id="how-would-an-apilibrary-work"><a class="header" href="#how-would-an-apilibrary-work">How would an API/library work?</a></h2>
<p>The traditional approach is to link against part of A/B Street as a library and
call it through language-specific bindings. The more language-agnostic option is
defining an API (maybe JSON or protobuf) and having clients run a local A/B
Street server, making HTTP requests to it. This is like the &quot;sidecar&quot; pattern in
microservice-land.</p>
<h2 id="compatibility"><a class="header" href="#compatibility">Compatibility</a></h2>
<p>Really have to think through this carefully. Some examples of big changes on the
horizon:</p>
<ul>
<li>Additive: separate cycleways and tramways. Likely no schema change.</li>
<li>Modify: traffic signals will get
<a href="https://github.com/a-b-street/abstreet/issues/295">more complex</a></li>
<li>Modify: we'll likely try again to merge tiny intersections together, which
would get rid of the current guarantees that a road/intersection is associated
to one particular OSM object</li>
</ul>
<h2 id="layering"><a class="header" href="#layering">Layering</a></h2>
<p>Clients should be able to opt into different data layers. For example, A/B
Street strips out OSM building tags right now to keep filesizes small. But an
OSM viewer would want to keep this (and likely discard the large contraction
hierarchies). So some pieces of the map model need to be teased apart into
optional pieces, and probably loaded in as separate files.</p>
<h2 id="the-bigger-vision"><a class="header" href="#the-bigger-vision">The bigger vision</a></h2>
<p>Depending what other open source projects are on board, the general idea is to
start assembling an ecosystem of libraries/tooling to make it easier to build
new things off of open GIS data.</p>
<p>The end state might look like this. A few separate applications would exist, all
running both natively and in the browser:</p>
<ul>
<li>A/B Street the game, more or less in its current form</li>
<li>A new OpenStreetMap viewer, likely focused on visualizing roads and
points-of-interest in detail</li>
<li>The street parking OSM editor, and other OSM editors specialized for mapping
certain things</li>
<li>A new app focusing on 15-minute neighborhoods, using isochrones to show
amenities available nearby
<ul>
<li>Ideally, allow editing current land use / zoning, to let people explore how
new policies might get closer to a 15-minute neighborhood.</li>
<li>Possibly <a href="https://www.open-accessibility.org">GOAT</a> does all of this
already, and this new thing shouldn't be built</li>
</ul>
</li>
<li>A new app for creating story maps, showing events that occur over time, with
lots of detail about the surrounding environment</li>
</ul>
<p>All of these would make use of some common libraries, which should be extracted
out cleanly from A/B Street today:</p>
<ul>
<li>the map model and OSM importer</li>
<li>the widgetry UI library</li>
<li>some common code for specifically interacting with maps in widgetry</li>
<li>a tool to generate a traffic demand model from OSM data, optional census data,
etc
<ul>
<li>This has been initially
<a href="https://a-b-street.github.io/docs/trafficsim/travel_demand.html#proletariat-robot">prototyped</a></li>
</ul>
</li>
<li>the discrete-event traffic simulation that A/B Street uses today</li>
<li>core geometry/utility libraries</li>
</ul>
<p>But note only the first application would use things like the simulation
library. The point of more cleanly modularizing these pieces is to make it
easier for new people to build different pieces, without having to understand
and be coupled to everything else. Also, as appropriate, these pieces should use
common data formats (like
<a href="https://github.com/d-wasserman/shared-row/">shared-row</a>) to be interoperable
with Streetmix, Complete Streets, etc.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ab-streets-traffic-simulation"><a class="header" href="#ab-streets-traffic-simulation">A/B Street's Traffic Simulation</a></h1>
<p>This article describes how cars, bikes, buses, and pedestrians are modeled in
A/B Street. All code lives in the <code>sim</code> crate.</p>
<p><a href="https://youtu.be/chYd5I-5oyc?t=1086">This recorded presentation</a> covers some of
this.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="discrete-event-traffic-simulation-laggy-heads-and-ghosts"><a class="header" href="#discrete-event-traffic-simulation-laggy-heads-and-ghosts">Discrete event traffic simulation, laggy heads, and ghosts</a></h1>
<p>A/B Street's traffic simulation isn't based on any research papers or existing systems, so this article aims to motivate and explain how it works. This article focuses on how the different agents (drivers, bicyclists, and pedestrians) move around. If you're wondering how we figure out where these agents should go or what time they decide to take trips, go read about <a href="tech/trafficsim/discrete_event/../travel_demand.html">travel demand models</a>.</p>
<p>I'm not aiming to survey how other traffic simulation models work here. In short, some focus on &quot;macroscopic&quot; patterns, like the volume of traffic along a particular highway over time. A/B Street is more on the &quot;microscopic&quot; side, modeling individual agents making decisions over time. Many such models use &quot;discrete-time&quot; simulation, where every agent senses and reacts to the world every time-step (0.1 seconds or so). A/B Street actually started with this -- see the <a href="tech/trafficsim/discrete_event/index.html#appendix-discrete-time-simulation">appendix</a> for more background. But early on, I switched to a discrete-event simulation instead. So, let's jump into that!</p>
<p>Note: I'll provide references to the current implementation. Someday I'll write that article describing how to build a traffic simulation from scratch...</p>
<ul>
<li><a href="tech/trafficsim/discrete_event/index.html#starting-simple-pedestrians">Starting simple: Pedestrians</a>
<ul>
<li><a href="tech/trafficsim/discrete_event/index.html#discrete-events">Discrete events</a></li>
</ul>
</li>
<li><a href="tech/trafficsim/discrete_event/index.html#vehicles">Vehicles</a>
<ul>
<li><a href="tech/trafficsim/discrete_event/index.html#the-state-machine">The state machine</a></li>
<li><a href="tech/trafficsim/discrete_event/index.html#exact-positions">Exact positions</a></li>
<li><a href="tech/trafficsim/discrete_event/index.html#laggy-heads">Laggy heads</a></li>
<li><a href="tech/trafficsim/discrete_event/index.html#performance">Performance</a></li>
</ul>
</li>
<li><a href="tech/trafficsim/discrete_event/index.html#lane-changing">Lane-changing</a></li>
<li><a href="tech/trafficsim/discrete_event/index.html#intersections">Intersections</a></li>
<li><a href="tech/trafficsim/discrete_event/index.html#appendix-discrete-time-simulation">Appendix: discrete-time simulation</a></li>
</ul>
<h2 id="starting-simple-pedestrians"><a class="header" href="#starting-simple-pedestrians">Starting simple: Pedestrians</a></h2>
<p>Imagine a simple movement model for pedestrians. Usually they exist at some point along a sidewalk and can move in one direction or the other.  At intersections, different sidewalks are connected by crosswalks, and pedestrians can also move bidirectionally on those, after waiting for the right time to cross.</p>
<!-- diagram sidewalk and turn -->
<p>We'll make a few assumptions about pedestrians. They follow the sidewalks and crosswalks perfectly, never deciding to <a href="tech/trafficsim/discrete_event/link">honor their inner Pythagorean</a>. They travel at a fixed speed and change that speed instantly -- no smooth acceleration. That fixed speed could depend on both their preferred walking speed and on the current sidewalk's elevation gain. These poor robotic pedestrians never stop to smell the flowers, write an angry neighborly note, or pet a pupper -- they just walk, or wait. Online dating is also so pervasive in this simulation that pedestrians ghost -- through each other, that is. There are more interesting models of pedestrian movement like the <a href="tech/trafficsim/discrete_event/link...">social force model</a> where people change speeds in crowds, but A/B Street is focused on sad American cities where you don't really see many people walking in one place. So there's no collision between pedestrians at all; they just pass through each other, temporarily losing their individuality for rendering purposes:</p>
<!-- gif -->
<p>In the world of discrete timesteps, you could imagine each pedestrian has very simple logic. At any moment, they just continue walking one direction or the other at their fixed speed along a sidewalk or crosswalk. Or they pause at the end of a sidewalk, awaiting their turn at a stop sign or traffic signal.</p>
<h3 id="discrete-events"><a class="header" href="#discrete-events">Discrete events</a></h3>
<p>Don't the constant updates every time-step seem wasteful? Most of the time, a pedestrian is in a steady-state -- walking or waiting. Since they walk at a fixed speed, we can just linearly interpolate their exact position at any moment in time if we want to draw them.</p>
<p>Instead of looping through every agent every time-step, in a discrete-event system, we just have one giant priority queue of events, scheduled to happen at some time in the future. Each agent remains in a certain state for a period of time, and schedules an event to transition themselves to a different state.</p>
<p>In the case of pedestrians, this works like this:</p>
<ol>
<li>A pedestrian begins at 30 meters distance along their first sidewalk. They want to walk forwards on the sidewalk, so they calculate the distance to the end of the sidewalk -- say another 70 meters -- and divide that by their preferred speed, scheduling an event an appropriate amount of time later -- say 10 seconds.</li>
<li>For the next 10 seconds, that pedestrian is in the <code>Crossing</code> state, which has a <code>DistanceInterval</code> stating that they're moving on a certain sidewalk from 30 to 70 meters. The <code>TimeInterval</code> says that this state is occuring from time 0 to 10 seconds. We can linearly interpolate to find their position for drawing.</li>
<li>At 10 seconds, the scheduler wakes up the pedestrian. They're now at the end of the sidewalk, so they look at the intersection and ask to cross. There's a traffic signal, and the almighty hand says NOPE, so they hand over control to the intersection and just mark themselves as <code>WaitingToTurn</code> state. No events are scheduled to update them.</li>
<li>But the intersection remembers the list of waiting agents. Some time later, the light changes, and the intersection &quot;wakes up&quot; all of the agents who now have a green.</li>
<li>Our pedestrian calculates a new <code>Crossing</code> state for the crosswalk. This state too happens over some distance and time interval.</li>
<li>At the end of the crosswalk, the pedestrian immediately enters another <code>Crossing</code> state for the next sidewalk.</li>
</ol>
<p>We can visualize this with a finite-state machine diagram:</p>
<!-- FSM diagram? -->
<!-- link to mechanics/walking.rs, scheduler.rs, sim step() -->
<h2 id="vehicles"><a class="header" href="#vehicles">Vehicles</a></h2>
<p>Discrete events are obviously much simpler for pedestrians, but there were some pretty drastic assumptions there that won't work for vehicles. It takes a few more tricks for A/B Street to model cars, bikes, and buses (I'll just use &quot;vehicle&quot; from here on.)</p>
<p>First let's understand what vehicles can do. They travel in one direction along individual lanes, and they queue behind each other -- no ghosting. At intersections, they wait as needed, then move along a &quot;turn,&quot; destined for a target lane. There are two major differences from reality that we'll take as assumptions.</p>
<p>First, vehicles instantly change speeds -- no smooth acceleration from rest, or modeling of safe stoping distance. So if a vehicle starts at the beginning of an empty lane, they instantly jump from rest to the maximum speed limit for that road. They travel at that maximum speed limit until the moment their front bumper strikes the boundary between road and intersection, then they stop immediately. This doesn't model highway driving at all, where things like jam waves are interesting to study and require more realistic kinematics and a model of driver reaction time. But A/B Street is focused on in-city movement, and the essence of scarcity I want to model is capacity on lanes and contention at intersections. What happens in between isn't as important. I think you'll find that the overall traffic patterns emerging in A/B Street still look compellingly realistic.</p>
<!-- show perfect stop -->
<p>The second article of funny business is lane-changing. Let's assume that vehicles don't change lanes in the middle of a road. Instead, vehicles shift left and right while moving through intersections. So if somebody needs to use a left turn lane, then at the intersection one road back, they'll choose to slide over during their turn. Any conflicting movements with other vehicles is handled at the intersection already.</p>
<!-- show path moving to the left -->
<p>This also means there's no over-taking. If a car gets stuck behind a bike moving slowly uphill, so be it.</p>
<!-- slow uphill -->
<p>We'll try to relax this second assumption later.</p>
<h3 id="the-state-machine"><a class="header" href="#the-state-machine">The state machine</a></h3>
<p>So let's figure out how to model these vehicles. The approach used by pedestrians, with <code>Crossing</code> and <code>WaitingToAdvance</code> states doesn't quite work, because nothing would stop vehicles from plowing into each other. So let's introduce a third state -- <code>Queued</code>. When a vehicle enters a new lane, it enters the <code>Crossing</code> state as usual, calculating the &quot;best-case&quot; time to cross the entire length of the lane at the max speed limit. This assumes nobody's in the way! But when this state ends, we can only transition the vehicle to the <code>WaitingToAdvance</code> state if they're the &quot;lead&quot; vehicle in the current lane's queue. If they have a &quot;leader&quot; vehicle, then they enter the <code>Queued</code> state and register as a &quot;follower&quot; of this &quot;leader&quot; in the queue.</p>
<!-- time0: leader in Crossing, follower in Crossing -->
<!-- time1: leader in WaitingToAdvance, follower in Crossing -->
<!-- time2: leader in WaitingToAdvance, follower in Queued -->
<p>When the vehicle at the very front of a lane enters the intersection and vacates their old lane, then they &quot;wake up&quot; their follower. The follower changes from <code>Queued</code> back to <code>Crossing</code>. Note that the follower doesn't instantly transition to <code>WaitingToAdvance</code>, since they're not quite at the end of the lane. Based on the length of the leader vehicle, the follower has some short distance left to cover. <!-- check details here... --></p>
<p>We can again understand all of this with a finite-state machine:</p>
<p><img src="tech/trafficsim/discrete_event/vehicle_fsm.png" alt="" /></p>
<!-- code in mechanics/car,driving -->
<h3 id="exact-positions"><a class="header" href="#exact-positions">Exact positions</a></h3>
<p>Most of the time, we don't care exactly where on a lane some vehicle is. But we
do need to know for drawing and for a few cases during simulation, such as
determining when a bus is lined up with a bus stop in the middle of a lane.</p>
<p>To calculate exact positions, we walk along each lane's queue from front to back. The key idea is that leaders bound the position of followers, and we can &quot;lazily evaluate&quot; the position of followers. This means that calculating one vehicle's position costs as much as calculating the entire queue's in the worst case, but that's usually fine -- for drawing, we want everyone anyway.</p>
<p>The process is simple. We use each vehicle's state to determine the possible position of their front bumper. <code>WaitingToAdvance</code> means the vehicle is at the very end of the lane. For vehicles still <code>Crossing</code>, we linearly interpolate the time and distance intervals. Then as we walk from front to back, we maintain a &quot;bound&quot; for the next vehicle's position. This is based on the front position of the current vehicle, plus the vehicle's length and a fixed following distance (which, note, is not based on speed).</p>
<!-- diagram -->
<!-- queue.rs -->
<h3 id="laggy-heads"><a class="header" href="#laggy-heads">Laggy heads</a></h3>
<!-- laggy head details -->
<p>Another case where we need to know exact positions of cars is to prevent the
first vehicle on a lane from hitting the back of a car who just left the lane.
All vehicles have length, and position is tracked by the front of the car. When
a car's front leaves a lane, its back is still partly in the lane. Logically,
the new lead car in the lane still needs to act like it's Queued. So each lane
keeps a &quot;laggy head&quot;, pointing to the car with its back partly in the lane.
After the laggy head has made it sufficient distance along its new turn or lane,
the laggy head on the old lane can be erased, unblocking the lead vehicle. This
requires calculating exact distances and some occasionally expensive cases where
we have to schedule frequent events to check when a laggy head is clear.</p>
<h3 id="performance"><a class="header" href="#performance">Performance</a></h3>
<!-- estimate number of events -->
<h2 id="lane-changing"><a class="header" href="#lane-changing">Lane-changing</a></h2>
<!-- https://github.com/a-b-street/abstreet/pull/682 -->
<p>Lane-changing (LCing) deserves special mention. A/B Street cheats by not
allowing it on lanes themselves. Instead, at intersections, cars can perform
turns that shift them over any number of lanes. These LCing turns conflict with
other turns appropriately, so the contention is still modeled. Why do it this
way? In a
<a href="http://apps.cs.utexas.edu/tech_reports/reports/tr/TR-2157.pdf">previous project</a>,
I tried opportunistic LCing. If a car had room to warp to the equivalent
distance on the adjacent lane without causing a crash, it would start LCing,
then take a fixed time to slide over, blocking both lanes throughout. This meant
cars often failed to LC when they needed to, forcing them to reroute, botching
their trip times. In many cases the cars would be permanently stuck, because
pathfinding would return paths requiring LCing that couldn't be pulled off in
practice due to really short roads. Why not try making the car slow down if
needed? Eventually it might have to stop, which could lead to unrealistic
gridlock. This LCing model was using a detailed discrete-time model with cars
accelerating properly; maybe it's easier with A/B Street's simplified movement
model.</p>
<p>Currently in A/B Street, cars will pick the least backed-up lane when there's a
choice. They make this decision once when they reach the front of a queue; look
for <code>opportunistically_lanechange</code> in <code>router.rs</code>. The decision could be
improved.</p>
<h2 id="intersections"><a class="header" href="#intersections">Intersections</a></h2>
<!-- maybe move all this to gridlock article -->
<p>I need to flesh this section out. See <code>mechanics/intersections.rs</code> for how stop
signs and traffic signals work. Two things I need to fix before making this
section interesting:</p>
<ul>
<li>Only wake up relevant agents when a previous agent finishes a turn.</li>
<li>Don't let an agent start a low-priority turn (like an unprotected left) if
it'll force a high-priority vehicle approaching to wait. The approaching
vehicle is still in the Crossing state, so we need to notify intersections
ahead of time of intended turns and an ETA.</li>
</ul>
<p>One contributor to permanent gridlock is cars and bikes being stuck in an
intersection, preventing conflicting turns from being performed. To help avoid
this, one of the last checks that stop signs and traffic signals perform before
accepting a new turn request is that the target lane has enough space for the
new vehicle. This is &quot;reserved&quot; space, not necessarily currently occupied by
vehicles in that lane. This accounts for other vehicles performing a turn bound
for that lane. See <code>try_to_reserve_entry</code> in <code>mechanics/queue.rs</code>. When a car
completely leaves a lane (determined by the &quot;laggy head&quot; described above), this
space is freed, and blocked cars are woken up.</p>
<h2 id="appendix-discrete-time-simulation"><a class="header" href="#appendix-discrete-time-simulation">Appendix: discrete-time simulation</a></h2>
<p>A/B Street's first traffic model was discrete-time, meaning that every agent
reacted to the world every 0.1s. Cars had a more realistic kinematics model,
accelerating to change speed and gradually come to a halt. Cars did a worst-case
estimation of how far ahead they need to lookahead in order to satisfy different
constraints:</p>
<ul>
<li>Don't exceed any speed limits</li>
<li>Don't hit the lead vehicle (which might suddenly slam on its brakes)</li>
<li>Stop at the end of a lane, unless the intersection says to go</li>
</ul>
<!-- why was lookahead hard: short lanes? -->
<p>After fighting with this approach for a long time, I eventually scrapped it in
favor of the simpler discrete-event model because:</p>
<ul>
<li>It's fundamentally slow; there's lots of busy work where cars in freeflow with
nothing blocking them or stopped in a long queue constantly check to see if
anything has changed.</li>
<li>Figuring out the acceleration to apply for the next 0.1s in order to satisfy
all of the constraints is really complicated. Floating point inaccuracies
cause ugly edge cases with speeds that wind up slightly negative and with cars
coming to a complete stop slightly past the end of a lane. I wound up storing
the &quot;intent&quot; of an action to auto-correct these errors.</li>
<li>The realism of having cars accelerate smoothly didn't add value to the core
idea in A/B Street, which is to model points of contention like parking
capacity and intersections. (This is the same reason why I don't model bike
racks for parking bikes -- in Seattle, it's never hard to find something to
lock to -- this would be very different if Copenhagen was the target.)
Additionally, the kinematics model made silly assumptions about driving anyway
-- cars would smash on their accelerators and brakes as hard as possible
within all of the constraints.</li>
</ul>
<!-- following papers is hard. diffeq's, no advice how to deal with real geometry or do LCing.. slow down to shift? -->
<div style="break-before: page; page-break-before: always;"></div><h1 id="travel-demand"><a class="header" href="#travel-demand">Travel demand</a></h1>
<p>A/B Street simulates people following a schedule of trips over a day. A single
<em>trip</em> has a start and endpoint, a departure time, and a mode. Most trips go
between buildings, but the start or endpoint may also be a border intersection
to represent something outside the map boundaries. The mode specifies whether
the person will walk, bike, drive, or use transit. Without a good set of people
and trips, evaluating some changes to a map is hard -- what if the traffic
patterns near the change aren't realistic to begin with? This chapter describes
where the travel demand data comes from.</p>
<h2 id="scenarios"><a class="header" href="#scenarios">Scenarios</a></h2>
<p>A <em>scenario</em> encodes the people and trips taken over a day. See the
<a href="https://github.com/a-b-street/abstreet/blob/master/sim/src/make/scenario.rs">code</a>.</p>
<p>TODO:</p>
<ul>
<li>talk about vehicle assignment / parked car seeding</li>
</ul>
<h2 id="data-sources-1"><a class="header" href="#data-sources-1">Data sources</a></h2>
<h3 id="seattle-soundcast"><a class="header" href="#seattle-soundcast">Seattle: Soundcast</a></h3>
<p>Seattle luckily has the Puget Sound Regional Council, which has produced the
<a href="https://www.psrc.org/activity-based-travel-model-soundcast">Soundcast model</a>.
They use census stats, land parcel records, observed vehicle counts, travel
diaries, and lots of other things I don't understand to produce a detailed model
of the region. We're currently using their 2014 model; the 2018 one should be
available sometime in 2020. See the
<a href="https://github.com/a-b-street/abstreet/tree/master/importer/src/soundcast">code</a>
for importing their data.</p>
<p>TODO:</p>
<ul>
<li>talk about how trips beginning/ending off-map are handled</li>
</ul>
<h3 id="berlin"><a class="header" href="#berlin">Berlin</a></h3>
<p>This work is <a href="https://github.com/a-b-street/abstreet/issues/119">stalled</a>. See
the
<a href="https://github.com/a-b-street/abstreet/blob/master/importer/src/berlin.rs">code</a>.
So far, we've found a population count per planning area and are randomly
distributing the number of residents to all residential buildings in each area.</p>
<h3 id="proletariat-robot"><a class="header" href="#proletariat-robot">Proletariat robot</a></h3>
<p>What if we just want to generate a reasonable model without any city-specific
data? One of the simplest approaches is just to spawn people beginning at
residential buildings, make them go to some workplace in the morning, then
return in the evening. OpenStreetMap building tags can be used to roughly
classify building types and distinguish small houses from large apartments. See
the <code>proletariat_robot</code>
<a href="https://github.com/a-b-street/abstreet/blob/master/sim/src/make/activity_model.rs">code</a>
for an implementation of this.</p>
<h3 id="census-based"><a class="header" href="#census-based">Census Based</a></h3>
<p>Trips are distributed based on where we believe people live. For the US, this
information comes from the US Census. To take advantage of this model for areas
outside the US, you'll need to add your data to the global <code>population_areas</code>
file. This is one huge file that is shared across regions. This is more work up
front, but makes adding individual cities relatively straight forward.</p>
<h4 id="preparing-the-population_areas-file"><a class="header" href="#preparing-the-population_areas-file">Preparing the <code>population_areas</code> file</a></h4>
<p>See <code>popdat/scripts/build_population_areas.sh</code> for updating or adding to the
existing population areas. Once rebuilt, you'll need to upload the file so that
popdat can find it.</p>
<h3 id="grid2demand"><a class="header" href="#grid2demand">Grid2Demand</a></h3>
<p>Collaborators at ASU are creating
<a href="https://github.com/asu-trans-ai-lab/grid2demand">https://github.com/asu-trans-ai-lab/grid2demand</a>, which does the traditional
four-step trip generation just using OSM as input. The output of this tool can
be directly imported into A/B Street. From the scenario picker, choose &quot;Import
Grid2Demand data&quot; and select the <code>input_agents.csv</code> file.</p>
<h3 id="abstr"><a class="header" href="#abstr">abstr</a></h3>
<p><a href="https://www.robinlovelace.net/">Robin Lovelace</a> is working on an
<a href="https://a-b-street.github.io/abstr/">R package</a> to transform aggregate desire
lines between different zones into A/B Street scenarios.</p>
<h3 id="desire-lines-for-the-uk"><a class="header" href="#desire-lines-for-the-uk">Desire lines (for the UK)</a></h3>
<p>The UK has origin/destination (aka desire line) data, recording how many people
travel between a home and work zone for work, broken down by mode. We have a
tool to disaggregate this and create individual people, picking homes and
workplaces reasonably using OSM-based heuristics. See
<a href="https://github.com/a-b-street/abstreet/blob/master/popdat/src/od.rs">the pipeline</a>
for details about how it works. The code that parses the raw UK data is
<a href="https://github.com/a-b-street/abstreet/blob/master/importer/src/uk.rs">here</a>.
If you have similar data for your area, contact me and we can add support for
it!</p>
<h3 id="custom-import"><a class="header" href="#custom-import">Custom import</a></h3>
<p>See <a href="tech/trafficsim/../dev/formats/scenarios.html">here</a>.</p>
<h2 id="modifying-demand"><a class="header" href="#modifying-demand">Modifying demand</a></h2>
<p>The travel demand model is extremely fixed; the main effect of a different
random number seed is currently to initially place parked cars in specific
spots. When the player makes changes to the map, exactly the same people and
trips are simulated, and we just measure how trip time changes. This is a very
short-term prediction. If it becomes much more convenient to bike or bus
somewhere, then more people will do it over time. How can we transform the
original demand model to respond to these changes?</p>
<p>Right now, there's very preliminary work in sandbox mode for Seattle weekday
scenarios. You can cancel all trips for some people (simulating lockdown) or
modify the mode for some people (change 50% of all driving trips between 7 and
9am to use transit).</p>
<h2 id="research"><a class="header" href="#research">Research</a></h2>
<ul>
<li><a href="https://github.com/replicahq/doppelganger">https://github.com/replicahq/doppelganger</a></li>
<li><a href="https://github.com/stasmix/popsynth">https://github.com/stasmix/popsynth</a></li>
<li><a href="https://zephyrtransport.github.io/zephyr-directory/projects/">https://zephyrtransport.github.io/zephyr-directory/projects/</a></li>
<li><a href="https://activitysim.github.io">https://activitysim.github.io</a></li>
<li><a href="https://github.com/BayAreaMetro/travel-model-one">https://github.com/BayAreaMetro/travel-model-one</a></li>
<li><a href="https://github.com/RSGInc/DaySim">https://github.com/RSGInc/DaySim</a></li>
<li><a href="https://github.com/arup-group/pam">https://github.com/arup-group/pam</a></li>
<li><a href="https://spatial-microsim-book.robinlovelace.net/smsimr.html">https://spatial-microsim-book.robinlovelace.net/smsimr.html</a></li>
<li><a href="https://github.com/DLR-VF/TAPAS">https://github.com/DLR-VF/TAPAS</a></li>
<li><a href="https://sumo.dlr.de/docs/Demand/Activity-based_Demand_Generation.html">https://sumo.dlr.de/docs/Demand/Activity-based_Demand_Generation.html</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gridlock"><a class="header" href="#gridlock">Gridlock</a></h1>
<p>Here &quot;gridlock&quot; refers to the general problem of trips getting permanently
stuck, preventing the full simulation from completing. Most of the work is
tracked <a href="https://github.com/a-b-street/abstreet/issues/114">here</a>.</p>
<p>The general lesson is: you can't code your way around all edge cases. The data
in OSM often needs manual fixes. It's often useful to spend coding effort on
tools to detect and fix OSM problems.</p>
<h2 id="problems-1"><a class="header" href="#problems-1">Problems</a></h2>
<p>The choices in the movement model matter. Some gridlock is inherent to any
system with queueing and conflicting turns. But in reality, people wiggle around
partly blocked turns. And some of this comes from the treatment of the
front/back of vehicles.</p>
<ul>
<li>Short roads in OSM causing very weird geometry</li>
<li>Intersection geometry being too large, requiring too much time to cross</li>
<li>Unrealistic traffic patterns caused by everyone trying to park in one big
garage (downtown) or take some alley (the UW soundcast issue)</li>
<li>Too many people try to take an unprotected left turn (often at a stop sign)</li>
<li>Bad individual traffic signals, usually at 5- or 6-ways</li>
<li>Groups of traffic signals logically acting as a single intersection</li>
<li>Separate traffic signals along a corridor being unsynchronized</li>
<li>Vehicles performing illegal sequences of turns</li>
<li>Vehicles are stuck with their plan and not reacting to traffic by changing
route</li>
<li>Real traffic would result in a gridlock without a deliberate actions to avoid
it. Such actions range from individual decisions of drivers to police manually
controlling traffic. Intelligent avoidance of gridlock is not simulated and is
extremely hard to simulate.</li>
<li>Vehicles will wait in lane filled with already waiting vehicles, even if there
is a completely empty lane allowing travel in desired direction. It makes
easier for entire lane between crossings to fill, contributing to gridlocks.
Note that while this and other clearly stupid behaviors are clearly
unrealistic, it is not trivial to implement more realistic and more efficient
decisions.</li>
<li>Issues caused by the unrealistic
<a href="tech/trafficsim/discrete_event/README.html#lane-changing">lane-changing model</a>
<ul>
<li>Two turns that go to the same lane (one going &quot;straight&quot;, the other often a
lane-change) conflict. The conflict is coarse, at the granularity of the
entire intersection. So if vehicles are piled up in two lanes trying to
merge into one, then one group is likely to go through as expected, but the
second group will wait for the first to completely clear the intersection.
Until then, it looks like a conflicting turn is being done.</li>
</ul>
</li>
</ul>
<h2 id="solutions"><a class="header" href="#solutions">Solutions</a></h2>
<p>Divide into implemented or not.</p>
<ul>
<li>Synchronizing pairs of signals</li>
<li>Uber-turns
<ul>
<li>for interpreting OSM turn restrictions</li>
<li>for synchronizing a group of signals</li>
<li>for locking turn sequences
<ul>
<li>Once a vehicle starts an uber-turn, prevent others from starting
conflicting turns on nearby intersections. Until groups of traffic signals
are configured as one, this is necessary to prevent somebody from making
it halfway through a sequence then getting blocked.</li>
</ul>
</li>
</ul>
</li>
<li>Cycle detector</li>
<li>block-the-box protection
<ul>
<li>the manual list of overrides</li>
<li>likely shouldn't apply during uber-turns</li>
<li>is it always fine to block the box at degenerate intersections?</li>
</ul>
</li>
<li>hacks to allow conflicting turns at really broken intersections</li>
<li>manually timing signals</li>
<li>penalties for lane choice to make lane usage realistic</li>
</ul>
<h3 id="not-implemented"><a class="header" href="#not-implemented">Not implemented</a></h3>
<ul>
<li>Dynamic rerouting</li>
<li>Allow multiple vehicles through intersection at once if there is enough space
on lane where given vehicle is going. Currrently vehicles travel through
crossings one by one (or, with <code>--disable_block_the_box</code> enabled - will enter
crossing even if leaving it will be impossible).</li>
<li>Last resort: if someone's waiting on a turn &gt;5m, just go.</li>
<li>Uber-turns
<ul>
<li>Group both stop sign and traffic signal intersections when looking for
uber-turns. Even a single traffic signal surrounded by tiny roads with stop
signs is causing problems.</li>
</ul>
</li>
</ul>
<h2 id="strategy-for-resolving"><a class="header" href="#strategy-for-resolving">Strategy for resolving</a></h2>
<p>Because there are so many different causes all tangled together, my approach is
to simplify the simulation as much as possible. A problem is much easier to
understand and fix when it's isolated. I've been trying this to get the downtown
weekday scenario to complete. A list of different techniques to simplify, in no
particular order:</p>
<ul>
<li>Use the <code>--infinite_parking</code> flag to just let everyone park directly in their
destination buildings. This is useful since downtown has many large parking
garages with high capacity, but I don't have a data source describing them.</li>
<li>Use the <code>--disable_turn_conflicts</code> flag, which greatly reduces realism, but
lets conflicting turns happen simultaneously. (Even with this and other flags,
downtown still gridlocks!) It also disables traffic signals, so bad inferred
timing isn't an issue.</li>
<li>Use the <code>--disable_block_the_box</code> flag to workaround short roads.</li>
<li>If you notice problems forming from cars stacking up behind slower cyclists,
there's no over-taking implemented yet. Use the scenario modifiers to convert
all biking trip to driving:
<code>--scenario_modifiers='[{&quot;ChangeMode&quot;:{&quot;to_mode&quot;:&quot;Drive&quot;,&quot;pct_ppl&quot;:100,&quot;departure_filter&quot;:[0.0,86400.0],&quot;from_modes&quot;:[&quot;Bike&quot;]}}]'</code></li>
<li>If all else fails, use the scenario modifiers to bluntly cancel some
percentage of all trips.</li>
</ul>
<p>A quick method for &quot;disabling&quot; buggy short roads is to use edit mode and close
the lanes. This forces traffic to reroute around the problematic area, which
might create other problems, but it can be useful.</p>
<h2 id="fixing-data-used-in-simulation"><a class="header" href="#fixing-data-used-in-simulation">Fixing data used in simulation</a></h2>
<p>Give more examples of changesets.</p>
<ul>
<li>upstreaming turn restrictions into OSM to prevent invalid U-turns and other
crazy movements
<ul>
<li>ex: <a href="https://www.openstreetmap.org/changeset/87945050">https://www.openstreetmap.org/changeset/87945050</a></li>
</ul>
</li>
<li>upstreaming lane count fixes into OSM to improve geometry</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="multi-modal-trips"><a class="header" href="#multi-modal-trips">Multi-modal trips</a></h1>
<p>A single trip consists of a sequence of <code>TripLegs</code> -- walking, operating a
vehicle (car or bike), and riding the bus. Depending whether a trip begins or
ends at a border or building, there are many combinations of these sequences.
This is a way to categorize them into three groups. I'm not sure it's the
simplest way to express all the state transitons.</p>
<h2 id="walking-only-trips"><a class="header" href="#walking-only-trips">Walking-only trips</a></h2>
<p><img src="tech/trafficsim/walking_only_trips.svg" alt="walking_only_trips" /></p>
<h2 id="trips-starting-from-a-border"><a class="header" href="#trips-starting-from-a-border">Trips starting from a border</a></h2>
<p><img src="tech/trafficsim/trips_from_border.svg" alt="trips_from_border" /></p>
<h2 id="trips-starting-from-a-building"><a class="header" href="#trips-starting-from-a-building">Trips starting from a building</a></h2>
<p><img src="tech/trafficsim/trips_from_building.svg" alt="trips_from_building" /></p>
<h2 id="spawning-code-overview"><a class="header" href="#spawning-code-overview">Spawning code overview</a></h2>
<p>As of January 2021, starting a traffic simulation works like this:</p>
<ol>
<li>Something creates a <code>Scenario</code>, which defines a bunch of people. Each person
has a schedule of trips, carrying them between <code>TripEndpoints</code> via some
<code>TripMode</code>, leaving at some <code>Time</code>.</li>
<li>When a scenario is instantiated, not much happens besides scheduling the trip
to start at the appropriate time and filling out <code>TripInfo</code> in <code>TripManager</code>.
Some state in <code>StartTripArgs</code> has to be plumbed forward in the
<code>Command::StartTrip</code>.</li>
<li>When the command gets run later, <code>TripManager::start_trip</code> happens. The
origin, destination, and mode flow through <code>TripSpec::maybe_new</code>.</li>
<li><code>TripSpec::to_plan</code> further validates these and attempts to repair impossible
plans. Each <code>TripSpec</code> is turned into a list of <code>TripLegs</code>.</li>
<li>Each <code>TripSpec</code> has its own initialization logic to kick off the first leg of
the trip.</li>
<li>Most trips have multiple legs. When the first car, bike, or pedestrian
reaches their goal, <code>TripManager</code> gets called with some sort of transition
function to initiate the next leg of the trip, or declare the trip finished.
These transition functions also record stats from that leg of the trip, like
total blocked time.</li>
</ol>
<p>What're the different <code>TripSpec</code> cases, and what <code>TripLegs</code> do they get turned
into?</p>
<ul>
<li><code>VehicleAppearing</code>: Starts at a border. Drive, then maybe walk to the
destination building.</li>
<li><code>SpawningFailure</code>: No trip legs; just create and immediately cancel the trip.</li>
<li><code>UsingParkedCar</code>: Starts at a building. Walk (to the parked car), drive, then
maybe walk to the destination building (after parking again).</li>
<li><code>JustWalking</code>: Just walk between two buildings/borders.</li>
<li><code>UsingBike</code>: Starts at a building. Walk to the nearest bikeable lane, drive,
then maybe walk to the destination building. (Note that starting a bike from a
border uses <code>VehicleAppearing</code>.)</li>
<li><code>UsingTransit</code>: Walk, ride the bus, maybe walk again. No transfers yet; only
rides one bus between two stops.</li>
</ul>
<p><code>TripManager</code> has a whole bunch of transition functions:</p>
<ul>
<li><code>car_reached_parking_spot</code>: drive -&gt; walk, unless the destination building is
where we parked</li>
<li><code>ped_reached_parking_spot</code>: walk -&gt; drive</li>
<li><code>ped_ready_to_bike</code>: walk -&gt; bike</li>
<li><code>bike_reached_end</code>: bike -&gt; walk</li>
<li><code>ped_reached_building</code>: walk -&gt; done</li>
<li><code>ped_reached_bus_stop</code>: walk -&gt; wait or ride bus</li>
<li><code>ped_boarded_bus</code>: waiting -&gt; ride bus</li>
<li><code>person_left_bus</code>: riding bus -&gt; walk</li>
<li><code>ped_reached_border</code>: walk -&gt; done</li>
<li><code>transit_rider_reached_border</code>: ride bus -&gt; done</li>
<li><code>car_or_bike_reached_border</code>: drive -&gt; done</li>
</ul>
<p>There are at least a few use cases motivating the cleanup of all of this
structure:</p>
<ul>
<li>Capping trips through congested areas. Sometimes this just changes the driving
route, but sometimes it needs to cancel trips, convert driving trips to
walking/transit, or delay the trip's start.</li>
<li>Multiple public transit rides in a single trip, aka transferring</li>
<li>Handling live map edits in the middle of a trip</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="live-edits-1"><a class="header" href="#live-edits-1">Live edits</a></h1>
<p>When the player edits the map, there's an <a href="tech/trafficsim/../map/edits.html">efficient process</a>
for applying the edits at the map model and rendering layer. In the middle of a
simulation, it's less obvious how to apply all edits. Most of the time
currently, edits cause the simulation to reset to midnight. Applying edits to
the sim without reset is important for running machine learning experiments and
for improving the gameplay experience (by having more immediate feedback about
the consequences of a change).</p>
<p>The UI has a <code>dirty_from_edits</code> bit to track when changes have been applied
without reset. This lets us tell the player that by the end of the day, any
score / results are tentative, because their edits might have a different effect
earlier in the day.</p>
<h2 id="what-works-today"><a class="header" href="#what-works-today">What works today</a></h2>
<p>Changes to traffic signals are simple -- <code>incremental_edit_traffic_signal</code>
happens at the map layer, and then <code>handle_live_edited_traffic_signals</code> at the
sim layer just resets the current stage to 0 if the previous configuration had
more stages.</p>
<h2 id="todo-recalculating-paths"><a class="header" href="#todo-recalculating-paths">TODO: Recalculating paths</a></h2>
<p>Many of the edits will influence routes. For trips that haven't started yet,
there's nothing to do immediately. Paths are calculated right before the trip
starts, so slight changes to the start/end of the path due to map edits (like
where somebody starts biking, for example) are captured naturally.</p>
<p>For currently active trips, in some cases, rerouting would be ideal but not
necessary (like if speed limits changed). In other cases -- like changing access
restrictions, modifying lane types, closing intersections -- the route must be
recomputed. As a simple first attempt, we could just cancel all active trips
whose path crosses an edited road or intersection. Later, we can figure out
rerouting.</p>
<p>And actually, the only other case to handle is <code>ChangeRouteSchedule</code>, which
should just be rescheduling the <code>StartBus</code> commands.</p>
<h2 id="todo-parking"><a class="header" href="#todo-parking">TODO: Parking</a></h2>
<p>What happens if you modify a parking lane while there are cars on it? For now,
just delete them. Trips later making use of them will just act as if the car
never had room to be spawned at all and get cancelled or fallback to walking.</p>
<p>A better resolution would be to relocate them to other parking spots. If the
owner is home, it'd be neat to have them walk outside, move the car, and go back
in. But this greatly complicates the simulation -- the edited lane is in a
transition state for a while, it modifies schedules, the person might not be
around, etc.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="parking"><a class="header" href="#parking">Parking</a></h1>
<p>In some areas, lots of traffic is caused by people circling around the block in
search of parking. And often, a great deal of space in a city is spent on street
parking, surface lots, and garages. So, A/B Street attempts to model parking as
a step at the beginning and end of every driving trip.</p>
<h2 id="types-of-parking"><a class="header" href="#types-of-parking">Types of parking</a></h2>
<p>Every parking spot can be categorized as public or private. Anybody can use
public spots, but only trips beginning or ending at a particular building can
use private spots inside of it. There's no modeling yet of time limits or fees.</p>
<p>On-street parking acts as one lane of the road. The full length of the lane gets
divided up into spots with a per-city configurable length, called
<code>street_parking_spot_length</code>, with a default of 8 meters. This is the only type
of parking that players can edit in-game, by changing lane types. Street parking
is always public.</p>
<p>Parking lots are also always public. OSM includes the service &quot;aisles&quot; running
through the lot, and A/B Street automatically packs in individual spots, winding
up with an estimate of the capacity.</p>
<p><img src="tech/trafficsim/parking_lot.png" alt="parking_lot" /></p>
<p>Off-street parking is part of a building. Physically this could mean a parking
garage, a small private lot behind some apartments, or a few spots in a carport
and driveway -- there's no distinction in A/B Street. Off-street parking can be
public or private.</p>
<h2 id="data-sources-2"><a class="header" href="#data-sources-2">Data sources</a></h2>
<p>On-street parking comes from OSM, using the
<a href="https://wiki.openstreetmap.org/wiki/Key:parking:lane">parking:lane</a> tags. This
field is rarely mapped; see <a href="tech/trafficsim/../../software/parking_mapper.html">here</a> to help
with that. Different cities can optionally configure some percentage of
residential roads to automatically infer a parking lane or two.</p>
<p>Parking lots only come from OSM. Individual spots and capacity is almost never
mapped, so A/B Street doesn't use that data.</p>
<p>Public off-street parking is only configured for Seattle right now, and comes
from
<a href="https://data-seattlecitygis.opendata.arcgis.com/datasets/public-garages-or-parking-lots">this dataset</a>.</p>
<p>I've yet to find any data that would help estimate private off-street parking.
For now, this is per-city configuration, called <code>FixedPerBldg</code>. We could
definitely do better by estimating building size. There's an exception for two
Seattle maps currently -- the number of off-street spots is set to equal the
number of driving trips that originate from that building over the course of the
entire day. This is also unrealistic, but was some attempt at improving those
two maps.</p>
<h2 id="simulation"><a class="header" href="#simulation">Simulation</a></h2>
<p>This seems like a good place to preface that A/B Street doesn't have any kind of
car-sharing, ride-share, or even multiple people in one car yet.</p>
<h3 id="seeding-cars"><a class="header" href="#seeding-cars">Seeding cars</a></h3>
<p>See
<a href="https://github.com/a-b-street/abstreet/blob/master/sim/src/make/scenario.rs">seed_parked_cars</a>
for reference.</p>
<p>When a simulation starts at midnight, where are cars initially placed? That
process first figures out how many cars are needed per building through the day.
If 100 driving trips originate from that building, you might think the building
needs 100 cars nearby. But many of these trips might actually arrive at the
building earlier using a car, in which case, when the same person later departs,
they'll take their car.</p>
<p>After this count per building is produced, we place each car as close as
possible to its building, only going far away as we run out of capacity. We
always prefer seeding a car inside a building than on the street or in a lot.
The list of cars to seed is shuffled, so that roughly helps with fairness -- we
don't fill in all of one building's cars first, then go the next -- that would
arbitrarily place one building's cars closer.</p>
<p>There's also a detail in this randomization process about the available spots.
The consequence is this: when a player makes a few changes to the amount of
street parking in an area, the effects shouldn't percolate everywhere and change
how cars are seeded far away -- unless the change adds/removes so much capacity
that the effect really would spill out that far.</p>
<h3 id="how-people-pick-a-spot"><a class="header" href="#how-people-pick-a-spot">How people pick a spot</a></h3>
<p>When a car gets to the last lane before its target building, it starts looks for
a free spot. If there's one on the current lane, it goes for it. If not, it uses
a breadth-first search, using distance, to explore from its current lane until
it finds a free spot. To avoid many cars in one area all contending for the same
spot, the distance used in the search has some randomized scaling applied.
Omnisciently knowing where free spots are located far away isn't realistic, but
attempting some kind of human-realistic random walk seems even harder to get
right.</p>
<h3 id="infinite-parking"><a class="header" href="#infinite-parking">Infinite parking</a></h3>
<p>If you pass <code>--infinite_parking</code> on the command line, every building gets
unlimited public spots. This effectively removes the effects of parking from the
model, since driving trips can always begin or end at their precise building
(except for blackhole cases). This is useful if a particular map has poor
parking data and you need to get comparative results about speeding up some
trips. Often the A/B testing is extremely sensitive, because a parking space
close to someone's destination is filled up quickly, slowing down the trip.</p>
<h3 id="blackholes"><a class="header" href="#blackholes">Blackholes</a></h3>
<p>Vehicles don't know how to turn left (or right for UK folks) from a driveway
yet. This means that some buildings and street parking lanes near map boundaries
might not be reachable from most of the map. Consequently, even though there
might be parking there, the simulation ignores it, because it's &quot;blackholed&quot;.</p>
<p><img src="tech/trafficsim/blackhole.png" alt="blackhole" /></p>
<h2 id="data-viz"><a class="header" href="#data-viz">Data viz</a></h2>
<p>There are 3 tools in the game that'll help you understand the effects of how
parking is modeled.</p>
<p><img src="tech/trafficsim/parking_occupancy.png" alt="parking_occupancy" /></p>
<p>The parking occupancy layer shows where parking spots are currently available.</p>
<p><img src="tech/trafficsim/parking_efficiency.png" alt="parking_efficiency" /></p>
<p>The parking efficiency layer shows how far away from their destination somebody
was forced to park. If you see lots of dark red dots, then people wound up
parking somewhere, then walking a long way to actually get to their building.
This is probably unrealistic, likely due to bad guesses about capacity in
different areas.</p>
<p><img src="tech/trafficsim/parking_overhead.png" alt="parking_overhead" /></p>
<p>The parking overhead dashboard looks at every driving trip that included a
parking phase. It measures how much of the total trip time was spent actually
driving, vs looking for parking and covering any remaining distance by foot.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="project-logistics"><a class="header" href="#project-logistics">Project logistics</a></h1>
<p>This has some background/logistics about the project.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="team"><a class="header" href="#team">Team</a></h1>
<p>The core group:</p>
<ul>
<li><a href="https://dcarlino.org">Dustin Carlino</a></li>
<li><a href="https://www.yuwen-li.com/">Yuwen Li</a> (UX)</li>
<li><a href="https://github.com/michaelkirk">Michael Kirk</a></li>
</ul>
<p>Collaborators from other projects:</p>
<ul>
<li><a href="https://www.robinlovelace.net/">Robin Lovelace</a> on
<a href="https://actdev.cyipt.bike/">ActDev</a> and
<a href="https://github.com/a-b-street/abstr/">demand modelling in R</a></li>
<li>Xuesong Zhou of
<a href="https://github.com/asu-trans-ai-lab">ASU's Transportation AI Lab</a> on
<a href="https://github.com/zephyr-data-specs/GMNS">GMNS integration</a></li>
</ul>
<h2 id="full-credits"><a class="header" href="#full-credits">Full credits</a></h2>
<p>Programming:</p>
<ul>
<li>All <a href="https://github.com/a-b-street/abstreet/graphs/contributors">contributors</a></li>
<li><a href="https://www.trevornederlof.me/">Trevor Nederlof</a> 15m explorer and census</li>
<li>Pandemic modeling by Orestis Malaspinas (<a href="project/orestis.malaspinas@hesge.ch">orestis.malaspinas@hesge.ch</a>)</li>
<li>OSM expertise courtesy <a href="https://github.com/matkoniecz">Mateusz Konieczny</a></li>
<li>Lots of helpful PRs from <a href="https://github.com/RestitutorOrbis">Javed Nissar</a></li>
<li>Lots of traffic signal and uber-turn work from
<a href="https://github.com/BruceBrown">Bruce</a></li>
</ul>
<p>Graphics / design:</p>
<ul>
<li>Logo by <a href="https://www.ryandpierson.com/">Ryan Pierson</a></li>
<li>Graphic design advice from <a href="http://starcatgames.com/">Starcat Games</a>,
<a href="https://somethingaboutmaps.wordpress.com/">Daniel Huffman</a>,
<a href="http://thebaprince.com/">Brian Prince</a></li>
<li>Character art by <a href="http://www.hollyhansel.com/">Holly Hansel</a></li>
<li>In-game character faces adapted from
<a href="https://github.com/anokhee/visual-synthesizer">Anokhee Jandhyala</a></li>
<li>Game design advice from Christopher Klein</li>
<li>Color and street rendering help from
<a href="https://github.com/westnordost">Tobias Zwick</a> of
<a href="https://github.com/streetcomplete/StreetComplete">StreetComplete</a></li>
</ul>
<p>Software dependencies:</p>
<ul>
<li>Lightning-fast pathfinding thanks to
<a href="https://github.com/easbar/fast_paths">fast_paths</a> by Andreas Barth
(<a href="project/easbar.mail@posteo.net">easbar.mail@posteo.net</a>)</li>
<li>Lots of help with rendering SVG and fonts from
<a href="https://github.com/RazrFalcon">RazrFalcon</a> and
<a href="https://github.com/nical">nical</a></li>
<li><a href="https://github.com/eldang/elevation_lookups">Elevation data</a> from
<a href="https://eldang.xyz/">Eldan</a></li>
</ul>
<p>Networking:</p>
<ul>
<li>Hackathon drop-ins from <a href="https://www.democracylab.org/">Democracy Lab</a> events</li>
<li><a href="https://cugos.org/">CUGOS</a> and <a href="http://julianmichael.org/">Julian Michael</a>
have been great sounding boards for ideas since the beginning</li>
</ul>
<p>Data:</p>
<ul>
<li>Special thanks to all <a href="https://www.openstreetmap.org/about">OpenStreetMap</a>
contributors!</li>
<li><a href="https://www.kingcounty.gov/services/gis.aspx">King County GIS</a></li>
<li><a href="https://data.seattle.gov/">Seattle Open Data</a></li>
<li><a href="https://www.psrc.org/">Puget Sound Regional Council</a></li>
<li><a href="https://www.nhgis.org">IPUMS NHGIS, University of Minnesota</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributing"><a class="header" href="#contributing">Contributing</a></h1>
<p>Lots of people are interested in this project, with very diverse backgrounds.
This page isn't meant to be prescriptive or limit options; it's just a starter.</p>
<h2 id="programming"><a class="header" href="#programming">Programming</a></h2>
<p>The biggest hurdle here is that A/B Street is written in Rust, a language that
may have a high entry barrier. If you're more comfortable in Python, R, or
something else, there are still ways to contribute -- particularly producing
input data for A/B Street to simulate.</p>
<h3 id="machinereinforcement-learning"><a class="header" href="#machinereinforcement-learning">Machine/reinforcement learning</a></h3>
<p>If you're a researcher looking for a complex multi-agent simulation with lots of
things to optimize, you've found the right place. We have a simple
<a href="project/../tech/dev/api.html">JSON API</a> already you can plug into, but we'd love to
improve this based on your use case. Particularly cool ideas could be
auto-tuning traffic signal timing or calibrating travel demand scenarios to
real-world throughput/delay measurements.</p>
<h3 id="transportation-modelling"><a class="header" href="#transportation-modelling">Transportation modelling</a></h3>
<p>Do you sling around population and aggregated origin/destination data with R or
Python? Great, help us generate realistic
<a href="project/tech/dev/formats/scenarios.html">travel demand models</a>! Work in whatever language
you like best; we'll settle on a common format.</p>
<h3 id="working-on-ab-street-itself"><a class="header" href="#working-on-ab-street-itself">Working on A/B Street itself</a></h3>
<p>You'll need to learn at least some Rust to start here. We can help you a bit
with that, especially by recommending starter projects or giving feedback in
PRs, but this requires a fair bit of independence.</p>
<p>There's so many different types of things to work on -- see our
<a href="project/hiring.html">hiring page</a> and
<a href="https://github.com/a-b-street/abstreet/issues">Github issues</a>.</p>
<h3 id="data-visualization--analysis"><a class="header" href="#data-visualization--analysis">Data visualization / analysis</a></h3>
<p>A/B Street generates loads of individual data through the simulation, but
deciding what's important, how to aggregate things, what filters/controls to
give to the user, and how to communicate trade-offs is really hard!</p>
<p>We can export data however's useful -- there's a few CSV files that the UI can
export today. You can work on analyzing and visualizing the data using whatever
tools you like. To actually implement a new dashboard in A/B Street, we'll
implement it in Rust, but we can implement/copy what you produce elsewhere.</p>
<p>Some examples where we need help:</p>
<ul>
<li>How to aggregate and compare the number of &quot;risky events&quot; somebody encounters
on their trip, possibly using some kind of contingency matrix. See
<a href="https://github.com/a-b-street/abstreet/pull/622">this PR</a> for some discussion
and open questions</li>
<li>How to show roads with more/less traffic. See this
<a href="https://github.com/a-b-street/abstreet/issues/85">discussion</a></li>
</ul>
<h2 id="design"><a class="header" href="#design">Design</a></h2>
<p>We wouldn't have made it to this point without loads of help from our UX
designer. We could always use more help here. We use Figma for designs
currently.</p>
<h3 id="graphics"><a class="header" href="#graphics">Graphics</a></h3>
<p>From what I've seen, no other street map attempt to include lane markings and as
much detail as A/B Street. This means there's not much cartography to take
inspiration from. Some places we need help:</p>
<ul>
<li>Showing arterial vs small residential roads while zoomed in</li>
<li>Conveying more information about buildings and land use -- is it a small
house, some apartments, a shop, a mall, a multi-use development?</li>
<li><a href="https://github.com/a-b-street/abstreet/issues/74">Tuning the color-scheme</a>,
especially in a color-blind friendly way</li>
<li>Visualizing
<a href="https://github.com/a-b-street/abstreet/issues/660">low traffic neighborhoods</a></li>
<li>Many people can't recognize the pedestrians and cyclists; how do we represent
them better in our 2D top-down view? What should e-scooters look like?</li>
</ul>
<h3 id="storyboarding"><a class="header" href="#storyboarding">Storyboarding</a></h3>
<p>We didn't start A/B Street with a clear set of product requirements or a
storyboard for how it should work -- and we've been paying the price of this all
along. But newer tools like the <a href="project/../software/fifteen_min.html">15-minute explorer</a>
or the idea for a
<a href="https://github.com/a-b-street/abstreet/issues/660">low-traffic neighborhood planner</a>
are focused and young enough where we could properly plan out the features and
UI.</p>
<h3 id="game-design"><a class="header" href="#game-design">Game design</a></h3>
<p>A/B Street <em>tries</em> to be a game, but it falls pretty short. Want to help us
improve the <a href="https://github.com/a-b-street/abstreet/issues/611">tutorial</a>? Have
some ideas how to split up levels in the challenge mode? Know how to write a
story? Help us!</p>
<p>Or maybe you can imagine a new spin-off game reusing some of the work that
exists today. That's how <a href="project/../software/santa.html">15-minute Santa</a> happened!</p>
<h2 id="using-ab-street"><a class="header" href="#using-ab-street">Using A/B Street</a></h2>
<h3 id="you-have-an-idea-for-fixing-something-in-your-city"><a class="header" href="#you-have-an-idea-for-fixing-something-in-your-city">You have an idea for fixing something in your city</a></h3>
<p>That's why we made this! Just go try and make the change, initially without help
from us. Write down your experience and all of the problems you hit. Then tell
us the problems and any ideas for fixing them.</p>
<p>Then write up a <a href="project/../proposals/README.html">proposal</a> and start advocating for it!</p>
<h3 id="youre-an-advocacy-group"><a class="header" href="#youre-an-advocacy-group">You're an advocacy group</a></h3>
<p>If you want to use A/B Street to argue for some change in your city, get in
touch! It's easiest if you:</p>
<ul>
<li>Tell us very clearly what you need</li>
<li>Draw a <a href="project/../user/new_city.html">study area</a></li>
<li>Have a pretty specific idea of what roads/intersections you want to actually
change</li>
<li>Have an idea of how you want to communicate your idea; browse
<a href="project/../proposals/README.html">our proposals</a> for inspiration</li>
</ul>
<h3 id="researching-car-free-cities"><a class="header" href="#researching-car-free-cities">Researching car-free cities</a></h3>
<p>Maybe you're studying urban planning and think our software can help. We have
some of the tools to get you started -- importing a new map, changing road
configuration and access, measuring comparative results. But you'll probably
have to work with us directly to fix up the map data and get a proper demand
model. You can help us by giving usability feedback about what's hard to do and
ideas for things to add. We're not experts in planning -- if you can tell us how
software can help you do your job better, let's talk!</p>
<h3 id="usability-studies"><a class="header" href="#usability-studies">Usability studies</a></h3>
<p>Every so often, we conduct formal usability studies. You'll spend an hour on a
videocall doing something in A/B Street and vocalizing your thought process and
what problems you hit. We'll use your feedback to find and fix problems.</p>
<p>We only run these every now and then; just contact us to get on the list for the
next round.</p>
<h3 id="reporting-bugs"><a class="header" href="#reporting-bugs">Reporting bugs</a></h3>
<p>You're bound to hit problems using our software -- just
<a href="https://github.com/a-b-street/abstreet/issues/new">file an issue</a> when you do.</p>
<h2 id="improving-data-quality"><a class="header" href="#improving-data-quality">Improving data quality</a></h2>
<p>A/B Street relies on having an accurate and up-to-date model of your city. What
do you do when it's wrong?</p>
<h3 id="fix-incorrect-lane-data"><a class="header" href="#fix-incorrect-lane-data">Fix incorrect lane data</a></h3>
<p>The most common problem is that a road has the wrong number of lanes, or
turn/bike/parking lanes are missing. If you know how to edit OpenStreetMap
already, go fix it. If not, you can use the lane editor in A/B Street to fix the
problem and make the road match reality. Send us your edits, and we can help
make the fix in OSM.</p>
<h3 id="openstreetmap-mapper"><a class="header" href="#openstreetmap-mapper">OpenStreetMap mapper</a></h3>
<p>Are you already involved in OSM and want to validate your work? Use
<a href="project/../software/osm_viewer.html">our tool</a> to help you visualize lane tagging easily.
Keep in mind there are some problems with this viewer that might not reflect
problems with the data in OSM -- particularly separate foot/cyclepaths and weird
intersection geometry.</p>
<p>Or maybe you think your city is incredibly well-mapped already -- I bet it's
missing one thing. Please map <a href="project/../software/parking_mapper.html">street parking</a> --
we need this to guess road widths.</p>
<h2 id="project-logistics-1"><a class="header" href="#project-logistics-1">Project logistics</a></h2>
<h3 id="networking--marketing"><a class="header" href="#networking--marketing">Networking / marketing</a></h3>
<p>Know an advocacy group or city authority who would want to use our work? Make
the connection!</p>
<h3 id="project-management"><a class="header" href="#project-management">Project management</a></h3>
<p>Organizing all of the information, ideas, and people involved with this project
is hard. Just writing this page and website took way too many tears and
caffeine! We could also use help prioritizing work and coming up with
requirements for new ideas.</p>
<h3 id="write-documentation"><a class="header" href="#write-documentation">Write documentation</a></h3>
<p>This website is <a href="https://github.com/a-b-street/docs">easy to edit</a>. We could
especially use help writing a user guide -- describe how different tools in A/B
Street work, or work through examples of how to do stuff.</p>
<h3 id="funding"><a class="header" href="#funding">Funding</a></h3>
<p>Our <a href="project/funding.html">funding</a> is pretty nonexistent, but if we had some, we could
<a href="project/hiring.html">hire more people</a> and build useful things faster. Do you know how to
write NSF grants? Have you thought of a business model compatible with our
values but that would let us financially sustain ourselves? Do you think we
should be an LLC, a B corp, a non-profit, something else? Help needed!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="funding-1"><a class="header" href="#funding-1">Funding</a></h1>
<p>A/B Street is in need of funding. If you would like to support the development
of A/B Street, e.g. to get a particular feature implemented or to get support
using it to simulate changes in a particular city,
<a href="mailto:dabreegster@gmail.com">get in touch</a>.</p>
<p>Funding received:</p>
<ul>
<li>Contract with <a href="https://actdev.cyipt.bike/">ActDev</a></li>
</ul>
<p>The project has funded two open-source libraries needed by A/B Street,
supporting the development of open source software for transport planning
applications:</p>
<ul>
<li><a href="https://github.com/easbar/fast_paths/">fast_paths Rust contraction hierarchy pathfinding</a></li>
<li><a href="https://github.com/eldang/elevation_lookups">Python elevation data processing</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hiring"><a class="header" href="#hiring">Hiring</a></h1>
<p>A/B Street is hiring a Rust engineer!</p>
<h2 id="the-project"><a class="header" href="#the-project">The project</a></h2>
<p>A/B Street aims to get the average citizen more involved with local
transportation planning and accelerate plans to make cities more friendly to
people biking, walking, and using public transit. This massive undertaking
involves building a realistic model of any citys street network from open data,
designing a user interface to easily edit streets and intersections, getting a
traffic simulation to run with some degree of realism, using data visualization
to explain the impacts of changes, and advocating for real changes using results
from the software.</p>
<p>A/B Street has yet to focus on public transit. Thats where you come in. Today,
theres only preliminary and broken support for importing bus routes from
OpenStreetMap and simulating people using them. A vision of what proper public
transit support in A/B Street should do:</p>
<ul>
<li>Let people draw entirely new bus and light rail routes, then understand the
impact on individual people and the aggregate community.</li>
<li>Explore how small changes affect bus performance -- like changing bus stop
locations, adding a bus-only lane, or configuring a traffic signal to
prioritize buses.</li>
<li>Gamify the process of planning for public transit, by gradually introducing
editing tools and a budget, to teach the public about the trade-offs involved
with planning.</li>
</ul>
<p>These goals will involve
<a href="https://github.com/a-b-street/abstreet/issues/372">many tasks</a>, such as
incorporating data from OpenStreetMap and GTFS into A/B Streets map model;
modifying pathfinding to decide which route a person should use; defining and
visualizing metrics for performance of a bus route; and changing the map model
and UI to allow bus stops and routes to be created and edited.</p>
<p>Although your main focus will be public transit, A/B Street is a project with a
wide scope, and there are other areas we need help, many of which good public
transit support depends on:</p>
<ul>
<li>Improving the underlying map model:
<ul>
<li><a href="https://github.com/a-b-street/abstreet/issues/654">simplifying complex intersections from OpenStreetMap</a></li>
<li><a href="https://github.com/a-b-street/abstreet/issues/330">snapping separate paths to the main road</a></li>
<li><a href="https://github.com/a-b-street/abstreet/issues/485">improving heuristics for placing crosswalks</a></li>
</ul>
</li>
<li>Fixing gridock and improving the simulation
<ul>
<li>lane-changing and over-taking</li>
<li>biking in parking lanes when possible</li>
<li>better rules for when pedestrians are likely to start crossing</li>
<li>mode shift / figuring out when a new bus route would
<a href="https://github.com/a-b-street/abstreet/issues/448">convince somebody to stop driving</a></li>
<li>editing the map without needing to restart a simulation</li>
</ul>
</li>
<li>UI / design
<ul>
<li>helping implement UX designs prototyped in Figma</li>
<li>fixing usability problems you notice yourself</li>
</ul>
</li>
</ul>
<h2 id="your-qualifications"><a class="header" href="#your-qualifications">Your qualifications</a></h2>
<ul>
<li>Can work independently, but still communicate effectively with the rest of the
team. We need to focus our efforts on other parts of the project, but we'll
keep up with your work closely
<ul>
<li>One way to demonstrate this: have you created your own project and
maintained it for a while? Have you worked on other open source projects?</li>
</ul>
</li>
<li>Can ramp up quickly on Rust, OpenStreetMap, GTFS, etc. If you already know
these, great. If not, you should feel comfortable learning enough to start
contributing to the code-base in a few days.</li>
<li>Are fine with (and happy to have) all of your work being Apache licensed and
designed/discussed transparently on Github and Slack</li>
<li>Bonus if you have enough design sense to mock up UIs, but no worries if not</li>
</ul>
<h2 id="the-job"><a class="header" href="#the-job">The job</a></h2>
<p>Our <a href="project/funding.html">funding</a> is all but nonexistent, so I am personally carving out
some of my savings for this. Because of this, the bar for hiring and my
expectations are pretty high.</p>
<ul>
<li>The amount is negotiable, but no more than about $30,000 USD total for the
duration of the contract.</li>
<li>Ideally this contract would be full-time (35-40 hours a week) for about 6
months -- so that's about $5,000 per month.</li>
<li>Can't offer any benefits, sorry -- we're not a company yet!</li>
<li>Remote only. Anywhere in the world is fine, but most of us are in Seattle
(PST).</li>
</ul>
<p>If we can figure out how to financially sustain ourselves, this could become a
permanent position, but don't count on it.</p>
<h2 id="applying"><a class="header" href="#applying">Applying</a></h2>
<p>If you think youd be a good fit, email <a href="project/dabreegster@gmail.com">dabreegster@gmail.com</a> with any
relevant material -- open source projects, a resume, etc. We can schedule a
video call.</p>
<p>In lieu of a traditional interview, Id like to ask you to submit a PR to A/B
Street to make progress on one of our starter bugs or any other fix/feature
youd like to see (theres plenty of things that need improving, and being able
to find and fix them without much guidance is what were looking for). Please
focus on good communication in your PR, as its something wed expect you to
keep up the entire time -- see
<a href="https://github.com/a-b-street/abstreet/pull/571">this</a> as an example, where the
before/after of the change is clear, and any uncertain design decisions are
brought up.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="roadmap"><a class="header" href="#roadmap">Roadmap</a></h1>
<p>See
<a href="https://docs.google.com/document/d/1tsr65WIIX3Y6A804eUK-BIVbOfwdYCOVddZe7esNSw0/edit?usp=sharing">this doc</a>
for a Q2 retrospective and more notes. This is a summary for our plans for
July-September 2021.</p>
<h2 id="mode-shift"><a class="header" href="#mode-shift">Mode shift</a></h2>
<p>Top priority is calculating when changes to roads might cause people to change
behavior long-term. A/B Street only shows short-term impacts right now, but we
have enough things in place to calculate when somebody might decide to ditch
their car. Ideas are <a href="https://github.com/a-b-street/abstreet/issues/448">here</a>.</p>
<p>Related to this, we'll try to allow
<a href="https://github.com/a-b-street/abstreet/issues/312">editing the map without reseting the simulation</a>
again. This has eaten lots of time already without any usable results, but there
are some fresh ideas for a simpler implementation.</p>
<p>And <a href="https://github.com/tnederlof">Trevor</a> is actively looking at reviving
public transit support from GTFS, which will fit into mode shifting perfectly --
in many places, deciding to use transit is much more likely than convincing
somebody to bike.</p>
<h2 id="finish-half-started-projects"><a class="header" href="#finish-half-started-projects">Finish half-started projects</a></h2>
<p>In Q2, there was some progress on hard technical problems:</p>
<ul>
<li>consolidating complex intersectons</li>
<li>dynamic lane-changing</li>
<li>entering and exiting driveways from either side of the road</li>
</ul>
<p>We'll continue pushing forward here. And some other areas likely to be revived:</p>
<ul>
<li>snapping separate cyclepaths to roads</li>
<li>more realistically placing crosswalks</li>
</ul>
<p>Some of this work will be prioritized based on a contract to help a city
demonstrate their design ideas for making their downtown be more multimodal
friendly.</p>
<h2 id="project-logistics-2"><a class="header" href="#project-logistics-2">Project logistics</a></h2>
<ul>
<li>Push through a revamp of &lt;docs.abstreet.org&gt;</li>
<li>Publish at least two blog posts exploring particular ideas in Seattle</li>
<li>COVID-permitting, start a Seattle-area meetup for exploring transportation
changes</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="project-motivations"><a class="header" href="#project-motivations">Project motivations</a></h1>
<p>I thought it'd be helpful to explain what motivates my work in A/B Street. These
are just my personal values; I don't intend to make a careful argument about
these here. In no particular order:</p>
<ul>
<li>
<p><strong>Transparency and reproducibility</strong>: if city government uses data, modeling,
or simulation to inform a decision affecting the general public, then anybody
ought to be able to repeat that analysis.</p>
<ul>
<li>This means code and data should be open.</li>
<li>Businesses like <a href="https://replicahq.com/">Sidewalk Lab's Replica</a> and
<a href="https://www.remix.com/solutions/streets">Remix</a> still need to generate
income, but it's unclear why governments use taxes to pay for something only
they see.</li>
<li>Decision making should be documented clearly. Why were the
<a href="https://www.seattle.gov/transportation/projects-and-programs/programs/maintenance-and-paving/current-paving-projects/35th-ave-ne">35th Ave bike lanes</a>
scrapped? Was the amount of on-street parking on nearby residential roads
factored in? Was there analysis of how trip time is impacted by parking in
the neighborhood and walking a few blocks to a business on the arterial?</li>
<li>I'm personally inspired by approaches like
<a href="https://info.vtaiwan.tw/">vTaiwan</a> and
<a href="https://po.pdis.nat.gov.tw/en/opengov/">PDIS</a></li>
</ul>
</li>
<li>
<p><strong>Accessibility leads to participation</strong>: There's overhead to taking small
ideas to advocacy groups or inconveniently timed public meetings. If the
planning process is easier to interact with, more people will participate.</p>
<ul>
<li>Seattle's
<a href="https://www.seattle.gov/neighborhoods/programs-and-services/your-voice-your-choice">Your Voice, Your Choice</a>
program is maybe an example of this</li>
</ul>
</li>
<li>
<p><strong>Short-term changes</strong>: <a href="https://en.wikipedia.org/wiki/Sound_Transit_3">ST3</a>
is exciting, but 2040 isn't close. There are much cheaper changes that can be
implemented sooner.</p>
<ul>
<li>Most of the edits in A/B Street are inspired by tactical urbanism; they
could be prototyped with signs and paint.</li>
</ul>
</li>
<li>
<p><strong>The US is too dependent on cars</strong>: This has an unacceptable impact on the
environment. Even ignoring that, many cities are out of room to build more
roads. We can't keep scaling population like this.</p>
</li>
<li>
<p><strong>Autonomous vehicles will NOT save the day</strong>: They can squeeze more
throughput out of existing infrastructure, but only up to a point. They might
encourage people to move and tolerate longer commutes. Mass transit and dense
land-use patterns handle population growth better.</p>
</li>
<li>
<p><strong>Compromise and trade-offs</strong>: I see lots of rhetoric calling for extreme,
sudden change. I don't want to ban all cars from downtown Seattle, because
that's not realistic. I want to focus on immediate steps forward. I want to
come up with estimates about impacting drivers by a median 3 minutes in order
to save a bus route 1 minute, and to shift public discourse towards that.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="project-history"><a class="header" href="#project-history">Project history</a></h1>
<p>As of June 2020.</p>
<p>tldr: A/B Street has been in active development since June 2018, but the idea
has been festering since I was about 16.</p>
<h2 id="retrospective"><a class="header" href="#retrospective">Retrospective</a></h2>
<p>What poor judgments have cost me the most time?</p>
<ul>
<li>UI churn: I should've studied some UX on my own and started with a clear idea
of how to organize everything</li>
<li>OSM data quality: I should've gained the confidence to upstream fixes earlier</li>
<li>Intersection geometry: I should've realized sooner that simulation robustness
is more important than nice appearance.</li>
<li>Geometry primitives: I sunk too much time into the polyline problem and f64
precision.</li>
</ul>
<h2 id="trivia"><a class="header" href="#trivia">Trivia</a></h2>
<ul>
<li>The name was almost &quot;Unstreet&quot; or &quot;Superban&quot; (superb urban)</li>
<li>I hope you enjoy and/or are baffled by the
<a href="https://github.com/a-b-street/abstreet/releases">release names</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backstory"><a class="header" href="#backstory">Backstory</a></h1>
<p>I originally wanted to tell a much longer story here of how I came to work on
A/B Street, but I'm not sure this is the right time yet. So consider this the
quick version.</p>
<p>I grew up in Baton Rouge, where driving is effectively the only mode of
transport. (I've gone back and made a point of taking long walks to confirm how
antagonistically the city is designed towards walking.) Very early on, I fell in
love with a Nintendo 64 game called Banjo Kazooie, which led me to the online
fan communities of the early 2000's. I wanted to create games too, so I started
learning programming via library books and lots of questions on IRC. Because I
never had any confidence in art, I wound up working on
<a href="https://github.com/dabreegster/mnemonicrl/">roguelikes</a>, which led to a fervent
interest in pathfinding algorithms and
<a href="http://www.cs.colorado.edu/%7Eralex/papers/PDF/OOPSLA06antiobjects.pdf">collaborative diffusion</a>.
When I started driving in high school, I quickly realized how bad people were at
it. I remember being stuck at the intersection of
<a href="https://www.openstreetmap.org/node/1279204989">Florida Blvd and Cloud</a> and
first wondering if the pathfinding algorithms could help with traffic. Can you
see where this is going?</p>
<p><img src="project/history/cloud_florida.jpg" alt="Impatience is a virtue" /></p>
<p>I moved to Austin for college. One of the first days of class, I shuffled down
the stairs of Gearing Hall past a crackly old speaker apocalyptically announcing
the weather forecast (details add color, right?) into a seminar demanding a
totally open-ended first assignment to do something interesting. After I left,
somebody stopped to ask me for directions, but I didn't know campus well yet. I
thought about how Google Maps gave really silly walking directions. So I decided
I'd hand-draw a map of campus, showing all of the construction, how to cut
through the labryinth that is Welch Hall on hot days, and where to find the 24/7
robot coffee machines, and hack together a routing engine to help people find
the shortest path between their classes. The feedback I got on this assignment
included something along the lines of, &quot;I was really pretty impressed first that
you would be so stupid as to actually try to do this...&quot;</p>
<p><img src="project/history/ut_map.png" alt="Hand-mapping UT Austin" /></p>
<p>But I did, and that led me to discovering OpenStreetMap, which it turns out was
pretty pivotal. (The first version of my campus map was seeded vaguely off an
official paper map, but mostly I walked around and invented half-assed surveying
methods on the spot.) Next semester, I joined a freshman research stream with
somebody who had worked on <a href="http://www.cs.utexas.edu/%7Eaim/">AIM</a>, UT's
demonstration that autonomous vehicles wouldn't need traffic lights. Everything
came together, and I started a 3 year journey of building
<a href="https://github.com/dabreegster/aorta/">AORTA</a>, a traffic simulator for AVs.
Guided by the research lab, I explored the really bizarre idea of letting AVs
<a href="http://www.cs.utexas.edu/%7Eaim/papers/ITSC13-dcarlino.pdf">bid to turn lights green sooner</a>
and micro-tolling all roads to disincentivize congestion. Both of these
mechanisms would be incredibly unfair to people without the spare cash to back
up their high value-of-time, but I brushed this off by saying the currency could
be based on carpooling, EVs, etc.</p>
<p><img src="project/history/aorta.gif" alt="Approximately Orchestrated Routing and Transportation Analyzer" /></p>
<p>It was great to try research in college; I learned I <em>really</em> dislike munging
data and compressing my work into 6 pages of conference paper LaTeX. So I moved
to Seattle to work in industry instead, on something completely unrelated to
transportation. Lots of things began unravelling for me in Seattle, but one of
them was biking. In Austin, I had picked up mountain biking, and all but stopped
driving; it was an amazing place to explore and commute by bike. Seattle was
different. There were many more cyclists around, but the experience felt more
stressful, the drivers more aggressive. I had plenty of near-misses. I kept
commuting by bike, but the joy of it was gone. I started noticing how many cars
were parked on narrow arterials and wondering why that was a fair use of space.
I started paying attention to the public discourse around bike infrastructure in
Seattle and feeling like the conversation was... chaotic.</p>
<p><img src="project/history/manhattan.jpg" alt="Manhattan took walkability seriously" /></p>
<p>Fast forward to late 2017. This is where I'll omit chunks of the story. I
visited London, my first experience with a city that took public transit
seriously. When I returned, lots of latent ideas stopped fermenting and started
exploding. I threw together a prototype of A/B Street and started the arduous
process at work of open-sourcing it and applying to a program to let me work it
on for a few quarters. A few months later, I wound up quitting instead, and
began to work on A/B Street in earnest.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="year-1-june-2018-2019"><a class="header" href="#year-1-june-2018-2019">Year 1 (June 2018-2019)</a></h1>
<p>I skimmed through git and summarized roughly what I was working on each month,
calling out milestones. &quot;UI churn&quot; is pretty much constantly happening.</p>
<ul>
<li>
<p>June: polyline geometry and lanes, building paths, protobuf -&gt; serde</p>
</li>
<li>
<p>July: pedestrians, bikes, parked cars, lane edits</p>
</li>
<li>
<p>August: porting AORTA's discrete-time driving model</p>
</li>
<li>
<p>September: multi-leg trips, buses, the first ezgui wizard, randomized
scenarios</p>
</li>
<li>
<p>October: A/B test mode (and so per-map plugins), forking RNG for
edit-invariance, intersection geometry</p>
</li>
<li>
<p>November: clipping / borders, using blockface for parking, time travel mode,
test runner framework</p>
</li>
<li>
<p>December: bezier curves for turns, traffic signal editor, a first attempt at
merging intersections, right-click menus, a top menu, modal menus</p>
<ul>
<li>the grand colorscheme refactor: a python script scraped <code>cs.get_def</code> calls
at build-time</li>
</ul>
</li>
<li>
<p>January: careful f64 resolution, ezgui screencapping, synthetic map editor</p>
<ul>
<li><strong>grand refactor</strong>: piston to glium</li>
</ul>
</li>
<li>
<p>February: attempting to use time-space intervals for a new driving model, new
discrete-event model instead</p>
<ul>
<li><strong>Feb 19-27</strong>: conceiving and cutting over to the new discrete event model</li>
</ul>
</li>
<li>
<p>March: fleshing out DES model (laggy heads), first attempt to build on
windows, gridlock detection</p>
</li>
<li>
<p>April: first public releases, splash screen and rearranging game modes</p>
</li>
<li>
<p>May: fancier agent rendering, attempting to use census tracts, finding real
demand data</p>
<ul>
<li><strong>milestone</strong>: discovered PSRC Soundcast data, much more realistic trips</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="year-2-june-2019-2020"><a class="header" href="#year-2-june-2019-2020">Year 2 (June 2019-2020)</a></h1>
<p><img src="project/history/oct_2019.png" alt="Circa October 2019" /></p>
<ul>
<li>
<p>June: contraction hierarchies for pathfinding, stackable game states</p>
</li>
<li>
<p>July: OSM turn restrictions, misc (I think I was in Europe?)</p>
</li>
<li>
<p>August: pedestrian crowds, agent color schemes, parking blackholes, a big
<code>raw_data</code> refactor to store <code>Pt2D</code>, attended first hackathon</p>
</li>
<li>
<p>September: offstreet parking, associating parked cars with buildings using
Soundcast (before that, anybody could use any car!), implemented texture
support for some reason, doing manual <code>MapFixes</code> at scale to fix OSM bugs</p>
<ul>
<li><strong>milestone</strong>: got the smallest montlake map to run without gridlock</li>
</ul>
</li>
<li>
<p>October: parking sim fixes, opportunistic lane-changing, starting challenge
modes</p>
</li>
<li>
<p>November: prebaked sim results, time-series plots, undo for edit mode, traffic
signal editor grouping turns</p>
<ul>
<li><strong>milestone</strong>: Yuwen joins project</li>
</ul>
</li>
<li>
<p>December: the UI reform begins (flexbox, minimap, trip timelines, cutting over
to SVGs, info panels, scrolling), started naming releases sensibly</p>
<ul>
<li>Project leaked to <a href="https://news.ycombinator.com/item?id=21763636">HN</a>, woops</li>
</ul>
</li>
<li>
<p>January: UI reform continues, the modern tutorial mode appears</p>
</li>
<li>
<p>Feburary: UI and tutorial, all text now pure vectors, port to glow+WASM</p>
</li>
<li>
<p>March: lockdowns start in US, start grouping trips as a person, population
heatmap, left-hand driving, info panel and typography overhauls. started
engaging with Greenways, started effort to map traffic signals</p>
</li>
<li>
<p>April: Orestis joins and starts the pandemic model, trip tables, the optimize
commute challenge, refactor for people's schedules and owned vehicles, trip
time dat viz, MAJOR progress fixing gridlock at the sim layer</p>
</li>
<li>
<p>May: gridlock progress, upstreaming fixes in OSM, differential throughput and
first real write-up, long-lasting player edits, dedicated parking mapper,
maybe vanquished the HiDPI bugs, multi-step turn restrictions, random bios for
people, and docs like this to prep for launch ;)</p>
<ul>
<li><strong>milestone</strong>: relying on pure OSM, no more <code>MapFixes</code></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="year-3-june-2020-2021"><a class="header" href="#year-3-june-2020-2021">Year 3 (June 2020-2021)</a></h1>
<ul>
<li>June: parking lots, real minimap controls, road labels
<ul>
<li><strong>June 22</strong>: alpha launch!
<a href="https://old.reddit.com/r/Seattle/comments/hdtucd/ab_street_think_you_can_fix_seattles_traffic/">r/Seattle</a>,
<a href="https://old.reddit.com/r/SeattleWA/comments/hdttu8/ab_street_think_you_can_fix_seattles_traffic/">r/SeattleWA</a>,
<a href="https://old.reddit.com/r/urbanplanning/comments/hdylmo/ab_street_a_traffic_simulation_game/">r/UrbanPlanning</a>,
<a href="https://news.ycombinator.com/item?id=23605048">HN</a>,
<a href="https://www.geekwire.com/2020/want-fix-seattle-traffic-redditor-makes-game-allows-players-tweak-city-streets/">GeekWire</a>,
<a href="https://www.thestranger.com/slog/2020/06/29/43999454/ab-streets-game-lets-you-create-the-seattle-street-grid-of-your-dreams">The Stranger</a></li>
</ul>
</li>
<li>July: loads of bugfixes, map geometry improvements, UI cleanups,
access-restricted zones for private neighborhoods and no-through-traffic,
better traffic generation between home&lt;-&gt;work for new maps, complete overhaul
to bus routes and introduction of light rail, commute pattern explorer,
importing Krakow and Berlin, smarter lane-changing, walkable shoulders for
roads without sidewalks
<ul>
<li><a href="https://www.youtube.com/watch?v=Pk8V-egsUxU">KING 5 Evening</a> interview</li>
</ul>
</li>
<li>August: Michael joins, multiple traffic signals can be edited together,
started a headless JSON API, support for other languages in OSM data, started
congestion capping, backwards-compatible and more robust map edits, two-way
cycletracks, more cities imported, slurry of bugfixes and performance
improvements
<ul>
<li><a href="https://bikesiliconvalley.org/2020/07/poster_dustin-carlino/">Silicon Valley Bike Summit</a>,
<a href="https://www.seattlepi.com/local/transportation/slideshow/solve-Seattles-traffic-problem-in-this-video-game-205839.php">Seattle PI</a></li>
</ul>
</li>
<li>September: full support for driving on the left, textured color scheme,
rendering isometric buildings, editing traffic signal offsets, a big round of
UI changes, infinite parking mode, trip purpose, alleyways
<ul>
<li><a href="https://www.seattlemet.com/news-and-city-life/2020/09/a-new-game-allows-you-to-redesign-seattle-streets">SeattleMet</a></li>
</ul>
</li>
<li>October: unit tested turn generation, web version launched with async file
loading, thought bubbles showing agent goals, slow parts of a trip
highlighted, more UI overhauls, dedicated OSM viewer mode started, major
simulation performance optimizations, major progress towards live map edits,
automatically picking boundaries for arbitrary cities</li>
<li>November: switched from Dropbox to S3, download new maps in-game, collision
dataviz UI, day/night color switching, unit testing lane changing behavior,
starting the 15 min walkshed tool, simplified simulation spawning code,
recording and replaying traffic around a few intersections, refactoring to
split out separate tools</li>
<li>December: lane-changing fixes, blocked-by explorer in debug mode, non-Latin
font support on web, saving player state on web, census-based scenario
generation started, 15 minute Santa</li>
<li>January: experimented with SUMO import, UI button overhaul, day/night mode,
first separate cycleways</li>
<li>February: better web loading and URL sharing, randomized parking,
procedurally generated houses, actdev integration, geofabrik picker, new day
theme, static routing penalties</li>
<li>March: UK flow-based scenario generation, roundabout gridlock fixes, UI panel
redesign, one-step OSM importer with UI, elevation data &amp; layers</li>
<li>April: pathfinding by roads, editing number of lanes, risk exposure, Tempe
intersection consolidation</li>
<li>May: GMNS signal timing import, cloud map importer, OSM turn lane fixes</li>
<li>June: performance, first dynamic vehicle lane-changing, exiting driveways
off-sides and across multiple lanes</li>
<li>July: pathfinding refactor, Broadmoor blog post, mode shift tool, massive
intersection consolidation breakthrough, deduplicating cycleways in OSM, bike
lane separators, new day mode colors</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-ab-street-retrospective"><a class="header" href="#the-ab-street-retrospective">The A/B Street Retrospective</a></h1>
<p>I want to reflect on what I've been working on for the past 3+ years, as of September 2021.</p>
<ul>
<li><a href="project/retrospective/index.html#technical-accomplishments--challenges">Technical accomplishments &amp; challenges</a>
<ul>
<li><a href="project/retrospective/index.html#the-map-model">The map model</a>
<ul>
<li><a href="project/retrospective/index.html#render-osm-in-gory-detail">Render OSM in gory detail</a></li>
<li><a href="project/retrospective/index.html#joining-data-sources">Joining data sources</a></li>
<li><a href="project/retrospective/index.html#map-editing">Map editing</a></li>
<li><a href="project/retrospective/index.html#the-map-importer">The map importer</a></li>
</ul>
</li>
<li><a href="project/retrospective/index.html#software-engineering">Software engineering</a>
<ul>
<li><a href="project/retrospective/index.html#testing">Testing</a></li>
<li><a href="project/retrospective/index.html#releases">Releases</a></li>
</ul>
</li>
<li><a href="project/retrospective/index.html#simulation">Simulation</a>
<ul>
<li><a href="project/retrospective/index.html#discrete-event-traffic-simulation">Discrete event traffic simulation</a></li>
<li><a href="project/retrospective/index.html#parking">Parking</a></li>
<li><a href="project/retrospective/index.html#gridlock">Gridlock</a></li>
<li><a href="project/retrospective/index.html#travel-demand-models">Travel demand models</a></li>
</ul>
</li>
<li><a href="project/retrospective/index.html#ui">UI</a>
<ul>
<li><a href="project/retrospective/index.html#widgetry-a-ui--dataviz-library-from-scratch">widgetry: a UI + dataviz library from scratch</a></li>
<li><a href="project/retrospective/index.html#native-and-web">Native and web</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="project/retrospective/index.html#design-accomplishments-and-challenges">Design accomplishments and challenges</a>
<ul>
<li><a href="project/retrospective/index.html#color-schemes">Color schemes</a></li>
<li><a href="project/retrospective/index.html#road-editor">Road editor</a></li>
<li><a href="project/retrospective/index.html#traffic-signal-editor">Traffic signal editor</a></li>
<li><a href="project/retrospective/index.html#data-visualization">Data visualization</a></li>
<li><a href="project/retrospective/index.html#road-labels">Road labels</a></li>
<li><a href="project/retrospective/index.html#charm">Charm</a></li>
</ul>
</li>
<li><a href="project/retrospective/index.html#project-management">Project management</a>
<ul>
<li><a href="project/retrospective/index.html#collaborations">Collaborations</a>
<ul>
<li><a href="project/retrospective/index.html#the-success-stories">The success stories</a></li>
</ul>
</li>
<li><a href="project/retrospective/index.html#project-scope">Project scope</a></li>
<li><a href="project/retrospective/index.html#teasing-apart-the-monolith">Teasing apart the monolith</a></li>
<li><a href="project/retrospective/index.html#marketing">Marketing</a></li>
<li><a href="project/retrospective/index.html#community">Community</a></li>
<li><a href="project/retrospective/index.html#money">Money</a></li>
</ul>
</li>
<li><a href="project/retrospective/index.html#the-problem">The problem</a>
<ul>
<li><a href="project/retrospective/index.html#advocacy-groups">Advocacy groups</a></li>
<li><a href="project/retrospective/index.html#the-public">The public</a></li>
<li><a href="project/retrospective/index.html#whos-our-audience">Who's our audience?</a></li>
<li><a href="project/retrospective/index.html#what-this-project-means-to-me">What this project means to me</a></li>
</ul>
</li>
</ul>
<h2 id="technical-accomplishments--challenges"><a class="header" href="#technical-accomplishments--challenges">Technical accomplishments &amp; challenges</a></h2>
<h3 id="the-map-model"><a class="header" href="#the-map-model">The map model</a></h3>
<p>To support a traffic simulation, A/B Street's map model isn't just a graph. It represents the physical geometry of roads and intersections and includes land-use semantics, like estimates of residential units and commercial spaces within each building.</p>
<p>One thing that's surprising to people with a GIS background is how from-scratch everything is. There's no QGIS, Leaflet, PostGIS, or map tiles. The map is just a single file with simple data structures and a clipped study area.</p>
<h4 id="render-osm-in-gory-detail"><a class="header" href="#render-osm-in-gory-detail">Render OSM in gory detail</a></h4>
<p>OpenStreetMap represents streets loosely as a graph, with road center-lines and a pretty free-form key/value tagging system. It was designed for ease of mapping certain features, not for maintaining data quality, representing roads as physical space, or describing semantics of movement along the transportation network.</p>
<p>But A/B Street needed lots of this, and OSM is the most enticing data source available, so I wrote aggressive heuristics to extract meaning from the formless chaos. Perfect results are unattainable, but I'm quite proud of how far it's come and how robust it is to most cities I've imported.</p>
<ul>
<li>
<p><a href="https://github.com/dabreegster/abstreet/blob/master/map_model/src/make/initial/lane_specs.rs">transforming road tagging into lanes</a></p>
<ul>
<li>The tagging schema described by the OSM wiki is complicated to begin with. But real mapping still diverges from this. I wound up fixing many discrepencies in Seattle, and made <a href="project/retrospective/../../software/osm_viewer.html">a dedicated tool</a> to help other mappers validate their work.</li>
<li>Because of A/B Street, I've mapped OSM tags that're just proposals or not widely used -- like <a href="project/retrospective/../../software/parking_mapper.html">street parking</a> and <a href="https://wiki.openstreetmap.org/wiki/Talk:Proposed_features/cycleway:separation">cycleway:separation</a>.</li>
</ul>
</li>
<li>
<p><a href="project/retrospective/../../tech/map/geometry/index.html">Creating geometry from roads and intersections</a></p>
<ul>
<li>I believe A/B Street has the most advanced handling of complex OSM intersections of anything that's public</li>
</ul>
</li>
<li>
<p>OSM doesn't directly encode what movements are possible through each intersection. A/B Street generates this for vehicles and pedestrians with aggressive heuristics.</p>
<ul>
<li>OSM turn lane tagging is often flat-out wrong (not matching the lane count) or broken when ways are split before an intersection</li>
<li>OSM has turn restriction relations that can span multiple road segments. This impacts graph pathfinding and traffic simulation in subtle ways. <!-- link pathfinding article --></li>
</ul>
</li>
<li>
<p>OSM includes parking lots and aisles, but A/B Street needs to know capacity, which is rarely mapped. So it procedurally generates individual stalls fitting the geometry.</p>
</li>
<li>
<p>A traffic signal is just a node in OSM -- or worse, a bunch of individual nodes for a complex junction. There's no way to describe its timing.</p>
<ul>
<li>A/B Street has reasonable heuristics for grouping movements together in stages for many different shapes of intersections. (I never did much work on automatically improving the timing, though.)</li>
<li>I invented a <a href="project/retrospective/../../tech/dev/formats/traffic_signals.html">JSON interchange format</a> referencing OSM IDs to describe signal configuration.</li>
<li>I worked with Dr. Xuezong Zhou's ASU group to import <a href="https://github.com/asu-trans-ai-lab/Vol2Timing">GMNS signal timing</a> and match the movements to A/B Street's representation.</li>
<li>The city of Seattle has still yet to release any public data about how signals are really timed, so for a while, I was <a href="https://docs.google.com/document/d/1Od_7WvBVYsvpY4etRI0sKmYmZnwXMAXcJxVmm8Iwdcg/edit?usp=sharing">manually mapping them</a> with a notebook and stopwatch, and even convinced a few other people to join. (Of course this was futile; most interesting intersections depend on actuators, which can't be observed directly.)</li>
</ul>
</li>
<li>
<p>Built pathfinding into the map model for vehicles and pedestrians. <!-- article --></p>
<ul>
<li>Funded the creation of a new <a href="https://github.com/easbar/fast_paths">Rust contraction hierarchy library</a> to achieve the performance necessary for a traffic simulation</li>
<li>Some complex features: responding to map edits (that might reverse roads, close things off to some vehicles), handling complex turn restriction relations, modeling private neighborhoods and streets with no through-traffic, turning left or right out of a driveway, and elevation-aware cost functions for vehicles, pedestrians, making unprotected turns, etc</li>
</ul>
</li>
</ul>
<!-- Snapping -->
<p><img src="project/retrospective/road_width_osm.png" alt="" />
<em>Do you have any idea what's on these roads?</em></p>
<p><img src="project/retrospective/road_width_abst.png" alt="" />
<em>A/B Street shows the bus lanes and guesses road width.</em></p>
<p><img src="project/retrospective/tempe_junction_osm.png" alt="" />
<em>An arterial road with light rail crosses a minor road in OSM</em></p>
<p><img src="project/retrospective/tempe_junction_abst.png" alt="" />
<em>In A/B Street, one consolidated traffic signal represents this situation</em></p>
<p><img src="project/retrospective/parking_lot_osm.png" alt="" />
<em>A parking lot in OSM</em>
<img src="project/retrospective/parking_lot_abst.png" alt="" />
<em>The same lot in A/B Street -- 1500 spots, based on geometry</em></p>
<p><img src="project/retrospective/tsig_two_stage.png" alt="" />
<em>Is turning traffic backing up here?</em></p>
<p><img src="project/retrospective/tsig_four_stage.png" alt="" />
<em>Add some protected left turns!</em></p>
<h4 id="joining-data-sources"><a class="header" href="#joining-data-sources">Joining data sources</a></h4>
<p>A/B Street brings in other public data for some cities, joining it with the OSM-based map model.</p>
<p><img src="project/retrospective/data_blockface.png" alt="" />
<em>Blockface data in Seattle describes street parking restrictions... in theory. Many segments disagree with OSM's splitting of roads, and many blocks have incorrect data.</em></p>
<p><img src="project/retrospective/data_elevation.png" alt="" />
<em>LIDAR elevation data overlaid with the bike network shows why Aurora would be such a nicer route to bike north from downtown than Fremont</em></p>
<p><img src="project/retrospective/data_parcels.png" alt="" />
<em>The sad blue sea of single-family parcels, from King County parcel data</em></p>
<h4 id="map-editing"><a class="header" href="#map-editing">Map editing</a></h4>
<p>It would be so simple if that map model representation was nice and immutable. But the whole point of A/B Street is to explore changes to the built environment. Aside from the UIs for this (which themselves went through many design iterations and usability studies), supporting this in the map model layer has been tough.</p>
<ul>
<li>Representing edits durably, even when a map is rebuilt from updated OSM data.</li>
<li>Handling undo/redo. When you change the lanes of one road, it might invalidate the traffic signal policy nearby.</li>
<li>When you widen or shrink a road, it affects intersection geometry. Especially when that intersection has been consolidated from several in OSM, there are some edge cases...</li>
<li>Applying edits has to be fast -- jokes on loading screens are hard to write!</li>
</ul>
<h4 id="the-map-importer"><a class="header" href="#the-map-importer">The map importer</a></h4>
<p>At first, I was just importing a few parts of Seattle, so running a little tool was fine. But as word of the project spread, of course people wanted to see it in more places. (And in fact, the most solid audience for the project has been the OSM community -- mappers tend to already be very invested in OSM as a hobby, so they're willing to get past any clunky UX hurdles in order to play with something cool!) By now, I'm importing ~130 maps from ~80 cities. Anytime I update the OSM import code, I've committed to regenerating everything and at least not totally breaking a city!</p>
<p>I've <a href="https://github.com/a-b-street/abstreet/issues/326">only barely managed</a> to stay on top of this growing scale. My faster laptop died for a few months and I scrambled to parallelize the import process in the cloud just to survive. Something that I haven't solved is expressing the complex importing process as a proper pipeline. Ideally it's a DAG of tasks depending on each other, with clear logging, progress tracking, parallelization, and error handling. One reason this is hard is expressing which parts of the graph to invalidate and recalculate. Should we grab new upstream OSM data? Just recalculat scenarios, leaving the maps alone? Only re-run one stage of the map import?</p>
<p>I'm pretty happy with how easy it is to <a href="https://a-b-street.github.io/docs/user/new_city.html">import a new city</a>. Originally you had to email me a boundary or compile the project yourself, but now the UI just asks you to draw a GeoJSON boundary, uses Overpass to grab fresh data, and runs the importer for you.</p>
<h3 id="software-engineering"><a class="header" href="#software-engineering">Software engineering</a></h3>
<h4 id="testing"><a class="header" href="#testing">Testing</a></h4>
<p>A huge challenge to maintaining maps over time is not breaking things, either from my own importing code or when grabbing new OSM data upstream. Writing tests to guarantee some kind of invariants in the map model layer (like no two roads overlapping each other, no disconnected bits of the graph, minimum road length, etc...) was something I wanted to do, but all of those are pretty impossible targets to meet with the messiness of OSM data. So I settled on regression tests and manual tool-assisted diffing. Screenshot diffing is one trick -- inspect an imported map once, take screenshots of it, then later compare to manually validate changes. There are also tests that re-run a full traffic simulation on maps known to work. They ensure gridlock isn't re-introduced, that overall travel time patterns don't change radically, etc.</p>
<p>There aren't tons of unit tests. Usually expressing the input and expected output for any of the interesting problems is just too hard manually. There are some hybrid solutions, like generating turns at an intersection. The input (a map's roads) isn't easy to understand by looking at some text encoding, but viewing in the UI is. Likewise, a human can't glance at output like &quot;left turn from lane #5 to lane #84&quot; and hope to understand it. But we can store the text output as goldenfiles and, when there's a diff, again use the UI to inspect the change.</p>
<h4 id="releases"><a class="header" href="#releases">Releases</a></h4>
<p>At my previous job, there was quite a bit of hassle maintaining a production service without downtime. It was initially very freeing to just write software quickly without worrying about breaking people, but of couse that didn't last long after I started releasing public builds every week. The <a href="project/retrospective/../../tech/dev/release.html">release process</a> is mostly automated.</p>
<p>At first, I just shipped all map and scenario data with the .zip releases and bundled this in one big .wasm blob (yes, really). Of course this didn't scale as we increased the number of imported cities. So eventually I made the UI download each city only when needed. This required <a href="project/retrospective/../../tech/dev/data.html">versioning the data</a> -- the code in a release from weeks ago is probably binary incompatible with the current map data.</p>
<p>Originally I just threw all the files in my personal Dropbox, but moved to S3 at some point (every single public file in Dropbox needs its own URL, and I broke the Python tool spamming it with requests for hundreds of files...). I really wanted to just re-use some existing tool to sync with S3 (both for me uploading and for people downloading), but never found anything that met all my needs -- cross-platform without system dependencies, grouping files into per-city data packs, gzipping. So I rolled my own <a href="https://github.com/a-b-street/abstreet/blob/master/updater/src/main.rs">updater</a>.</p>
<p>I'd still love to conceptually use real version control; maybe Git LFS is worth another try.</p>
<h3 id="simulation-1"><a class="header" href="#simulation-1">Simulation</a></h3>
<h4 id="discrete-event-traffic-simulation"><a class="header" href="#discrete-event-traffic-simulation">Discrete event traffic simulation</a></h4>
<!-- Full article... (maybe some of this is the intro to it) -->
<p>Although there's lots of academic papers out there describing car-following models and other &quot;microscopic,&quot; agent-based traffic models, it's always seemed to me that they omit details about how to actually implement them. So, I rolled my own. Not claiming this is a good approach -- simulation results have to be met with <strong>much</strong> more skepticism -- but I'm very proud of the model.</p>
<p>A/B Street simulates the movement of individual people walking, biking, and driving. It doesn't do so in fixed time-steps (every 0.1 seconds, update everything). It uses a &quot;discrete event&quot; approach. Each agent is in a state, like traveling along a lane or waiting at an intersection, for some amount of time. Updates only happen when that state possibly transitions to another one, like when a vehicle reaches the end of a lane or a traffic signal &quot;wakes up&quot; people on a green light. Instead of updating every agent every 0.1 seconds, we just &quot;skip ahead&quot; to the next interesting time, per agent.</p>
<p>Actually making this work with on-demand rendering at any moment in time is one of the more clever things I've come up with. The model is quite fast (until gridlock happens...) and looks reasonably realistic in aggregate. Things like smooth acceleration are missing, but few people have seemed to notice. Making vehicles change lanes and over-take is one of the main limitations -- this is very hard to squeeze into the discrete event model, and only half-done.</p>
<p><img src="project/retrospective/traffic_sim.gif" alt="" />
<em>Drivers, cyclists, and pedestrians negotiate the traffic signal at Greenwood and N 87th</em></p>
<h4 id="parking-1"><a class="header" href="#parking-1">Parking</a></h4>
<p>Some traffic simulators out there are only focused on highways, not even inner-city driving. Many don't include pedestrians and cyclists, or bolt them on as an after-thought. But I'll bet A/B Street is one of the only ones including a detail crucial to the experience of driving: <a href="project/retrospective/../../tech/trafficsim/parking.html">parking</a>. How many times have you heard a friend complain that it took 10 minutes to drive over, but 15 to find parking? Exactly.</p>
<p>Except in some maps that disable it, every driving trip in A/B Street begins and ends with somebody walking between their actual endpoint and a parking spot with their car. There's lots of estimation with the capacity along streets, in parking lots, and especially with private residences and businesses, but at least A/B Street tries. Maybe this pushes the rest of the field towards a bit more realism. Abstractions matter! Parking occupies a huge amount of space, and when your phone says driving somewhere is 20 minutes faster than taking a bus, it may not be giving you the full picture -- are you sure you won't circle around a dense neighborhood for 10 minutes finding that free spot? Abstractions matter. I hope I've done justice to Donald Shoup.</p>
<p><img src="project/retrospective/../../tech/trafficsim/parking_efficiency.png" alt="" />
<em>Darker red dots are vehicles parked farther away from their final destination</em></p>
<h4 id="gridlock-1"><a class="header" href="#gridlock-1">Gridlock</a></h4>
<p>In both the real world and in a traffic simulation, vehicles get a bit stuck. In the real world, this is usually resolved by humans slightly breaking strict abstractions like usage of distinct lanes, slowly creeping into a partially blocked intersection, or deciding to detour around a problem last minute. I've had a hard time capturing that robustness in simulation, so well, in most simulations on larger maps, vehicles get stuck. Like, permanently.</p>
<p>This has so many causes -- broken intersection geometry causing impossible turn conflicts, weird lane-changing behavior, vehicles being too cautious about partially blocking an intersection, pedestrians darting into non-existent crosswalks, hilariously Byzantine traffic signal timing, travel demand models sending all 80,000 trips to UW campus to a single tiny building... and so I've dumped countless hours into trying to fix them, with only very modest success. Sometimes it's trying to fix the data, or improve signal timing heuristics. Sometimes it's building in complex cycle detectors into the simulation to figure out when vehicles in a roundabout are all waiting for each other. Sometimes it works. Usually it doesn't.</p>
<p><img src="project/retrospective/traffic_seitan.png" alt="" />
<em>Traffic Seitan spreads from one broken Fremont bridge</em></p>
<h4 id="travel-demand-models"><a class="header" href="#travel-demand-models">Travel demand models</a></h4>
<p>You can't run a traffic simulation if you don't know where people are going, when they're leaving, or how they're trying to get there. The naive approach of uniformly distributing some number of trips between all possible buildings is hilariously unrealistic. And the amount of complex modeling and <a href="https://www.psrc.org/sites/default/files/soundcastdesign2014.pdf">specialized knowledge</a> needed to properly do activity modeling or something simpler is overwhelming. I've tried as much as possible to punt on this -- importing Soundcast data for Seattle, relying on collaborators like <a href="https://github.com/asu-trans-ai-lab/grid2demand">grid2demand</a> and <a href="https://a-b-street.github.io/abstr">abstr</a>.</p>
<p>But inevitably, A/B Street has wound up with its own simple travel demand models. Mateusz started the <a href="https://github.com/a-b-street/abstreet/issues/154">proletariat robot model</a>, using naught but OSM tags on buildings to estimate the number of people living and working, and using simple matching to send people to and from work, and nothing else. Such robots.</p>
<p>Then during the <a href="https://actdev.cyipt.bike/">Actdev</a> work, it became necessary last-minute to generate traffic using UK census flow data, which describes the number of people commuting between different polygonal areas for work, broken down by mode. The <a href="https://github.com/a-b-street/abstreet/blob/master/popdat/src/od.rs">pipeline</a> is simple.</p>
<p>We've also done a fair bit of work into data visualization to understand the outut of these travel demand models. Part of this even includes heuristics that automatically group buildings into &quot;neighborhoods&quot; -- roughly, tracing along arterial roads and finding everything in the middle.</p>
<p><img src="project/retrospective/commuter_patterns.png" alt="" />
<em>Where do trips starting from Broadview go, according to Soundcast data?</em></p>
<h3 id="ui"><a class="header" href="#ui">UI</a></h3>
<h4 id="widgetry-a-ui--dataviz-library-from-scratch"><a class="header" href="#widgetry-a-ui--dataviz-library-from-scratch">widgetry: a UI + dataviz library from scratch</a></h4>
<p>This is probably one of the more ridiculous things that's happened.</p>
<p>In ~2018 when I started, all of the rendering and GUI libraries for Rust appeared to not do what I needed. So I started with <a href="https://github.com/rust-windowing/winit">raw window event handling</a> and OpenGL and... just went for it. It's not hard to start drawing a big <a href="https://wiki.openstreetmap.org/wiki/Slippy_Map">slippy map</a> with zooming and panning, nor is it tough to wire up a basic clickable button. But... <a href="https://a-b-street.github.io/docs/tech/dev/ui.html">widgetry</a> has turned into something quite feature-full and has a decent API.</p>
<p>The journey there was quite circuitous. Most of the difficulty was not even knowing how the UI should work (or even having a clear picture of what the app was supposed to do...). But once Yuwen joined the project, this library started shaping up very quickly. And Michael has dumped in countless work into adding complex features to it, polishing the APIs and style, implementing massive design changes from Yuwen like the buttons...</p>
<p>The end result is pretty impressive -- it works on native and web (no system dependencies), everything's an infinitely scalable vector (including text), and it has loads of interactive dataviz widgets.</p>
<p><img src="project/retrospective/widgetry_demo.gif" alt="" />
<em>A quick preview of interactive line plots, draggable cards, and a canvas filled with vector goodies</em></p>
<h4 id="native-and-web"><a class="header" href="#native-and-web">Native and web</a></h4>
<p>I never intended to target mobile or the web. But in January 2020ish, winit support for web landed, so I thought... why not? Initial support was surprisingly easy, but properly dealing with asynchronous file loading, loading screens, progress bars, and detangling native-only dependencies has been quite tough.</p>
<h2 id="design-accomplishments-and-challenges"><a class="header" href="#design-accomplishments-and-challenges">Design accomplishments and challenges</a></h2>
<p>I think it's safe to say my own design skills are somewhat lacking:</p>
<p><img src="project/retrospective/ui_ancient.png" alt="" />
<em>A/B Street as of September 2019</em></p>
<p>A/B Street has lots of complex information to convey and data to visualize, and getting people excited about a vision for a more sustainable transportation system requires beautiful design. So... it's quite awesome that <a href="https://www.yuwen-li.com/work/abstreet">Yuwen</a> joined the project at the right time. Thanks to <a href="https://github.com/michaelkirk">Michael</a> and feedback from dozens of people from OpenStreetMap, Github, Twitter, and user testing studies, A/B Street today is quite aesthetic and functional.</p>
<h3 id="color-schemes"><a class="header" href="#color-schemes">Color schemes</a></h3>
<p>One of the puzzles I struggled with from the very start was how to communicate both lane types and road types at the same time. Unzoomed, a simple color scheme distinguishes highways from major and minor roads:</p>
<p><img src="project/retrospective/colors_unzoomed.png" alt="" />
<em>I5 is distinguishable from arterial and residential roads in Seattle, and the Burke Gilman trail is also visible.</em></p>
<p>But zoom in, and we use coloring to distinguish regular lanes, parking, and sidewalks. It's still useful to distinguish major and minor roads, though! Most maps cheat with road width and use that, but there are many cases where arterials are just as wide as residential streets.</p>
<p><img src="project/retrospective/colors_zoomed_before.png" alt="" />
<em>Can you spot the arterial?</em></p>
<p>But inspired by designs from <a href="https://github.com/westnordost">Streetcomplete by Tobias</a>, we found some shades of grey that convey the difference quite effectively, as well as slightly convey the curb height:</p>
<p><img src="project/retrospective/colors_zoomed_after.png" alt="" />
<em>There it is!</em></p>
<p>Also, we have a pretty fantastic night mode, although I'm still holding out for something more cyberpunk.</p>
<p><img src="project/retrospective/colors_night.png" alt="" />
<em>Both the UI and map have colors to show when the simulation is after-hours</em></p>
<h3 id="road-editor"><a class="header" href="#road-editor">Road editor</a></h3>
<p>A/B Street's ability to edit roads started simple, but today is quite powerful. Inspired by <a href="http://streetmix.net">Streetmix</a>, you can modify lanes however you want:</p>
<p><img src="project/retrospective/edit_roads.gif" alt="" />
<em>Drag-and-drop, spear-headed by Michael, is key to this UI working smoothly.</em></p>
<p>We arrived at this design only after many rounds of designing, implementing prototypes, and gathering feedback.</p>
<h3 id="traffic-signal-editor"><a class="header" href="#traffic-signal-editor">Traffic signal editor</a></h3>
<p>Most people experience traffic signals from the ground, not the sky -- they think about just the direction they want to go, not how the entire intersection behaves over time. At any point in time, a particular movement could be protected by a green arrow or light, permitted after yielding to oncoming traffic, or not allowed. After many iterations, I think we represent and allow changes to this quite well:</p>
<p><img src="project/retrospective/edit_signals.gif" alt="" />
<em>Left turns should be protected here. So first we remove the left turns from stage 1, where they were just permitted. Then we add a new stage, protect the left turns, and adjust its timing to end early if there's no traffic.</em></p>
<h3 id="data-visualization"><a class="header" href="#data-visualization">Data visualization</a></h3>
<p>A/B Street measures all sorts of things -- travel times, delays, throughput, a biking route's steepness, exposure to risky events. All of these things can be understood at the level of individual agents, roads, and intersections, or you can explore aggregate patterns and finder larger trends. You can view the data in absolute terms based on the current simulation running, or if you've edited the map (and the map is one of the lucky few that doesn't gridlock), then you can compare the results to the baseline simulation without edits -- the essence of A/B testing.</p>
<p>Here's a very incomplete sampling of our work:</p>
<p><img src="project/retrospective/viz_trip.png" alt="" />
<em>Diving into one person's route</em></p>
<p><img src="project/retrospective/viz_delay_scatter.gif" alt="" />
<em>Watching a live scatter plot of delays through an intersection, broken down by mode</em></p>
<p><img src="project/retrospective/viz_relative_thruput.png" alt="" />
<em>The red roads have higher foot traffic, due to converting Broadmoor to a Stay Healthy Street</em></p>
<p><img src="project/retrospective/viz_trip_table.gif" alt="" />
<em>Using a sortable table of all trips to find individual people whose journey got much faster due to map edits</em></p>
<p><img src="project/retrospective/viz_time_summary.gif" alt="" />
<em>Understanding how short and long trips got faster or slower due to map edits</em></p>
<h3 id="road-labels"><a class="header" href="#road-labels">Road labels</a></h3>
<p>Placing road labels on a map is quite a design and implementation challenge, but Michael and I cranked out something decent in a few days:</p>
<p><img src="project/retrospective/road_labels.gif" alt="" />
<em>Labels aren't too densely clustered, but they still appear to help orient by major roads.</em></p>
<h3 id="charm"><a class="header" href="#charm">Charm</a></h3>
<p>Some design decisions in A/B Street are a love story to the city that started it:</p>
<p><img src="project/retrospective/rainbow_crosswalks.png" alt="" />
<em>The cycletrack may not be snapped to Broadway properly, but we do have the rainbow crosswalks on Pike</em></p>
<p>We tried to create a narrative around the game's challenge modes, with character art from a <a href="https://hollarity.com/">college friend</a>:</p>
<p><img src="project/retrospective/characters_cutscene.png" alt="" />
<em>The Boss doles out assignments and placates irate citizens</em></p>
<p>One of the first things people point out about A/B Street is the unusually bendy buses:</p>
<p><img src="project/retrospective/articulate.gif" alt="" />
<em>&quot;This frustrated tension and brief relief I cant articulate / oh, but the bus can.&quot; - from <a href="https://dabreegster.github.io/poetry/adult/public_transit.html">public transit</a></em></p>
<p>For the record, this started because the simpler alternative is much worse. If you draw a long bus as a straight line and use any one point to determine the angle, the bus will pendulum around tight curves, happily smashing into anything in the way. Snakes are a slightly better approximation of reality. (I think the bendy buses have been called some less polite, but more hilarious, things too...)</p>
<h2 id="project-management-1"><a class="header" href="#project-management-1">Project management</a></h2>
<p>Here's the section where I feel like the challenges have swallowed me, with very little success.</p>
<h3 id="collaborations"><a class="header" href="#collaborations">Collaborations</a></h3>
<p>I was pretty quiet the first year, but then I started actively looking for people interested in working on this. I've lost track of all the people I've spent at least an hour talking to and seriously trying to set up some sort of collaboration -- at least 100? I've tried everything I can to attract <a href="project/retrospective/../contributing.html">contributors</a> for programming, design, business, outreach, writing. Many start, but wind up vanishing. It's exhausting for me; I get emotionally invested in everybody who wants something from A/B Street. Running an open source project is really hard. <strong>But I want to emphasize it has partly worked -- I'm super thankful for the ~dozen people who have stuck around and really made working on this project a true pleasure.</strong> I probably need to learn to filter better, fail-fast, and put some barriers up before I invest.</p>
<p>There were a few low moments that stand out. Accidentally CC'd on an internal email literally stood the question, &quot;It's open souce, why pay him anything?&quot; when I was trying to set up a small consulting deal. There was also a group that was too cheap to hire somebody for their own idea, so exploited the fact that this is a passion project for me and for a while, somewhat successfully coerced me to work on their quasi-startup. There were also some highlights, especially when butting heads philosophically. Not everybody understood my <a href="project/retrospective/../motivations.html">mission</a> before reaching out. I'll never forget one video call with a company that was going splendidly, until I explicitly stated all work I do will be open source -- watching the other person scramble to control their plummeting facial expression was perfect. And once I got the most Silicon Valley-ish email ever that started, &quot;I'm the founder of a XYZ billion dollar AV startup.&quot; After thinking a moment, I led back with, &quot;Well I think your XYZ billion dollar startup is a reasonable stepping towards car-free cities, but AVs aren't part of the world that I ultimately want to build towards.&quot;</p>
<p>These moments still bring me strength.</p>
<h4 id="the-success-stories"><a class="header" href="#the-success-stories">The success stories</a></h4>
<p>I want to particularly thank Robin for his involvement with A/B Street. He fought to make it a part of <a href="https://actdev.cyipt.bike">ActDev</a>, a really neat data science tool studying how people living in new residential sites in the UK are likely to commute. This integration provided a strong push to solidify the web deployment of A/B Street.</p>
<p><img src="project/retrospective/poundbury_actdev.png" alt="" />
<em>You can explore mode split patterns and other data in the ActDev site</em></p>
<p><img src="project/retrospective/poundbury_abst.png" alt="" />
<em>and then just click to simulate the site at an agent-based level, and edit the cycle network</em></p>
<p>Robin has also massively helped evangelize the project and network with possible users. Along with Nathanael, they've made A/B Street more accessible to the data science community, creating an <a href="https://a-b-street.github.io/abstr/">R package</a> to transform travel demand models into individual trips to simulate. Robin's enthusiasm for open source and reproducible research is infectious.</p>
<h3 id="project-scope"><a class="header" href="#project-scope">Project scope</a></h3>
<p>Traffic simulation is such a massively broad endeavor, and because I dabble in so many parts of it, people really brought strong expectations about what they wanted it to be. What about Monte Carlo simulations? Or gondolas? (No, really.) Why not build a city from scratch, just merge with Citybound? Oh, there's no lane-changing? Not calibrated to real traffic volume data? Well then it must be useless.</p>
<p>I tried my best to balance all of that input with establishing boundaries and pursuing MY vision.</p>
<p>... But what exactly was my vision? I said early on, &quot;this is an identity crisis between a game and a serious planning tool.&quot; At first that was a way to punt on the realism and calibration problem -- I couldn't hope to alone compete with industry standard simulation software. It was also a way to engage the general public, or at least the percentage that plays games.</p>
<!-- And where do things stand? What're the use cases, who is the audience? Advocacy? Education? Placating fears of NIMBYs? -->
<h3 id="teasing-apart-the-monolith"><a class="header" href="#teasing-apart-the-monolith">Teasing apart the monolith</a></h3>
<p>The scope of A/B Street is <strong>way</strong> too broad. Early on, all of the new experiments were just crowded onto the title screen, but at some point, we split out more tools with more focused purposes.</p>
<p>The &quot;main&quot; app is A/B Street -- that thing that lets you simulate traffic and edit roads. Part of it still tries to act like a computer game, but we haven't put much effort into this in quite a while. It does have a tutorial and a few challenge modes with particular objectives (and even a narrative with some characters!). But I wouldn't call A/B Street as a game &quot;fun&quot; -- one of the challenge modes is impossible to win, because we picked too large a map to ever hope to get past the gridlock bugs. We could chop up the challenges into much smaller &quot;levels&quot; and properly tune the difficulty curve, but it would honestly take somebody dedicated to game design to spearhead that.</p>
<p><img src="project/retrospective/tutorial.png" alt="" />
<em>The user interface can be overwhelming, but the tutorial slowly introduces and motivates different features. The more ambitious idea was always to have the player slowly &quot;unlock&quot; more of the tools as they complete challenges.</em></p>
<p>Instead, most uses of A/B Street are in the &quot;sandbox&quot; mode, where no specific objectives exist. Instead, this is a place to edit the map, explore all the different data visualizations, and try to inch towards completing a full simulation without gridlock.</p>
<p>I feel bad that A/B Street as a properly fun game was never realized, but I'm proud of <a href="project/retrospective/../../software/santa.html">15-minute Santa</a>. By no means is Santa attempting to split the difference between serious planning and entertainment; it's just a silly arcade game that loosely involves transportation and land use.</p>
<p><img src="project/retrospective/santa.gif" alt="" />
<em>Paperboy modernized with OpenStreetMap, a Santa sprite, and plenty of silliness</em></p>
<p>We also made a tool to explore <a href="project/retrospective/../../software/fifteen_min.html">15-minute neighborhoods</a>. The isochrones are hopefully useful to understand what parts of a city have good or bad access to different types of shops, and how hills and slow traffic signals affect walk or bike-sheds. Editing the map -- particularly to modify land use -- and checking out the differential isochrone would be the ultimate use for this tool, should we ever revive it.</p>
<p>As I realized the most active audience for A/B Street is the OpenStreetMap community, I spun out some tools to <a href="project/retrospective/../../software/osm_viewer.html">validate lane tagging</a> and <a href="project/retrospective/../../software/parking_mapper.html">tag street parking</a>.</p>
<p>And finally, after some feedback from advocacy groups and people who felt overwhelmed by the broad scope of A/B Street, we're working on a simple interface for sketching and evaluating a bike network. Stay tuned.</p>
<h3 id="marketing"><a class="header" href="#marketing">Marketing</a></h3>
<p>The successful marketing basically came for free. A single bold post to <a href="https://old.reddit.com/r/Seattle/comments/hdtucd/ab_street_think_you_can_fix_seattles_traffic/">r/seattle</a> was magic. Someone &quot;leaked&quot; the project to <a href="https://news.ycombinator.com/item?id=23605048">Hacker News</a>. I think the <a href="https://www.youtube.com/watch?v=LxPD4n_1-LU">alpha launch trailer</a> got the point across. <a href="https://www.thestranger.com/slog/2020/06/29/43999454/ab-streets-game-lets-you-create-the-seattle-street-grid-of-your-dreams">The Stranger</a> made a shocking connection between my childhood with Banjo Kazooie and my current fascination with multi-modal travel.</p>
<p>But I've also hustled near-constantly online and in-person, at countless hackathons and <a href="project/retrospective/../presentations.html">conferences</a>. I've cold-emailed so many companies trying to set up collaborations.</p>
<h3 id="community"><a class="header" href="#community">Community</a></h3>
<p>The A/B Street Slack has a sense of home to me; it might've started for work, but I've forged friendships there.</p>
<p>I think I did a reasonable job amassing a small army of people interested in open source transportation software. Some of the academic and data science communities weren't talking to each other before I got people into the same (virtual) room.</p>
<h3 id="money"><a class="header" href="#money">Money</a></h3>
<p>I self-funded from savings from my previous big tech job. I feel super fortunate to have had zero pressure to make money with A/B Street, letting me prioritize what really matters to me. I've even personally funded a few people to create <a href="project/retrospective/../funding.html">new open source libraries</a> that I needed.</p>
<p>But not starting a business, even some kind of consulting firm, was likely a mistake. Many of the groups I tried to collaborate with probably had no idea how to deal with me. There's no legal entity for the project, I'm not in academia, I'm not even calling it a startup.</p>
<h1 id="the-problem"><a class="header" href="#the-problem">The problem</a></h1>
<p>That thing I've poured 3+ years of my life into? Nobody's using it.</p>
<p>(Except maybe a few members of the OSM community, in a way I mostly don't hear about.)</p>
<h2 id="advocacy-groups"><a class="header" href="#advocacy-groups">Advocacy groups</a></h2>
<p>For a long time, I've insisted that either advocacy groups who fight for biking/walking-friendly changes in cities or individual Twitter urbanists with large followings would find some use for A/B Street. Maybe the traffic simulation stuff is overwhelming and not trustworthy, fine. But at least the top-down road visualization and editing is better at communicating an idea than some squiggly lines on top of Google Maps? Surely groups pushing for a better bike network want to see how elevation and collision data relate to their ideas?</p>
<p>And the more I understand about how advocacy groups (at least in Seattle) work, the less I have faith in them to avert the climate crisis. I seriously respect their longevity and determination, but fighting for years to get only the slightest improvement isn't a time-scale I believe in. Cities need a massive culture shift. I want to find and work with the people who have some sense of urgency, even if that's not realistic.</p>
<h2 id="the-public"><a class="header" href="#the-public">The public</a></h2>
<p>The thesis behind A/B Street is that ordinary citizens are experts in some small slice of the city that they interact with. And so when they see a problem, A/B Street is a tool for them to explore and express ideas for changing it. But I'm beginning to believe I'm wrong about this -- because, where are they? If somebody's only casually interested, they're not going to dedicate their time to fighting for a real change. And if somebody really does care enough, they'll... possibly wind up working for a city government, where they actually have power to change things (and slowly have their spirit crushed by bureaucracy).</p>
<p>I had many goals with A/B Street that are about sparking culture shifts:</p>
<ol>
<li>Pushing people towards sustainable car-free cities</li>
<li>Getting more ordinary citizens involved, in a productive way</li>
<li>Getting different parties -- government, citizen, advocacy group -- on the same level, communicating in a standard way</li>
<li>Promoting open data and open source software for use in government planning -- why trust the traffic analysis that you can't read and reproduce yourself?</li>
</ol>
<p>I don't feel I've budged the needle on any of these.</p>
<h2 id="whos-our-audience"><a class="header" href="#whos-our-audience">Who's our audience?</a></h2>
<p>I've tried to avoid actually advocating myself for specific changes in Seattle. Partly this is because there are well-established groups here that do this already, and I want to spend my energy doing what I enjoy more -- creating software to empower them. Partly I'm afraid of promoting ideas that're tied to my own biases and wouldn't serve everyone in Seattle well -- I have a conspicuous gap of knowledge about biking in South Seattle, a place with much more traffic violence and much less cycling-friendly infrastructure. And partly, I'm just lazy and avoiding writing -- I can do it, but it's so draining -- writing this document was quite difficult for me. As a team, we have published <a href="project/retrospective/../../proposals/broadmoor.html">one simple advocacy piece</a> -- written by Michael -- more to experiment with the format than to push for a real change (although the idea would be fantastic, asking to open up private roads is a non-starter).</p>
<p>I don't have a good understanding of politics or how to actually help advance real changes on the ground. But since we've failed to find users for A/B Street that're advancing some cause, then... there is one last thing we could try. Will I rip off such an adhesive bandage before it's too late?</p>
<h2 id="what-this-project-means-to-me"><a class="header" href="#what-this-project-means-to-me">What this project means to me</a></h2>
<p>I try to inject my humor into A/B Street wherever I can. When I skim through the <a href="https://github.com/a-b-street/abstreet/releases">release names</a>, I remember the story of my life that week, or something bizarre I cooked/ate/&quot;foraged&quot; -- ajitummy, twice-dumpstered anything, beef welldoneington, tostonical vows, the rise of Fridgehaus, rubducks in the laptub, taro bingsoothsayer, Hausbroken.</p>
<p>After weeks of sweating over what the 15-minute neighborhood tool is supposed to do and just one stout, I exploded out of my room and drunkenly pitched <a href="project/retrospective/../../software/santa.html">15 minute Santa</a> to my bewildered housemates. Then Michael and Yuwen and I made it (thank you for putting up with me).</p>
<p>A/B Street is my self-expression. Its origins are tangled in a mess of bittersweet memory (I wasn't the one who thought a game should be about traffic) and near-misses with trucks passing too closely on Boyer. I used it to pull out of a nose-dive of depression -- that's a story I'm still trying to write. I broke my fear and landed some of the largest jumps of my life (I do <a href="http://dcarlino.org/parkour">parkour</a>) as an escape from constantly thinking about A/B Street. I've worked on this project for the entirety of COVID. I've coded while taking the shinkansen from Tokyo to Miyazaki and the TGV from Paris to Berlin. I pushed code the morning of my ACL surgery, and reviewed a PR when I got home (and was remarkably lucid). It's safe to call me obsessed. I quit my job to do this. I've worked on it basically every weekday and weekend for 3 years, and thought about it constantly for at least 6 months before starting the project full-time. </p>
<p>A/B Street lets me take a bird's eye view of the messy world I move through, imagine it a bit differently, and try to convince others to see it the same way.</p>
<p>If anybody wants to convince me to do something else instead, now you know what you're up against. And if you succeed, you know how important your idea must be to me instead.</p>
<!-- A street and B Street... ->
<div style="break-before: page; page-break-before: always;"></div><h1 id="changelog"><a class="header" href="#changelog">CHANGELOG</a></h1>
<p>Every time I upload a new <a href="https://github.com/a-b-street/abstreet/releases">binary
release</a>, I'll list major
changes here.</p>
<p>0.1.0</p>
<ul>
<li>First binary release</li>
</ul>
<p>0.1.1</p>
<ul>
<li>drawing arrows better</li>
<li>start with a splash screen, make it easy to change maps in-game</li>
</ul>
<p>0.1.2</p>
<ul>
<li>totally revamp GUI by organizing everything into distinct gameplay modes</li>
</ul>
<p>0.1.3</p>
<ul>
<li>new warp tool that autocompletes street names</li>
<li>hideable menus, place context menus better, remove top menu bar, add a simple OSD</li>
<li>loading screens reflect what's printed to the terminal</li>
<li>depict pedestrians and bikes with more detail</li>
<li>tool to scroll through an agent's route</li>
<li>make simulation speed controls actually work</li>
</ul>
<p>0.1.4</p>
<ul>
<li>improve stop sign editor UI (toggle entire roads)</li>
<li>better mouseover / selection rendering</li>
<li>better traffic signal rendering (show time left, use outlines for yields)</li>
<li>make cars actually stop and briefly wait at stop signs</li>
<li>improve edit mode diff visualization (cross-hatching)</li>
<li>render actual stop signs, not just red lines</li>
<li>fix intersection policies confused by conflicting straight turns with lane-changing</li>
<li>fix mac scrolling</li>
<li>better turn indicators</li>
<li>nicer unzoomed view of roads, with different colors for big/small roads</li>
</ul>
<p>0.1.5</p>
<p>(release file size jumped from ~15MB to ~70MB because of new PSRC trips)</p>
<ul>
<li>improve UX of intersection editors</li>
<li>define a better set of maps included by default</li>
<li>improve drawing speed by batching more stuff</li>
<li>better default traffic signal policies for many cases</li>
<li>import and visualize census data</li>
<li>fix missing sidewalks on downtown one-ways</li>
<li>import and visualize PSRC trip data</li>
</ul>
<p>0.1.6</p>
<ul>
<li>slider widget for controlling time and speed</li>
<li>fixing bad polyline geometry in most cases; visualizing routes should no longer be buggy</li>
<li>handle PSRC trips that begin or end out-of-bounds</li>
<li>draw agents in unzoomed mode in a way simpler way</li>
<li>improve edit mode: detect reverts to original, easier lane type switching</li>
<li>lots of fixes for buses: handle edits better, read sequence of stops correctly from GTFS</li>
<li>set up A/B tests faster</li>
</ul>
<p>0.1.7</p>
<ul>
<li>bulk and revert tools in edit mode</li>
<li>improve turns and default intersection policies when bike/bus lanes involved</li>
<li>new tool to manually hint for short roads and weird intersections. some problems have now been manually fixed</li>
<li>scoreboard of trip results for sandbox and A/B test mode</li>
<li>reduce lag when sim is running at full speeds, but system is too slow</li>
<li>switch to easbar's contraction hierarchy crate, making all pathfinding INSANELY fast</li>
<li>remove weird rules about the world freezing when traffic signals are in &quot;overtime&quot;</li>
</ul>
<p>0.1.8</p>
<ul>
<li>edit mode: convert to a ped scramble cycle, simplify stop sign editor by removing individual turns</li>
<li>ui: put labels next to sliders, organize modal menus into sections, add a minimize/maximize icon</li>
<li>A/B test mode: savestate, include time controls and agent following/route tools here</li>
<li>use more OSM data for turn lanes, turn restrictions from lanes, turn restrictions between entire roads</li>
<li>dont attempt to cross a traffic signal if there's absolutely no hope</li>
<li>improve bus route UI tools and make routes using transit more sane</li>
<li>user-defined shortcuts for jumping between views of a map</li>
</ul>
<p>0.1.9</p>
<ul>
<li>sliders to pick times in wizards</li>
<li>fix hidpi scaling</li>
<li>traffic signal diagram scrolls properly</li>
<li>easier to instantiate a scenario, show all trips involving a building for a scenario</li>
<li>colorschemes to show trip duration or time blocked</li>
<li>label buses with route number</li>
<li>represent overlapping pedestrians as a labeled crowd</li>
<li>massive performance boost via real priority queue</li>
<li>prevent cars from &quot;blocking the box&quot;</li>
<li>prevent all? aborted trips (due to parking blackholes mostly)</li>
<li>smarter roam-around-for-parking router</li>
</ul>
<p>0.1.10</p>
<ul>
<li>sim
<ul>
<li>parking in off-street garages and on-street lanes on the off-side of oneways now mostly works</li>
<li>detect and handle parking blackholes; cars should never get stuck looking for parking now</li>
<li>let lower-priority turns happen at traffic signals when higher-priority ones blocked</li>
<li>get closer to FCFS ordering at stop signs</li>
<li>basic opportunistic lane-changing</li>
<li>a bus should be seeded for every route now</li>
</ul>
</li>
<li>demand data
<ul>
<li>show trips to/from buildings and borders</li>
<li>make PSRC trips seed and attempt to use parked cars</li>
</ul>
</li>
<li>UI
<ul>
<li>different heatmap overlays, like parking availability and busiest areas</li>
<li>show colorscheme legends when relevant</li>
<li>interactively seed parked cars, spawn more types of trips</li>
<li>fix major A/B test mode bug (mismatched scenarios and map edits)</li>
<li>adjusting sliders, menu placement, dynamic items</li>
<li>consolidating different tools into a single info panel for objects</li>
<li>bus route explorer shows entire route, current bus location</li>
</ul>
</li>
<li>map quality
<ul>
<li>degenerate intersections only have one crosswalk now</li>
<li>revamped the map editor for fixing geometry problems, used it in many places</li>
<li>nicer yellow center lines (dashed when appropriate)</li>
<li>handling OSM turn restriction relations properly</li>
<li>fix empty traffic signal phases</li>
<li>handling bike lanes on certain sides of the road</li>
<li>starting to upstream manually-verified parking lanes into OSM</li>
</ul>
</li>
<li>new gameplay: reverse direction of lanes</li>
</ul>
<p>0.1.11</p>
<ul>
<li>small UI fixes: fixed width traffic signal diagram, skip info phase of menus when empty</li>
<li>start drawing (but not using) shared left-turn lanes from OSM</li>
<li>fix OSM polylines with redundant points (fixing an issue in ballard)</li>
<li>improved traffic signal policies in some cases</li>
<li>started upstreaming some sidewalk tags in OSM to fix inference issues</li>
<li>fixed misclassified right turns</li>
<li>adjusting map colors</li>
<li>handling lakes/ocean polygons from OSM way better</li>
<li>reorganized sim analytics, added stuff for bus arrivals</li>
<li>adding new internal road points to map editor. almost ready to really aggressively use it</li>
<li>skipping parking lanes with no nearby sidewalks, since they're unusable</li>
<li>fix z-order of bridges/tunnels in unzoomed view</li>
<li>allow unzooming indefinitely</li>
<li>move lots of sandbox mode controls (and other modes) to menus under buttons and dedicated buttons</li>
<li>basic support for marking a lane closed for construction</li>
<li>improved geometry of sidewalks at dead-ends</li>
</ul>
<p>0.1.12</p>
<ul>
<li>reorganize everything as different challenge modes. start implementing 3: optimizing a bus route, speeding up all trips, or causing as much gridlock as possible</li>
<li>improved bus route explorer</li>
<li>some UI fixes (popup messages in a few places, moving mouse tooltips to the OSD)</li>
<li>lots of analytics and time-series plots</li>
</ul>
<p>0.1.13</p>
<ul>
<li>analytics: prebake baseline results properly. hover over plot series. some new modes to see bus network, throughput of a road/intersection over time</li>
<li>log scale for the speed slider</li>
<li>add a bulk spawner in freeform mode (F2 on a lane)</li>
<li>rendering: nicer routes, crosswalks, zoomed car colors</li>
<li>map data: better stop sign and sidewalk heuristics</li>
<li>fixed the mac hidpi text rendering issue once and for all?!</li>
</ul>
<p>0.1.14</p>
<ul>
<li>better crosswalk generation when there's only a sidewalk on one side of a road</li>
<li>edit mode UI revamp: paintbrush-style buttons to apply changes to lanes</li>
<li>show error messages and prevent edits, like disconnecting sidewalks</li>
<li>properly ban bikes from highways (revamped rules for vehicles using a lane)</li>
<li>new freeform mode tool to spawn bikes</li>
<li>WIP (not working yet): make bikes prefer bike lanes. some debug heatmaps for path cost</li>
<li>edit mode has proper undo support</li>
</ul>
<p>0.1.15</p>
<ul>
<li>minor bugfixes with reverting lane types, preserving stop signs</li>
<li>incorporate edits into the challenge splash screen, make sure edits are reset when appropriate</li>
<li>starting a new challenge mode, just focused on traffic signals</li>
<li>can't leave traffic signal editor with missing turns</li>
<li>render pedestrian crowds on building front paths</li>
<li>traffic signals support an offset parameter</li>
<li>traffic signal visualization and editing revamped to group related turns together</li>
<li>can preview traffic using a signal from the editor</li>
<li>actually apply priority at intersections, so protected turns get first dibs over yield turns</li>
</ul>
<p>0.1.16</p>
<ul>
<li>fix Mac crashing with texture limit bug by switching to texture arrays</li>
<li>fix crashing simulation when a border intersection was used</li>
<li>started to implement a new UI design for starting the game</li>
</ul>
<p>0.1.17</p>
<ul>
<li>more work on the pre-game UI, with some flexbox layouting</li>
<li>prototype a minimap in sandbox mode. doesn't pan or scroll yet.</li>
<li>prototype a new speed/time control panel from the mockup</li>
<li>nicer time warp loading screen</li>
<li>record and show detailed trip timeline, including time to park</li>
</ul>
<p>0.1.18</p>
<ul>
<li>map data: infer more building addresses</li>
<li>some analytics on how long people spend parking and intersection delay over time</li>
<li>create an options panel, allowing runtime customization of color scheme, traffic signal rendering, etc</li>
<li>internal changes to map building pipeline to make it much easier for new devs to onboard</li>
<li>organizing challenges into sub-stages, starting to flesh out specifics for the fix traffic signal track</li>
<li>much more realistic pedestrian pathfinding</li>
<li>fix minimap on mac (dpi issues)</li>
<li>visual tweaks to cars to make front/back easier to distinguish</li>
<li>internal change to switch most assets from PNG to SVG</li>
</ul>
<p>0.1.19</p>
<ul>
<li>some challenge modes show a histogram for counting faster/slower trips</li>
<li>new visualization of current demand per direction at a traffic signal</li>
<li>implementing some of Yuwen's UI changes: agent counter, split time/speed panel, moved functionality out of the old drop-down menus into a bottom-left tool panel, hiding debug functionality</li>
<li>replaced right-click context menus with left click to open info panels</li>
<li>fixed random issues reported by people from HN</li>
</ul>
<p>0.1.20</p>
<ul>
<li>moved some UI functionality around, pulling graphs into info panel</li>
<li>interactive legend for the minimap, toggle visibility of different agents</li>
<li>nicer colors and shapes for cars</li>
<li>misc simulation bugfixes that might help huge_seattle</li>
<li>pedestrians choose to use transit more realistically, factoring in time for the bus to drive</li>
</ul>
<p>0.1.21</p>
<ul>
<li>switch some analytics dashboards to use buttons, not old non-scrolling menus</li>
<li>scrollbars... at least a start</li>
<li>preview traffic signal changes from live sim as the base</li>
<li>traffic signal preview has normal time/speed controls</li>
<li>traffic signal editor has undo support</li>
<li>minimap has buttons to pan</li>
</ul>
<p>0.1.22</p>
<ul>
<li>minimap zoom controls</li>
<li>traffic signal rendering overhaul</li>
<li>heatmap colors improved, heatmap appears on minimap</li>
<li>bus info panel, a start to live delay analytics</li>
</ul>
<p>0.1.23</p>
<ul>
<li>UI revamps: speed panel, minimap controls, heatmap chooser</li>
<li>bus timeline</li>
<li>hide internal IDs normally</li>
<li>limit map zoom</li>
<li>fix bugs with crosswalks conflicting with vehicle turns</li>
</ul>
<p>0.1.24</p>
<ul>
<li>overhaul traffic signal editor UI, and add redo support</li>
<li>update main edit mode UI, and add redo support</li>
<li>limit max unzoom</li>
<li>fix the infamous HiDPI bug once and for all; minimaps should work everywhere</li>
<li>almost bug-free support for floating, horizontally and vertically scrolling panels</li>
<li>overhaul top-center panel, rename scenarios to be less confusing</li>
<li>expose bus analytics outside of challenge mode</li>
<li>live info panel can exist during a running simulation</li>
<li>consolidated agent route/trip information into info panel</li>
</ul>
<p>0.1.25</p>
<ul>
<li>overhauled the tutorial</li>
<li>tuned top-center panel for sandbox and challenge modes</li>
<li>make bike and bus lanes more obvious</li>
<li>show map edits as an overlay anywhere</li>
<li>tune info panel contents, and show relationships between parked cars and buildings</li>
<li>fixes to traffic signal editor, like making all-walk conversion idempotent</li>
<li>nicer throughput and delay plots (sliding windows, grid lines)</li>
</ul>
<p>0.1.26</p>
<ul>
<li>tutorial improved in a few places</li>
<li>map data: thinner sidewalks, associate buildings with named amenities</li>
<li>traffic model: vehicles can spawn on all lanes from a border</li>
<li>much better gameplay speed (previously was too fast)</li>
<li>UI tuning: lane editor, minimap, signal editor, heatmap legends don't overwrite minimap</li>
<li>traffic signal challenge communicates score more clearly</li>
</ul>
<p>0.1.27</p>
<ul>
<li>edit mode revamped: click to edit stuff. no more lane paintbrushes. autosaving and save as.</li>
<li>tutorial: can quit and resume tutorial now</li>
<li>challenge picking flow simplified</li>
<li>UI: layouting fixes to full-screen / into stuff, popup menus go beneath buttons, plots improved</li>
<li>internal change to render all text using vector graphics. other than a few text layouting issues, shouldn't be noticeable, except now tooltips in plots don't get covered up</li>
<li>misc perf improvements (cache SVGs, drawing many circles for unzoomed agents, dont reload prebaked data)</li>
<li>upgraded winit, glutin, glium -- hopefully no new bugs introduced on any platforms</li>
</ul>
<p>0.1.27a</p>
<ul>
<li>patch to fix a crash with empty text dimensions on things like building info panels</li>
</ul>
<p>0.1.28</p>
<ul>
<li>all info panels revamped</li>
<li>some tutorial stages are much more clear, with an updating goal</li>
<li>traffic signal scorecard generalized to work for some tutorial too</li>
<li>adjust how selected agents look</li>
<li>X button on popup menus</li>
</ul>
<p>0.1.29</p>
<ul>
<li>new tool to convert between stop signs and traffic signals</li>
<li>lane editor easier to edit multiple lanes</li>
<li>info panels: IDs, mostly avoid horizontal scrolling, better info about trips to/from somewhere, move buttons up</li>
<li>traffic signal editor UI overhaul</li>
<li>different data in top-right agent meters panel</li>
<li>tooltips to communicate keybindings better</li>
<li>new jump-to-time panel, showing when rush hours occur</li>
<li>speed controls use more useful speeds</li>
<li>include ongoing trips in measured trip times</li>
<li>jump to next challenge after completing one</li>
<li>lots of tutorial tweaks</li>
</ul>
<p>0.1.30</p>
<ul>
<li>show additional info about traffic patterns and buggy maps</li>
<li>revamp tutorial UI to group tasks and messages better</li>
<li>handle different mode transitions when info panel open on an agent</li>
<li>select entire roads in unzoomed edit mode</li>
<li>show total time an agent has spent moving / blocked</li>
<li>use 2-phase traffic signals by default, making the 23rd map successfully complete!</li>
<li>jump-to-time now optionally points out traffic jams forming</li>
<li>challenge splash screen improved</li>
</ul>
<p>0.1.31</p>
<ul>
<li>overhauled trip timeline in agent info panels</li>
<li>overhauled traffic signal details panel and the per-lane turn explorer</li>
<li>settings page: show all options at once. add way to scale up text/UI elements for high-DPI displays, and an alternate pan/zoom control scheme</li>
<li>traffic signal edits can now be exported and used in any slice of Seattle. will be using this to hand-map many of them.</li>
<li>many small tutorial fixes</li>
</ul>
<p>0.1.32</p>
<ul>
<li>some UI work on giving focus to textboxes, improving dropdown menus</li>
<li>road/intersection plots display baseline sim data too</li>
<li>start associating people with multiple trips, exposing this a little in the UI</li>
<li>bring back elevation data, introduce a new overlay. the elevation data is still really bad.</li>
</ul>
<p>0.1.33</p>
<ul>
<li>new &quot;population&quot; overlay, showing people (not just current trips). heatmap and dot map to visualize.</li>
<li>improved the &quot;delay&quot; overlay to handle roads and intersections</li>
<li>removed the confusing and useless alternate color schemes for agents</li>
<li>initial left-hand driving side, tested in Perth, also drawing more arrows for all one-way roads</li>
<li>loads of internal GUI code refactorings, preparing for a standalone release of the library</li>
<li>fixed z-buffering and alpha values for web backend</li>
</ul>
<p>0.1.34</p>
<ul>
<li>info panels have been totally overhauled again. multiple tabs, way more clear representation of agents, trips, and people.</li>
<li>draw people inside of a building</li>
<li>applied consistent typography everywhere</li>
<li>lots of internal refactoring</li>
</ul>
<p>0.1.35</p>
<ul>
<li>more info panel work, particularly for trips and buses. change plot settings live.</li>
<li>prototype of a SEIR pandemic model based on time spent in shared spaces, by orestis</li>
<li>slight heatmap improvements, more coming</li>
<li>more typography changes</li>
<li>mouse cursor now changes for buttons and dragging!</li>
<li>overhaul minimap controls, make layers behavior zoomed in a little better</li>
<li>new speed panel and jump-to-time modal</li>
</ul>
<p>0.1.36</p>
<ul>
<li>overhauled simulation data page, with a table to find slow trips and some initial summary visualizations</li>
<li>plots can change windowing and show/hide series</li>
<li>layers: fade map to contrast more, better scales/legends</li>
<li>show relative trip times in info panels</li>
<li>tools to rewind/ffw to watch particular trips</li>
<li>refocusing efforts on challenge modes; level 1 of a new one is pretty much ready</li>
<li>some simulation fixes around parking and a corner case of cars temporarily forming a cycle</li>
<li>orestis improved the population/pandemic heatmaps</li>
</ul>
<p>0.1.37</p>
<ul>
<li>optimize commute challenge: high score, live sentiment, second stage</li>
<li>parked cars are owned by people, not buildings</li>
<li>info panel improvements for trips</li>
<li>bike layer suggests places where bike lanes could be helpful</li>
<li>many improvements to scatter plot</li>
<li>a new histogram-ish thing for understanding faster/slower trips</li>
<li>handling scenarios longer than 24 hours better (for pandemic model)</li>
<li>prototype of commute visualization, grouping buildings by blocks</li>
<li>sim bugfixes: crosswalk / vehicle turn conflicts, start bikes in bike lanes from borders</li>
</ul>
<p>0.1.38</p>
<ul>
<li>major internal changes to ensure people's schedules don't have impossible gaps, to associate fixed bikes/cars to a eprson, handle delayed starts to trips</li>
<li>parking changes: show path to closest free spot, utilization of a lane over time, every building includes at least 1 offstreet spot by default</li>
<li>progress on removing unrealistic gridlock: detect turn conflict cycles and temporarily allow conflicts, trim last steps of a laggy head</li>
<li>internal sim alert system. speeds up debugging, could be used for player-facing &quot;traffic jam!&quot; alerts</li>
</ul>
<p>0.1.39</p>
<ul>
<li>switched to proper OSM-based maps; no more brittle, manual geometry fixes</li>
<li>more sorting and filtering options in trip table and parking overhead tables</li>
<li>improve offstreet parking rendering. park closer to destination buildings</li>
<li>easier process for importing new cities. introducing Los Angeles, Austin, Barranquilla.</li>
<li>new data updater tool so people can opt-in to new cities</li>
<li>many internal fixes to prevent gridlock. smarter cycle detection, manual OSM fixes and traffic signal timings</li>
</ul>
<p>0.1.40</p>
<ul>
<li>differential throughput layer to understand routing diversions</li>
<li>map edits now reference longer-lasting OSM IDs, can work cross-map</li>
<li>basemap updates: new areas for west seattle, mt baker, lots of upstreamed fixes in OSM and traffic signals, smarter border matching</li>
<li>parking: optionally filter on/off-street spots in the layer, allow disconnecting spots via edits</li>
<li>render some tunnels with lower opacity</li>
<li>new feature to change speed limits and bulk road selection tools</li>
<li>first write-up of a real use case (closing lake wash through arboretum)</li>
<li>make the traffic signal challenge act like a game, with a failure/win state and scoring</li>
</ul>
<p>0.1.40a</p>
<ul>
<li>added a mode to map parking</li>
</ul>
<p>0.1.41</p>
<ul>
<li>new parking mapper tool</li>
<li>include a one-shot .osm importer in the release</li>
<li>new layer to find different types of amenities / businesses</li>
<li>adjust traffic signal rendering style</li>
<li>bulk lane editor for changing speed limits and lane types</li>
<li>including west seattle and udistrict maps</li>
<li>include some OSM buildings that were being skipped</li>
<li>dont pause after opening something from sandbox mode</li>
<li>adjust turn signals for lane-changing cars</li>
<li>lots of fixes for monitors with different DPIs, enabled by default</li>
</ul>
<p>0.1.42</p>
<ul>
<li>many misc UI bugfixes, especially for high-DPI screens</li>
<li>managing turns across multiple nearby intersections: tool to visualize, handling multi-way OSM turn restrictions, using this to ban illegal movements at the pathfinding layer, starting a traffic signal editor variant to edit these</li>
<li>rendering improvements: unzoomed agent size, visualizing routes on trip table, transparent roads beneath bridges, draw harbor island</li>
<li>overhauled street/address finder</li>
<li>parking mapper: shortcut to open bing</li>
</ul>
<p>0.1.43</p>
<ul>
<li>new map picker!</li>
<li>UI polish: traffic signal editor, layers, bus stops, delay plots</li>
<li>generate more interesting biographies for people</li>
<li>tuned all the map boundaries</li>
<li>fleshing out lots of docs in preparation for the alpha release...</li>
</ul>
<p>0.1.44</p>
<ul>
<li>spawner UI revamped</li>
<li>model parking lots! and finally model public/private parking</li>
<li>fix up tutorial</li>
<li>starting a story map mode</li>
</ul>
<p>0.1.45</p>
<ul>
<li>overhauled challenge cutscenes and hints</li>
<li>traffic signal challenge: fix score detection, add meter, much faster startup, no reset-to-midnight required</li>
<li>layers: use gradient for a few, delay comparison, new UI for picker</li>
<li>overhauled minimap controls, should be intuitive now</li>
<li>edit mode changelist UI started</li>
</ul>
<p>0.2.0 (alpha launch)</p>
<ul>
<li>road names now shown by default, in a new style</li>
<li>all layers now use gradients and show up zoomed in. worst traffic jam layer revamped.</li>
<li>scatter and line plot improvements</li>
<li>internal UI fixes: proper word wrap</li>
<li>bugfixes for following people riding the bus</li>
<li>rainbow crosswalks in one neighborhood</li>
<li>final polishing for launch</li>
</ul>
<p>0.2.1</p>
<ul>
<li>busy week due to launch, but many new features in the pipeline</li>
<li>many bug fixes</li>
<li>edit mode: proper autosave, load proposals, jump between lane/intersection editors</li>
<li>very first steps on light rail... importing the tracks</li>
<li>starting a new traffic scenario modifier system, to repeat entire scenario or outright cancel trips for some people. many more ideas for filters and actions coming soon.</li>
<li>starting to represent private roads</li>
<li>add a very simple actuated traffic signal</li>
</ul>
<p>0.2.2</p>
<ul>
<li>the default traffic signal configuration is much smarter now, handling roads with some sidewalks missing and automatically synchronizing pairs of adjacent lights</li>
<li>much faster startup time for large maps</li>
<li>better UX for handling unsaved edits</li>
<li>access-restricted zones: changing existing zones almost completely works, except for granting new access to pedestrians</li>
<li>new sidewalk corner rendering, more rounded</li>
<li>ui style standardized for margins, padding</li>
<li>Javed got camera panning when your cursor is at the edge of the screen to work; enable it in settings</li>
<li>pulling bus stop/route info from OSM, not GTFS. steps towards light rail.</li>
<li>experimenting with controls for hiding bridges to see roads underneath; try them in dev mode (ctrl+S)</li>
<li>many bug fixes</li>
</ul>
<p>0.2.3</p>
<ul>
<li>lane geometry is dramatically fixed, especially for one-ways</li>
<li>importing lanes from OSM improved</li>
<li>UI: bulk select includes select-along-a-route, show all bus routes in the layer, unzoomed zordering for roads/intersections</li>
<li>traffic scenario modifier can now convert trip modes</li>
<li>slight progress on light rail, although the train only makes one stop</li>
<li>vehicles moving through complex intersections with multiple traffic signals will now make it through multiple lights, even if they're unsynchronized</li>
<li>new random traffic scenario generator that makes people go between houses and workplaces</li>
<li>access-restricted zones: granular editing of individual roads now mostly works</li>
<li>removing the hardcoded relative directories, which many people have been having problems with</li>
<li>many many bug fixes, and some optimizations to reduce release file size</li>
</ul>
<p>0.2.4</p>
<ul>
<li>bus/train routes overhauled; they're now one-way, regularly spawn every hour, and may begin or end at a border</li>
<li>new commute pattern explorer tool</li>
<li>new character art to give cutscenes a bit more personaliy</li>
<li>some progress on gridlocking maps, both from manual fixes and an attempt to reduce conflicts in multi-turn sequences</li>
<li>misc UI: show cars seeking parking in unzoomed mode, plot arrival rate at border intersections, consolidate bulk selection controls</li>
<li>trips modified by an experiment can now be filtered in summaries</li>
<li>buses, trains, and passengers on them are now properly distinguished in different stats</li>
<li>include krakow and berlin in release</li>
<li>buildings with holes in the middle are now rendered properly</li>
</ul>
<p>0.2.5</p>
<ul>
<li>cars pick lanes better</li>
<li>overhaul bus/stop/route info panels</li>
<li>UI: better autocomplete, commuter pattern improvements by Michael, toggles instead of checkboxes, contours for heatmaps, edit mode loader revamp</li>
<li>internal refactors: turn creation, osm tags, osm parsing</li>
<li>import living streets from OSM as restricted-access zones, and other importer tweaks for berlin, krakow, san jose, sydney</li>
</ul>
<p>0.2.6</p>
<ul>
<li>many roads without sidewalks now have a tiny shoulder lane, still enabling pedestrian movement, but with a penalty</li>
<li>bike trips will stop/start at a better position along the sidewalk now</li>
<li>support parking lanes on the off-side of a one-way</li>
<li>UI: search by building names, commuter patterns shows borders better</li>
<li>transit: make people ride off-map, spawn buses on short roads</li>
<li>internal cleanups for buttons</li>
</ul>
<p>0.2.7</p>
<ul>
<li>many intersections with on/off ramps have much better geometry</li>
<li>lane-changing banned on turn lanes</li>
<li>lots more work matching bus stops/routes to the map. some progress, also some regressions.</li>
<li>fixing spawning on tiny borders</li>
<li>bus spawn rates from GTFS for seattle. started an editor for the schedule.</li>
<li>internal ezgui refactorings</li>
</ul>
<p>0.2.8</p>
<ul>
<li>multiple traffic signals can now be synchronized and edited together</li>
<li>new dashboard for &quot;traffic signal demand&quot; over the entire day and map</li>
<li>started experimenting with controlling the headless runner via a JSON API</li>
<li>epic ezgui fix by Michael to consolidate handling of HiDPI scaling</li>
<li>got a bunch of huge cities importing and loading quickly</li>
<li>you can now save the trips you manually spawn in freeform mode, then replay them later</li>
</ul>
<p>0.2.9</p>
<ul>
<li>import Xi'an, add a Chinese font, and add a tool for that group to import their external demand data</li>
<li>control A/B Street through a graphics-less API, with a Python example</li>
<li>improve UI for per-direction traffic signal demand</li>
<li>on/off ramp geometry fixed in a few more cases</li>
<li>fix some missing parking lot aisles, handle parking lots with 0 spots, and extract parking garages from OSM</li>
<li>switch road/building language in settings, if OSM data exists</li>
<li>congestion capping prototype: declare a max number of vehicles that can pass through a zone per hour, view/edit it, and very simple implementation in the sim layer</li>
<li>add custom-drawn trips to the main scenario, for exploring new demand from a new building</li>
<li>mkirk fixed up the glow/wasm ezgui backends, letting us remove glium</li>
<li>make map edit JSON backwards compatible</li>
<li>better lane/turn markings</li>
</ul>
<p>0.2.10</p>
<ul>
<li>two-way cycletracks and arbitrary direction changes for roads</li>
<li>fix map editing for lane reversals, make edits backwards compatible, and massively speed up applying edits</li>
<li>fleshing out the headless API and tooling for controlling the simulation from any language</li>
<li>import a few more places, redo left-hand driving support so far</li>
<li>various bug/performance fixes</li>
</ul>
<p>0.2.11</p>
<ul>
<li>disabled support for editing the map without resetting the simulation. needs more work, but solid start.</li>
<li>improvements to API, activity model, congestion capping</li>
<li>small UI tweaks for parking, editing multiple signals</li>
<li>fixed last bugs for left-handed driving, should work just as well now</li>
<li>lots of graphics experiments from the hackathon, not merged yet</li>
</ul>
<p>0.2.12</p>
<ul>
<li>new textured color scheme and isometric buildings, in settings</li>
<li>new layer to show how far away people parked</li>
<li>Massive UI overhauls: jump to time/delay, edit mode, traffic signal editor (now with offsets), lane editor, bulk lane edit, traffic signal demand (individual intersections and all), loading screen</li>
<li>the Go API example compares trip times and detects gridlock</li>
<li>infinite parking mode</li>
<li>show how long a car has been parked in one spot</li>
<li>bugfix for some pathfinding costs around uber-turns</li>
<li>start to show a trip's purpose</li>
</ul>
<p>0.2.13</p>
<ul>
<li>alleyways from OSM imported</li>
<li>traffic signal minimum time now constrained by crosswalks; thanks Sam!</li>
<li>UI changes in progress for trip tables, summaries, bulk edit</li>
<li>more API / Python example work for congestion capping</li>
<li>bug fixes: isometric buildings, documentation links, dropdown widgets, turn restrictions</li>
</ul>
<p>0.2.14</p>
<ul>
<li>improve turn generation, with goldenfile tests</li>
<li>UI adjustments: unzoomed routes, better delay layer, include reasons for cancelled trips, throughput layer counts</li>
<li>small map importing fixes: multipolygon parking lots</li>
<li>fix infinite parking and blackholed buildings</li>
</ul>
<p>0.2.15</p>
<ul>
<li>large internal change allowing asynchronously loading extra files over HTTP for web</li>
<li>the release of the first web version!</li>
<li>cars looking for parking now have a &quot;thought bubble&quot; showing this, by Michael</li>
<li>slow sections of a trip are now shown in the info panel, by Sam</li>
<li>fix by Michael for handling window resizing in panels</li>
<li>fix original routes on edited maps</li>
<li>internal code organization and documentation</li>
</ul>
<p>0.2.16</p>
<ul>
<li>UI: click unzoomed agents, switch between metric/imperial units, show reason for cancelled trips, new &quot;faded zoom&quot; color scheme based on mapbox, more detailed agent counts in the top-right panel's tooltips</li>
<li>started a new dedicated OpenStreetMap viewer, will split out from A/B Street later</li>
<li>fix alpha colors on web</li>
<li>bugfixes for the new asynchronous map loading</li>
<li>some substantial simulation performance gains (168s to 90s on one benchmark!)</li>
<li>lots of progress towards editing the map without resetting the simulation to midnight. please test with --live_map_edits and report any issues</li>
<li>internal refactoring and code documentation</li>
</ul>
<p>0.2.17</p>
<ul>
<li>tooling to automatically extract different shapes around cities without an explicit bounding polygon</li>
<li>imported many maps for an OSM viewer demo</li>
<li>misc bug fixes, UI tweaks, and perf improvements, especially for the web version</li>
<li>start using OSM sidewalks data properly in krakow -- more work needed, but better start</li>
</ul>
<p>0.2.18</p>
<ul>
<li>overhaul data/system management: switch from Dropbox to S3, reorganize files, add an in-game updater</li>
<li>started a UI for collision dataviz, with data in the UK and Seattle</li>
<li>improve turns between separate footways</li>
<li>simplify the process of importing a new city</li>
</ul>
<p>0.2.19</p>
<ul>
<li>added experimental day/night support; run with --day_night</li>
<li>slight performance improvements by avoiding applying no-op edits</li>
<li>new tests for lane-changing behavior, used to more safely allow more realistic behavior blocking &quot;degenerate&quot; intersections</li>
<li>experimenting with filling in gaps between one-way roads, to represent medians</li>
</ul>
<p>0.2.20</p>
<ul>
<li>prototyped a new 15-minute neighborhood tool</li>
<li>overhaul internal simulation input code -- better performance, way simpler</li>
<li>debug tool to record traffic around a few intersections and replay later</li>
</ul>
<p>0.2.21</p>
<ul>
<li>split separate tools into their own executables</li>
<li>misc bug fixes and other refactoring, focused on GUI code mostly</li>
<li>most of a prototype done for an experiment</li>
<li>map added for north seattle</li>
</ul>
<p>0.2.22</p>
<ul>
<li>vehicles will lane-change less erratically during uber-turns (sequences of turns through multiple traffic signals close together)</li>
<li>debug mode has a &quot;blocked-by graph&quot; tool to understand dependencies between waiting agents</li>
<li>try multiple OpenGL video mode options if the first choice fails (thanks Michael!)</li>
<li>refactoring trip starting code and the minimap</li>
<li>non-Latin fonts now supported on web too, thanks to rustybuzz release</li>
<li>new small maps in Seattle included in the release, and NYC added to optional cities</li>
<li>saving some player state on the web (mostly camera position per map, for the main game)</li>
<li>partial prototype of a new census-based scenario generator, thanks to help from the Amazon SSPA hackathon</li>
<li>significant progress on the experiment, about one week left...</li>
</ul>
<p>0.2.23</p>
<ul>
<li>released the 15-minute Santa experiment!</li>
<li>trip info panels now show more continuous progress along a route</li>
<li>fixing inactive buttons stretching too much</li>
</ul>
<p>0.2.24</p>
<ul>
<li>variable traffic signal timing, thanks to Bruce</li>
<li>15 min explorer: more walking options (require shoulders, change speed), more organized business search</li>
<li>15 min santa: remember upzoning choices</li>
<li>misc bugfixes and refactoring</li>
<li>2021 roadmap drafted</li>
</ul>
<p>0.2.25</p>
<ul>
<li>huge breakthrough on merging intersections to handle short roads. applied to just a few places so far</li>
<li>support one-way roads with default traffic signal heuristics</li>
<li>15 min explorer: find residences close to user-specified businesses, see unwalkable roads</li>
<li>bugfix from Bruce to prevent sim from crashing when a short road is over capacity</li>
<li>automatically fetch census data for any US map and use for scenario generation, from Michael</li>
<li>some initial experiments to bring A/B Street's lane rendering to the web using Leaflet</li>
</ul>
<p>0.2.26</p>
<ul>
<li>dramatically improve initial web loading and be able to start with any map</li>
<li>city picker UI now better organizes other regions with many maps</li>
<li>new tool to convert SUMO networks into A/B Street maps</li>
<li>taking screenshots of the entire map now much faster, portable. trying to use for Leaflet raster tiles, but not working yet.</li>
<li>widgetry UI library now doesn't depend on anything specific to A/B Street</li>
<li>internal refactoring for error handling</li>
</ul>
<p>0.2.27</p>
<ul>
<li>dramatically speed up starting scenarios by deferring when public transit riders pick their route</li>
<li>start importing separate cyclepaths and pedestrian plazas for Cambridge, many adjustments to make these start working</li>
<li>full panel for picking a scenario to start</li>
<li>import trip data from the actdev project for Cambridge</li>
<li>improve inferred map elements (stop signs and crosswalks) near short roads</li>
<li>heuristics for automatically finding and merging short roads. disabled, but solid start</li>
</ul>
<p>0.2.28</p>
<ul>
<li>massive button overhaul by Yuwen and Michael</li>
<li>the color scheme automatically switches between day/night based on simulation time!</li>
<li>significant progress on editing the map without resetting the simulation</li>
<li>various bugfixes, new maps, improvements to running the importer, faster updater</li>
</ul>
<p>0.2.29</p>
<ul>
<li>new map, Rainier Valley, is the 3rd ever to finish without gridlock! One of the fixes was collapsing traffic circles into a normal intersecton</li>
<li>bugfixes for map importing: cycleways with left-handed driving, matching traffic signals, odd number of lanes, u-turns</li>
<li>further fixes after the great button refactor</li>
</ul>
<p>0.2.30</p>
<ul>
<li>split documentation into a separate git repo</li>
<li>UI: filter throughput layer by mode, render stop signs better</li>
<li>started a debug tool to live-tune routing parameters and see the effects on a single route or all trips</li>
<li>Michael improved the web loading screen and added webgl1 support for ios browsers</li>
<li>cars looking for parking now randomize a bit, eliminating the unrealistic &quot;parking snakes/parades&quot; effect</li>
<li>Bruce fixed a critical bug with uber-turns, helping ease gridlock in some maps</li>
<li>new tool to procedurally generate houses along empty residential roads, useful when OSM is missing most data</li>
</ul>
<p>0.2.31</p>
<ul>
<li>loads of work integrating abstreet with the actdev project, and importing tons of maps</li>
<li>new tool to find the geofabrik OSM source best fitting a boundary</li>
<li>fix crosswalks and traffic signal policies in left-handed driving countries</li>
<li>fix initial zoom when starting with flags to copy the viewport from OSM</li>
<li>Bruce added lagging green signal heuristics</li>
<li>make it easier to click tiny bikes and pedestrians</li>
<li>change the URL in the web version as you change maps/scenarios</li>
<li>split the list of cities by country, and improved the UI for picking a place</li>
</ul>
<p>0.2.32</p>
<ul>
<li>easier to share web URLs with the current viewport</li>
<li>more actdev integration work</li>
<li>misc bugfixes, especially with uber-turns and the city picker UI</li>
<li>revived the map_editor tool for drawing small test maps and iterating faster on merging intersection geometry</li>
</ul>
<p>0.2.33</p>
<ul>
<li>import service roads and separate cyclepaths in all maps!</li>
<li>brand new day theme, designed by Yuwen and implemented by Michael!</li>
<li>improved rendering where sidewalks and shoulders of roads meet</li>
<li>fix overlapping panels on HiDPI screens with low resolution</li>
<li>prototype of loading abst in the background on a webpage</li>
<li>adjusted routing, penalizing unprotected left turns onto bigger roads, which often contribute to gridlock</li>
<li>fixed some turn restrictions at merged intersections</li>
<li>widgetry: change fonts mid-line, dynamically load extra fonts (for a Taipei map)</li>
</ul>
<p>0.2.34</p>
<ul>
<li>new travel demand generator using UK origin/destination data</li>
<li>the 15m and OSM viewer web apps also have nicer URLs now</li>
<li>2 more seattle maps complete without gridlock!</li>
<li>less seattle maps bundled with the release by default, to keep file size sane</li>
<li>many UI changes for the actdev integration, pending rollout to abst generally</li>
<li>initial experiments with implementing lane over-taking and road-based pathfinding</li>
</ul>
<p>0.2.35</p>
<ul>
<li>vast improvements to roundabouts, gridlock, and ordering at stop signs</li>
<li>consolidated UI panels in simulation modes; should work much better for smaller screens</li>
<li>measure intersection delay more intuitively</li>
<li>use straight lines for right/left turns at small intersections</li>
<li>various bugfixes and small UI improvements</li>
<li>started a tool to import from OSM without the command line; should be ready next week</li>
</ul>
<p>0.2.36</p>
<ul>
<li>released a new tool to import anywhere from OSM from within the game!</li>
<li>UI: finished trips meter, consolidated agent counters on minimap, move layers to the left for small screens, new tab style, use new day colorscheme in other apps</li>
<li>fixed a bug with comparing the route somebody took before/after changes</li>
<li>start integrating Eldan's elevation data and reviving parts of the UI that use the data</li>
<li>better routing into/out of access-restricted neighborhoods</li>
</ul>
<p>0.2.37</p>
<ul>
<li>import elevation data for Seattle!</li>
<li>add layers showing steep streets, elevation contours, and show elevation profile for bike/pedestrian routes</li>
<li>faster, simpler pathfinding for access-restricted zones</li>
<li>faster map importer and some UI fixes</li>
</ul>
<p>0.2.38</p>
<ul>
<li>change walking and biking speed based on elevation</li>
<li>import elevation data for all maps -- though there may still be quality issues</li>
<li>filter trip table by start/end location on the map</li>
<li>Michael made the web deployment much more flexible, in preparation for a blog post</li>
</ul>
<p>0.2.39</p>
<ul>
<li>massive internal change to make pathfinding use roads, not lanes. paves the way for many exciting things, like...</li>
<li>changing the number and width of lanes per road! WIP, debug mode-only UI for now</li>
</ul>
<p>0.2.40</p>
<ul>
<li>fix bugs running the importer</li>
<li>import grid2demand scenarios from the UI</li>
<li>implement more of road widening internals</li>
<li>new --minimal_controls option by Michael for screencasts</li>
<li>ran the first UX study in a long time, lots of feedback on the tutorial and traffic signal editor</li>
</ul>
<p>0.2.41</p>
<ul>
<li>first prototype of the new road editor!</li>
<li>much easier way to download new cities -- just try to open a map you don't yet have. much smaller .zip release now</li>
<li>track two &quot;risk exposure&quot; events -- when cars want to overtake cyclists, and passing through a large intersection -- and start to show data on trip panels, a new &quot;problem map&quot; layer, and a WIP summary dashboard</li>
<li>better geometry for some merged intersections, and applying the algorithm all around Tempe</li>
<li>another UX study and some tutorial UX fixes</li>
</ul>
<p>0.2.42</p>
<ul>
<li>improvements to experimental road editor</li>
<li>2 more UX studies and a slew of small fixes</li>
</ul>
<p>0.2.43</p>
<ul>
<li>starting to import GMNS traffic signal timing. this will eventully let us import from Synchro!</li>
<li>more work on the new road editor, but still not ready. lane widths are now more varied and realistic.</li>
<li>Trevor overhauled the OSM amenity categories and added a multi-source isochrone to the 15m tool to find places without access to some amenity</li>
<li>partial work running the map importer in a Docker container, to eventually speed up the import process in the cloud</li>
<li>signal editor UI adjustments</li>
<li>time warp UI fixes and a new risk exposure contingency matrix by Michael</li>
<li>internal code cleanup using clippy, by Vinzent</li>
</ul>
<p>0.2.44</p>
<ul>
<li>experimental road editor finally released! more improvements still planned</li>
<li>save/restore settings (like camera angle and units) between sessions</li>
<li>Michael improved performance of scrolling panels</li>
<li>Michael adding more dataviz to travel time and risk exposure dashboards</li>
<li>regenerating all maps now happens on the cloud -- faster and less harmful to my poor laptop</li>
<li>exploring some debug tools and strategies for consolidating intersections</li>
</ul>
<p>0.2.45</p>
<ul>
<li>map importing fixes: multiple left/right turn lanes, combo bus/turn lanes, tidy up degenerate intersections along cyclepaths, allow explicitly tagged U-turns, better stop sign placement heuristics</li>
<li>in Seattle, snap trips entering/leaving map through borders more carefully</li>
<li>prebake data to cover trips starting near midnight. down from about 3000 cancelled trips in montlake to 300</li>
<li>road editor UI: explain disabled actions</li>
<li>Michael added new &quot;arterial crossing&quot; risk for pedestrians</li>
<li>improved GMNS signal timing importer</li>
</ul>
<p>0.2.46</p>
<ul>
<li>lots of internal writing, presentations... not quite ready for an audience yet</li>
<li>fixed weird turn lane arrows</li>
<li>GMNS signal import now works for many intersections, thanks to crosswalk inference</li>
<li>road editor UI fixes</li>
<li>speed up starting a simulation with infinite parking</li>
<li>possible breakthrough with intersection consolidation</li>
</ul>
<p>0.2.47</p>
<ul>
<li>simulation speedup by storing turns better</li>
<li>new website/docs maybe halfway done</li>
<li>sped up rust build process</li>
<li>improved some geometry around Tempe</li>
<li>fix broken screenshot diff test</li>
<li>trevor added the &quot;cloud of uncertainty&quot; in the 15m tool to show borders</li>
</ul>
<p>0.2.48</p>
<ul>
<li>vehicles will now dynamically change lanes to pass slower traffic! in limited cases only.</li>
<li>vehicles can now exit a building's driveway and immediately cut across a few lanes</li>
<li>new UI tool to easily find when trips start</li>
<li>fix some crashes related to widening roads</li>
</ul>
<p>0.2.49</p>
<ul>
<li>vehicles can exit driveways in either direction!</li>
<li>bugfixes with lane-changing, time-warping, settings, nondeterministic z-ordering, changing speed limits</li>
<li>speed up edit mode on large maps</li>
<li>loading maps on native now sees locally imported maps</li>
<li>smaller files across the board by serializing f64s as integers</li>
<li>map data quality: greenlake cycletrack, better stop sign placement, crosswalks at consolidated intersections</li>
<li>risk exposure matrix labels</li>
<li>keep cars out of bus lanes with better costing</li>
</ul>
<p>0.2.50</p>
<ul>
<li>UI: improve elevation profiles, add road editor revert button, thought bubbles for people climbing steep inclines</li>
<li>fixed signal timing for 3-ways</li>
<li>fixed a race condition with two vehicles going for the same offstreet parking</li>
<li>fixing pedestrian speeds on inclines</li>
<li>improved relative positons of adjacent lanes on curvy roads</li>
<li>internal speedups for map importing and a tool to compare two maps, for intersection consolidation</li>
<li>let lane-changing happen in more cases (when vehicle1 wants to pass vehicle2, but can't until a few lanes later)</li>
<li>add a mode to import a region-wide map without local roads</li>
<li>internal pathfinding refactor to switch between contraction hierarchies &amp; Dijkstra more flexibly, reduce duplicate higher-level input graph logic</li>
</ul>
<p>0.2.51</p>
<ul>
<li>special mid-week release to support a blog post</li>
<li>using infinite parking for the arboretum scenario</li>
<li>add y axis to trip time dashboard</li>
<li>faster OSM import using overpass</li>
<li>internal tools for working on intersection consolidation and cyclepath snapping</li>
</ul>
<p>0.2.52</p>
<ul>
<li>started a mode shift dashboard</li>
<li>individual trips can be explored from the risk exposure dashboards now</li>
<li>fixed actdev scenarios</li>
<li>web file loaders now show progress</li>
<li>performance improvements for editing roads</li>
<li>various bug fixes</li>
</ul>
<p>0.2.53</p>
<ul>
<li>new intersection consolidation algorithm, applied around Seattle and Tempe with really great results!</li>
<li>Seattle fixes: deduplicating cycletracks, connecting Arboretum bike paths</li>
<li>add new lane types to express buffers for protected bike lanes</li>
<li>better neighborhood shapes by Michael, in the commuter patterns layer</li>
<li>fixed Overpass imports, which were missing border intersections</li>
</ul>
<p>0.2.54</p>
<ul>
<li>brand new day mode color scheme!</li>
<li>road editor automatically adjusts lane width, and other small UI fixes</li>
<li>show bike network gaps in the mode shift dashboard</li>
<li>progress on snapping cyclepaths, representing buffers, fixing up nearby geometry</li>
<li>fixed crosswalks for consolidated intersections on left-handed maps</li>
</ul>
<p>0.2.55</p>
<ul>
<li>more progress on cycleway snapping, but still not ready</li>
<li>road editor sets new lane width better</li>
<li>load proposals picks a better order</li>
<li>a new experiment unfolding...</li>
</ul>
<p>0.2.56</p>
<ul>
<li>releasing a new tool dedicated to planning bike networks!</li>
<li>massive overhaul to the road editor, including lane cards that can be both dragged AND dropped</li>
<li>new road labeling in unzoomed mode</li>
<li>new tool to quickly sketch roads to edit</li>
<li>new tool to plan routes and see elevation/road types along the way</li>
<li>load previously saved proposals on web</li>
<li>disabled prototype: uploading proposals to a central server for easier sharing</li>
</ul>
<p>0.2.57</p>
<ul>
<li>bike network tool UI fixes, especially for the routing tool</li>
<li>use drag and drop for traffic signal editor and route waypoints</li>
<li>small internal map model performance boost</li>
<li>heavy documentation week</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="references"><a class="header" href="#references">References</a></h1>
<h2 id="example-use-cases"><a class="header" href="#example-use-cases">Example use cases</a></h2>
<ul>
<li><a href="https://www.reddit.com/r/SeattleWA/comments/9mtgkh/seven_places_to_add_bus_lanes_now/">https://www.reddit.com/r/SeattleWA/comments/9mtgkh/seven_places_to_add_bus_lanes_now/</a></li>
<li><a href="https://www.reddit.com/r/SeattleWA/comments/9oqkz9/how_traffic_patterns_will_change_after_seattles/">https://www.reddit.com/r/SeattleWA/comments/9oqkz9/how_traffic_patterns_will_change_after_seattles/</a></li>
<li><a href="https://www.reddit.com/r/Seattle/comments/9orqne/4_fresh_ideas_to_ease_seattles_coming_traffic/">https://www.reddit.com/r/Seattle/comments/9orqne/4_fresh_ideas_to_ease_seattles_coming_traffic/</a></li>
<li><a href="https://www.reddit.com/r/SeattleWA/comments/cr1r1l/why_the_fuck_does_the_right_lane_convert_to/">https://www.reddit.com/r/SeattleWA/comments/cr1r1l/why_the_fuck_does_the_right_lane_convert_to/</a></li>
<li><a href="https://twitter.com/transitrunner/status/1175068582142599168">https://twitter.com/transitrunner/status/1175068582142599168</a></li>
</ul>
<h2 id="groups-that-may-be-eventually-interested"><a class="header" href="#groups-that-may-be-eventually-interested">Groups that may be eventually interested</a></h2>
<ul>
<li>Seattle Times Traffic Lab</li>
<li><a href="https://www.citylab.com/transportation/2018/08/is-it-time-to-rethink-what-a-bike-lane-is/568483/">https://www.citylab.com/transportation/2018/08/is-it-time-to-rethink-what-a-bike-lane-is/568483/</a></li>
<li><a href="http://openseattle.org/">http://openseattle.org/</a></li>
<li><a href="https://igniteseattle.com/">https://igniteseattle.com/</a></li>
<li><a href="http://seattlegreenways.org/">http://seattlegreenways.org/</a></li>
<li><a href="https://www.livablecities.org/">https://www.livablecities.org/</a></li>
<li><a href="https://www.reddit.com/r/openstreetmap/comments/a39uv0/ok_so/">https://www.reddit.com/r/openstreetmap/comments/a39uv0/ok_so/</a></li>
<li><a href="https://mic.comotion.uw.edu/">https://mic.comotion.uw.edu/</a></li>
<li><a href="https://www.seattleinprogress.com/">https://www.seattleinprogress.com/</a></li>
<li><a href="http://www.seattle.gov/seattle-pedestrian-advisory-board">http://www.seattle.gov/seattle-pedestrian-advisory-board</a></li>
<li>Socrata</li>
<li><a href="http://transportationcamp.org/">http://transportationcamp.org/</a></li>
<li><a href="https://www.seattle.gov/transportation/projects-and-programs/programs/neighborhood-street-fund">https://www.seattle.gov/transportation/projects-and-programs/programs/neighborhood-street-fund</a></li>
<li><a href="https://www.seattle.gov/neighborhoods/programs-and-services/your-voice-your-choice">https://www.seattle.gov/neighborhoods/programs-and-services/your-voice-your-choice</a></li>
<li><a href="https://commuteseattle.com/">https://commuteseattle.com/</a></li>
<li><a href="https://www.theurbanist.org/">https://www.theurbanist.org/</a></li>
<li><a href="https://humantransit.org/2019/03/notes-on-simcity-at-30.html">https://humantransit.org/2019/03/notes-on-simcity-at-30.html</a></li>
<li><a href="https://mynorthwest.com/category/chokepoints/">https://mynorthwest.com/category/chokepoints/</a></li>
<li><a href="https://blogs.uw.edu/ceadvice/2019/05/08/infrastructure-week-2019-welcome-uw-cee-students-and-faculty/">https://blogs.uw.edu/ceadvice/2019/05/08/infrastructure-week-2019-welcome-uw-cee-students-and-faculty/</a></li>
<li><a href="https://escience.washington.edu/dssg/">https://escience.washington.edu/dssg/</a></li>
<li>josie kresner from transport foundry</li>
<li><a href="https://www.citylab.com/transportation/2019/08/city-planning-transportation-oakland-community-engagement/596050/">https://www.citylab.com/transportation/2019/08/city-planning-transportation-oakland-community-engagement/596050/</a>
<ul>
<li>tweeting small problems -&gt; bug tracker</li>
</ul>
</li>
<li><a href="https://www.the74million.org/article/building-a-smarter-and-cheaper-school-bus-system-how-a-boston-mit-partnership-led-to-new-routes-that-are-20-more-efficient-use-400-fewer-buses-save-5-million/">https://www.the74million.org/article/building-a-smarter-and-cheaper-school-bus-system-how-a-boston-mit-partnership-led-to-new-routes-that-are-20-more-efficient-use-400-fewer-buses-save-5-million/</a></li>
<li><a href="https://www.citylab.com/perspective/2019/10/micromobility-urban-design-car-free-infrastruture-futurama/600163/">https://www.citylab.com/perspective/2019/10/micromobility-urban-design-car-free-infrastruture-futurama/600163/</a></li>
<li><a href="https://www.sanjorn.com/">https://www.sanjorn.com/</a></li>
<li><a href="https://ui.kpf.com/">https://ui.kpf.com/</a></li>
</ul>
<h2 id="similar-projects"><a class="header" href="#similar-projects">Similar projects</a></h2>
<ul>
<li>Urban Footprint (<a href="https://news.ycombinator.com/item?id=17895739">https://news.ycombinator.com/item?id=17895739</a>)</li>
</ul>
<h2 id="seattle-specific"><a class="header" href="#seattle-specific">Seattle-specific</a></h2>
<p>SDOT asking for feedback:</p>
<ul>
<li><a href="http://sdotblog.seattle.gov/2017/02/08/from-signals-to-signs/">http://sdotblog.seattle.gov/2017/02/08/from-signals-to-signs/</a></li>
<li><a href="https://www.seattle.gov/transportation/projects-and-programs/programs/bike-program/protected-bike-lanes/n-34th-st-mobility-improvements">https://www.seattle.gov/transportation/projects-and-programs/programs/bike-program/protected-bike-lanes/n-34th-st-mobility-improvements</a></li>
<li><a href="https://www.seattle.gov/transportation/projects-and-programs/programs/transportation-planning/north-downtown-mobility-action-plan">https://www.seattle.gov/transportation/projects-and-programs/programs/transportation-planning/north-downtown-mobility-action-plan</a></li>
<li><a href="https://www.seattlebikeblog.com/2016/12/01/check-out-seattles-12-winning-neighborhood-led-transportation-ideas/">https://www.seattlebikeblog.com/2016/12/01/check-out-seattles-12-winning-neighborhood-led-transportation-ideas/</a></li>
</ul>
<p>Seattlites with opinions and ideas:</p>
<ul>
<li>
<p><a href="http://seattlegreenways.org/">http://seattlegreenways.org/</a></p>
</li>
<li>
<p><a href="https://www.seattlebikeblog.com/2018/01/19/a-roosevelt-junior-redesigned-the-streets-around-his-high-school-and-his-plan-is-better-than-sdots/">https://www.seattlebikeblog.com/2018/01/19/a-roosevelt-junior-redesigned-the-streets-around-his-high-school-and-his-plan-is-better-than-sdots/</a></p>
</li>
<li>
<p><a href="https://www.reddit.com/r/SeattleWA/comments/5rvss5/what_changes_would_you_make_to_seattles_bus/">https://www.reddit.com/r/SeattleWA/comments/5rvss5/what_changes_would_you_make_to_seattles_bus/</a></p>
</li>
<li>
<p><a href="https://www.seattletimes.com/seattle-news/transportation/congestion-tolling-could-finally-break-seattles-working-poor-heres-a-better-idea/">https://www.seattletimes.com/seattle-news/transportation/congestion-tolling-could-finally-break-seattles-working-poor-heres-a-better-idea/</a></p>
</li>
<li>
<p><a href="https://www.reddit.com/r/SeattleWA/comments/86g3p9/id_get_back_an_hour_and_a_half_a_week/">https://www.reddit.com/r/SeattleWA/comments/86g3p9/id_get_back_an_hour_and_a_half_a_week/</a></p>
</li>
<li>
<p><a href="https://www.reddit.com/r/Seattle/comments/4z3ewl/what_are_seattles_worst_intersections/">https://www.reddit.com/r/Seattle/comments/4z3ewl/what_are_seattles_worst_intersections/</a></p>
</li>
<li>
<p><a href="https://www.reddit.com/r/SeattleWA/comments/83h4ri/the_intersection_at_john_and_broadway_desperately/">https://www.reddit.com/r/SeattleWA/comments/83h4ri/the_intersection_at_john_and_broadway_desperately/</a></p>
</li>
<li>
<p><a href="http://www.seattle.gov/transportation/sdot-document-library/citywide-plans/move-seattle">http://www.seattle.gov/transportation/sdot-document-library/citywide-plans/move-seattle</a></p>
</li>
</ul>
<h2 id="other-projects"><a class="header" href="#other-projects">Other projects</a></h2>
<ul>
<li><a href="https://github.com/uwescience/TrafficCruising-DSSG2017">https://github.com/uwescience/TrafficCruising-DSSG2017</a></li>
<li><a href="http://sharedstreets.io/">http://sharedstreets.io/</a></li>
<li><a href="https://github.com/twpol/osm-tiles">https://github.com/twpol/osm-tiles</a> attempting to infer nice road geometry
too</li>
</ul>
<h2 id="notes-from-related-work"><a class="header" href="#notes-from-related-work">Notes from related work</a></h2>
<h3 id="smarts-a-hrefhttpspeopleengunimelbeduauetanintist17pdfhttpspeopleengunimelbeduauetanintist17pdfa"><a class="header" href="#smarts-a-hrefhttpspeopleengunimelbeduauetanintist17pdfhttpspeopleengunimelbeduauetanintist17pdfa">SMARTS (<a href="https://people.eng.unimelb.edu.au/etanin/tist17.pdf">https://people.eng.unimelb.edu.au/etanin/tist17.pdf</a>)</a></h3>
<ul>
<li>Split map into sections, simulate in parallel, load-balance</li>
<li>has an IDM equation</li>
<li>tests against real TomTom data of average speed per link</li>
</ul>
<h3 id="games"><a class="header" href="#games">Games</a></h3>
<p>SimCity, Cities: Skylines
<a href="https://steamcommunity.com/sharedfiles/filedetails/?id=583429740">https://steamcommunity.com/sharedfiles/filedetails/?id=583429740</a>
<a href="https://github.com/fegennari/3DWorld">https://github.com/fegennari/3DWorld</a></p>
<h3 id="open-source-urban-planning"><a class="header" href="#open-source-urban-planning">Open source urban planning</a></h3>
<p>UrbanSim</p>
<h3 id="proprietary"><a class="header" href="#proprietary">Proprietary</a></h3>
<p>Sidewalk Labs Model</p>
<h3 id="maps-for-people"><a class="header" href="#maps-for-people">Maps for people</a></h3>
<p><a href="https://arxiv.org/pdf/1811.01147.pdf">https://arxiv.org/pdf/1811.01147.pdf</a></p>
<h3 id="gammacsunceduroadnetworkwilkie_tvcgpdf"><a class="header" href="#gammacsunceduroadnetworkwilkie_tvcgpdf">gamma.cs.unc.edu/RoadNetwork/wilkie_TVCG.pdf</a></h3>
<p>section 6.3 talks about offset polylines <a href="http://gamma.cs.unc.edu/RoadNetwork">http://gamma.cs.unc.edu/RoadNetwork</a></p>
<h3 id="citybound"><a class="header" href="#citybound">CityBound</a></h3>
<p><a href="https://github.com/aeickhoff/descartes">https://github.com/aeickhoff/descartes</a></p>
<h3 id="discrete-event-simulation-papers"><a class="header" href="#discrete-event-simulation-papers">Discrete Event Simulation papers</a></h3>
<ul>
<li>
<p>section 5.1 of Advanced tutorial on microscopic discrete-event traffic
simulation refers to some DES systems</p>
<ul>
<li>Florian, Mahut, and Tremblay 2008</li>
<li>Sumaryo, Halim, and Ramli 2013</li>
<li>Salimifard and Ansari 2013</li>
<li>Burghout, Koutsopoulos, and Andreasson 2006</li>
<li>Thulasidasan, Kasiviswanathan, Eidenbenz, Galli, Mniszewski, and Romero 2009</li>
</ul>
</li>
<li>
<p>A Dynamic Traffic Assignment Model for Highly Congested Urban Networks</p>
<ul>
<li>section 2.2 models lanes as a moving and queueing part, references other
possibly useful papers</li>
<li>dont worry about multiple lanes for the moving part, just the turn queues at
the end</li>
</ul>
</li>
</ul>
<h2 id="tactical-urbanism"><a class="header" href="#tactical-urbanism">Tactical urbanism</a></h2>
<ul>
<li><a href="https://www.vice.com/en_us/article/pajgyz/rogue-coder-turned-a-parking-spot-into-a-coworking-space">https://www.vice.com/en_us/article/pajgyz/rogue-coder-turned-a-parking-spot-into-a-coworking-space</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="presentations"><a class="header" href="#presentations">Presentations</a></h1>
<p>Most recent first.</p>
<ul>
<li>August 2021: <a href="https://www.youtube.com/watch?v=nNYroA16JEQ">Actdev promo video</a></li>
<li>July 2021: State of the Map 2021, Using OSM for transportation advocacy
<ul>
<li><a href="https://docs.google.com/presentation/d/1glV5DTq2M-XMHOwiNyAmQ6LeeyaKynOHRA-XoU02qYk/edit?usp=sharing">Slides</a></li>
<li><a href="https://www.youtube.com/watch?v=27uxMlF8th8">Video</a></li>
</ul>
</li>
<li>June 2021: Smart Planning, Digital Twins, &amp; Open Data
<ul>
<li><a href="https://docs.google.com/presentation/d/1Tt6oentuh_q-WpIC8auX67HBocpTj7ywnKZN-x6Ny8w/edit?usp=sharing">Slides</a></li>
<li><a href="https://www.dropbox.com/s/ywsshog7vbdkf9x/TOMNETWebinar_060721.mp4?dl=0">Video</a></li>
<li>Talk given for
<a href="https://tomnet-utc.engineering.asu.edu/seminars/spring-2021-seminars/">Arizona State University TOMNET</a></li>
</ul>
</li>
<li>April 2021:
<a href="https://www.fsutmsonline.net/index.php?/user_groups/comments/southeast_florida_fsutms_users_group_meeting_april_16_2021">FSUTMS talk</a>
<ul>
<li><a href="https://docs.google.com/presentation/d/1YpqE3NpQYZmSePbALMK5PWoP7jD3cah_X8Jtcy4gtpo/edit?usp=sharing">Slides</a></li>
<li><a href="https://www.fsutmsonline.net/images/uploads/southeastfloridafsutms/SEFL_FSUTMS_UG_04_16_2021.mp4">Video</a></li>
</ul>
</li>
<li>February 2021: Transport Data Science guest lecture
<ul>
<li><a href="https://docs.google.com/presentation/d/1wFgkbyVhsa93FxmDsWuMQ6nXPJbHiZDllQ59xGXcKyg/edit?usp=sharing">Slides</a></li>
</ul>
</li>
<li>October 2020: OSM Connect 2020
<ul>
<li><a href="https://docs.google.com/presentation/d/1ZudGSXlbOL6xdVZXhAcKJvFaLEgeRkgFIX4pbVKSvLQ/edit?usp=sharing">Slides</a></li>
<li><a href="https://www.youtube.com/watch?v=JUN5GWfb4Qo">Video</a></li>
</ul>
</li>
<li>July 2020: <a href="https://bikesiliconvalley.org/2020/07/poster_dustin-carlino/">Silicon Valley Bike Coalition summit</a></li>
<li><a href="https://youtu.be/P12N51qI5Cs?t=1469">March 2021 ActDev workshop</a></li>
<li>April 2020 Seattle Rust meetup
<ul>
<li><a href="https://www.youtube.com/watch?v=chYd5I-5oyc">Video</a></li>
<li><a href="https://docs.google.com/presentation/d/1nUodhr42eppB2E2eMAnuTkMhIVuHnN7_6i6V6MA028c/edit?usp=sharing">Slides</a></li>
</ul>
</li>
<li><a href="https://docs.google.com/presentation/d/181so6bWkGsPzpc-mI72CQffthMKMVzFPAkYxIyzgfAs/edit?usp=sharing">Feb 2020 traffic sim</a></li>
<li><a href="https://docs.google.com/presentation/d/1PJRFoXmJAyenkqHIwo48zxqu1LSH6pc7XKSzhyC1raw/edit?usp=sharing">Oct 2019 Traffic sim and current challenges</a></li>
<li><a href="https://docs.google.com/presentation/d/1cF7qFtjAzkXL_r62CjxBvgQnLvuQ9I2WTE2iX_5tMCY/edit?usp=sharing">Oct 2019 Map construction</a></li>
</ul>
<h2 id="minor-talksdemos"><a class="header" href="#minor-talksdemos">Minor talks/demos</a></h2>
<ul>
<li>May 2021: Open:Data:Night for Open Manchester
<ul>
<li><a href="https://vimeo.com/557955717">Video</a></li>
</ul>
</li>
<li>January 2021: TRB Network Models in Practice
<ul>
<li><a href="https://docs.google.com/presentation/d/1-yC_WsdHN5RjmEvdN1wpa8Pdy-BJIZGhyV_dPYbaxyI/edit?usp=sharing">Slides</a></li>
</ul>
</li>
</ul>
<h2 id="upcoming"><a class="header" href="#upcoming">Upcoming</a></h2>
<p>Don't forget to link to these!</p>
<ul>
<li>FOSS4G 2021</li>
<li>SUMO</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
                        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
                
    </body>
</html>
