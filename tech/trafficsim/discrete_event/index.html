<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Discrete event simulation - A/B Street</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../../../favicon.svg">
                        <link rel="shortcut icon" href="../../../favicon.png">
                <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
                <link rel="stylesheet" href="../../../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../../../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../../index.html"><strong aria-hidden="true">1.</strong> Homepage</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../../../software/index.html"><strong aria-hidden="true">2.</strong> Software</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../software/abstreet.html"><strong aria-hidden="true">2.1.</strong> A/B Street</a></li><li class="chapter-item expanded "><a href="../../../software/fifteen_min.html"><strong aria-hidden="true">2.2.</strong> 15-minute neighborhoods explorer</a></li><li class="chapter-item expanded "><a href="../../../software/santa.html"><strong aria-hidden="true">2.3.</strong> 15-minute Santa</a></li><li class="chapter-item expanded "><a href="../../../software/osm_viewer.html"><strong aria-hidden="true">2.4.</strong> OpenStreetMap viewer</a></li><li class="chapter-item expanded "><a href="../../../software/parking_mapper.html"><strong aria-hidden="true">2.5.</strong> Mapping on-street parking</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../user/index.html"><strong aria-hidden="true">3.</strong> User guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../user/new_city.html"><strong aria-hidden="true">3.1.</strong> Importing a new city</a></li><li class="chapter-item expanded "><a href="../../../user/asu.html"><strong aria-hidden="true">3.2.</strong> ASU Lab guide</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../proposals/index.html"><strong aria-hidden="true">4.</strong> Proposals</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../proposals/lake_wash.html"><strong aria-hidden="true">4.1.</strong> Lake Washington Blvd Stay Healthy Street</a></li><li class="chapter-item expanded "><a href="../../../proposals/broadmoor.html"><strong aria-hidden="true">4.2.</strong> Allow bike and foot traffic through Broadmoor</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../tech/index.html"><strong aria-hidden="true">5.</strong> Technical details</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../tech/dev/index.html"><strong aria-hidden="true">5.1.</strong> Developer guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../tech/dev/misc_tricks.html"><strong aria-hidden="true">5.1.1.</strong> Misc developer tricks</a></li><li class="chapter-item expanded "><a href="../../../tech/dev/api.html"><strong aria-hidden="true">5.1.2.</strong> API</a></li><li class="chapter-item expanded "><a href="../../../tech/dev/testing.html"><strong aria-hidden="true">5.1.3.</strong> Testing</a></li><li class="chapter-item expanded "><a href="../../../tech/dev/mass_import.html"><strong aria-hidden="true">5.1.4.</strong> Importing many maps</a></li><li class="chapter-item expanded "><a href="../../../tech/dev/data.html"><strong aria-hidden="true">5.1.5.</strong> Data organization</a></li><li class="chapter-item expanded "><a href="../../../tech/dev/release.html"><strong aria-hidden="true">5.1.6.</strong> Release process</a></li><li class="chapter-item expanded "><a href="../../../tech/dev/formats/index.html"><strong aria-hidden="true">5.1.7.</strong> Data formats</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../tech/dev/formats/scenarios.html"><strong aria-hidden="true">5.1.7.1.</strong> Scenarios</a></li><li class="chapter-item expanded "><a href="../../../tech/dev/formats/traffic_signals.html"><strong aria-hidden="true">5.1.7.2.</strong> Traffic signals</a></li></ol></li><li class="chapter-item expanded "><a href="../../../tech/dev/ui.html"><strong aria-hidden="true">5.1.8.</strong> UI</a></li></ol></li><li class="chapter-item expanded "><a href="../../../tech/map/index.html"><strong aria-hidden="true">5.2.</strong> Map model</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../tech/map/geometry/index.html"><strong aria-hidden="true">5.2.1.</strong> Intersection geometry</a></li><li class="chapter-item expanded "><a href="../../../tech/map/details.html"><strong aria-hidden="true">5.2.2.</strong> Details</a></li><li class="chapter-item expanded "><a href="../../../tech/map/importing/index.html"><strong aria-hidden="true">5.2.3.</strong> Importing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../tech/map/importing/convert_osm.html"><strong aria-hidden="true">5.2.3.1.</strong> convert_osm</a></li><li class="chapter-item expanded "><a href="../../../tech/map/importing/geometry.html"><strong aria-hidden="true">5.2.3.2.</strong> Road/intersection geometry</a></li><li class="chapter-item expanded "><a href="../../../tech/map/importing/rest.html"><strong aria-hidden="true">5.2.3.3.</strong> The rest</a></li><li class="chapter-item expanded "><a href="../../../tech/map/importing/misc.html"><strong aria-hidden="true">5.2.3.4.</strong> Misc</a></li></ol></li><li class="chapter-item expanded "><a href="../../../tech/map/edits.html"><strong aria-hidden="true">5.2.4.</strong> Live edits</a></li><li class="chapter-item expanded "><a href="../../../tech/map/platform.html"><strong aria-hidden="true">5.2.5.</strong> Exporting</a></li></ol></li><li class="chapter-item expanded "><a href="../../../tech/trafficsim/index.html"><strong aria-hidden="true">5.3.</strong> Traffic simulation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../tech/trafficsim/discrete_event/index.html" class="active"><strong aria-hidden="true">5.3.1.</strong> Discrete event simulation</a></li><li class="chapter-item expanded "><a href="../../../tech/trafficsim/travel_demand.html"><strong aria-hidden="true">5.3.2.</strong> Travel demand</a></li><li class="chapter-item expanded "><a href="../../../tech/trafficsim/gridlock.html"><strong aria-hidden="true">5.3.3.</strong> Gridlock</a></li><li class="chapter-item expanded "><a href="../../../tech/trafficsim/trips.html"><strong aria-hidden="true">5.3.4.</strong> Multi-modal trips</a></li><li class="chapter-item expanded "><a href="../../../tech/trafficsim/live_edits.html"><strong aria-hidden="true">5.3.5.</strong> Live edits</a></li><li class="chapter-item expanded "><a href="../../../tech/trafficsim/parking.html"><strong aria-hidden="true">5.3.6.</strong> Parking</a></li><li class="spacer"></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../project/index.html"><strong aria-hidden="true">6.</strong> Project</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../project/team.html"><strong aria-hidden="true">6.1.</strong> Team</a></li><li class="chapter-item expanded "><a href="../../../project/contributing.html"><strong aria-hidden="true">6.2.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="../../../project/funding.html"><strong aria-hidden="true">6.3.</strong> Funding</a></li><li class="chapter-item expanded "><a href="../../../project/hiring.html"><strong aria-hidden="true">6.4.</strong> Hiring</a></li><li class="chapter-item expanded "><a href="../../../project/roadmap.html"><strong aria-hidden="true">6.5.</strong> Roadmap</a></li><li class="chapter-item expanded "><a href="../../../project/motivations.html"><strong aria-hidden="true">6.6.</strong> Motivations</a></li><li class="chapter-item expanded "><a href="../../../project/history/index.html"><strong aria-hidden="true">6.7.</strong> History</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../project/history/backstory.html"><strong aria-hidden="true">6.7.1.</strong> Backstory</a></li><li class="chapter-item expanded "><a href="../../../project/history/year1.html"><strong aria-hidden="true">6.7.2.</strong> Year 1</a></li><li class="chapter-item expanded "><a href="../../../project/history/year2.html"><strong aria-hidden="true">6.7.3.</strong> Year 2</a></li><li class="chapter-item expanded "><a href="../../../project/history/year3.html"><strong aria-hidden="true">6.7.4.</strong> Year 3</a></li></ol></li><li class="chapter-item expanded "><a href="../../../project/retrospective/index.html"><strong aria-hidden="true">6.8.</strong> Retrospective</a></li><li class="chapter-item expanded "><a href="../../../project/CHANGELOG.html"><strong aria-hidden="true">6.9.</strong> Full CHANGELOG</a></li><li class="chapter-item expanded "><a href="../../../project/references.html"><strong aria-hidden="true">6.10.</strong> References</a></li><li class="chapter-item expanded "><a href="../../../project/presentations.html"><strong aria-hidden="true">6.11.</strong> Presentations</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">A/B Street</h1>

                    <div class="right-buttons">
                                                <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/a-b-street/docs/tree/main/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                                        <a href="https://github.com/a-b-street/docs/edit/main/book/src/tech/trafficsim/discrete_event/README.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="discrete-event-traffic-simulation-laggy-heads-and-ghosts"><a class="header" href="#discrete-event-traffic-simulation-laggy-heads-and-ghosts">Discrete event traffic simulation, laggy heads, and ghosts</a></h1>
<p>A/B Street's traffic simulation isn't based on any research papers or existing
systems, so this article aims to motivate and explain how it works. This article
focuses on how the different agents (drivers, bicyclists, and pedestrians) move
around. If you're wondering how we figure out where these agents should go or
what time they decide to take trips, go read about
<a href="../travel_demand.html">travel demand models</a>.</p>
<p>I'm not aiming to survey how other traffic simulation models work here. In
short, some focus on &quot;macroscopic&quot; patterns, like the volume of traffic along a
particular highway over time. A/B Street is more on the &quot;microscopic&quot; side,
modeling individual agents making decisions over time. Many such models use
&quot;discrete-time&quot; simulation, where every agent senses and reacts to the world
every time-step (0.1 seconds or so). A/B Street actually started with this --
see the <a href="#appendix-discrete-time-simulation">appendix</a> for more background. But
early on, I switched to a discrete-event simulation instead. So, let's jump into
that!</p>
<p>Note: I'll provide references to the current implementation. Someday I'll write
that article describing how to build a traffic simulation from scratch...</p>
<ul>
<li><a href="#starting-simple-pedestrians">Starting simple: Pedestrians</a>
<ul>
<li><a href="#discrete-events">Discrete events</a></li>
</ul>
</li>
<li><a href="#vehicles">Vehicles</a>
<ul>
<li><a href="#the-state-machine">The state machine</a></li>
<li><a href="#exact-positions">Exact positions</a></li>
<li><a href="#laggy-heads">Laggy heads</a></li>
<li><a href="#performance">Performance</a></li>
</ul>
</li>
<li><a href="#lane-changing">Lane-changing</a></li>
<li><a href="#intersections">Intersections</a></li>
<li><a href="#appendix-discrete-time-simulation">Appendix: discrete-time simulation</a></li>
</ul>
<h2 id="starting-simple-pedestrians"><a class="header" href="#starting-simple-pedestrians">Starting simple: Pedestrians</a></h2>
<p>Imagine a simple movement model for pedestrians. Usually they exist at some
point along a sidewalk and can move in one direction or the other. At
intersections, different sidewalks are connected by crosswalks, and pedestrians
can also move bidirectionally on those, after waiting for the right time to
cross.</p>
<p><img src="sidewalks.png" alt="" /> <em>Sidewalks shown in blue, connected by pink crosswalks and
also cyan connections.Everything is bidirectional.</em></p>
<p>We'll make a few assumptions about pedestrians. They follow the sidewalks and
crosswalks perfectly, never deciding to honor their inner Pythagorean. They
travel at a fixed speed and change that speed instantly -- no smooth
acceleration. That fixed speed could depend on both their preferred walking
speed and on the current sidewalk's elevation gain. These poor robotic
pedestrians never stop to smell the flowers, write an angry neighborly note, or
pet a pupper -- they just walk, or wait. Online dating is also so pervasive in
this simulation that pedestrians ghost -- through each other, that is. There are
more interesting models of pedestrian movement like the
<a href="https://en.wikipedia.org/wiki/Crowd_simulation">social force model</a> where
people change speeds in crowds, but A/B Street is focused on sad American cities
where you don't really see many people walking in one place. So there's no
collision between pedestrians at all; they just pass through each other,
temporarily losing their individuality for rendering purposes:</p>
<p><img src="ghosts.gif" alt="" />
<em><a href="https://www.youtube.com/watch?v=lsV500W4BHU">This is what it's like when people collide</a></em></p>
<p>In the world of discrete timesteps, you could imagine each pedestrian has very
simple logic. At any moment, they just continue walking one direction or the
other at their fixed speed along a sidewalk or crosswalk. Or they pause at the
end of a sidewalk, awaiting their turn at a stop sign or traffic signal.</p>
<h3 id="discrete-events"><a class="header" href="#discrete-events">Discrete events</a></h3>
<p>Don't the constant updates every time-step seem wasteful? Most of the time, a
pedestrian is in a steady-state -- walking or waiting. Since they walk at a
fixed speed, we can just linearly interpolate their exact position at any moment
in time if we want to draw them.</p>
<p>Instead of looping through every agent every time-step, in a discrete-event
system, we just have one giant
<a href="https://github.com/a-b-street/abstreet/blob/master/sim/src/scheduler.rs">priority queue of events</a>,
scheduled to happen at some time in the future. Each agent remains in a certain
state for a period of time, and schedules an event to transition themselves to a
different state.</p>
<p>In the case of pedestrians, this works like this:</p>
<ol>
<li>A pedestrian begins at 30 meters distance along their first sidewalk. They
want to walk forwards on the sidewalk, so they calculate the distance to the
end of the sidewalk -- say another 70 meters -- and divide that by their
preferred speed, scheduling an event an appropriate amount of time later --
say 10 seconds.</li>
<li>For the next 10 seconds, that pedestrian is in the <code>Crossing</code> state, which
has a <code>DistanceInterval</code> stating that they're moving on a certain sidewalk
from 30 to 70 meters. The <code>TimeInterval</code> says that this state is occuring
from time 0 to 10 seconds. We can linearly interpolate to find their
position for drawing.</li>
<li>At 10 seconds, the scheduler wakes up the pedestrian. They're now at the end
of the sidewalk, so they look at the intersection and ask to cross. There's
a traffic signal, and the almighty hand says NOPE, so they hand over control
to the intersection and just mark themselves as <code>WaitingToTurn</code> state. No
events are scheduled to update them.</li>
<li>But the intersection remembers the list of waiting agents. Some time later,
the light changes, and the intersection &quot;wakes up&quot; all of the agents who now
have a green.</li>
<li>Our pedestrian calculates a new <code>Crossing</code> state for the crosswalk. This
state too happens over some distance and time interval.</li>
<li>At the end of the crosswalk, the pedestrian immediately enters another
<code>Crossing</code> state for the next sidewalk.</li>
</ol>
<p>We can visualize this with a finite-state machine diagram:</p>
<p><img src="pedestrian_fsm.png" alt="" /></p>
<p>Code references
<a href="https://github.com/a-b-street/abstreet/blob/master/sim/src/mechanics/walking.rs">here</a>.</p>
<h2 id="vehicles"><a class="header" href="#vehicles">Vehicles</a></h2>
<p>Discrete events are obviously much simpler for pedestrians, but there were some
pretty drastic assumptions there that won't work for vehicles. It takes a few
more tricks for A/B Street to model cars, bikes, and buses (I'll just use
&quot;vehicle&quot; from here on.)</p>
<p>First let's understand what vehicles can do. They travel in one direction along
individual lanes, and they queue behind each other -- no ghosting. At
intersections, they wait as needed, then move along a &quot;turn,&quot; destined for a
target lane. There are two major differences from reality that we'll take as
assumptions.</p>
<p>First, vehicles instantly change speeds -- no smooth acceleration from rest, or
modeling of safe stoping distance. So if a vehicle starts at the beginning of an
empty lane, they instantly jump from rest to the maximum speed limit for that
road. They travel at that maximum speed limit until the moment their front
bumper strikes the boundary between road and intersection, then they stop
immediately. This doesn't model highway driving at all, where things like jam
waves are interesting to study and require more realistic kinematics and a model
of driver reaction time. But A/B Street is focused on in-city movement, and the
essence of scarcity I want to model is capacity on lanes and contention at
intersections. What happens in between isn't as important. I think you'll find
that the overall traffic patterns emerging in A/B Street still look compellingly
realistic.</p>
<!-- show perfect stop -->
<p>The second article of funny business is lane-changing. Let's assume that
vehicles don't change lanes in the middle of a road. Instead, vehicles shift
left and right while moving through intersections. So if somebody needs to use a
left turn lane, then at the intersection one road back, they'll choose to slide
over during their turn. Any conflicting movements with other vehicles is handled
at the intersection already.</p>
<!-- show path moving to the left -->
<p>This also means there's no over-taking. If a car gets stuck behind a bike moving
slowly uphill, so be it.</p>
<!-- slow uphill -->
<p>We'll try to relax this second assumption later.</p>
<h3 id="the-state-machine"><a class="header" href="#the-state-machine">The state machine</a></h3>
<p>So let's figure out how to model these vehicles. The approach used by
pedestrians, with <code>Crossing</code> and <code>WaitingToAdvance</code> states doesn't quite work,
because nothing would stop vehicles from plowing into each other. So let's
introduce a third state -- <code>Queued</code>. When a vehicle enters a new lane, it enters
the <code>Crossing</code> state as usual, calculating the &quot;best-case&quot; time to cross the
entire length of the lane at the max speed limit. This assumes nobody's in the
way! But when this state ends, we can only transition the vehicle to the
<code>WaitingToAdvance</code> state if they're the &quot;lead&quot; vehicle in the current lane's
queue. If they have a &quot;leader&quot; vehicle, then they enter the <code>Queued</code> state and
register as a &quot;follower&quot; of this &quot;leader&quot; in the queue.</p>
<!-- time0: leader in Crossing, follower in Crossing -->
<!-- time1: leader in WaitingToAdvance, follower in Crossing -->
<!-- time2: leader in WaitingToAdvance, follower in Queued -->
<p>When the vehicle at the very front of a lane enters the intersection and vacates
their old lane, then they &quot;wake up&quot; their follower. The follower changes from
<code>Queued</code> back to <code>Crossing</code>. Note that the follower doesn't instantly transition
to <code>WaitingToAdvance</code>, since they're not quite at the end of the lane. Based on
the length of the leader vehicle, the follower has some short distance left to
cover. <!-- check details here... --></p>
<p>We can again understand all of this with a finite-state machine:</p>
<p><img src="vehicle_fsm.png" alt="" /></p>
<!-- code in mechanics/car,driving -->
<h3 id="exact-positions"><a class="header" href="#exact-positions">Exact positions</a></h3>
<p>Most of the time, we don't care exactly where on a lane some vehicle is. But we
do need to know for drawing and for a few cases during simulation, such as
determining when a bus is lined up with a bus stop in the middle of a lane.</p>
<p>To calculate exact positions, we walk along each lane's queue from front to
back. The key idea is that leaders bound the position of followers, and we can
&quot;lazily evaluate&quot; the position of followers. This means that calculating one
vehicle's position costs as much as calculating the entire queue's in the worst
case, but that's usually fine -- for drawing, we want everyone anyway.</p>
<p>The process is simple. We use each vehicle's state to determine the possible
position of their front bumper. <code>WaitingToAdvance</code> means the vehicle is at the
very end of the lane. For vehicles still <code>Crossing</code>, we linearly interpolate the
time and distance intervals. Then as we walk from front to back, we maintain a
&quot;bound&quot; for the next vehicle's position. This is based on the front position of
the current vehicle, plus the vehicle's length and a fixed following distance
(which, note, is not based on speed).</p>
<!-- diagram -->
<!-- queue.rs -->
<h3 id="laggy-heads"><a class="header" href="#laggy-heads">Laggy heads</a></h3>
<!-- laggy head details -->
<p>Another case where we need to know exact positions of cars is to prevent the
first vehicle on a lane from hitting the back of a car who just left the lane.
All vehicles have length, and position is tracked by the front of the car. When
a car's front leaves a lane, its back is still partly in the lane. Logically,
the new lead car in the lane still needs to act like it's Queued. So each lane
keeps a &quot;laggy head&quot;, pointing to the car with its back partly in the lane.
After the laggy head has made it sufficient distance along its new turn or lane,
the laggy head on the old lane can be erased, unblocking the lead vehicle. This
requires calculating exact distances and some occasionally expensive cases where
we have to schedule frequent events to check when a laggy head is clear.</p>
<h3 id="performance"><a class="header" href="#performance">Performance</a></h3>
<!-- estimate number of events -->
<h2 id="lane-changing"><a class="header" href="#lane-changing">Lane-changing</a></h2>
<!-- https://github.com/a-b-street/abstreet/pull/682 -->
<p>Lane-changing (LCing) deserves special mention. A/B Street cheats by not
allowing it on lanes themselves. Instead, at intersections, cars can perform
turns that shift them over any number of lanes. These LCing turns conflict with
other turns appropriately, so the contention is still modeled. Why do it this
way? In a
<a href="http://apps.cs.utexas.edu/tech_reports/reports/tr/TR-2157.pdf">previous project</a>,
I tried opportunistic LCing. If a car had room to warp to the equivalent
distance on the adjacent lane without causing a crash, it would start LCing,
then take a fixed time to slide over, blocking both lanes throughout. This meant
cars often failed to LC when they needed to, forcing them to reroute, botching
their trip times. In many cases the cars would be permanently stuck, because
pathfinding would return paths requiring LCing that couldn't be pulled off in
practice due to really short roads. Why not try making the car slow down if
needed? Eventually it might have to stop, which could lead to unrealistic
gridlock. This LCing model was using a detailed discrete-time model with cars
accelerating properly; maybe it's easier with A/B Street's simplified movement
model.</p>
<p>Currently in A/B Street, cars will pick the least backed-up lane when there's a
choice. They make this decision once when they reach the front of a queue; look
for <code>opportunistically_lanechange</code> in <code>router.rs</code>. The decision could be
improved.</p>
<h2 id="intersections"><a class="header" href="#intersections">Intersections</a></h2>
<!-- maybe move all this to gridlock article -->
<p>I need to flesh this section out. See <code>mechanics/intersections.rs</code> for how stop
signs and traffic signals work. Two things I need to fix before making this
section interesting:</p>
<ul>
<li>Only wake up relevant agents when a previous agent finishes a turn.</li>
<li>Don't let an agent start a low-priority turn (like an unprotected left) if
it'll force a high-priority vehicle approaching to wait. The approaching
vehicle is still in the Crossing state, so we need to notify intersections
ahead of time of intended turns and an ETA.</li>
</ul>
<p>One contributor to permanent gridlock is cars and bikes being stuck in an
intersection, preventing conflicting turns from being performed. To help avoid
this, one of the last checks that stop signs and traffic signals perform before
accepting a new turn request is that the target lane has enough space for the
new vehicle. This is &quot;reserved&quot; space, not necessarily currently occupied by
vehicles in that lane. This accounts for other vehicles performing a turn bound
for that lane. See <code>try_to_reserve_entry</code> in <code>mechanics/queue.rs</code>. When a car
completely leaves a lane (determined by the &quot;laggy head&quot; described above), this
space is freed, and blocked cars are woken up.</p>
<h2 id="appendix-discrete-time-simulation"><a class="header" href="#appendix-discrete-time-simulation">Appendix: discrete-time simulation</a></h2>
<p>A/B Street's first traffic model was discrete-time, meaning that every agent
reacted to the world every 0.1s. Cars had a more realistic kinematics model,
accelerating to change speed and gradually come to a halt. Cars did a worst-case
estimation of how far ahead they need to lookahead in order to satisfy different
constraints:</p>
<ul>
<li>Don't exceed any speed limits</li>
<li>Don't hit the lead vehicle (which might suddenly slam on its brakes)</li>
<li>Stop at the end of a lane, unless the intersection says to go</li>
</ul>
<!-- why was lookahead hard: short lanes? -->
<p>After fighting with this approach for a long time, I eventually scrapped it in
favor of the simpler discrete-event model because:</p>
<ul>
<li>It's fundamentally slow; there's lots of busy work where cars in freeflow with
nothing blocking them or stopped in a long queue constantly check to see if
anything has changed.</li>
<li>Figuring out the acceleration to apply for the next 0.1s in order to satisfy
all of the constraints is really complicated. Floating point inaccuracies
cause ugly edge cases with speeds that wind up slightly negative and with cars
coming to a complete stop slightly past the end of a lane. I wound up storing
the &quot;intent&quot; of an action to auto-correct these errors.</li>
<li>The realism of having cars accelerate smoothly didn't add value to the core
idea in A/B Street, which is to model points of contention like parking
capacity and intersections. (This is the same reason why I don't model bike
racks for parking bikes -- in Seattle, it's never hard to find something to
lock to -- this would be very different if Copenhagen was the target.)
Additionally, the kinematics model made silly assumptions about driving anyway
-- cars would smash on their accelerators and brakes as hard as possible
within all of the constraints.</li>
</ul>
<!-- following papers is hard. diffeq's, no advice how to deal with real geometry or do LCing.. slow down to shift? -->

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../../../tech/trafficsim/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../../../tech/trafficsim/travel_demand.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../../../tech/trafficsim/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../../../tech/trafficsim/travel_demand.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
