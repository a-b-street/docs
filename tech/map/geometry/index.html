<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Intersection geometry - A/B Street</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../../../favicon.svg">
                        <link rel="shortcut icon" href="../../../favicon.png">
                <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
                <link rel="stylesheet" href="../../../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../../../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../../index.html"><strong aria-hidden="true">1.</strong> Homepage</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../../../software/index.html"><strong aria-hidden="true">2.</strong> Software</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../software/abstreet.html"><strong aria-hidden="true">2.1.</strong> A/B Street</a></li><li class="chapter-item expanded "><a href="../../../software/fifteen_min.html"><strong aria-hidden="true">2.2.</strong> 15-minute neighborhoods explorer</a></li><li class="chapter-item expanded "><a href="../../../software/santa.html"><strong aria-hidden="true">2.3.</strong> 15-minute Santa</a></li><li class="chapter-item expanded "><a href="../../../software/osm_viewer.html"><strong aria-hidden="true">2.4.</strong> OpenStreetMap viewer</a></li><li class="chapter-item expanded "><a href="../../../software/parking_mapper.html"><strong aria-hidden="true">2.5.</strong> Mapping on-street parking</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../user/index.html"><strong aria-hidden="true">3.</strong> User guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../user/new_city.html"><strong aria-hidden="true">3.1.</strong> Importing a new city</a></li><li class="chapter-item expanded "><a href="../../../user/asu.html"><strong aria-hidden="true">3.2.</strong> ASU Lab guide</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../proposals/index.html"><strong aria-hidden="true">4.</strong> Proposals</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../proposals/lake_wash.html"><strong aria-hidden="true">4.1.</strong> Lake Washington Blvd Stay Healthy Street</a></li><li class="chapter-item expanded "><a href="../../../proposals/broadmoor.html"><strong aria-hidden="true">4.2.</strong> Allow bike and foot traffic through Broadmoor</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../tech/index.html"><strong aria-hidden="true">5.</strong> Technical details</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../tech/dev/index.html"><strong aria-hidden="true">5.1.</strong> Developer guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../tech/dev/misc_tricks.html"><strong aria-hidden="true">5.1.1.</strong> Misc developer tricks</a></li><li class="chapter-item expanded "><a href="../../../tech/dev/api.html"><strong aria-hidden="true">5.1.2.</strong> API</a></li><li class="chapter-item expanded "><a href="../../../tech/dev/testing.html"><strong aria-hidden="true">5.1.3.</strong> Testing</a></li><li class="chapter-item expanded "><a href="../../../tech/dev/mass_import.html"><strong aria-hidden="true">5.1.4.</strong> Importing many maps</a></li><li class="chapter-item expanded "><a href="../../../tech/dev/data.html"><strong aria-hidden="true">5.1.5.</strong> Data organization</a></li><li class="chapter-item expanded "><a href="../../../tech/dev/release.html"><strong aria-hidden="true">5.1.6.</strong> Release process</a></li><li class="chapter-item expanded "><a href="../../../tech/dev/formats/index.html"><strong aria-hidden="true">5.1.7.</strong> Data formats</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../tech/dev/formats/scenarios.html"><strong aria-hidden="true">5.1.7.1.</strong> Scenarios</a></li><li class="chapter-item expanded "><a href="../../../tech/dev/formats/traffic_signals.html"><strong aria-hidden="true">5.1.7.2.</strong> Traffic signals</a></li></ol></li><li class="chapter-item expanded "><a href="../../../tech/dev/ui.html"><strong aria-hidden="true">5.1.8.</strong> UI</a></li></ol></li><li class="chapter-item expanded "><a href="../../../tech/map/index.html"><strong aria-hidden="true">5.2.</strong> Map model</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../tech/map/geometry/index.html" class="active"><strong aria-hidden="true">5.2.1.</strong> Intersection geometry</a></li><li class="chapter-item expanded "><a href="../../../tech/map/details.html"><strong aria-hidden="true">5.2.2.</strong> Details</a></li><li class="chapter-item expanded "><a href="../../../tech/map/importing/index.html"><strong aria-hidden="true">5.2.3.</strong> Importing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../tech/map/importing/convert_osm.html"><strong aria-hidden="true">5.2.3.1.</strong> convert_osm</a></li><li class="chapter-item expanded "><a href="../../../tech/map/importing/geometry.html"><strong aria-hidden="true">5.2.3.2.</strong> Road/intersection geometry</a></li><li class="chapter-item expanded "><a href="../../../tech/map/importing/rest.html"><strong aria-hidden="true">5.2.3.3.</strong> The rest</a></li><li class="chapter-item expanded "><a href="../../../tech/map/importing/misc.html"><strong aria-hidden="true">5.2.3.4.</strong> Misc</a></li></ol></li><li class="chapter-item expanded "><a href="../../../tech/map/edits.html"><strong aria-hidden="true">5.2.4.</strong> Live edits</a></li><li class="chapter-item expanded "><a href="../../../tech/map/platform.html"><strong aria-hidden="true">5.2.5.</strong> Exporting</a></li></ol></li><li class="chapter-item expanded "><a href="../../../tech/trafficsim/index.html"><strong aria-hidden="true">5.3.</strong> Traffic simulation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../tech/trafficsim/discrete_event.html"><strong aria-hidden="true">5.3.1.</strong> Discrete event simulation</a></li><li class="chapter-item expanded "><a href="../../../tech/trafficsim/travel_demand.html"><strong aria-hidden="true">5.3.2.</strong> Travel demand</a></li><li class="chapter-item expanded "><a href="../../../tech/trafficsim/gridlock.html"><strong aria-hidden="true">5.3.3.</strong> Gridlock</a></li><li class="chapter-item expanded "><a href="../../../tech/trafficsim/trips.html"><strong aria-hidden="true">5.3.4.</strong> Multi-modal trips</a></li><li class="chapter-item expanded "><a href="../../../tech/trafficsim/live_edits.html"><strong aria-hidden="true">5.3.5.</strong> Live edits</a></li><li class="chapter-item expanded "><a href="../../../tech/trafficsim/parking.html"><strong aria-hidden="true">5.3.6.</strong> Parking</a></li><li class="spacer"></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../project/index.html"><strong aria-hidden="true">6.</strong> Project</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../project/team.html"><strong aria-hidden="true">6.1.</strong> Team</a></li><li class="chapter-item expanded "><a href="../../../project/contributing.html"><strong aria-hidden="true">6.2.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="../../../project/funding.html"><strong aria-hidden="true">6.3.</strong> Funding</a></li><li class="chapter-item expanded "><a href="../../../project/hiring.html"><strong aria-hidden="true">6.4.</strong> Hiring</a></li><li class="chapter-item expanded "><a href="../../../project/roadmap.html"><strong aria-hidden="true">6.5.</strong> Roadmap</a></li><li class="chapter-item expanded "><a href="../../../project/motivations.html"><strong aria-hidden="true">6.6.</strong> Motivations</a></li><li class="chapter-item expanded "><a href="../../../project/history/index.html"><strong aria-hidden="true">6.7.</strong> History</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../project/history/backstory.html"><strong aria-hidden="true">6.7.1.</strong> Backstory</a></li><li class="chapter-item expanded "><a href="../../../project/history/year1.html"><strong aria-hidden="true">6.7.2.</strong> Year 1</a></li><li class="chapter-item expanded "><a href="../../../project/history/year2.html"><strong aria-hidden="true">6.7.3.</strong> Year 2</a></li><li class="chapter-item expanded "><a href="../../../project/history/year3.html"><strong aria-hidden="true">6.7.4.</strong> Year 3</a></li></ol></li><li class="chapter-item expanded "><a href="../../../project/retrospective/index.html"><strong aria-hidden="true">6.8.</strong> Retrospective</a></li><li class="chapter-item expanded "><a href="../../../project/CHANGELOG.html"><strong aria-hidden="true">6.9.</strong> Full CHANGELOG</a></li><li class="chapter-item expanded "><a href="../../../project/references.html"><strong aria-hidden="true">6.10.</strong> References</a></li><li class="chapter-item expanded "><a href="../../../project/presentations.html"><strong aria-hidden="true">6.11.</strong> Presentations</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">A/B Street</h1>

                    <div class="right-buttons">
                                                <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/a-b-street/docs/tree/main/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                                        <a href="https://github.com/a-b-street/docs/edit/main/book/src/tech/map/geometry/README.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="deep-dive-into-devilish-details-intersection-geometry"><a class="header" href="#deep-dive-into-devilish-details-intersection-geometry">Deep dive into devilish details: Intersection geometry</a></h1>
<p>Some of the things in A/B Street that seem the simplest have taken me tremendous effort. Determining the shape of roads and intersections is one of those problems, so this article is a deep-dive into how it works and why it's so hard.</p>
<p>Note 1: There's no &quot;related work&quot; section here -- I haven't found many other projects attempting something like this. I've seen a few research papers going in this direction, but none of them pointed to any code to try. The approach I'll describe has many flaws -- I'm not claiming this is a good solution, just the one that A/B Street uses. If you see a way to improve anything here, let me know about it! Even better, try it for real and send a PR -- there's plenty of tooling to help you debug and visually diff against the existing implementation.</p>
<p>Note 2: This article would be way more awesome with code and some interactive demos to play around with each step. That level of ambition would prevent this from ever being written, though! I'll link to the real code and am happy to answer questions if anything's unclear.</p>
<h2 id="background"><a class="header" href="#background">Background</a></h2>
<p>Most street maps you'll find provide a simplified view of streets. Google Maps, Apple Maps, and most OpenStreetMap renderers mostly just tell you the road's name, color it by type (a highway, major arterial road, minor residential street), take great liberties with the width, and don't explicitly distinguish intersections from roads. These maps are used for navigation and drawing your attention to nearby businesses, so this is quite a reasonable view.</p>
<p>(example pictures, compared to satellite)</p>
<p>A/B Street is all about imagining how traffic moves through a city and exploring the effects of redesigning streets. So of course, we need way more detail. To imagine a bike lane down Eastlake Ave instead of street parking, we need to first see how the street's space is allocated. To propose a more pedestrian-friendly traffic signal crossing from Husky Stadium to the UW medical building, we need to see that huge intersection.</p>
<p>(before / after pictures)</p>
<p>At a high-level, we want a representation that:</p>
<ol>
<li>Clearly communicates how a road is divided into different types of lanes (general purpose driving, turn lanes, bike lanes, bus-only lanes, street parking, sidewalks)</li>
<li>Represents the total road width, which tells us how we might change that lane configuration</li>
<li>Divides paved area into distinct roads and intersections. This division tells us where vehicles stop before entering an intersection, how pedestrians and vehicles are likely to move through the space, and what conflicts between them might occur.</li>
</ol>
<p>We're constrained to publicly available, free data sources. Although some cities have GIS departments with some datasets that might be helpful, we're pretty much going with OpenStreetMap (OSM), which has decent coverage of most cities worldwide.</p>
<h3 id="desired-output"><a class="header" href="#desired-output">Desired output</a></h3>
<p>Let's be a little more specific about the representation we want. If you imagine a city as flat 2D space, roads and intersections occupy some portion of it. (Let's ignore bridges and tunnels.)</p>
<p>(example of the thick stuff)</p>
<p>We want to partition this space into individual intersections and road segments. Each road segment (just called &quot;road&quot; for simplicity) leads between exactly two of those intersections. This partition shouldn't have any ambiguous overlap between objects.</p>
<p>(example)</p>
<p>A simplifying assumption, mostly coming from OSM, is that roads can be represented as a center-line and width, and individual lanes can be formed by projecting that center-line left and right. This means when the road changes width in the middle (like for pocket parking or to make room for a turn lane), we have to model that transition as a small &quot;degenerate&quot; intersection, which connects only those two roads.</p>
<p>(examples)</p>
<p>Another assumption taken by A/B Street is that roads hit intersections at a perpendicular angle:</p>
<p>(example)</p>
<p>We use this division to determine where vehicles stop, and where a crosswalk exists:</p>
<p>(example with traffic)</p>
<p>Of course, this assumption isn't always true in reality. At sharp angles, the stop position for adjacent lanes might be offset a fair bit, resulting in a &quot;jagged tooth&quot; look:</p>
<p>(example broadway and boren!)</p>
<p>But for the sake of this article, these're the assumptions we're sticking with. Pedestrian islands, slip lanes, gores, and medians are all real-world elements that don't fit nicely in this model.</p>
<h2 id="overview-of-the-process"><a class="header" href="#overview-of-the-process">Overview of the process</a></h2>
<p>We'll now explore the steps to produce geometry for a single intersection and its connected roads. The broad overview:</p>
<ol>
<li>Pre-process OSM into road center-lines with attributes, with each road connecting just two intersections.</li>
<li>Thicken each road</li>
<li>Trim back the roads based on overlap</li>
<li>Produce the intersection polygon</li>
</ol>
<h2 id="part-1-thickening-the-infinitesmal"><a class="header" href="#part-1-thickening-the-infinitesmal">Part 1: Thickening the infinitesmal</a></h2>
<p>OSM models roads as a center-line -- supposedly the physical center of the paved area, not the solid or dashed yellow line (t least in the US) separating the two directions of traffic. The schema, and how it gets mapped in practice, is fuzzy when there are more lanes in one direction than the other or when roads join or split up for logical routing, but... let's keep things simple to start.</p>
<p>(example)</p>
<p>OSM has a few tags (link) for explicitly mapping road width, but in practice they're not used. Instead, we have a whole bunch of tags that describe the lane configuration of the road. A/B Street interprets these and produces an ordered list of lanes from the left side of the road to the right, guessing the direction, width, and type of each lane. See the <a href="https://github.com/dabreegster/abstreet/blob/master/map_model/src/make/initial/lane_specs.rs">code here</a> -- it's fairly lengthy, but has some intuitive unit tests. This interpretation of tags is hard in practice because the schema is very confusing, there are multiple ways of mapping the same thing, people make many mistakes in practice, etc. TODO, list some examples like cycleway:left:separator:right.</p>
<p>(example of tags -&gt; lanespecs)</p>
<p>So for each road, we estimate the total width based on the lane tagging. Then we project the center line to the left and right, giving us a thickened polygon for the entire road:</p>
<p>(example)</p>
<h3 id="projecting-a-polyline"><a class="header" href="#projecting-a-polyline">Projecting a polyline</a></h3>
<p><a href="https://github.com/a-b-street/abstreet/blob/91c152c123924d7b8bfa14722d18c652d7e42966/geom/src/polyline.rs#L435">https://github.com/a-b-street/abstreet/blob/91c152c123924d7b8bfa14722d18c652d7e42966/geom/src/polyline.rs#L435</a></p>
<p>Explanation of the math. Miters. Examples of it exploding.</p>
<h2 id="part-2-counting-coup"><a class="header" href="#part-2-counting-coup">Part 2: Counting coup</a></h2>
<p>Let's pick a particularly illustrative <a href="https://www.openstreetmap.org/node/1705063811">five-way intersection</a> as our example. For each road, we've got the original center from OSM and our calculated the left and right side:</p>
<p>(pic)</p>
<p>Now the magic happens. You'll notice that many of those polylines collide (For sanity, let's call these &quot;collisions&quot; and not &quot;intersections&quot;, since that term is overloaded here!). Let's find every collision point:</p>
<p>(pic)</p>
<p>These collisions represent where two thickened roads overlap. So let's use them to &quot;trim back&quot; the roads and avoid overlap. For each collision, we form an infinitely long line perpendicular to the collision and find where it hits the original center-line. We'll trim the road back to at least that point.</p>
<p>(diagram)</p>
<p>Because we want roads to meet intersections perpendiculously (I'm quite sure that's the proper term), we want the left and right side of a road to line up. There's probably a collision on a road's left and right side, and usually one of them would cause the center-line to be trimmed back more than the other. We'll always trim back as much as possible.</p>
<p>(pic)</p>
<p>Some questions to consider:</p>
<ol>
<li>
<p>Why look for collisions between every pair of left/right lines? Couldn't we just use the &quot;adjacent&quot; pairs?</p>
</li>
<li>
<p>Is it ever possible for the line perpendicular to a collision to NOT hit the center-line?</p>
</li>
</ol>
<h2 id="part-3-the-clockwise-walk"><a class="header" href="#part-3-the-clockwise-walk">Part 3: The clockwise walk</a></h2>
<p>We've now trimmed roads back to avoid overlapping each other. We just need to generate the polygon for the intersection. As a first cut, let's take these trimmed center-lines, calculate the left and right polylines again (since we've changed the center line), and use the endpoints for the shape.</p>
<p>(example)</p>
<p>Oops, the polygon covers a bit too much space! Cut red tape, queues, and split ends, but not corners. What if we remember all of the collision points, and use those too?</p>
<p>(example)</p>
<p>Much better.</p>
<h3 id="sorting-roads-around-a-center"><a class="header" href="#sorting-roads-around-a-center">Sorting roads around a center</a></h3>
<p>When we're forming the intersection polygon, we know all of the points making it up. But what order do they go in? Seemingly innocent question.</p>
<p>Maybe we can just average all of the points, call that the &quot;center&quot;, calculate the angle to each point, and order clockwise.</p>
<p>(diagram)</p>
<p>TODO: Should we talk about the consolidated intersection case here or not?</p>
<h2 id="interlude-problems-so-far"><a class="header" href="#interlude-problems-so-far">Interlude: problems so far</a></h2>
<p>That wasn't actually so bad! The results are reasonable in many cases:</p>
<p>(examples)</p>
<p>But what kind of things go wrong?</p>
<h3 id="floating-point-fudgery"><a class="header" href="#floating-point-fudgery">Floating point fudgery</a></h3>
<p>Do we ever wind up with points that're aaaalmost the same? What threshold do we pick to deduplicate?</p>
<h3 id="funky-sidewalks"><a class="header" href="#funky-sidewalks">Funky sidewalks</a></h3>
<p>the montlake example</p>
<h3 id="lovecraftian-geometry"><a class="header" href="#lovecraftian-geometry">Lovecraftian geometry</a></h3>
<p>When do we wind up with the polygon looping back on itself? (When two thick roads overlap, but dont share an intersection -- right?)</p>
<h3 id="bad-osm-data"><a class="header" href="#bad-osm-data">Bad OSM data</a></h3>
<p>Often times, the upstream OSM data is just flat-out wrong. Center lines for divided one-way roads are way too close to each other, so using the number of lanes with a reasonable guess at width produces roads that overlap outside of the intersection. This throws off everything we've done!</p>
<p>(aurora)</p>
<p>Another example is people tagging the lane count incorrectly. A common problem when splitting a bidirectional road into two one-ways (which is what you're supposed to do when there's physical separation like a median) is forgetting to change the lane count:</p>
<p>(example)</p>
<p>An important lesson when trying to write algorithms using OSM data: there's a balance between making your code robust to problems in the data, and trying to fix everything upstream. I attempt a compromise. It's a virtuous cycle -- in trying to use OSM data in this new way, I wind up fixing the data sometimes.</p>
<h3 id="highway-onoff-ramps"><a class="header" href="#highway-onoff-ramps">Highway on/off-ramps</a></h3>
<p>TODO Problem and solution. How do we detect this case?</p>
<p>The montlake/520 thing also has this -- if we opt it in, can we fix?</p>
<h2 id="intersection-consolidation"><a class="header" href="#intersection-consolidation">Intersection consolidation</a></h2>
<p>This strict separation between roads and intersections has a fatal flaw -- the real world is very complicated.</p>
<h3 id="where-short-roads-conspire"><a class="header" href="#where-short-roads-conspire">Where short roads conspire</a></h3>
<p>&quot;Dog-leg&quot; intersections: We model the short highlighted piece as its own road, and there two intersections super close together.</p>
<p>(example)</p>
<p>But sometimes something looking like a dog-leg actually isn't -- if vehicles can legitimately stop and queue there, even if it's only one or two of them, then I think it deserves to remain separate:</p>
<p>(phinney/market example)</p>
<p>Another common case is divided highways, aka dual carriageways, aka parallel one-way roads. Every time these intersect, we wind up with some short roads and lots of intersections.</p>
<p>(example of 2 crossing a normal bidi, example of two oneways crossing)</p>
<p>And then there's just the funky cases where I'm pretty sure civil engineers anticipated me writing this algorithm, and found the most obnoxious angles for roads to meet in order to maximize my frustration:</p>
<p>(weird boston example)</p>
<h3 id="why-we-want-to-do-something-about-it"><a class="header" href="#why-we-want-to-do-something-about-it">Why we want to do something about it</a></h3>
<p>So why is this a problem? For starters, it's visually incomprehensible:</p>
<p>(examples)</p>
<p>Oh, that's not enough convincing for you? These complicated areas often are the ones that would be most interesting to study in A/B Street, but just try adding or removing lanes in these cases:</p>
<p>(example)</p>
<p>Now throw traffic signals into the mix. A/B Street tries to simulate those, so when we have a cluster of two or four of them super close, now we have to somehow try to synchronize their timing. When somebody wants to edit them, now they have to operate on all of them at once! We even extended the UI to handle that, but it's quite a poor editing experience.</p>
<p>(example before, and after)</p>
<p>And finally, traffic simulation gets MUCH harder. A/B Street models vehicles as having some length, meaning a vehicle's front can make it through one intersection, but its tail gets stuck there:</p>
<p>(example)</p>
<p>Turns through intersections are just modeled as polylines. They conflict with each other very coarsely. In reality, humans might try to wiggle around a vehicle partially blocking an intersection, but we don't have that robustness. So to prevent this problem from happening, the simulation has complicated rules so that vehicles do not &quot;block the box&quot; -- if they enter an intersection, they must be guaranteed to fully exit and clear it, not get stuck somewhere in the middle. These rules blow up in the presence of short roads. Lots of effort has gone into workarounds at the simulation layer, but... just fixing the representation in the map model seems much more desirable. So let's do that!</p>
<h3 id="my-lazy-first-attempt"><a class="header" href="#my-lazy-first-attempt">My lazy first attempt</a></h3>
<p>Remove the short road, extend the road geometry (or not?), run it through the same algorithm. Miraculously this worked sometimes?!</p>
<h3 id="current-attempt-two-stage"><a class="header" href="#current-attempt-two-stage">Current attempt: two stage</a></h3>
<p>TODO: Write.</p>
<p>Pre-trim based on original thing, remember how much to trim back each road center line.</p>
<p>Then do the merge -- blow up the road. Don't modify any center lines.</p>
<p>For the geom algorithm, do something totally different -- just project the pre-trimmed thing and use that. Seems to work? Even when editing roads, turns out k?</p>
<h3 id="sorting-around-a-center"><a class="header" href="#sorting-around-a-center">Sorting around a center</a></h3>
<p>Before trimming, how do you do this? The point farthest away? A point a fixed few meters away?</p>
<p>For consolidated intersections, probably use the pre-trimmed point</p>
<p>Example Tempe intersection with light rail that blows it up. Center vs polylabel.</p>
<h3 id="finding-the-short-roads"><a class="header" href="#finding-the-short-roads">Finding the short roads</a></h3>
<p>I've been tagging junction=intersection manually upstream to opt them in slowly.</p>
<p>Tried some approaches that look for all short road (pre trimmed or post?). Usually breaks.</p>
<p>Targeted heuristics for 2 and 4-clusters of tsigs.</p>
<p>Examples in Loop 101 -- it gets crazy.</p>
<p>Focusing on tsig clusters for now, since they cause the most problems to traffic sim, but very much ongoing work.</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>Given how much time I've sank into trying to automatically generate decent geometry from an OSM schema absolutely not meant for this, I hope you don't fault me for wanting to try some radically different ideas, like mapping from scratch. There are some intersections just not worth trying to squeeze into OSM's model. Maybe in some future, I'll explore something very different. Or play around with some of the proposals to tag OSM junction areas.</p>
<h2 id="appendices"><a class="header" href="#appendices">Appendices</a></h2>
<h3 id="tricks-and-tooling"><a class="header" href="#tricks-and-tooling">Tricks and tooling</a></h3>
<ul>
<li>screenshot diff as a regression test!</li>
<li>back and forth on RawMap editor and marking stuff in the main game. fast reimports. be able to adjust road centers in rawmap, quickly toggle shorties on or off, preview geometry.</li>
<li>how to debug? this is wedged in the middle of an import process, should we emit extra &quot;side output&quot; files to visualize later? Some kind of step-through debugger, live edit code would be fantastic.</li>
</ul>
<h3 id="hall-of-lovecraftian-horrors--the-stress-tests"><a class="header" href="#hall-of-lovecraftian-horrors--the-stress-tests">Hall of Lovecraftian horrors / the stress tests</a></h3>
<p>montlake/520</p>
<p>roundabouts</p>
<p>south of fremont bridge</p>
<h3 id="radically-simpler-approach"><a class="header" href="#radically-simpler-approach">Radically simpler approach?</a></h3>
<p>Why not just thicken roads, calc bool overlap?  robust bool-op library, and also three-ways</p>
<h3 id="other-data-sources"><a class="header" href="#other-data-sources">Other data sources</a></h3>
<p>philly curb vectors?</p>
<p>streets illustrated</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../../../tech/map/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../../../tech/map/details.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../../../tech/map/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../../../tech/map/details.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
