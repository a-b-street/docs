<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Developer guide - A/B Street</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">A/B Street</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/a-b-street/docs/tree/main/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/a-b-street/docs/edit/main/book/src/tech/dev/README.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="developer-guide"><a class="header" href="#developer-guide">Developer guide</a></h1>
<p>This guide is meant for people who want to work on A/B Street's code. In most
cases as a user, even for importing new cities, you shouldn't need to bother
with any of this.</p>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting started</a></h2>
<p>You will first need:</p>
<ul>
<li>Stable Rust, at least 1.71. <a href="https://www.rust-lang.org/tools/install">https://www.rust-lang.org/tools/install</a>.
<ul>
<li>On Windows, you may need
<a href="https://visualstudio.microsoft.com/en/downloads/">Visual Studio 2019</a>.</li>
</ul>
</li>
<li>On Linux,
<code>sudo apt-get install libasound2-dev libxcb-shape0-dev libxcb-xfixes0-dev libpango1.0-dev libgtk-3-dev</code>
or the equivalent for your distro</li>
</ul>
<p>One-time setup:</p>
<ol>
<li>
<p>Download the repository:
<code>git clone https://github.com/a-b-street/abstreet.git</code></p>
</li>
<li>
<p>Grab the minimal amount of data to get started:
<code>cargo run --bin updater -- download --minimal</code></p>
</li>
<li>
<p>Run the game: <code>RUST_BACKTRACE=1 cargo run --bin game --release</code>. On Windows,
set environment variables like this:
<code>set RUST_BACKTRACE=1 &amp;&amp; cargo run --bin game --release</code></p>
</li>
</ol>
<h2 id="development-tips"><a class="header" href="#development-tips">Development tips</a></h2>
<ul>
<li><a href="https://a-b-street.github.io/abstreet/rustdoc/map_model/index.html">Generated API documentation</a></li>
<li>Compile faster by just doing <code>cargo run</code>. The executable will have debug stack
traces and run more slowly. You can do <code>cargo run --release</code> to build in
optimized release mode; compilation will be slower, but the executable much
faster.</li>
<li>Some in-game features are turned off by default or don't have a normal menu to
access them. The list:
<ul>
<li>To toggle developer mode: press <strong>Control+S</strong> in game, or
<code>cargo run -- --dev</code></li>
<li>To warp to an object by numeric ID: press <strong>Control+j</strong></li>
<li>To enter debug mode with all sorts of goodies: press <strong>Control+D</strong></li>
</ul>
</li>
<li>You can start the game in different modes using flags:
<ul>
<li><code>cargo run --bin game -- --dev data/system/us/seattle/maps/downtown.bin</code>
starts on a particular map</li>
<li><code>cargo run --bin game -- data/system/us/seattle/scenarios/downtown/weekday.bin</code>
starts with a scenario (which is tied to a certain map)</li>
<li><code>cargo run --bin game -- --challenge=trafficsig/tut2</code> starts on a particular
challenge. See the list of aliases by passing in a bad value here.</li>
<li><code>cargo run --bin game -- data/player/saves/us/seattle/montlake/no_edits_unnamed/00h00m20.3s.bin</code>
restores an exact simulation state. Savestates are found in debug mode
(<strong>Control+D</strong>) -- they're probably confusing for the normal player
experience, so they're hidden for now.</li>
<li><code>cargo run --bin game -- --tutorial=12</code> starts somewhere in the tutorial</li>
<li>Adding <code>--edits='name of edits'</code> starts with edits applied to the map.</li>
</ul>
</li>
</ul>
<h2 id="downloading-more-cities"><a class="header" href="#downloading-more-cities">Downloading more cities</a></h2>
<p>Most easily, you can download new cities using the GUI directly.</p>
<p>As data formats change over time, things in the <code>data/</code> directory not under
version control will get out of date. At any time, you can run
<code>cargo run --bin updater -- download</code> from the main repository directory to
update only the files that have changed.</p>
<p>You can also opt into downloading updates for more cities from the command line
by editing <code>data/player/data.json</code>. If you want to add data for Leeds, GB, for
example, you could edit that file so that it contains the following:</p>
<pre><code class="language-json">{
  "runtime": ["gb/leeds", "us/seattle"],
  "input": ["gb/leeds", "us/seattle"]
}
</code></pre>
<p>If you want to opt into absolutely everything:
<code>cargo run --bin updater -- opt-into-all &gt; data/player/data.json</code></p>
<h2 id="building-map-data"><a class="header" href="#building-map-data">Building map data</a></h2>
<p>You can skip this section if you're just touching code in <code>game</code>, <code>widgetry</code>,
and <code>sim</code>. If you're just trying to import a new city, follow
<a href="../../user/new_city.html">the user guide</a>. This section is relevant if you're
working on the code that imports maps and scenarios.</p>
<h3 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h3>
<p>To run all pieces of the importer, you'll need some extra dependencies:</p>
<ul>
<li><code>osmium</code>: See <a href="https://osmcode.org/osmium-tool/manual.html#installation">https://osmcode.org/osmium-tool/manual.html#installation</a></li>
<li><code>libgdal-dev</code>: See <a href="https://gdal.org">https://gdal.org</a> if your OS package manager doesn't have
this. If you keep hitting linking errors, then just remove
<code>--features importer/scenarios</code> from <code>import.sh</code>. You won't be able to build
the Seattle scenarios.</li>
<li>Standard Unix utilities: <code>unzip</code> and <code>gunzip</code></li>
</ul>
<h3 id="the-importer-pipeline"><a class="header" href="#the-importer-pipeline">The importer pipeline</a></h3>
<p>The import process is split into two main steps. When you run the importer, you
specify what work you want to do, so understanding these steps is important.
First is the <code>--raw</code> step, which:</p>
<ol>
<li>Downloads all input data needed for a map -- a .osm.pbf file from Geofabrik,
at minimum</li>
<li>Uses <code>osmium</code> to clip the large OSM file into smaller pieces</li>
<li>Reads in all of the input, producing a <code>RawMap</code> file. This is an
intermediate format that's useful for debugging, using the <code>map_editor</code>
tool.</li>
</ol>
<p>If you look in <code>data/input/us/nyc/</code> (substituting the country and city, of
course), you'll see <code>osm</code> and <code>raw_maps</code> directories. In places like
<code>data/input/us/seattle/</code>, there are many other input files.</p>
<p>The second step, <code>--map</code>, transforms the <code>RawMap</code> to the final <code>Map</code> file used
by all of the applications. These files live in <code>data/system/us/nyc/maps</code>.</p>
<h3 id="running-the-importer"><a class="header" href="#running-the-importer">Running the importer</a></h3>
<p>The importer tool has many CLI flags not described here; <code>--help</code> is the best
reference. But we can start with a few common examples.</p>
<p>After creating configuration files for a city, you can import it, running both
the <code>--raw</code> and <code>--map</code> steps:</p>
<p><code>./import.sh --raw --map --city=br/sao_paulo</code></p>
<p>If your city is split into many maps, you can operate on just one of them (the
<code>west</code> boundary):</p>
<p><code>./import.sh --raw --map --city=fr/paris west</code></p>
<p>If you want to regenerate a map with the latest OSM data, you need to first
delete the OSM input files cached locally. Then running with <code>--raw</code> will
download them again. Note the OSM files are downloaded from Geofabrik, so they
may be up to one day out-of-date. You can additionally use <code>osmupdate</code> if
needed.</p>
<pre><code>rm -rfv data/input/fr/paris/osm/
./import.sh --raw --map --city=fr/paris
</code></pre>
<p>Some more tips for running specific stages of the importer:</p>
<ul>
<li>If you're modifying the initial OSM data -&gt; RawMap conversion in
<code>convert_osm</code>, you need <code>./import.sh --raw --map</code>.</li>
<li>If you're modifying <code>map_model</code> but not the OSM -&gt; RawMap conversion, then you
just need <code>./import.sh --map</code>.</li>
<li>If you're modifying the demand model for Seattle, you can add <code>--scenario</code> to
regenerate.</li>
<li>By default, all maps are regenerated. You can also specify a single map:
<code>./import.sh --map downtown</code>.</li>
<li>By default, Seattle is assumed as the city. You have to specify otherwise:
<code>./import.sh --city=us/detroit --map downtown</code>.</li>
</ul>
<p>Building contraction hierarchies for pathfinding occurs in the <code>--map</code> stage. It
can take a few minutes for larger maps. To view occasional progress updates, you
can run the importer with</p>
<pre><code>RUST_LOG="fast_paths=debug/contracted node [0-9]+0000 "
</code></pre>
<p>You can also make the importer <a href="../../user/new_city.html">import a new city</a>.</p>
<h2 id="understanding-stuff"><a class="header" href="#understanding-stuff">Understanding stuff</a></h2>
<p>The docs listed at <a href="https://github.com/a-b-street/abstreet#documentation">https://github.com/a-b-street/abstreet#documentation</a>
explain things like map importing and how the traffic simulation works.</p>
<h3 id="code-organization"><a class="header" href="#code-organization">Code organization</a></h3>
<p>If you're going to dig into the code, it helps to know what all the crates are.
The most interesting crates are <code>map_model</code>, <code>sim</code>, and <code>game</code>.</p>
<p>Constructing the map:</p>
<ul>
<li><code>convert_osm</code>: extract useful data from OpenStreetMap and other data sources,
emit intermediate map format</li>
<li><code>kml</code>: extract shapes from KML and CSV shapefiles</li>
<li><code>map_model</code>: the final representation of the map, also conversion from the
intermediate map format into the final format</li>
<li><code>map_editor</code>: GUI for modifying geometry of maps and creating maps from
scratch. pretty abandoned as of June 2020</li>
<li><code>importer</code>: the entire import pipeline</li>
<li><code>cli</code>: a collection of command-line tools to manage importing</li>
<li><code>updater</code>: tool to download/upload large files used in the import pipeline</li>
</ul>
<p>Traffic simulation:</p>
<ul>
<li><code>sim</code>: all of the agent-based simulation logic</li>
<li><code>headless</code>: tool to run a simulation without any visualization</li>
</ul>
<p>Graphics:</p>
<ul>
<li><code>game</code>: the GUI and main gameplay</li>
<li><code>map_gui</code>: common code to interact with <code>map_model</code> maps</li>
<li><code>widgetry</code>: a GUI and 2D OpenGL rendering library, using glium + winit +
glutin</li>
</ul>
<p>Common utilities:</p>
<ul>
<li><code>abstutil</code>: a grab-bag timing and logging utilities</li>
<li><code>abstio</code>: Reading/writing files on native/web</li>
<li><code>geom</code>: types for GPS and map-space points, lines, angles, polylines,
polygons, circles, durations, speeds</li>
</ul>
<p>Other:</p>
<ul>
<li><code>collisions</code>: an experimental data format for real-world collision data</li>
<li><code>traffic_seitan</code>: a bug-finding tool that randomly generates live map edits</li>
<li><code>tests</code>: integration tests</li>
<li><code>santa</code>: 15-minute Santa, an arcade game about delivering and zoning</li>
<li><code>parking_mapper</code>: a standalone tool to help map street parking in OSM</li>
<li><code>osm_viewer</code>: a standalone tool to render OSM in detail</li>
<li><code>fifteen_min</code>: a standalone tool to explore 15-minute neighborhoods</li>
<li><code>popdat</code>: use census data to produce traffic simulation input</li>
<li><code>traffic_signal_data</code>: manual timing overrides for some traffic signals</li>
<li><code>piggyback</code>: a small WebAssembly API to layer parts of A/B Street on top of
Mapbox or other web maps</li>
</ul>
<h2 id="code-conventions"><a class="header" href="#code-conventions">Code conventions</a></h2>
<p>All code is automatically formatted using
<a href="https://github.com/rust-lang/rustfmt">https://github.com/rust-lang/rustfmt</a>; please run <code>cargo fmt</code> before sending a
PR.</p>
<p>cargo fmt can't yet organize imports, but we follow a convention to minimize
conflict with what some IDEs do. Follow existing code to group imports: std,
external crates, other crates in the project, the current crate, then finally
any module declarations.</p>
<p>We also use <a href="https://github.com/rust-lang/rust-clippy">https://github.com/rust-lang/rust-clippy</a> to adhere to more Rust
best practices. No need to run it for every commit, and sometimes we'll disable
a warning. If in doubt, just ask on a PR.</p>
<p>See the <a href="testing.html">testing strategy</a> page.</p>
<h2 id="error-handling"><a class="header" href="#error-handling">Error handling</a></h2>
<p>The error handling is unfortunately inconsistent. The goal is to gracefully
degrade instead of crashing the game. If a crash does happen, make sure the logs
will have enough context to reproduce and debug. For example, giving up when
some geometry problem happens isn't ideal, but at least make sure to print the
road / agent IDs or whatever will help find the problem. It's fine to crash
during map importing, since the player won't deal with this, and loudly stopping
problems is useful. It's also fine to crash when initially constructing all of
the renderable map objects, because this crash will consistently happen at
startup-time and be noticed by somebody developing before a player gets to it.</p>
<p>Since almost none of the code ever needs to distinguish error cases, use
<a href="https://crates.io/crates/anyhow">anyhow</a>. Most of the errors generated within
A/B Street are just strings anyway; the <code>bail!</code> macro is a convenient way to
return them.</p>
<h2 id="logging"><a class="header" href="#logging">Logging</a></h2>
<p>Prefer using <code>info!</code>, <code>warn!</code>, <code>error!</code>, etc from the <code>log</code> crate rather than
<code>println</code>.</p>
<p>Adjust the log level without recompiling via the <code>RUST_LOG</code> env variable.</p>
<pre><code>RUST_LOG=debug cargo run --bin game
</code></pre>
<p>This can be done on a per lib basis:</p>
<pre><code>RUST_LOG=my_lib=debug cargo run --bin game
</code></pre>
<p>Or a module-by-module basis:</p>
<pre><code>RUST_LOG=my_lib::module=debug cargo run --bin game
</code></pre>
<p>You can mix and match:</p>
<pre><code># error logging by default, except the foo:bar module at debug level
# and the entire baz crate at info level
RUST_LOG=error,foo::bar=debug,baz=info cargo run --bin game
</code></pre>
<p>For some special cases, you might want to use regex matching by specifying a
pattern with the "/":</p>
<pre><code># only log once every 10k
RUST_LOG="fast_paths=debug/contracted node [0-9]+0000 " mike import_la
</code></pre>
<p>See the <a href="https://docs.rs/env_logger/0.8.2/env_logger/">env_logger documentation</a>
for more usage examples.</p>
<h2 id="profiling"><a class="header" href="#profiling">Profiling</a></h2>
<p>Use <a href="https://github.com/flamegraph-rs/flamegraph">https://github.com/flamegraph-rs/flamegraph</a>, just running it on the
binaries you build normally.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../tech/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../tech/dev/misc_tricks.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../tech/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../tech/dev/misc_tricks.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
