<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Technical details - A/B Street</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">A/B Street</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/a-b-street/docs/tree/main/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/a-b-street/docs/edit/main/book/src/software/ltn/tech_details.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ltn-technical-details"><a class="header" href="#ltn-technical-details">LTN technical details</a></h1>
<p>Since the tool is in such an early stage of development, this is a mix of "how
things work currently" and ideas for moving forwards.</p>
<h2 id="neighborhood-selection"><a class="header" href="#neighborhood-selection">Neighborhood selection</a></h2>
<p>The software operates on a single "neighborhood" at a time. This is defined by a
perimeter, which is a contiguous sequence of roads that form a loop, without any
gaps in the middle. This separates the map into an "interior" and "exterior,"
with border intersections connecting the two.</p>
<p><img src="perimeter_ordering.png" alt="" /></p>
<p>Internally, this is built up from individual "city blocks," that trace around an
area without ever crossing the street.</p>
<p><img src="blocks.png" alt="" /></p>
<h3 id="bugs"><a class="header" href="#bugs">Bugs</a></h3>
<p>These underlying blocks have three major bugs currently. Some blocks are missing
entirely, because of internal geometry problems trying to trace:</p>
<p><img src="geom_bug.png" alt="" /></p>
<p>Bridges, tunnels, and train tracks can produce blocks that appear to overlap in
2D space:</p>
<p><img src="overlap.png" alt="" /></p>
<p>And we don't attempt to build blocks near the boundary of the map. If somebody
wants to study that area, they should import a new map covering more of the
area. We don't know what roads exist just outside the map, so it's not useful to
do any analysis.</p>
<p><img src="map_boundary.png" alt="" /></p>
<h3 id="next-steps"><a class="header" href="#next-steps">Next steps</a></h3>
<p>We've heard overwhelming feedback that choosing the boundary of an LTN needs to
be much more flexible. Sometimes the software's guesses are flat-out wrong, due
to bugs, or improperly including large parks or lakes. Sometimes the major road
classifications in OpenStreetMap are inappropriate. And often, there are parties
interested in more ambitious schemes to "merge" two LTNs or create large ones.
We don't want the software to be prescriptive at all in this selection of
boundary road; people know best. So the plan is to allow for drawing custom
boundaries. To speed things up, we can also improve the built-in heuristics for
partitioning neighborhoods and let people select which OpenStreetMap highway
types should count as a "major" road.</p>
<h2 id="cell-connectivity"><a class="header" href="#cell-connectivity">Cell connectivity</a></h2>
<p>After picking a neighborhood, the tool groups all of the interior streets by
connectivity for motor vehicles. Within each "cell," a driver can reach all
streets without using a perimeter road. How does this work? Start from any
interior street, and "flood" out from that start position to find all reachable
streets. Don't search past perimeter roads. That's a cell. Repeat until all
interior streets have been visited. The reachability is based on motor vehicle
constraints, so streets classified as pedestrian- or bike-only and new modal
filters can't be crossed.</p>
<p>Initially, a neighborhood might be split into a few cells:</p>
<p><img src="cells_initial.png" alt="" /></p>
<p>That blue cell is quite large, so drivers may be tempted to cut through to avoid
queues along the perimeter. Let's add a filter to stop them:</p>
<p><img src="one_filter.png" alt="" /></p>
<p>The cells didn't change, because there's a parallel street that's still open.
Adding a filter to just one street might not work -- drivers can just detour to
the other option. Let's fix that.</p>
<p><img src="cells_areas.png" alt="" /></p>
<p>Now the blue cell is split into a yellow piece; the two aren't connected
anymore. The scheme is now "water-tight."</p>
<p>The cells are visualized as colored areas, inspired by many example LTN diagrams
floating around. But if that's confusing, you can just color the cells by street
instead:</p>
<p><img src="cells_streets.png" alt="" /></p>
<p>The colors aren't meaningful; they're just meant to show different cells. There
may be cases when two adjacent cells have the same color, but they're not
connected -- that's just a bug we're working on.</p>
<h2 id="routing"><a class="header" href="#routing">Routing</a></h2>
<p>There's a pathfinding tool to see how driving routes will interact with a
neighborhood. The pathfinding itself performs a standard graph search,
respecting any turn and lane restrictions defined in OpenStreetMap. The
<a href="https://github.com/a-b-street/abstreet/blob/b45bf869b7b037fefc075d19fb9ecd3d7dcacc86/map_model/src/pathfind/vehicles.rs#L271">cost function</a>,
expressed in units of duration, is the distance divided by the speed limit. For
drivers, there's just one extra penalty that normally applies -- unprotected
right turns (in the UK) from a smaller to a larger road. This penalty is fixed
at 30 seconds currently.</p>
<p>According to this cost function, often the optimal route for a driver doesn't
even pass through a neighborhood. Major roads tend to have higher speed limits
in OpenStreetMap, so their cost is lower. This may not match reality -- during
peak hours, main roads might have long queues, and a driver armed with satnav
could try to cut through a neighborhood. So there's a toggleable slowdown factor
for main roads, which just multiplies the cost.</p>
<p>Here's an example of the results. With a slowdown factor of 1.5x, the blue route
shows that drivers might try to cut through this neighborhood. After we add some
modal filters, the blue route becomes impossible, and the driver is likely to
try the red route instead -- which actually cuts through the neighborhood on the
north end, because we haven't added filters there.</p>
<p><img src="detour.png" alt="" /></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../software/ltn/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../software/osm_viewer.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../software/ltn/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../software/osm_viewer.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
